<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MDRRMO ‚Äî Edit Household (Uniform)</title>
<link rel="stylesheet" href="styles.css"/>
<style>
/* ====== Reuse the same look & feel as your dataForm basis ====== */
/* (styles kept compact - same as your provided template) */

.member-panel {
  position: fixed; right: 0; top: 0; height: 100vh; width: 420px; max-width: 96%;
  background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,250,0.98));
  box-shadow: -18px 0 40px rgba(6,30,20,0.12); transform: translateX(110%);
  transition: transform 280ms cubic-bezier(.2,.9,.3,1); z-index: 6000; padding: 18px; overflow-y:auto;
}
.member-panel.open { transform: translateX(0%); }
.member-panel .panel-header { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
.member-panel h3 { margin:0; font-size:18px; color:var(--green-1,#0f7a4a); }
.member-panel .panel-body { margin-top:8px; }
.member-panel .panel-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

.panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.32); opacity: 0; transition: opacity 200ms; pointer-events: none; z-index: 5900; }
.panel-overlay.show { opacity: 1; pointer-events: auto; }

.radio-line { display:flex; gap:18px; align-items:center; padding:6px 0; }
.radio-item { display:flex; align-items:center; gap:6px; font-weight:700; font-size:14px; }

.btn { border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;background: linear-gradient(90deg,#0f7a4a,#34b78f); color:#fff; }
.btn.secondary { background: transparent; color: #0f7a4a; border:1px solid rgba(6,30,20,0.06); }
.card { padding:14px;border-radius:10px;background:#fff;margin-bottom:12px;box-shadow:0 6px 18px rgba(6,30,20,0.04); }
.form-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
.small-muted { font-size:13px; color:#666; }
.brand .logo { width:44px; height:44px; object-fit:contain; }
.green { color:#0f7a4a; font-weight:700; }

.records-toolbar { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom:18px; }
.toolbar-center { flex:1; display:flex; justify-content:center; }
.toolbar-right { display:flex; align-items:center; gap:12px; }

.search-box { padding:8px 12px; border-radius:8px; border:1px solid #bbb; min-width:260px; }
.brgy-dropdown { padding:8px 10px; border-radius:8px; border:1px solid #ccc; }

.icon-btn-lg { border:none; background:none; cursor:pointer; padding:8px; border-radius:8px; transition:0.15s; display:inline-flex; align-items:center; justify-content:center; font-size:18px; }
.icon-btn-lg:hover { background:#e8ffee; }
.icon-btn { border:0; background:none; cursor:pointer; padding:6px; border-radius:6px; }
.icon-refresh svg path { fill:#0A8A15; }

.export-wrapper { position:relative; }
.export-dropdown { position:absolute; right:0; top:36px; background:white; border:1px solid #ccc; border-radius:8px; padding:6px 0; width:170px; box-shadow:0 4px 12px rgba(0,0,0,0.12); z-index:9999; }
.export-dropdown div { padding:10px 14px; cursor:pointer; }
.export-dropdown div:hover { background:#effff5; }
.hidden { display:none; }

.records-wrapper { overflow:auto; border-radius:10px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
.records-table { width:100%; border-collapse:collapse; min-width:1100px; font-size:13px; }
.records-table th, .records-table td { padding:8px 10px; border-bottom:1px solid #eee; white-space:nowrap; height:36px; vertical-align:middle; }
.records-table thead th { background:#f4f7f4; position:sticky; top:0; z-index:20; font-weight:700; }
.select-col { position:sticky; left:0; background:#fff; z-index:25; padding-left:12px; }
.actions-col { position:sticky; right:0; background:#fff; z-index:25; }
.mem-small { background:#d4f6ff; } .mem-normal { background:#d9ffd9; } .mem-large { background:#fff7c2; } .mem-critical { background:#ffd6d6; }
.member-row { background:white; } .member-row.hidden { display:none; } .member-row td { padding-left:20px; font-size:13px; color:#444; height:36px; }
.members-toggle-btn { padding:4px 6px; font-size:13px; background:none; border:none; cursor:pointer; color:#0a6a9a; }
.members-toggle-btn:hover { text-decoration:underline; }

@media(max-width:900px){ .form-grid { grid-template-columns:1fr; } .member-panel{ width:100%; } }
</style>
</head>
<body>
<div class="page-container">
  <header class="topbar">
    <button id="menuToggle" class="menu-btn" aria-label="Toggle menu" aria-expanded="true">‚ò∞</button>
    <div class="brand" style="display:flex;align-items:center;gap:12px;">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="logo"/>
      <div>
        <div class="title">PUROK KALIGTASAN</div>
        <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
      </div>
    </div>
    <div class="user-info" style="margin-left:auto;">
      <span id="userName"></span>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <ul>
      <li><a href="dashboard.html">üìä Dashboard</a></li>
      <li><a href="dataForm.html">üìù Data Entry</a></li>
      <li><a href="records.html">üìÅ Records</a></li>
      <li><a href="charts.html">üìà Charts</a></li>
      <li class="admin-only"><a href="users.html">üë• User Management</a></li>
    </ul>
  </aside>

  <main class="content-area" tabindex="-1">
    <h2>üìÅ Household Records ‚Äî Edit (Uniform)</h2>

    <div class="top-stats" style="display:flex; justify-content:flex-end; gap:18px; margin-bottom:12px;">
      <span>Rows: <strong class="green" id="rowCount">0</strong></span>
      <span>Matches: <strong class="green" id="matchCount">0</strong></span>
      <span>Selected: <strong class="green" id="selectedCount">0</strong></span>
    </div>

    <div class="records-toolbar">
      <div class="toolbar-center">
        <input id="searchInput" class="search-box" placeholder="Search by Barangay / Name / Data ID..." />
      </div>

      <div class="toolbar-right">
        <select id="filterBarangay" class="brgy-dropdown">
          <option value="">All Barangays</option>
          <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
          <option>Dalipit East</option><option>Dalipit West</option><option>Dominador East</option>
          <option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
          <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option>
          <option>Ping-As</option><option>Poblacion East</option><option>Poblacion West</option>
          <option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
        </select>

        <button id="refreshBtn" class="icon-btn-lg icon-refresh" title="Refresh">
          <svg width="20" height="20" viewBox="0 0 24 24"><path d="M12 6V3L8 7l4 4V8c2.2 0 4 1.8 4 4 0 .7-.2 1.4-.5 2l1.5 1.3c.6-.9 1-2 1-3.3 0-3.3-2.7-6-6-6zm-4.5 2C6.9 8.9 6 10.4 6 12c0 3.3 2.7 6 6 6v3l4-4-4-4v3c-2.2 0-4-1.8-4-4 0-.7.2-1.4.5-2L7.5 8z"></path></svg>
        </button>

        <div class="export-wrapper">
          <button id="exportMenuBtn" class="icon-btn-lg" title="Export">üì§</button>
          <div id="exportDropdown" class="export-dropdown hidden">
            <div onclick="exportAll()">Export All</div>
            <div onclick="exportSelected()">Export Selected</div>
          </div>
        </div>
      </div>
    </div>

    <div class="records-wrapper">
      <table id="recordsTable" class="records-table" aria-describedby="tableDescription">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div id="paginationArea"></div>
  </main>
</div>

<!-- Loading overlay -->
<div id="loading" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(255,255,255,0.75); z-index:9999;">
  <div style="background:#fff; padding:18px; border-radius:10px; box-shadow:0 6px 24px rgba(0,0,0,0.08);">Loading records‚Ä¶</div>
</div>

<!-- Panel overlay -->
<div id="panelOverlay" class="panel-overlay" aria-hidden="true"></div>

<!-- Edit slide-in panel (head first, then members) -->
<div id="editPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Edit household panel">
  <div class="panel-header">
    <button id="panelClose" class="btn secondary" title="Close panel">‚Üê</button>
    <h3 id="panelTitle">Edit Household</h3>
  </div>

  <div class="panel-body">
    <form id="editForm" onsubmit="return false;">
      <!-- Head editing -->
      <div class="card">
        <h4>Household Head ‚Äî Edit</h4>
        <div class="form-grid">
          <div>
            <label>Barangay</label>
            <select id="edit_barangay">
              <option value="">Select Barangay...</option>
              <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
              <option>Dalipit East</option><option>Dalipit West</option><option>Dominador East</option>
              <option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
              <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option>
              <option>Ping-As</option><option>Poblacion East</option><option>Poblacion West</option>
              <option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
            </select>
          </div>
          <div>
            <label>Sitio / Purok</label>
            <select id="edit_sitio">
              <option value="">Select...</option>
              <option>Purok I</option><option>Purok II</option><option>Purok III</option>
              <option>Purok IV</option><option>Purok V</option><option>Purok VI</option>
              <option>Purok VII</option>
            </select>
          </div>

          <div>
            <label>Name of Household Head</label>
            <input type="text" id="edit_householdHead"/>
          </div>
          <div>
            <label>Sex</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="edit_head_sex" value="Male"> Male</label>
              <label class="radio-item"><input type="radio" name="edit_head_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate</label>
            <input type="date" id="edit_householdBirthdate"/>
          </div>
          <div>
            <label>Age</label>
            <input type="number" id="edit_householdAge" readonly/>
          </div>

          <div>
            <label>Stage</label>
            <input type="text" id="edit_householdStage" readonly/>
          </div>
          <div>
            <label>No. of Household Member/s</label>
            <input type="number" id="edit_memberCount" min="0" value="0"/>
          </div>
        </div>

        <hr style="margin:12px 0;">
        <h4>Health & Transport</h4>
        <div class="form-grid">
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="edit_head_pwd" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="edit_head_pwd" value="No"> No</label>
            </div>
          </div>
          <div>
            <label>Status</label>
            <select id="edit_head_status"><option value="">Select...</option><option>With Sickness</option><option>Pregnant</option><option>Others</option></select>
          </div>
          <div>
            <label>Transportation</label>
            <select id="edit_head_transport"><option value="">Select...</option><option>Individual with Transportation</option><option>Individual needing Transportation</option></select>
          </div>
        </div>

        <hr style="margin:12px 0;">
        <h4>Pickup / Camp</h4>
        <div class="form-grid">
          <div><label>Designated Pick-Up Point</label><input id="edit_pickup"/></div>
          <div><label>Drop-Off Point</label><input id="edit_dropoff"/></div>
          <div><label>Name of Camp</label><input id="edit_campName"/></div>
          <div><label>Capacity</label><input type="number" id="edit_capacity" min="0"/></div>
          <div><label>No. Inside Camp</label><input type="number" id="edit_insideCamp" min="0"/></div>
          <div><label>No. Outside Camp</label><input type="number" id="edit_outsideCamp" min="0"/></div>
        </div>

        <h4>Assistance Received (optional)</h4>

<div class="form-grid">
  <label><input type="checkbox" id="edit_ass_tupad"> TUPAD</label>
  <label><input type="checkbox" id="edit_ass_local4ps"> Local 4Ps</label>
  <label><input type="checkbox" id="edit_ass_intl4ps"> National 4Ps</label>
  <label><input type="checkbox" id="edit_ass_locsp"> Local Social Pension</label>
  <label><input type="checkbox" id="edit_ass_intlsp"> National Social Pension</label>
  <label><input type="checkbox" id="edit_ass_solo"> Solo Parent Assistance</label>
  <label><input type="checkbox" id="edit_ass_relief"> Relief Goods</label>
  <label><input type="checkbox" id="edit_ass_cash"> Cash Subsidy</label>
</div>

<div style="margin-top:8px">
  <label>AICS (if any)</label>
  <select id="edit_ass_aics">
    <option value="">None</option>
    <option>Shelter Assistance</option>
    <option>Burial</option>
    <option>Scholarship</option>
  </select>
</div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button id="startSequenceBtn" class="btn">Next ‚Üí Members (Start sequence)</button>
          <button id="saveEditBtn" class="btn">Save changes</button>
          <button id="cancelEditBtn" class="btn secondary" type="button">Cancel</button>
        </div>
      </div>

      <!-- Members preview + edit controls -->
      <div class="card">
        <h4>Members</h4>
        <div class="small-muted">Count: <strong id="edit_previewCount">0</strong></div>
        <ul id="edit_membersPreview" class="member-preview"></ul>
        <div style="display:flex;gap:8px; margin-top:10px; justify-content:flex-end;">
          <button id="edit_addMember" class="btn secondary" type="button">Add / Edit Members</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Member sequential panel -->
<div id="memberPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Member entry panel">
  <div class="panel-header">
    <button id="memberPanelClose" class="btn secondary" title="Close panel">‚Üê</button>
    <h3 id="memberPanelTitle">Member 1 of N</h3>
  </div>

  <div class="panel-body">
    <form id="memberForm" onsubmit="return false;">
      <div class="form-grid">
        <div>
          <label>Member Name <span class="small">*</span></label>
          <input type="text" id="memberName" class="member-name" />
        </div>

        <div>
          <label>Sex</label>
          <div class="radio-line">
            <label class="radio-item"><input type="radio" name="member_sex" value="Male" class="member-sex"> Male</label>
            <label class="radio-item"><input type="radio" name="member_sex" value="Female" class="member-sex"> Female</label>
          </div>
        </div>

        <div>
          <label>Birthdate</label>
          <input type="date" id="memberBirthdate" class="member-birthdate"/>
        </div>

        <div>
          <label>Age</label>
          <input type="number" id="memberAge" class="member-age" readonly/>
        </div>

        <div>
          <label>PWD</label>
          <div class="radio-line">
            <label class="radio-item"><input type="radio" name="member_pwd" value="Yes" class="member-pwd"> Yes</label>
            <label class="radio-item"><input type="radio" name="member_pwd" value="No" class="member-pwd"> No</label>
          </div>
        </div>

        <div>
          <label>Stage</label>
          <input type="text" id="memberStage" class="member-stage" readonly/>
        </div>

        <div>
          <label>Status</label>
          <select id="memberStatus" class="member-status"><option value="">Select...</option><option>With Sickness</option><option>Pregnant</option></select>
        </div>

        <div>
          <label>Transportation</label>
          <select id="memberTransport" class="member-transport"><option value="">Select...</option><option>Individual with Transportation</option><option>Individual needing Transportation</option></select>
        </div>

        <div>
          <label>Designated Pick-Up Point</label>
          <input id="memberPickup" class="member-pickup"/>
        </div>

        <div>
          <label>Drop-Off Point</label>
          <input id="memberDropoff" class="member-dropoff"/>
        </div>

        <div>
          <label>Name of Camp</label>
          <input id="memberCamp" class="member-camp"/>
        </div>

        <div>
          <label>Capacity</label>
          <input type="number" id="memberCampCap" class="member-cap" min="0"/>
        </div>

        <div>
          <label>No. Inside Camp</label>
          <input type="number" id="memberInside" class="member-inside" min="0"/>
        </div>

        <div>
          <label>No. Outside Camp</label>
          <input type="number" id="memberOutside" class="member-outside" min="0"/>
        </div>

        <div style="grid-column:1/-1;">
          <label>Reason</label>
          <select id="memberReason" class="member-reason"><option value="">Select...</option><option>With-in 14-15 KM Danger Zone</option><option>Others</option></select>
        </div>

        <div style="grid-column:1/-1; margin-top:8px">
  <h4 style="margin:6px 0 8px 0">Government Support</h4>
  <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px 12px">
    <label><input type="checkbox" id="member_tupad" class="member_tupad"> TUPAD</label>
    <label><input type="checkbox" id="member_local4ps" class="member_local4ps"> Local 4Ps</label>
    <label><input type="checkbox" id="member_intl4ps" class="member_intl4ps"> National 4Ps</label>
    <label><input type="checkbox" id="member_locsp" class="member_locsp"> Local Social Pension</label>
    <label><input type="checkbox" id="member_intlsp" class="member_intlsp"> National Social Pension</label>
    <label><input type="checkbox" id="member_solo" class="member_solo"> Solo Parent Assistance</label>
    <label><input type="checkbox" id="member_cash" class="member_cash"> Cash Subsidy</label>
    <label><input type="checkbox" id="member_relief" class="member_relief"> Relief Goods</label>
  </div>

  <div style="margin-top:8px">
    <label>AICS (if any)</label>
    <select id="memberAics" class="member_aics">
      <option value="">None</option>
      <option>Shelter Assistance</option>
      <option>Burial</option>
      <option>Scholarship</option>
    </select>
  </div>
</div>

      <div class="panel-actions" style="margin-top:10px;">
        <button id="memberBack" class="btn secondary" type="button">Back</button>
        <button id="memberNext" class="btn" type="button">Save & Next</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ========================= CONFIG ========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyB66g9Ashw5n5ZwaX2XZH8KE2OvAm-8uPAAOVsrF9W59u5Uyr-D0N-fZSC7wIyD4rXDw/exec";

/* ========================= STATE ========================= */
let rawRows = [];
let grouped = {};
let header = [];
let groupsArr = [];
let selectedIds = new Set();
let currentPage = 1;
const rowsPerPage = 25;

/* Edit state */
let editDataID = null;
let editHead = {};
let editMembers = [];
let memberEditIndex = 0;
let sequenceMode = false;

/* ========================= UTIL HELPERS ========================= */
const $ = id => document.getElementById(id);
const q = sel => document.querySelector(sel);
const qAll = sel => Array.from(document.querySelectorAll(sel));

function showLoading(show = true){
  const el = $('loading');
  if(!el) return;
  el.style.display = show ? 'flex' : 'none';
}
function escapeHtml(s){ return String(s ?? '').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
function computeKeywordRegex(q){ if(!q) return null; const esc = q.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"); return new RegExp(esc,"gi"); }
function highlight(text,q){ if(!q) return escapeHtml(text); const re=computeKeywordRegex(q); return escapeHtml(text).replace(re,m=>`<span class="hl">${m}</span>`); }

/* ========================= DATE PARSING & FORMATTING =========================
   - toInputDate: converts different sheet/display values -> "yyyy-mm-dd" for <input type="date">
   - toSheetDate: converts "yyyy-mm-dd" -> "DD/MM/YYYY" for saving to sheet
   - toDisplayDate: normalize various inputs to "DD/MM/YYYY" for UI display (if needed)
*/
function toInputDate(val){
  if(!val && val !== 0) return '';
  // If already yyyy-mm-dd
  if(typeof val === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(val)) return val;

  // If the sheet provided DD/MM/YYYY
  if(typeof val === 'string' && /^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(val)){
    const parts = val.split('/');
    // prefer DD/MM/YYYY (your sheet uses DD/MM/YYYY). handle 2- or 4-digit years
    let d = parts[0].padStart(2,'0'), m = parts[1].padStart(2,'0'), y = parts[2];
    if(y.length === 2) y = '20' + y;
    // If it's ambiguous (both <=12) we prioritize DD/MM/YYYY per your requirement
    return `${y}-${m}-${d}`;
  }

  // If the string looks like MM/DD/YYYY we try to detect
  if(typeof val === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(val)){
    // attempt both interpretations: prefer DD/MM/YYYY as above
    const [a,b,c] = val.split('/');
    // prefer DD/MM/YYYY
    const d = a.padStart(2,'0'), m = b.padStart(2,'0'), y = c;
    return `${y}-${m}-${d}`;
  }

  // If it's a Date object
  if(val instanceof Date && !isNaN(val)){
    const mm = String(val.getMonth()+1).padStart(2,'0');
    const dd = String(val.getDate()).padStart(2,'0');
    return `${val.getFullYear()}-${mm}-${dd}`;
  }

  // fallback: try parsing
  const dt = new Date(String(val));
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dt.getFullYear()}-${mm}-${dd}`;
  }

  return '';
}

function toSheetDate(inputVal){
  // Expects "yyyy-mm-dd" OR Date-like -> returns "DD/MM/YYYY" (sheet format)
  if(!inputVal) return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputVal)){
    const [y,m,d] = inputVal.split('-');
    return `${d}/${m}/${y}`;
  }
  // fallback: parse and format
  const dt = new Date(inputVal);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dd}/${mm}/${dt.getFullYear()}`;
  }
  return '';
}

function toDisplayDate(val){
  // Normalize to DD/MM/YYYY for showing to users (if you ever need it)
  if(!val) return '';
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(val)) return val;
  if(/^\d{4}-\d{2}-\d{2}$/.test(val)){
    const [y,m,d] = val.split('-'); return `${d}/${m}/${y}`;
  }
  // try to parse sloppy inputs
  if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(val)){
    const [a,b,c] = val.split('/'); // treat as DD/MM/YYYY per your sheet
    const d = a.padStart(2,'0'), m = b.padStart(2,'0'), y = c;
    return `${d}/${m}/${y}`;
  }
  const dt = new Date(val);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dd}/${mm}/${dt.getFullYear()}`;
  }
  return String(val);
}

/* ========================= AGE / STAGE HELPERS ========================= */
function computeAgeFromBirthdateISO(isoDate){
  if(!isoDate) return null;
  const d = new Date(isoDate);
  if(isNaN(d)) return null;
  const now = new Date();
  let years = now.getFullYear() - d.getFullYear();
  const m = now.getMonth() - d.getMonth();
  if(m < 0 || (m === 0 && now.getDate() < d.getDate())) years--;
  if(years <= 0){
    const months = (now.getFullYear() - d.getFullYear())*12 + (now.getMonth() - d.getMonth());
    return { years: 0, months: Math.max(0, months) };
  }
  return { years };
}
function deriveStageFromAge(ageObj){
  if(!ageObj) return '';
  if(ageObj.years === 0){
    const months = ageObj.months || 0;
    if(months <= 10) return 'Infant';
    return 'Children';
  }
  if(ageObj.years <= 17) return 'School Children';
  if(ageObj.years >= 60) return 'Elderly';
  return 'Adult';
}

/* ========================= JSONP (GAS) ========================= */
function jsonpGet(params, cb){
  const ts = Date.now();
  const cbName = 'cb_' + ts + '_' + Math.floor(Math.random()*1000);
  window[cbName] = function(resp){ cb(null, resp); delete window[cbName]; };
  const qstr = `action=getRecords&filterBarangay=${encodeURIComponent(params.filterBarangay||'')}&filterStage=${encodeURIComponent(params.filterStage||'')}&q=${encodeURIComponent(params.q||'')}&callback=${cbName}`;
  const s = document.createElement('script');
  s.src = `${SCRIPT_URL}?${qstr}`;
  s.onerror = ()=>cb(new Error('JSONP failed'));
  s.onload = ()=>s.remove();
  document.body.appendChild(s);
}

/* ========================= LOAD & GROUP RECORDS ========================= */
function loadRecords(){
  showLoading(true);
  const filterBarangay = $('filterBarangay') ? $('filterBarangay').value : '';
  const qstr = $('searchInput') ? $('searchInput').value : '';

  jsonpGet({ filterBarangay, q: qstr }, (err, resp) => {
    showLoading(false);
    if(err || !resp || !resp.success){ alert('Failed to load records'); console.error(err, resp); return; }
    header = resp.header || [];
    rawRows = resp.rows || [];
    grouped = {};

    rawRows.forEach(r=>{
      const id = String(r['Data ID'] || '');
      if(!id) return;
      if(!grouped[id]) grouped[id] = { dataID: id, head: null, members: [] };
      const isHead = !r['Name of Household Member/s'] || String(r['Name of Household Member/s']).trim() === '';
      if(isHead && !grouped[id].head) grouped[id].head = r;
      else grouped[id].members.push(r);
    });

    // ensure if no explicit head, first member becomes head
    Object.keys(grouped).forEach(id=>{
      if(!grouped[id].head && grouped[id].members.length>0) grouped[id].head = grouped[id].members.shift();
    });

    const keys = Object.keys(grouped).sort((a,b)=> Number(a) - Number(b));
    groupsArr = keys.map(k => grouped[k]);

    currentPage = 1; selectedIds.clear();
    renderPage(); renderPagination(); updateCounts();
  });
}

/* ========================= RENDER TABLE ========================= */
function renderPage(){
  const tbody = $('tableBody');
  const thead = $('tableHead');
  if(!tbody || !thead) return;
  tbody.innerHTML = '';
  thead.innerHTML = '';

  // header
  let hdr = '<tr>';
  hdr += `<th class="select-col"><input id="selectAll" type="checkbox"></th>`;
  header.forEach(h => hdr += `<th>${escapeHtml(h)}</th>`);
  hdr += `<th class="actions-col">Members</th>`;
  hdr += `<th class="actions-col">Actions</th>`;
  hdr += '</tr>';
  thead.innerHTML = hdr;

  const start = (currentPage - 1) * rowsPerPage;
  const slice = groupsArr.slice(start, start + rowsPerPage);
  const keyword = ($('searchInput')?.value || '').trim();

  slice.forEach(group => {
    const head = group.head || {};
    const members = group.members || [];
    const memCount = members.length;
    const cls = memCount <= 1 ? 'mem-small' : memCount <= 4 ? 'mem-normal' : memCount <= 7 ? 'mem-large' : 'mem-critical';

    // head row
    const tr = document.createElement('tr'); tr.className = cls;
    // select col
    const tdSel = document.createElement('td'); tdSel.className = 'select-col';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.className='row-select'; cb.dataset.dataId = group.dataID;
    cb.checked = selectedIds.has(group.dataID);
    cb.addEventListener('change', onRowSelect);
    tdSel.appendChild(cb); tr.appendChild(tdSel);

    // data columns
    header.forEach(col=>{
      const td = document.createElement('td');
      let txt = head[col] ?? '';
      if(col === 'No. of Household Member/s') txt = `${txt} (+${memCount})`;
      td.innerHTML = highlight(txt, keyword);
      tr.appendChild(td);
    });

    // members toggle
    const tdMem = document.createElement('td'); tdMem.className = 'actions-col';
    tdMem.innerHTML = `<button class="members-toggle-btn" onclick="toggleMembers('${group.dataID}')">‚ñ∏ ${memCount} members</button>`;
    tr.appendChild(tdMem);

    // actions
    const tdAct = document.createElement('td'); tdAct.className = 'actions-col';
    tdAct.innerHTML = `
      <button title="Edit" class="icon-btn" onclick="onEditClick('${group.dataID}')"><span class="action-icon">‚úèÔ∏è</span></button>
      <button title="Delete" class="icon-btn" onclick="onDeleteClick('${group.dataID}')"><span class="action-icon">üóëÔ∏è</span></button>
    `;
    tr.appendChild(tdAct);

    tbody.appendChild(tr);

    // member rows
    members.forEach(m => {
      const mr = document.createElement('tr');
      mr.className = 'member-row hidden';
      mr.dataset.parent = group.dataID;
      mr.appendChild(document.createElement('td'));
      header.forEach(col=>{
        const td = document.createElement('td');
        td.innerHTML = highlight(m[col] || '', keyword);
        mr.appendChild(td);
      });
      mr.appendChild(document.createElement('td'));
      mr.appendChild(document.createElement('td'));
      tbody.appendChild(mr);
    });
  });

  // selectAll
  const selectAll = $('selectAll');
  if(selectAll){
    selectAll.checked = slice.every(g => selectedIds.has(g.dataID));
    selectAll.onchange = ()=>{ slice.forEach(g => { if(selectAll.checked) selectedIds.add(g.dataID); else selectedIds.delete(g.dataID); }); renderPage(); };
  }

  updateCounts();
}

function toggleMembers(id){
  qAll(`tr.member-row[data-parent="${id}"]`).forEach(r => r.classList.toggle('hidden'));
}

/* ========================= PAGINATION / COUNTS ========================= */
function renderPagination(){
  const div = $('paginationArea');
  if(!div) return;
  const total = Math.max(1, Math.ceil(groupsArr.length / rowsPerPage));
  if(total <= 1){ div.innerHTML = ''; return; }
  let html = `<button class="page-btn" onclick="changePage(${currentPage-1})">‚¨Ö Prev</button>`;
  for(let i=1;i<=total;i++) html += `<button class="page-btn ${i===currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
  html += `<button class="page-btn" onclick="changePage(${currentPage+1})">Next ‚û°</button>`;
  div.innerHTML = html;
}
function changePage(p){ const total = Math.ceil(groupsArr.length / rowsPerPage); if(p<1||p>total) return; currentPage = p; renderPage(); renderPagination(); }
function updateCounts(){ if($('rowCount')) $('rowCount').innerText = groupsArr.length; if($('matchCount')) $('matchCount').innerText = groupsArr.length; if($('selectedCount')) $('selectedCount').innerText = selectedIds.size; }
function onRowSelect(e){ const id = e.target.dataset.dataId; if(e.target.checked) selectedIds.add(id); else selectedIds.delete(id); updateCounts(); }

/* ========================= DELETE ========================= */
function onDeleteClick(dataID){
  if(!confirm('Delete household ' + dataID + '?')) return;
  const fd = new FormData();
  fd.append('action','deleteHousehold');
  fd.append('dataID', dataID);
  fetch(SCRIPT_URL, { method: 'POST', body: fd })
    .then(r => r.text())
    .then(txt => {
      let json;
      try { json = JSON.parse(txt); } catch(e){ throw new Error('Invalid server response'); }
      if(json.success){ alert(json.message || 'Deleted'); loadRecords(); }
      else alert('Delete failed: ' + (json.message || JSON.stringify(json)));
    }).catch(err => { console.error('Delete error', err); alert('Delete failed ‚Äî see console'); });
}

/* ========================= EDIT FLOW ========================= */
function onEditClick(dataID){
  const group = grouped[dataID] || groupsArr.find(g => g.dataID === dataID);
  if(!group){ alert('Record not found'); return; }

  editDataID = dataID;
  editHead = Object.assign({}, group.head || {});
  editMembers = (group.members || []).map(m => Object.assign({}, m));

  // Prefill head inputs (convert sheet dates to input ISO)
  $('edit_barangay').value = editHead['Barangay'] || '';
  $('edit_sitio').value = editHead['Sitio / Purok'] || '';
  $('edit_householdHead').value = editHead['Name of Household Head'] || '';
  qAll("input[name='edit_head_sex']").forEach(r => r.checked = (r.value === (editHead['Sex'] || '')));
  $('edit_householdBirthdate').value = toInputDate(editHead['Birthdate'] || '');
  updateEditHeadAgeStage();
  $('edit_memberCount').value = editHead['No. of Household Member/s'] || (editMembers.length || 0);
  qAll("input[name='edit_head_pwd']").forEach(r => r.checked = (r.value === (editHead['Persons with Disability (PWD)'] || 'No')));
  $('edit_head_status').value = editHead['Status'] || '';
  $('edit_head_transport').value = editHead['Transportation'] || '';
  $('edit_pickup').value = editHead['Designated Pick-Up Point'] || '';
  $('edit_dropoff').value = editHead['Drop-Off Point'] || '';
  $('edit_campName').value = editHead['Name of Camp'] || '';
  $('edit_capacity').value = editHead['Capacity'] || '';
  $('edit_insideCamp').value = editHead['No. of Individuals Inside Camp'] || '';
  $('edit_outsideCamp').value = editHead['No. of Individuals Outside Camp'] || '';
  $('edit_ass_tupad').checked = (editHead['TUPAD'] === 'Yes');
  $('edit_ass_local4ps').checked = (editHead['Local 4Ps'] === 'Yes');
  $('edit_ass_intl4ps').checked = (editHead['National 4Ps'] === 'Yes');
  $('edit_ass_locsp').checked = (editHead['Local Social Pension'] === 'Yes');
  $('edit_ass_intlsp').checked = (editHead['National Social Pension'] === 'Yes');
  $('edit_ass_solo').checked = (editHead['Solo Parent Assistance'] === 'Yes');
  $('edit_ass_cash').checked = (editHead['Cash Subsidy'] === 'Yes');
  $('edit_ass_relief').checked = (editHead['Relief Goods'] === 'Yes');
  $('edit_ass_aics').value = editHead['AICS'] || '';

  updateEditMembersPreview();
  openEditPanel();
  setTimeout(()=> $('edit_householdHead')?.focus(), 120);
}

function openEditPanel(){ $('editPanel')?.classList.add('open'); $('panelOverlay')?.classList.add('show'); }
function closeEditPanel(){ $('editPanel')?.classList.remove('open'); $('panelOverlay')?.classList.remove('show'); }

/* Head age/stage */
function updateEditHeadAgeStage(){
  const d = $('edit_householdBirthdate')?.value || '';
  const ageObj = computeAgeFromBirthdateISO(d);
  if(!ageObj){ if($('edit_householdAge')) $('edit_householdAge').value=''; if($('edit_householdStage')) $('edit_householdStage').value=''; return; }
  $('edit_householdAge').value = (ageObj.years === 0 ? 0 : ageObj.years);
  $('edit_householdStage').value = deriveStageFromAge(ageObj);
}

/* Members preview */
function updateEditMembersPreview(){
  const ul = $('edit_membersPreview');
  if(!ul) return;
  ul.innerHTML = '';
  const n = editMembers.length || 0;
  if($('edit_previewCount')) $('edit_previewCount').innerText = n;
  for(let i=0;i<n;i++){
    const li = document.createElement('li');
    const m = editMembers[i] || {};
    li.textContent = `#${i+1} ‚Äî ${m['Name of Household Member/s'] || '(empty)'}`;
    li.style.cursor = 'pointer';
    li.onclick = () => { memberEditIndex = i; openMemberPanelForEdit(i); };
    ul.appendChild(li);
  }
}

/* Add/Edit Members button handler */
function ensureMembersArraySize(){
  const expected = Number($('edit_memberCount')?.value || 0);
  while(editMembers.length < expected) editMembers.push(createEmptyMember());
  if(editMembers.length === 0) editMembers.push(createEmptyMember());
}

/* create empty member object */
function createEmptyMember(){
  return {
    'Name of Household Member/s':'',
    'Sex':'',
    'Birthdate':'',
    'Age':'',
    'Stage':'',
    'Persons with Disability (PWD)':'No',
    'Status':'',
    'Transportation':'',
    'Designated Pick-Up Point':'',
    'Drop-Off Point':'',
    'Name of Camp':'',
    'Capacity':'',
    'No. of Individuals Inside Camp':'',
    'No. of Individuals Outside Camp':'',
    'Reasons for Displacement':'',
    'TUPAD':'No','Local 4Ps':'No','National 4Ps':'No',
    'Local Social Pension':'No','National Social Pension':'No','Solo Parent Assistance':'No',
    'Cash Subsidy':'No','Relief Goods':'No','AICS':''
  };
}

/* MEMBER PANEL: open -> fill -> collect -> navigate */
function openMemberPanelForEdit(index){
  ensureMembersArraySize();
  memberEditIndex = index;
  const total = editMembers.length;
  $('memberPanelTitle').innerText = `Member ${index+1} of ${total}`;
  fillMemberPanelFromEdit(index);
  $('memberPanel')?.classList.add('open');
  $('panelOverlay')?.classList.add('show');
}

function fillMemberPanelFromEdit(idx){
  const m = editMembers[idx] || createEmptyMember();
  $('memberName').value = m['Name of Household Member/s'] || '';
  qAll("input[name='member_sex']").forEach(r => r.checked = (r.value === (m['Sex'] || '')));
  $('memberBirthdate').value = toInputDate(m['Birthdate'] || '');
  updateMemberAgeStage();
  qAll("input[name='member_pwd']").forEach(r => r.checked = (r.value === (m['Persons with Disability (PWD)'] || 'No')));
  $('memberStage').value = m['Stage'] || '';
  $('memberStatus').value = m['Status'] || '';
  $('memberTransport').value = m['Transportation'] || '';
  $('memberPickup').value = m['Designated Pick-Up Point'] || '';
  $('memberDropoff').value = m['Drop-Off Point'] || '';
  $('memberCamp').value = m['Name of Camp'] || '';
  $('memberCampCap').value = m['Capacity'] || '';
  $('memberInside').value = m['No. of Individuals Inside Camp'] || '';
  $('memberOutside').value = m['No. of Individuals Outside Camp'] || '';
  $('memberReason').value = m['Reasons for Displacement'] || '';
  $('member_tupad').checked = (m['TUPAD'] === 'Yes');
  $('member_local4ps').checked = (m['Local 4Ps'] === 'Yes');
  $('member_intl4ps').checked = (m['National 4Ps'] === 'Yes');
  $('member_locsp').checked = (m['Local Social Pension'] === 'Yes');
  $('member_intlsp').checked = (m['National Social Pension'] === 'Yes');
  $('member_solo').checked = (m['Solo Parent Assistance'] === 'Yes');
  $('member_cash').checked = (m['Cash Subsidy'] === 'Yes');
  $('member_relief').checked = (m['Relief Goods'] === 'Yes');
  $('memberAics').value = m['AICS'] || '';
}

function collectMemberPanelToEdit(){
  const name = $('memberName').value.trim();
  const sex = document.querySelector("input[name='member_sex']:checked")?.value || '';
  const birthdate_input = $('memberBirthdate').value || '';
  const birth_for_sheet = toSheetDate(birthdate_input);
  const age = $('memberAge').value || '';
  const stage = $('memberStage').value || '';
  const pwd = document.querySelector("input[name='member_pwd']:checked")?.value || 'No';
  const obj = {
    'Name of Household Member/s': name,
    'Sex': sex,
    'Birthdate': birth_for_sheet,
    'Age': age,
    'Stage': stage,
    'Persons with Disability (PWD)': pwd,
    'Status': $('memberStatus').value || '',
    'Transportation': $('memberTransport').value || '',
    'Designated Pick-Up Point': $('memberPickup').value || '',
    'Drop-Off Point': $('memberDropoff').value || '',
    'Name of Camp': $('memberCamp').value || '',
    'Capacity': $('memberCampCap').value || '',
    'No. of Individuals Inside Camp': $('memberInside').value || '',
    'No. of Individuals Outside Camp': $('memberOutside').value || '',
    'Reasons for Displacement': $('memberReason').value || '',
    'TUPAD': $('member_tupad').checked ? 'Yes' : 'No',
    'Local 4Ps': $('member_local4ps').checked ? 'Yes' : 'No',
    'National 4Ps': $('member_intl4ps').checked ? 'Yes' : 'No',
    'Local Social Pension': $('member_locsp').checked ? 'Yes' : 'No',
    'National Social Pension': $('member_intlsp').checked ? 'Yes' : 'No',
    'Solo Parent Assistance': $('member_solo').checked ? 'Yes' : 'No',
    'Cash Subsidy': $('member_cash').checked ? 'Yes' : 'No',
    'Relief Goods': $('member_relief').checked ? 'Yes' : 'No',
    'AICS': $('memberAics').value || ''
  };
  editMembers[memberEditIndex] = obj;
}

/* NAV: Next / Back inside member panel wired after DOM ready */

/* member date change -> update age & stage */
function updateMemberAgeStage(){
  const date = $('memberBirthdate').value;
  const ageObj = computeAgeFromBirthdateISO(date);
  if(!ageObj){ $('memberAge').value=''; $('memberStage').value=''; return; }
  $('memberAge').value = (ageObj.years === 0 ? 0 : ageObj.years);
  $('memberStage').value = deriveStageFromAge(ageObj);
}

/* HEAD collect */
function collectHeadFromEditForm(){
  const bd_input = $('edit_householdBirthdate').value || '';
  const headBirthForSheet = toSheetDate(bd_input);

  editHead = {
    'Barangay': $('edit_barangay').value || '',
    'Sitio / Purok': $('edit_sitio').value || '',
    'Name of Household Head': ($('edit_householdHead').value || '').trim(),
    'Sex': document.querySelector("input[name='edit_head_sex']:checked")?.value || '',
    'Birthdate': headBirthForSheet,
    'Age': $('edit_householdAge').value || '',
    'Stage': $('edit_householdStage').value || '',
    'No. of Household Member/s': String($('edit_memberCount').value || '0'),
    'Persons with Disability (PWD)': document.querySelector("input[name='edit_head_pwd']:checked")?.value || 'No',
    'Status': $('edit_head_status').value || '',
    'Transportation': $('edit_head_transport').value || '',
    'Designated Pick-Up Point': $('edit_pickup').value || '',
    'Drop-Off Point': $('edit_dropoff').value || '',
    'Name of Camp': $('edit_campName').value || '',
    'Capacity': $('edit_capacity').value || '',
    'No. of Individuals Inside Camp': $('edit_insideCamp').value || '',
    'No. of Individuals Outside Camp': $('edit_outsideCamp').value || '',
    'TUPAD': $('edit_ass_tupad').checked ? 'Yes' : 'No',
    'Local 4Ps': $('edit_ass_local4ps').checked ? 'Yes' : 'No',
    'National 4Ps': $('edit_ass_intl4ps').checked ? 'Yes' : 'No',
    'Local Social Pension': $('edit_ass_locsp').checked ? 'Yes' : 'No',
    'National Social Pension': $('edit_ass_intlsp').checked ? 'Yes' : 'No',
    'Solo Parent Assistance': $('edit_ass_solo').checked ? 'Yes' : 'No',
    'Cash Subsidy': $('edit_ass_cash').checked ? 'Yes' : 'No',
    'Relief Goods': $('edit_ass_relief').checked ? 'Yes' : 'No',
    'AICS': $('edit_ass_aics').value || ''
  };
}

/* ========================= SAVE EDITED HOUSEHOLD ========================= */
async function saveEditedHousehold(silentReload = false){
  collectHeadFromEditForm();

  const expected = Number($('edit_memberCount')?.value || 0);
  while(editMembers.length < expected) editMembers.push(createEmptyMember());
  if(editMembers.length > expected) editMembers = editMembers.slice(0, expected);

  const fd = new FormData();
  fd.append('action','updateHousehold');
  fd.append('dataID', editDataID);
  fd.append('head', JSON.stringify(editHead));
  fd.append('members', JSON.stringify(editMembers || []));
  fd.append('submittedBy', localStorage.getItem('staffName') || localStorage.getItem('username') || 'Unknown');

  const btn = $('saveEditBtn');
  if(btn){ btn.disabled = true; btn.innerText = 'Saving...'; }

  try {
    const res = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
    const text = await res.text();
    let json; try { json = JSON.parse(text); } catch(e){ throw new Error('Invalid server response'); }
    if(!json.success){ alert('Save failed: ' + (json.message || JSON.stringify(json))); console.error(json); }
    else {
      if(!silentReload) alert('Household updated (Data ID: ' + (editDataID||'') + ')');
      closeEditPanel();
      loadRecords();
    }
  } catch(err){
    console.error('Save error', err);
    alert('Network or server error. See console.');
  } finally {
    if(btn){ btn.disabled = false; btn.innerText = 'Save changes'; }
  }
}

/* ========================= EXPORT CSV (kept small) ========================= */
function groupsToCSV(groups){
  const cols = header.slice();
  const csv = [];
  csv.push(cols.map(c => `"${c.replace(/"/g,'""')}"`).join(','));
  groups.forEach(g => {
    const h = g.head || {};
    csv.push(cols.map(c => `"${String(h[c]||'').replace(/"/g,'""')}"`).join(','));
    (g.members||[]).forEach(m => csv.push(cols.map(c => `"${String(m[c]||'').replace(/"/g,'""')}"`).join(',')));
  });
  return csv.join('\r\n');
}
function downloadCSV(name, content){
  const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name; a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 500);
}
function exportAll(){ if(!groupsArr.length) return alert('Nothing to export.'); downloadCSV('mdrrmo_records_all.csv', groupsToCSV(groupsArr)); }
function exportSelected(){ const sel = groupsArr.filter(g => selectedIds.has(g.dataID)); if(!sel.length) return alert('No selected households.'); downloadCSV('mdrrmo_records_selected.csv', groupsToCSV(sel)); }

/* ========================= UI BINDINGS (wired on DOMContentLoaded) ========================= */
function wireUI(){
  if($('filterBarangay')) $('filterBarangay').onchange = loadRecords;
  if($('refreshBtn')) $('refreshBtn').onclick = loadRecords;
  if($('exportMenuBtn')) $('exportMenuBtn').onclick = ()=> $('exportDropdown')?.classList.toggle('hidden');
  document.addEventListener('click', e => {
    const menu = $('exportMenuBtn'), box = $('exportDropdown');
    if(menu && box && !menu.contains(e.target) && !box.contains(e.target)) box.classList.add('hidden');
  });
  if($('searchInput')) $('searchInput').addEventListener('input', ()=>{ clearTimeout(window.__typeTimer); window.__typeTimer = setTimeout(loadRecords, 300); });

  // member / edit controls
  if($('edit_addMember')) $('edit_addMember').addEventListener('click', ()=>{
    ensureMembersArraySize(); memberEditIndex = 0; openMemberPanelForEdit(memberEditIndex);
  });
  if($('memberNext')) $('memberNext').addEventListener('click', ()=>{
    const name = $('memberName').value.trim();
    if(!name){ alert('Please enter member name'); return; }
    collectMemberPanelToEdit();
    memberEditIndex++;
    if(memberEditIndex >= editMembers.length){
      $('memberPanel')?.classList.remove('open');
      updateEditMembersPreview();
      if(sequenceMode){
        sequenceMode = false;
        saveEditedHousehold(true);
      }
      return;
    }
    fillMemberPanelFromEdit(memberEditIndex);
    $('memberPanelTitle').innerText = `Member ${memberEditIndex+1} of ${editMembers.length}`;
  });
  if($('memberBack')) $('memberBack').addEventListener('click', ()=>{
    collectMemberPanelToEdit();
    if(memberEditIndex > 0){ memberEditIndex--; fillMemberPanelFromEdit(memberEditIndex); $('memberPanelTitle').innerText = `Member ${memberEditIndex+1} of ${editMembers.length}`; }
    else { $('memberPanel')?.classList.remove('open'); updateEditMembersPreview(); }
  });
  if($('memberPanelClose')) $('memberPanelClose').addEventListener('click', ()=> {
    if(confirm('Close member entry? Unsaved member edits will be kept in panel preview.')) { $('memberPanel')?.classList.remove('open'); updateEditMembersPreview(); }
  });
  if($('memberBirthdate')) $('memberBirthdate').addEventListener('change', updateMemberAgeStage);
  if($('edit_householdBirthdate')) $('edit_householdBirthdate').addEventListener('change', updateEditHeadAgeStage);
  if($('cancelEditBtn')) $('cancelEditBtn').addEventListener('click', ()=> { if(confirm('Discard changes and close?')) closeEditPanel(); });
  if($('panelClose')) $('panelClose').addEventListener('click', ()=> { if(confirm('Discard changes and close?')) closeEditPanel(); });
  if($('panelOverlay')) $('panelOverlay').addEventListener('click', ()=> {
    if($('memberPanel')?.classList.contains('open')) return;
    if(confirm('Close edit panel? Unsaved changes will be lost.')) closeEditPanel();
  });
  if($('startSequenceBtn')) $('startSequenceBtn').addEventListener('click', (ev)=> {
    ev.preventDefault();
    collectHeadFromEditForm();
    const expected = Number($('edit_memberCount')?.value || 0);
    while(editMembers.length < expected) editMembers.push(createEmptyMember());
    if(editMembers.length === 0){ saveEditedHousehold(true); return; }
    sequenceMode = true; memberEditIndex = 0; openMemberPanelForEdit(memberEditIndex);
  });
  if($('saveEditBtn')) $('saveEditBtn').addEventListener('click', (ev)=> { ev.preventDefault(); saveEditedHousehold(false); });

  // export menu items (if dropdown entries exist)
  // they call global functions exportAll / exportSelected defined above
}

/* ========================= INIT ========================= */
window.addEventListener('DOMContentLoaded', ()=>{
  // set username
  if($('userName')) $('userName').innerText = localStorage.getItem('staffName') || '';
  wireUI();
  loadRecords();
});
</script>

</body>
</html>





