<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Edit Household ‚Äî MDRRMO Alitagtag</title>
<link rel="stylesheet" href="styles.css"/>
<style>
/* ---------- Page-specific styling (keeps main layout) ---------- */
.member-panel { position: fixed; right: 0; top: 0; height: 100vh; width: 420px; max-width:96%; background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,250,0.98)); box-shadow: -18px 0 40px rgba(6,30,20,0.12); transform: translateX(110%); transition: transform 280ms cubic-bezier(.2,.9,.3,1); z-index:6000; padding:18px; overflow-y:auto; }
.member-panel.open { transform: translateX(0%); }
.panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.32); opacity: 0; transition: opacity 200ms; pointer-events: none; z-index:5900; }
.panel-overlay.show { opacity: 1; pointer-events: auto; }
.btn { border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;background: linear-gradient(90deg,#0f7a4a,#34b78f); color:#fff; }
.btn.secondary { background: transparent; color: #0f7a4a; border:1px solid rgba(6,30,20,0.06); }

.card { padding:14px;border-radius:10px;background:#fff;margin-bottom:12px;box-shadow:0 6px 18px rgba(6,30,20,0.04); }
.form-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
.small-muted { font-size:13px; color:#666; }
.member-preview { margin-top:8px; font-size:14px; list-style:none; padding-left:0; }
.member-preview li { margin-bottom:6px; padding:6px 8px; border-radius:6px; cursor:pointer; }
.member-preview li:hover { background:#f2fdf2; }
.actions-row { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
.icon-btn { padding:6px 8px; border-radius:6px; border:0; cursor:pointer; }

/* responsive adjustments */
@media (max-width:900px){
  .form-grid{ grid-template-columns: 1fr; }
  .member-panel{ width:100%; max-width:100%; }
}

/* input spacing small helpers */
.radio-line { display:flex; gap:10px; align-items:center; }
.radio-item { display:inline-flex; gap:6px; align-items:center; }

/* small required star */
.small { color:#a00; font-weight:700; margin-left:4px; }

/* overlay smooth */
.panel-header { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
.panel-body { padding-bottom:18px; }
.panel-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

/* make preview count bold */
#previewCount { font-weight:700; color:#0f7a4a; }

/* ensure form controls use site defaults */
input, select { padding:8px 10px; border-radius:8px; border:1px solid #ccc; width:100%; box-sizing:border-box; }
</style>
</head>
<body>
<div class="page-container">
  <header class="topbar">
    <button id="menuToggle" class="menu-btn" aria-label="Toggle menu">‚ò∞</button>
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="logo"/>
      <div><div class="title">PUROK KALIGTASAN</div><div class="subtitle">DRRMO - Alitagtag</div></div>
    </div>
    <div class="user-info">
      <span id="userName"></span>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <ul>
      <li><a href="dashboard.html">üìä Dashboard</a></li>
      <li><a href="dataForm.html">üìù Data Entry</a></li>
      <li><a href="records.html">üìÅ Records</a></li>
      <li><a href="charts.html">üìà Charts</a></li>
      <li class="admin-only"><a href="users.html">üë• User Management</a></li>
    </ul>
  </aside>

  <main class="content-area">
    <h2>Edit Household</h2>

    <form id="editHeadForm" onsubmit="return false;">
      <div class="card">
        <h3>Household Head ‚Äî Edit</h3>
        <div class="form-grid">

          <div>
            <label>Barangay <span class="small">*</span></label>
            <select id="barangay" required>
              <option value="">Select Barangay...</option>
              <option>Balagbag</option><option>Concepcion</option><option>Concordia</option><option>Dalipit East</option><option>Dalipit West</option>
              <option>Dominador East</option><option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
              <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option><option>Ping-As</option>
              <option>Poblacion East</option><option>Poblacion West</option><option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
            </select>
          </div>

          <div>
            <label>Sitio / Purok <span class="small">*</span></label>
            <select id="sitio" required>
              <option value="">Select...</option>
              <option>Purok I</option><option>Purok II</option><option>Purok III</option><option>Purok IV</option><option>Purok V</option><option>Purok VI</option><option>Purok VII</option>
            </select>
          </div>

          <div>
            <label>Name of Household Head <span class="small">*</span></label>
            <input type="text" id="householdHead" required />
          </div>

          <div>
            <label>Sex <span class="small">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="head_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate</label>
            <input type="date" id="householdBirthdate" />
          </div>

          <div>
            <label>Age</label>
            <input type="number" id="householdAge" readonly />
          </div>

          <div>
            <label>Stage</label>
            <input type="text" id="householdStage" readonly />
          </div>

          <div>
            <label>No. of Household Member/s <span class="small">*</span></label>
            <input type="number" id="memberCount" min="0" value="0" />
            <div class="small-muted">Set to 0 if no other members.</div>
          </div>
        </div>

        <hr style="margin:12px 0">

        <h4>Health and Status</h4>
        <div class="form-grid">
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_pwd" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="head_pwd" value="No"> No</label>
            </div>
          </div>

          <div>
            <label>Status</label>
            <select id="head_status">
              <option value="">Select...</option>
              <option>With Sickness</option><option>Pregnant</option><option>Others</option>
            </select>
          </div>

          <div>
            <label>Transportation</label>
            <select id="head_transport">
              <option value="">Select...</option>
              <option>Individual with Transportation</option>
              <option>Individual needing Transportation</option>
            </select>
          </div>
        </div>

        <hr style="margin:12px 0">

        <h4>Pickup / Transport / Camp Details</h4>
        <div class="form-grid">
          <div><label>Designated Pick-Up Point</label><input id="pickup" /></div>
          <div><label>Drop-Off Point</label><input id="dropoff" /></div>
          <div><label>Name of Camp</label><input id="campName" /></div>
          <div><label>Capacity</label><input type="number" id="capacity" min="0" /></div>
          <div><label>No. of Individuals Inside Camp</label><input type="number" id="insideCamp" min="0" value="0" /></div>
          <div><label>No. of Individuals Outside Camp</label><input type="number" id="outsideCamp" min="0" value="0" /></div>
        </div>

        <div style="margin-top:8px">
          <label>Reasons for Displacement</label>
          <select id="reasons">
            <option value="">Select...</option><option>With-in 14-15 KM Danger Zone</option><option>Others</option>
          </select>
        </div>

        <hr style="margin:12px 0">
        <h4>Assistance Received (optional)</h4>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
          <label><input type="checkbox" id="ass_tupad"> TUPAD</label>
          <label><input type="checkbox" id="ass_local4ps"> Local 4Ps</label>
          <label><input type="checkbox" id="ass_intl4ps"> National 4Ps</label>
          <label><input type="checkbox" id="ass_locsp"> Local Social Pension</label>
          <label><input type="checkbox" id="ass_intlsp"> National Social Pension</label>
          <label><input type="checkbox" id="ass_solo"> Solo Parent Assistance</label>
          <label><input type="checkbox" id="ass_relief"> Relief Goods</label>
          <label><input type="checkbox" id="ass_cash"> Cash Subsidy</label>
        </div>

        <div style="margin-top:8px">
          <label>AICS (if any)</label>
          <select id="ass_aics">
            <option value="">None</option>
            <option>Shelter Assistance</option>
            <option>Burial</option>
            <option>Scholarship</option>
          </select>
        </div>

        <div class="actions-row">
          <button id="saveBtn" class="btn">Save changes</button>
          <button id="cancelBtn" type="button" class="btn secondary">Cancel</button>
        </div>
      </div>

      <!-- Member preview -->
      <div class="card">
        <h4>Members</h4>
        <div class="small-muted">Count: <strong id="previewCount">0</strong></div>
        <ul id="membersPreview" class="member-preview"></ul>
      </div>
    </form>
  </main>
</div>

<!-- overlay + member panel -->
<div id="panelOverlay" class="panel-overlay" aria-hidden="true"></div>

<div id="memberPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Member entry panel">
  <div class="panel-header">
    <button id="panelClose" class="btn secondary" title="Close panel">‚Üê</button>
    <h3 id="panelTitle">Member 1 of N</h3>
  </div>

  <div class="panel-body">
    <form id="memberForm" onsubmit="return false;">
      <div class="form-grid">
        <div>
          <label>Member Name <span class="small">*</span></label>
          <input type="text" id="memberName" class="member-name" required />
        </div>

        <div>
          <label>Sex</label>
          <div class="radio-line">
            <label class="radio-item"><input type="radio" name="member_sex" value="Male" class="member-sex"> Male</label>
            <label class="radio-item"><input type="radio" name="member_sex" value="Female" class="member-sex"> Female</label>
          </div>
        </div>

        <div>
          <label>Birthdate</label>
          <input type="date" id="memberBirthdate" class="member-birthdate" />
        </div>

        <div>
          <label>Age</label>
          <input type="number" id="memberAge" class="member-age" readonly />
        </div>

        <div>
          <label>PWD</label>
          <div class="radio-line">
            <label class="radio-item"><input type="radio" name="member_pwd" value="Yes" class="member-pwd"> Yes</label>
            <label class="radio-item"><input type="radio" name="member_pwd" value="No" checked class="member-pwd"> No</label>
          </div>
        </div>

        <div>
          <label>Stage</label>
          <input type="text" id="memberStage" class="member-stage" readonly />
        </div>

        <div>
          <label>Status</label>
          <select id="memberStatus" class="member-status">
            <option value="">Select...</option><option>With Sickness</option><option>Pregnant</option>
          </select>
        </div>

        <div>
          <label>Transportation</label>
          <select id="memberTransport" class="member-transport">
            <option value="">Select...</option>
            <option>Individual with Transportation</option>
            <option>Individual needing Transportation</option>
          </select>
        </div>

        <div>
          <label>Designated Pick-Up Point</label>
          <input type="text" id="memberPickup" class="member-pickup"/>
        </div>

        <div>
          <label>Drop-Off Point</label>
          <input type="text" id="memberDropoff" class="member-dropoff"/>
        </div>

        <div>
          <label>Name of Camp</label>
          <input type="text" id="memberCamp" class="member-camp"/>
        </div>

        <div>
          <label>Capacity</label>
          <input type="number" id="memberCampCap" class="member-cap" min="0"/>
        </div>

        <div>
          <label>No. Inside Camp</label>
          <input type="number" id="memberInside" class="member-inside" min="0"/>
        </div>

        <div>
          <label>No. Outside Camp</label>
          <input type="number" id="memberOutside" class="member-outside" min="0"/>
        </div>

        <div>
          <label>Reason</label>
          <select id="memberReason" class="member-reason">
            <option value="">Select...</option><option>With-in 14-15 KM Danger Zone</option><option>Others</option>
          </select>
        </div>

        <div style="grid-column:1/-1; margin-top:8px">
          <h4 style="margin:6px 0 8px 0">Government Support</h4>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px 12px">
            <label><input type="checkbox" id="member_tupad" class="member_tupad"> TUPAD</label>
            <label><input type="checkbox" id="member_local4ps" class="member_local4ps"> Local 4Ps</label>
            <label><input type="checkbox" id="member_intl4ps" class="member_intl4ps"> National 4Ps</label>
            <label><input type="checkbox" id="member_locsp" class="member_locsp"> Local Social Pension</label>
            <label><input type="checkbox" id="member_intlsp" class="member_intlsp"> National Social Pension</label>
            <label><input type="checkbox" id="member_solo" class="member_solo"> Solo Parent Assistance</label>
            <label><input type="checkbox" id="member_cash" class="member_cash"> Cash Subsidy</label>
            <label><input type="checkbox" id="member_relief" class="member_relief"> Relief Goods</label>
          </div>

          <div style="margin-top:8px">
            <label>AICS (if any)</label>
            <select id="memberAics" class="member_aics">
              <option value="">None</option>
              <option>Shelter Assistance</option>
              <option>Burial</option>
              <option>Scholarship</option>
            </select>
          </div>
        </div>

      </div>

      <div class="panel-actions">
        <button id="memberBack" class="btn secondary" type="button">Back</button>
        <button id="memberNext" class="btn" type="button">Save & Next</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ========== CONFIG ========== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxWs1kxkyleYw6qcQlIx1xsecQS8x2O-nyXxbcdcm5DVst6IcmDKR-NmzSgBxyH7ErvpA/exec";

/* ========== HELPERS ========== */
function computeAge(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (isNaN(d)) return "";
  const now = new Date();
  let age = now.getFullYear() - d.getFullYear();
  if (now.getMonth() < d.getMonth() || (now.getMonth() === d.getMonth() && now.getDate() < d.getDate())) age--;
  return age;
}
function getStageFromAge(age) {
  if (age === "" || age === null || age === undefined) return "";
  const a = Number(age);
  if (isNaN(a)) return "";
  if (a <= 1) return "Infant";
  if (a <= 12) return "Children";
  if (a <= 17) return "School Children";
  if (a >= 60) return "Elderly";
  return "Adult";
}
function openPanel(){ document.getElementById("memberPanel").classList.add("open"); document.getElementById("panelOverlay").classList.add("show"); }
function closePanel(){ document.getElementById("memberPanel").classList.remove("open"); document.getElementById("panelOverlay").classList.remove("show"); }

/* ========== STATE ========== */
let editDataID = null;
let collectedMembers = []; // array of member objects (one per member)
let currentMemberIndex = 0;

/* ========== DOM SHORTCUTS ========== */
const previewCountEl = () => document.getElementById("previewCount");
const membersPreviewUL = () => document.getElementById("membersPreview");

/* ========== JSONP helper for getRecords (GAS) ========== */
function jsonpGetRecords(params, callback) {
  const timestamp = Date.now();
  const cbName = "cb_records_" + timestamp + "_" + Math.floor(Math.random()*1000);
  window[cbName] = function(resp){
    try { callback(null, resp); } finally { delete window[cbName]; }
  };
  const query = `action=getRecords&filterBarangay=${encodeURIComponent(params.filterBarangay||"")}&filterStage=${encodeURIComponent(params.filterStage||"")}&q=${encodeURIComponent(params.q||"")}&callback=${cbName}`;
  const s = document.createElement('script');
  s.src = SCRIPT_URL + "?" + query;
  s.onerror = function(){ callback(new Error("JSONP failed")); delete window[cbName]; };
  document.body.appendChild(s);
}

/* ========== Load household rows from Master by edit_dataID ========== */
function loadHouseholdForEdit() {
  editDataID = localStorage.getItem("edit_dataID");
  if (!editDataID) { alert("No edit_dataID found. Open an entry from records page first."); return; }

  jsonpGetRecords({}, function(err, data) {
    if (err) { alert("Failed to load data"); return; }
    if (!data || !data.success) { alert("Failed to load data: " + (data && data.message)); return; }

    const rows = data.rows.filter(r => String(r["Data ID"]) === String(editDataID));
    if (!rows || rows.length === 0) { alert("No rows found for Data ID " + editDataID); return; }

    // HEAD detection: row where Name of Household Member/s is empty (preferred)
    let headRow = rows.find(r => !r["Name of Household Member/s"] || String(r["Name of Household Member/s"]).trim() === "");
    if (!headRow) headRow = rows[0];

    const members = rows.filter(r => r["Name of Household Member/s"] && String(r["Name of Household Member/s"]).trim() !== "");

    // fill form head
    fillHeadForm(headRow);

    // fill collectedMembers array exactly from rows (preserve order)
    collectedMembers = members.map(m => ({
      "Name of Household Member/s": m["Name of Household Member/s"] || "",
      "Sex": m["Sex"] || "",
      "Birthdate": m["Birthdate"] || "",
      "Age": m["Age"] || "",
      "Stage": m["Stage"] || "",
      "Persons with Disability (PWD)": m["Persons with Disability (PWD)"] || "No",
      "Status": m["Status"] || "",
      "Transportation": m["Transportation"] || "",
      "Designated Pick-Up Point": m["Designated Pick-Up Point"] || "",
      "Drop-Off Point": m["Drop-Off Point"] || "",
      "Name of Camp": m["Name of Camp"] || "",
      "Capacity": m["Capacity"] || "",
      "No. of Individuals Inside Camp": m["No. of Individuals Inside Camp"] || "",
      "No. of Individuals Outside Camp": m["No. of Individuals Outside Camp"] || "",
      "Reasons for Displacement": m["Reasons for Displacement"] || "",
      "TUPAD": m["TUPAD"] || "No",
      "Local 4Ps": m["Local 4Ps"] || "No",
      "National 4Ps": m["National 4Ps"] || "No",
      "Local Social Pension": m["Local Social Pension"] || "No",
      "National Social Pension": m["National Social Pension"] || "No",
      "Solo Parent Assistance": m["Solo Parent Assistance"] || "No",
      "Cash Subsidy": m["Cash Subsidy"] || "No",
      "Relief Goods": m["Relief Goods"] || "No",
      "AICS": m["AICS"] || ""
    }));

    // ensure collectedMembers length matches memberCount value (if head says 3 but only 2 members exist, fill blanks)
    const expected = Number(document.getElementById("memberCount").value || 0);
    while (collectedMembers.length < expected) collectedMembers.push({
      "Name of Household Member/s":"", "Sex":"", "Birthdate":"", "Age":"", "Stage":"", "Persons with Disability (PWD)":"No",
      "Status":"", "Transportation":"", "Designated Pick-Up Point":"", "Drop-Off Point":"", "Name of Camp":"", "Capacity":"",
      "No. of Individuals Inside Camp":"", "No. of Individuals Outside Camp":"", "Reasons for Displacement":"", "TUPAD":"No",
      "Local 4Ps":"No","National 4Ps":"No","Local Social Pension":"No","National Social Pension":"No","Solo Parent Assistance":"No",
      "Cash Subsidy":"No","Relief Goods":"No","AICS":""
    });

    updateMemberPreview();
  });
}

/* ========== Fill head form helper ========== */
function fillHeadForm(headObj){
  if(!headObj) return;
  document.getElementById("barangay").value = headObj["Barangay"] || "";
  document.getElementById("sitio").value = headObj["Sitio / Purok"] || "";
  document.getElementById("householdHead").value = headObj["Name of Household Head"] || "";
  Array.from(document.getElementsByName("head_sex")).forEach(r => r.checked = (r.value === (headObj["Sex"] || "")));
  document.getElementById("householdBirthdate").value = headObj["Birthdate"] || "";
  document.getElementById("householdAge").value = headObj["Age"] || "";
  document.getElementById("householdStage").value = headObj["Stage"] || "";
  document.getElementById("memberCount").value = headObj["No. of Household Member/s"] || 0;
  document.getElementById("pickup").value = headObj["Designated Pick-Up Point"] || "";
  document.getElementById("dropoff").value = headObj["Drop-Off Point"] || "";
  document.getElementById("campName").value = headObj["Name of Camp"] || "";
  document.getElementById("capacity").value = headObj["Capacity"] || "";
  document.getElementById("insideCamp").value = headObj["No. of Individuals Inside Camp"] || "";
  document.getElementById("outsideCamp").value = headObj["No. of Individuals Outside Camp"] || "";
  document.getElementById("reasons").value = headObj["Reasons for Displacement"] || "";
  document.getElementsByName("head_pwd").forEach(r=>r.checked = (r.value === (headObj["Persons with Disability (PWD)"] || "No")));
  document.getElementById("head_status").value = headObj["Status"] || "";
  document.getElementById("head_transport").value = headObj["Transportation"] || "";
  document.getElementById("ass_tupad").checked = (headObj["TUPAD"] === "Yes");
  document.getElementById("ass_local4ps").checked = (headObj["Local 4Ps"] === "Yes");
  document.getElementById("ass_intl4ps").checked = (headObj["National 4Ps"] === "Yes");
  document.getElementById("ass_locsp").checked = (headObj["Local Social Pension"] === "Yes");
  document.getElementById("ass_intlsp").checked = (headObj["National Social Pension"] === "Yes");
  document.getElementById("ass_solo").checked = (headObj["Solo Parent Assistance"] === "Yes");
  document.getElementById("ass_relief").checked = (headObj["Relief Goods"] === "Yes");
  document.getElementById("ass_cash").checked = (headObj["Cash Subsidy"] === "Yes");
  document.getElementById("ass_aics").value = headObj["AICS"] || "";
}

/* ========== Member preview and panel helpers ========== */
function updateMemberPreview(){
  const n = Number(document.getElementById("memberCount").value || 0);
  previewCountEl().innerText = n;
  const list = membersPreviewUL();
  list.innerHTML = "";
  for (let i=0;i<n;i++){
    const li = document.createElement("li");
    const mem = collectedMembers[i];
    li.innerText = mem && mem["Name of Household Member/s"] ? `#${i+1} ‚Äî ${mem["Name of Household Member/s"]}` : `#${i+1} ‚Äî (empty)`;
    li.dataset.index = i;
    li.onclick = () => {
      currentMemberIndex = i;
      fillMemberPanel(i);
      document.getElementById('panelTitle').innerText = `Member ${i+1} of ${n}`;
      openPanel();
    };
    list.appendChild(li);
  }
}

/* ========== Fill member panel from collectedMembers[idx] ========== */
function fillMemberPanel(idx){
  const mem = collectedMembers[idx] || {};
  document.getElementById("memberName").value = mem["Name of Household Member/s"] || "";
  Array.from(document.getElementsByName("member_sex")).forEach(r => r.checked = (r.value === (mem["Sex"] || "")));
  document.getElementById("memberBirthdate").value = mem["Birthdate"] || "";
  document.getElementById("memberAge").value = mem["Age"] || "";
  document.getElementById("memberStage").value = mem["Stage"] || "";
  // PWD radio (if present)
  document.getElementsByName("member_pwd").forEach(r=>r.checked = (r.value === (mem["Persons with Disability (PWD)"]||"No")));
  document.getElementById("memberStatus").value = mem["Status"] || "";
  document.getElementById("memberTransport").value = mem["Transportation"] || "";
  document.getElementById("memberPickup").value = mem["Designated Pick-Up Point"] || "";
  document.getElementById("memberDropoff").value = mem["Drop-Off Point"] || "";
  document.getElementById("memberCamp").value = mem["Name of Camp"] || "";
  document.getElementById("memberCampCap").value = mem["Capacity"] || "";
  document.getElementById("memberInside").value = mem["No. of Individuals Inside Camp"] || "";
  document.getElementById("memberOutside").value = mem["No. of Individuals Outside Camp"] || "";
  document.getElementById("memberReason").value = mem["Reasons for Displacement"] || "";
  document.getElementById("member_tupad").checked = (mem["TUPAD"] === "Yes");
  document.getElementById("member_local4ps").checked = (mem["Local 4Ps"] === "Yes");
  document.getElementById("member_intl4ps").checked = (mem["National 4Ps"] === "Yes");
  document.getElementById("member_locsp").checked = (mem["Local Social Pension"] === "Yes");
  document.getElementById("member_intlsp").checked = (mem["National Social Pension"] === "Yes");
  document.getElementById("member_solo").checked = (mem["Solo Parent Assistance"] === "Yes");
  document.getElementById("member_relief").checked = (mem["Relief Goods"] === "Yes");
  document.getElementById("member_cash").checked = (mem["Cash Subsidy"] === "Yes");
  document.getElementById("memberAics").value = mem["AICS"] || "";
}

/* ========== Collect member from panel into object ========== */
function collectMemberFromPanel(){
  const name = document.getElementById("memberName").value.trim();
  const sex = document.querySelector("input[name='member_sex']:checked")?.value || "";
  const birthdate = document.getElementById("memberBirthdate").value || "";
  const age = computeAge(birthdate) || "";
  const stage = getStageFromAge(age) || "";
  return {
    "Name of Household Member/s": name,
    "Sex": sex,
    "Birthdate": birthdate,
    "Age": age,
    "Stage": stage,
    "Persons with Disability (PWD)": (document.querySelector("input[name='member_pwd']:checked")?.value || "No"),
    "Status": document.getElementById("memberStatus").value || "",
    "Transportation": document.getElementById("memberTransport").value || "",
    "Designated Pick-Up Point": document.getElementById("memberPickup").value || "",
    "Drop-Off Point": document.getElementById("memberDropoff").value || "",
    "Name of Camp": document.getElementById("memberCamp").value || "",
    "Capacity": document.getElementById("memberCampCap").value || "",
    "No. of Individuals Inside Camp": document.getElementById("memberInside").value || "",
    "No. of Individuals Outside Camp": document.getElementById("memberOutside").value || "",
    "Reasons for Displacement": document.getElementById("memberReason").value || "",
    "TUPAD": document.getElementById("member_tupad").checked ? "Yes" : "No",
    "Local 4Ps": document.getElementById("member_local4ps").checked ? "Yes" : "No",
    "National 4Ps": document.getElementById("member_intl4ps").checked ? "Yes" : "No",
    "Local Social Pension": document.getElementById("member_locsp").checked ? "Yes" : "No",
    "National Social Pension": document.getElementById("member_intlsp").checked ? "Yes" : "No",
    "Solo Parent Assistance": document.getElementById("member_solo").checked ? "Yes" : "No",
    "Relief Goods": document.getElementById("member_relief").checked ? "Yes" : "No",
    "Cash Subsidy": document.getElementById("member_cash").checked ? "Yes" : "No",
    "AICS": document.getElementById("memberAics").value || ""
  };
}

/* ========== UI Bindings & Save logic ========== */
document.addEventListener('DOMContentLoaded', () => {
  // show staff name if available
  document.getElementById("userName").innerText = localStorage.getItem("staffName") || "";

  // auto-age/stage updates for head and member birthdates
  document.getElementById("householdBirthdate").addEventListener("input", () => {
    const a = computeAge(document.getElementById("householdBirthdate").value);
    document.getElementById("householdAge").value = a;
    document.getElementById("householdStage").value = getStageFromAge(a);
  });
  document.getElementById("memberBirthdate").addEventListener("input", () => {
    const a = computeAge(document.getElementById("memberBirthdate").value);
    document.getElementById("memberAge").value = a;
    document.getElementById("memberStage").value = getStageFromAge(a);
  });

  // panel controls
  document.getElementById("panelClose").addEventListener("click", () => closePanel());

  document.getElementById("memberBack").addEventListener("click", () => {
    // save current member then go back (or close)
    collectedMembers[currentMemberIndex] = collectMemberFromPanel();
    if (currentMemberIndex > 0) {
      currentMemberIndex--;
      fillMemberPanel(currentMemberIndex);
      const total = Number(document.getElementById("memberCount").value || 0);
      document.getElementById('panelTitle').innerText = `Member ${currentMemberIndex+1} of ${total}`;
      updateMemberPreview();
    } else {
      // if back from first member, close
      closePanel();
    }
  });

  document.getElementById("memberNext").addEventListener("click", () => {
    // save current member then go next (or close when finished)
    const name = document.getElementById("memberName").value.trim();
    if (!name) { alert("Please enter member name."); return; }
    collectedMembers[currentMemberIndex] = collectMemberFromPanel();
    updateMemberPreview();
    currentMemberIndex++;
    const total = Number(document.getElementById("memberCount").value || 0);
    if (currentMemberIndex >= total) { closePanel(); return; }
    fillMemberPanel(currentMemberIndex);
    document.getElementById('panelTitle').innerText = `Member ${currentMemberIndex+1} of ${total}`;
  });

  // memberCount change adjusts collectedMembers array length
  document.getElementById("memberCount").addEventListener("change", () => {
    const expected = Number(document.getElementById("memberCount").value || 0);
    if (collectedMembers.length > expected) collectedMembers = collectedMembers.slice(0, expected);
    while (collectedMembers.length < expected) collectedMembers.push({
      "Name of Household Member/s":"", "Sex":"", "Birthdate":"", "Age":"", "Stage":"", "Persons with Disability (PWD)":"No",
      "Status":"", "Transportation":"", "Designated Pick-Up Point":"", "Drop-Off Point":"", "Name of Camp":"", "Capacity":"",
      "No. of Individuals Inside Camp":"", "No. of Individuals Outside Camp":"", "Reasons for Displacement":"", "TUPAD":"No",
      "Local 4Ps":"No","National 4Ps":"No","Local Social Pension":"No","National Social Pension":"No","Solo Parent Assistance":"No",
      "Cash Subsidy":"No","Relief Goods":"No","AICS":""
    });
    updateMemberPreview();
  });

  // Cancel/back to records
  document.getElementById("cancelBtn").addEventListener("click", () => { window.location.href = "records.html"; });

  // Save changes (updateHousehold)
  document.getElementById("saveBtn").addEventListener("click", async () => {
    // Build head object with all editable fields
    const head = {
      "Barangay": document.getElementById("barangay").value || "",
      "Sitio / Purok": document.getElementById("sitio").value || "",
      "Name of Household Head": document.getElementById("householdHead").value || "",
      "Sex": document.querySelector("input[name='head_sex']:checked")?.value || "",
      "Birthdate": document.getElementById("householdBirthdate").value || "",
      "Age": document.getElementById("householdAge").value || "",
      "Stage": document.getElementById("householdStage").value || "",
      "No. of Household Member/s": document.getElementById("memberCount").value || 0,
      "Persons with Disability (PWD)": (document.querySelector("input[name='head_pwd']:checked")?.value || "No"),
      "Status": document.getElementById("head_status").value || "",
      "Transportation": document.getElementById("head_transport").value || "",
      "Designated Pick-Up Point": document.getElementById("pickup").value || "",
      "Drop-Off Point": document.getElementById("dropoff").value || "",
      "Name of Camp": document.getElementById("campName").value || "",
      "Capacity": document.getElementById("capacity").value || "",
      "No. of Individuals Inside Camp": document.getElementById("insideCamp").value || "",
      "No. of Individuals Outside Camp": document.getElementById("outsideCamp").value || "",
      "Reasons for Displacement": document.getElementById("reasons").value || "",
      "TUPAD": document.getElementById("ass_tupad").checked ? "Yes" : "No",
      "Local 4Ps": document.getElementById("ass_local4ps").checked ? "Yes" : "No",
      "National 4Ps": document.getElementById("ass_intl4ps").checked ? "Yes" : "No",
      "Local Social Pension": document.getElementById("ass_locsp").checked ? "Yes" : "No",
      "National Social Pension": document.getElementById("ass_intlsp").checked ? "Yes" : "No",
      "Solo Parent Assistance": document.getElementById("ass_solo").checked ? "Yes" : "No",
      "Relief Goods": document.getElementById("ass_relief").checked ? "Yes" : "No",
      "Cash Subsidy": document.getElementById("ass_cash").checked ? "Yes" : "No",
      "AICS": document.getElementById("ass_aics").value || ""
    };

    // Ensure collectedMembers length matches memberCount
    const expected = Number(document.getElementById("memberCount").value || 0);
    while (collectedMembers.length < expected) collectedMembers.push({
      "Name of Household Member/s":"", "Sex":"", "Birthdate":"", "Age":"", "Stage":"", "Persons with Disability (PWD)":"No",
      "Status":"", "Transportation":"", "Designated Pick-Up Point":"", "Drop-Off Point":"", "Name of Camp":"", "Capacity":"",
      "No. of Individuals Inside Camp":"", "No. of Individuals Outside Camp":"", "Reasons for Displacement":"", "TUPAD":"No",
      "Local 4Ps":"No","National 4Ps":"No","Local Social Pension":"No","National Social Pension":"No","Solo Parent Assistance":"No",
      "Cash Subsidy":"No","Relief Goods":"No","AICS":""
    });

    // Build FormData and send
    const fd = new FormData();
    fd.append("action", "updateHousehold");
    fd.append("dataID", editDataID);
    fd.append("head", JSON.stringify(head));
    fd.append("members", JSON.stringify(collectedMembers));
    fd.append("submittedBy", localStorage.getItem("staffName") || localStorage.getItem("username") || "Unknown");

    const btn = document.getElementById("saveBtn");
    btn.disabled = true; btn.innerText = "Saving...";

    try {
      const res = await fetch(SCRIPT_URL, { method: "POST", body: fd });
      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch (e) { throw new Error("Invalid server response"); }
      if (!json.success) {
        alert("Save failed: " + (json.message || JSON.stringify(json)));
        console.error("UPDATE ERROR:", json);
      } else {
        alert("Household updated successfully (Data ID: " + editDataID + ")");
        window.location.href = "records.html";
      }
    } catch (err) {
      console.error("NETWORK / SERVER ERROR:", err);
      alert("Network or server error. See console.");
    } finally {
      btn.disabled = false; btn.innerText = "Save changes";
    }
  });

  // finally load the household
  loadHouseholdForEdit();
});

/* ========== small utilities ========== */
function computeAge(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (isNaN(d)) return "";
  const now = new Date();
  let age = now.getFullYear() - d.getFullYear();
  if (now.getMonth() < d.getMonth() || (now.getMonth() === d.getMonth() && now.getDate() < d.getDate())) age--;
  return age;
}
function getStageFromAge(age) {
  if (age === "" || age === null || age === undefined) return "";
  const a = Number(age);
  if (isNaN(a)) return "";
  if (a <= 1) return "Infant";
  if (a <= 12) return "Children";
  if (a <= 17) return "School Children";
  if (a >= 60) return "Elderly";
  return "Adult";
}
</script>
</body>
</html>
