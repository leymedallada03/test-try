<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan ‚Äî Household Records</title>
<link rel="stylesheet" href="styles.css"/>

<style>
/* === SAME DESIGN FROM YOUR ORIGINAL FILE (SHORTENED COMMENTS) === */

.member-row.hidden { display:none; }

/* Topbar, Sidebar, Table, Buttons ‚Äî preserved from your version */
.search-box { padding:8px 12px; border:1px solid #bbb; border-radius:8px; min-width:260px; }

.btn {
  padding:8px 14px;
  border-radius:8px;
  background:#0f7a4a;
  color:white;
  border:none;
  cursor:pointer;
  font-weight:700;
}

.btn-secondary {
  padding:8px 14px;
  border-radius:8px;
  background:white;
  border:1px solid #0f7a4a;
  cursor:pointer;
}

/* Export dropdown */
.export-wrapper { position:relative; }
.export-dropdown {
  position:absolute;
  top:40px;
  right:0;
  background:white;
  border:1px solid #ccc;
  border-radius:10px;
  width:170px;
  padding:6px 0;
  box-shadow:0 5px 18px rgba(0,0,0,0.12);
  z-index:9999;
}
.export-dropdown div { padding:10px 14px; cursor:pointer; }
.export-dropdown div:hover { background:#e9fff0; }
.hidden { display:none; }

/* Table */
.records-wrapper { overflow:auto; background:white; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.06); }
.records-table { width:100%; border-collapse:collapse; min-width:1200px; }
.records-table th, .records-table td {
  padding:8px 10px;
  border-bottom:1px solid #eee;
  white-space:nowrap;
}
.records-table thead th {
  background:#f4f7f4;
  position:sticky; top:0;
  z-index:20;
  font-weight:700;
}
.select-col { position:sticky; left:0; background:white; z-index:30; }
.actions-col { position:sticky; right:0; background:white; z-index:30; }

/* Counts */
.green { color:#0f7a4a; font-weight:700; }
</style>
</head>


<body>
<div class="page-container">

<header class="topbar">
  <button id="menuToggle" class="menu-btn">‚ò∞</button>

  <div class="brand">
    <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
    <div>
      <div class="title">PUROK KALIGTASAN</div>
      <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
    </div>
  </div>

  <div class="user-info">
    <span id="userName"></span>
    <button id="logoutBtn" class="logout-btn">Logout</button>
  </div>
</header>


<aside class="sidebar" id="sidebar">
<ul>
  <li><a href="dashboard.html">üìä Dashboard</a></li>
  <li><a href="dataForm.html">üìù Data Entry</a></li>
  <li><a href="records.html" class="active">üìÅ Records</a></li>
  <li><a href="charts.html">üìà Charts</a></li>
  <li class="admin-only"><a href="users.html">üë• User Management</a></li>
</ul>
</aside>


<main class="content-area">
<h2>üìÅ Household Records</h2>

<!-- Top counts -->
<div style="display:flex; justify-content:flex-end; gap:20px; margin-bottom:10px;">
  <span>Rows: <strong class="green" id="rowCount">0</strong></span>
  <span>Matches: <strong class="green" id="matchCount">0</strong></span>
  <span>Selected: <strong class="green" id="selectedCount">0</strong></span>
</div>


<!-- Toolbar -->
<div style="display:flex; justify-content:space-between; margin-bottom:15px;">

  <input id="searchInput" class="search-box" placeholder="Search by Name / Barangay / ID..."/>

  <select id="filterBarangay" class="brgy-dropdown">
    <option value="">All Barangays</option>
    <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
    <option>Dalipit East</option><option>Dalipit West</option>
    <option>Dominador East</option><option>Dominador West</option>
    <option>Munlawin Sur</option><option>Munlawin Norte</option>
    <option>Muzon Primero</option><option>Muzon Segundo</option>
    <option>Pinagkurusan</option><option>Ping-As</option>
    <option>Poblacion East</option><option>Poblacion West</option>
    <option>San Jose</option><option>San Juan</option>
    <option>Santa Cruz</option><option>Tadlac</option>
  </select>

  <button id="refreshBtn" class="btn">Refresh</button>

  <div class="export-wrapper">
    <button id="exportBtn" class="btn-secondary">Export ‚ñº</button>
    <div id="exportDropdown" class="export-dropdown hidden">
      <div onclick="exportAll()">Export All</div>
      <div onclick="exportSelected()">Export Selected</div>
    </div>
  </div>

</div>


<div class="records-wrapper">
  <table id="recordsTable" class="records-table">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<div id="paginationArea" style="text-align:center; margin-top:15px;"></div>

</main>
</div>


<!-- Loading -->
<div id="loading" style="display:none; position:fixed; inset:0; background:rgba(255,255,255,0.7); align-items:center; justify-content:center; z-index:9999;">
  <div style="padding:15px; background:white; border-radius:10px; box-shadow:0 5px 20px rgba(0,0,0,0.1);">
    Loading records‚Ä¶
  </div>
</div>


<script>
/* ============================================================
   CONFIG
============================================================ */
const SCRIPT_URL = "YOUR_DEPLOYED_WEBAPP_URL_HERE";  /* <-- PUT YOUR NEW DEPLOYED URL */

/* ============================================================
   STATE
============================================================ */
let header = [];
let rawRows = [];
let groups = [];
let selected = new Set();
let currentPage = 1;
const rowsPerPage = 25;


/* ============================================================
   UTILITIES
============================================================ */
function showLoading(x){ document.getElementById("loading").style.display = x ? "flex" : "none"; }

function highlight(text, q){
  text = String(text ?? "");
  if(!q) return text;
  const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"), "gi");
  return text.replace(re, m => `<span class="hl">${m}</span>`);
}


/* ============================================================
   FETCH RECORDS
============================================================ */
async function loadRecords(){
  showLoading(true);
  try {
    const barangay = document.getElementById("filterBarangay").value || "";
    const q = document.getElementById("searchInput").value.trim();

    const url = `${SCRIPT_URL}?action=getRecords&filterBarangay=${encodeURIComponent(barangay)}&q=${encodeURIComponent(q)}`;

    const res = await fetch(url, { method:"GET" });
    const data = await res.json();

    if(!data.success){
      alert("Failed to load");
      return;
    }

    header = data.header || [];
    rawRows = data.rows || [];

    groupData();
    currentPage = 1;
    renderTable();
    renderPagination();
    updateCounts();

  } catch (err){
    console.error(err);
    alert("Error loading records");
  }
  showLoading(false);
}


/* ============================================================
   GROUP BY DATA ID
============================================================ */
function groupData(){
  const map = {};

  rawRows.forEach(r=>{
    let id = String(r["Data ID"] || "");
    if(!id) return;

    if(!map[id]) map[id] = { dataID:id, head:null, members:[] };

    const isHead = !r["Name of Household Member/s"];
    if(isHead && !map[id].head) map[id].head = r;
    else map[id].members.push(r);
  });

  groups = Object.values(map).sort((a,b)=> Number(a.dataID)-Number(b.dataID));
}


/* ============================================================
   RENDER TABLE
============================================================ */
function renderTable(){
  const thead = document.getElementById("tableHead");
  const tbody = document.getElementById("tableBody");

  thead.innerHTML = "";
  tbody.innerHTML = "";

  let headHTML = `<tr>
      <th class="select-col"><input type="checkbox" id="selectAll"></th>
  `;

  header.forEach(h=> headHTML += `<th>${h}</th>`);
  headHTML += `<th class="actions-col">Members</th><th class="actions-col">Actions</th></tr>`;
  thead.innerHTML = headHTML;

  const start = (currentPage - 1) * rowsPerPage;
  const list = groups.slice(start, start + rowsPerPage);
  const keyword = document.getElementById("searchInput").value.trim();

  list.forEach(g=>{
    const head = g.head || {};
    const memCount = g.members.length;

    let tr = document.createElement("tr");

    // Select checkbox
    let tdSel = document.createElement("td");
    tdSel.className = "select-col";
    tdSel.innerHTML = `<input type="checkbox" class="row-select" data-id="${g.dataID}" ${selected.has(g.dataID)?"checked":""}>`;
    tr.appendChild(tdSel);

    header.forEach(col=>{
      let td = document.createElement("td");
      td.innerHTML = highlight(head[col] || "", keyword);
      tr.appendChild(td);
    });

    let tdMem = document.createElement("td");
    tdMem.className = "actions-col";
    tdMem.innerHTML = `<button onclick="toggleMembers('${g.dataID}')">Show (${memCount})</button>`;
    tr.appendChild(tdMem);

    let tdAct = document.createElement("td");
    tdAct.className = "actions-col";
    tdAct.innerHTML = `
      <button onclick="onEdit('${g.dataID}')">Edit</button>
      <button onclick="onDelete('${g.dataID}')">Delete</button>
    `;
    tr.appendChild(tdAct);

    tbody.appendChild(tr);

    // MEMBER ROWS
    g.members.forEach(m=>{
      let mr = document.createElement("tr");
      mr.className = "member-row hidden";
      mr.dataset.parent = g.dataID;

      mr.appendChild(document.createElement("td")); // empty select col

      header.forEach(col=>{
        let td = document.createElement("td");
        td.innerHTML = highlight(m[col] || "", keyword);
        mr.appendChild(td);
      });

      mr.appendChild(document.createElement("td"));
      mr.appendChild(document.createElement("td"));

      tbody.appendChild(mr);
    });

  });

  document.getElementById("selectAll").onchange = function(){
    list.forEach(g=>{
      if(this.checked) selected.add(g.dataID);
      else selected.delete(g.dataID);
    });
    renderTable();
  };

  document.querySelectorAll(".row-select").forEach(cb=>{
    cb.onchange = function(){
      const id = this.dataset.id;
      if(this.checked) selected.add(id);
      else selected.delete(id);
      updateCounts();
    };
  });

}


/* ============================================================
   MEMBERS TOGGLE
============================================================ */
function toggleMembers(id){
  document.querySelectorAll(`tr.member-row[data-parent="${id}"]`)
    .forEach(r=> r.classList.toggle("hidden"));
}


/* ============================================================
   PAGINATION
============================================================ */
function renderPagination(){
  let div = document.getElementById("paginationArea");
  let total = Math.ceil(groups.length / rowsPerPage);

  if(total <= 1){ div.innerHTML = ""; return; }

  let html = "";

  for(let i=1; i<=total; i++){
    html += `<button onclick="gotoPage(${i})" class="${currentPage===i?"active":""}">${i}</button>`;
  }

  div.innerHTML = html;
}
function gotoPage(p){
  currentPage = p;
  renderTable();
  renderPagination();
}


/* ============================================================
   COUNTS
============================================================ */
function updateCounts(){
  document.getElementById("rowCount").innerText = groups.length;
  document.getElementById("matchCount").innerText = groups.length;
  document.getElementById("selectedCount").innerText = selected.size;
}


/* ============================================================
   EDIT & DELETE
============================================================ */
function onEdit(id){
  localStorage.setItem("edit_dataID", id);
  location.href = "edit.html";
}

async function onDelete(id){
  if(!confirm("Delete household " + id + "?")) return;

  let fd = new FormData();
  fd.append("action", "deleteHousehold");
  fd.append("dataID", id);

  const res = await fetch(SCRIPT_URL, { method:"POST", body:fd });
  const json = await res.json();

  if(json.success){
    alert("Deleted");
    loadRecords();
  } else {
    alert("Delete failed");
  }
}


/* ============================================================
   EXPORT CSV
============================================================ */
function exportAll(){
  exportCSV(groups);
}

function exportSelected(){
  let arr = groups.filter(g=> selected.has(g.dataID));
  if(!arr.length){ alert("No selected rows"); return; }
  exportCSV(arr);
}

function exportCSV(list){
  let cols = header;
  let lines = [];

  lines.push(cols.join(","));

  list.forEach(g=>{
    let h = g.head;

    lines.push(cols.map(c => `"${(h[c]||"").replace(/"/g,'""')}"`).join(","));

    g.members.forEach(m=>{
      lines.push(cols.map(c => `"${(m[c]||"").replace(/"/g,'""')}"`).join(","));
    });
  });

  let blob = new Blob([lines.join("\r\n")], {type:"text/csv"});
  let url = URL.createObjectURL(blob);

  let a = document.createElement("a");
  a.href = url;
  a.download = "records.csv";
  a.click();

  URL.revokeObjectURL(url);
}


/* ============================================================
   UI BINDINGS
============================================================ */
document.getElementById("refreshBtn").onclick = loadRecords;
document.getElementById("filterBarangay").onchange = loadRecords;
document.getElementById("searchInput").oninput = ()=> setTimeout(loadRecords, 250);

document.getElementById("exportBtn").onclick = () => {
  document.getElementById("exportDropdown").classList.toggle("hidden");
};

document.addEventListener("click", e=>{
  let box = document.getElementById("exportDropdown");
  let btn = document.getElementById("exportBtn");
  if(!btn.contains(e.target) && !box.contains(e.target)){
    box.classList.add("hidden");
  }
});


/* ============================================================
   INIT
============================================================ */
window.onload = function(){
  document.getElementById("userName").innerText = localStorage.getItem("staffName") || "";
  loadRecords();
};

</script>
</body>
</html>
