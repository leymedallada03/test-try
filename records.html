<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan â€” Household Records</title>
<link rel="stylesheet" href="styles.css"/>

<style>
/* compact adjustments requested */
.icon-btn { background:none;border:none;font-size:14px;cursor:pointer;padding:4px;border-radius:6px; }
.icon-btn:hover{background:#e8fff0}
.records-table th, .records-table td{padding:6px 8px;font-size:13px;line-height:1.2}
.records-table tr{height:34px}
.actions-col, .select-col{width:90px}
.select-col input, .row-select{transform:scale(1);}
.member-row td{padding-left:14px}
/* make "Show" toggle small & inline with row */
.icon-show{font-size:13px;padding:4px 6px;border-radius:6px;border:1px solid rgba(6,30,20,0.06);background:transparent}
.icon-small{font-size:14px}
.legend-box{margin-top:14px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.legend-color{width:14px;height:14px;border-radius:4px;display:inline-block;margin-right:8px}
/* search highlight distinct color */
.hl{background:#fffe8a;padding:2px 3px;border-radius:4px}
/* responsive */
@media(max-width:980px){ .records-table{min-width:1100px} }
</style>
</head>

<body>
<div class="page-container">

<header class="topbar">
  <button id="menuToggle" class="menu-btn">â˜°</button>
  <div class="brand">
    <img src="assets/MDRRMO Logo.png" class="logo"/>
    <div><div class="title">PUROK KALIGTASAN</div><div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div></div>
  </div>
  <div class="user-info"><span id="userName"></span><button id="logoutBtn" class="logout-btn">Logout</button></div>
</header>

<aside class="sidebar" id="sidebar">...
<ul>
  <li><a href="dashboard.html">ğŸ“Š Dashboard</a></li>
  <li><a href="dataForm.html">ğŸ“ Data Entry</a></li>
  <li><a href="records.html" class="active">ğŸ“ Records</a></li>
  <li><a href="charts.html">ğŸ“ˆ Charts</a></li>
  <li class="admin-only"><a href="users.html">ğŸ‘¥ User Management</a></li>
</ul>
</aside>

<main class="content-area">
<h2>ğŸ“ Household Records</h2>

<div style="display:flex; justify-content:flex-end; gap:18px; margin-bottom:10px;">
  <span>Rows: <strong class="green" id="rowCount">0</strong></span>
  <span>Matches: <strong class="green" id="matchCount">0</strong></span>
  <span>Selected: <strong class="green" id="selectedCount">0</strong></span>
</div>

<div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; margin-bottom:12px; align-items:center">
  <input id="searchInput" class="search-box" placeholder="Search by Name / Barangay / ID..."/>
  <select id="filterBarangay" class="brgy-dropdown"> <option value="">All Barangays</option> <!-- options kept as before --> </select>
  <button id="refreshBtn" class="btn-main">âŸ³ Refresh</button>
  <div class="export-wrapper">
    <button id="exportBtn" class="btn-secondary">ğŸ“¤ Export â–¾</button>
    <div id="exportDropdown" class="export-dropdown hidden"><div onclick="exportAll()">Export All</div><div onclick="exportSelected()">Export Selected</div></div>
  </div>
</div>

<div class="records-wrapper">
  <table class="records-table">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<div id="paginationArea" style="margin-top:12px"></div>

<div class="legend-box" style="margin-top:14px">
  <div class="legend-card"> <strong>Household Color Legend:</strong>
    <div><span class="legend-color" style="background:#d4f6ff"></span>1 Member</div>
    <div><span class="legend-color" style="background:#d9ffd9"></span>2â€“4 Members</div>
    <div><span class="legend-color" style="background:#fff7c2"></span>5â€“7 Members</div>
    <div><span class="legend-color" style="background:#ffd6d6"></span>8+ Members</div>
  </div>
</div>

</main>
</div>

<div id="loading" style="display:none; position:fixed; inset:0; background:rgba(255,255,255,0.7); align-items:center; justify-content:center; z-index:9999;"><div style="padding:12px;background:white;border-radius:10px;">Loading recordsâ€¦</div></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";
let header = [];
let rawRows = [];
let groups = [];
let selected = new Set();
let currentPage = 1; const rowsPerPage = 25;

function showLoading(x){ document.getElementById('loading').style.display = x ? 'flex' : 'none'; }
function highlight(text,q){ text = String(text||''); if(!q) return text; const r = new RegExp(q.replace(/[.*+?^${}()|[\\]\\]/g,'\\$&'),'gi'); return text.replace(r,m=>`<span class="hl">${m}</span>`); }

async function loadRecords(){ showLoading(true);
  try{
    const barangay = document.getElementById('filterBarangay').value||'';
    const q = document.getElementById('searchInput').value.trim();
    const res = await fetch(`${SCRIPT_URL}?action=getRecords&filterBarangay=${encodeURIComponent(barangay)}&q=${encodeURIComponent(q)}`);
    const data = await res.json();
    if(!data.success){ alert('Load failed'); showLoading(false); return; }
    header = data.header || [];
    rawRows = data.rows || [];
    groupRows(); currentPage=1; renderTable(); renderPagination(); updateCounts();
  }catch(err){ console.error(err); alert('Error loading records'); }
  showLoading(false);
}

function groupRows(){ const map = {}; rawRows.forEach(r=>{ const id = String(r['Data ID']||''); if(!id) return; if(!map[id]) map[id]={dataID:id, head:null, members:[]}; const isHead = !r['Name of Household Member/s']; if(isHead && !map[id].head) map[id].head = r; else map[id].members.push(r); }); groups = Object.values(map).sort((a,b)=> Number(a.dataID)-Number(b.dataID)); }

function renderTable(){ const thead = document.getElementById('tableHead'); const tbody = document.getElementById('tableBody'); thead.innerHTML = ''; tbody.innerHTML = '';
  // build header using server header (but ensure exact expected order will be used for export)
  let h = `<tr><th class="select-col"><input id="selectAll" type="checkbox"></th>`;
  header.forEach(c=> h += `<th>${c}</th>`);
  h += `<th class="actions-col">Members</th><th class="actions-col">Actions</th></tr>`;
  thead.innerHTML = h;

  const start = (currentPage-1)*rowsPerPage; const page = groups.slice(start, start+rowsPerPage);
  const keyword = document.getElementById('searchInput').value.trim();

  page.forEach(g=>{
    const head = g.head||{}; const mCount = g.members.length;
    let cls = mCount <=1 ? 'mem-small' : mCount<=4 ? 'mem-normal' : mCount<=7 ? 'mem-large' : 'mem-critical';
    const tr = document.createElement('tr'); tr.className = cls;
    const tdSel = document.createElement('td'); tdSel.className='select-col'; tdSel.innerHTML = `<input class="row-select" type="checkbox" data-id="${g.dataID}" ${selected.has(g.dataID)?'checked':''}>`; tr.appendChild(tdSel);

    header.forEach(c=>{ const td = document.createElement('td'); td.innerHTML = highlight(head[c]||'', keyword); tr.appendChild(td); });

    const tdM = document.createElement('td'); tdM.className='actions-col'; tdM.innerHTML = `<button class="icon-show" onclick="toggleMembers('${g.dataID}')">ğŸ‘ Show (${mCount})</button>`; tr.appendChild(tdM);

    const tdA = document.createElement('td'); tdA.className='actions-col'; tdA.innerHTML = `<button class="icon-btn" title="Edit" onclick="onEdit('${g.dataID}')">âœï¸</button> <button class="icon-btn" title="Delete" onclick="onDelete('${g.dataID}')">ğŸ—‘ï¸</button>`; tr.appendChild(tdA);

    tbody.appendChild(tr);

    g.members.forEach(m=>{
      const mr = document.createElement('tr'); mr.className='member-row hidden'; mr.dataset.parent = g.dataID;
      mr.appendChild(document.createElement('td'));
      header.forEach(c=>{ const td=document.createElement('td'); td.innerHTML = highlight(m[c]||'', keyword); mr.appendChild(td); });
      mr.appendChild(document.createElement('td')); mr.appendChild(document.createElement('td'));
      tbody.appendChild(mr);
    });
  });

  // select all
  document.getElementById('selectAll').onchange = function(){ page.forEach(g=>{ if(this.checked) selected.add(g.dataID); else selected.delete(g.dataID); }); renderTable(); };
  document.querySelectorAll('.row-select').forEach(cb=> cb.onchange = function(){ const id=this.dataset.id; if(this.checked) selected.add(id); else selected.delete(id); updateCounts(); });
}

function toggleMembers(id){ document.querySelectorAll(`tr.member-row[data-parent="${id}"]`).forEach(r=> r.classList.toggle('hidden')); }

function renderPagination(){ const div = document.getElementById('paginationArea'); const total = Math.ceil(groups.length/rowsPerPage); if(total<=1){ div.innerHTML=''; return; } let html=''; for(let i=1;i<=total;i++) html += `<button onclick="gotoPage(${i})" class="${i===currentPage?'active':''}">${i}</button>`; div.innerHTML = html; }
function gotoPage(p){ currentPage=p; renderTable(); renderPagination(); }
function updateCounts(){ document.getElementById('rowCount').innerText = groups.length; document.getElementById('matchCount').innerText = groups.length; document.getElementById('selectedCount').innerText = selected.size; }

function onEdit(id){ localStorage.setItem('edit_dataID', id); location.href='edit.html'; }

async function onDelete(id){ if(!confirm(`Delete household ${id}?`)) return; const fd = new FormData(); fd.append('action','deleteHousehold'); fd.append('dataID', id); try{ const res = await fetch(SCRIPT_URL, { method:'POST', body:fd }); const j = await res.json(); if(j.success){ alert(`Data has been deleted. Data ID: ${id} from Master and Barangay`); loadRecords(); } else { alert('Delete failed: ' + (j.message||'Unknown')); } }catch(e){ console.error(e); alert('Delete failed â€” see console'); } }

function exportAll(){ exportCSV(groups); }
function exportSelected(){ const arr = groups.filter(g=> selected.has(g.dataID)); if(!arr.length) return alert('No selected rows'); exportCSV(arr); }
function exportCSV(list){ const cols = header.slice(); const lines=[]; lines.push(cols.join(',')); list.forEach(g=>{ lines.push(cols.map(c=> `"${String(g.head[c]||'').replace(/"/g,'""')}"`).join(',')); g.members.forEach(m=> lines.push(cols.map(c=> `"${String(m[c]||'').replace(/"/g,'""')}"`).join(','))); }); const blob = new Blob([lines.join('\r\n')], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='records.csv'; a.click(); URL.revokeObjectURL(url); }

// UI bindings
document.getElementById('refreshBtn').onclick = loadRecords;
document.getElementById('filterBarangay').onchange = loadRecords;
document.getElementById('searchInput').oninput = ()=> setTimeout(loadRecords, 220);
document.getElementById('exportBtn').onclick = ()=> document.getElementById('exportDropdown').classList.toggle('hidden');
document.addEventListener('click', e=>{ const box=document.getElementById('exportDropdown'); const btn=document.getElementById('exportBtn'); if(!btn.contains(e.target) && !box.contains(e.target)) box.classList.add('hidden'); });

window.onload = ()=>{ document.getElementById('userName').innerText = localStorage.getItem('staffName') || ''; loadRecords(); };
</script>
</body>
</html>
