<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan ‚Äî Household Records</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
   /* ORIGINAL RECORDS STYLES */
   :root{
    --bg:#f6f8f7;
    --card-bg:#fff;
    --muted:#6b6f6b;
    --accent1:#0f7a4a;
    --accent2:#34b78f;
    --accent3: #ff7a00;
    --accent4: #ffa500;
    --hazard-red: #dc2626;
    --hazard-orange: #ef4444;
    --light-green: #e9f7f2;
    --border: #e1e8e5;
    --shadow: 0 6px 18px rgba(6,30,20,0.06);
    --shadow-dark: 0 6px 20px rgba(5,40,25,0.12);
    --radius:12px;
    --radius-sm:8px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
   }
   
   /* EDIT PANEL STYLES FROM edit.html */
   .member-panel {
     position: fixed;
     right: 0;
     top: 0;
     height: 100vh;
     width: 520px;
     max-width: 96%;
     background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,250,0.98));
     box-shadow: -18px 0 40px rgba(6,30,20,0.12);
     transform: translateX(110%);
     transition: transform 280ms cubic-bezier(.2,.9,.3,1);
     z-index: 6000;
     padding: 18px;
     overflow-y: auto;
   }
   
   .member-panel.open {
     transform: translateX(0%);
   }
   
   .member-panel .panel-header {
     display: flex;
     align-items: center;
     gap: 10px;
     margin-bottom: 10px;
   }
   
   .member-panel h3 {
     margin: 0;
     font-size: 18px;
     color: var(--accent1);
   }
   
   .member-panel .panel-body {
     margin-top: 8px;
   }
   
   .member-panel .panel-actions {
     display: flex;
     gap: 8px;
     justify-content: flex-end;
     margin-top: 12px;
   }
   
   .panel-overlay {
     position: fixed;
     inset: 0;
     background: rgba(0,0,0,0.32);
     opacity: 0;
     transition: opacity 200ms;
     pointer-events: none;
     z-index: 5900;
   }
   
   .panel-overlay.show {
     opacity: 1;
     pointer-events: auto;
   }
   
   /* FIX 1: Improved radio button alignment - UPDATED to match dataForm.html */
   .form-row {
     margin-bottom: 12px;
   }
   
   .radio-line, .radio-group {
     margin-top: 8px;
     padding: 8px 0;
     display: flex;
     gap: 16px;
     align-items: center;
     flex-wrap: wrap;
   }
   
   .radio-item {
     display: flex;
     align-items: center;
     gap: 8px;
     font-weight: 600;
     color: var(--accent1);
     cursor: pointer;
   }
   
   .radio-item input[type="radio"] {
     accent-color: var(--accent1);
     width: 18px;
     height: 18px;
     margin: 0;
     transform: scale(1.1);
   }
   
   .btn.secondary {
     background: transparent;
     color: #0f7a4a;
     border: 1px solid rgba(6,30,20,0.06);
   }
   
   /* Card styling for edit form */
   .edit-card {
     padding: 16px;
     border-radius: var(--radius);
     background: white;
     margin-bottom: 16px;
     box-shadow: 0 4px 12px rgba(6,30,20,0.08);
     border: 1px solid var(--border);
   }
   
   /* FIX 4: Consistent form section headers */
   .form-section {
     background: var(--light-green);
     padding: 10px 14px;
     border-radius: var(--radius-sm);
     margin: 20px 0 16px 0;
     border-left: 4px solid var(--accent1);
   }
   
   .form-section h5 {
     margin: 0;
     color: var(--accent1);
     font-size: 15px;
     font-weight: 700;
   }
   
   .form-grid {
     display: grid;
     grid-template-columns: repeat(2,1fr);
     gap: 16px;
   }
   
   .small-muted {
     font-size: 13px;
     color: #666;
   }
   
   .green {
     color: #0f7a4a;
     font-weight: 700;
   }
   
   /* Specific edit form styling */
   .coordinate-container {
     display: flex;
     gap: 8px;
     align-items: flex-start;
     flex-wrap: wrap;
   }
   
   .coordinate-container input {
     flex: 1;
     min-width: 200px;
   }
   
   .coordinate-container .btn {
     white-space: nowrap;
     padding: 8px 12px;
     font-size: 14px;
   }
   
   /* Form controls */
   .member-panel input,
   .member-panel select,
   .member-panel textarea {
     width: 100%;
     padding: 10px 12px;
     border: 2px solid var(--border);
     border-radius: var(--radius-sm);
     font-size: 14px;
     font-family: inherit;
     box-sizing: border-box;
     margin-top: 6px;
   }
   
   .member-panel input:focus,
   .member-panel select:focus,
   .member-panel textarea:focus {
     outline: none;
     border-color: var(--accent1);
     box-shadow: 0 0 0 3px rgba(15,122,74,0.1);
   }
   
   .member-panel label {
     font-weight: 600;
     font-size: 14px;
     color: var(--muted);
     display: block;
     margin-bottom: 6px;
   }
   
   /* Hazard hunter button */
   .btn.hazard-hunter {
     background: linear-gradient(90deg, var(--hazard-red), var(--hazard-orange)) !important;
     color: white !important;
     border: none !important;
   }
   
   .btn.hazard-hunter:hover {
     background: linear-gradient(90deg, #b91c1c, var(--hazard-red)) !important;
     box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2) !important;
   }
   
   /* FIX 2: Larger checkboxes like dataForm.html - UPDATED */
   .checkbox-item {
     display: flex;
     align-items: center;
     gap: 10px;
     font-weight: 600;
     color: var(--accent1);
     cursor: pointer;
     margin: 6px 0;
     padding: 4px 0;
   }
   
   .checkbox-item input[type="checkbox"] {
     accent-color: var(--accent1);
     width: 20px;
     height: 20px;
     margin: 0;
     cursor: pointer;
     transform: scale(1.1);
   }
   
   /* Conditional fields */
   .conditional-field {
     display: none;
     margin-top: 8px;
     animation: fadeIn 0.3s ease;
   }
   
   .conditional-field.show {
     display: block;
   }
   
   @keyframes fadeIn {
     from { opacity: 0; transform: translateY(-5px); }
     to { opacity: 1; transform: translateY(0); }
   }
   
   /* Animal grid */
   .domestic-grid {
     display: grid;
     grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
     gap: 12px;
     margin-top: 12px;
   }
   
   .animal-card {
     background: var(--light-green);
     padding: 12px;
     border-radius: var(--radius-sm);
     border: 2px solid var(--border);
     transition: all 0.3s ease;
   }
   
   .animal-card:hover {
     border-color: var(--accent1);
     transform: translateY(-2px);
     box-shadow: 0 4px 12px rgba(15,122,74,0.1);
   }
   
   .animal-header {
     display: flex;
     align-items: center;
     gap: 12px;
     margin-bottom: 8px;
   }
   
   .animal-qty {
     display: flex;
     align-items: center;
     gap: 8px;
   }
   
   .animal-qty label {
     margin: 0;
     font-weight: 600;
     color: var(--muted);
     font-size: 14px;
   }
   
   .qty {
     width: 70px;
     padding: 8px;
     border-radius: var(--radius-sm);
     border: 2px solid var(--border);
     text-align: center;
     font-size: 14px;
   }
   
   .others-box {
     width: 100%;
     min-height: 80px;
     padding: 12px;
     border-radius: var(--radius-sm);
     border: 2px solid var(--border);
     font-family: inherit;
     font-size: 14px;
     margin-top: 8px;
     resize: vertical;
   }
   
   /* Government support grid */
   .gov-support-grid {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
     gap: 12px 20px;
     margin-top: 12px;
   }
   
   .gov-support-grid .checkbox-item {
     min-height: 40px;
     padding: 10px 0;
   }
   
   /* Error messages */
   .error-message {
     color: #dc2626;
     font-size: 12px;
     margin-top: 4px;
     display: none;
   }
   
   .input-error {
     border-color: #dc2626 !important;
   }
   
   /* Required field indicator */
   .required {
     color: #dc2626;
     margin-left: 2px;
   }
   
   /* Panel improvements */
   .panel-body {
     padding-right: 8px;
   }
   
   .panel-body h4 {
     margin: 20px 0 16px 0;
     color: var(--accent1);
     font-size: 16px;
     border-bottom: 2px solid var(--light-green);
     padding-bottom: 8px;
   }
   
   /* Data ID display */
   .data-id-display {
     background: #f0f9ff;
     padding: 10px 14px;
     border-radius: 8px;
     border: 1px solid #d1e9ff;
     margin-bottom: 16px;
     font-weight: bold;
     color: #0f7a4a;
   }
   
   .data-id-display span {
     background: #e3f2fd;
     padding: 4px 8px;
     border-radius: 4px;
     font-family: monospace;
   }
   
   /* Member preview improvements */
   .member-preview {
     list-style: none;
     padding: 0;
     margin: 12px 0;
     max-height: 200px;
     overflow-y: auto;
     border: 1px solid var(--border);
     border-radius: 8px;
     padding: 8px;
   }
   
   .member-preview li {
     padding: 10px 12px;
     border-bottom: 1px solid #eee;
     cursor: pointer;
     transition: background 0.2s;
   }
   
   .member-preview li:hover {
     background: #f0f9ff;
   }
   
   .member-preview li:last-child {
     border-bottom: none;
   }
   
   .member-preview li .member-actions {
     float: right;
     display: flex;
     gap: 6px;
   }
   
   .member-preview li .member-actions button {
     background: none;
     border: none;
     cursor: pointer;
     padding: 2px 6px;
     font-size: 12px;
   }
   
   .member-preview li .member-actions .edit-btn {
     color: #0f7a4a;
   }
   
   .member-preview li .member-actions .remove-btn {
     color: #dc2626;
   }
   
   /* Form section spacing */
   .member-panel .edit-card + .edit-card {
     margin-top: 20px;
   }
   
   /* Specific grid column spans */
   .member-panel .form-grid > div[style*="grid-column"] {
     grid-column: 1 / -1;
   }
   
   /* FIX 3: Coordinate modal styles */
   .coordinate-modal {
     display: none;
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background: rgba(0,0,0,0.5);
     z-index: 7000;
     align-items: center;
     justify-content: center;
   }
   
   .coordinate-modal.active {
     display: flex;
   }
   
   .coordinate-modal-content {
     background: white;
     padding: 24px;
     border-radius: var(--radius);
     width: 90%;
     max-width: 500px;
     box-shadow: var(--shadow-dark);
   }
   
   .coordinate-modal-content h4 {
     margin-top: 0;
     color: var(--accent1);
     border-bottom: 2px solid var(--light-green);
     padding-bottom: 12px;
     margin-bottom: 20px;
   }
   
   .modal-coordinate-input {
     width: 100%;
     padding: 12px;
     border: 2px solid var(--border);
     border-radius: var(--radius-sm);
     margin: 12px 0;
     font-size: 14px;
   }
   
   .modal-coordinate-input:focus {
     outline: none;
     border-color: var(--accent1);
     box-shadow: 0 0 0 3px rgba(15,122,74,0.1);
   }
   
   .modal-coordinate-actions {
     display: flex;
     gap: 12px;
     justify-content: flex-end;
     margin-top: 20px;
   }
   
   /* Responsive for edit panel */
   @media(max-width:900px){
     .form-grid {
       grid-template-columns: 1fr;
     }
     
     .member-panel {
       width: 100%;
     }
     
     .domestic-grid {
       grid-template-columns: 1fr;
     }
     
     .gov-support-grid {
       grid-template-columns: repeat(2, 1fr);
     }
     
     .radio-group {
       gap: 16px;
       flex-wrap: wrap;
     }
   }

   /* FIX: Ensure member panel action buttons are visible */
   #memberPanel .panel-actions {
     display: flex !important;
     gap: 8px;
     justify-content: flex-end;
     margin-top: 20px;
     padding: 16px 0;
     border-top: 1px solid var(--border);
   }

   #memberPanel .panel-actions button {
     min-width: 120px;
   }

   /* FIX: Ensure all form elements in member panel are properly spaced */
   #memberPanel .edit-card {
     margin-bottom: 20px;
   }

   #memberPanel .edit-card:last-of-type {
     margin-bottom: 0;
   }

   /* FIX: Improve contact number input validation styling */
   .member-panel input[type="text"][id$="contact"],
   .member-panel input[type="tel"] {
     font-family: monospace;
     letter-spacing: 0.5px;
   }

   .member-panel input.input-error {
     border-color: #dc2626 !important;
     background-color: #fff5f5;
   }

   #memberContactError, #edit_contactError {
     color: #dc2626;
     font-size: 12px;
     margin-top: 4px;
     display: none;
   }

   /* Ensure the member panel body has enough padding at bottom */
   #memberPanel .panel-body {
     padding-bottom: 80px !important;
   }

   /* Head name with checkbox container - FIXED */
   .head-name-container {
     display: flex;
     align-items: flex-start;
     gap: 0;
     flex-wrap: wrap;
     margin-bottom: 0;
   }

   .head-name-container input[type="text"] {
     flex: 1;
     min-width: 200px;
     margin-bottom: 0;
   }

   /* FIXED: Remove space between Household Head Full Name and FishR/RBIS Registered button */
   .head-registration-container {
     display: flex;
     align-items: center;
     gap: 16px;
     margin-top: 3px;
     padding: 0;
     background: transparent;
     border-radius: 0;
     border-left: none;
   }

   .head-registration-container .checkbox-item {
     margin: 0;
   }

   /* FIXED: Better alignment for conditional field in Educational & Economic Status */
   .form-grid .conditional-field {
     grid-column: 1 / -1;
     margin-top: 8px;
     margin-bottom: 0;
   }

   /* FIXED: Ensure proper spacing in form grids */
   .form-grid > div:not(:last-child) {
     margin-bottom: 0;
   }

   /* ORIGINAL RECORDS STYLES CONTINUED */
   #disc {
    margin-bottom: 10px;
    background: var(--light-green);
    padding: 12px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--accent1);
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.5;
   }
   body {
    background-color: var(--bg);
    margin: 0;
    min-height: 100vh;
   }

   .page-container{
    max-width:1200px;
    margin:20px auto;
    padding:12px;
    display:grid;
    grid-template-columns:260px 1fr;
    gap:18px;
    align-items:start;
    transition: grid-template-columns 0.3s ease;
   }

   .page-container.collapsed {
    grid-template-columns: 60px 1fr;
   }

   /* Topbar - Enhanced */
   .topbar{
    grid-column:1/-1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
    border-radius:var(--radius);
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    box-shadow:var(--shadow-dark);
   }

   .brand{
    display:flex;
    gap:12px;
    align-items:center;
   }

   .brand .logo{
    width:48px;
    height:48px;
    border-radius:var(--radius-sm);
    object-fit:contain;
    background: rgba(255,255,255,0.1);
    padding: 4px;
    border: 2px solid rgba(255,255,255,0.2);
   }

   .brand-text h1 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
   }

   .brand-text p {
    font-size:12px;
    opacity:0.95;
    margin: 4px 0 0 0;
   }

   .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
   }

   #userName {
    font-weight: 600;
    border-radius: 20px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
   }

   #logoutBtn {
    background: rgba(255,255,255,0.25);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
   }

   #logoutBtn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
   }

   /* Sidebar - Collapsible */
   .sidebar{
    background:linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.20));
    border-radius:var(--radius);
    padding:12px;
    height:calc(100vh - 120px);
    position:sticky;
    top:72px;
    overflow:auto;
    transition: width 0.3s ease;
   }

   .sidebar-container {
    display: flex;
    flex-direction: column;
    height: 100%;
   }

   .sidebar-toggle {
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.3s ease;
   }

   .sidebar-toggle:hover {
    transform: scale(1.1);
   }

   .sidebar ul{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
    flex: 1;
   }

   .sidebar li a{
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    text-decoration: none;
    color: var(--muted);
    border-radius: var(--radius-sm);
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
   }

   .sidebar li a:hover{
    background: var(--light-green);
    color: var(--accent1);
   }

   .sidebar li a.active{
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .sidebar li a .menu-icon {
    font-size: 1.2rem;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
   }

   .sidebar li a .menu-text {
    transition: opacity 0.3s ease;
   }

   .page-container.collapsed .sidebar li a .menu-text {
    opacity: 0;
    width: 0;
    overflow: hidden;
   }

   /* Content Area - Fixed Size */
   .content-area{
    background:linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
    border-radius:var(--radius);
    padding:18px;
    box-shadow:0 8px 22px rgba(10,20,16,0.06);
    min-height:72vh;
    height: calc(100vh - 120px);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
   }

   /* Content Header - Fixed */
   .content-header {
    margin-top: 0;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
   }

   .content-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: var(--accent1);
    display: flex;
    align-items: center;
    gap: 8px;
   }

   /* Stats - Made Smaller */
   .stats-container {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
   }

   .stat-item {
    text-align: center;
    min-width: 70px;
    padding: 6px 8px;
    background: white;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
   }

   .stat-item span {
    font-size: 0.75rem;
    color: var(--muted);
    display: block;
    margin-bottom: 2px;
   }

   .stat-item .value {
    font-size: 1rem;
    font-weight: 700;
    color: var(--accent1);
    display: block;
   }

   /* Toolbar - New Layout */
   .toolbar {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
   }

   .toolbar-row-1 {
    display: flex;
    width: 100%;
   }

   .search-container {
    position: relative;
    flex: 1;
    width: 100%;
   }

   .search-container i {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 0.9rem;
    z-index: 1;
   }

   .search-box{
    padding: 10px 12px 10px 32px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    background: white;
    width: 100%;
    box-sizing: border-box;
   }

   .search-box:focus {
    outline: none;
    border-color: var(--accent1);
    box-shadow: 0 0 0 3px rgba(15,122,74,0.1);
   }

   .toolbar-row-2 {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    align-items: center;
   }

   .brgy-dropdown{
    padding: 8px 10px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: white;
    color: var(--muted);
    font-size: 0.85rem;
    min-width: 160px;
    cursor: pointer;
    height: 36px;
    box-sizing: border-box;
   }

   .brgy-dropdown:focus {
    outline: none;
    border-color: var(--accent1);
   }

   .btn {
    border:0;
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    cursor:pointer;
    font-weight:600;
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    white-space: nowrap;
    height: 36px;
    box-sizing: border-box;
   }

   .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .btn-export {
    background: linear-gradient(90deg, var(--accent3), var(--accent4));
   }

   .btn-export:hover {
    box-shadow: 0 4px 8px rgba(255,122,0,0.2);
   }

   /* Records Table - Fixed */
   .records-wrapper{
    flex: 1;
    background:rgba(255,255,255,0.95);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:auto;
    position: relative;
    margin-bottom: 16px;
    border: 1px solid var(--border);
   }

   .records-table{
    width:100%;
    min-width:1400px;
    border-collapse:collapse;
    font-size: 14px;
   }

   .records-table th{
    background: var(--light-green);
    padding: 10px 8px;
    text-align: center;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 100;
    font-size: 14px;
    color: var(--accent1);
    border-bottom: 2px solid rgba(15,122,74,0.15);
    white-space: nowrap;
    vertical-align: middle;
    height: 40px;
    box-sizing: border-box;
   }

   .records-table td{
    padding: 8px 6px;
    font-size: 14px;
    border-bottom: 1px solid rgba(15,122,74,0.08);
    vertical-align: middle;
    color: var(--muted);
    text-align: center;
    height: 36px;
    box-sizing: border-box;
    line-height: 1.3;
   }

   .records-table tbody tr:hover{
    background:rgba(52,183,143,0.05);
   }

   /* Sticky columns - Updated with dark background */
   .select-col{
    position:sticky;
    left:0;
    background: rgba(255,255,255,0.95);
    z-index:50;
    padding-left:8px;
    border-right: 1px solid rgba(15,122,74,0.1);
   }

   .actions-col{
    position:sticky;
    right:0;
    background: #2c3e50;
    z-index:50;
    border-left: 1px solid rgba(255,255,255,0.1);
   }

   /* Specific styling for Members and Actions columns */
   .records-table th.actions-col {
    background: #2c3e50;
    color: white;
    font-weight: 700;
    z-index: 101;
   }

   .records-table th:last-child,
   .records-table th:nth-last-child(2) {
    background: #2c3e50;
    color: white;
    z-index: 101;
   }

   .records-table td.actions-col {
    background: #2c3e50;
    color: white;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    z-index: 49;
   }

   .records-table td:nth-last-child(1),
   .records-table td:nth-last-child(2) {
    background: #2c3e50;
    color: white;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    z-index: 49;
   }

   /* FIXED: Updated By and Updated On columns - match row color */
   .records-table td:nth-last-child(3),
   .records-table td:nth-last-child(4) {
     background: inherit !important;
     z-index: 48;
   }

   /* Ensure these columns don't get the dark actions background */
   .records-table tr:hover td:nth-last-child(3),
   .records-table tr:hover td:nth-last-child(4) {
     background: rgba(52,183,143,0.05) !important;
   }

   /* Specific styles for different row colors */
   .records-table tr.mem-small td:nth-last-child(3),
   .records-table tr.mem-small td:nth-last-child(4) {
     background: #d4f6ff !important;
   }

   .records-table tr.mem-normal td:nth-last-child(3),
   .records-table tr.mem-normal td:nth-last-child(4) {
     background: #d9ffd9 !important;
   }

   .records-table tr.mem-large td:nth-last-child(3),
   .records-table tr.mem-large td:nth-last-child(4) {
     background: #fff7c2 !important;
   }

   .records-table tr.mem-critical td:nth-last-child(3),
   .records-table tr.mem-critical td:nth-last-child(4) {
     background: #ffd6d6 !important;
   }

   /* Checkbox styling */
   .select-col input[type="checkbox"] {
    width: 14px;
    height: 14px;
    cursor: pointer;
    accent-color: var(--accent1);
   }

   /* Compact member rows */
   .member-row{
    background:#fafafa;
   }

   .member-row.hidden{
    display:none;
   }

   /* Color coding */
   .mem-small{background:#d4f6ff !important}
   .mem-normal{background:#d9ffd9 !important}
   .mem-large{background:#fff7c2 !important}
   .mem-critical{background:#ffd6d6 !important}

   /* Highlight */
   .hl{
    background:#fffe8a;
    padding:1px 2px;
    border-radius:3px;
   }

   /* Icon buttons */
   .icon-btn{
    background:none;
    border:0;
    font-size:0.85rem;
    cursor:pointer;
    padding:4px;
    border-radius:4px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    color:white;
    transition: all 0.2s ease;
   }

   .icon-btn:hover{
    background:rgba(255,255,255,0.15);
    transform:translateY(-1px);
   }

   /* Show toggle */
   .show-toggle{
    font-size:0.75rem;
    padding:5px 8px;
    border-radius:4px;
    border:1px solid rgba(255,255,255,0.3);
    background:rgba(255,255,255,0.1);
    cursor:pointer;
    color:white;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s ease;
    white-space: nowrap;
   }

   .show-toggle:hover{
    background:rgba(255,255,255,0.2);
    border-color: rgba(255,255,255,0.5);
   }

   /* Export dropdown */
   .export-wrapper{
    position:relative;
   }

   .export-dropdown{
    font-size:0.8rem;
    position:absolute;
    top:100%;
    right:0;
    margin-top: 8px;
    background:#fff;
    border:1px solid var(--border);
    border-radius:var(--radius-sm);
    width:140px;
    box-shadow:var(--shadow);
    z-index:9999;
    overflow: hidden;
   }

   .export-dropdown div{
    padding:8px 12px;
    cursor:pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
   }

   .export-dropdown div:hover{
    background:#e9fff0;
    color: var(--accent1);
   }

   .export-dropdown div i {
    width: 14px;
    text-align: center;
    font-size: 0.85rem;
   }

   .hidden{
    display:none;
   }

   /* Pagination - Fixed Position */
   #paginationArea {
    margin-top: 16px;
    display: flex;
    justify-content: center;
    gap: 6px;
    flex-wrap: wrap;
   }

   #paginationArea button{
    padding:5px 8px;
    margin:0 2px;
    border-radius:4px;
    border:1px solid var(--border);
    background:#fff;
    cursor:pointer;
    color: var(--muted);
    font-size: 0.8rem;
    min-width: 28px;
    transition: all 0.2s ease;
   }

   #paginationArea button:hover{
    border-color:var(--accent1);
    color: var(--accent1);
   }

   #paginationArea button.active{
    background:var(--accent1);
    color:#fff;
    border-color:var(--accent1);
    font-weight:700;
   }

   /* Legend - Compact Horizontal Layout */
   .legend-container {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px 16px;
    box-shadow: 0 2px 8px rgba(6,30,20,0.04);
    margin-top: 0;
    border-top: 2px solid var(--accent1);
   }

   .legend-box {
    display: flex;
    flex-direction: column;
    gap: 6px;
   }

   .legend-box h4 {
    margin: 0;
    font-size: 0.9rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 6px;
   }

   .legend-items {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
   }

   .legend-item{
    display:flex;
    gap:6px;
    align-items:center;
    font-size:0.8rem;
    white-space: nowrap;
   }

   .legend-swatch{
    width:14px;
    height:14px;
    border-radius:3px;
    flex-shrink: 0;
    border: 1px solid rgba(0,0,0,0.1);
   }

   /* Loading overlay */
   #loading {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(255,255,255,0.85);
    align-items:center;
    justify-content:center;
    z-index:9999;
    backdrop-filter: blur(2px);
   }

   .loading-content {
    background:#fff;
    padding:20px 24px;
    border-radius:var(--radius);
    box-shadow:var(--shadow-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
   }

   .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent1);
    border-radius: 50%;
    animation: spin 1s linear infinite;
   }

   @keyframes spin {
    to { transform: rotate(360deg); }
   }

   /* Mobile Styles */
   @media (max-width: 768px) {
    .page-container {
        grid-template-columns: 1fr !important;
        padding: 8px;
        gap: 12px;
    }
    
    .page-container.collapsed {
        grid-template-columns: 1fr !important;
    }
    
    .sidebar {
        position: fixed;
        top: 72px;
        left: 0;
        right: 0;
        height: auto;
        max-height: 0;
        overflow: hidden;
        z-index: 1000;
        margin: 0;
        padding: 0;
        border-radius: 0 0 var(--radius) var(--radius);
        background: white;
        box-shadow: var(--shadow);
        transition: max-height 0.3s ease;
    }
    
    .sidebar.mobile-open {
        max-height: 300px;
        padding: 12px;
        overflow-y: auto;
    }
    
    .sidebar-container {
        flex-direction: column;
    }
    
    .sidebar-toggle {
        display: none;
    }
    
    .mobile-menu-toggle {
        display: flex !important;
        background: linear-gradient(135deg, var(--accent1), var(--accent2));
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        width: 40px;
        height: 40px;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
    }
    
    .content-area {
        height: auto;
        min-height: calc(100vh - 140px);
    }
    
    .toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .toolbar-row-2 {
        justify-content: space-between;
        flex-wrap: wrap;
    }
    
    .search-box {
        max-width: 100%;
    }
    
    .brgy-dropdown {
        width: 100%;
        min-width: auto;
    }
    
    .stats-container {
        justify-content: space-between;
        gap: 8px;
    }
    
    .stat-item {
        flex: 1;
        min-width: auto;
        padding: 5px 6px;
    }
    
    .stat-item span {
        font-size: 0.7rem;
    }
    
    .stat-item .value {
        font-size: 0.9rem;
    }
    
    .user-info {
        gap: 8px;
    }
    
    #userName {
        font-size: 0.9rem;
        padding: 6px 12px;
    }
    
    #logoutBtn {
        padding: 6px 12px;
        font-size: 0.85rem;
    }
    
    .legend-items {
        flex-direction: column;
        gap: 6px;
        align-items: flex-start;
    }
    
    .records-table {
        font-size: 12px;
        min-width: 1200px;
    }
    
    .records-table th,
    .records-table td {
        font-size: 12px;
        padding: 6px 5px;
    }
    
    .records-table th {
        height: 36px;
    }
    
    .records-table td {
        height: 32px;
    }
   }

   /* Tablet Styles */
   @media (min-width: 769px) and (max-width: 1024px) {
    .page-container {
        max-width: 95%;
        grid-template-columns: 220px 1fr;
        gap: 15px;
        padding: 10px;
    }
    
    .content-area {
        padding: 15px;
    }
    
    .records-table {
        min-width: 1300px;
    }
    
    .records-table th,
    .records-table td {
        font-size: 13px;
        padding: 8px 6px;
    }
   }

   /* Mobile menu toggle button */
   .mobile-menu-toggle {
    display: none;
   }

   /* Scrollbar styling */
   .records-wrapper::-webkit-scrollbar {
    width: 8px;
    height: 8px;
   }

   .records-wrapper::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
   }

   .records-wrapper::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
   }

   .records-wrapper::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
   }
</style>
</head>
<body>
<div class="page-container">

  <header class="topbar">
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div class="brand-text">
        <h1>PUROK KALIGTASAN</h1>
        <p>MDRRMO Alitagtag Household Records System</p>
      </div>
    </div>

    <div class="user-info">
      <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
      </button>
      <span id="userName"></span>
      <button id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-container">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul>
        <li><a href="dashboard.html" title="Dashboard"><span class="menu-icon">üìä</span> <span class="menu-text">Dashboard</span></a></li>
        <li><a href="dataForm.html" title="Data Entry"><span class="menu-icon">üìù</span> <span class="menu-text">Data Entry</span></a></li>
        <li><a href="records.html" class="active" title="Records"><span class="menu-icon">üìÅ</span> <span class="menu-text">Records</span></a></li>
        <li><a href="charts.html" title="Charts"><span class="menu-icon">üìà</span> <span class="menu-text">Charts</span></a></li>
        <li class="admin-only"><a href="users.html" title="User Management"><span class="menu-icon">üë•</span> <span class="menu-text">User Management</span></a></li>
      </ul>
    </div>
  </aside>

  <main class="content-area">
    <div class="content-header">
      <h2><span style="color: var(--accent1);">üìÅ</span> Household Records</h2>
    </div>
    
    <!-- Description -->
    <div id="disc">This section displays all collected household data in one place. Users can easily view, search, and review information gathered from each household, helping ensure accurate monitoring, validation, and decision-making for community programs and emergency operations.</div>

    <!-- Counts - Top Right -->
    <div class="stats-container">
      <div class="stat-item">
        <span>Rows</span>
        <div class="value" id="rowCount">0</div>
      </div>
      <div class="stat-item">
        <span>Matches</span>
        <div class="value" id="matchCount">0</div>
      </div>
      <div class="stat-item">
        <span>Selected</span>
        <div class="value" id="selectedCount">0</div>
      </div>
    </div>

    <!-- Toolbar - New Layout -->
    <div class="toolbar">
      <div class="toolbar-row-1">
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input id="searchInput" class="search-box" placeholder="Search by Name / Barangay / ID..." />
        </div>
      </div>
      
      <div class="toolbar-row-2">
        <select id="filterBarangay" class="brgy-dropdown" aria-label="Filter by Barangay">
          <option value="">All Barangays</option>
          <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
          <option>Dalipit East</option><option>Dalipit West</option>
          <option>Dominador East</option><option>Dominador West</option>
          <option>Munlawin Sur</option><option>Munlawin Norte</option>
          <option>Muzon Primero</option><option>Muzon Segundo</option>
          <option>Pinagkurusan</option><option>Ping-As</option>
          <option>Poblacion East</option><option>Poblacion West</option>
          <option>San Jose</option><option>San Juan</option>
          <option>Santa Cruz</option><option>Tadlac</option>
        </select>

        <button id="refreshBtn" class="btn">
          <i class="fas fa-redo"></i> Refresh
        </button>

        <div class="export-wrapper">
          <button id="exportBtn" class="btn btn-export">
            <i class="fas fa-download"></i> Export ‚ñº
          </button>
          <div id="exportDropdown" class="export-dropdown hidden" role="menu" aria-hidden="true">
            <div onclick="exportAll()">
              <i class="fas fa-file-export"></i> Export All
            </div>
            <div onclick="exportSelected()">
              <i class="fas fa-check-circle"></i> Export Selected
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="records-wrapper">
      <table class="records-table" aria-describedby="records table">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div id="paginationArea"></div>

    <!-- Legend - Compact Horizontal Layout -->
    <div class="legend-container">
      <div class="legend-box">
        <h4><i class="fas fa-palette"></i> Household Color Legend:</h4>
        <div class="legend-items">
          <div class="legend-item"><div class="legend-swatch" style="background:#d4f6ff"></div>1 Member</div>
          <div class="legend-item"><div class="legend-swatch" style="background:#d9ffd9"></div>2‚Äì4 Members</div>
          <div class="legend-item"><div class="legend-swatch" style="background:#fff7c2"></div>5‚Äì7 Members</div>
          <div class="legend-item"><div class="legend-swatch" style="background:#ffd6d6"></div>8+ Members</div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- EDIT PANEL OVERLAY -->
<div id="panelOverlay" class="panel-overlay" aria-hidden="true"></div>

<!-- EDIT SLIDE-IN PANEL -->
<div id="editPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Edit household panel">
  <div class="panel-header">
    <button id="panelClose" class="btn secondary" title="Close panel">‚Üê</button>
    <h3 id="panelTitle">Edit Household</h3>
  </div>

  <div class="panel-body">
    <div class="data-id-display">
      Data ID: <span id="editDataIdDisplay">Loading...</span>
    </div>
    
    <form id="editForm" onsubmit="return false;">
      <!-- Head editing -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Household Head Information</h5>
        </div>
        
        <!-- Coordinate Field - UPDATED to match dataForm.html -->
        <div style="grid-column: 1 / -1;">
          <label>Coordinates (optional)</label>
          <div class="coordinate-container">
            <input type="text" id="edit_coordinate" placeholder="Latitude, Longitude" />
            <button type="button" id="edit_getLocationBtn" class="btn secondary">
              <i class="fas fa-map-marker-alt"></i> Get My Location
            </button>
            <button type="button" id="edit_hazardHunterBtn" class="btn hazard-hunter">
              <i class="fas fa-map-marked-alt"></i> Pick from Hazard Hunter
            </button>
          </div>
          <div class="small-muted">Optional ‚Äî paste `lat, lng` if available, or use the buttons above.</div>
        </div>

        <div class="form-grid">
          <div>
            <label>Barangay <span class="required">*</span></label>
            <select id="edit_barangay" required>
              <option value="">Select Barangay...</option>
              <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
              <option>Dalipit East</option><option>Dalipit West</option><option>Dominador East</option>
              <option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
              <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option>
              <option>Ping-As</option><option>Poblacion East</option><option>Poblacion West</option>
              <option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
            </select>
          </div>
          
          <div>
            <label>Sitio / Purok <span class="required">*</span></label>
            <select id="edit_sitio" required>
              <option value="">Select...</option>
              <option>Purok I</option><option>Purok II</option><option>Purok III</option>
              <option>Purok IV</option><option>Purok V</option><option>Purok VI</option>
              <option>Purok VII</option>
            </select>
          </div>

          <!-- UPDATED: Household Head Full Name section to match dataForm.html -->
          <div style="grid-column: 1 / -1;">
            <label>Household Head Full Name<span class="required">*</span></label>
            <div class="head-name-container">
              <input type="text" id="edit_householdHead" required/>
            </div>
            
            <!-- FIXED: FishR/RBIS Registered button moved inline -->
            <div class="head-registration-container">
              <div class="checkbox-item" style="margin-bottom: 0;">
                <input type="checkbox" id="edit_headRegisteredCheckbox">
                <label for="edit_headRegisteredCheckbox">FishR/RBIS Registered</label>
              </div>
            </div>
            
            <div id="edit_headRegistrationField" class="conditional-field">
              <label>FishR Registered/RBIS Registered</label>
              <select id="edit_headRegistration">
                <option value="">Select...</option>
                <option value="FishR Registered">FishR Registered</option>
                <option value="RBIS Registered">RBIS Registered</option>
                <option value="FishR & RBIS Registered">FishR & RBIS Registered</option>
              </select>
            </div>
          </div>

          <div>
            <label>Contact no. <span class="required">*</span></label>
            <input type="text" id="edit_contactNo" placeholder="09XXXXXXXXX" required 
                   pattern="^(09|\+639)\d{9}$" />
            <div class="error-message" id="edit_contactError"></div>
          </div>

          <div>
            <label>Sex <span class="required">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="edit_head_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="edit_head_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate <span class="required">*</span></label>
            <input type="date" id="edit_householdBirthdate" required/>
          </div>

          <div>
            <label>Age</label>
            <input type="text" id="edit_householdAge" readonly/>
          </div>

          <div>
            <label>Age Category</label>
            <input type="text" id="edit_householdStage" readonly/>
          </div>

          <div>
            <label>No. of Household Member/s <span class="required">*</span></label>
            <input type="number" id="edit_memberCount" min="0" value="0" required/>
            <div class="small-muted">Set to 0 if no other members.</div>
          </div>
        </div>

        <div class="form-section">
          <h5>Educational & Economic Status</h5>
        </div>
        <div class="form-grid">
          <div>
            <label>Educational Attainment</label>
            <select id="edit_educationalAttainment">
              <option value="">Select...</option>
              <option value="No Formal Education">No Formal Education</option>
              <option value="Elementary Level">Elementary Level</option>
              <option value="Elementary Graduate">Elementary Graduate</option>
              <option value="High School Level">High School Level</option>
              <option value="High School Graduate">High School Graduate</option>
              <option value="Senior High School Level">Senior High School Level</option>
              <option value="Senior High School Graduate">Senior High School Graduate</option>
              <option value="College Level">College Level</option>
              <option value="College Graduate">College Graduate</option>
            </select>
          </div>

          <div id="edit_collegeCourseField" class="conditional-field">
            <label>College Graduate Course</label>
            <input type="text" id="edit_collegeCourse" placeholder="Enter course name" />
          </div>

          <div>
            <label>Employment</label>
            <select id="edit_employment">
              <option value="">Select...</option>
              <option value="Employed">Employed</option>
              <option value="Unemployed">Unemployed</option>
            </select>
          </div>

          <div id="edit_jobTitleField" class="conditional-field">
            <label>Job Title</label>
            <select id="edit_jobTitle">
              <option value="">Select...</option>
              <optgroup label="Office & Administrative Jobs">
                <option>Administrative Assistant / Admin Staff</option>
                <option>Office Clerk</option>
                <option>Secretary / Executive Assistant</option>
              </optgroup>
              <optgroup label="Business & Management">
                <option>Project Manager</option>
                <option>Operations Manager</option>
                <option>HR Staff / HR Officer</option>
                <option>Account Manager</option>
              </optgroup>
              <optgroup label="Accounting & Finance">
                <option>Accounting Staff</option>
                <option>Bookkeeper</option>
                <option>Payroll Officer</option>
                <option>Auditor</option>
              </optgroup>
              <optgroup label="IT & Tech">
                <option>IT Support / IT Technician</option>
                <option>Web Developer</option>
                <option>Software Developer / Programmer</option>
                <option>Data Analyst</option>
                <option>System Administrator</option>
              </optgroup>
              <optgroup label="Healthcare">
                <option>Nurse (Staff Nurse / Company Nurse)</option>
                <option>Medical Technologist</option>
                <option>Caregiver</option>
                <option>Pharmacist</option>
              </optgroup>
              <optgroup label="Education">
                <option>Teacher / Instructor</option>
                <option>Tutor</option>
                <option>School Administrator</option>
              </optgroup>
              <optgroup label="Sales & Customer Service">
                <option>Customer Service Representative (CSR)</option>
                <option>Sales Associate</option>
                <option>Cashier</option>
                <option>Store Supervisor</option>
              </optgroup>
              <optgroup label="Skilled Work & Labor">
                <option>Electrician</option>
                <option>Plumber</option>
                <option>Welder</option>
                <option>Construction Worker / Skilled Laborer</option>
              </optgroup>
              <optgroup label="Delivery & Logistics">
                <option>Driver (Company Driver / Delivery Driver)</option>
                <option>Logistics Staff</option>
                <option>Rider / Motorcycle Delivery</option>
              </optgroup>
              <optgroup label="Food & Hospitality">
                <option>Cook / Chef</option>
                <option>Waiter / Service Crew</option>
                <option>Barista</option>
                <option>Housekeeping Staff</option>
              </optgroup>
              <optgroup label="Security & Public Service">
                <option>Security Guard</option>
                <option>Barangay Staff / Barangay Council Employee</option>
                <option>Police Officer</option>
                <option>Fire Officer</option>
              </optgroup>
              <optgroup label="Media, Design & Creative">
                <option>Graphic Designer</option>
                <option>Video Editor</option>
                <option>Content Writer</option>
                <option>Social Media Manager</option>
              </optgroup>
              <option>Others</option>
            </select>
          </div>

          <div>
            <label>Overseas Filipino Worker (OFW)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="edit_ofw_status" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="edit_ofw_status" value="No" checked> No</label>
            </div>
          </div>

          <div id="edit_countryField" class="conditional-field">
            <label>Country</label>
            <select id="edit_country">
              <option value="">Select...</option>
              <option>Saudi Arabia</option>
              <option>United Arab Emirates (UAE)</option>
              <option>Qatar</option>
              <option>Kuwait</option>
              <option>Bahrain</option>
              <option>Oman</option>
              <option>Hong Kong</option>
              <option>Singapore</option>
              <option>Japan</option>
              <option>Taiwan</option>
              <option>Malaysia</option>
              <option>Australia</option>
              <option>New Zealand</option>
              <option>Italy</option>
              <option>United Kingdom (UK)</option>
              <option>Germany</option>
              <option>Cyprus</option>
              <option>Canada</option>
              <option>United States (USA)</option>
              <option>Libya</option>
              <option>Others</option>
            </select>
          </div>
        </div>

        <div class="form-section">
          <h5>Health & Status</h5>
        </div>
        <div class="form-grid">
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="edit_head_pwd" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="edit_head_pwd" value="No" checked> No</label>
            </div>
          </div>
          <div>
            <label>Status</label>
            <select id="edit_head_status">
                <option value="">Select...</option>
                <option>With Sickness</option>
                <option>Pregnant</option>
                <option>Solo Parent</option>
                <option>Lactating</option>
                <option>Severe Illness</option>
                <option>HIV Positive</option>
                <option>LGBTQ Plus</option>
            </select>
          </div>
        </div>

        <div class="form-section">
          <h5>Domestic Livestock</h5>
        </div>
        <div class="domestic-grid">
          <div class="animal-card">
            <div class="animal-header">
              <label class="checkbox-item"><input type="checkbox" id="edit_dog_chk"> <span style="font-size: 1.2rem;">üêï</span> Dog</label>
            </div>
            <div class="animal-qty">
              <label>Quantity:</label>
              <input type="number" id="edit_dog_qty" class="qty" min="0" placeholder="0" />
            </div>
          </div>

          <div class="animal-card">
            <div class="animal-header">
              <label class="checkbox-item"><input type="checkbox" id="edit_cat_chk"> <span style="font-size: 1.2rem;">üêà</span> Cat</label>
            </div>
            <div class="animal-qty">
              <label>Quantity:</label>
              <input type="number" id="edit_cat_qty" class="qty" min="0" placeholder="0" />
            </div>
          </div>

          <div class="animal-card">
            <div class="animal-header">
              <label class="checkbox-item"><input type="checkbox" id="edit_pig_chk"> <span style="font-size: 1.2rem;">üêñ</span> Pig</label>
            </div>
            <div class="animal-qty">
              <label>Quantity:</label>
              <input type="number" id="edit_pig_qty" class="qty" min="0" placeholder="0" />
            </div>
          </div>

          <div class="animal-card">
            <div class="animal-header">
              <label class="checkbox-item"><input type="checkbox" id="edit_cow_chk"> <span style="font-size: 1.2rem;">üêÑ</span> Cow</label>
            </div>
            <div class="animal-qty">
              <label>Quantity:</label>
              <input type="number" id="edit_cow_qty" class="qty" min="0" placeholder="0" />
            </div>
          </div>

          <div class="animal-card">
            <div class="animal-header">
              <label class="checkbox-item"><input type="checkbox" id="edit_carabao_chk"> <span style="font-size: 1.2rem;">üêÉ</span> Carabao</label>
            </div>
            <div class="animal-qty">
              <label>Quantity:</label>
              <input type="number" id="edit_carabao_qty" class="qty" min="0" placeholder="0" />
            </div>
          </div>

          <div class="animal-card">
            <div class="animal-header">
              <label class="checkbox-item"><input type="checkbox" id="edit_chicken_chk"> <span style="font-size: 1.2rem;">üêî</span> Chicken</label>
            </div>
            <div class="animal-qty">
              <label>Quantity:</label>
              <input type="number" id="edit_chicken_qty" class="qty" min="0" placeholder="0" />
            </div>
          </div>
        </div>

        <div style="margin-top: 12px;">
          <label>Others</label>
          <textarea id="edit_animals_others" class="others-box" placeholder="Use this field to describe other animals owned in a brief sentence (e.g., '5 goats and 2 ducks')."></textarea>
        </div>

        <div class="form-section">
          <h5>Transportation & Evacuation Details</h5>
        </div>
        <div class="form-grid">
          <div>
            <label>Transportation</label>
            <select id="edit_head_transport">
              <option value="">Select...</option>
              <option>Has Transportation</option>
              <option>Needs Transportation</option>
            </select>
          </div>
          
          <div>
            <label>Pick-Up Location</label>
            <input type="text" id="edit_pickup"/>
          </div>
          
          <div>
            <label>Drop-Off Location</label>
            <input type="text" id="edit_dropoff"/>
          </div>
          
          <div>
            <label>Evacuation Camp Name</label>
            <input type="text" id="edit_campName"/>
          </div>
          
          <div>
            <label>Camp Capacity</label>
            <input type="number" id="edit_capacity" min="0"/>
          </div>
          
          <div>
            <label>Individuals Currently in Camp</label>
            <input type="number" id="edit_insideCamp" min="0"/>
          </div>
          
          <div>
            <label>Individuals Outside Camp</label>
            <input type="number" id="edit_outsideCamp" min="0"/>
          </div>

          <div style="grid-column:1/-1;">
            <label>Reason for Displacement</label>
            <select id="edit_reasons">
              <option value="">Select...</option>
              <option>Taal Volcano (Within 14-15 KM Danger Zone)</option>
              <option>Typhoon</option>
              <option>Flood</option>
              <option>Landslide</option>
              <option>Earthquake</option>
              <option>Others</option>
            </select>
          </div>
        </div>

        <div class="form-section">
          <h5>Government Assistance Programs</h5>
        </div>
        <div class="gov-support-grid">
          <div class="checkbox-item">
            <input type="checkbox" id="edit_ass_tupad">
            <label for="edit_ass_tupad">TUPAD</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="edit_ass_local4ps">
            <label for="edit_ass_local4ps">Local 4Ps</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="edit_ass_intl4ps">
            <label for="edit_ass_intl4ps">National 4Ps</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="edit_ass_locsp">
            <label for="edit_ass_locsp">Local Social Pension</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="edit_ass_intlsp">
            <label for="edit_ass_intlsp">National Social Pension</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="edit_ass_solo">
            <label for="edit_ass_solo">Solo Parent Assistance</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="edit_ass_relief">
            <label for="edit_ass_relief">Relief Goods</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="edit_ass_cash">
            <label for="edit_ass_cash">Cash Subsidy</label>
          </div>
        </div>

        <div style="margin-top:16px">
          <label>AICS (if any)</label>
          <select id="edit_ass_aics">
            <option value="">None</option>
            <option>Shelter Assistance</option>
            <option>Burial</option>
            <option>Scholarship</option>
          </select>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
          <button id="startSequenceBtn" class="btn">Next ‚Üí Members (Start sequence)</button>
          <button id="saveEditBtn" class="btn">Save changes</button>
          <button id="cancelEditBtn" class="btn secondary" type="button">Cancel</button>
        </div>
      </div>

      <!-- Members preview + edit controls -->
      <div class="edit-card">
        <h4>Members</h4>
        <div class="small-muted">Count: <strong id="edit_previewCount">0</strong></div>
        <ul id="edit_membersPreview" class="member-preview"></ul>
        <div style="display:flex;gap:8px; margin-top:10px; justify-content:flex-end;">
          <button id="edit_addMember" class="btn secondary" type="button">
            <i class="fas fa-user-plus"></i> Add / Edit Members
          </button>
          <button id="edit_removeMember" class="btn secondary" type="button" style="background: #f8d7da; color: #721c24; border-color: #f5c6cb;">
            <i class="fas fa-user-minus"></i> Remove Member
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- MEMBER SEQUENTIAL PANEL -->
<div id="memberPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Member entry panel">
  <div class="panel-header">
    <button id="memberPanelClose" class="btn secondary" title="Close panel">‚Üê</button>
    <h3 id="memberPanelTitle">Member 1 of N</h3>
  </div>

  <div class="panel-body">
    <form id="memberForm" onsubmit="return false;">
      <div class="edit-card">
        <div class="form-section">
          <h5>Basic Information</h5>
        </div>
        <div class="form-grid">
          <div style="grid-column: 1 / -1;">
            <label>Household Member Full Name<span class="required">*</span></label>
            <input type="text" id="memberName" class="member-name" required />
          </div>

          <div style="grid-column: 1 / -1;">
            <div class="checkbox-item">
              <input type="checkbox" id="memberRegisteredCheckbox">
              <label for="memberRegisteredCheckbox">FishR/RBIS Registered</label>
            </div>
            
            <div id="memberRegistrationField" class="conditional-field">
              <label>FishR Registered/RBIS Registered</label>
              <select id="memberRegistration">
                <option value="">Select...</option>
                <option value="FishR Registered">FishR Registered</option>
                <option value="RBIS Registered">RBIS Registered</option>
                <option value="FishR & RBIS Registered">FishR & RBIS Registered</option>
              </select>
            </div>
          </div>

          <div>
            <label>Contact no. <span class="required">*</span></label>
            <input type="text" id="memberContact" placeholder="09XXXXXXXXX" required
                   pattern="^(09|\+639)\d{9}$" />
            <div class="error-message" id="memberContactError"></div>
          </div>

          <div>
            <label>Sex <span class="required">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="member_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="member_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate <span class="required">*</span></label>
            <input type="date" id="memberBirthdate" class="member-birthdate" required/>
          </div>

          <div>
            <label>Age</label>
            <input type="text" id="memberAge" class="member-age" readonly/>
          </div>

          <div>
            <label>Age Category</label>
            <input type="text" id="memberStage" class="member-stage" readonly/>
          </div>
        </div>
      </div>

      <div class="edit-card">
        <div class="form-section">
          <h5>Educational & Economic Status</h5>
        </div>
        <div class="form-grid">
          <div>
            <label>Educational Attainment</label>
            <select id="memberEducationalAttainment" class="member-educational">
              <option value="">Select...</option>
              <option value="No Formal Education">No Formal Education</option>
              <option value="Elementary Level">Elementary Level</option>
              <option value="Elementary Graduate">Elementary Graduate</option>
              <option value="High School Level">High School Level</option>
              <option value="High School Graduate">High School Graduate</option>
              <option value="Senior High School Level">Senior High School Level</option>
              <option value="Senior High School Graduate">Senior High School Graduate</option>
              <option value="College Level">College Level</option>
              <option value="College Graduate">College Graduate</option>
            </select>
          </div>

          <div id="memberCollegeCourseField" class="conditional-field">
            <label>College Graduate Course</label>
            <input type="text" id="memberCollegeCourse" placeholder="Enter course name" />
          </div>

          <div>
            <label>Employment</label>
            <select id="memberEmployment" class="member-employment">
              <option value="">Select...</option>
              <option value="Employed">Employed</option>
              <option value="Unemployed">Unemployed</option>
            </select>
          </div>

          <div id="memberJobTitleField" class="conditional-field">
            <label>Job Title</label>
            <select id="memberJobTitle" class="member-jobtitle">
              <option value="">Select...</option>
              <optgroup label="Office & Administrative Jobs">
                <option>Administrative Assistant / Admin Staff</option>
                <option>Office Clerk</option>
                <option>Secretary / Executive Assistant</option>
              </optgroup>
              <optgroup label="Business & Management">
                <option>Project Manager</option>
                <option>Operations Manager</option>
                <option>HR Staff / HR Officer</option>
                <option>Account Manager</option>
              </optgroup>
              <optgroup label="Accounting & Finance">
                <option>Accounting Staff</option>
                <option>Bookkeeper</option>
                <option>Payroll Officer</option>
                <option>Auditor</option>
              </optgroup>
              <optgroup label="IT & Tech">
                <option>IT Support / IT Technician</option>
                <option>Web Developer</option>
                <option>Software Developer / Programmer</option>
                <option>Data Analyst</option>
                <option>System Administrator</option>
              </optgroup>
              <optgroup label="Healthcare">
                <option>Nurse (Staff Nurse / Company Nurse)</option>
                <option>Medical Technologist</option>
                <option>Caregiver</option>
                <option>Pharmacist</option>
              </optgroup>
              <optgroup label="Education">
                <option>Teacher / Instructor</option>
                <option>Tutor</option>
                <option>School Administrator</option>
              </optgroup>
              <optgroup label="Sales & Customer Service">
                <option>Customer Service Representative (CSR)</option>
                <option>Sales Associate</option>
                <option>Cashier</option>
                <option>Store Supervisor</option>
              </optgroup>
              <optgroup label="Skilled Work & Labor">
                <option>Electrician</option>
                <option>Plumber</option>
                <option>Welder</option>
                <option>Construction Worker / Skilled Laborer</option>
              </optgroup>
              <optgroup label="Delivery & Logistics">
                <option>Driver (Company Driver / Delivery Driver)</option>
                <option>Logistics Staff</option>
                <option>Rider / Motorcycle Delivery</option>
              </optgroup>
              <optgroup label="Food & Hospitality">
                <option>Cook / Chef</option>
                <option>Waiter / Service Crew</option>
                <option>Barista</option>
                <option>Housekeeping Staff</option>
              </optgroup>
              <optgroup label="Security & Public Service">
                <option>Security Guard</option>
                <option>Barangay Staff / Barangay Council Employee</option>
                <option>Police Officer</option>
                <option>Fire Officer</option>
              </optgroup>
              <optgroup label="Media, Design & Creative">
                <option>Graphic Designer</option>
                <option>Video Editor</option>
                <option>Content Writer</option>
                <option>Social Media Manager</option>
              </optgroup>
              <option>Others</option>
            </select>
          </div>

          <div>
            <label>Overseas Filipino Worker (OFW)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="member_ofw_status" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="member_ofw_status" value="No" checked> No</label>
            </div>
          </div>

          <div id="memberCountryField" class="conditional-field">
            <label>Country</label>
            <select id="memberCountry" class="member-country">
              <option value="">Select...</option>
              <option>Saudi Arabia</option>
              <option>United Arab Emirates (UAE)</option>
              <option>Qatar</option>
              <option>Kuwait</option>
              <option>Bahrain</option>
              <option>Oman</option>
              <option>Hong Kong</option>
              <option>Singapore</option>
              <option>Japan</option>
              <option>Taiwan</option>
              <option>Malaysia</option>
              <option>Australia</option>
              <option>New Zealand</option>
              <option>Italy</option>
              <option>United Kingdom (UK)</option>
              <option>Germany</option>
              <option>Cyprus</option>
              <option>Canada</option>
              <option>United States (USA)</option>
              <option>Libya</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <div class="edit-card">
        <div class="form-section">
          <h5>Health and Status</h5>
        </div>
        <div class="form-grid">
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="member_pwd" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="member_pwd" value="No" checked> No</label>
            </div>
          </div>

          <div>
            <label>Status</label>
            <select id="memberStatus" class="member-status">
              <option value="">Select...</option>
              <option>With Sickness</option>
              <option>Pregnant</option>
              <option>Solo Parent</option>
              <option>Lactating</option>
              <option>Severe Illness</option>
              <option>HIV Positive</option>
              <option>LGBTQ Plus</option>
            </select>
          </div>
        </div>
      </div>

      <div class="edit-card">
        <div class="form-section">
          <h5>Transportation & Evacuation Details</h5>
        </div>
        <div class="form-grid">
          <div>
            <label>Transportation</label>
            <select id="memberTransport" class="member-transport">
              <option value="">Select...</option>
              <option>Has Transportation</option>
              <option>Needs Transportation</option>
            </select>
          </div>
          
          <div>
            <label>Pick-Up Location</label>
            <input id="memberPickup" class="member-pickup"/>
          </div>
          
          <div>
            <label>Drop-Off Location</label>
            <input id="memberDropoff" class="member-dropoff"/>
          </div>
          
          <div>
            <label>Evacuation Camp Name</label>
            <input id="memberCamp" class="member-camp"/>
          </div>
          
          <div>
            <label>Camp Capacity</label>
            <input type="number" id="memberCampCap" class="member-cap" min="0"/>
          </div>
          
          <div>
            <label>Individuals Currently in Camp</label>
            <input type="number" id="memberInside" class="member-inside" min="0"/>
          </div>
          
          <div>
            <label>Individuals Outside Camp</label>
            <input type="number" id="memberOutside" class="member-outside" min="0"/>
          </div>

          <div style="grid-column:1/-1;">
            <label>Reason for Displacement</label>
            <select id="memberReason" class="member-reason">
              <option value="">Select...</option>
              <option>Taal Volcano (Within 14-15 KM Danger Zone)</option>
              <option>Typhoon</option>
              <option>Flood</option>
              <option>Landslide</option>
              <option>Earthquake</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <div class="edit-card">
        <div class="form-section">
          <h5>Government Assistance Programs</h5>
        </div>
        <div class="gov-support-grid">
          <div class="checkbox-item">
            <input type="checkbox" id="member_tupad" class="member_tupad">
            <label for="member_tupad">TUPAD</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_local4ps" class="member_local4ps">
            <label for="member_local4ps">Local 4Ps</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_intl4ps" class="member_intl4ps">
            <label for="member_intl4ps">National 4Ps</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_locsp" class="member_locsp">
            <label for="member_locsp">Local Social Pension</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_intlsp" class="member_intlsp">
            <label for="member_intlsp">National Social Pension</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_solo" class="member_solo">
            <label for="member_solo">Solo Parent Assistance</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_relief" class="member_relief">
            <label for="member_relief">Relief Goods</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_cash" class="member_cash">
            <label for="member_cash">Cash Subsidy</label>
          </div>
        </div>

        <div style="margin-top:16px">
          <label>AICS (if any)</label>
          <select id="memberAics" class="member_aics">
            <option value="">None</option>
            <option>Shelter Assistance</option>
            <option>Burial</option>
            <option>Scholarship</option>
          </select>
        </div>
      </div>

      <div class="panel-actions" style="margin-top:20px;">
        <button id="memberBack" class="btn secondary" type="button">Back</button>
        <button id="memberNext" class="btn" type="button">Save & Next</button>
      </div>
    </form>
  </div>
</div>

<!-- COORDINATE MODAL -->
<div id="coordinateModal" class="coordinate-modal">
  <div class="coordinate-modal-content">
    <h4>Set Household Coordinates</h4>
    
    <div style="margin-bottom: 16px;">
      <label>Coordinates <span class="required">*</span></label>
      <input type="text" id="modal_coordinate" class="modal-coordinate-input" 
             placeholder="e.g., 13.8651, 120.9278" />
      <div class="small-muted">Enter latitude and longitude separated by comma</div>
    </div>
    
    <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
      <div style="font-weight: 600; color: var(--accent1); margin-bottom: 8px;">
        <i class="fas fa-lightbulb"></i> How to get coordinates:
      </div>
      <div style="display: flex; gap: 16px; flex-wrap: wrap;">
        <button type="button" id="modal_getLocationBtn" class="btn secondary" style="flex: 1;">
          <i class="fas fa-map-marker-alt"></i> Get Current Location
        </button>
        <button type="button" id="modal_hazardHunterBtn" class="btn hazard-hunter" style="flex: 1;">
          <i class="fas fa-map-marked-alt"></i> Open Hazard Hunter
        </button>
      </div>
    </div>
    
    <div class="modal-coordinate-actions">
      <button id="modal_cancelBtn" class="btn secondary" type="button">Cancel</button>
      <button id="modal_saveBtn" class="btn" type="button">Save Coordinates</button>
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div id="loading">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div>Loading records‚Ä¶</div>
  </div>
</div>

<script>
/* ============ CONFIG ============ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";
const HAZARD_HUNTER_URL = "https://hazardhunter.georisk.gov.ph/map#";

/* ============ STATE ============ */
let header = [];
let rawRows = [];
let groups = [];
let filteredGroups = [];
let selected = new Set();
let currentPage = 1;
const rowsPerPage = 25;

/* ============ EDIT STATE ============ */
let editDataID = null;
let editHead = {};
let editMembers = [];
let memberEditIndex = 0;
let sequenceMode = false;

/* ============ UTIL ============ */
const $ = id => document.getElementById(id);
const q = sel => document.querySelector(sel);
const qAll = sel => Array.from(document.querySelectorAll(sel));

function showLoading(yes){ 
    document.getElementById("loading").style.display = yes ? "flex" : "none"; 
}

function highlight(text,q){
    text = String(text ?? "");
    if(!q) return text;
    const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");
    return text.replace(re, m => `<span class="hl">${m}</span>`);
}

/* ============ EDIT PANEL FUNCTIONS ============ */
function openEditPanel(){ 
    $('editPanel')?.classList.add('open'); 
    $('panelOverlay')?.classList.add('show'); 
}

function closeEditPanel(){ 
    $('editPanel')?.classList.remove('open'); 
    $('panelOverlay')?.classList.remove('show'); 
}

function resetEditState() {
  editDataID = null;
  editHead = {};
  editMembers = [];
  memberEditIndex = 0;
  sequenceMode = false;
}

/* ============ COORDINATE FUNCTIONS ============ */
function openCoordinateModal() {
  const modal = $('coordinateModal');
  const currentCoord = $('edit_coordinate').value || '';
  $('modal_coordinate').value = currentCoord;
  modal.classList.add('active');
}

function closeCoordinateModal() {
  $('coordinateModal').classList.remove('active');
}

function saveCoordinateFromModal() {
  const coord = $('modal_coordinate').value.trim();
  if (!coord) {
    alert('Please enter coordinates');
    return;
  }
  
  // Basic validation for coordinate format
  const coordRegex = /^-?\d+\.?\d*,\s*-?\d+\.?\d*$/;
  if (!coordRegex.test(coord)) {
    alert('Please enter valid coordinates in format: latitude, longitude\ne.g., 13.8651, 120.9278');
    return;
  }
  
  $('edit_coordinate').value = coord;
  closeCoordinateModal();
}

function getCurrentLocationForModal() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude.toFixed(6);
        const lng = pos.coords.longitude.toFixed(6);
        $('modal_coordinate').value = `${lat}, ${lng}`;
      },
      (err) => {
        alert('Unable to retrieve location. Please enable location services or enter coordinates manually.');
      }
    );
  } else {
    alert('Geolocation is not supported by your browser.');
  }
}

function openHazardHunterForModal() {
  alert('Open Hazard Hunter in another tab to get coordinates, then paste them in the coordinate field.');
  window.open(HAZARD_HUNTER_URL, '_blank');
}

/* ============ GET CURRENT LOCATION FUNCTION ============ */
function getCurrentLocation() {
  if (!navigator.geolocation) {
    alert("Geolocation is not supported by your browser.");
    return;
  }

  showLoading(true);

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      $('edit_coordinate').value = `${lat}, ${lng}`;
      showLoading(false);
      
      // Ask user if they want to verify on Hazard Hunter
      if (confirm("Location captured successfully!\n\nWould you like to verify this location on Hazard Hunter to check for hazards?")) {
        openHazardHunterVerification(lat, lng);
      }
    },
    (err) => {
      showLoading(false);
      alert("Unable to retrieve GPS location. Please allow location access or use the Hazard Hunter option.");
      console.error("GPS Error:", err);
    },
    {
      enableHighAccuracy: true,
      timeout: 8000,
      maximumAge: 0
    }
  );
}

/* ============ HAZARD HUNTER FUNCTIONS ============ */
function openHazardHunterPicker() {
  // Store current form data temporarily
  const formData = {
    barangay: $('edit_barangay').value,
    sitio: $('edit_sitio').value,
    householdHead: $('edit_householdHead').value,
    contactNo: $('edit_contactNo').value,
  };
  
  // Store in sessionStorage so we can retrieve it when we come back
  sessionStorage.setItem('tempFormData', JSON.stringify(formData));
  sessionStorage.setItem('awaitingCoordinates', 'true');
  
  // Show instructions
  alert('Hazard Hunter will open in a new tab.\n\nInstructions:\n1. Navigate to the desired location\n2. Click on the map to get coordinates\n3. Copy the coordinates (latitude, longitude)\n4. Return to this tab and paste them in the coordinate field');
  
  // Open Hazard Hunter in new tab
  window.open(HAZARD_HUNTER_URL, '_blank');
}

function openHazardHunterVerification(lat, lng) {
  // Hazard Hunter URL format for specific coordinates
  const verificationUrl = `${HAZARD_HUNTER_URL}?lat=${lat}&lng=${lng}`;
  
  // Store that we're in verification mode
  sessionStorage.setItem('verifyingCoordinates', 'true');
  sessionStorage.setItem('originalCoordinates', `${lat}, ${lng}`);
  
  // Open in new tab
  window.open(verificationUrl, '_blank');
  
  alert("Hazard Hunter opened with your location.\n\nYou can check for hazards and update coordinates if needed.\n\nReturn to this tab and update the coordinates field if necessary.");
}

/* ============ DATE FORMATTING FUNCTIONS ============ */
function toInputDate(val){
  if(!val && val !== 0) return '';
  
  // Already in yyyy-mm-dd format
  if(typeof val === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
  
  // Handle dd/mm/yyyy format
  if(typeof val === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(val)){
    const parts = val.split('/');
    const d = parts[0].padStart(2,'0');
    const m = parts[1].padStart(2,'0');
    const y = parts[2];
    return `${y}-${m}-${d}`;
  }
  
  // Handle mm/dd/yyyy format
  if(typeof val === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(val)){
    const [m, d, y] = val.split('/');
    const month = m.padStart(2,'0');
    const day = d.padStart(2,'0');
    return `${y}-${month}-${day}`;
  }
  
  // Try parsing as Date
  const dt = new Date(val);
  if(!isNaN(dt)){
    const y = dt.getFullYear();
    const m = String(dt.getMonth() + 1).padStart(2, '0');
    const d = String(dt.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }
  
  return '';
}

function toSheetDate(inputVal){
  if(!inputVal) return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputVal)){
    const [y,m,d] = inputVal.split('-');
    return `${d}/${m}/${y}`;
  }
  const dt = new Date(inputVal);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dd}/${mm}/${dt.getFullYear()}`;
  }
  return '';
}

function computeAgeDetailed(inputDateValue){
  if(!inputDateValue) return null;
  let d;
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputDateValue)){
    const parts = inputDateValue.split('-');
    d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
  } else {
    d = new Date(inputDateValue);
  }
  if(isNaN(d)) return null;

  const now = new Date();
  const birth = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  let years = today.getFullYear() - birth.getFullYear();
  let months = today.getMonth() - birth.getMonth();
  let days = today.getDate() - birth.getDate();

  if(days < 0){
    months -= 1;
    const prev = new Date(today.getFullYear(), today.getMonth(), 0);
    days += prev.getDate();
  }
  if(months < 0){
    years -= 1;
    months += 12;
  }

  let display = "";
  if(years >= 1){
    display = String(years);
  } else {
    if(months >= 1) display = `${months} month(s)`;
    else display = `${days} day(s)`;
  }

  let stage = "";
  if(years === 0){
    if(months <= 10) stage = "Infant";
    else stage = "Children";
  } else if(years <= 17) stage = "School Children";
  else if(years >= 60) stage = "Elderly";
  else stage = "Adult";

  return { years, months, days, display, stage };
}

/* ============ UPDATED DATE FORMATTING FUNCTION ============ */
function formatDateForDisplay(dateValue) {
  if (!dateValue || dateValue === 'N/A') return 'N/A';
  
  try {
    // If it's already in the correct format (MM/DD/YYYY, HH:MM:SS AM/PM), return as is
    if (typeof dateValue === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}, \d{1,2}:\d{2}:\d{2} [AP]M$/.test(dateValue)) {
      return dateValue;
    }
    
    // If it's an ISO string or timestamp (like "2025-12-10T05:02:00.000Z")
    const date = new Date(dateValue);
    if (!isNaN(date)) {
      // Format as MM/DD/YYYY, HH:MM:SS AM/PM to match formatTimestampPH_()
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const year = date.getFullYear();
      
      let hours = date.getHours();
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      
      hours = hours % 12;
      hours = hours ? hours : 12; // the hour '0' should be '12'
      hours = String(hours).padStart(2, '0');
      
      return `${month}/${day}/${year}, ${hours}:${minutes}:${seconds} ${ampm}`;
    }
    
    // For any other format, return as is
    return dateValue;
  } catch (e) {
    console.warn('Date formatting error:', e, 'for value:', dateValue);
    return dateValue;
  }
}

/* ============ CONTACT VALIDATION ============ */
function validatePhilippineMobileNumber(number) {
    const cleaned = number.replace(/\s+/g, '').replace(/[^\d+]/g, '');
    const pattern = /^(09|\+639)\d{9}$/;
    
    if (!pattern.test(cleaned)) return false;
    
    if (cleaned.startsWith('09') && cleaned.length !== 11) return false;
    if (cleaned.startsWith('+639') && cleaned.length !== 13) return false;
    
    return true;
}

function validateContactInput(input, errorElement) {
    if (!input || !errorElement) return true;
    
    const value = input.value.trim();
    
    // Allow empty for optional fields (check if field is required)
    const isRequired = input.hasAttribute('required');
    if (!value && !isRequired) {
        input.classList.remove('input-error');
        errorElement.style.display = 'none';
        return true;
    }
    
    if (!value && isRequired) {
        input.classList.add('input-error');
        errorElement.style.display = 'block';
        errorElement.textContent = 'Contact number is required';
        return false;
    }
    
    const isValid = validatePhilippineMobileNumber(value);
    
    if (!isValid) {
        input.classList.add('input-error');
        errorElement.style.display = 'block';
        errorElement.textContent = 'Please enter a valid Philippine mobile number (09XXXXXXXXX or +639XXXXXXXXX)';
        return false;
    } else {
        input.classList.remove('input-error');
        errorElement.style.display = 'none';
        return true;
    }
}

/* ============ SESSION CHECK FUNCTION ============ */
async function sessionCheck(){
  try {
    const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
    
    if (userName && userName !== "User") {
      document.getElementById('userName').innerText = userName;
      
      const isAdmin = localStorage.getItem("userRole") === "admin";
      const adminItems = document.querySelectorAll(".admin-only");
      adminItems.forEach(item => {
          item.style.display = isAdmin ? "block" : "none";
      });
      
      sessionStorage.setItem('authenticated', 'true');
      return true;
    } else {
      if(sessionStorage.getItem('authenticated')) {
        document.getElementById('userName').innerText = "User";
        return true;
      } else {
        window.location.href = 'index.html?session=expired';
        return false;
      }
    }
  } catch(e){ 
    console.warn('session check failed', e);
    return false;
  }
}

/* ============ ENHANCED LOGOUT FUNCTION ============ */
function handleLogout() {
  localStorage.clear();
  sessionStorage.clear();
  
  const logoutUrl = 'index.html?logout=true&t=' + Date.now();
  
  fetch(SCRIPT_URL+'?action=logout&t=' + Date.now())
    .catch(() => { })
    .finally(() => {
      window.location.replace(logoutUrl);
    });
}

/* ============ LOAD RECORDS WITH CACHING ============ */
async function loadRecords(){
    showLoading(true);
    try{
        const cachedData = localStorage.getItem('recordsCache');
        const cacheTime = localStorage.getItem('recordsCacheTime');
        const now = Date.now();
        
        if(cachedData && cacheTime && (now - parseInt(cacheTime)) < 300000) {
            const data = JSON.parse(cachedData);
            header = data.header || [];
            rawRows = data.rows || [];
            console.log("Using cached data");
        } else {
            const res = await fetch(`${SCRIPT_URL}?action=getRecords&barangay=&q=`);
            const data = await res.json();
            
            if(!data.success){ 
                alert("Load failed: " + (data.message||"")); 
                showLoading(false); 
                return; 
            }
            
            header = data.header || [];
            rawRows = data.rows || [];
            
            localStorage.setItem('recordsCache', JSON.stringify(data));
            localStorage.setItem('recordsCacheTime', now.toString());
            console.log("Loaded fresh data from server");
        }
        
        groupRows();
        filteredGroups = [...groups];
        currentPage = 1;
        renderTable();
        renderPagination();
        updateCounts();
    } catch(err){
        console.error(err);
        alert("Error loading records");
    }
    showLoading(false);
}

/* ============ CLIENT-SIDE FILTERING ============ */
function filterRecords() {
    const barangay = document.getElementById("filterBarangay").value || "";
    const q = document.getElementById("searchInput").value.trim().toLowerCase();
    
    currentPage = 1;
    
    filteredGroups = groups.filter(g => {
        const head = g.head || {};
        
        if (barangay && head["Barangay"] !== barangay) {
            return false;
        }
        
        if (q) {
            const searchableFields = [
                head["Data ID"] || "",
                head["Name of Head"] || "",
                head["Barangay"] || "",
                head["Purok/Street"] || "",
                head["Contact"] || ""
            ];
            
            const memberNames = g.members.map(m => m["Name of Household Member/s"] || "").join(" ");
            const searchText = [...searchableFields, memberNames].join(" ").toLowerCase();
            
            return searchText.includes(q);
        }
        
        return true;
    });
    
    renderTable();
    renderPagination();
    updateCounts();
}

/* ============ GROUPING ============ */
function groupRows(){
    const map = {};
    rawRows.forEach(r=>{
        const id = String(r["Data ID"] || "");
        if(!id) return;
        if(!map[id]) map[id] = { dataID:id, head:null, members:[] };

        const isHead = !r["Name of Household Member/s"] || String(r["Name of Household Member/s"]).trim() === "";
        if(isHead && !map[id].head) map[id].head = r;
        else map[id].members.push(r);
    });

    Object.keys(map).forEach(k=>{
        if(!map[k].head && map[k].members.length>0){
            map[k].head = map[k].members.shift();
        }
    });

    groups = Object.values(map).sort((a,b)=> Number(a.dataID) - Number(b.dataID));
}

/* ============ RENDER ============ */
function renderTable(){
    const thead = document.getElementById("tableHead");
    const tbody = document.getElementById("tableBody");
    thead.innerHTML = ""; tbody.innerHTML = "";

    // header row - FIXED: Only use header columns that exist in data
    let th = `<tr><th class="select-col"><input id="selectAll" type="checkbox"></th>`;
    header.forEach(c => th += `<th>${c}</th>`);
    th += `<th class="actions-col">Members</th><th class="actions-col">Actions</th></tr>`;
    thead.innerHTML = th;

    const start = (currentPage-1) * rowsPerPage;
    const pageRows = filteredGroups.slice(start, start + rowsPerPage);
    const keyword = document.getElementById("searchInput").value.trim();

    pageRows.forEach(g=>{
        const head = g.head || {};
        const mCount = g.members.length;

        let cls = mCount <= 1 ? "mem-small" : mCount <= 4 ? "mem-normal" : mCount <= 7 ? "mem-large" : "mem-critical";
        const tr = document.createElement("tr"); 
        tr.className = cls;

        // checkbox
        const tdSel = document.createElement("td"); 
        tdSel.className = "select-col";
        tdSel.innerHTML = `<input type="checkbox" class="row-select" data-id="${g.dataID}" ${selected.has(g.dataID) ? "checked" : ""}>`;
        tr.appendChild(tdSel);

        // header columns - FIXED: Only render columns from header array
        header.forEach(col=>{
            const td = document.createElement("td");
            let cellValue = head[col] || "";
            
            // Apply special formatting for date columns
            if (col === "Submitted On" || col === "Updated On") {
                cellValue = formatDateForDisplay(cellValue);
            }
            
            if (col === "Submitted On" && String(cellValue).includes("NaN")) {
                const rawData = rawRows.find(r => 
                    String(r["Data ID"]) === String(g.dataID) && 
                    (!r["Name of Household Member/s"] || String(r["Name of Household Member/s"]).trim() === "")
                );
                if (rawData && rawData[col] && !String(rawData[col]).includes("NaN")) {
                    td.innerHTML = highlight(formatDateForDisplay(rawData[col]), keyword);
                } else {
                    td.innerHTML = "Invalid Date";
                }
            } else {
                td.innerHTML = highlight(cellValue, keyword);
            }
            tr.appendChild(td);
        });

        // show toggle
        const tdShow = document.createElement("td"); 
        tdShow.className = "actions-col";
        tdShow.innerHTML = `<button class="show-toggle" onclick="toggleMembers('${g.dataID}')"><i class="fas fa-eye"></i> Show (${mCount})</button>`;
        tr.appendChild(tdShow);

        // action buttons - MODIFIED FOR IN-PLACE EDITING
        const tdAct = document.createElement("td"); 
        tdAct.className = "actions-col";
        tdAct.innerHTML = `
            <button class="icon-btn" title="Edit" onclick="onEdit('${g.dataID}')">
                <i class="fas fa-edit"></i>
            </button>
            <button class="icon-btn" title="Delete" onclick="onDelete('${g.dataID}')">
                <i class="fas fa-trash"></i>
            </button>
        `;
        tr.appendChild(tdAct);

        tbody.appendChild(tr);

        // member rows
        g.members.forEach(m=>{
            const mr = document.createElement("tr");
            mr.className = "member-row hidden";
            mr.dataset.parent = g.dataID;
            mr.appendChild(document.createElement("td")); // empty select col
            
            header.forEach(col=>{
                const td = document.createElement("td");
                let cellValue = m[col] || "";
                
                // Apply special formatting for date columns
                if (col === "Submitted On" || col === "Updated On") {
                    cellValue = formatDateForDisplay(cellValue);
                }
                
                if (col === "Submitted On" && String(cellValue).includes("NaN")) {
                    const rawData = rawRows.find(r => 
                        String(r["Data ID"]) === String(g.dataID) && 
                        String(r["Name of Household Member/s"] || "").trim() === String(m["Name of Household Member/s"] || "").trim()
                    );
                    if (rawData && rawData[col] && !String(rawData[col]).includes("NaN")) {
                        td.innerHTML = highlight(formatDateForDisplay(rawData[col]), keyword);
                    } else {
                        td.innerHTML = "Invalid Date";
                    }
                } else {
                    td.innerHTML = highlight(cellValue, keyword);
                }
                mr.appendChild(td);
            });
            
            mr.appendChild(document.createElement("td")); // empty members column
            mr.appendChild(document.createElement("td")); // empty actions column
            tbody.appendChild(mr);
        });
    });

    // select all logic for page
    const selectAll = document.getElementById("selectAll");
    if(selectAll){
        selectAll.checked = pageRows.every(g => selected.has(g.dataID));
        selectAll.onchange = function(){
            pageRows.forEach(g => {
                if(this.checked) selected.add(g.dataID); 
                else selected.delete(g.dataID);
            });
            renderTable();
            updateCounts();
        };
    }

    // row selects
    document.querySelectorAll(".row-select").forEach(cb=>{
        cb.onchange = function(){
            const id = this.dataset.id;
            if(this.checked) selected.add(id); 
            else selected.delete(id);
            updateCounts();
        };
    });

    updateCounts();
}
   
/* ============ TOGGLE MEMBERS ============ */
function toggleMembers(id){
    const memberRows = document.querySelectorAll(`tr.member-row[data-parent="${id}"]`);
    memberRows.forEach(r => {
        r.classList.toggle("hidden");
        const btn = document.querySelector(`.show-toggle[onclick*="${id}"]`);
        if(btn){
            const icon = btn.querySelector('i');
            if(r.classList.contains('hidden')){
                icon.className = 'fas fa-eye';
            } else {
                icon.className = 'fas fa-eye-slash';
            }
        }
    });
}

/* ============ PAGINATION ============ */
function renderPagination(){
    const div = document.getElementById("paginationArea");
    const total = Math.ceil(filteredGroups.length / rowsPerPage);
    
    if(total <= 1){ 
        div.innerHTML = ""; 
        return; 
    }

    let html = "";
    for(let i=1;i<=total;i++){
        html += `<button onclick="gotoPage(${i})" class="${i===currentPage ? 'active' : ''}">${i}</button>`;
    }
    div.innerHTML = html;
}

function gotoPage(p){ 
    if(p<1) p=1; 
    currentPage=p; 
    renderTable(); 
    renderPagination(); 
}

/* ============ COUNTS ============ */
function updateCounts(){
    document.getElementById("rowCount").innerText = groups.length;
    document.getElementById("matchCount").innerText = filteredGroups.length;
    
    let selectedCount = 0;
    filteredGroups.forEach(g => {
        if (selected.has(g.dataID)) {
            selectedCount++;
        }
    });
    document.getElementById("selectedCount").innerText = selectedCount;
}

/* ============ SYNC ANIMAL CHECKBOXES - UPDATED ============ */
function syncAnimalCheckboxes() {
  document.querySelectorAll('#editPanel .animal-card input[type="checkbox"]').forEach(checkbox => {
    const qtyInput = checkbox.closest('.animal-card').querySelector('.qty');
    
    // Set initial state
    qtyInput.disabled = !checkbox.checked;
    if (!checkbox.checked) qtyInput.value = '';
    
    // Add change listener - set to 1 when checked (like dataForm.html)
    checkbox.addEventListener('change', function() {
      qtyInput.disabled = !this.checked;
      if (this.checked) {
        qtyInput.value = qtyInput.value || '1';
      } else {
        qtyInput.value = '';
      }
    });
    
    // Also sync quantity input changes
    qtyInput.addEventListener('input', function() {
      if (this.value !== '' && this.value !== '0') {
        checkbox.checked = true;
        qtyInput.disabled = false;
      } else if (this.value === '' || this.value === '0') {
        checkbox.checked = false;
        qtyInput.disabled = true;
      }
    });
  });
}

/* ============ EDIT FUNCTION - MODIFIED FOR IN-PLACE EDITING ============ */
function onEdit(id){
    resetEditState();
    
    const group = groups.find(g => g.dataID === id) || filteredGroups.find(g => g.dataID === id);
    if(!group){ alert('Record not found'); return; }

    editDataID = id;
    editHead = Object.assign({}, group.head || {});
    editMembers = (group.members || []).map(m => Object.assign({}, m));

    // Show Data ID at the top of edit panel
    if ($('editDataIdDisplay')) {
        $('editDataIdDisplay').textContent = editDataID;
    }

    // Store original submittedBy value from head
    const originalSubmittedBy = editHead['Submitted By'] || editHead['submittedBy'] || '';
    
    // If no submittedBy in head, add current user's name
    if (!originalSubmittedBy) {
        editHead['Submitted By'] = getUserFullName();
    }
    
    // Prefill head inputs
    $('edit_coordinate').value = editHead['Coordinate'] || editHead['Coordinates'] || '';
    $('edit_barangay').value = editHead['Barangay'] || '';
    $('edit_sitio').value = editHead['Sitio / Purok'] || '';
    $('edit_householdHead').value = editHead['Name of Household Head'] || '';
    
    // FishR/RBIS Registered - FIXED
    const hasRegistration = editHead['FishR Registered/RBIS Registered'] && editHead['FishR Registered/RBIS Registered'] !== '';
    $('edit_headRegisteredCheckbox').checked = hasRegistration;
    if (hasRegistration) {
        $('edit_headRegistrationField').classList.add('show');
        $('edit_headRegistration').value = editHead['FishR Registered/RBIS Registered'] || '';
    } else {
        $('edit_headRegistrationField').classList.remove('show');
        $('edit_headRegistration').value = '';
    }
    
    $('edit_contactNo').value = editHead['Contact no.'] || '';
    
    // Set radio buttons - FIXED to use radio-line styling
    qAll("input[name='edit_head_sex']").forEach(r => r.checked = (r.value === (editHead['Sex'] || '')));
    $('edit_householdBirthdate').value = toInputDate(editHead['Birthdate'] || '');
    updateEditHeadAgeStage();
    $('edit_memberCount').value = editHead['No. of Household Member/s'] || (editMembers.length || 0);
    
    // Educational & Economic Status
    $('edit_educationalAttainment').value = editHead['Educational Attainment'] || '';
    if (editHead['Educational Attainment'] === 'College Graduate') {
        $('edit_collegeCourseField').classList.add('show');
        $('edit_collegeCourse').value = editHead['College Graduate Course'] || '';
    } else {
        $('edit_collegeCourseField').classList.remove('show');
        $('edit_collegeCourse').value = '';
    }
    
    $('edit_employment').value = editHead['Employment'] || '';
    if (editHead['Employment'] === 'Employed') {
        $('edit_jobTitleField').classList.add('show');
        $('edit_jobTitle').value = editHead['Job Title'] || '';
    } else {
        $('edit_jobTitleField').classList.remove('show');
        $('edit_jobTitle').value = '';
    }
    
    // Set OFW status - FIXED to use radio-line styling
    qAll("input[name='edit_ofw_status']").forEach(r => r.checked = (r.value === (editHead['Overseas Filipino Worker(OFW)'] || 'No')));
    if (editHead['Overseas Filipino Worker(OFW)'] === 'Yes') {
        $('edit_countryField').classList.add('show');
        $('edit_country').value = editHead['Country'] || '';
    } else {
        $('edit_countryField').classList.remove('show');
        $('edit_country').value = '';
    }
    
    // Health & Status - FIXED to use radio-line styling
    qAll("input[name='edit_head_pwd']").forEach(r => r.checked = (r.value === (editHead['PWD'] || 'No')));
    $('edit_head_status').value = editHead['Status'] || '';
    
    // Domestic Animals - FIXED with checkbox sync
    $('edit_dog_chk').checked = (editHead['Dog'] === 'Yes');
    $('edit_dog_qty').value = editHead['Dog Qty.'] || '';
    $('edit_cat_chk').checked = (editHead['Cat'] === 'Yes');
    $('edit_cat_qty').value = editHead['Cat Qty.'] || '';
    $('edit_pig_chk').checked = (editHead['Pig'] === 'Yes');
    $('edit_pig_qty').value = editHead['Pig Qty.'] || '';
    $('edit_cow_chk').checked = (editHead['Cow'] === 'Yes');
    $('edit_cow_qty').value = editHead['Cow Qty.'] || '';
    $('edit_carabao_chk').checked = (editHead['Carabao'] === 'Yes');
    $('edit_carabao_qty').value = editHead['Carabao Qty.'] || '';
    $('edit_chicken_chk').checked = (editHead['Chicken'] === 'Yes');
    $('edit_chicken_qty').value = editHead['Chicken Qty.'] || '';
    $('edit_animals_others').value = editHead['Others'] || '';
    
    // Sync animal checkboxes with quantity fields
    syncAnimalCheckboxes();
    
    // Transportation & Evacuation
    $('edit_head_transport').value = editHead['Transportation'] || '';
    $('edit_pickup').value = editHead['Designated Pick-Up Point'] || editHead['Pick-Up Location'] || '';
    $('edit_dropoff').value = editHead['Drop-Off Point'] || editHead['Drop-Off Location'] || '';
    $('edit_campName').value = editHead['Name of Camp'] || editHead['Evacuation Camp Name'] || '';
    $('edit_capacity').value = editHead['Capacity'] || '';
    $('edit_insideCamp').value = editHead['No. of Individuals Inside Camp'] || editHead['Individuals Currently in Camp'] || '';
    $('edit_outsideCamp').value = editHead['No. of Individuals Outside Camp'] || editHead['Individuals Outside Camp'] || '';
    $('edit_reasons').value = editHead['Reasons for Displacement'] || '';
    
    // Government Assistance
    $('edit_ass_tupad').checked = (editHead['TUPAD'] === 'Yes');
    $('edit_ass_local4ps').checked = (editHead['Local 4Ps'] === 'Yes');
    $('edit_ass_intl4ps').checked = (editHead['National 4Ps'] === 'Yes');
    $('edit_ass_locsp').checked = (editHead['Local Social Pension'] === 'Yes');
    $('edit_ass_intlsp').checked = (editHead['National Social Pension'] === 'Yes');
    $('edit_ass_solo').checked = (editHead['Solo Parent Assistance'] === 'Yes');
    $('edit_ass_relief').checked = (editHead['Relief Goods'] === 'Yes');
    $('edit_ass_cash').checked = (editHead['Cash Subsidy'] === 'Yes');
    $('edit_ass_aics').value = editHead['AICS'] || '';

    updateEditMembersPreview();
    openEditPanel();
    
    setTimeout(()=> $('edit_householdHead')?.focus(), 120);
}

function getUserFullName() {
  return localStorage.getItem('staffName') || 
         localStorage.getItem('userFullName') || 
         localStorage.getItem('fullName') || 
         localStorage.getItem('username') || 
         'System';
}

function updateEditHeadAgeStage(){
  const d = $('edit_householdBirthdate')?.value || '';
  const ageObj = computeAgeDetailed(d);
  if(!ageObj){ 
      if($('edit_householdAge')) $('edit_householdAge').value=''; 
      if($('edit_householdStage')) $('edit_householdStage').value=''; 
      return; 
  }
  $('edit_householdAge').value = ageObj.display;
  $('edit_householdStage').value = ageObj.stage;
}

function createEmptyMember(){
  return {
    'Data ID': editDataID || '',
    'Name of Household Member/s':'',
    'FishR Registered/RBIS Registered':'',
    'Contact no.':'',
    'Sex':'',
    'Birthdate':'',
    'Age':'',
    'Stage':'',
    'Persons with Disability (PWD)':'No',
    'Status':'',
    'Educational Attainment':'',
    'College Graduate Course':'',
    'Employment':'',
    'Job Title':'',
    'Overseas Filipino Worker(OFW)':'No',
    'Country':'',
    'Transportation':'',
    'Designated Pick-Up Point':'',
    'Pick-Up Location':'',
    'Drop-Off Point':'',
    'Drop-Off Location':'',
    'Name of Camp':'',
    'Evacuation Camp Name':'',
    'Capacity':'',
    'No. of Individuals Inside Camp':'',
    'Individuals Currently in Camp':'',
    'No. of Individuals Outside Camp':'',
    'Individuals Outside Camp':'',
    'Reasons for Displacement':'',
    'TUPAD':'No','Local 4Ps':'No','National 4Ps':'No',
    'Local Social Pension':'No','National Social Pension':'No','Solo Parent Assistance':'No',
    'Cash Subsidy':'No','Relief Goods':'No','AICS':'',
    'Submitted By': getUserFullName()
  };
}

function updateEditMembersPreview(){
  const ul = $('edit_membersPreview');
  if(!ul) return;
  ul.innerHTML = '';
  const n = editMembers.length || 0;
  if($('edit_previewCount')) $('edit_previewCount').innerText = n;
  for(let i=0;i<n;i++){
    const li = document.createElement('li');
    const m = editMembers[i] || {};
    li.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span>#${i+1} ‚Äî ${escapeHtml(m['Name of Household Member/s'] || '(empty)')} (${m['Contact no.']||''})</span>
        <div class="member-actions">
          <button class="edit-btn" title="Edit this member" onclick="event.stopPropagation(); openMemberPanelForEdit(${i})">‚úèÔ∏è</button>
          <button class="remove-btn" title="Remove this member" onclick="event.stopPropagation(); removeMember(${i})">üóëÔ∏è</button>
        </div>
      </div>
    `;
    li.style.cursor = 'pointer';
    li.onclick = () => { memberEditIndex = i; openMemberPanelForEdit(i); };
    ul.appendChild(li);
  }
}

function escapeHtml(s){ return String(s ?? '').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

function removeMember(index) {
  if (confirm('Are you sure you want to remove this member?')) {
    editMembers.splice(index, 1);
    updateEditMembersPreview();
    
    // Update member count
    const currentCount = parseInt($('edit_memberCount').value) || 0;
    if (currentCount > 0) {
      $('edit_memberCount').value = currentCount - 1;
    }
  }
}

/* ============ SETUP CONDITIONAL FIELDS ============ */
function setupEditConditionalFields() {
    // Head Registered Checkbox
    const headRegisteredCheckbox = $('edit_headRegisteredCheckbox');
    const headRegistrationField = $('edit_headRegistrationField');
    const headRegistrationSelect = $('edit_headRegistration');
    
    if (headRegisteredCheckbox) {
        headRegisteredCheckbox.addEventListener('change', function() {
            if (this.checked) {
                headRegistrationField.classList.add('show');
                headRegistrationSelect.required = true;
            } else {
                headRegistrationField.classList.remove('show');
                headRegistrationSelect.required = false;
                headRegistrationSelect.value = '';
            }
        });
    }
    
    // Educational Attainment -> College Course
    const educationSelect = $('edit_educationalAttainment');
    const collegeCourseField = $('edit_collegeCourseField');
    const collegeCourseInput = $('edit_collegeCourse');
    
    if (educationSelect) {
        educationSelect.addEventListener('change', function() {
            if (this.value === 'College Graduate') {
                collegeCourseField.classList.add('show');
                collegeCourseInput.required = true;
            } else {
                collegeCourseField.classList.remove('show');
                collegeCourseInput.required = false;
                collegeCourseInput.value = '';
            }
        });
    }
    
    // Employment -> Job Title
    const employmentSelect = $('edit_employment');
    const jobTitleField = $('edit_jobTitleField');
    const jobTitleSelect = $('edit_jobTitle');
    
    if (employmentSelect) {
        employmentSelect.addEventListener('change', function() {
            if (this.value === 'Employed') {
                jobTitleField.classList.add('show');
                jobTitleSelect.required = true;
            } else {
                jobTitleField.classList.remove('show');
                jobTitleSelect.required = false;
                jobTitleSelect.value = '';
            }
        });
    }
    
    // OFW Status -> Country
    const ofwRadios = document.querySelectorAll('input[name="edit_ofw_status"]');
    const countryField = $('edit_countryField');
    const countrySelect = $('edit_country');
    
    if (ofwRadios.length > 0) {
        ofwRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'Yes') {
                    countryField.classList.add('show');
                    countrySelect.required = true;
                } else {
                    countryField.classList.remove('show');
                    countrySelect.required = false;
                    countrySelect.value = '';
                }
            });
        });
    }
    
    // Member Registered Checkbox
    const memberRegisteredCheckbox = $('memberRegisteredCheckbox');
    const memberRegistrationField = $('memberRegistrationField');
    const memberRegistrationSelect = $('memberRegistration');
    
    if (memberRegisteredCheckbox) {
        memberRegisteredCheckbox.addEventListener('change', function() {
            if (this.checked) {
                memberRegistrationField.classList.add('show');
                memberRegistrationSelect.required = true;
            } else {
                memberRegistrationField.classList.remove('show');
                memberRegistrationSelect.required = false;
                memberRegistrationSelect.value = '';
            }
        });
    }
    
    // Member Educational Attainment -> College Course
    const memberEducationSelect = $('memberEducationalAttainment');
    const memberCollegeCourseField = $('memberCollegeCourseField');
    const memberCollegeCourseInput = $('memberCollegeCourse');
    
    if (memberEducationSelect) {
        memberEducationSelect.addEventListener('change', function() {
            if (this.value === 'College Graduate') {
                memberCollegeCourseField.classList.add('show');
                memberCollegeCourseInput.required = true;
            } else {
                memberCollegeCourseField.classList.remove('show');
                memberCollegeCourseInput.required = false;
                memberCollegeCourseInput.value = '';
            }
        });
    }
    
    // Member Employment -> Job Title
    const memberEmploymentSelect = $('memberEmployment');
    const memberJobTitleField = $('memberJobTitleField');
    const memberJobTitleSelect = $('memberJobTitle');
    
    if (memberEmploymentSelect) {
        memberEmploymentSelect.addEventListener('change', function() {
            if (this.value === 'Employed') {
                memberJobTitleField.classList.add('show');
                memberJobTitleSelect.required = true;
            } else {
                memberJobTitleField.classList.remove('show');
                memberJobTitleSelect.required = false;
                memberJobTitleSelect.value = '';
            }
        });
    }
    
    // Member OFW Status -> Country
    const memberOfwRadios = document.querySelectorAll('input[name="member_ofw_status"]');
    const memberCountryField = $('memberCountryField');
    const memberCountrySelect = $('memberCountry');
    
    if (memberOfwRadios.length > 0) {
        memberOfwRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'Yes') {
                    memberCountryField.classList.add('show');
                    memberCountrySelect.required = true;
                } else {
                    memberCountryField.classList.remove('show');
                    memberCountrySelect.required = false;
                    memberCountrySelect.value = '';
                }
            });
        });
    }
}

/* ============ MEMBER PANEL FUNCTIONS ============ */
function validateEditPanelForMemberEditing() {
  // Check if household head has valid contact number
  if (!validateContactInput($('edit_contactNo'), $('edit_contactError'))) {
    alert('Please enter a valid Philippine mobile number for the household head first.');
    $('edit_contactNo').focus();
    return false;
  }
  
  // Check if household head name is filled
  const headName = $('edit_householdHead').value.trim();
  if (!headName) {
    alert('Please enter household head name first.');
    $('edit_householdHead').focus();
    return false;
  }
  
  // Check if barangay is selected
  const barangay = $('edit_barangay').value;
  if (!barangay) {
    alert('Please select barangay first.');
    $('edit_barangay').focus();
    return false;
  }
  
  return true;
}

function openMemberPanelForEdit(index){
  // Ensure we have valid head data first
  if (!validateEditPanelForMemberEditing()) {
    return;
  }
  
  // Collect head data
  collectHeadFromEditForm();
  
  // Ensure the members array exists
  if (!editMembers || !Array.isArray(editMembers)) {
    editMembers = [];
  }
  
  // Ensure we have enough members
  while (editMembers.length <= index) {
    editMembers.push(createEmptyMember());
  }
  
  memberEditIndex = index;
  const total = Math.max(1, editMembers.length);
  $('memberPanelTitle').innerText = `Member ${index+1} of ${total}`;
  fillMemberPanelFromEdit(index);
  $('memberPanel')?.classList.add('open');
  $('panelOverlay')?.classList.add('show');
  
  // Focus on the first field
  setTimeout(() => $('memberName')?.focus(), 100);
}

function fillMemberPanelFromEdit(idx){
  const m = editMembers[idx] || createEmptyMember();
  
  // Basic Information
  $('memberName').value = m['Name of Household Member/s'] || '';
  
  // FishR/RBIS Registered - FIXED
  const hasRegistration = m['FishR Registered/RBIS Registered'] && m['FishR Registered/RBIS Registered'] !== '';
  $('memberRegisteredCheckbox').checked = hasRegistration;
  if (hasRegistration) {
    $('memberRegistrationField').classList.add('show');
    $('memberRegistration').value = m['FishR Registered/RBIS Registered'] || '';
  } else {
    $('memberRegistrationField').classList.remove('show');
    $('memberRegistration').value = '';
  }
  
  $('memberContact').value = m['Contact no.'] || '';
  qAll("input[name='member_sex']").forEach(r => r.checked = (r.value === (m['Sex'] || '')));
  $('memberBirthdate').value = toInputDate(m['Birthdate'] || '');
  updateMemberAgeStage();
  
  // Educational & Economic Status
  $('memberEducationalAttainment').value = m['Educational Attainment'] || '';
  if (m['Educational Attainment'] === 'College Graduate') {
    $('memberCollegeCourseField').classList.add('show');
    $('memberCollegeCourse').value = m['College Graduate Course'] || '';
  } else {
    $('memberCollegeCourseField').classList.remove('show');
    $('memberCollegeCourse').value = '';
  }
  
  $('memberEmployment').value = m['Employment'] || '';
  if (m['Employment'] === 'Employed') {
    $('memberJobTitleField').classList.add('show');
    $('memberJobTitle').value = m['Job Title'] || '';
  } else {
    $('memberJobTitleField').classList.remove('show');
    $('memberJobTitle').value = '';
  }
  
  qAll("input[name='member_ofw_status']").forEach(r => r.checked = (r.value === (m['Overseas Filipino Worker(OFW)'] || 'No')));
  if (m['Overseas Filipino Worker(OFW)'] === 'Yes') {
    $('memberCountryField').classList.add('show');
    $('memberCountry').value = m['Country'] || '';
  } else {
    $('memberCountryField').classList.remove('show');
    $('memberCountry').value = '';
  }
  
  // Health and Status
  qAll("input[name='member_pwd']").forEach(r => r.checked = (r.value === (m['Persons with Disability (PWD)'] || 'No')));
  $('memberStatus').value = m['Status'] || '';
  
  // Transportation & Evacuation Details
  $('memberTransport').value = m['Transportation'] || '';
  $('memberPickup').value = m['Designated Pick-Up Point'] || m['Pick-Up Location'] || '';
  $('memberDropoff').value = m['Drop-Off Point'] || m['Drop-Off Location'] || '';
  $('memberCamp').value = m['Name of Camp'] || m['Evacuation Camp Name'] || '';
  $('memberCampCap').value = m['Capacity'] || '';
  $('memberInside').value = m['No. of Individuals Inside Camp'] || m['Individuals Currently in Camp'] || '';
  $('memberOutside').value = m['No. of Individuals Outside Camp'] || m['Individuals Outside Camp'] || '';
  $('memberReason').value = m['Reasons for Displacement'] || '';
  
  // Government Assistance Programs
  $('member_tupad').checked = (m['TUPAD'] === 'Yes');
  $('member_local4ps').checked = (m['Local 4Ps'] === 'Yes');
  $('member_intl4ps').checked = (m['National 4Ps'] === 'Yes');
  $('member_locsp').checked = (m['Local Social Pension'] === 'Yes');
  $('member_intlsp').checked = (m['National Social Pension'] === 'Yes');
  $('member_solo').checked = (m['Solo Parent Assistance'] === 'Yes');
  $('member_relief').checked = (m['Relief Goods'] === 'Yes');
  $('member_cash').checked = (m['Cash Subsidy'] === 'Yes');
  $('memberAics').value = m['AICS'] || '';
}

function collectHeadFromEditForm(){
  const bd_input = $('edit_householdBirthdate').value || '';
  const headBirthForSheet = toSheetDate(bd_input);
  const headAgeInfo = computeAgeDetailed(bd_input);
  const headAgeVal = headAgeInfo ? headAgeInfo.display : '';

  // Get head registration value only if checkbox is checked
  let headRegistrationValue = "";
  if ($('edit_headRegisteredCheckbox').checked) {
    headRegistrationValue = $('edit_headRegistration').value || "";
  }

  // Preserve the original submittedBy value
  const originalSubmittedBy = editHead['Submitted By'] || editHead['submittedBy'] || '';
  // FIXED: Preserve original Submitted On date
  const originalSubmittedOn = editHead['Submitted On'] || '';
  
  editHead = {
    'Data ID': editDataID,
    'Coordinate': $('edit_coordinate').value || '',
    'Coordinates': $('edit_coordinate').value || '',
    'Barangay': $('edit_barangay').value || '',
    'Sitio / Purok': $('edit_sitio').value || '',
    'Name of Household Head': ($('edit_householdHead').value || '').trim(),
    'FishR Registered/RBIS Registered': headRegistrationValue,
    'Contact no.': $('edit_contactNo').value || '',
    'Sex': document.querySelector("input[name='edit_head_sex']:checked")?.value || '',
    'Birthdate': headBirthForSheet,
    'Age': headAgeVal,
    'Stage': headAgeInfo ? headAgeInfo.stage : '',
    'No. of Household Member/s': String($('edit_memberCount').value || '0'),
    'Persons with Disability (PWD)': document.querySelector("input[name='edit_head_pwd']:checked")?.value || 'No',
    'Status': $('edit_head_status').value || '',
    'Educational Attainment': $('edit_educationalAttainment').value || '',
    'College Graduate Course': $('edit_collegeCourse').value || '',
    'Employment': $('edit_employment').value || '',
    'Job Title': $('edit_jobTitle').value || '',
    'Overseas Filipino Worker(OFW)': document.querySelector("input[name='edit_ofw_status']:checked")?.value || 'No',
    'Country': $('edit_country').value || '',
    'Transportation': $('edit_head_transport').value || '',
    'Designated Pick-Up Point': $('edit_pickup').value || '',
    'Pick-Up Location': $('edit_pickup').value || '',
    'Drop-Off Point': $('edit_dropoff').value || '',
    'Drop-Off Location': $('edit_dropoff').value || '',
    'Name of Camp': $('edit_campName').value || '',
    'Evacuation Camp Name': $('edit_campName').value || '',
    'Capacity': $('edit_capacity').value || '',
    'No. of Individuals Inside Camp': $('edit_insideCamp').value || '',
    'Individuals Currently in Camp': $('edit_insideCamp').value || '',
    'No. of Individuals Outside Camp': $('edit_outsideCamp').value || '',
    'Individuals Outside Camp': $('edit_outsideCamp').value || '',
    'Reasons for Displacement': $('edit_reasons').value || '',
    'Dog': $('edit_dog_chk').checked ? 'Yes' : 'No',
    'Dog Qty.': $('edit_dog_qty').value || '',
    'Cat': $('edit_cat_chk').checked ? 'Yes' : 'No',
    'Cat Qty.': $('edit_cat_qty').value || '',
    'Pig': $('edit_pig_chk').checked ? 'Yes' : 'No',
    'Pig Qty.': $('edit_pig_qty').value || '',
    'Cow': $('edit_cow_chk').checked ? 'Yes' : 'No',
    'Cow Qty.': $('edit_cow_qty').value || '',
    'Carabao': $('edit_carabao_chk').checked ? 'Yes' : 'No',
    'Carabao Qty.': $('edit_carabao_qty').value || '',
    'Chicken': $('edit_chicken_chk').checked ? 'Yes' : 'No',
    'Chicken Qty.': $('edit_chicken_qty').value || '',
    'Others': $('edit_animals_others').value || '',
    'TUPAD': $('edit_ass_tupad').checked ? 'Yes' : 'No',
    'Local 4Ps': $('edit_ass_local4ps').checked ? 'Yes' : 'No',
    'National 4Ps': $('edit_ass_intl4ps').checked ? 'Yes' : 'No',
    'Local Social Pension': $('edit_ass_locsp').checked ? 'Yes' : 'No',
    'National Social Pension': $('edit_ass_intlsp').checked ? 'Yes' : 'No',
    'Solo Parent Assistance': $('edit_ass_solo').checked ? 'Yes' : 'No',
    'Relief Goods': $('edit_ass_relief').checked ? 'Yes' : 'No',
    'Cash Subsidy': $('edit_ass_cash').checked ? 'Yes' : 'No',
    'AICS': $('edit_ass_aics').value || '',
    // Preserve the Submitted By and Submitted On fields
    'Submitted By': originalSubmittedBy || getUserFullName(),
    'Submitted On': originalSubmittedOn // FIXED: Preserve original Submitted On date
  };
}

function collectMemberPanelToEdit(){
  const name = $('memberName').value.trim();
  const birthdate_input = $('memberBirthdate').value || '';
  const birth_for_sheet = toSheetDate(birthdate_input);
  const ageObj = computeAgeDetailed(birthdate_input);
  const ageVal = ageObj ? ageObj.display : '';
  const stageVal = ageObj ? ageObj.stage : '';

  // Get registration value only if checkbox is checked
  let registrationValue = "";
  if ($('memberRegisteredCheckbox').checked) {
    registrationValue = $('memberRegistration').value || "";
  }

  // Get the current member to preserve existing submittedBy
  const currentMember = editMembers[memberEditIndex] || {};
  const existingSubmittedBy = currentMember['Submitted By'] || '';

  const obj = {
    'Data ID': editDataID,
    'Name of Household Member/s': name,
    'FishR Registered/RBIS Registered': registrationValue,
    'Contact no.': $('memberContact').value || '',
    'Sex': document.querySelector("input[name='member_sex']:checked")?.value || '',
    'Birthdate': birth_for_sheet,
    'Age': ageVal,
    'Stage': stageVal,
    'Persons with Disability (PWD)': document.querySelector("input[name='member_pwd']:checked")?.value || 'No',
    'Status': $('memberStatus').value || '',
    'Educational Attainment': $('memberEducationalAttainment').value || '',
    'College Graduate Course': $('memberCollegeCourse').value || '',
    'Employment': $('memberEmployment').value || '',
    'Job Title': $('memberJobTitle').value || '',
    'Overseas Filipino Worker(OFW)': document.querySelector("input[name='member_ofw_status']:checked")?.value || 'No',
    'Country': $('memberCountry').value || '',
    'Transportation': $('memberTransport').value || '',
    'Designated Pick-Up Point': $('memberPickup').value || '',
    'Pick-Up Location': $('memberPickup').value || '',
    'Drop-Off Point': $('memberDropoff').value || '',
    'Drop-Off Location': $('memberDropoff').value || '',
    'Name of Camp': $('memberCamp').value || '',
    'Evacuation Camp Name': $('memberCamp').value || '',
    'Capacity': $('memberCampCap').value || '',
    'No. of Individuals Inside Camp': $('memberInside').value || '',
    'Individuals Currently in Camp': $('memberInside').value || '',
    'No. of Individuals Outside Camp': $('memberOutside').value || '',
    'Individuals Outside Camp': $('memberOutside').value || '',
    'Reasons for Displacement': $('memberReason').value || '',
    'TUPAD': $('member_tupad').checked ? 'Yes' : 'No',
    'Local 4Ps': $('member_local4ps').checked ? 'Yes' : 'No',
    'National 4Ps': $('member_intl4ps').checked ? 'Yes' : 'No',
    'Local Social Pension': $('member_locsp').checked ? 'Yes' : 'No',
    'National Social Pension': $('member_intlsp').checked ? 'Yes' : 'No',
    'Solo Parent Assistance': $('member_solo').checked ? 'Yes' : 'No',
    'Relief Goods': $('member_relief').checked ? 'Yes' : 'No',
    'Cash Subsidy': $('member_cash').checked ? 'Yes' : 'No',
    'AICS': $('memberAics').value || '',
    // Preserve existing submittedBy or use current user's full name
    'Submitted By': existingSubmittedBy || getUserFullName()
  };
  editMembers[memberEditIndex] = obj;
}

function updateMemberAgeStage(){
  const date = $('memberBirthdate').value;
  const ageObj = computeAgeDetailed(date);
  if(!ageObj){ 
      $('memberAge').value=''; 
      $('memberStage').value=''; 
      return; 
  }
  $('memberAge').value = ageObj.display;
  $('memberStage').value = ageObj.stage;
}

function memberPanelNext() {
    const name = $('memberName').value.trim();
    const contact = $('memberContact').value.trim();
    const birthdate = $('memberBirthdate').value;
    const sex = document.querySelector("input[name='member_sex']:checked")?.value;
    
    // Validate all required fields
    if(!name){ 
        alert('Please enter member name'); 
        $('memberName').focus();
        return; 
    }
    
    if(!sex){
        alert('Please select member sex');
        qAll("input[name='member_sex']")[0]?.focus();
        return;
    }
    
    if(!birthdate){
        alert('Please enter member birthdate');
        $('memberBirthdate').focus();
        return;
    }
    
    // Validate contact number (if provided)
    if (contact && !validateContactInput($('memberContact'), $('memberContactError'))) {
        alert('Please enter a valid Philippine mobile number');
        $('memberContact').focus();
        return;
    }
    
    collectMemberPanelToEdit();
    memberEditIndex++;
    
    if(memberEditIndex >= editMembers.length){
        $('memberPanel')?.classList.remove('open');
        updateEditMembersPreview();
        if(sequenceMode){
            sequenceMode = false;
            saveEditedHousehold(true);
        }
        return;
    }
    
    fillMemberPanelFromEdit(memberEditIndex);
    $('memberPanelTitle').innerText = `Member ${memberEditIndex+1} of ${editMembers.length}`;
}

function memberPanelBack() {
    collectMemberPanelToEdit();
    if(memberEditIndex > 0){ 
        memberEditIndex--; 
        fillMemberPanelFromEdit(memberEditIndex); 
        $('memberPanelTitle').innerText = `Member ${memberEditIndex+1} of ${editMembers.length}`; 
    }
    else { 
        $('memberPanel')?.classList.remove('open'); 
        updateEditMembersPreview(); 
    }
}

/* ============ FIXED SAVE EDITED HOUSEHOLD FUNCTION ============ */
async function saveEditedHousehold(silentReload = false){
  const btn = $('saveEditBtn');
  const originalText = btn ? btn.innerText : 'Save changes';
  
  try {
    // Validate required fields
    const contactNo = $('edit_contactNo').value.trim();
    if (!validateContactInput($('edit_contactNo'), $('edit_contactError'))) {
        alert('Please enter a valid Philippine mobile number for the household head');
        $('edit_contactNo').focus();
        return;
    }
    
    collectHeadFromEditForm();

    const expected = Number($('edit_memberCount')?.value || 0);
    while(editMembers.length < expected) editMembers.push(createEmptyMember());
    if(editMembers.length > expected) editMembers = editMembers.slice(0, expected);

    const userFullName = getUserFullName();

    // Create properly formatted date for Philippines timezone
    const now = new Date();
    const formattedDate = `${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')}/${now.getFullYear()}, ` +
                         `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')} ` +
                         `${now.getHours() >= 12 ? 'PM' : 'AM'}`;

    // Add "Last Edited By" field with formatted date
    editHead['Last Edited By'] = userFullName;
    editHead['Last Edit Date'] = formattedDate;
    
    // Preserve original Submitted On date if it exists
    if (!editHead['Submitted On']) {
        editHead['Submitted On'] = formattedDate;
    }
    
    // Add Updated By and Updated On fields for tracking
    editHead['Updated By'] = userFullName;
    editHead['Updated On'] = formattedDate;
    
    // Ensure all members have the correct Data ID with formatted dates
    editMembers.forEach((member, index) => {
      member['Data ID'] = editDataID;
      member['Barangay'] = editHead['Barangay'];
      member['Sitio / Purok'] = editHead['Sitio / Purok'];
      member['Coordinate'] = editHead['Coordinate'];
      member['Coordinates'] = editHead['Coordinates'];
      
      if (!member['Submitted On']) {
          member['Submitted On'] = formattedDate;
      }
      
      member['Last Edited By'] = userFullName;
      member['Last Edit Date'] = formattedDate;
      member['Updated By'] = userFullName;
      member['Updated On'] = formattedDate;
    });

    // ADD DEBUG LOGGING HERE
    console.log('=== DEBUG: Sending update to server ===');
    console.log('Data ID:', editDataID);
    console.log('Head:', editHead);
    console.log('Members count:', editMembers.length);
    console.log('Members:', editMembers);
    console.log('=== END DEBUG ===');

    const fd = new FormData();
    fd.append('action','updateHousehold');
    fd.append('dataID', editDataID);
    fd.append('actor', userFullName);
    fd.append('head', JSON.stringify(editHead));
    fd.append('members', JSON.stringify(editMembers || []));
    fd.append('submittedBy', editHead['Submitted By'] || userFullName);
    fd.append('barangay', editHead['Barangay']);
    
    // CRITICAL: Add clearExisting flag to tell server to clear existing rows
    fd.append('clearExisting', 'true');
    
    // NEW: Add insertAtOriginalPosition flag to tell server to insert at correct position
    fd.append('insertAtOriginalPosition', 'true');

    // Set loading state AFTER validation
    if(btn){ btn.disabled = true; btn.innerText = 'Saving...'; }

    const res = await fetch(SCRIPT_URL, { 
      method: 'POST', 
      body: fd,
      timeout: 30000
    });
    
    if (!res.ok) {
      throw new Error(`Server responded with status: ${res.status}`);
    }
    
    const text = await res.text();
    let json;
    try { 
      json = JSON.parse(text); 
    } catch(e){ 
      throw new Error('Invalid server response format'); 
    }
    
    if(!json.success){ 
      alert('Save failed: ' + (json.message || JSON.stringify(json))); 
      console.error('Server error:', json); 
    }
    else {
      if(!silentReload) alert('Household updated (Data ID: ' + (editDataID||'') + ')');
      closeEditPanel();
      
      // Clear cache and reload
      localStorage.removeItem('recordsCache');
      localStorage.removeItem('recordsCacheTime');
      loadRecords();
    }
  } catch(err){
    console.error('Save error', err);
    alert('Error saving data: ' + err.message + '\nPlease check your connection and try again.');
  } finally {
    if(btn){ 
      btn.disabled = false; 
      btn.innerText = originalText || 'Save changes'; 
    }
  }
}

/* ============ DELETE FUNCTION ============ */
async function onDelete(id){
    if(!confirm("Delete household " + id + "?")) return;
    
    const currentUserFullName = getUserFullName();

    const fd = new FormData();
    fd.append("action", "deleteHousehold");
    fd.append("dataID", id);
    fd.append("actor", currentUserFullName);

    try{
        const res = await fetch(SCRIPT_URL, { method: "POST", body: fd });
        const json = await res.json();

        if(json.success){
            alert(`Data has been deleted. Data ID: ${id} from Master and Barangay`);
            localStorage.removeItem('recordsCache');
            localStorage.removeItem('recordsCacheTime');
            await loadRecords();
        } else {
            alert("Delete failed: " + (json.message || JSON.stringify(json)));
        }
    }catch(err){
        console.error("Delete error", err);
        alert("Delete failed ‚Äî see console");
    }
}

/* ============ SETUP CONTACT VALIDATION ============ */
function setupContactValidation() {
  // Head contact validation
  const editContactInput = $('edit_contactNo');
  const editContactError = $('edit_contactError');
  
  if (editContactInput) {
    editContactInput.addEventListener('input', function() {
      // Auto-format: remove non-numeric characters except + at the beginning
      let value = this.value.replace(/[^\d+]/g, '');
      
      // Ensure it starts with 09 or +639
      if (value.startsWith('+639') && value.length > 13) {
        value = value.substring(0, 13);
      } else if (value.startsWith('09') && value.length > 11) {
        value = value.substring(0, 11);
      }
      
      this.value = value;
      
      // Clear error on input
      this.classList.remove('input-error');
      if (editContactError) editContactError.style.display = 'none';
    });
    
    editContactInput.addEventListener('blur', function() {
      validateContactInput(this, editContactError);
    });
  }
  
  // Member contact validation
  const memberContactInput = $('memberContact');
  const memberContactError = $('memberContactError');
  
  if (memberContactInput) {
    memberContactInput.addEventListener('input', function() {
      // Auto-format: remove non-numeric characters except + at the beginning
      let value = this.value.replace(/[^\d+]/g, '');
      
      // Ensure it starts with 09 or +639
      if (value.startsWith('+639') && value.length > 13) {
        value = value.substring(0, 13);
      } else if (value.startsWith('09') && value.length > 11) {
        value = value.substring(0, 11);
      }
      
      this.value = value;
      
      // Clear error on input
      this.classList.remove('input-error');
      if (memberContactError) memberContactError.style.display = 'none';
    });
    
    memberContactInput.addEventListener('blur', function() {
      validateContactInput(this, memberContactError);
    });
  }
}

/* ============ WIRE EDIT PANEL UI ============ */
function wireEditPanelUI() {
  // Coordinate buttons
  if ($('edit_getLocationBtn')) {
    $('edit_getLocationBtn').addEventListener('click', getCurrentLocation);
  }
  
  if ($('edit_hazardHunterBtn')) {
    $('edit_hazardHunterBtn').addEventListener('click', openHazardHunterPicker);
  }

  // Coordinate modal buttons
  if ($('modal_getLocationBtn')) {
    $('modal_getLocationBtn').addEventListener('click', getCurrentLocationForModal);
  }
  
  if ($('modal_hazardHunterBtn')) {
    $('modal_hazardHunterBtn').addEventListener('click', openHazardHunterForModal);
  }
  
  if ($('modal_saveBtn')) {
    $('modal_saveBtn').addEventListener('click', saveCoordinateFromModal);
  }
  
  if ($('modal_cancelBtn')) {
    $('modal_cancelBtn').addEventListener('click', closeCoordinateModal);
  }

  // Setup contact validation
  setupContactValidation();

  // Add/Edit Members button
  if($('edit_addMember')) $('edit_addMember').addEventListener('click', ()=>{
    // Validate the head information first
    if (!validateEditPanelForMemberEditing()) {
      return;
    }
    
    // Collect head data to ensure it's saved
    collectHeadFromEditForm();
    
    // First, update the member count to reflect the new addition
    const currentCount = editMembers.length || 0;
    const newCount = currentCount + 1;
    
    // Update the member count input
    $('edit_memberCount').value = newCount;
    
    // Create a new empty member and add it to the array
    const newMember = createEmptyMember();
    editMembers.push(newMember);
    
    // Update the preview to show the new member
    updateEditMembersPreview();
    
    // Open the member panel for editing the new member
    memberEditIndex = editMembers.length - 1;
    openMemberPanelForEdit(memberEditIndex);
  });

  // Remove Member button
  if($('edit_removeMember')) $('edit_removeMember').addEventListener('click', ()=>{
    if (editMembers.length === 0) {
      alert('No members to remove.');
      return;
    }
    
    // Show a list of members to remove
    const memberList = editMembers.map((m, i) => 
      `${i+1}. ${m['Name of Household Member/s'] || 'Unnamed Member'}`
    ).join('\n');
    
    const memberIndex = prompt(
      `Enter the number of the member to remove (1-${editMembers.length}):\n\n${memberList}`
    );
    
    const index = parseInt(memberIndex) - 1;
    
    if (index >= 0 && index < editMembers.length) {
      if (confirm(`Remove member "${editMembers[index]['Name of Household Member/s'] || 'Unnamed Member'}"?`)) {
        editMembers.splice(index, 1);
        
        // Update member count
        $('edit_memberCount').value = editMembers.length;
        
        updateEditMembersPreview();
        alert('Member removed.');
      }
    } else if (memberIndex !== null) {
      alert('Invalid member number.');
    }
  });

  // Member panel navigation
  if($('memberNext')) $('memberNext').addEventListener('click', memberPanelNext);
  if($('memberBack')) $('memberBack').addEventListener('click', memberPanelBack);
  
  if($('memberPanelClose')) $('memberPanelClose').addEventListener('click', ()=> {
    if(confirm('Close member entry? Unsaved member edits will be kept in panel preview.')) { 
        $('memberPanel')?.classList.remove('open'); 
        updateEditMembersPreview(); 
    }
  });
  
  // Date change handlers
  if($('memberBirthdate')) $('memberBirthdate').addEventListener('change', updateMemberAgeStage);
  if($('edit_householdBirthdate')) $('edit_householdBirthdate').addEventListener('change', updateEditHeadAgeStage);
  
  // Member count change handler
  if ($('edit_memberCount')) {
    $('edit_memberCount').addEventListener('change', function() {
      const newCount = parseInt(this.value) || 0;
      const currentCount = editMembers.length;
      
      if (newCount < currentCount) {
        // Remove extra members
        if (confirm(`Reduce members from ${currentCount} to ${newCount}? This will remove the last ${currentCount - newCount} member(s).`)) {
          editMembers = editMembers.slice(0, newCount);
          updateEditMembersPreview();
        } else {
          this.value = currentCount;
        }
      } else if (newCount > currentCount) {
        // Add empty members
        const toAdd = newCount - currentCount;
        for (let i = 0; i < toAdd; i++) {
          editMembers.push(createEmptyMember());
        }
        updateEditMembersPreview();
      }
    });
  }

  // Cancel buttons
  if($('cancelEditBtn')) $('cancelEditBtn').addEventListener('click', ()=> { 
    if(confirm('Discard ALL changes and close? This includes both head and member changes.')) {
      closeEditPanel();
    }
  });

  if($('panelClose')) $('panelClose').addEventListener('click', ()=> { 
    if(confirm('Discard ALL changes and close? This includes both head and member changes.')) {
      closeEditPanel();
    }
  });

  if($('panelOverlay')) $('panelOverlay').addEventListener('click', ()=>{
    if($('memberPanel')?.classList.contains('open')) {
      if(confirm('Close member panel? Unsaved member changes will be lost.')) {
        $('memberPanel')?.classList.remove('open');
      }
      return;
    }
    if(confirm('Close edit panel? ALL unsaved changes will be lost.')) {
      closeEditPanel();
    }
  });

  // Start sequence button
  if($('startSequenceBtn')) $('startSequenceBtn').addEventListener('click', (ev)=> {
    ev.preventDefault();
    
    // Validate ALL head required fields first
    const requiredFields = [
      { id: 'edit_barangay', name: 'Barangay' },
      { id: 'edit_sitio', name: 'Sitio/Purok' },
      { id: 'edit_householdHead', name: 'Household Head Name' },
      { id: 'edit_contactNo', name: 'Contact Number' },
      { id: 'edit_householdBirthdate', name: 'Birthdate' }
    ];
    
    for (const field of requiredFields) {
      const element = $(field.id);
      if (!element || !element.value.trim()) {
        alert(`Please fill in ${field.name}`);
        element?.focus();
        return;
      }
    }
    
    // Validate contact number
    if (!validateContactInput($('edit_contactNo'), $('edit_contactError'))) {
      alert('Please enter a valid Philippine mobile number for the household head');
      $('edit_contactNo').focus();
      return;
    }
    
    // Check if sex is selected
    const headSex = document.querySelector("input[name='edit_head_sex']:checked")?.value;
    if (!headSex) {
      alert('Please select head sex');
      qAll("input[name='edit_head_sex']")[0]?.focus();
      return;
    }
    
    collectHeadFromEditForm();
    const expected = Number($('edit_memberCount')?.value || 0);
    
    // Ensure we have the right number of members
    while(editMembers.length < expected) editMembers.push(createEmptyMember());
    if (expected === 0) {
        // No members, just save
        saveEditedHousehold(true);
        return;
    }
    
    // Start member sequence
    sequenceMode = true; 
    memberEditIndex = 0; 
    openMemberPanelForEdit(memberEditIndex);
  });

  // Save edit button - FIXED VERSION
  if($('saveEditBtn')) $('saveEditBtn').addEventListener('click', async (ev)=> { 
    ev.preventDefault(); 
    
    const btn = $('saveEditBtn');
    const originalBtnText = btn ? btn.innerText : 'Save changes';
    
    // Validate head data
    const requiredFields = [
      { id: 'edit_barangay', name: 'Barangay' },
      { id: 'edit_sitio', name: 'Sitio/Purok' },
      { id: 'edit_householdHead', name: 'Household Head Name' },
      { id: 'edit_contactNo', name: 'Contact Number' },
      { id: 'edit_householdBirthdate', name: 'Birthdate' }
    ];
    
    for (const field of requiredFields) {
      const element = $(field.id);
      if (!element || !element.value.trim()) {
        alert(`Please fill in ${field.name}`);
        element?.focus();
        return;
      }
    }
    
    // Validate contact number
    if (!validateContactInput($('edit_contactNo'), $('edit_contactError'))) {
      alert('Please enter a valid Philippine mobile number for the household head');
      $('edit_contactNo').focus();
      return;
    }
    
    // Check if sex is selected
    const headSex = document.querySelector("input[name='edit_head_sex']:checked")?.value;
    if (!headSex) {
      alert('Please select head sex');
      qAll("input[name='edit_head_sex']")[0]?.focus();
      return;
    }
    
    // Validate all members if there are any
    if (editMembers.length > 0) {
      const invalidMembers = [];
      editMembers.forEach((member, index) => {
        if (!member['Name of Household Member/s'] || !member['Name of Household Member/s'].trim()) {
          invalidMembers.push(index + 1);
        }
      });
      
      if (invalidMembers.length > 0) {
        if (confirm(`Members #${invalidMembers.join(', ')} are missing names. Save anyway?`)) {
          // Set loading state
          if(btn){ btn.disabled = true; btn.innerText = 'Saving...'; }
          try {
            await saveEditedHousehold(false);
          } finally {
            if(btn){ 
              btn.disabled = false; 
              btn.innerText = originalBtnText; 
            }
          }
        }
        return;
      }
    }
    
    // Set loading state
    if(btn){ btn.disabled = true; btn.innerText = 'Saving...'; }
    try {
      await saveEditedHousehold(false);
    } finally {
      if(btn){ 
        btn.disabled = false; 
        btn.innerText = originalBtnText; 
      }
    }
  });
}

/* ============ EXPORT ============ */
function exportAll(){ 
    exportCSV(filteredGroups); 
}

function exportSelected(){
    const arr = filteredGroups.filter(g => selected.has(g.dataID));
    if(!arr.length) return alert("No selected rows");
    exportCSV(arr);
}

function exportCSV(list){
    const cols = header.slice();
    const lines = [];
    lines.push(cols.map(c => `"${c.replace(/"/g,'""')}"`).join(","));
    
    list.forEach(g=>{
        lines.push(cols.map(c => `"${(g.head[c]||"").toString().replace(/"/g,'""')}"`).join(","));
        (g.members || []).forEach(m => {
            lines.push(cols.map(c => `"${(m[c]||"").toString().replace(/"/g,'""')}"`).join(","));
        });
    });
    
    const blob = new Blob([lines.join("\r\n")], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); 
    a.href = url; 
    a.download = "records.csv"; 
    a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 500);
}

/* ============ SIDEBAR COLLAPSE ============ */
function toggleSidebar() {
    const pageContainer = document.querySelector('.page-container');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const icon = sidebarToggle.querySelector('i');
    
    pageContainer.classList.toggle('collapsed');
    
    if (pageContainer.classList.contains('collapsed')) {
        icon.className = 'fas fa-chevron-right';
        sidebarToggle.title = "Expand sidebar";
    } else {
        icon.className = 'fas fa-bars';
        sidebarToggle.title = "Collapse sidebar";
    }
}

/* ============ MOBILE SIDEBAR TOGGLE ============ */
function toggleMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    const icon = mobileToggle.querySelector('i');
    
    sidebar.classList.toggle('mobile-open');
    
    if (sidebar.classList.contains('mobile-open')) {
        icon.className = 'fas fa-times';
        mobileToggle.title = "Close menu";
    } else {
        icon.className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
}

/* ============ CLOSE MOBILE SIDEBAR ON CLICK OUTSIDE ============ */
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    
    if (window.innerWidth <= 768) {
        if (!sidebar.contains(event.target) && !mobileToggle.contains(event.target) && sidebar.classList.contains('mobile-open')) {
            sidebar.classList.remove('mobile-open');
            mobileToggle.querySelector('i').className = 'fas fa-bars';
            mobileToggle.title = "Open menu";
        }
    }
});

/* ============ UI BINDINGS ============ */
document.getElementById("refreshBtn").onclick = function() {
    localStorage.removeItem('recordsCache');
    localStorage.removeItem('recordsCacheTime');
    loadRecords();
};

// Client-side filtering for search and barangay dropdown
document.getElementById("filterBarangay").onchange = filterRecords;

// Real-time search filtering
document.getElementById("searchInput").addEventListener("input", filterRecords);

// Export dropdown toggle
document.getElementById("exportBtn").onclick = (e) => {
    e.stopPropagation();
    document.getElementById("exportDropdown").classList.toggle("hidden");
};

// Close dropdown when clicking outside
document.addEventListener("click", (e) => {
    const dropdown = document.getElementById("exportDropdown");
    const btn = document.getElementById("exportBtn");
    
    if(!btn.contains(e.target) && !dropdown.contains(e.target)){
        dropdown.classList.add("hidden");
    }
});

// Desktop sidebar toggle
document.getElementById('sidebarToggle').onclick = toggleSidebar;

// Mobile sidebar toggle
document.getElementById('mobileMenuToggle').onclick = toggleMobileSidebar;

// Logout button event listener
document.getElementById('logoutBtn').addEventListener('click', handleLogout);

/* ============ WINDOW RESIZE HANDLER ============ */
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        const sidebar = document.getElementById('sidebar');
        const mobileToggle = document.getElementById('mobileMenuToggle');
        
        sidebar.classList.remove('mobile-open');
        mobileToggle.querySelector('i').className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
});

/* ============ PREVENT BACK BUTTON ISSUES ============ */
window.addEventListener('pageshow', function(event) {
  if (event.persisted) {
    console.log('Page loaded from cache, checking session...');
    
    sessionCheck().then(isAuthenticated => {
      if (isAuthenticated) {
        loadRecords();
      }
    });
  }
});

/* ============ CHECK RETURN FROM HAZARD HUNTER ============ */
function checkReturnFromHazardHunter() {
    window.addEventListener('pageshow', (event) => {
        if (sessionStorage.getItem('awaitingCoordinates') === 'true') {
            // User returned from Hazard Hunter
            setTimeout(() => {
                const coordInput = $('edit_coordinate');
                if (coordInput && !coordInput.value.trim()) {
                    alert("Paste your Hazard Hunter coordinates (Ctrl+V) in the coordinate field.");
                }
            }, 1000);
            sessionStorage.removeItem('awaitingCoordinates');
        }
        
        // Restore form data if we have it
        const tempData = sessionStorage.getItem('tempFormData');
        if (tempData) {
            try {
                const data = JSON.parse(tempData);
                if (data.barangay) $('edit_barangay').value = data.barangay;
                if (data.sitio) $('edit_sitio').value = data.sitio;
                if (data.householdHead) $('edit_householdHead').value = data.householdHead;
                if (data.contactNo) $('edit_contactNo').value = data.contactNo;
                sessionStorage.removeItem('tempFormData');
            } catch (e) {
                console.error("Error restoring form data:", e);
            }
        }
    });
}

/* ============ INIT ============ */
window.addEventListener("DOMContentLoaded", async () => {
  // First check session
  const isAuthenticated = await sessionCheck();
  
  if (isAuthenticated) {
    // Load data if authenticated
    const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
    // Remove üë§ emoji from user display
    document.getElementById("userName").innerText = userName;
    
    // Check if user is admin
    const isAdmin = localStorage.getItem("userRole") === "admin";
    const adminItems = document.querySelectorAll(".admin-only");
    adminItems.forEach(item => {
        item.style.display = isAdmin ? "block" : "none";
    });
    
    // Check screen width and adjust sidebar
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.remove('mobile-open');
    }
    
    // Setup conditional fields
    setupEditConditionalFields();
    
    // Wire edit panel UI
    wireEditPanelUI();
    
    // Setup coordinate modal close on overlay click
    $('coordinateModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeCoordinateModal();
      }
    });
    
    // Check if returning from Hazard Hunter
    checkReturnFromHazardHunter();
    
    loadRecords();
  }
});
</script>
<script src="session-manager.js"></script>
<script src="common-session.js"></script>
<script src="activity-tracking-final.js"></script>
</body>
</html>
