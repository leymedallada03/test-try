<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MDRRMO Records</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
<div class="page-container">
  <header class="topbar">
    <button id="menuToggle" class="menu-btn">‚ò∞</button>
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="logo"/>
      <div>
        <div class="title">PUROK KALIGTASAN</div>
        <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
      </div>
    </div>
    <div class="user-info">
      <span id="userName"></span>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <ul>
      <li><a href="dashboard.html">üìä Dashboard</a></li>
      <li><a href="dataForm.html">üìù Data Entry</a></li>
      <li><a href="records.html" class="active">üìÅ Records</a></li>
      <li><a href="charts.html">üìà Charts</a></li>
      <li class="admin-only"><a href="users.html">üë• User Management</a></li>
    </ul>
  </aside>

  <div id="loading">Loading records...</div>

  <!-- MAIN CONTENT -->
  <main class="content-area">
    <h2>üìÅ Household Records</h2>

    <!-- GLOBAL SEARCH -->
    <div class="search-container">
      <input id="searchInput" type="text" placeholder="Search by Barangay / Name / Data ID...">
    </div>
      <button onclick="loadRecords()" class="actions-btn view-btn">Refresh</button>

    <!-- FILTER BAR -->
    <div class="records-container">
      <div class="filter-bar">

        <select id="filterBarangay">
          <option value="">All Barangays</option>
          <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
          <option>Dalipit East</option><option>Dalipit West</option><option>Dominador East</option>
          <option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
          <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option>
          <option>Ping-As</option><option>Poblacion East</option><option>Poblacion West</option>
          <option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
        </select>
        <button onclick="loadRecords()" class="actions-btn view-btn">Refresh</button>
      </div>

<div class="records-wrapper">
    <table id="recordsTable" class="records-table">
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>

    <!-- Pagination buttons will appear here -->
    <div id="paginationArea"></div>
</div>
    </div>

<script>
const scriptURL = 
  "https://script.google.com/macros/s/AKfycbxWs1kxkyleYw6qcQlIx1xsecQS8x2O-nyXxbcdcm5DVst6IcmDKR-NmzSgBxyH7ErvpA/exec";

// PAGINATION
let allRows = [];
let currentHeader = [];
let currentPage = 1;
let rowsPerPage = 25;

// AUTO LOAD
window.onload = () => {
  loadRecords();

  // live search
  let typingTimer;
  document.getElementById("searchInput").addEventListener("input", () => {
    clearTimeout(typingTimer);
    typingTimer = setTimeout(loadRecords, 300);
  });
};

function showLoading(show) {
  document.getElementById("loading").style.display = show ? "flex" : "none";
}

// ----------------------------------------------
// LOAD DATA (JSONP)
// ----------------------------------------------
function loadRecords() {
  showLoading(true);

  const filterBarangay = encodeURIComponent(
    document.getElementById("filterBarangay").value
  );
  const filterStage = ""; // not used
  const q = encodeURIComponent(document.getElementById("searchInput").value);

  const callbackName = "recordsLoaded_" + Date.now();
  window[callbackName] = recordsLoaded;

  const url =
    `${scriptURL}?action=getRecords&filterBarangay=${filterBarangay}` +
    `&filterStage=${filterStage}&q=${q}&callback=${callbackName}`;

  const s = document.createElement("script");
  s.src = url;

  s.onload = () => s.remove();
  s.onerror = () => {
    alert("Error loading records (JSONP failed)");
    showLoading(false);
  };

  document.body.appendChild(s);
}

// ----------------------------------------------
// JSONP CALLBACK
// ----------------------------------------------
function recordsLoaded(response) {
  if (!response || !response.success) {
    alert("Failed to load records");
    showLoading(false);
    return;
  }

  currentHeader = response.header;
  allRows = response.rows;
  currentPage = 1;

  renderPage();
  renderPagination();

  showLoading(false);
}

// ----------------------------------------------
// PAGINATION HELPERS
// ----------------------------------------------
function getPagedRows() {
  const start = (currentPage - 1) * rowsPerPage;
  return allRows.slice(start, start + rowsPerPage);
}

function changePage(p) {
  const totalPages = Math.ceil(allRows.length / rowsPerPage);
  if (p < 1 || p > totalPages) return;
  currentPage = p;
  renderPage();
  renderPagination();
}

// ----------------------------------------------
// HIGHLIGHT SEARCH
// ----------------------------------------------
function highlightText(text, keyword) {
  if (!keyword) return text;
  keyword = keyword.replace(/[-/\\^$*+?.()|[\]{}]/g, "\\$&");
  const regex = new RegExp(`(${keyword})`, "gi");
  return text.replace(regex, `<span class="hl">$1</span>`);
}

// ----------------------------------------------
// RENDER PAGE
// ----------------------------------------------
function renderPage() {
  const tbody = document.getElementById("tableBody");
  const thead = document.getElementById("tableHead");
  const keyword = document.getElementById("searchInput").value.trim();

  tbody.innerHTML = "";
  thead.innerHTML = "";

  // HEADER
  let h = "<tr>";
  currentHeader.forEach(col => (h += `<th>${col}</th>`));
  h += `<th>Actions</th></tr>`;
  thead.innerHTML = h;

  // ROWS
  const rows = getPagedRows();
  rows.forEach(r => {
    let row = "<tr>";
    currentHeader.forEach(col => {
      let val = r[col] ?? "";
      val = highlightText(String(val), keyword);
      row += `<td>${val}</td>`;
    });

    row += `
      <td>
        <button class="icon-btn" onclick="editRecord('${r["Data ID"]}')">‚úèÔ∏è</button>
        <button class="icon-btn" onclick="deleteRecord('${r["Data ID"]}')">üóëÔ∏è</button>
      </td>`;
    row += "</tr>";

    tbody.innerHTML += row;
  });
}

// ----------------------------------------------
// PAGINATION BUTTONS
// ----------------------------------------------
function renderPagination() {
  const div = document.getElementById("paginationArea");
  if (!div) return;

  const totalPages = Math.ceil(allRows.length / rowsPerPage);
  if (totalPages <= 1) {
    div.innerHTML = "";
    return;
  }

  let html = `<button class="page-btn" onclick="changePage(${currentPage - 1})">‚¨Ö Prev</button>`;

  for (let i = 1; i <= totalPages; i++) {
    html += `<button class="page-btn ${i === currentPage ? "active" : ""}" onclick="changePage(${i})">${i}</button>`;
  }

  html += `<button class="page-btn" onclick="changePage(${currentPage + 1})">Next ‚û°</button>`;
  div.innerHTML = html;
}

// ----------------------------------------------
// ACTIONS
// ----------------------------------------------
function editRecord(dataID) {
  localStorage.setItem("edit_dataID", dataID);
  window.location.href = "edit.html";
}

async function deleteRecord(dataID) {
  if (!confirm("Delete household " + dataID + "?")) return;

  const body = { action: "deleteHousehold", dataID };

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = JSON.parse(await res.text());
    alert(data.message);

    loadRecords();
  } catch (err) {
    alert("Delete failed");
  }
}
</script>

<style>
/* HIGHLIGHT STYLE */
.hl {
  background: yellow;
  padding: 1px 2px;
}

/* PAGINATION STYLES */
#paginationArea {
  margin-top: 12px;
  text-align: center;
}
.page-btn {
  padding: 6px 12px;
  margin: 0 3px;
  border: 1px solid #888;
  background: #fff;
  cursor: pointer;
  border-radius: 6px;
}
.page-btn.active {
  background: #007bff;
  color: #fff;
  font-weight: bold;
}
</style>

</body>
</html>



