<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan ‚Äî Household Records</title>
<link rel="stylesheet" href="styles.css"/>

<style>
/* Highlight for search results */
.hl {
  background: #ffeb8a;
  padding: 1px 2px;
  border-radius: 4px;
}

/* Export dropdown */
.export-wrapper { position:relative; }
.export-dropdown {
  position:absolute;
  top:45px;
  right:0;
  background:white;
  border:1px solid #ddd;
  border-radius:10px;
  width:170px;
  padding:6px 0;
  box-shadow:0 4px 18px rgba(0,0,0,0.12);
  z-index:999;
}
.export-dropdown div { padding:10px 14px; cursor:pointer; }
.export-dropdown div:hover { background:#e9fff0; }

.hidden { display:none; }

/* Table fix */
.records-wrapper {
  margin-top: 14px;
  background: rgba(255,255,255,0.85);
  border-radius: 12px;
  box-shadow: 0 8px 22px rgba(6,30,20,0.06);
  overflow-x: auto;
}

.records-table {
  width: 100%;
  min-width: 1500px;
  border-collapse: collapse;
}

.records-table th,
.records-table td {
  padding: 8px 10px;
  font-size: 13px;
  border-bottom: 1px solid rgba(15,122,74,0.15);
  background: rgba(255,255,255,0.6);
}

.records-table th {
  background: rgba(15,122,74,0.10);
  font-weight: 800;
  position: sticky;
  top: 0;
  z-index: 5;
}

.records-table tbody tr:hover {
  background: rgba(52,183,143,0.06);
}

/* Sticky select + actions columns */
.select-col {
  position: sticky;
  left: 0;
  background: rgba(255,255,255,0.9);
  z-index: 6;
}

.actions-col {
  position: sticky;
  right: 0;
  background: rgba(255,255,255,0.9);
  z-index: 6;
}

/* Legend card */
.legend-card {
  margin-top: 18px;
  padding: 14px;
  width: fit-content;
  background: rgba(255,255,255,0.9);
  border-radius: 12px;
  box-shadow: 0 4px 14px rgba(6,30,20,0.08);
  border:1px solid rgba(6,30,20,0.06);
}

.legend-card div {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 4px 0;
  font-size:14px;
}

.legend-swatch {
  width: 16px;
  height: 16px;
  border-radius:4px;
}

</style>
</head>


<body>
<div class="page-container">

<!-- Topbar -->
<header class="topbar">
  <button id="menuToggle" class="menu-btn">‚ò∞</button>

  <div class="brand">
    <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
    <div>
      <div class="title">PUROK KALIGTASAN</div>
      <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
    </div>
  </div>

  <div class="user-info">
    <span id="userName"></span>
    <button id="logoutBtn" class="logout-btn">Logout</button>
  </div>
</header>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
<ul>
  <li><a href="dashboard.html">üìä Dashboard</a></li>
  <li><a href="dataForm.html">üìù Data Entry</a></li>
  <li><a class="active" href="records.html">üìÅ Records</a></li>
  <li><a href="charts.html">üìà Charts</a></li>
  <li class="admin-only"><a href="users.html">üë• User Management</a></li>
</ul>
</aside>

<!-- Main Content -->
<main class="content-area">

<h2>üìÅ Household Records</h2>

<!-- Counters -->
<div style="display:flex; gap:20px; justify-content:flex-end; margin-bottom:10px;">
  <span>Rows: <strong class="green" id="rowCount">0</strong></span>
  <span>Matches: <strong class="green" id="matchCount">0</strong></span>
  <span>Selected: <strong class="green" id="selectedCount">0</strong></span>
</div>

<!-- Search + Filters -->
<div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
  <input id="searchInput" class="search-box" placeholder="Search by Name / Barangay / ID..."/>
  <select id="filterBarangay" class="search-box" style="max-width:260px;">
    <option value="">All Barangays</option>
    <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
    <option>Dalipit East</option><option>Dalipit West</option>
    <option>Dominador East</option><option>Dominador West</option>
    <option>Munlawin Sur</option><option>Munlawin Norte</option>
    <option>Muzon Primero</option><option>Muzon Segundo</option>
    <option>Pinagkurusan</option><option>Ping-As</option>
    <option>Poblacion East</option><option>Poblacion West</option>
    <option>San Jose</option><option>San Juan</option>
    <option>Santa Cruz</option><option>Tadlac</option>
  </select>

  <button id="refreshBtn" class="btn">üîÑ Refresh</button>

  <div class="export-wrapper">
    <button id="exportBtn" class="btn secondary" style="background:white; color:#0f7a4a;">üì§ Export ‚ñº</button>
    <div id="exportDropdown" class="export-dropdown hidden">
      <div onclick="exportAll()">Export All</div>
      <div onclick="exportSelected()">Export Selected</div>
    </div>
  </div>
</div>

<!-- Table Area -->
<div class="records-wrapper">
  <table id="recordsTable" class="records-table">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- Legend -->
<div class="legend-card">
  <div><div class="legend-swatch" style="background:#cfefff"></div>1 Member</div>
  <div><div class="legend-swatch" style="background:#d5f8d5"></div>2‚Äì4 Members</div>
  <div><div class="legend-swatch" style="background:#fff3c2"></div>5‚Äì7 Members</div>
  <div><div class="legend-swatch" style="background:#ffd2d2"></div>8+ Members</div>
</div>

<!-- Pagination -->
<div id="paginationArea" style="text-align:center; margin-top:18px;"></div>

</main>
</div>

<!-- Loading -->
<div id="loading" style="display:none; position:fixed; inset:0; background:rgba(255,255,255,0.7); align-items:center; justify-content:center; z-index:9999;">
  <div style="padding:15px; background:white; border-radius:10px; box-shadow:0 5px 20px rgba(0,0,0,0.1);">
    Loading records‚Ä¶
  </div>
</div>


<script>
/* ============================================================
   CONFIG
============================================================ */
const SCRIPT_URL = "YOUR_SCRIPT_URL_HERE"; /* <-- replace */

/* ============================================================
   STATE
============================================================ */
let header = [];
let rawRows = [];
let groups = [];
let selected = new Set();
let currentPage = 1;
const rowsPerPage = 20;

/* ============================================================
   UTIL UTIL
============================================================ */
function showLoading(x){
  document.getElementById("loading").style.display = x ? "flex":"none";
}

function highlight(text, q){
  text = String(text ?? "");
  if(!q) return text;
  const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");
  return text.replace(re, m => `<span class="hl">${m}</span>`);
}

/* ============================================================
   LOAD RECORDS
============================================================ */
async function loadRecords(){
  showLoading(true);

  try{
    const barangay = document.getElementById("filterBarangay").value;
    const q = document.getElementById("searchInput").value;

    const url = `${SCRIPT_URL}?action=getRecords&filterBarangay=${encodeURIComponent(barangay)}&q=${encodeURIComponent(q)}`;

    const res = await fetch(url);
    const data = await res.json();

    if(!data.success){
      alert("Failed to load records");
      return;
    }

    header = data.header;
    rawRows = data.rows;

    groupData();
    currentPage = 1;
    renderTable();
    renderPagination();
    updateCounts();

  }catch(err){
    console.error(err);
  }

  showLoading(false);
}

/* ============================================================
   GROUP BY ID
============================================================ */
function groupData(){
  let map = {};

  rawRows.forEach(r=>{
    let id = String(r["Data ID"]);
    if(!map[id]) map[id] = { head:null, members:[], dataID:id };

    if(!r["Name of Household Member/s"]) map[id].head = r;
    else map[id].members.push(r);
  });

  groups = Object.values(map).sort((a,b)=>Number(a.dataID)-Number(b.dataID));
}

/* ============================================================
   RENDER TABLE
============================================================ */
function renderTable(){
  const thead = document.getElementById("tableHead");
  const tbody = document.getElementById("tableBody");

  thead.innerHTML = "";
  tbody.innerHTML = "";

  const q = document.getElementById("searchInput").value;

  let th = `<tr>
    <th class="select-col"><input type="checkbox" id="selectAll"></th>
  `;

  header.forEach(h => th += `<th>${h}</th>`);
  th += `<th class="actions-col">Actions</th></tr>`;

  thead.innerHTML = th;

  const start = (currentPage-1)*rowsPerPage;
  const slice = groups.slice(start,start+rowsPerPage);

  slice.forEach(g=>{
    const h = g.head || {};
    const memCount = g.members.length;

    let tr = document.createElement("tr");

    let tdSel = document.createElement("td");
    tdSel.className = "select-col";
    tdSel.innerHTML = `<input type="checkbox" class="row-select" data-id="${g.dataID}" ${selected.has(g.dataID)?"checked":""}>`;
    tr.appendChild(tdSel);

    header.forEach(col=>{
      let td = document.createElement("td");
      td.innerHTML = highlight(h[col] || "", q);
      tr.appendChild(td);
    });

    let actions = document.createElement("td");
    actions.className = "actions-col";
    actions.innerHTML = `
      <button onclick="toggleMembers('${g.dataID}')">üëÅ (${memCount})</button>
      <button onclick="onEdit('${g.dataID}')">‚úèÔ∏è</button>
      <button onclick="onDelete('${g.dataID}')">üóë</button>
    `;
    tr.appendChild(actions);

    tbody.appendChild(tr);

    g.members.forEach(m=>{
      let mr = document.createElement("tr");
      mr.className = "member-row hidden";
      mr.dataset.parent = g.dataID;

      mr.innerHTML = `<td></td>`; /* Empty select column */

      header.forEach(col=>{
        mr.innerHTML += `<td>${highlight(m[col]||"", q)}</td>`;
      });

      mr.innerHTML += `<td></td>`; /* actions empty */

      tbody.appendChild(mr);
    });
  });

  document.getElementById("selectAll").onchange = function(){
    slice.forEach(g=>{
      this.checked ? selected.add(g.dataID) : selected.delete(g.dataID);
    });
    renderTable();
  };

  document.querySelectorAll(".row-select").forEach(cb=>{
    cb.onchange = function(){
      const id = this.dataset.id;
      this.checked ? selected.add(id) : selected.delete(id);
      updateCounts();
    };
  });
}

/* TOGGLE MEMBERS */
function toggleMembers(id){
  document.querySelectorAll(`tr.member-row[data-parent="${id}"]`)
    .forEach(r => r.classList.toggle("hidden"));
}

/* PAGINATION */
function renderPagination(){
  let total = Math.ceil(groups.length/rowsPerPage);
  let div = document.getElementById("paginationArea");
  if(total<=1){ div.innerHTML=""; return; }

  let html="";
  for(let i=1;i<=total;i++){
    html += `<button onclick="gotoPage(${i})" class="${i===currentPage?"btn":"btn secondary"}" style="margin:2px;">${i}</button>`;
  }
  div.innerHTML = html;
}
function gotoPage(p){
  currentPage=p;
  renderTable();
  renderPagination();
}

/* COUNTS */
function updateCounts(){
  document.getElementById("rowCount").innerText = groups.length;
  document.getElementById("matchCount").innerText = groups.length;
  document.getElementById("selectedCount").innerText = selected.size;
}

/* EDIT */
function onEdit(id){
  localStorage.setItem("edit_dataID", id);
  location.href="edit.html";
}

/* DELETE */
async function onDelete(id){
  if(!confirm("Delete household " + id + "?")) return;

  let fd = new FormData();
  fd.append("action","deleteHousehold");
  fd.append("dataID", id);

  const res = await fetch(SCRIPT_URL, {method:"POST", body:fd});
  const json = await res.json();

  if(json.success){
    alert("Deleted");
    loadRecords();
  } else {
    alert("Delete failed");
  }
}

/* EXPORT */
function exportAll(){ exportCSV(groups); }
function exportSelected(){
  let list = groups.filter(g=>selected.has(g.dataID));
  if(!list.length){ alert("No selected rows"); return; }
  exportCSV(list);
}

function exportCSV(list){
  let cols = header;
  let lines = [];
  lines.push(cols.join(","));

  list.forEach(g=>{
    let h = g.head;
    lines.push(cols.map(c => `"${(h[c]||"").replace(/"/g,'""')}"`).join(","));

    g.members.forEach(m=>{
      lines.push(cols.map(c => `"${(m[c]||"").replace(/"/g,'""')}"`).join(","));
    });
  });

  let blob = new Blob([lines.join("\r\n")],{type:"text/csv"});
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href=url;
  a.download="records.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* BINDINGS */
document.getElementById("refreshBtn").onclick = loadRecords;
document.getElementById("filterBarangay").onchange = loadRecords;
document.getElementById("searchInput").oninput = () => setTimeout(loadRecords,250);

document.getElementById("exportBtn").onclick = ()=>{
  document.getElementById("exportDropdown").classList.toggle("hidden");
};

document.addEventListener("click",e=>{
  let d = document.getElementById("exportDropdown");
  let b = document.getElementById("exportBtn");
  if(!b.contains(e.target) && !d.contains(e.target)){
    d.classList.add("hidden");
  }
});

/* INIT */
window.onload = function(){
  document.getElementById("userName").innerText = localStorage.getItem("staffName") || "";
  loadRecords();
};
</script>

</body>
</html>
