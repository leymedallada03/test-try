<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Records & Management — Purok Kaligtasans</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="css/uniform-styles.css">
<style>
   /* ORIGINAL RECORDS STYLES */
   :root{
    --bg:#f6f8f7;
    --card-bg:#fff;
    --muted:#6b6f6b;
    --accent1:#0f7a4a;
    --accent2:#34b78f;
    --accent3: #ff7a00;
    --accent4: #ffa500;
    --hazard-red: #dc2626;
    --hazard-orange: #ef4444;
    --light-green: #e9f7f2;
    --border: #e1e8e5;
    --shadow: 0 6px 18px rgba(6,30,20,0.06);
    --shadow-dark: 0 6px 20px rgba(5,40,25,0.12);
    --radius:12px;
    --radius-sm:8px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
   }
   /* Add to your existing CSS */
.loading-spinner-small {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  display: inline-block;
  margin-left: 8px;
  vertical-align: middle;
}

/* Make sure buttons with loading state have proper alignment */
.btn .loading-spinner-small {
  margin-left: 8px;
  margin-right: 0;
}

/* Disabled button styling */
.btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none !important;
}

.btn:disabled:hover {
  transform: none !important;
  box-shadow: none !important;
}
      .btn.secondary {
     background: transparent;
     color: #fff;
   }
   
   /* Background decorative elements */
   .bg-pattern {
     position: absolute;
     width: 100%;
     height: 100%;
     overflow: hidden;
     z-index: -1;
   }
   
   .bg-circle {
     position: absolute;
     border-radius: 50%;
     background: rgba(15, 122, 74, 0.05);
   }
   
   .circle-1 {
     width: 300px;
     height: 300px;
     top: -150px;
     right: -150px;
   }
   
   .circle-2 {
     width: 200px;
     height: 200px;
     bottom: -100px;
     left: -100px;
     background: rgba(255, 122, 0, 0.05);
   }
   
   .circle-3 {
     width: 150px;
     height: 150px;
     top: 50%;
     left: 10%;
     background: rgba(52, 183, 143, 0.05);
   }
   /* Mobile Bottom Navigation - Fixed Position */
.mobile-bottom-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid var(--border);
    z-index: 1000;
    padding: 8px 0;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
    height: 70px;
    box-sizing: border-box;
    overflow: hidden;
}

.mobile-nav-items {
    display: flex;
    justify-content: space-around;
    align-items: center;
    height: 100%;
}

.mobile-nav-item {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    text-decoration: none !important;
    color: var(--muted) !important;
    padding: 8px 12px !important;
    border-radius: var(--radius-sm) !important;
    transition: all 0.3s ease !important;
    min-width: 60px !important;
    flex: 1 !important;
    height: 100% !important;
    justify-content: center !important;
}

/* Admin items - initially hidden */
.mobile-nav-item.admin-only {
    display: none !important;
}

/* Show admin items when user is admin */
.mobile-nav-item.admin-only.admin-visible {
    display: flex !important;
}

/* Active state for all tabs */
.mobile-nav-item.active {
    color: var(--accent1) !important;
    background: var(--light-green) !important;
}

/* Icon and text for all tabs */
.mobile-nav-icon {
    font-size: 1.2rem !important;
    margin-bottom: 4px !important;
    display: block !important;
    text-align: center !important;
    width: 100% !important;
}

.mobile-nav-text {
    font-size: 0.7rem !important;
    font-weight: 500 !important;
    display: block !important;
    text-align: center !important;
    width: 100% !important;
}
/* ============ FIELD-LEVEL VALIDATION STYLES ============ */
.validation-summary {
    background-color: rgba(220, 38, 38, 0.1);
    border: 0.5px solid rgba(220, 38, 38, 0.3);
    border-radius: var(--radius-sm);
    padding: 12px;
    margin-bottom: 16px;
    display: none; /* Start with display: none */
    animation: fadeIn 0.3s ease;
}

.validation-summary.show {
    display: block; /* Only show when .show class is added */
}

.validation-summary h4 {
    margin: 0 0 8px 0;
    color: #dc2626;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.validation-summary ul {
    margin: 0;
    padding-left: 20px;
}

.validation-summary li {
    margin-bottom: 4px;
    font-size: 0.8rem;
}
   /* ============ MODAL STYLING FROM DATAFORM.HTML ============ */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 12px;
}

.modal-content {
    background: white;
    padding: 16px;
    border-radius: var(--radius);
    max-width: 420px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: var(--shadow-dark);
    animation: modalSlideIn 0.3s ease;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
}

.modal-header h3 {
    margin: 0;
    color: var(--accent1);
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 6px;
}

.modal-body {
    margin-bottom: 12px;
    padding: 0 2px;
}

.modal-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
}

@keyframes modalSlideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* Button styles to match dataForm.html */
.modal-actions .btn {
    border: 0;
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 600;
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    white-space: nowrap;
    height: 36px;
    box-sizing: border-box;
    position: relative;
}

.modal-actions .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
}
/*
.modal-actions .btn-secondary {
    background: transparent;
    color: var(--accent1);
    border: 1px solid var(--accent1);
}

/* Modal type styling */
.modal-success .modal-header {
    background: #e9f7f2;
    margin: -16px -16px 16px -16px;
    padding: 12px 16px;
    border-radius: var(--radius) var(--radius) 0 0;
    border-bottom: 1px solid rgba(15,122,74,0.1);
}

.modal-success .modal-header h3 {
    color: var(--accent1);
}

.modal-success .modal-icon {
    font-size: 2.2rem;
    color: var(--accent1);
    text-align: center;
    margin-bottom: 10px;
}

.modal-warning .modal-header {
    background: #fff8e1;
    margin: -16px -16px 16px -16px;
    padding: 12px 16px;
    border-radius: var(--radius) var(--radius) 0 0;
    border-bottom: 1px solid #ffecb3;
}

.modal-warning .modal-header h3 {
    color: var(--accent3);
}

.modal-warning .modal-icon {
    font-size: 2.2rem;
    color: var(--accent3);
    text-align: center;
    margin-bottom: 10px;
}

.modal-error .modal-header {
    background: #ffeaea;
    margin: -16px -16px 16px -16px;
    padding: 12px 16px;
    border-radius: var(--radius) var(--radius) 0 0;
    border-bottom: 1px solid #ffcccc;
}

.modal-error .modal-header h3 {
    color: var(--hazard-red);
}

.modal-error .modal-icon {
    font-size: 2.2rem;
    color: var(--hazard-red);
    text-align: center;
    margin-bottom: 10px;
}

.modal-info .modal-header {
    background: #f0f9ff;
    margin: -16px -16px 16px -16px;
    padding: 12px 16px;
    border-radius: var(--radius) var(--radius) 0 0;
    border-bottom: 1px solid #d1e9ff;
}

.modal-info .modal-header h3 {
    color: var(--accent2);
}

.modal-info .modal-icon {
    font-size: 2.2rem;
    color: var(--accent2);
    text-align: center;
    margin-bottom: 10px;
}

.modal-body p {
    margin: 0 0 10px 0;
    line-height: 1.4;
    font-size: 0.9rem;
    color: var(--muted);
}

.btn-reset {
    background: linear-gradient(90deg, var(--accent3), var(--accent4)) !important;
    color: #fff !important;
    border: none !important;
}

.btn-reset:hover {
    box-shadow: 0 4px 12px rgba(255,122,0,0.2) !important;
}

/* Remove Member Modal specific styles */
#currentMembersList {
    display: block;
    max-height: 100px;
    overflow-y: auto;
    text-align: left;
    margin: 8px 0;
    padding: 8px;
    background: var(--light-green);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    line-height: 1.4;
}

#currentMembersList span {
    display: block;
    padding: 2px 4px;
    margin: 1px 0;
    border-radius: 3px;
    cursor: pointer;
}

#currentMembersList span:hover {
    background: rgba(15,122,74,0.1);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .modal {
        padding: 8px;
    }
    
    .modal-content {
        max-width: 92%;
        padding: 12px;
        margin: 8px;
    }
    
    .modal-header {
        margin-bottom: 10px;
        padding-bottom: 8px;
    }
    
    .modal-header h3 {
        font-size: 1rem;
    }
    
    .modal-success .modal-header,
    .modal-warning .modal-header,
    .modal-error .modal-header,
    .modal-info .modal-header {
        margin: -12px -12px 12px -12px;
        padding: 10px 12px;
    }
    
    .modal-actions {
        flex-direction: column;
        gap: 8px;
    }
    
    .modal-actions .btn {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .modal-content {
        max-width: 98%;
        width: 98%;
        padding: 14px;
        margin: 8px;
    }
}
   /* Form styles for modals - matching users.html */
.form-group {
  margin-bottom: 12px;
}

.form-group label {
  display: block;
  margin-bottom: 4px;
  font-size: 0.85rem;
  color: var(--muted);
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.9rem;
  box-sizing: border-box;
}

.form-control:focus {
  outline: none;
  border-color: var(--accent1);
  box-shadow: 0 0 0 3px rgba(15,122,74,0.1);
}

.form-hint {
  font-size: 0.75rem;
  color: var(--muted);
  margin-top: 4px;
}
   /* Government Assistance with Date Fields - Add to existing CSS */
.gov-checkbox-with-date {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
  margin: 4px 0;
  padding: 6px 0;
  min-height: 40px;
  width: 100%;
}

.gov-checkbox-with-date input[type="checkbox"] {
  flex-shrink: 0;
  width: 18px;
  height: 18px;
  margin: 0;
  accent-color: var(--accent1);
  cursor: pointer;
  transform: scale(1.1);
}

.gov-checkbox-with-date > label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: var(--accent1);
  cursor: pointer;
  flex: 0 0 180px;
  min-width: 180px;
  margin: 0;
  padding: 4px 0;
  white-space: nowrap;
}

.gov-checkbox-with-date input[type="checkbox"]:checked + label {
  color: #0f7a4a;
  font-weight: 700;
}

.gov-date-field {
  display: none;
  flex: 1;
  min-width: 200px;
  animation: fadeIn 0.3s ease;
  align-items: center;
  gap: 8px;
}

.gov-date-field.show {
  display: flex;
}

.gov-date-field label {
  font-size: 0.8rem;
  color: var(--muted);
  margin: 0;
  white-space: nowrap;
  flex-shrink: 0;
}

.gov-date-field input[type="date"] {
  width: 140px;
  padding: 6px 8px;
  border-radius: var(--radius-sm);
  border: 2px solid var(--border);
  font-size: 0.8rem;
  min-height: 32px;
  flex-shrink: 0;
}

/* Adjust grid for compact layout in edit panel */
.member-panel .gov-support-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 4px 0;
  margin-top: 0;
}
/* Enhanced modal styling for remove/delete member modals */
.modal-content input[type="number"] {
  padding: 8px 12px;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.9rem;
  text-align: center;
}

.modal-content input[type="number"]:focus {
  outline: none;
  border-color: var(--accent1);
  box-shadow: 0 0 0 3px rgba(15,122,74,0.1);
}

#currentMembersList {
  display: block;
  max-height: 100px;
  overflow-y: auto;
  text-align: left;
  margin: 8px 0;
  padding: 8px;
  background: var(--light-green);
  border-radius: var(--radius-sm);
  font-size: 0.8rem;
  line-height: 1.4;
}

#currentMembersList span {
  display: block;
  padding: 2px 4px;
  margin: 1px 0;
  border-radius: 3px;
}

#currentMembersList span:hover {
  background: rgba(15,122,74,0.1);
}
   .admin-only {
    display: none !important;
}

/* Class to show admin elements - applied by JavaScript */
.admin-only.admin-visible {
    display: block !important;
}

/* For list items */
li.admin-only {
    display: none !important;
}

li.admin-only.admin-visible {
    display: list-item !important;
}
    select.animated {
     appearance: none;
     padding-right: 36px;
     background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%230f7a4a' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
     background-position: calc(100% - 12px) center;
     background-repeat: no-repeat;
     background-size: 9px;
   }
   
   /* EDIT PANEL STYLES FROM edit.html */
   .member-panel {
     position: fixed;
     right: 0;
     top: 0;
     height: 100vh;
     width: 520px;
     max-width: 96%;
     background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,250,0.98));
     box-shadow: -18px 0 40px rgba(6,30,20,0.12);
     transform: translateX(110%);
     transition: transform 280ms cubic-bezier(.2,.9,.3,1);
     z-index: 6000;
     padding: 18px;
     overflow-y: auto;
   }
   
   .member-panel.open {
     transform: translateX(0%);
   }
   
   .member-panel .panel-header {
     display: flex;
     align-items: center;
     gap: 10px;
     margin-bottom: 10px;
   }
   
   .member-panel h3 {
     margin: 0;
     font-size: 18px;
     color: var(--accent1);
   }
   
   .member-panel .panel-body {
     margin-top: 8px;
   }
   
   .member-panel .panel-actions {
     display: flex;
     gap: 8px;
     justify-content: flex-end;
     margin-top: 12px;
   }
   
   .panel-overlay {
     position: fixed;
     inset: 0;
     background: rgba(0,0,0,0.32);
     opacity: 0;
     transition: opacity 200ms;
     pointer-events: none;
     z-index: 5900;
   }
   
   .panel-overlay.show {
     opacity: 1;
     pointer-events: auto;
   }
   
   /* FIX 1: Improved radio button alignment - UPDATED to match dataForm.html */
   .form-row {
     margin-bottom: 12px;
   }
   
   .radio-line, .radio-group {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
    padding: 8px 0;
   }
   
   .radio-item {
     display: flex;
     align-items: center;
     gap: 8px;
     font-weight: 600;
     color: var(--accent1);
     cursor: pointer;
   }
   
   .radio-item input[type="radio"] {
     accent-color: var(--accent1);
     width: 18px;
     margin: 0;
     transform: scale(1.1);
   }
   
   .btn.secondary {
     background: transparent;
     color: #0f7a4a;
     border: 1px solid rgba(6,30,20,0.06);
   }
   
   /* Card styling for edit form */
   .edit-card {
     padding: 16px;
     border-radius: var(--radius);
     background: white;
     margin-bottom: 16px;
     box-shadow: 0 4px 12px rgba(6,30,20,0.08);
     border: 1px solid var(--border);
   }
   
   /* FIX 4: Consistent form section headers */
   .form-section {
     background: var(--light-green);
     padding: 10px 14px;
     border-radius: var(--radius-sm);
     margin: 20px 0 16px 0;
     border-left: 4px solid var(--accent1);
   }
   
   .form-section h5 {
     margin: 0;
     color: var(--accent1);
     font-size: 15px;
     font-weight: 700;
   }
   
   .form-grid {
     display: grid;
     grid-template-columns: repeat(2,1fr);
     gap: 16px;
   }
   
   .small-muted {
     font-size:0.75rem; 
     color:var(--muted);
     margin-bottom: 10px;
   }
   
   .green {
     color: #0f7a4a;
     font-weight: 700;
   }
   
/* Specific edit form styling */
.coordinate-container {
  display: flex;
  gap: 8px;
  align-items: center; /* This ensures vertical centering */
  flex-wrap: wrap;
}

.coordinate-container input {
  flex: 1;
  min-width: 200px;
  margin-bottom: 0;
  height: 40px; /* Set consistent height */
}

.coordinate-container .btn {
  white-space: nowrap;
  padding: 8px 12px;
  font-size: 14px;
  height: 40px; /* Match the input height */
  align-self: center; /* Center vertically */
  display: flex;
  align-items: center;
  justify-content: center;
}
/* Specifically for the Get My Location button - REMOVE the previous margin-top */
#edit_getLocationBtn {
  margin-top: 6px;
}
   
   /* Form controls */
   .member-panel input,
   .member-panel select,
   .member-panel textarea {
     width: 100%;
     padding: 10px 12px;
     border: 2px solid var(--border);
     border-radius: var(--radius-sm);
     font-size: 14px;
     font-family: inherit;
     box-sizing: border-box;
     margin-top: 6px;
   }
   
   .member-panel input:focus,
   .member-panel select:focus,
   .member-panel textarea:focus {
     outline: none;
     border-color: var(--accent1);
     box-shadow: 0 0 0 3px rgba(15,122,74,0.1);
   }
   
   .member-panel label {
     font-weight: 600;
     font-size: 14px;
     color: var(--accent1);
     display: block;
     margin-bottom: 6px;
   }
   
   /* Hazard hunter button */
   .btn.hazard-hunter {
     background: linear-gradient(90deg, var(--hazard-red), var(--hazard-orange)) !important;
     color: white !important;
     border: none !important;
   }
   
   .btn.hazard-hunter:hover {
     background: linear-gradient(90deg, #b91c1c, var(--hazard-red)) !important;
     box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2) !important;
   }
   
   /* FIX 2: Larger checkboxes like dataForm.html - UPDATED */
   .checkbox-item {
     display: flex;
     align-items: center;
     gap: 10px;
     font-weight: 600;
     color: var(--accent1);
     cursor: pointer;
     margin: 6px 0;
     padding: 4px 0;
   }
   
   .checkbox-item input[type="checkbox"] {
     accent-color: var(--accent1);
     width: 20px;
     height: 20px;
     margin: 0;
     cursor: pointer;
     transform: scale(1.1);
   }
.checkbox-item1 {
    display: flex;
    align-items: center;     /* Vertical alignment */
    gap: 8px;                /* Space between checkbox and text */
    margin-top: 4px;
}

.checkbox-item1 input[type="checkbox"] {
    accent-color: var(--accent1);
    width: 20px;
    cursor: pointer;
    transform: scale(1.1);
    margin: 0;               /* Remove unwanted margins */
}

.checkbox-item1 label {
    margin: 0;
    line-height: 1;          /* Prevent label from dropping to next line */
    font-weight: 600;
    color: #0a7a43;          /* Match your green text */
}
   
   /* Conditional fields */
   .conditional-field {
     display: none;
     margin-top: 8px;
     animation: fadeIn 0.3s ease;
   }
   
   .conditional-field.show {
     display: block;
   }
   
   @keyframes fadeIn {
     from { opacity: 0; transform: translateY(-5px); }
     to { opacity: 1; transform: translateY(0); }
   }
   
   /* Animal grid */
   .domestic-grid {
     display: grid;
     grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
     gap: 12px;
     margin-top: 12px;
   }
   
   .animal-card {
     background: var(--light-green);
     padding: 12px;
     border-radius: var(--radius-sm);
     border: 2px solid var(--border);
     transition: all 0.3s ease;
   }
   
   .animal-card:hover {
     border-color: var(--accent1);
     transform: translateY(-2px);
     box-shadow: 0 4px 12px rgba(15,122,74,0.1);
   }
   
   .animal-header {
     display: flex;
     align-items: center;
     gap: 12px;
     margin-bottom: 8px;
   }
   
   .animal-qty {
     display: flex;
     align-items: center;
     gap: 8px;
   }
   
   .animal-qty label {
     margin: 0;
     font-weight: 600;
     color: var(--muted);
     font-size: 14px;
   }
   
   .qty {
     width: 70px;
     padding: 8px;
     border-radius: var(--radius-sm);
     border: 2px solid var(--border);
     text-align: center;
     font-size: 14px;
   }
   
   .others-box {
     width: 100%;
     min-height: 80px;
     padding: 12px;
     border-radius: var(--radius-sm);
     border: 2px solid var(--border);
     font-family: inherit;
     font-size: 14px;
     margin-top: 8px;
     resize: vertical;
   }
   
   /* Government support grid */
   .gov-support-grid {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px 16px;
     margin-top: 12px;
   }
   
   .gov-support-grid .checkbox-item {
    display: flex;
    align-items: center;
    gap: 10px;
    min-height: 40px;
    -webkit-tap-highlight-color: transparent;
   }
   
   /* Error messages */
   .error-message {
     color: #dc2626;
     font-size: 12px;
     margin-top: 4px;
     display: none;
   }
   
   .input-error {
     border-color: #dc2626 !important;
   }
   
   /* Required field indicator */
   .required {
     color: #dc2626;
     margin-left: 2px;
   }
   
   /* Panel improvements */
   .panel-body {
     padding-right: 8px;
   }
   
   .panel-body h4 {
  margin: 0 0 8px 0;
  color: #0f7a4a;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
   }
   
   /* Data ID display */
   .data-id-display {
     background: #f0f9ff;
     padding: 10px 14px;
     border-radius: 8px;
     border: 1px solid #d1e9ff;
     margin-bottom: 16px;
     font-weight: bold;
     color: #0f7a4a;
   }
   
   .data-id-display span {
     background: #e3f2fd;
     padding: 4px 8px;
     border-radius: 4px;
   }
   
/* Member preview improvements - FIX 6 */
.member-preview {
  list-style: none;
  padding: 0;
  margin: 12px 0;
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px;
}

.member-preview li {
  padding: 10px 12px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  transition: background 0.2s;
}

.member-preview li:hover {
  background: #f0f9ff;
}

.member-preview li:last-child {
  border-bottom: none;
}

.member-preview li .member-actions {
  float: right;
  display: flex;
  gap: 6px;
}

/* REMOVE BACKGROUND FROM BUTTONS */
.member-preview li .member-actions button {
  background: none !important; /* Remove background */
  border: none !important; /* Remove border */
  cursor: pointer;
  padding: 4px !important; /* Adjust padding */
  font-size: 14px !important; /* Slightly larger icons */
  border-radius: 0 !important; /* Remove rounded corners */
  width: auto !important; /* Remove fixed width */
  height: auto !important; /* Remove fixed height */
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Style for edit button - green icon */
.member-preview li .member-actions .edit-btn {
  color: var(--accent1) !important; /* Green color */
}

.member-preview li .member-actions .edit-btn:hover {
  color: #0a5c36 !important; /* Darker green on hover */
}

/* Style for delete button - red icon */
.member-preview li .member-actions .remove-btn {
  color: #dc2626 !important; /* Red color */
}

.member-preview li .member-actions .remove-btn:hover {
  color: #b91c1c !important; /* Darker red on hover */
}

/* Remove hover background effects */
.member-preview li .member-actions button:hover {
  background: transparent !important;
  transform: translateY(0) !important;
  box-shadow: none !important;
}
   
   /* Form section spacing */
   .member-panel .edit-card + .edit-card {
     margin-top: 20px;
   }
   
   /* Specific grid column spans */
   .member-panel .form-grid > div[style*="grid-column"] {
     grid-column: 1 / -1;
   }
   
   /* FIX 3: Coordinate modal styles */
   .coordinate-modal {
     display: none;
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background: rgba(0,0,0,0.5);
     z-index: 7000;
     align-items: center;
     justify-content: center;
   }
   
   .coordinate-modal.active {
     display: flex;
   }
   
   .coordinate-modal-content {
     background: white;
     padding: 24px;
     border-radius: var(--radius);
     width: 90%;
     max-width: 500px;
     box-shadow: var(--shadow-dark);
   }
   
   .coordinate-modal-content h4 {
     margin-top: 0;
     color: var(--accent1);
     border-bottom: 2px solid var(--light-green);
     padding-bottom: 12px;
     margin-bottom: 20px;
   }
   
   .modal-coordinate-input {
     width: 100%;
     padding: 12px;
     border: 2px solid var(--border);
     border-radius: var(--radius-sm);
     margin: 12px 0;
     font-size: 14px;
   }
   
   .modal-coordinate-input:focus {
     outline: none;
     border-color: var(--accent1);
     box-shadow: 0 0 0 3px rgba(15,122,74,0.1);
   }
   
   .modal-coordinate-actions {
     display: flex;
     gap: 12px;
     justify-content: flex-end;
     margin-top: 20px;
   }
   
   /* Responsive for edit panel */
   @media(max-width:900px){
     .form-grid {
       grid-template-columns: 1fr;
     }
     
     .member-panel {
       width: 100%;
     }
     
     .domestic-grid {
       grid-template-columns: 1fr;
     }
     
     .gov-support-grid {
       grid-template-columns: repeat(2, 1fr);
     }
     
     .radio-group {
       gap: 16px;
       flex-wrap: wrap;
     }
   }

   /* FIX: Ensure member panel action buttons are visible */
   #memberPanel .panel-actions {
     display: flex !important;
     gap: 8px;
     justify-content: flex-end;
     margin-top: 20px;
     padding: 16px 0;
     border-top: 1px solid var(--border);
   }

   #memberPanel .panel-actions button {
     min-width: 120px;
   }

   /* FIX: Ensure all form elements in member panel are properly spaced */
   #memberPanel .edit-card {
     margin-bottom: 20px;
   }

   #memberPanel .edit-card:last-of-type {
     margin-bottom: 0;
   }

   /* FIX: Improve contact number input validation styling */
   .member-panel input[type="text"][id$="contact"],
   .member-panel input[type="tel"] {
     font-family: monospace;
     letter-spacing: 0.5px;
   }

   .member-panel input.input-error {
     border-color: #dc2626 !important;
     background-color: #fff5f5;
   }

   #memberContactError, #edit_contactError {
     color: #dc2626;
     font-size: 12px;
     margin-top: 4px;
     display: none;
   }

   /* FIX 4: Ensure the member panel body has enough padding at bottom */
   #memberPanel .panel-body {
     padding-bottom: 10px !important;
   }

   /* FIX 4: Add margin at bottom of edit panel for head */
   #editPanel .panel-body {
     padding-bottom: 10px !important;
   }
   
   #editPanel .edit-card:first-of-type {
     margin-bottom: 5px;
   }

   /* Head name with checkbox container - FIXED */
   .head-name-container {
     display: flex;
     align-items: flex-start;
     gap: 0;
     flex-wrap: wrap;
     margin-bottom: 0;
   }

   .head-name-container input[type="text"] {
     flex: 1;
     min-width: 200px;
     margin-bottom: 0;
   }

   /* FIXED: Remove space between Household Head Full Name and FishR/RBIS Registered button */
   .head-registration-container {
     display: flex;
     align-items: center;
     gap: 16px;
     padding: 0;
     background: transparent;
     border-radius: 0;
     border-left: none;
   }

   .head-registration-container .checkbox-item {
     margin: 0;
   }

   /* FIXED: Better alignment for conditional field in Educational & Economic Status */
   .form-grid .conditional-field {
     grid-column: 1 / -1;
     margin-top: 8px;
     margin-bottom: 0;
   }

   /* FIXED: Ensure proper spacing in form grids */
   .form-grid > div:not(:last-child) {
     margin-bottom: 0;
   }

   /* FIX 5: Center align text in all buttons */
   .btn {
     text-align: center;
     justify-content: center;
   }

   /* Specific alignment for action buttons */
   .panel-actions .btn,
   #memberPanel .panel-actions .btn,
   #editPanel .panel-actions .btn {
     display: flex;
     align-items: center;
     justify-content: center;
     text-align: center;
   }

   /* Center text in edit panel action buttons */
   #editPanel .edit-card:last-of-type .btn {
     text-align: center;
     justify-content: center;
   }

   /* For Back, Save & Next buttons specifically - FIX 5 */
   #memberBack, #memberNext, #saveEditBtn, #cancelEditBtn, #startSequenceBtn {
     text-align: center !important;
     display: flex !important;
     align-items: center !important;
     justify-content: center !important;
   }

   /* ORIGINAL RECORDS STYLES CONTINUED */
   #disc {
    margin-bottom: 10px;
    background: var(--light-green);
    padding: 12px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--accent1);
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.5;
   }
   body {
    background-color: var(--bg);
    margin: 0;
    min-height: 100vh;
   }

   .page-container{
    max-width:1200px;
    margin:20px auto;
    padding:12px;
    display:grid;
    grid-template-columns:260px 1fr;
    gap:18px;
    align-items:start;
    transition: grid-template-columns 0.3s ease;
   }

   .page-container.collapsed {
    grid-template-columns: 60px 1fr;
   }

   /* Topbar - Enhanced */
   .topbar{
    grid-column:1/-1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
    border-radius:var(--radius);
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    box-shadow:var(--shadow-dark);
   }

   .brand{
    display:flex;
    gap:12px;
    align-items:center;
   }

   .brand .logo{
    width:60px;
    height:60px;
    border-radius:var(--radius-sm);
    object-fit:contain;
   }

   .brand-text h1 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
   }

   .brand-text p {
    font-size:12px;
    opacity:0.95;
    margin: 4px 0 0 0;
   }

   .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
   }

   #userName {
    font-weight: 600;
    border-radius: 20px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
   }

   #logoutBtn {
    background: rgba(255,255,255,0.25);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
   }

   #logoutBtn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
   }

   /* Sidebar - Collapsible */
   .sidebar{
    background:linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.20));
    border-radius:var(--radius);
    padding:12px;
    height:calc(100vh - 120px);
    position:sticky;
    top:72px;
    overflow:auto;
    transition: width 0.3s ease;
   }

   .sidebar-container {
    display: flex;
    flex-direction: column;
    height: 100%;
   }

   .sidebar-toggle {
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.3s ease;
   }

   .sidebar-toggle:hover {
    transform: scale(1.1);
   }

   .sidebar ul{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
    flex: 1;
   }

   .sidebar li a{
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    text-decoration: none;
    color: var(--muted);
    border-radius: var(--radius-sm);
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
   }

   .sidebar li a:hover{
    background: var(--light-green);
    color: var(--accent1);
   }

   .sidebar li a.active{
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .sidebar li a .menu-icon {
    font-size: 1.2rem;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
   }

   .sidebar li a .menu-text {
    transition: opacity 0.3s ease;
   }

   .page-container.collapsed .sidebar li a .menu-text {
    opacity: 0;
    width: 0;
    overflow: hidden;
   }

   /* Content Area - Fixed Size */
   .content-area{
    background:linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
    border-radius:var(--radius);
    padding:18px;
    box-shadow:0 8px 22px rgba(10,20,16,0.06);
    min-height:72vh;
    height: calc(100vh - 120px);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
   }

   /* Content Header - Fixed */
   .content-header {
    margin-top: 0;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
   }

   .content-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: var(--accent1);
    display: flex;
    align-items: center;
    gap: 8px;
   }

   /* Stats - Made Smaller */
   .stats-container {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
   }

   .stat-item {
    text-align: center;
    min-width: 70px;
    padding: 6px 8px;
    background: white;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
   }

   .stat-item span {
    font-size: 0.75rem;
    color: var(--muted);
    display: block;
    margin-bottom: 2px;
   }

   .stat-item .value {
    font-size: 1rem;
    font-weight: 700;
    color: var(--accent1);
    display: block;
   }

   /* Toolbar - New Layout */
   .toolbar {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
   }

   .toolbar-row-1 {
    display: flex;
    width: 100%;
   }

   .search-container {
    position: relative;
    flex: 1;
    width: 100%;
   }

   .search-container i {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 0.9rem;
    z-index: 1;
   }

   .search-box{
    padding: 10px 12px 10px 32px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    background: white;
    width: 100%;
    box-sizing: border-box;
   }

   .search-box:focus {
    outline: none;
    border-color: var(--accent1);
    box-shadow: 0 0 0 3px rgba(15,122,74,0.1);
   }

   .toolbar-row-2 {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    align-items: center;
   }

   .brgy-dropdown{
    padding: 8px 10px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: white;
    color: var(--muted);
    font-size: 0.85rem;
    min-width: 160px;
    cursor: pointer;
    height: 36px;
    box-sizing: border-box;
   }

   .brgy-dropdown:focus {
    outline: none;
    border-color: var(--accent1);
   }

   .btn {
    border:0;
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    cursor:pointer;
    font-weight:600;
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    white-space: nowrap;
    height: 36px;
    box-sizing: border-box;
   }

   .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .btn-export {
    background: linear-gradient(90deg, var(--accent3), var(--accent4));
   }

   .btn-export:hover {
    box-shadow: 0 4px 8px rgba(255,122,0,0.2);
   }

   /* Records Table - Fixed */
   .records-wrapper{
    flex: 1;
    background:rgba(255,255,255,0.95);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:auto;
    position: relative;
    margin-bottom: 16px;
    border: 1px solid var(--border);
   }

   .records-table{
    width:100%;
    min-width:1400px;
    border-collapse:collapse;
    font-size: 14px;
   }

   .records-table th{
    background: var(--light-green);
    padding: 10px 8px;
    text-align: center;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 100;
    font-size: 14px;
    color: var(--accent1);
    border-bottom: 2px solid rgba(15,122,74,0.15);
    white-space: nowrap;
    vertical-align: middle;
    height: 40px;
    box-sizing: border-box;
   }

   .records-table td{
    padding: 8px 6px;
    font-size: 14px;
    border-bottom: 1px solid rgba(15,122,74,0.08);
    vertical-align: middle;
    color: var(--muted);
    text-align: center;
    height: 36px;
    box-sizing: border-box;
    line-height: 1.3;
   }

   .records-table tbody tr:hover{
    background:rgba(52,183,143,0.05);
   }

   /* Sticky columns - Updated with dark background */
   .select-col{
    position:sticky;
    left:0;
    background: rgba(255,255,255,0.95);
    z-index:50;
    padding-left:8px;
    border-right: 1px solid rgba(15,122,74,0.1);
   }

   .actions-col{
    position:sticky;
    right:0;
    background: #2c3e50;
    z-index:50;
    border-left: 1px solid rgba(255,255,255,0.1);
   }

   /* Specific styling for Members and Actions columns */
   .records-table th.actions-col {
    background: #2c3e50;
    color: white;
    font-weight: 700;
    z-index: 101;
   }

   .records-table th:last-child,
   .records-table th:nth-last-child(2) {
    background: #2c3e50;
    color: white;
    z-index: 101;
   }

   .records-table td.actions-col {
    background: #2c3e50;
    color: white;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    z-index: 49;
   }

   .records-table td:nth-last-child(1),
   .records-table td:nth-last-child(2) {
    background: #2c3e50;
    color: white;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    z-index: 49;
   }

   /* FIXED: Updated By and Updated On columns - match row color */
   .records-table td:nth-last-child(3),
   .records-table td:nth-last-child(4) {
     background: inherit !important;
     z-index: 48;
   }

   /* Ensure these columns don't get the dark actions background */
   .records-table tr:hover td:nth-last-child(3),
   .records-table tr:hover td:nth-last-child(4) {
     background: rgba(52,183,143,0.05) !important;
   }

   /* Specific styles for different row colors */
   .records-table tr.mem-small td:nth-last-child(3),
   .records-table tr.mem-small td:nth-last-child(4) {
     background: #d4f6ff !important;
   }

   .records-table tr.mem-normal td:nth-last-child(3),
   .records-table tr.mem-normal td:nth-last-child(4) {
     background: #d9ffd9 !important;
   }

   .records-table tr.mem-large td:nth-last-child(3),
   .records-table tr.mem-large td:nth-last-child(4) {
     background: #fff7c2 !important;
   }

   .records-table tr.mem-critical td:nth-last-child(3),
   .records-table tr.mem-critical td:nth-last-child(4) {
     background: #ffd6d6 !important;
   }

   /* Checkbox styling */
   .select-col input[type="checkbox"] {
    width: 14px;
    height: 14px;
    cursor: pointer;
    accent-color: var(--accent1);
   }

   /* Compact member rows */
   .member-row{
    background:#fafafa;
   }

   .member-row.hidden{
    display:none;
   }

   /* Color coding */
   .mem-small{background:#d4f6ff !important}
   .mem-normal{background:#d9ffd9 !important}
   .mem-large{background:#fff7c2 !important}
   .mem-critical{background:#ffd6d6 !important}

   /* Highlight */
   .hl{
    background:#fffe8a;
    padding:1px 2px;
    border-radius:3px;
   }

   /* Icon buttons */
   .icon-btn{
    background:none;
    border:0;
    font-size:0.85rem;
    cursor:pointer;
    padding:4px;
    border-radius:4px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    color:white;
    transition: all 0.2s ease;
   }

   .icon-btn:hover{
    background:rgba(255,255,255,0.15);
    transform:translateY(-1px);
   }

   /* Show toggle */
   .show-toggle{
    font-size:0.75rem;
    padding:5px 8px;
    border-radius:4px;
    border:1px solid rgba(255,255,255,0.3);
    background:rgba(255,255,255,0.1);
    cursor:pointer;
    color:white;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s ease;
    white-space: nowrap;
   }

   .show-toggle:hover{
    background:rgba(255,255,255,0.2);
    border-color: rgba(255,255,255,0.5);
   }

   /* Export dropdown */
   .export-wrapper{
    position:relative;
   }

   .export-dropdown{
    font-size:0.8rem;
    position:absolute;
    top:100%;
    right:0;
    margin-top: 8px;
    background:#fff;
    border:1px solid var(--border);
    border-radius:var(--radius-sm);
    width:140px;
    box-shadow:var(--shadow);
    z-index:9999;
    overflow: hidden;
   }

   .export-dropdown div{
    padding:8px 12px;
    cursor:pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
   }

   .export-dropdown div:hover{
    background:#e9fff0;
    color: var(--accent1);
   }

   .export-dropdown div i {
    width: 14px;
    text-align: center;
    font-size: 0.85rem;
   }

   .hidden{
    display:none;
   }

   /* Pagination - Fixed Position */
   #paginationArea {
    margin-top: 16px;
    display: flex;
    justify-content: center;
    gap: 6px;
    flex-wrap: wrap;
   }

   #paginationArea button{
    padding:5px 8px;
    margin:0 2px;
    border-radius:4px;
    border:1px solid var(--border);
    background:#fff;
    cursor:pointer;
    color: var(--muted);
    font-size: 0.8rem;
    min-width: 28px;
    transition: all 0.2s ease;
   }

   #paginationArea button:hover{
    border-color:var(--accent1);
    color: var(--accent1);
   }

   #paginationArea button.active{
    background:var(--accent1);
    color:#fff;
    border-color:var(--accent1);
    font-weight:700;
   }

   /* Legend - Compact Horizontal Layout */
   .legend-container {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px 16px;
    box-shadow: 0 2px 8px rgba(6,30,20,0.04);
    margin-top: 0;
    border-top: 2px solid var(--accent1);
   }

   .legend-box {
    display: flex;
    flex-direction: column;
    gap: 6px;
   }

   .legend-box h4 {
    margin: 0;
    font-size: 0.9rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 6px;
   }

   .legend-items {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
   }

   .legend-item{
    display:flex;
    gap:6px;
    align-items:center;
    font-size:0.8rem;
    white-space: nowrap;
   }

   .legend-swatch{
    width:14px;
    height:14px;
    border-radius:3px;
    flex-shrink: 0;
    border: 1px solid rgba(0,0,0,0.1);
   }

   /* Loading overlay */
   #loading {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(255,255,255,0.85);
    align-items:center;
    justify-content:center;
    z-index:9999;
    backdrop-filter: blur(2px);
   }

   .loading-content {
    background:#fff;
    padding:20px 24px;
    border-radius:var(--radius);
    box-shadow:var(--shadow-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
   }

   .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent1);
    border-radius: 50%;
    animation: spin 1s linear infinite;
   }

   @keyframes spin {
    to { transform: rotate(360deg); }
   }

/* Mobile Styles */
@media (max-width: 768px) {
    body {
        padding-bottom: 70px; /* Space for fixed bottom nav */
    }
    
    .page-container {
        grid-template-columns: 1fr !important;
        padding: 8px;
        gap: 12px;
        margin-bottom: 0; /* Remove margin since we have body padding */
    }
    
    .page-container.collapsed {
        grid-template-columns: 1fr !important;
    }
    
    .sidebar {
        display: none !important; /* Hide sidebar on mobile */
    }
    
    .mobile-bottom-nav {
        display: flex !important; /* Show bottom nav on mobile */
        flex-direction: column;
    }
    
    /* Remove mobile menu toggle button */
    .mobile-menu-toggle {
        display: none !important;
    }
    
    .content-area {
        height: auto;
        min-height: auto;
        padding: 20px;
        margin-bottom: 0;
    }
    
    /* Adjust content area for bottom nav */
    .content-area {
        margin-bottom: 70px;
    }
    
    .toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .toolbar-row-2 {
        justify-content: space-between;
        flex-wrap: wrap;
    }
    
    .search-box {
        max-width: 100%;
    }
    
    .brgy-dropdown {
        width: 100%;
        min-width: auto;
    }
    
    .stats-container {
        justify-content: space-between;
        gap: 8px;
    }
    
    .stat-item {
        flex: 1;
        min-width: auto;
        padding: 5px 6px;
    }
    
    .stat-item span {
        font-size: 0.7rem;
    }
    
    .stat-item .value {
        font-size: 0.9rem;
    }
    
    .user-info {
        gap: 8px;
    }
    
    #userName {
        font-size: 0.9rem;
        padding: 6px 12px;
    }
    
    #logoutBtn {
        padding: 6px 12px;
        font-size: 0.85rem;
    }
    
    .legend-items {
        flex-direction: column;
        gap: 6px;
        align-items: flex-start;
    }
    
    .records-table {
        font-size: 12px;
        min-width: 1200px;
    }
    
    .records-table th,
    .records-table td {
        font-size: 12px;
        padding: 6px 5px;
    }
    
    .records-table th {
        height: 36px;
    }
    
    .records-table td {
        height: 32px;
    }
}
/* Desktop Styles */
@media (min-width: 1025px) {
    .mobile-bottom-nav {
        display: none;
    }
}

   /* Tablet Styles */
   @media (min-width: 769px) and (max-width: 1024px) {
    .page-container {
        max-width: 95%;
        grid-template-columns: 220px 1fr;
        gap: 15px;
        padding: 10px;
    }
    
    .content-area {
        padding: 15px;
    }
    
    .records-table {
        min-width: 1300px;
    }
    
    .records-table th,
    .records-table td {
        font-size: 13px;
        padding: 8px 6px;
    }
   }

   /* Mobile menu toggle button */
   .mobile-menu-toggle {
    display: none;
   }

   /* Scrollbar styling */
   .records-wrapper::-webkit-scrollbar {
    width: 8px;
    height: 8px;
   }

   .records-wrapper::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
   }

   .records-wrapper::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
   }

   .records-wrapper::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
   }
</style>
</head>
<body>
<!-- Background pattern -->
    <div class="bg-pattern">
        <div class="bg-circle circle-1"></div>
        <div class="bg-circle circle-2"></div>
        <div class="bg-circle circle-3"></div>
    </div>
<div class="page-container">

  <header class="topbar">
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div class="brand-text">
        <h1>PUROK KALIGTASAN</h1>
        <p>MDRRMO Alitagtag – Household Records System</p>
      </div>
    </div>

    <div class="user-info">
      <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
      </button>
      <span id="userName"></span>
      <button id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-container">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul>
        <li><a href="dashboard.html" title="Dashboard"><span class="menu-icon">📊</span> <span class="menu-text">Dashboard</span></a></li>
        <li><a href="dataForm.html" title="Data Entry"><span class="menu-icon">📝</span> <span class="menu-text">Data Entry</span></a></li>
        <li><a href="records.html" class="active" title="Records"><span class="menu-icon">📁</span> <span class="menu-text">Records & Management</span></a></li>
        <li><a href="charts.html" title="Charts"><span class="menu-icon">📈</span> <span class="menu-text">Charts & Analytics</span></a></li>
        <li class="admin-only"><a href="users.html" title="User Management"><span class="menu-icon">👥</span> <span class="menu-text">User Management</span></a></li>
      </ul>
    </div>
  </aside>

  <main class="content-area">
    <div class="content-header">
      <h2><span style="color: var(--accent1);">📁</span> Household Records</h2>
    </div>
    
    <!-- Description -->
    <div id="disc">This section displays all collected household data in one place. Users can easily view, search, and review information gathered from each household, helping ensure accurate monitoring, validation, and decision-making for community programs and emergency operations.</div>

    <!-- Counts - Top Right -->
    <div class="stats-container">
      <div class="stat-item">
        <span>Rows</span>
        <div class="value" id="rowCount">0</div>
      </div>
      <div class="stat-item">
        <span>Matches</span>
        <div class="value" id="matchCount">0</div>
      </div>
      <div class="stat-item">
        <span>Selected</span>
        <div class="value" id="selectedCount">0</div>
      </div>
    </div>

    <!-- Toolbar - New Layout -->
    <div class="toolbar">
      <div class="toolbar-row-1">
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input id="searchInput" class="search-box" placeholder="Search by Name / Barangay / ID..." />
        </div>
      </div>
      
      <div class="toolbar-row-2">
        <select id="filterBarangay" class="brgy-dropdown" aria-label="Filter by Barangay">
          <option value="">All Barangays</option>
          <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
          <option>Dalipit East</option><option>Dalipit West</option>
          <option>Dominador East</option><option>Dominador West</option>
          <option>Munlawin Sur</option><option>Munlawin Norte</option>
          <option>Muzon Primero</option><option>Muzon Segundo</option>
          <option>Pinagkurusan</option><option>Ping-As</option>
          <option>Poblacion East</option><option>Poblacion West</option>
          <option>San Jose</option><option>San Juan</option>
          <option>Santa Cruz</option><option>Tadlac</option>
        </select>

        <button id="refreshBtn" class="btn">
          <i class="fas fa-redo"></i> Refresh
        </button>

        <div class="export-wrapper">
          <!-- FIX 1: Changed export icon -->
          <button id="exportBtn" class="btn btn-export">
            <i class="fas fa-file-export"></i> Export 
          </button>
          <div id="exportDropdown" class="export-dropdown hidden" role="menu" aria-hidden="true">
            <div onclick="exportAll()">
              <i class="fas fa-file-export"></i> Export All
            </div>
            <div onclick="exportSelected()">
              <i class="fas fa-check-circle"></i> Export Selected
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="records-wrapper">
      <table class="records-table" aria-describedby="records table">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div id="paginationArea"></div>

    <!-- Legend - Compact Horizontal Layout -->
    <div class="legend-container">
      <div class="legend-box">
        <h4><i class="fas fa-palette"></i> Household Color Legend:</h4>
        <div class="legend-items">
          <div class="legend-item"><div class="legend-swatch" style="background:#d4f6ff"></div>1 Member</div>
          <div class="legend-item"><div class="legend-swatch" style="background:#d9ffd9"></div>2–4 Members</div>
          <div class="legend-item"><div class="legend-swatch" style="background:#fff7c2"></div>5–7 Members</div>
          <div class="legend-item"><div class="legend-swatch" style="background:#ffd6d6"></div>8+ Members</div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- EDIT SLIDE-IN PANEL -->
<div id="editPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Edit household panel">
  <div class="panel-header">
    <button id="panelClose" class="btn secondary" title="Close panel">←</button>
    <h3 id="panelTitle">Edit Household</h3>
  </div>

  <div class="panel-body">
    <div class="data-id-display">
      Data ID: <span id="editDataIdDisplay">Loading...</span>
    </div>
    
    <!-- ADD THIS VALIDATION SUMMARY CONTAINER -->
    <div id="validationSummaryEdit" class="validation-summary" role="alert" aria-live="polite">
      <h4><i class="fas fa-exclamation-triangle"></i> Required Fields – The following information must be provided before saving:</h4>
      <ul id="editValidationErrors"></ul>
    </div>
    
    <form id="editForm" onsubmit="return false;">
      <!-- Card 1: Basic Information -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Basic Information</h5>
        </div>
        
        <div class="form-grid">
          <div>
            <label>Coordinates (optional)</label>
            <div class="coordinate-container">
              <input type="text" id="edit_coordinate" placeholder="Latitude, Longitude" />
              <button type="button" id="edit_getLocationBtn" class="btn secondary">
                <i class="fas fa-map-marker-alt"></i> Get My Location
              </button>
              <button type="button" id="edit_hazardHunterBtn" class="btn hazard-hunter">
                <i class="fas fa-map-marked-alt"></i> Pick from Hazard Hunter
              </button>
            </div>
            <div class="small-muted">Optional — paste `lat, lng` if available, or use the buttons above.</div>
          </div>
          
          <div>
            <label>Barangay <span class="required">*</span></label>
            <select id="edit_barangay" required class="animated">
              <option value="">Select Barangay...</option>
              <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
              <option>Dalipit East</option><option>Dalipit West</option><option>Dominador East</option>
              <option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
              <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option>
              <option>Ping-As</option><option>Poblacion East</option><option>Poblacion West</option>
              <option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
            </select>
          </div>

          <div>
            <label>Sitio / Purok <span class="required">*</span></label>
            <select id="edit_sitio" required class="animated">
              <option value="">Select...</option>
              <option>Purok I</option><option>Purok II</option><option>Purok III</option>
              <option>Purok IV</option><option>Purok V</option><option>Purok VI</option>
              <option>Purok VII</option>
            </select>
          </div>

          <!-- Household Head Full Name section -->
          <div style="grid-column: 1 / -1;">
            <label>Household Head Full Name<span class="required">*</span></label>
            <div class="head-name-container">
              <input type="text" id="edit_householdHead" required/>
            </div>
            
            <!-- FIXED: FishR/RBIS Registered button moved inline -->
            <div class="head-registration-container">
              <div class="checkbox-item1" style="margin-bottom: 0;">
                <input type="checkbox" id="edit_headRegisteredCheckbox">
                <label for="edit_headRegisteredCheckbox">FishR/RBIS Registered</label>
              </div>
            </div>
            
            <div id="edit_headRegistrationField" class="conditional-field">
              <label>FishR Registered/RBIS Registered</label>
              <select id="edit_headRegistration" class="animated">
                <option value="">Select...</option>
                <option value="FishR Registered">FishR Registered</option>
                <option value="RBIS Registered">RBIS Registered</option>
                <option value="FishR & RBIS Registered">FishR & RBIS Registered</option>
              </select>
            </div>
          </div>

          <div>
            <label>Contact no. <span class="required">*</span></label>
            <input type="text" id="edit_contactNo" placeholder="09XXXXXXXXX" required 
                   pattern="^(09|\+639)\d{9}$" />
            <div class="error-message" id="edit_contactError"></div>
          </div>

          <div>
            <label>Sex <span class="required">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="edit_head_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="edit_head_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate <span class="required">*</span></label>
            <input type="date" id="edit_householdBirthdate" required/>
          </div>

          <div>
            <label>Age</label>
            <input type="text" id="edit_householdAge" readonly/>
          </div>

          <div>
            <label>Age Category</label>
            <input type="text" id="edit_householdStage" readonly/>
          </div>

          <div>
            <label>No. of Household Member/s</label>
            <input type="number" id="edit_memberCount" min="0" value="0" >
            <div class="small-muted">Set to 0 if no other members.</div>
          </div>

          <!-- FIXED: Additional Information checkboxes -->
          <div style="grid-column: 1 / -1;">
            <label style="margin-bottom: 0;">Additional Information</label>
            <div class="small-muted1">Please check (✓) all items that apply.</div>
            <div class="additional-info-checkbox-container">
              <div class="additional-info-checkbox-item">
                <input type="checkbox" id="edit_soloParenting">
                <label for="edit_soloParenting">Solo Parenting</label>
              </div>
              <div class="additional-info-checkbox-item">
                <input type="checkbox" id="edit_lgbt">
                <label for="edit_lgbt">LGBT</label>
              </div>
              <div class="additional-info-checkbox-item">
                <input type="checkbox" id="edit_lactating">
                <label for="edit_lactating">Lactating</label>
              </div>
              <div class="additional-info-checkbox-item">
                <input type="checkbox" id="edit_pregnant">
                <label for="edit_pregnant">Pregnant</label>
              </div>
            </div>
          </div>

          <!-- MOVED: Persons with Disability (PWD) -->
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="edit_head_pwd" value="Yes" id="edit_pwdYes"> Yes</label>
              <label class="radio-item"><input type="radio" name="edit_head_pwd" value="No" id="edit_pwdNo" checked> No</label>
            </div>
          </div>

          <!-- NEW: Type of Disability Dropdown -->
          <div id="edit_disabilityTypeField" class="conditional-field" style="grid-column: 1 / -1;">
            <label>Type of Disability</label>
            <select id="edit_disabilityType" class="animated">
              <option value="">Select type of disability...</option>
              <option value="Physical Disability">Physical Disability</option>
              <option value="Visual Disability">Visual Disability</option>
              <option value="Hearing Disability">Hearing Disability</option>
              <option value="Speech Impairment">Speech Impairment</option>
              <option value="Intellectual Disability">Intellectual Disability</option>
              <option value="Psychosocial Disability">Psychosocial Disability</option>
              <option value="Learning Disability">Learning Disability</option>
              <option value="Multiple Disabilities">Multiple Disabilities</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Card 2: Educational & Economic Status -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Educational & Economic Status</h5>
        </div>
        <div class="form-grid">
          <div>
            <label>Educational Attainment</label>
            <select id="edit_educationalAttainment" class="animated">
              <option value="">Select...</option>
              <option value="No Formal Education">No Formal Education</option>
              <option value="Elementary Level">Elementary Level</option>
              <option value="Elementary Graduate">Elementary Graduate</option>
              <option value="High School Level">High School Level</option>
              <option value="High School Graduate">High School Graduate</option>
              <option value="Senior High School Level">Senior High School Level</option>
              <option value="Senior High School Graduate">Senior High School Graduate</option>
              <option value="College Level">College Level</option>
              <option value="College Graduate">College Graduate</option>
            </select>
          </div>

          <div id="edit_collegeCourseField" class="conditional-field">
            <label>College Graduate Course</label>
            <input type="text" id="edit_collegeCourse" placeholder="Enter course name" />
            <div class="small-muted">Please input the official college course acronym only (e.g., BSIT, BSCS, BSA, BSEd–Math).</div>
          </div>

          <div>
            <label>Employment</label>
            <select id="edit_employment" class="animated">
              <option value="">Select...</option>
              <option value="Employed">Employed</option>
              <option value="Unemployed">Unemployed</option>
            </select>
          </div>

          <div id="edit_jobTitleField" class="conditional-field">
            <label>Job Title</label>
            <select id="edit_jobTitle" class="animated">
              <option value="">Select...</option>
              <optgroup label="Office & Administrative Jobs">
                <option>Administrative Assistant / Admin Staff</option>
                <option>Office Clerk</option>
                <option>Secretary / Executive Assistant</option>
              </optgroup>
              <optgroup label="Business & Management">
                <option>Project Manager</option>
                <option>Operations Manager</option>
                <option>HR Staff / HR Officer</option>
                <option>Account Manager</option>
              </optgroup>
              <optgroup label="Accounting & Finance">
                <option>Accounting Staff</option>
                <option>Bookkeeper</option>
                <option>Payroll Officer</option>
                <option>Auditor</option>
              </optgroup>
              <optgroup label="IT & Tech">
                <option>IT Support / IT Technician</option>
                <option>Web Developer</option>
                <option>Software Developer / Programmer</option>
                <option>Data Analyst</option>
                <option>System Administrator</option>
              </optgroup>
              <optgroup label="Healthcare">
                <option>Nurse (Staff Nurse / Company Nurse)</option>
                <option>Medical Technologist</option>
                <option>Caregiver</option>
                <option>Pharmacist</option>
              </optgroup>
              <optgroup label="Education">
                <option>Teacher / Instructor</option>
                <option>Tutor</option>
                <option>School Administrator</option>
              </optgroup>
              <optgroup label="Sales & Customer Service">
                <option>Customer Service Representative (CSR)</option>
                <option>Sales Associate</option>
                <option>Cashier</option>
                <option>Store Supervisor</option>
              </optgroup>
              <optgroup label="Skilled Work & Labor">
                <option>Electrician</option>
                <option>Plumber</option>
                <option>Welder</option>
                <option>Construction Worker / Skilled Laborer</option>
              </optgroup>
              <optgroup label="Delivery & Logistics">
                <option>Driver (Company Driver / Delivery Driver)</option>
                <option>Logistics Staff</option>
                <option>Rider / Motorcycle Delivery</option>
              </optgroup>
              <optgroup label="Food & Hospitality">
                <option>Cook / Chef</option>
                <option>Waiter / Service Crew</option>
                <option>Barista</option>
                <option>Housekeeping Staff</option>
              </optgroup>
              <optgroup label="Security & Public Service">
                <option>Security Guard</option>
                <option>Barangay Staff / Barangay Council Employee</option>
                <option>Police Officer</option>
                <option>Fire Officer</option>
              </optgroup>
              <optgroup label="Media, Design & Creative">
                <option>Graphic Designer</option>
                <option>Video Editor</option>
                <option>Content Writer</option>
                <option>Social Media Manager</option>
              </optgroup>
              <option>Others</option>
            </select>
          </div>

          <div>
            <label>Overseas Filipino Worker (OFW)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="edit_ofw_status" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="edit_ofw_status" value="No"> No</label>
            </div>
          </div>

          <div id="edit_countryField" class="conditional-field">
            <label>Country</label>
            <select id="edit_country" class="animated">
              <option value="">Select...</option>
              <option>Saudi Arabia</option>
              <option>United Arab Emirates (UAE)</option>
              <option>Qatar</option>
              <option>Kuwait</option>
              <option>Bahrain</option>
              <option>Oman</option>
              <option>Hong Kong</option>
              <option>Singapore</option>
              <option>Japan</option>
              <option>Taiwan</option>
              <option>Malaysia</option>
              <option>Australia</option>
              <option>New Zealand</option>
              <option>Italy</option>
              <option>United Kingdom (UK)</option>
              <option>Germany</option>
              <option>Cyprus</option>
              <option>Canada</option>
              <option>United States (USA)</option>
              <option>Libya</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Card 3: UPDATED Health and Status (PWD removed) -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Health and Status</h5>
        </div>
        <div class="form-grid">
          <div style="grid-column: 1 / -1;">
            <label>Status</label>
            <select id="edit_head_status" class="animated">
              <option value="">Select...</option>
              <optgroup label="Common Sickness">
                <option value="Cough and colds">Cough and colds</option>
                <option value="Fever">Fever</option>
                <option value="Headache">Headache</option>
                <option value="Diarrhea">Diarrhea</option>
                <option value="Stomach ache / Hyperacidity">Stomach ache / Hyperacidity</option>
                <option value="Skin disease (rashes, fungal infection)">Skin disease (rashes, fungal infection)</option>
                <option value="Urinary Tract Infection (UTI)">Urinary Tract Infection (UTI)</option>
              </optgroup>
              <optgroup label="Severe Illness">
                <option value="Hypertension">Hypertension</option>
                <option value="Heart Disease">Heart Disease</option>
                <option value="Stroke">Stroke</option>
                <option value="Diabetes Mellitus">Diabetes Mellitus</option>
                <option value="Cancer">Cancer</option>
                <option value="Tuberculosis (TB)">Tuberculosis (TB)</option>
                <option value="Chronic Kidney Disease">Chronic Kidney Disease</option>
                <option value="Severe Asthma / COPD">Severe Asthma / COPD</option>
                <option value="Others">Others</option>
              </optgroup>
            </select>
          </div>
          
          <!-- Others textbox for Status field -->
          <div id="edit_statusOthersField" class="conditional-field" style="grid-column: 1 / -1;">
            <label>Specify Other Status</label>
            <input type="text" id="edit_statusOthers" placeholder="Please specify the status..." />
            <div class="small-muted">This value will be saved in the Status field instead of "Others".</div>
          </div>
        </div>
      </div>

      <!-- Card 4: Domestic Livestock -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Domestic Livestock</h5>
        </div>
        <div class="domestic-grid">
          <div class="animal-card">
            <div class="animal-header">
              <label class="checkbox-item1"><input type="checkbox" id="edit_dog_chk"> <span style="font-size: 1.2rem;">🐕</span> Dog</label>
            </div>
            <div class="animal-qty">
              <label>Quantity:</label>
              <input type="number" id="edit_dog_qty" class="qty" min="0" placeholder="0" />
            </div>
          </div>

          <div class="animal-card">
            <div class="animal-header">
              <label class="checkbox-item1"><input type="checkbox" id="edit_cat_chk"> <span style="font-size: 1.2rem;">🐈</span> Cat</label>
            </div>
            <div class="animal-qty">
              <label>Quantity:</label>
              <input type="number" id="edit_cat_qty" class="qty" min="0" placeholder="0" />
            </div>
          </div>

          <div class="animal-card">
            <div class="animal-header">
              <label class="checkbox-item1"><input type="checkbox" id="edit_pig_chk"> <span style="font-size: 1.2rem;">🐖</span> Pig</label>
            </div>
            <div class="animal-qty">
              <label>Quantity:</label>
              <input type="number" id="edit_pig_qty" class="qty" min="0" placeholder="0" />
            </div>
          </div>

          <div class="animal-card">
            <div class="animal-header">
              <label class="checkbox-item1"><input type="checkbox" id="edit_cow_chk"> <span style="font-size: 1.2rem;">🐄</span> Cow</label>
            </div>
            <div class="animal-qty">
              <label>Quantity:</label>
              <input type="number" id="edit_cow_qty" class="qty" min="0" placeholder="0" />
            </div>
          </div>

          <div class="animal-card">
            <div class="animal-header">
              <label class="checkbox-item1"><input type="checkbox" id="edit_carabao_chk"> <span style="font-size: 1.2rem;">🐃</span> Carabao</label>
            </div>
            <div class="animal-qty">
              <label>Quantity:</label>
              <input type="number" id="edit_carabao_qty" class="qty" min="0" placeholder="0" />
            </div>
          </div>

          <div class="animal-card">
            <div class="animal-header">
              <label class="checkbox-item1"><input type="checkbox" id="edit_chicken_chk"> <span style="font-size: 1.2rem;">🐔</span> Chicken</label>
            </div>
            <div class="animal-qty">
              <label>Quantity:</label>
              <input type="number" id="edit_chicken_qty" class="qty" min="0" placeholder="0" />
            </div>
          </div>
        </div>

        <div style="margin-top: 12px;">
          <label>Others</label>
          <textarea id="edit_animals_others" class="others-box" placeholder="Use this field to describe other animals owned in a brief sentence (e.g., '5 goats and 2 ducks')."></textarea>
        </div>
      </div>

      <!-- Card 5: FIXED Transportation & Evacuation Details -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Transportation & Evacuation Details</h5>
        </div>
        <div class="form-grid">
          <!-- FIXED: Reason for Displacement - Checkboxes -->
          <div style="grid-column: 1 / -1;">
            <label style="margin-bottom: 0;">Reason for Displacement</label>
            <div class="small-muted1">Please check (✓) all items that apply.</div>
            <div class="displacement-checkbox-container">
              <div class="displacement-checkbox-item">
                <input type="checkbox" id="edit_displacement_taal" class="edit_displacement-reason" value="Taal Volcano (Within 14-15 KM Danger Zone)">
                <label for="edit_displacement_taal">Taal Volcano (Within 14-15 KM Danger Zone)</label>
              </div>
              <div class="displacement-checkbox-item">
                <input type="checkbox" id="edit_displacement_typhoon" class="edit_displacement-reason" value="Typhoon">
                <label for="edit_displacement_typhoon">Typhoon</label>
              </div>
              <div class="displacement-checkbox-item">
                <input type="checkbox" id="edit_displacement_flood" class="edit_displacement-reason" value="Flood">
                <label for="edit_displacement_flood">Flood</label>
              </div>
              <div class="displacement-checkbox-item">
                <input type="checkbox" id="edit_displacement_landslide" class="edit_displacement-reason" value="Landslide">
                <label for="edit_displacement_landslide">Landslide</label>
              </div>
              <div class="displacement-checkbox-item">
                <input type="checkbox" id="edit_displacement_earthquake" class="edit_displacement-reason" value="Earthquake">
                <label for="edit_displacement_earthquake">Earthquake</label>
              </div>
              <div class="displacement-checkbox-item">
                <input type="checkbox" id="edit_displacement_fire" class="edit_displacement-reason" value="Fire">
                <label for="edit_displacement_fire">Fire</label>
              </div>
            </div>
            
            <!-- FIXED: Other Reason checkbox -->
            <div class="displacement-checkbox-item" style="margin-top: 12px;">
              <input type="checkbox" id="edit_displacement_other_check">
              <label for="edit_displacement_other_check">Other Reason</label>
            </div>
            
            <div id="edit_displacementOtherField" class="conditional-field" style="margin-top: 8px;">
              <input type="text" id="edit_displacement_other" placeholder="Please specify other reason for displacement..." />
              <div class="small-muted">This will be used when none of the listed reasons apply.</div>
            </div>
          </div>

          <!-- Assembly Area Options -->
          <div id="edit_assemblyAreaOptions" class="conditional-field" style="grid-column: 1 / -1; display: none;">
            <label>Assembly Area</label>
            <div style="display: flex; gap: 20px;">
              <div class="displacement-checkbox-item">
                <input type="checkbox" id="edit_inside_assembly" class="edit_assembly-option">
                <label for="edit_inside_assembly">Inside Assembly Area</label>
              </div>
              <div class="displacement-checkbox-item">
                <input type="checkbox" id="edit_outside_assembly" class="edit_assembly-option">
                <label for="edit_outside_assembly">Outside Assembly Area</label>
              </div>
            </div>
          </div>

          <!-- Inside Assembly Area Fields -->
          <div id="edit_insideAssemblyFields" class="conditional-field" style="grid-column: 1 / -1; display: none;">
            <div class="form-grid" style="margin-top: 12px;">
              <div>
                <label>Pick-Up Location</label>
                <input type="text" id="edit_pickup" />
              </div>
              
              <div>
                <label>Assembly Area</label>
                <input type="text" id="edit_assembly_area" placeholder="Replacement for Drop-Off Location" />
              </div>
              
              <div>
                <label>Transportation</label>
                <select id="edit_head_transport" class="animated">
                  <option value="">Select...</option>
                  <option>Has Transportation</option>
                  <option>Needs Transportation</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Outside Assembly Area Fields -->
          <div id="edit_outsideAssemblyFields" class="conditional-field" style="grid-column: 1 / -1; display: none;">
            <div class="form-grid" style="margin-top: 12px;">
              <div>
                <label>Family/Relative Host</label>
                <input type="text" id="edit_family_host" />
              </div>
              
              <div>
                <label>Contact No.</label>
                <input type="text" id="edit_host_contact" placeholder="Host contact number" />
              </div>
              
              <div>
                <label>Transportation</label>
                <select id="edit_outside_transport" class="animated">
                  <option value="">Select...</option>
                  <option>Has Transportation</option>
                  <option>Needs Transportation</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Old fields (hidden) -->
          <div style="display: none;">
            <input type="text" id="edit_dropoff" />
            <input type="text" id="edit_campName" />
            <input type="number" id="edit_capacity" min="0" />
            <input type="number" id="edit_insideCamp" min="0" />
            <input type="number" id="edit_outsideCamp" min="0"/>
            <select id="edit_reasons" class="animated">
              <option value="">Select...</option>
              <option>Taal Volcano (Within 14-15 KM Danger Zone)</option>
              <option>Typhoon</option>
              <option>Flood</option>
              <option>Landslide</option>
              <option>Earthquake</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Card 6: Government Assistance Programs WITH DATE FIELDS -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Government Assistance Programs</h5>
        </div>
        
        <div class="gov-support-grid">
          <!-- TUPAD with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="edit_ass_tupad">
            <label for="edit_ass_tupad">TUPAD</label>
            <div id="edit_ass_tupad_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="edit_ass_tupad_date_input">
            </div>
          </div>
          
          <!-- Local 4Ps with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="edit_ass_local4ps">
            <label for="edit_ass_local4ps">Local 4Ps</label>
            <div id="edit_ass_local4ps_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="edit_ass_local4ps_date_input">
            </div>
          </div>
          
          <!-- National 4Ps with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="edit_ass_intl4ps">
            <label for="edit_ass_intl4ps">National 4Ps</label>
            <div id="edit_ass_intl4ps_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="edit_ass_intl4ps_date_input">
            </div>
          </div>
          
          <!-- Local Social Pension with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="edit_ass_locsp">
            <label for="edit_ass_locsp">Local Social Pension</label>
            <div id="edit_ass_locsp_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="edit_ass_locsp_date_input">
            </div>
          </div>
          
          <!-- National Social Pension with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="edit_ass_intlsp">
            <label for="edit_ass_intlsp">National Social Pension</label>
            <div id="edit_ass_intlsp_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="edit_ass_intlsp_date_input">
            </div>
          </div>
          
          <!-- Solo Parent Assistance with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="edit_ass_solo">
            <label for="edit_ass_solo">Solo Parent Assistance</label>
            <div id="edit_ass_solo_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="edit_ass_solo_date_input">
            </div>
          </div>
          
          <!-- Relief Goods with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="edit_ass_relief">
            <label for="edit_ass_relief">Relief Goods</label>
            <div id="edit_ass_relief_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="edit_ass_relief_date_input">
            </div>
          </div>
          
          <!-- Cash Subsidy with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="edit_ass_cash">
            <label for="edit_ass_cash">Cash Subsidy</label>
            <div id="edit_ass_cash_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="edit_ass_cash_date_input">
            </div>
          </div>
        </div>

        <div style="margin-top:16px">
          <label>AICS (if any)</label>
          <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <select id="edit_ass_aics" class="animated" style="flex: 1; min-width: 200px;">
              <option value="">None</option>
              <option>Shelter Assistance</option>
              <option>Burial</option>
              <option>Scholarship</option>
            </select>
            <div id="edit_ass_aics_date" class="gov-date-field" style="margin-top: 0;">
              <label>Date:</label>
              <input type="date" id="edit_ass_aics_date_input">
            </div>
          </div>
        </div>
      </div>

      <!-- Card 7: Action Buttons -->
      <div class="edit-card">
        <div style="display:flex;gap:8px;justify-content:flex-end;">
          <button id="startSequenceBtn" class="btn">Next → Members (Start sequence)</button>
          <button id="saveEditBtn" class="btn">Save changes</button>
          <button id="cancelEditBtn" class="btn secondary1" type="button">Cancel</button>
        </div>
      </div>

      <!-- Card 8: Members Section -->
      <div class="edit-card">
        <h4>Members</h4>
        <div class="small-muted">Count: <strong id="edit_previewCount">0</strong></div>
        <ul id="edit_membersPreview" class="member-preview"></ul>
        <div style="display:flex;gap:8px; margin-top:10px; justify-content:flex-end;">
          <button id="edit_addMember" class="btn secondary" type="button">
            <i class="fas fa-user-plus"></i> Add / Edit Members
          </button>
          <button id="edit_removeMember" class="btn secondary" type="button" style="background: #f8d7da; color: #721c24; border-color: #f5c6cb;">
            <i class="fas fa-user-minus"></i> Remove Member
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- MEMBER SEQUENTIAL PANEL -->
<div id="memberPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Member entry panel">
  <div class="panel-header">
    <button id="memberPanelClose" class="btn secondary" title="Close panel">←</button>
    <h3 id="memberPanelTitle">Member 1 of N</h3>
  </div>

  <div class="panel-body">
    <div id="validationSummaryMember" class="validation-summary" role="alert" aria-live="polite">
      <h4><i class="fas fa-exclamation-triangle"></i> Required Fields – The following information must be provided before submission:</h4>
      <ul id="memberValidationErrors"></ul>
    </div>

    <form id="memberForm" onsubmit="return false;">
      <!-- Card 1: Basic Information -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Basic Information</h5>
        </div>
        <div class="form-grid">
          <div style="grid-column: 1 / -1;">
            <label>Household Member Full Name<span class="required">*</span></label>
            <input type="text" id="memberName" class="member-name" required />
          </div>

          <div style="grid-column: 1 / -1;">
            <div class="checkbox-item1" style="margin-top: 0px;">
              <input type="checkbox" id="memberRegisteredCheckbox">
              <label for="memberRegisteredCheckbox">FishR/RBIS Registered</label>
            </div>
            
            <div id="memberRegistrationField" class="conditional-field">
              <label>FishR Registered/RBIS Registered</label>
              <select id="memberRegistration" class="animated">
                <option value="">Select...</option>
                <option value="FishR Registered">FishR Registered</option>
                <option value="RBIS Registered">RBIS Registered</option>
                <option value="FishR & RBIS Registered">FishR & RBIS Registered</option>
              </select>
            </div>
          </div>

          <div>
            <label>Contact no. <span class="required">*</span></label>
            <input type="text" id="memberContact" placeholder="09XXXXXXXXX" required
                   pattern="^(09|\+639)\d{9}$" />
            <div class="error-message" id="memberContactError"></div>
          </div>

          <div>
            <label>Sex <span class="required">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="member_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="member_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate <span class="required">*</span></label>
            <input type="date" id="memberBirthdate" class="member-birthdate" required/>
          </div>

          <div>
            <label>Age</label>
            <input type="text" id="memberAge" class="member-age" readonly/>
          </div>

          <div>
            <label>Age Category</label>
            <input type="text" id="memberStage" class="member-stage" readonly/>
          </div>

          <!-- FIXED: Member Additional Information -->
          <div style="grid-column: 1 / -1;">
            <label>Additional Information</label>
            <div class="small-muted" style="margin-bottom: 8px;">Please check (✓) all items that apply.</div>
            <div class="member-additional-info-checkbox-container">
              <div class="member-additional-info-checkbox-item">
                <input type="checkbox" id="member_soloParenting" class="member-additional">
                <label for="member_soloParenting">Solo Parenting</label>
              </div>
              <div class="member-additional-info-checkbox-item">
                <input type="checkbox" id="member_lgbt" class="member-additional">
                <label for="member_lgbt">LGBT</label>
              </div>
              <div class="member-additional-info-checkbox-item">
                <input type="checkbox" id="member_lactating" class="member-additional">
                <label for="member_lactating">Lactating</label>
              </div>
              <div class="member-additional-info-checkbox-item">
                <input type="checkbox" id="member_pregnant" class="member-additional">
                <label for="member_pregnant">Pregnant</label>
              </div>
            </div>
          </div>

          <!-- MOVED: Member Persons with Disability (PWD) -->
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="member_pwd" value="Yes" id="member_pwdYes"> Yes</label>
              <label class="radio-item"><input type="radio" name="member_pwd" value="No" id="member_pwdNo" checked> No</label>
            </div>
          </div>

          <!-- NEW: Member Type of Disability Dropdown -->
          <div id="memberDisabilityTypeField" class="conditional-field" style="grid-column: 1 / -1;">
            <label>Type of Disability</label>
            <select id="memberDisabilityType" class="animated">
              <option value="">Select type of disability...</option>
              <option value="Physical Disability">Physical Disability</option>
              <option value="Visual Disability">Visual Disability</option>
              <option value="Hearing Disability">Hearing Disability</option>
              <option value="Speech Impairment">Speech Impairment</option>
              <option value="Intellectual Disability">Intellectual Disability</option>
              <option value="Psychosocial Disability">Psychosocial Disability</option>
              <option value="Learning Disability">Learning Disability</option>
              <option value="Multiple Disabilities">Multiple Disabilities</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Card 2: Educational & Economic Status -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Educational & Economic Status</h5>
        </div>
        <div class="form-grid">
          <div>
            <label>Educational Attainment</label>
            <select id="memberEducationalAttainment" class="member-educational animated">
              <option value="">Select...</option>
              <option value="No Formal Education">No Formal Education</option>
              <option value="Elementary Level">Elementary Level</option>
              <option value="Elementary Graduate">Elementary Graduate</option>
              <option value="High School Level">High School Level</option>
              <option value="High School Graduate">High School Graduate</option>
              <option value="Senior High School Level">Senior High School Level</option>
              <option value="Senior High School Graduate">Senior High School Graduate</option>
              <option value="College Level">College Level</option>
              <option value="College Graduate">College Graduate</option>
            </select>
          </div>

          <div id="memberCollegeCourseField" class="conditional-field">
            <label>College Graduate Course</label>
            <input type="text" id="memberCollegeCourse" placeholder="Enter course name" />
            <div class="small-muted">Please input the official college course acronym only (e.g., BSIT, BSCS, BSA, BSEd–Math).</div>
          </div>

          <div>
            <label>Employment</label>
            <select id="memberEmployment" class="member-employment animated">
              <option value="">Select...</option>
              <option value="Employed">Employed</option>
              <option value="Unemployed">Unemployed</option>
            </select>
          </div>

          <div id="memberJobTitleField" class="conditional-field">
            <label>Job Title</label>
            <select id="memberJobTitle" class="member-jobtitle animated">
              <option value="">Select...</option>
              <optgroup label="Office & Administrative Jobs">
                <option>Administrative Assistant / Admin Staff</option>
                <option>Office Clerk</option>
                <option>Secretary / Executive Assistant</option>
              </optgroup>
              <optgroup label="Business & Management">
                <option>Project Manager</option>
                <option>Operations Manager</option>
                <option>HR Staff / HR Officer</option>
                <option>Account Manager</option>
              </optgroup>
              <optgroup label="Accounting & Finance">
                <option>Accounting Staff</option>
                <option>Bookkeeper</option>
                <option>Payroll Officer</option>
                <option>Auditor</option>
              </optgroup>
              <optgroup label="IT & Tech">
                <option>IT Support / IT Technician</option>
                <option>Web Developer</option>
                <option>Software Developer / Programmer</option>
                <option>Data Analyst</option>
                <option>System Administrator</option>
              </optgroup>
              <optgroup label="Healthcare">
                <option>Nurse (Staff Nurse / Company Nurse)</option>
                <option>Medical Technologist</option>
                <option>Caregiver</option>
                <option>Pharmacist</option>
              </optgroup>
              <optgroup label="Education">
                <option>Teacher / Instructor</option>
                <option>Tutor</option>
                <option>School Administrator</option>
              </optgroup>
              <optgroup label="Sales & Customer Service">
                <option>Customer Service Representative (CSR)</option>
                <option>Sales Associate</option>
                <option>Cashier</option>
                <option>Store Supervisor</option>
              </optgroup>
              <optgroup label="Skilled Work & Labor">
                <option>Electrician</option>
                <option>Plumber</option>
                <option>Welder</option>
                <option>Construction Worker / Skilled Laborer</option>
              </optgroup>
              <optgroup label="Delivery & Logistics">
                <option>Driver (Company Driver / Delivery Driver)</option>
                <option>Logistics Staff</option>
                <option>Rider / Motorcycle Delivery</option>
              </optgroup>
              <optgroup label="Food & Hospitality">
                <option>Cook / Chef</option>
                <option>Waiter / Service Crew</option>
                <option>Barista</option>
                <option>Housekeeping Staff</option>
              </optgroup>
              <optgroup label="Security & Public Service">
                <option>Security Guard</option>
                <option>Barangay Staff / Barangay Council Employee</option>
                <option>Police Officer</option>
                <option>Fire Officer</option>
              </optgroup>
              <optgroup label="Media, Design & Creative">
                <option>Graphic Designer</option>
                <option>Video Editor</option>
                <option>Content Writer</option>
                <option>Social Media Manager</option>
              </optgroup>
              <option>Others</option>
            </select>
          </div>

          <div>
            <label>Overseas Filipino Worker (OFW)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="member_ofw_status" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="member_ofw_status" value="No" checked> No</label>
            </div>
          </div>

          <div id="memberCountryField" class="conditional-field">
            <label>Country</label>
            <select id="memberCountry" class="member-country animated">
              <option value="">Select...</option>
              <option>Saudi Arabia</option>
              <option>United Arab Emirates (UAE)</option>
              <option>Qatar</option>
              <option>Kuwait</option>
              <option>Bahrain</option>
              <option>Oman</option>
              <option>Hong Kong</option>
              <option>Singapore</option>
              <option>Japan</option>
              <option>Taiwan</option>
              <option>Malaysia</option>
              <option>Australia</option>
              <option>New Zealand</option>
              <option>Italy</option>
              <option>United Kingdom (UK)</option>
              <option>Germany</option>
              <option>Cyprus</option>
              <option>Canada</option>
              <option>United States (USA)</option>
              <option>Libya</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Card 3: UPDATED Health and Status (PWD removed) -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Health and Status</h5>
        </div>
        <div class="form-grid">
          <div style="grid-column: 1 / -1;">
            <label>Status</label>
            <select id="memberStatus" class="member-status animated">
              <option value="">Select...</option>
              <optgroup label="Common Sickness">
                <option value="Cough and colds">Cough and colds</option>
                <option value="Fever">Fever</option>
                <option value="Headache">Headache</option>
                <option value="Diarrhea">Diarrhea</option>
                <option value="Stomach ache / Hyperacidity">Stomach ache / Hyperacidity</option>
                <option value="Skin disease (rashes, fungal infection)">Skin disease (rashes, fungal infection)</option>
                <option value="Urinary Tract Infection (UTI)">Urinary Tract Infection (UTI)</option>
              </optgroup>
              <optgroup label="Severe Illness">
                <option value="Hypertension">Hypertension</option>
                <option value="Heart Disease">Heart Disease</option>
                <option value="Stroke">Stroke</option>
                <option value="Diabetes Mellitus">Diabetes Mellitus</option>
                <option value="Cancer">Cancer</option>
                <option value="Tuberculosis (TB)">Tuberculosis (TB)</option>
                <option value="Chronic Kidney Disease">Chronic Kidney Disease</option>
                <option value="Severe Asthma / COPD">Severe Asthma / COPD</option>
                <option value="Others">Others</option>
              </optgroup>
            </select>
          </div>
          
          <!-- Others textbox for Member Status field -->
          <div id="memberStatusOthersField" class="conditional-field" style="grid-column: 1 / -1;">
            <label>Specify Other Status</label>
            <input type="text" id="memberStatusOthers" placeholder="Please specify the status..." />
            <div class="small-muted">This value will be saved in the Status field instead of "Others".</div>
          </div>
        </div>
      </div>

      <!-- Card 4: FIXED Transportation & Evacuation Details -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Transportation & Evacuation Details</h5>
        </div>
        <div class="form-grid">
          <!-- FIXED: Member Reason for Displacement - Checkboxes -->
          <div style="grid-column: 1 / -1;">
            <label>Reason for Displacement</label>
            <div class="small-muted" style="margin-bottom: 8px;">Please check (✓) all items that apply.</div>
            <div class="member-displacement-checkbox-container">
              <div class="member-displacement-checkbox-item">
                <input type="checkbox" id="member_displacement_taal" class="member-displacement-reason" value="Taal Volcano (Within 14-15 KM Danger Zone)">
                <label for="member_displacement_taal">Taal Volcano (Within 14-15 KM Danger Zone)</label>
              </div>
              <div class="member-displacement-checkbox-item">
                <input type="checkbox" id="member_displacement_typhoon" class="member-displacement-reason" value="Typhoon">
                <label for="member_displacement_typhoon">Typhoon</label>
              </div>
              <div class="member-displacement-checkbox-item">
                <input type="checkbox" id="member_displacement_flood" class="member-displacement-reason" value="Flood">
                <label for="member_displacement_flood">Flood</label>
              </div>
              <div class="member-displacement-checkbox-item">
                <input type="checkbox" id="member_displacement_landslide" class="member-displacement-reason" value="Landslide">
                <label for="member_displacement_landslide">Landslide</label>
              </div>
              <div class="member-displacement-checkbox-item">
                <input type="checkbox" id="member_displacement_earthquake" class="member-displacement-reason" value="Earthquake">
                <label for="member_displacement_earthquake">Earthquake</label>
              </div>
              <div class="member-displacement-checkbox-item">
                <input type="checkbox" id="member_displacement_fire" class="member-displacement-reason" value="Fire">
                <label for="member_displacement_fire">Fire</label>
              </div>
            </div>
            
            <!-- FIXED: Other Reason checkbox for member -->
            <div class="member-displacement-checkbox-item" style="margin-top: 12px;">
              <input type="checkbox" id="member_displacement_other_check">
              <label for="member_displacement_other_check">Other Reason</label>
            </div>
            
            <div id="memberDisplacementOtherField" class="conditional-field" style="margin-top: 8px;">
              <input type="text" id="member_displacement_other" placeholder="Please specify other reason for displacement..." />
              <div class="small-muted">This will be used when none of the listed reasons apply.</div>
            </div>
          </div>

          <!-- Member Assembly Area Options -->
          <div id="memberAssemblyAreaOptions" class="conditional-field" style="grid-column: 1 / -1; margin-top: 16px; display: none;">
            <label>Assembly Area</label>
            <div style="display: flex; gap: 20px; margin-top: 8px;">
              <div class="member-displacement-checkbox-item">
                <input type="checkbox" id="member_inside_assembly" class="member-assembly-option">
                <label for="member_inside_assembly">Inside Assembly Area</label>
              </div>
              <div class="member-displacement-checkbox-item">
                <input type="checkbox" id="member_outside_assembly" class="member-assembly-option">
                <label for="member_outside_assembly">Outside Assembly Area</label>
              </div>
            </div>
          </div>

          <!-- Member Inside Assembly Area Fields -->
          <div id="memberInsideAssemblyFields" class="conditional-field" style="grid-column: 1 / -1; display: none;">
            <div class="form-grid" style="margin-top: 12px;">
              <div>
                <label>Pick-Up Location</label>
                <input id="memberPickup" class="member-pickup"/>
              </div>
              
              <div>
                <label>Assembly Area</label>
                <input id="memberAssemblyArea" class="member-assembly-area" placeholder="Replacement for Drop-Off Location" />
              </div>
              
              <div>
                <label>Transportation</label>
                <select id="memberTransport" class="member-transport animated">
                  <option value="">Select...</option>
                  <option>Has Transportation</option>
                  <option>Needs Transportation</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Member Outside Assembly Area Fields -->
          <div id="memberOutsideAssemblyFields" class="conditional-field" style="grid-column: 1 / -1; display: none;">
            <div class="form-grid" style="margin-top: 12px;">
              <div>
                <label>Family/Relative Host</label>
                <input id="memberFamilyHost" class="member-family-host"/>
              </div>
              
              <div>
                <label>Contact No.</label>
                <input id="memberHostContact" class="member-host-contact" placeholder="Host contact number" />
              </div>
              
              <div>
                <label>Transportation</label>
                <select id="memberOutsideTransport" class="member-outside-transport animated">
                  <option value="">Select...</option>
                  <option>Has Transportation</option>
                  <option>Needs Transportation</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Old member fields (initially hidden) -->
          <div style="display: none;">
            <input id="memberDropoff" class="member-dropoff"/>
            <input id="memberCamp" class="member-camp"/>
            <input type="number" id="memberCampCap" class="member-cap" min="0"/>
            <input type="number" id="memberInside" class="member-inside" min="0"/>
            <input type="number" id="memberOutside" class="member-outside" min="0"/>
            <select id="memberReason" class="member-reason animated">
              <option value="">Select...</option>
              <option>Taal Volcano (Within 14-15 KM Danger Zone)</option>
              <option>Typhoon</option>
              <option>Flood</option>
              <option>Landslide</option>
              <option>Earthquake</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Card 5: Government Assistance Programs WITH DATES -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Government Assistance Programs</h5>
        </div>
        <div class="gov-support-grid">
          <!-- TUPAD with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="member_tupad" class="member_tupad">
            <label for="member_tupad">TUPAD</label>
            <div id="member_tupad_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="member_tupad_date_input" class="member_tupad_date_input">
            </div>
          </div>
          
          <!-- Local 4Ps with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="member_local4ps" class="member_local4ps">
            <label for="member_local4ps">Local 4Ps</label>
            <div id="member_local4ps_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="member_local4ps_date_input" class="member_local4ps_date_input">
            </div>
          </div>
          
          <!-- National 4Ps with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="member_intl4ps" class="member_intl4ps">
            <label for="member_intl4ps">National 4Ps</label>
            <div id="member_intl4ps_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="member_intl4ps_date_input" class="member_intl4ps_date_input">
            </div>
          </div>
          
          <!-- Local Social Pension with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="member_locsp" class="member_locsp">
            <label for="member_locsp">Local Social Pension</label>
            <div id="member_locsp_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="member_locsp_date_input" class="member_locsp_date_input">
            </div>
          </div>
          
          <!-- National Social Pension with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="member_intlsp" class="member_intlsp">
            <label for="member_intlsp">National Social Pension</label>
            <div id="member_intlsp_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="member_intlsp_date_input" class="member_intlsp_date_input">
            </div>
          </div>
          
          <!-- Solo Parent Assistance with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="member_solo" class="member_solo">
            <label for="member_solo">Solo Parent Assistance</label>
            <div id="member_solo_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="member_solo_date_input" class="member_solo_date_input">
            </div>
          </div>
          
          <!-- Relief Goods with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="member_relief" class="member_relief">
            <label for="member_relief">Relief Goods</label>
            <div id="member_relief_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="member_relief_date_input" class="member_relief_date_input">
            </div>
          </div>
          
          <!-- Cash Subsidy with Date -->
          <div class="gov-checkbox-with-date">
            <input type="checkbox" id="member_cash" class="member_cash">
            <label for="member_cash">Cash Subsidy</label>
            <div id="member_cash_date" class="gov-date-field">
              <label>Date:</label>
              <input type="date" id="member_cash_date_input" class="member_cash_date_input">
            </div>
          </div>
        </div>

        <div style="margin-top:16px">
          <label>AICS (if any)</label>
          <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <select id="memberAics" class="member_aics animated" style="flex: 1; min-width: 200px;">
              <option value="">None</option>
              <option>Shelter Assistance</option>
              <option>Burial</option>
              <option>Scholarship</option>
            </select>
            <div id="member_aics_date" class="gov-date-field" style="margin-top: 0;">
              <label>Date:</label>
              <input type="date" id="member_aics_date_input" class="member_aics_date_input">
            </div>
          </div>
        </div>
      </div>

      <div class="panel-actions" style="margin-top:20px;">
        <button id="memberBack" class="btn btn secondary" type="button">Back</button>
        <button id="memberCancel" class="btn" type="button">Cancel</button>
        <button id="memberNext" class="btn" type="button">Save & Next</button>
      </div>
    </form>
  </div>
</div>

<!-- COORDINATE MODAL -->
<div id="coordinateModal" class="coordinate-modal">
  <div class="coordinate-modal-content">
    <h4>Set Household Coordinates</h4>
    
    <div style="margin-bottom: 16px;">
      <label>Coordinates <span class="required">*</span></label>
      <input type="text" id="modal_coordinate" class="modal-coordinate-input" 
             placeholder="e.g., 13.8651, 120.9278" />
      <div class="small-muted">Enter latitude and longitude separated by comma</div>
    </div>
    
    <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
      <div style="font-weight: 600; color: var(--accent1); margin-bottom: 8px;">
        <i class="fas fa-lightbulb"></i> How to get coordinates:
      </div>
      <div style="display: flex; gap: 16px; flex-wrap: wrap;">
        <button type="button" id="modal_getLocationBtn" class="btn secondary" style="flex: 1;">
          <i class="fas fa-map-marker-alt"></i> Get Current Location
        </button>
        <button type="button" id="modal_hazardHunterBtn" class="btn hazard-hunter" style="flex: 1;">
          <i class="fas fa-map-marked-alt"></i> Open Hazard Hunter
        </button>
      </div>
    </div>
    
    <div class="modal-coordinate-actions">
      <button id="modal_cancelBtn" class="btn secondary" type="button">Cancel</button>
      <button id="modal_saveBtn" class="btn" type="button">Save Coordinates</button>
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div id="loading">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div>Loading records…</div>
  </div>
</div>
<!-- MODALS FROM DATAFORM.HTML -->
<!-- Reset Confirmation Modal - Updated Structure -->
<div id="resetConfirmationModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-warning">
    <div class="modal-header">
      <h3><i class="fas fa-exclamation-triangle"></i> Reset Form</h3>
    </div>
    <div class="modal-body">
      <div class="modal-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <p>Are you sure you want to reset the edit form? All entered changes will be permanently lost.</p>
    </div>
    <div class="modal-actions">
      <button id="cancelReset" class="btn btn-secondary">Cancel</button>
      <button id="confirmReset" class="btn btn-reset">
        <i class="fas fa-redo"></i> Reset Form
      </button>
    </div>
  </div>
</div>

<!-- Save Confirmation Modal -->
<div id="saveConfirmationModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-info">
    <div class="modal-header">
      <h3><i class="fas fa-save"></i> Save Data</h3>
    </div>
    <div class="modal-body">
      <div class="modal-icon">
        <i class="fas fa-save"></i>
      </div>
      <p>Are you ready to save the household data? This action cannot be undone.</p>
    </div>
    <div class="modal-actions">
      <button id="cancelSave" class="btn btn-secondary">Cancel</button>
      <button id="confirmSave" class="btn">
        <i class="fas fa-check"></i> Save Data
      </button>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-success">
    <div class="modal-header">
      <h3><i class="fas fa-check-circle"></i> Success!</h3>
    </div>
    <div class="modal-body">
      <div class="modal-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <p id="successMessage">Operation completed successfully.</p>
    </div>
    <div class="modal-actions">
      <button id="closeSuccess" class="btn">
        <i class="fas fa-check"></i> OK
      </button>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-error">
    <div class="modal-header">
      <h3><i class="fas fa-exclamation-circle"></i> Error</h3>
    </div>
    <div class="modal-body">
      <div class="modal-icon">
        <i class="fas fa-exclamation-circle"></i>
      </div>
      <p id="errorMessage">An error occurred.</p>
    </div>
    <div class="modal-actions">
      <button id="closeError" class="btn btn-secondary">
        <i class="fas fa-times"></i> Close
      </button>
    </div>
  </div>
</div>

<!-- Info Modal -->
<div id="infoModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-info">
    <div class="modal-header">
      <h3><i class="fas fa-info-circle"></i> Information</h3>
    </div>
    <div class="modal-body">
      <div class="modal-icon">
        <i class="fas fa-info-circle"></i>
      </div>
      <p id="infoMessage">Information message.</p>
    </div>
    <div class="modal-actions">
      <button id="closeInfo" class="btn">
        <i class="fas fa-check"></i> OK
      </button>
    </div>
  </div>
</div>

<!-- Remove Member Modal -->
<div id="removeMemberModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-warning">
    <div class="modal-header">
      <h3><i class="fas fa-user-minus"></i> Remove Member</h3>
    </div>
    <div class="modal-body">
      <div class="modal-icon">
        <i class="fas fa-user-minus"></i>
      </div>
      <p id="removeMemberMessage">Enter the number of the member to remove (1-<span id="memberTotalCount">0</span>):</p>
      <input type="number" id="memberToRemove" class="search-box" style="width: 120px; text-align: center;" 
             min="1" max="1" placeholder="Enter number" />
      <div class="small-muted" style="margin-top: 8px;">Members:</div>
      <div id="currentMembersList"></div>
    </div>
    <div class="modal-actions">
      <button id="cancelRemoveMember" class="btn btn-secondary">Cancel</button>
      <button id="confirmRemoveMember" class="btn btn-reset">
        <i class="fas fa-user-minus"></i> Remove Member
      </button>
    </div>
  </div>
</div>

<!-- Delete Member Confirmation Modal -->
<div id="deleteMemberConfirmationModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-error">
    <div class="modal-header">
      <h3><i class="fas fa-user-times"></i> Delete Member</h3>
    </div>
    <div class="modal-body">
      <div class="modal-icon">
        <i class="fas fa-user-times"></i>
      </div>
      <p id="deleteMemberMessage">Are you sure you want to delete this member?</p>
    </div>
    <div class="modal-actions">
      <button id="cancelDeleteMember" class="btn btn-secondary">Cancel</button>
      <button id="confirmDeleteMember" class="btn btn-reset">
        <i class="fas fa-trash"></i> Delete Member
      </button>
    </div>
  </div>
</div>

<!-- Delete Household Confirmation Modal -->
<div id="deleteConfirmationModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-error">
    <div class="modal-header">
      <h3><i class="fas fa-trash-alt"></i> Delete Household</h3>
    </div>
    <div class="modal-body">
      <div class="modal-icon">
        <i class="fas fa-trash-alt"></i>
      </div>
      <p id="deleteMessage">Are you sure you want to delete this household?</p>
    </div>
    <div class="modal-actions">
      <button id="cancelDelete" class="btn btn-secondary">Cancel</button>
<button id="confirmDelete" class="btn btn-reset">
  <i class="fas fa-trash" id="deleteIcon"></i>
  <span id="deleteText">Delete Household</span>
  <div id="deleteSpinner" class="loading-spinner-small" style="display: none;"></div>
</button>
    </div>
  </div>
</div>

<!-- Edit Confirmation Modal -->
<div id="editConfirmationModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-warning">
    <div class="modal-header">
      <h3><i class="fas fa-exclamation-triangle"></i> Unsaved Changes</h3>
    </div>
    <div class="modal-body">
      <div class="modal-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <p id="editMessage">You have unsaved changes. Are you sure you want to close the edit panel?</p>
    </div>
    <div class="modal-actions">
      <button id="cancelEditClose" class="btn btn-secondary">Cancel</button>
      <button id="confirmEditClose" class="btn btn-reset">
        <i class="fas fa-times"></i> Discard Changes
      </button>
    </div>
  </div>
</div>
<!-- Mobile Bottom Navigation - Fixed Position -->
<nav class="mobile-bottom-nav" id="mobileBottomNav">
  <div class="mobile-nav-items">
    <a href="dashboard.html" class="mobile-nav-item" title="Dashboard">
      <span class="mobile-nav-icon">📊</span>
      <span class="mobile-nav-text">Dashboard</span>
    </a>
    <a href="dataForm.html" class="mobile-nav-item" title="Data Entry">
      <span class="mobile-nav-icon">📝</span>
      <span class="mobile-nav-text">Data Entry</span>
    </a>
    <a href="records.html" class="mobile-nav-item active" title="Records">
      <span class="mobile-nav-icon">📁</span>
      <span class="mobile-nav-text">Records</span>
    </a>
    <a href="charts.html" class="mobile-nav-item" title="Charts">
      <span class="mobile-nav-icon">📈</span>
      <span class="mobile-nav-text">Charts</span>
    </a>
    <a href="users.html" class="mobile-nav-item admin-only" title="Users" id="mobileUsersNav">
      <span class="mobile-nav-icon">👥</span>
      <span class="mobile-nav-text">Users</span>
    </a>
  </div>
</nav>
<script>
/* ============ CONFIG ============ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";
const HAZARD_HUNTER_URL = "https://hazardhunter.georisk.gov.ph/map#";

/* ============ IMPROVED MODAL MANAGEMENT ============ */
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden', 'false');
        
        // Add click-outside-to-close functionality
        setTimeout(() => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    hideModal(modalId);
                }
            });
        }, 10);
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
    }
}

// Also add ESC key to close modals
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const openModals = document.querySelectorAll('.modal[style*="display: flex"]');
        openModals.forEach(modal => {
            hideModal(modal.id);
        });
    }
});

/* Setup activity tracking for records/data entry pages */
function setupActivityTrackingForPages() {
    console.log('Setting up activity tracking for this page');
    
    // Listen for storage events (from other tabs/pages)
    window.addEventListener('storage', function(e) {
        console.log('Storage event detected on records page:', e.key);
        
        // Check if this is an activity-related update
        if (e.key === 'activityLog' || e.key === 'recentActivity' || 
            e.key === 'activityUpdateTrigger' || e.key?.startsWith('activityUpdate_')) {
            
            console.log('Activity update detected from another tab');
            
            // If we need to sync something on this page, do it here
            // For example, refresh data if needed
            if (e.key === 'activityUpdateTrigger' && typeof loadRecords === 'function') {
                console.log('Refreshing records due to activity update');
                setTimeout(() => {
                    if (typeof loadRecords === 'function') {
                        loadRecords();
                    }
                }, 1000);
            }
        }
    });
    
    // Listen for BroadcastChannel messages if supported
    if (typeof BroadcastChannel !== 'undefined') {
        try {
            const channel = new BroadcastChannel('dashboard_activities');
            channel.onmessage = function(event) {
                console.log('BroadcastChannel message received on records page:', event.data);
                // Handle messages if needed
            };
        } catch(err) {
            console.log('BroadcastChannel setup failed on records page:', err);
        }
    }
    
    // Listen for postMessage
    window.addEventListener('message', function(event) {
        // Check origin for security
        // if (event.origin !== window.location.origin) return;
        
        if (event.data && event.data.type === 'activity') {
            console.log('Activity message received on records page:', event.data);
            // Handle if needed
        }
    });
}

/* Function to record activity when actions happen on this page */
function recordPageActivity(action, details = '') {
    console.log(`Recording page activity: ${action}`);
    
    // Use the function from activity-tracking-final.js
    if (typeof recordActivityFromOtherPage === 'function') {
        recordActivityFromOtherPage(action, details);
    } else if (typeof window.recordActivityFromOtherPage === 'function') {
        window.recordActivityFromOtherPage(action, details);
    } else if (typeof recordUserActivity === 'function') {
        recordUserActivity(action, details);
    } else if (typeof window.recordUserActivity === 'function') {
        window.recordUserActivity(action, details);
    } else {
        console.warn('No activity recording function available');
        // Fallback: direct localStorage update
        try {
            const username = localStorage.getItem('staffName') || localStorage.getItem('username') || 'Unknown User';
            const timestamp = new Date().toISOString();
            
            const activity = {
                action: action,
                actor: username,
                details: details,
                timestamp: timestamp
            };
            
            const activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
            activityLog.push(activity);
            
            if (activityLog.length > 20) {
                activityLog.splice(0, activityLog.length - 20);
            }
            
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
            localStorage.setItem('recentActivity', JSON.stringify(activity));
            localStorage.setItem('activityUpdateTrigger', Date.now().toString());
            
            console.log('Activity recorded via fallback method');
        } catch(err) {
            console.error('Fallback activity recording failed:', err);
        }
    }
}

/* ============ MODAL HANDLERS SETUP ============ */
function setupModalHandlers() {
  console.log("Setting up modal handlers");
  
  // Delete Confirmation Modal
  const deleteModal = document.getElementById('deleteConfirmationModal');
  const cancelDeleteBtn = document.getElementById('cancelDelete');
  const confirmDeleteBtn = document.getElementById('confirmDelete');

  if (deleteModal) {
    if (cancelDeleteBtn) {
      cancelDeleteBtn.addEventListener('click', () => {
        hideModal('deleteConfirmationModal');
        deletePendingId = null;
        deletePendingHeadName = '';
        deletePendingBarangay = '';
      });
    }

    if (confirmDeleteBtn) {
      confirmDeleteBtn.addEventListener('click', () => {
        performDelete();
      });
    }

    deleteModal.addEventListener('click', (e) => {
      if (e.target === deleteModal) {
        hideModal('deleteConfirmationModal');
        deletePendingId = null;
        deletePendingHeadName = '';
        deletePendingBarangay = '';
      }
    });
  }

  // Edit Confirmation Modal
  const editModal = document.getElementById('editConfirmationModal');
  const cancelEditCloseBtn = document.getElementById('cancelEditClose');
  const confirmEditCloseBtn = document.getElementById('confirmEditClose');

  if (editModal) {
    if (cancelEditCloseBtn) {
      cancelEditCloseBtn.addEventListener('click', cancelEditClose);
    }

    if (confirmEditCloseBtn) {
      confirmEditCloseBtn.addEventListener('click', handleEditCloseConfirmation);
    }

    editModal.addEventListener('click', (e) => {
      if (e.target === editModal) {
        cancelEditClose();
      }
    });
  }

  // Success Modal
  const successModal = document.getElementById('successModal');
  const closeSuccessBtn = document.getElementById('closeSuccess');
  
  if (successModal) {
    if (closeSuccessBtn) {
      closeSuccessBtn.addEventListener('click', () => hideModal('successModal'));
    }
    
    successModal.addEventListener('click', (e) => {
      if (e.target === successModal) hideModal('successModal');
    });
  }
  
  // Error Modal
  const errorModal = document.getElementById('errorModal');
  const closeErrorBtn = document.getElementById('closeError');
  
  if (errorModal) {
    if (closeErrorBtn) {
      closeErrorBtn.addEventListener('click', () => hideModal('errorModal'));
    }
    
    errorModal.addEventListener('click', (e) => {
      if (e.target === errorModal) hideModal('errorModal');
    });
  }
  
  // Info Modal
  const infoModal = document.getElementById('infoModal');
  const closeInfoBtn = document.getElementById('closeInfo');
  
  if (infoModal) {
    if (closeInfoBtn) {
      closeInfoBtn.addEventListener('click', () => hideModal('infoModal'));
    }
    
    infoModal.addEventListener('click', (e) => {
      if (e.target === infoModal) hideModal('infoModal');
    });
  }

  // Reset Confirmation Modal
  const resetModal = document.getElementById('resetConfirmationModal');
  const cancelResetBtn = document.getElementById('cancelReset');
  const confirmResetBtn = document.getElementById('confirmReset');

  if (resetModal) {
    if (cancelResetBtn) {
      cancelResetBtn.addEventListener('click', () => hideModal('resetConfirmationModal'));
    }

    if (confirmResetBtn) {
      confirmResetBtn.addEventListener('click', handleResetConfirmation);
    }

    resetModal.addEventListener('click', (e) => {
      if (e.target === resetModal) hideModal('resetConfirmationModal');
    });
  }

  // Save Confirmation Modal
  const saveModal = document.getElementById('saveConfirmationModal');
  const cancelSaveBtn = document.getElementById('cancelSave');
  const confirmSaveBtn = document.getElementById('confirmSave');

  if (saveModal) {
    if (cancelSaveBtn) {
      cancelSaveBtn.addEventListener('click', () => hideModal('saveConfirmationModal'));
    }

    if (confirmSaveBtn) {
      confirmSaveBtn.addEventListener('click', handleSaveConfirmation);
    }

    saveModal.addEventListener('click', (e) => {
      if (e.target === saveModal) hideModal('saveConfirmationModal');
    });
  }

  // Remove Member Modal
  const removeMemberModal = document.getElementById('removeMemberModal');
  const cancelRemoveMemberBtn = document.getElementById('cancelRemoveMember');
  const confirmRemoveMemberBtn = document.getElementById('confirmRemoveMember');

  if (removeMemberModal) {
    if (cancelRemoveMemberBtn) {
      cancelRemoveMemberBtn.addEventListener('click', () => {
        hideModal('removeMemberModal');
      });
    }

    if (confirmRemoveMemberBtn) {
      confirmRemoveMemberBtn.addEventListener('click', handleRemoveMemberFromModal);
    }

    // Handle Enter key in the input field
    const memberToRemoveInput = document.getElementById('memberToRemove');
    if (memberToRemoveInput) {
      memberToRemoveInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleRemoveMemberFromModal();
        }
      });
    }

    removeMemberModal.addEventListener('click', (e) => {
      if (e.target === removeMemberModal) {
        hideModal('removeMemberModal');
      }
    });
  }

  // Delete Member Confirmation Modal
  const deleteMemberModal = document.getElementById('deleteMemberConfirmationModal');
  const cancelDeleteMemberBtn = document.getElementById('cancelDeleteMember');
  const confirmDeleteMemberBtn = document.getElementById('confirmDeleteMember');

  if (deleteMemberModal) {
    if (cancelDeleteMemberBtn) {
      cancelDeleteMemberBtn.addEventListener('click', () => {
        hideModal('deleteMemberConfirmationModal');
        if (deleteMemberModal.dataset.memberIndex) {
          delete deleteMemberModal.dataset.memberIndex;
        }
      });
    }

    if (confirmDeleteMemberBtn) {
      confirmDeleteMemberBtn.addEventListener('click', performMemberDeletion);
    }

    deleteMemberModal.addEventListener('click', (e) => {
      if (e.target === deleteMemberModal) {
        hideModal('deleteMemberConfirmationModal');
        if (deleteMemberModal.dataset.memberIndex) {
          delete deleteMemberModal.dataset.memberIndex;
        }
      }
    });
  }
}


  // ============ RESET CONFIRMATION MODAL - WITH ACTUAL FUNCTIONALITY ============
  const resetModal = document.getElementById('resetConfirmationModal');
  const cancelResetBtn = document.getElementById('cancelReset');
  const confirmResetBtn = document.getElementById('confirmReset');

  if (resetModal) {
    if (cancelResetBtn) {
      cancelResetBtn.addEventListener('click', () => hideModal('resetConfirmationModal'));
    }

    if (confirmResetBtn) {
      confirmResetBtn.addEventListener('click', handleResetConfirmation);
    }

    resetModal.addEventListener('click', (e) => {
      if (e.target === resetModal) hideModal('resetConfirmationModal');
    });
  }

  // ============ SAVE CONFIRMATION MODAL - WITH ACTUAL FUNCTIONALITY ============
  const saveModal = document.getElementById('saveConfirmationModal');
  const cancelSaveBtn = document.getElementById('cancelSave');
  const confirmSaveBtn = document.getElementById('confirmSave');

  if (saveModal) {
    if (cancelSaveBtn) {
      cancelSaveBtn.addEventListener('click', () => hideModal('saveConfirmationModal'));
    }

    if (confirmSaveBtn) {
      confirmSaveBtn.addEventListener('click', handleSaveConfirmation);
    }

    saveModal.addEventListener('click', (e) => {
      if (e.target === saveModal) hideModal('saveConfirmationModal');
    });
  }

  /* ============ REMOVE MEMBER MODAL HANDLERS ============ */
  const removeMemberModal = document.getElementById('removeMemberModal');
  const cancelRemoveMemberBtn = document.getElementById('cancelRemoveMember');
  const confirmRemoveMemberBtn = document.getElementById('confirmRemoveMember');

  if (removeMemberModal) {
    if (cancelRemoveMemberBtn) {
      cancelRemoveMemberBtn.addEventListener('click', () => {
        hideModal('removeMemberModal');
      });
    }

    if (confirmRemoveMemberBtn) {
      confirmRemoveMemberBtn.addEventListener('click', handleRemoveMemberFromModal);
    }

    // Handle Enter key in the input field
    const memberToRemoveInput = document.getElementById('memberToRemove');
    if (memberToRemoveInput) {
      memberToRemoveInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleRemoveMemberFromModal();
        }
      });
    }

    removeMemberModal.addEventListener('click', (e) => {
      if (e.target === removeMemberModal) {
        hideModal('removeMemberModal');
      }
    });
  }

  // Delete Member Confirmation Modal
  const deleteMemberModal = document.getElementById('deleteMemberConfirmationModal');
  const cancelDeleteMemberBtn = document.getElementById('cancelDeleteMember');
  const confirmDeleteMemberBtn = document.getElementById('confirmDeleteMember');

  if (deleteMemberModal) {
    if (cancelDeleteMemberBtn) {
      cancelDeleteMemberBtn.addEventListener('click', () => {
        hideModal('deleteMemberConfirmationModal');
        if (deleteMemberModal.dataset.memberIndex) {
          delete deleteMemberModal.dataset.memberIndex;
        }
      });
    }

    if (confirmDeleteMemberBtn) {
      confirmDeleteMemberBtn.addEventListener('click', performMemberDeletion);
    }

    deleteMemberModal.addEventListener('click', (e) => {
      if (e.target === deleteMemberModal) {
        hideModal('deleteMemberConfirmationModal');
        if (deleteMemberModal.dataset.memberIndex) {
          delete deleteMemberModal.dataset.memberIndex;
        }
      }
    });
  }
  
  // ============ ADD ESC KEY SUPPORT FOR ALL MODALS ============
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const openModals = document.querySelectorAll('.modal[style*="display: flex"]');
      openModals.forEach(modal => {
        hideModal(modal.id);
      });
    }
  });

/* ============ MISSING MODAL FUNCTIONS - ADD THESE ============ */

// Reset Confirmation Modal Handler
function handleResetConfirmation() {
  console.log('Resetting form...');
  
  const editForm = document.getElementById('editForm');
  if (editForm) {
    editForm.reset();
    clearValidationErrors('editForm');
    editMembers = [];
    updateEditMembersPreview();
    
    const memberCountInput = document.getElementById('edit_memberCount');
    if (memberCountInput) {
      memberCountInput.value = 0;
    }
    
    closeEditPanel();
    showSuccess('Edit form has been reset successfully.');
  }
  
  hideModal('resetConfirmationModal');
}


// Save Confirmation Modal Handler
function handleSaveConfirmation() {
  console.log('Saving changes...');
  
  const saveBtn = document.getElementById('saveEditBtn');
  if (saveBtn) {
    saveBtn.click();
  }
  
  hideModal('saveConfirmationModal');
}

// Function to show reset confirmation (call this when reset button is clicked)
function showResetConfirmation() {
  if (hasUnsavedChanges()) {
    showModal('resetConfirmationModal');
  } else {
    handleResetConfirmation();
  }
}

// Function to show save confirmation (call this when save button is clicked)
function showSaveConfirmation() {
  if (!validateHeadFormForEdit()) {
    return;
  }
  
  if (editMembers.length > 0) {
    const invalidMembers = [];
    editMembers.forEach((member, index) => {
      if (!member['Name of Household Member/s'] || !member['Name of Household Member/s'].trim()) {
        invalidMembers.push(index + 1);
      }
    });
    
    if (invalidMembers.length > 0) {
      if (confirm(`Members #${invalidMembers.join(', ')} are missing names. Save anyway?`)) {
        handleSaveConfirmation();
      }
      return;
    }
  }
  
  showModal('saveConfirmationModal');
}
/* ============ MEMBER CANCEL FUNCTION ============ */
function handleMemberCancel() {
  const memberName = $('memberName')?.value?.trim();
  const memberContact = $('memberContact')?.value?.trim();
  const memberBirthdate = $('memberBirthdate')?.value;
  
  // Check if there are unsaved changes
  if (memberName || memberContact || memberBirthdate) {
    if(confirm('Cancel member entry? Unsaved changes will be lost.')) {
      // Remove the current member from editMembers array if it's empty
      removeEmptyMemberIfNeeded();
      // Clear the form and close
      clearMemberForm();
      $('memberPanel')?.classList.remove('open');
      // Update the preview
      updateEditMembersPreview();
    }
  } else {
    // No changes, just close - but still remove empty member
    removeEmptyMemberIfNeeded();
    clearMemberForm();
    $('memberPanel')?.classList.remove('open');
    updateEditMembersPreview();
  }
}
/* ============ REMOVE EMPTY MEMBER FUNCTION ============ */
function removeEmptyMemberIfNeeded() {
  // If we're editing an existing member (not adding new), don't remove
  if (memberEditIndex < editMembers.length - 1) {
    return;
  }
  
  // Get the current member being edited
  const currentMember = editMembers[memberEditIndex] || {};
  
  // Check if this member is empty (no name, contact, or birthdate)
  const isEmpty = !currentMember['Name of Household Member/s'] && 
                  !currentMember['Contact no.'] && 
                  !currentMember['Birthdate'];
  
  if (isEmpty) {
    // Remove the empty member from array
    editMembers.splice(memberEditIndex, 1);
    
    // Update member count input
    const currentCount = parseInt($('edit_memberCount').value) || 0;
    if (currentCount > 0) {
      $('edit_memberCount').value = currentCount - 1;
    }
  }
}
/* ============ CLEAR MEMBER FORM FUNCTION ============ */
function clearMemberForm() {
  // Clear all member form fields
  $('memberName').value = '';
  $('memberRegisteredCheckbox').checked = false;
  $('memberRegistrationField').classList.remove('show');
  $('memberRegistration').value = '';
  $('memberContact').value = '';
  qAll("input[name='member_sex']").forEach(r => r.checked = false);
  $('memberBirthdate').value = '';
  $('memberAge').value = '';
  $('memberStage').value = '';
  $('memberEducationalAttainment').value = '';
  $('memberCollegeCourseField').classList.remove('show');
  $('memberCollegeCourse').value = '';
  $('memberEmployment').value = '';
  $('memberJobTitleField').classList.remove('show');
  $('memberJobTitle').value = '';
  qAll("input[name='member_ofw_status']").forEach(r => {
    if (r.value === 'No') r.checked = true;
  });
  $('memberCountryField').classList.remove('show');
  $('memberCountry').value = '';
  qAll("input[name='member_pwd']").forEach(r => {
    if (r.value === 'No') r.checked = true;
  });
  $('memberStatus').value = '';
  $('memberTransport').value = '';
  $('memberPickup').value = '';
  $('memberDropoff').value = '';
  $('memberCamp').value = '';
  $('memberCampCap').value = '';
  $('memberInside').value = '';
  $('memberOutside').value = '';
  $('memberReason').value = '';
  
  // Clear government assistance fields
  const memberGovCheckboxes = [
    'member_tupad', 'member_local4ps', 'member_intl4ps',
    'member_locsp', 'member_intlsp', 'member_solo',
    'member_relief', 'member_cash'
  ];
  
  memberGovCheckboxes.forEach(checkboxId => {
    const checkbox = $(checkboxId);
    if (checkbox) checkbox.checked = false;
    
    const dateField = $(checkboxId + '_date');
    if (dateField) dateField.classList.remove('show');
    
    const dateInput = $(checkboxId + '_date_input');
    if (dateInput) dateInput.value = '';
  });
  
  $('memberAics').value = '';
  const memberAicsDateField = $('member_aics_date');
  if (memberAicsDateField) memberAicsDateField.classList.remove('show');
  
  const memberAicsDateInput = $('member_aics_date_input');
  if (memberAicsDateInput) memberAicsDateInput.value = '';
  
  // Clear validation
  clearValidationErrors('memberForm');
}
/* ============ NEW: ENHANCED REMOVE MEMBER FUNCTIONS WITH MODAL ============ */
function showRemoveMemberModal() {
  if (editMembers.length === 0) {
    showError('No members to remove.');
    return;
  }
  
  document.getElementById('memberTotalCount').textContent = editMembers.length;
  document.getElementById('memberToRemove').max = editMembers.length;
  document.getElementById('memberToRemove').min = 1;
  document.getElementById('memberToRemove').value = '';
  
  const membersList = document.getElementById('currentMembersList');
  membersList.innerHTML = '';
  
  editMembers.forEach((member, index) => {
    const memberName = member['Name of Household Member/s'] || 'Unnamed Member';
    const span = document.createElement('span');
    span.textContent = `${index + 1}. ${memberName}`;
    span.style.cursor = 'pointer';
    span.onclick = () => {
      document.getElementById('memberToRemove').value = index + 1;
      highlightSelectedMember(index);
    };
    membersList.appendChild(span);
  });
  
  setTimeout(() => {
    const allSpans = membersList.querySelectorAll('span');
    allSpans.forEach(span => {
      span.style.background = 'transparent';
      span.style.fontWeight = 'normal';
    });
  }, 100);
  
  showModal('removeMemberModal');
  
  setTimeout(() => {
    document.getElementById('memberToRemove').focus();
  }, 300);
}

function highlightSelectedMember(index) {
  const membersList = document.getElementById('currentMembersList');
  const allSpans = membersList.querySelectorAll('span');
  
  allSpans.forEach((span, i) => {
    if (i === index) {
      span.style.background = 'rgba(255,122,0,0.2)';
      span.style.fontWeight = 'bold';
    } else {
      span.style.background = 'transparent';
      span.style.fontWeight = 'normal';
    }
  });
}

function removeMemberByIndex(index) {
  if (index < 0 || index >= editMembers.length) {
    showError('Invalid member number.');
    return;
  }
  
  const memberName = editMembers[index]['Name of Household Member/s'] || 'Unnamed Member';
  
  // Set up the confirmation modal
  document.getElementById('deleteMemberMessage').textContent = 
    `Are you sure you want to delete member "${memberName}"? This action cannot be undone.`;
  
  showModal('deleteMemberConfirmationModal');
  
  // Store the index to be deleted
  const modal = document.getElementById('deleteMemberConfirmationModal');
  modal.dataset.memberIndex = index;
}

function performMemberDeletion() {
  const modal = document.getElementById('deleteMemberConfirmationModal');
  const index = parseInt(modal.dataset.memberIndex);
  
  if (isNaN(index) || index < 0 || index >= editMembers.length) {
    showError('Invalid member index.');
    hideModal('deleteMemberConfirmationModal');
    return;
  }
  
  const memberName = editMembers[index]['Name of Household Member/s'] || 'Unnamed Member';
  editMembers.splice(index, 1);
  
  // Update member count
  const currentCount = parseInt($('edit_memberCount').value) || 0;
  if (currentCount > 0) {
    $('edit_memberCount').value = currentCount - 1;
  }
  
  updateEditMembersPreview();
  
  hideModal('deleteMemberConfirmationModal');
  showSuccess(`Member "${memberName}" removed successfully.`);
  
  // Record activity
  recordPageActivity('Member Removed', `Removed member "${memberName}" from household ${editDataID}`);
}

function handleRemoveMemberFromModal() {
  const input = document.getElementById('memberToRemove');
  const memberNumber = parseInt(input.value);
  
  if (isNaN(memberNumber) || memberNumber < 1 || memberNumber > editMembers.length) {
    showError(`Please enter a valid number between 1 and ${editMembers.length}`);
    input.focus();
    return;
  }
  
  hideModal('removeMemberModal');
  
  // Show confirmation modal for the specific member
  removeMemberByIndex(memberNumber - 1);
}

// Update the existing removeMember function to use the modal
function removeMember(index) {
  removeMemberByIndex(index);
}

/* ============ KEYBOARD SHORTCUTS ============ */
function setupKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    // Don't trigger if user is typing in an input field
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
      return;
    }
    
    // Ctrl+Delete to open remove member modal when edit panel is open
    if (e.ctrlKey && e.key === 'Delete' && $('editPanel')?.classList.contains('open')) {
      e.preventDefault();
      showRemoveMemberModal();
    }
  });
}

/* ============ STATE ============ */
let header = [];
let rawRows = [];
let groups = [];
let filteredGroups = [];
let selected = new Set();
let currentPage = 1;
const rowsPerPage = 25;

/* ============ EDIT STATE ============ */
let editDataID = null;
let editHead = {};
let editMembers = [];
let memberEditIndex = 0;
let sequenceMode = false;

/* ============ UTIL ============ */
const $ = id => document.getElementById(id);
const q = sel => document.querySelector(sel);
const qAll = sel => Array.from(document.querySelectorAll(sel));

function showLoading(yes){ 
    document.getElementById("loading").style.display = yes ? "flex" : "none"; 
}

function highlight(text,q){
    text = String(text ?? "");
    if(!q) return text;
    const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");
    return text.replace(re, m => `<span class="hl">${m}</span>`);
}

/* ============ EDIT PANEL FUNCTIONS ============ */
function openEditPanel(){ 
    $('editPanel')?.classList.add('open'); 
    $('panelOverlay')?.classList.add('show'); 
}

function closeEditPanel(){ 
    $('editPanel')?.classList.remove('open'); 
    $('panelOverlay')?.classList.remove('show'); 
}

function resetEditState() {
  editDataID = null;
  editHead = {};
  editMembers = [];
  memberEditIndex = 0;
  sequenceMode = false;
}

/* ============ COORDINATE FUNCTIONS ============ */
function openCoordinateModal() {
  const modal = $('coordinateModal');
  const currentCoord = $('edit_coordinate').value || '';
  $('modal_coordinate').value = currentCoord;
  modal.classList.add('active');
}

function closeCoordinateModal() {
  $('coordinateModal').classList.remove('active');
}

function saveCoordinateFromModal() {
  const coord = $('modal_coordinate').value.trim();
  if (!coord) {
    alert('Please enter coordinates');
    return;
  }
  
  // Basic validation for coordinate format
  const coordRegex = /^-?\d+\.?\d*,\s*-?\d+\.?\d*$/;
  if (!coordRegex.test(coord)) {
    alert('Please enter valid coordinates in format: latitude, longitude\ne.g., 13.8651, 120.9278');
    return;
  }
  
  $('edit_coordinate').value = coord;
  closeCoordinateModal();
}

function getCurrentLocationForModal() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude.toFixed(6);
        const lng = pos.coords.longitude.toFixed(6);
        $('modal_coordinate').value = `${lat}, ${lng}`;
      },
      (err) => {
        alert('Unable to retrieve location. Please enable location services or enter coordinates manually.');
      }
    );
  } else {
    alert('Geolocation is not supported by your browser.');
  }
}

function openHazardHunterForModal() {
  alert('Open Hazard Hunter in another tab to get coordinates, then paste them in the coordinate field.');
  window.open(HAZARD_HUNTER_URL, '_blank');
}

// Add these functions to records.html
function setupRealTimeValidation() {
  // Head form fields
  const headRequiredFields = ['barangay', 'sitio', 'householdHead', 'contactNo', 'householdBirthdate', 'memberCount'];
  
  headRequiredFields.forEach(fieldId => {
    const field = document.getElementById('edit_' + fieldId); // Note: edit_ prefix
    if (field) {
      const validationFn = debounce(() => {
        if (field.value.trim()) {
          field.classList.remove('validation-error');
          const label = field.closest('div')?.querySelector('label');
          if (label) label.classList.remove('validation-error-label');
          removeHeadErrorByFieldId(fieldId);
        }
      }, 300);
      
      field.addEventListener('input', validationFn);
      if (field.tagName === 'SELECT') {
        field.addEventListener('change', validationFn);
      }
    }
  });
  
  // Head sex radio buttons
  const headSexRadios = document.querySelectorAll('input[name="edit_head_sex"]');
  headSexRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      const sexContainer = document.querySelector('.radio-line');
      if (sexContainer) sexContainer.classList.remove('validation-error');
      
      const sexLabel = document.querySelector('#editForm .form-grid > div:has(.radio-line) label');
      if (sexLabel) sexLabel.classList.remove('validation-error-label');
      
      removeHeadErrorByText('Sex is required');
    });
  });
  
  // Head contact number
  const contactInput = document.getElementById('edit_contactNo');
  if (contactInput) {
    contactInput.addEventListener('input', debounce(() => {
      if (contactInput.value.trim() && validatePhilippineMobileNumber(contactInput.value.trim())) {
        contactInput.classList.remove('validation-error', 'input-error');
        const contactError = document.getElementById('edit_contactError');
        if (contactError) contactError.style.display = 'none';
        removeHeadErrorByText('Please enter a valid Philippine mobile number');
      }
    }, 300));
  }
}
function setupEditGovernmentAssistanceDateHandlers() {
  // Head government assistance checkboxes
  const headGovCheckboxes = [
    { checkboxId: 'edit_ass_tupad', dateFieldId: 'edit_ass_tupad_date' },
    { checkboxId: 'edit_ass_local4ps', dateFieldId: 'edit_ass_local4ps_date' },
    { checkboxId: 'edit_ass_intl4ps', dateFieldId: 'edit_ass_intl4ps_date' },
    { checkboxId: 'edit_ass_locsp', dateFieldId: 'edit_ass_locsp_date' },
    { checkboxId: 'edit_ass_intlsp', dateFieldId: 'edit_ass_intlsp_date' },
    { checkboxId: 'edit_ass_solo', dateFieldId: 'edit_ass_solo_date' },
    { checkboxId: 'edit_ass_relief', dateFieldId: 'edit_ass_relief_date' },
    { checkboxId: 'edit_ass_cash', dateFieldId: 'edit_ass_cash_date' }
  ];
  
  headGovCheckboxes.forEach(item => {
    const checkbox = $(item.checkboxId);
    const dateField = $(item.dateFieldId);
    
    if (checkbox && dateField) {
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          dateField.classList.add('show');
        } else {
          dateField.classList.remove('show');
          // Clear date field when unchecked
          const dateInput = dateField.querySelector('input[type="date"]');
          if (dateInput) dateInput.value = '';
        }
      });
      
      // Initialize based on current state
      if (checkbox.checked) {
        dateField.classList.add('show');
      }
    }
  });
  
  // Head AICS dropdown
  const aicsSelect = $('edit_ass_aics');
  const aicsDateField = $('edit_ass_aics_date');
  
  if (aicsSelect && aicsDateField) {
    aicsSelect.addEventListener('change', function() {
      if (this.value && this.value !== "") {
        aicsDateField.classList.add('show');
      } else {
        aicsDateField.classList.remove('show');
        // Clear date field when set to none
        const dateInput = aicsDateField.querySelector('input[type="date"]');
        if (dateInput) dateInput.value = '';
      }
    });
    
    // Initialize based on current state
    if (aicsSelect.value && aicsSelect.value !== "") {
      aicsDateField.classList.add('show');
    }
  }
}

function setupMemberGovernmentAssistanceDateHandlers() {
  // Member government assistance checkboxes
  const memberGovCheckboxes = [
    { checkboxId: 'member_tupad', dateFieldId: 'member_tupad_date' },
    { checkboxId: 'member_local4ps', dateFieldId: 'member_local4ps_date' },
    { checkboxId: 'member_intl4ps', dateFieldId: 'member_intl4ps_date' },
    { checkboxId: 'member_locsp', dateFieldId: 'member_locsp_date' },
    { checkboxId: 'member_intlsp', dateFieldId: 'member_intlsp_date' },
    { checkboxId: 'member_solo', dateFieldId: 'member_solo_date' },
    { checkboxId: 'member_relief', dateFieldId: 'member_relief_date' },
    { checkboxId: 'member_cash', dateFieldId: 'member_cash_date' }
  ];
  
  memberGovCheckboxes.forEach(item => {
    const checkbox = $(item.checkboxId);
    const dateField = $(item.dateFieldId);
    
    if (checkbox && dateField) {
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          dateField.classList.add('show');
        } else {
          dateField.classList.remove('show');
          // Clear date field when unchecked
          const dateInput = dateField.querySelector('input[type="date"]');
          if (dateInput) dateInput.value = '';
        }
      });
      
      // Initialize based on current state
      if (checkbox.checked) {
        dateField.classList.add('show');
      }
    }
  });
  
  // Member AICS dropdown
  const memberAicsSelect = $('memberAics');
  const memberAicsDateField = $('member_aics_date');
  
  if (memberAicsSelect && memberAicsDateField) {
    memberAicsSelect.addEventListener('change', function() {
      if (this.value && this.value !== "") {
        memberAicsDateField.classList.add('show');
      } else {
        memberAicsDateField.classList.remove('show');
        // Clear date field when set to none
        const dateInput = memberAicsDateField.querySelector('input[type="date"]');
        if (dateInput) dateInput.value = '';
      }
    });
    
    // Initialize based on current state
    if (memberAicsSelect.value && memberAicsSelect.value !== "") {
      memberAicsDateField.classList.add('show');
    }
  }
}
function removeHeadErrorByText(errorText) {
  // Implementation from dataForm.html
  const errorsList = document.getElementById('headValidationErrors');
  if (!errorsList) return;
  
  const errors = Array.from(errorsList.querySelectorAll('li'));
  let found = false;
  
  errors.forEach(li => {
    if (li.textContent.includes(errorText)) {
      li.remove();
      found = true;
    }
  });
  
  if (found) {
    const remainingErrors = errorsList.querySelectorAll('li');
    const validationSummary = document.getElementById('validationSummaryHead');
    
    if (remainingErrors.length === 0 && validationSummary) {
      validationSummary.classList.remove('show');
    }
  }
}

function removeHeadErrorByFieldId(fieldId) {
  const fieldNameMap = {
    'barangay': 'Barangay',
    'sitio': 'Sitio / Purok',
    'householdHead': 'Household Head Full Name',
    'contactNo': 'Contact number',
    'householdBirthdate': 'Birthdate',
    'memberCount': 'No. of Household Member(s)'
  };
  
  if (fieldNameMap[fieldId]) {
    removeHeadErrorByText(fieldNameMap[fieldId]);
  }
}
/* ============ GET CURRENT LOCATION FUNCTION ============ */
function getCurrentLocation() {
  if (!navigator.geolocation) {
    alert("Geolocation is not supported by your browser.");
    return;
  }

  showLoading(true);

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      $('edit_coordinate').value = `${lat}, ${lng}`;
      showLoading(false);
      
      // Ask user if they want to verify on Hazard Hunter
      if (confirm("Location captured successfully!\n\nWould you like to verify this location on Hazard Hunter to check for hazards?")) {
        openHazardHunterVerification(lat, lng);
      }
    },
    (err) => {
      showLoading(false);
      alert("Unable to retrieve GPS location. Please allow location access or use the Hazard Hunter option.");
      console.error("GPS Error:", err);
    },
    {
      enableHighAccuracy: true,
      timeout: 8000,
      maximumAge: 0
    }
  );
}
/* ============ ENHANCED VALIDATION FUNCTIONS FROM DATAFORM.HTML ============ */
function validateHeadFormForEdit() {
  const requiredFields = [
    { id: 'edit_barangay', name: 'Barangay' },
    { id: 'edit_sitio', name: 'Sitio / Purok' },
    { id: 'edit_householdHead', name: 'Household Head Full Name' },
    { id: 'edit_contactNo', name: 'Contact no.' },
    { id: 'edit_householdBirthdate', name: 'Birthdate' },
    { id: 'edit_memberCount', name: 'No. of Household Member/s' }
  ];

  const sexRadios = document.querySelectorAll('input[name="edit_head_sex"]:checked');
  const contactInput = document.getElementById("edit_contactNo");
  const contactError = document.getElementById("edit_contactError");
  
  let errors = [];
  let hasErrors = false;

  clearValidationErrors('editForm');

  requiredFields.forEach(field => {
    const element = document.getElementById(field.id);
    if (element) {
      const value = element.value.trim();
      if (!value) {
        element.classList.add('validation-error');
        const label = element.closest('div')?.querySelector('label');
        if (label) label.classList.add('validation-error-label');
        errors.push(`${field.name} is required`);
        hasErrors = true;
      }
    }
  });

  if (sexRadios.length === 0) {
    const sexLabel = document.querySelector('label[for="edit_head_sex"]') || 
                     document.querySelector('.form-grid > div:has(.radio-line) label');
    
    if (sexLabel) {
      sexLabel.classList.add('validation-error-label');
    }
    errors.push('Sex is required');
    hasErrors = true;
  }

  if (contactInput && contactInput.value.trim()) {
    if (!validateContactInput(contactInput, contactError)) {
      errors.push('Please enter a valid Philippine mobile number (09XXXXXXXXX or +639XXXXXXXXX)');
      hasErrors = true;
    }
  }

  const validationSummary = document.getElementById('validationSummaryEdit');
  const errorsList = document.getElementById('editValidationErrors');
  
  if (hasErrors) {
    if (errorsList) {
      errorsList.innerHTML = '';
      errors.forEach(error => {
        const li = document.createElement('li');
        li.textContent = error;
        errorsList.appendChild(li);
      });
    }
    if (validationSummary) {
      validationSummary.classList.add('show'); // USE classList ONLY
      validationSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    return false;
  } else {
    if (validationSummary) {
      validationSummary.classList.remove('show'); // USE classList ONLY
    }
    return true;
  }
}

function validateMemberFormForEdit() {
  const requiredFields = [
    { id: 'memberName', name: 'Household Member Full Name' },
    { id: 'memberContact', name: 'Contact no.' },
    { id: 'memberBirthdate', name: 'Birthdate' }
  ];

  const sexRadios = document.querySelectorAll('input[name="member_sex"]:checked');
  const contactInput = document.getElementById("memberContact");
  const contactError = document.getElementById("memberContactError");
  
  let errors = [];
  let hasErrors = false;

  clearValidationErrors('memberForm');

  requiredFields.forEach(field => {
    const element = document.getElementById(field.id);
    if (element) {
      const value = element.value.trim();
      if (!value) {
        element.classList.add('validation-error');
        const label = element.closest('div')?.querySelector('label');
        if (label) label.classList.add('validation-error-label');
        errors.push(`${field.name} is required`);
        hasErrors = true;
      }
    }
  });

  if (sexRadios.length === 0) {
    const memberSexLabel = document.querySelector('#memberPanel label:has(+ .radio-line)') ||
                           document.querySelector('#memberForm .form-grid > div:has(.radio-line) label');
    
    if (memberSexLabel) {
      memberSexLabel.classList.add('validation-error-label');
    }
    errors.push('Sex is required');
    hasErrors = true;
  }

  if (contactInput && contactInput.value.trim()) {
    if (!validateContactInput(contactInput, contactError)) {
      errors.push('Please enter a valid Philippine mobile number (09XXXXXXXXX or +639XXXXXXXXX)');
      hasErrors = true;
    }
  }

const validationSummary = document.getElementById('validationSummaryMember');
const errorsList = document.getElementById('memberValidationErrors');

if (hasErrors) {
  if (errorsList) {
    errorsList.innerHTML = '';
    errors.forEach(error => {
      const li = document.createElement('li');
      li.textContent = error;
      errorsList.appendChild(li);
    });
  }
  if (validationSummary) {
    validationSummary.classList.add('show');  // USE classList
    validationSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
  return false;
} else {
  if (validationSummary) {
    validationSummary.classList.remove('show');  // USE classList
  }
  return true;
}
}
function clearValidationErrors(formId) {
  let elements;
  if (formId === 'editForm') {
    elements = document.querySelectorAll('#editForm input, #editForm select, #editForm textarea');
    const sexContainer = document.querySelector('.radio-line');
    if (sexContainer) sexContainer.classList.remove('validation-error');
    
    const sexLabel = document.querySelector('#editForm .form-grid > div:has(.radio-line) label');
    if (sexLabel) sexLabel.classList.remove('validation-error-label');
    
    document.querySelectorAll('#editForm label').forEach(label => {
      label.classList.remove('validation-error-label');
    });
    
    // IMPORTANT: Hide the validation summary
    const validationSummary = document.getElementById('validationSummaryEdit');
    if (validationSummary) {
      validationSummary.classList.remove('show');
    }
    
  } else if (formId === 'memberForm') {
    elements = document.querySelectorAll('#memberForm input, #memberForm select, #memberForm textarea');
    const sexContainer = document.querySelectorAll('.radio-line')[1];
    if (sexContainer) sexContainer.classList.remove('validation-error');
    
    const memberSexLabel = document.querySelector('#memberForm .form-grid > div:has(.radio-line) label');
    if (memberSexLabel) memberSexLabel.classList.remove('validation-error-label');
    
    document.querySelectorAll('#memberForm label').forEach(label => {
      label.classList.remove('validation-error-label');
    });
    
    // IMPORTANT: Hide the member validation summary
    const validationSummary = document.getElementById('validationSummaryMember');
    if (validationSummary) {
      validationSummary.classList.remove('show');
    }
  }
  
  elements.forEach(element => {
    element.classList.remove('validation-error');
  });
}

/* ============ SUCCESS/ERROR MODAL FUNCTIONS ============ */
function showSuccess(message) {
  const messageEl = document.getElementById('successMessage');
  if (messageEl) messageEl.textContent = message;
  showModal('successModal');
}

function showError(message) {
  const messageEl = document.getElementById('errorMessage');
  if (messageEl) messageEl.textContent = message;
  showModal('errorModal');
}

function showInfo(message) {
  const messageEl = document.getElementById('infoMessage');
  if (messageEl) messageEl.textContent = message;
  showModal('infoModal');
}

function setupRealTimeValidationForEdit() {
  // Head form fields
  const headRequiredFields = ['edit_barangay', 'edit_sitio', 'edit_householdHead', 'edit_contactNo', 'edit_householdBirthdate', 'edit_memberCount'];
  
  headRequiredFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      const validationFn = debounce(() => {
        if (field.value.trim()) {
          field.classList.remove('validation-error');
          const label = field.closest('div')?.querySelector('label');
          if (label) label.classList.remove('validation-error-label');
          removeEditErrorByFieldId(fieldId);
        }
      }, 300);
      
      field.addEventListener('input', validationFn);
      if (field.tagName === 'SELECT') {
        field.addEventListener('change', validationFn);
      }
    }
  });
  
  // Head sex radio buttons
  const headSexRadios = document.querySelectorAll('input[name="edit_head_sex"]');
  headSexRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      const sexContainer = document.querySelector('.radio-line');
      if (sexContainer) sexContainer.classList.remove('validation-error');
      
      const sexLabel = document.querySelector('#editForm .form-grid > div:has(.radio-line) label');
      if (sexLabel) sexLabel.classList.remove('validation-error-label');
      
      removeEditErrorByText('Sex is required');
    });
  });
  
  // Head contact number
  const contactInput = document.getElementById('edit_contactNo');
  if (contactInput) {
    contactInput.addEventListener('input', debounce(() => {
      if (contactInput.value.trim() && validatePhilippineMobileNumber(contactInput.value.trim())) {
        contactInput.classList.remove('validation-error', 'input-error');
        const contactError = document.getElementById('edit_contactError');
        if (contactError) contactError.style.display = 'none';
        removeEditErrorByText('Please enter a valid Philippine mobile number');
      }
    }, 300));
  }
}

function removeEditErrorByFieldId(fieldId) {
  const fieldNameMap = {
    'edit_barangay': 'Barangay',
    'edit_sitio': 'Sitio / Purok',
    'edit_householdHead': 'Household Head Full Name',
    'edit_contactNo': 'Contact number',
    'edit_householdBirthdate': 'Birthdate',
    'edit_memberCount': 'No. of Household Member(s)'
  };
  
  if (fieldNameMap[fieldId]) {
    removeEditErrorByText(fieldNameMap[fieldId]);
  }
}

function removeEditErrorByText(errorText) {
  const errorsList = document.getElementById('editValidationErrors');
  if (!errorsList) return;
  
  const errors = Array.from(errorsList.querySelectorAll('li'));
  let found = false;
  
  errors.forEach(li => {
    if (li.textContent.includes(errorText)) {
      li.remove();
      found = true;
    }
  });
  
  if (found) {
    const remainingErrors = errorsList.querySelectorAll('li');
    const validationSummary = document.getElementById('validationSummaryEdit');
    
    // FIX: Only hide when no errors remain AND ensure we use classList
    if (remainingErrors.length === 0) {
      if (validationSummary) {
        validationSummary.classList.remove('show'); // Use classList only
      }
    }
  }
}

/* ============ HAZARD HUNTER FUNCTIONS ============ */
function openHazardHunterPicker() {
  // Store current form data temporarily
  const formData = {
    barangay: $('edit_barangay').value,
    sitio: $('edit_sitio').value,
    householdHead: $('edit_householdHead').value,
    contactNo: $('edit_contactNo').value,
  };
  
  // Store in sessionStorage so we can retrieve it when we come back
  sessionStorage.setItem('tempFormData', JSON.stringify(formData));
  sessionStorage.setItem('awaitingCoordinates', 'true');
  
  // Show instructions
  alert('Hazard Hunter will open in a new tab.\n\nInstructions:\n1. Navigate to the desired location\n2. Click on the map to get coordinates\n3. Copy the coordinates (latitude, longitude)\n4. Return to this tab and paste them in the coordinate field');
  
  // Open Hazard Hunter in new tab
  window.open(HAZARD_HUNTER_URL, '_blank');
}

function openHazardHunterVerification(lat, lng) {
  // Hazard Hunter URL format for specific coordinates
  const verificationUrl = `${HAZARD_HUNTER_URL}?lat=${lat}&lng=${lng}`;
  
  // Store that we're in verification mode
  sessionStorage.setItem('verifyingCoordinates', 'true');
  sessionStorage.setItem('originalCoordinates', `${lat}, ${lng}`);
  
  // Open in new tab
  window.open(verificationUrl, '_blank');
  
  alert("Hazard Hunter opened with your location.\n\nYou can check for hazards and update coordinates if needed.\n\nReturn to this tab and update the coordinates field if necessary.");
}

/* ============ DATE FORMATTING FUNCTIONS ============ */
function toInputDate(val){
  if(!val && val !== 0) return '';
  
  val = String(val).trim();
  console.log("toInputDate() INPUT:", val);
  
  // Handle dates like "2025-30-11" (yyyy-dd-mm)
  if(/^\d{4}-\d{2}-\d{2}$/.test(val)) {
    const [y, part1, part2] = val.split('-');
    const p1 = parseInt(part1);
    
    // If first part > 12, it's yyyy-dd-mm
    if(p1 > 12) {
      // Swap to yyyy-mm-dd
      const result = `${y}-${String(part2).padStart(2,'0')}-${String(part1).padStart(2,'0')}`;
      console.log("FIXED yyyy-dd-mm to yyyy-mm-dd:", val, "->", result);
      return result;
    }
    return val;
  }
  
  // Handle slash-separated dates
  if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(val)){
    const parts = val.split('/');
    const first = parseInt(parts[0]);
    const second = parseInt(parts[1]);
    
    // FORCE CONVERSION to mm/dd/yyyy interpretation
    // If first > 12, it's currently dd/mm/yyyy -> swap to mm/dd/yyyy
    if(first > 12) {
      // Currently dd/mm/yyyy, need mm/dd/yyyy -> swap parts
      const m = parts[1].padStart(2,'0');  // Month is second part
      const d = parts[0].padStart(2,'0');  // Day is first part  
      const y = parts[2];
      const result = `${y}-${m}-${d}`;
      console.log("SWAPPED dd/mm/yyyy to mm/dd/yyyy (as yyyy-mm-dd):", val, "->", result);
      return result;
    }
    
    // Otherwise assume it's already mm/dd/yyyy
    const m = parts[0].padStart(2,'0');
    const d = parts[1].padStart(2,'0');
    const y = parts[2];
    const result = `${y}-${m}-${d}`;
    console.log("Already mm/dd/yyyy to yyyy-mm-dd:", val, "->", result);
    return result;
  }
  
  // Try Date object
  const dt = new Date(val);
  if(!isNaN(dt)){
    const y = dt.getFullYear();
    const m = String(dt.getMonth() + 1).padStart(2, '0');
    const d = String(dt.getDate()).padStart(2, '0');
    const result = `${y}-${m}-${d}`;
    console.log("Parsed via Date object:", val, "->", result);
    return result;
  }
  
  console.warn("Could not parse date:", val);
  return '';
}

function toSheetDate(inputVal){
  if(!inputVal) return '';
  
  console.log("toSheetDate() INPUT:", inputVal);
  
  // If it's already in mm/dd/yyyy format
  if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(inputVal)) {
    // Verify it's actually mm/dd/yyyy (first part <= 12)
    const parts = inputVal.split('/');
    if(parseInt(parts[0]) <= 12) {
      console.log("Already mm/dd/yyyy:", inputVal);
      return inputVal;
    }
  }
  
  // If it's in yyyy-mm-dd format (from HTML date input)
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputVal)){
    const [y, m, d] = inputVal.split('-');
    const result = `${m}/${d}/${y}`;  // Convert to mm/dd/yyyy
    console.log("Converted yyyy-mm-dd to mm/dd/yyyy:", inputVal, "->", result);
    return result;
  }
  
  // Try parsing as Date
  const dt = new Date(inputVal);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth() + 1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    const result = `${mm}/${dd}/${dt.getFullYear()}`;  // mm/dd/yyyy
    console.log("Parsed Date to mm/dd/yyyy:", inputVal, "->", result);
    return result;
  }
  
  console.warn("toSheetDate() could not parse:", inputVal);
  return '';
}
/* ============ CONTACT NUMBER FOR DISPLAY ============ */
function formatContactForDisplay(contact) {
  if (!contact) return '';
  
  // If already formatted, return as is
  if (contact.includes(' ')) return contact;
  
  // Remove all non-digit characters
  let cleaned = contact.replace(/\D/g, '');
  
  // Format: 09XX XXX XXXX
  if (cleaned.length === 11 && cleaned.startsWith('09')) {
    return cleaned.replace(/(\d{4})(\d{3})(\d{4})/, '$1 $2 $3');
  }
  
  // Format: +63 XXX XXX XXXX
  if (cleaned.length === 12 && cleaned.startsWith('63')) {
    return '+63 ' + cleaned.substring(2).replace(/(\d{3})(\d{3})(\d{4})/, '$1 $2 $3');
  }
  
  // Return original if can't format
  return contact;
}
function computeAgeDetailed(inputDateValue){
  if(!inputDateValue) return null;
  let d;
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputDateValue)){
    const parts = inputDateValue.split('-');
    d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
  } else {
    d = new Date(inputDateValue);
  }
  if(isNaN(d)) return null;

  const now = new Date();
  const birth = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  let years = today.getFullYear() - birth.getFullYear();
  let months = today.getMonth() - birth.getMonth();
  let days = today.getDate() - birth.getDate();

  if(days < 0){
    months -= 1;
    const prev = new Date(today.getFullYear(), today.getMonth(), 0);
    days += prev.getDate();
  }
  if(months < 0){
    years -= 1;
    months += 12;
  }

  let display = "";
  if(years >= 1){
    display = String(years);
  } else {
    if(months >= 1) display = `${months} month(s)`;
    else display = `${days} day(s)`;
  }

  let stage = "";
  if(years === 0){
    if(months <= 10) stage = "Infant";
    else stage = "Children";
  } else if(years <= 17) stage = "School Children";
  else if(years >= 60) stage = "Elderly";
  else stage = "Adult";

  return { years, months, days, display, stage };
}
/* ============ INITIALIZE GOVERNMENT ASSISTANCE DATE FIELDS ============ */
function initializeGovernmentAssistanceDateFields() {
  console.log("Initializing government assistance date fields...");
  
  // Head government assistance date fields
  const headGovCheckboxes = [
    'edit_ass_tupad',
    'edit_ass_local4ps', 
    'edit_ass_intl4ps',
    'edit_ass_locsp',
    'edit_ass_intlsp',
    'edit_ass_solo',
    'edit_ass_relief',
    'edit_ass_cash'
  ];
  
  headGovCheckboxes.forEach(fieldId => {
    const checkbox = $(fieldId);
    const dateField = $(fieldId + '_date');
    
    if (checkbox && dateField) {
      // Set initial state
      if (checkbox.checked) {
        dateField.classList.add('show');
      }
      
      // Add event listener
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          dateField.classList.add('show');
        } else {
          dateField.classList.remove('show');
          // Clear date field when unchecked
          const dateInput = dateField.querySelector('input[type="date"]');
          if (dateInput) dateInput.value = '';
        }
      });
    }
  });
  
  // Head AICS field
  const aicsSelect = $('edit_ass_aics');
  const aicsDateField = $('edit_ass_aics_date');
  
  if (aicsSelect && aicsDateField) {
    // Set initial state
    if (aicsSelect.value && aicsSelect.value !== "") {
      aicsDateField.classList.add('show');
    }
    
    // Add event listener
    aicsSelect.addEventListener('change', function() {
      if (this.value && this.value !== "") {
        aicsDateField.classList.add('show');
      } else {
        aicsDateField.classList.remove('show');
        const dateInput = aicsDateField.querySelector('input[type="date"]');
        if (dateInput) dateInput.value = '';
      }
    });
  }
  
  // Member government assistance date fields
  const memberGovCheckboxes = [
    'member_tupad',
    'member_local4ps',
    'member_intl4ps',
    'member_locsp',
    'member_intlsp',
    'member_solo',
    'member_relief',
    'member_cash'
  ];
  
  memberGovCheckboxes.forEach(fieldId => {
    const checkbox = $(fieldId);
    const dateField = $(fieldId + '_date');
    
    if (checkbox && dateField) {
      // Set initial state
      if (checkbox.checked) {
        dateField.classList.add('show');
      }
      
      // Add event listener
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          dateField.classList.add('show');
        } else {
          dateField.classList.remove('show');
          const dateInput = dateField.querySelector('input[type="date"]');
          if (dateInput) dateInput.value = '';
        }
      });
    }
  });
  
  // Member AICS field
  const memberAicsSelect = $('memberAics');
  const memberAicsDateField = $('member_aics_date');
  
  if (memberAicsSelect && memberAicsDateField) {
    // Set initial state
    if (memberAicsSelect.value && memberAicsSelect.value !== "") {
      memberAicsDateField.classList.add('show');
    }
    
    // Add event listener
    memberAicsSelect.addEventListener('change', function() {
      if (this.value && this.value !== "") {
        memberAicsDateField.classList.add('show');
      } else {
        memberAicsDateField.classList.remove('show');
        const dateInput = memberAicsDateField.querySelector('input[type="date"]');
        if (dateInput) dateInput.value = '';
      }
    });
  }
}
  
  // Member government assistance date fields
  const memberGovFields = [
    'member_tupad',
    'member_local4ps',
    'member_intl4ps',
    'member_locsp',
    'member_intlsp',
    'member_solo',
    'member_relief',
    'member_cash'
  ];
  
  memberGovFields.forEach(fieldId => {
    const checkbox = $(fieldId);
    const dateField = $(fieldId + '_date');
    
    if (checkbox && dateField) {
      // Set initial state
      if (checkbox.checked) {
        dateField.classList.add('show');
      }
      
      // Add event listener
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          dateField.classList.add('show');
        } else {
          dateField.classList.remove('show');
          const dateInput = dateField.querySelector('input[type="date"]');
          if (dateInput) dateInput.value = '';
        }
      });
    }
  });
  
  // Member AICS field
  const memberAicsSelect = $('memberAics');
  const memberAicsDateField = $('member_aics_date');
  
  if (memberAicsSelect && memberAicsDateField) {
    // Set initial state
    if (memberAicsSelect.value && memberAicsSelect.value !== "") {
      memberAicsDateField.classList.add('show');
    }
    
    // Add event listener
    memberAicsSelect.addEventListener('change', function() {
      if (this.value && this.value !== "") {
        memberAicsDateField.classList.add('show');
      } else {
        memberAicsDateField.classList.remove('show');
        const dateInput = memberAicsDateField.querySelector('input[type="date"]');
        if (dateInput) dateInput.value = '';
      }
    });
  }
/* ============ UPDATED DATE FORMATTING FUNCTION ============ */
function formatDateForDisplay(dateValue) {
  if (!dateValue || dateValue === 'N/A') return 'N/A';
  
  try {
    // If it's already in the correct format (MM/DD/YYYY, HH:MM:SS AM/PM), return as is
    if (typeof dateValue === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}, \d{1,2}:\d{2}:\d{2} [AP]M$/.test(dateValue)) {
      return dateValue;
    }
    
    // If it's an ISO string or timestamp (like "2025-12-10T05:02:00.000Z")
    const date = new Date(dateValue);
    if (!isNaN(date)) {
      // Format as MM/DD/YYYY, HH:MM:SS AM/PM to match formatTimestampPH_()
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const year = date.getFullYear();
      
      let hours = date.getHours();
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      
      hours = hours % 12;
      hours = hours ? hours : 12; // the hour '0' should be '12'
      hours = String(hours).padStart(2, '0');
      
      return `${month}/${day}/${year}, ${hours}:${minutes}:${seconds} ${ampm}`;
    }
    
    // For any other format, return as is
    return dateValue;
  } catch (e) {
    console.warn('Date formatting error:', e, 'for value:', dateValue);
    return dateValue;
  }
}

/* ============ CONTACT VALIDATION ============ */
function validatePhilippineMobileNumber(number) {
    const cleaned = number.replace(/\s+/g, '').replace(/[^\d+]/g, '');
    const pattern = /^(09|\+639)\d{9}$/;
    
    if (!pattern.test(cleaned)) return false;
    
    if (cleaned.startsWith('09') && cleaned.length !== 11) return false;
    if (cleaned.startsWith('+639') && cleaned.length !== 13) return false;
    
    return true;
}

function validateContactInput(input, errorElement) {
    if (!input || !errorElement) return true;
    
    let value = input.value.trim();
    
    // Allow empty for optional fields (check if field is required)
    const isRequired = input.hasAttribute('required');
    if (!value && !isRequired) {
        input.classList.remove('input-error');
        errorElement.style.display = 'none';
        return true;
    }
    
    if (!value && isRequired) {
        input.classList.add('input-error');
        errorElement.style.display = 'block';
        errorElement.textContent = 'Contact number is required';
        return false;
    }
    
    // Format the number as user types
    const formattedValue = formatContactNumber(value);
    if (formattedValue !== value) {
        input.value = formattedValue;
        value = formattedValue;
    }
    
    const isValid = validatePhilippineMobileNumber(value);
    
    if (!isValid) {
        input.classList.add('input-error');
        errorElement.style.display = 'block';
        errorElement.textContent = 'Please enter a valid Philippine mobile number (09XXXXXXXXX or +639XXXXXXXXX)';
        return false;
    } else {
        input.classList.remove('input-error');
        errorElement.style.display = 'none';
        return true;
    }
}

/* ============ SESSION MANAGEMENT ============ */
async function sessionCheck(){
    try {
        const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
        
        if (userName && userName !== "User") {
            document.getElementById('userName').innerText = userName;
            
            const isAdmin = localStorage.getItem("userRole") === "admin";
            
            // Handle desktop admin items
            const adminItems = document.querySelectorAll(".admin-only");
            adminItems.forEach(item => {
                item.classList.toggle("admin-visible", isAdmin);
            });
            
            // Handle mobile nav for admin
            const mobileUsersNav = document.getElementById('mobileUsersNav');
            if (mobileUsersNav) {
                if (isAdmin) {
                    mobileUsersNav.classList.add('admin-visible');
                } else {
                    mobileUsersNav.classList.remove('admin-visible');
                }
            }
            
            sessionStorage.setItem('authenticated', 'true');
            return true;
        } else {
            if(sessionStorage.getItem('authenticated')) {
                document.getElementById('userName').innerText = "User";
                return true;
            } else {
                window.location.href = 'index.html?session=expired';
                return false;
            }
        }
    } catch(e){ 
        console.warn('session check failed', e);
        return false;
    }
}

/* ============ ENHANCED LOGOUT FUNCTION ============ */
function handleLogout() {
  localStorage.clear();
  sessionStorage.clear();
  
  const logoutUrl = 'index.html?logout=true&t=' + Date.now();
  
  fetch(SCRIPT_URL+'?action=logout&t=' + Date.now())
    .catch(() => { })
    .finally(() => {
      window.location.replace(logoutUrl);
    });
}

/* ============ LOAD RECORDS WITH CACHING ============ */
async function loadRecords(){
    console.log("loadRecords() called");
    showLoading(true);
    try{
        const cachedData = localStorage.getItem('recordsCache');
        const cacheTime = localStorage.getItem('recordsCacheTime');
        const now = Date.now();
        
        if(cachedData && cacheTime && (now - parseInt(cacheTime)) < 300000) {
            const data = JSON.parse(cachedData);
            header = data.header || [];
            rawRows = data.rows || [];
            console.log("Using cached data");
        } else {
            const res = await fetch(`${SCRIPT_URL}?action=getRecords&barangay=&q=`);
            const data = await res.json();
            
            if(!data.success){ 
                alert("Load failed: " + (data.message||"")); 
                showLoading(false); 
                return; 
            }
            
            // FIXED: Handle the response structure properly
            // The server returns data.header and data.rows
            header = data.header || [];
            rawRows = data.rows || [];
            
            // Cache the data
            localStorage.setItem('recordsCache', JSON.stringify(data));
            localStorage.setItem('recordsCacheTime', now.toString());
            console.log("Loaded fresh data from server");
        }
        
        groupRows();
        filteredGroups = [...groups];
        currentPage = 1;
        renderTable();
        renderPagination();
        updateCounts();
    } catch(err){
        console.error("Load records error:", err);
        alert("Error loading records: " + err.message);
    }
    showLoading(false);
}

/* ============ CLIENT-SIDE FILTERING ============ */
function filterRecords() {
    const barangay = document.getElementById("filterBarangay").value || "";
    const q = document.getElementById("searchInput").value.trim().toLowerCase();
    
    currentPage = 1;
    
    filteredGroups = groups.filter(g => {
        const head = g.head || {};
        
        if (barangay && head["Barangay"] !== barangay) {
            return false;
        }
        
        if (q) {
            const searchableFields = [
                head["Data ID"] || "",
                head["Name of Head"] || "",
                head["Barangay"] || "",
                head["Purok/Street"] || "",
                head["Contact"] || ""
            ];
            
            const memberNames = g.members.map(m => m["Name of Household Member/s"] || "").join(" ");
            const searchText = [...searchableFields, memberNames].join(" ").toLowerCase();
            
            return searchText.includes(q);
        }
        
        return true;
    });
    
    renderTable();
    renderPagination();
    updateCounts();
}

/* ============ GROUPING ============ */
function groupRows(){
    const map = {};
    rawRows.forEach(r=>{
        const id = String(r["Data ID"] || "");
        if(!id) return;
        if(!map[id]) map[id] = { dataID:id, head:null, members:[] };

        const isHead = !r["Name of Household Member/s"] || String(r["Name of Household Member/s"]).trim() === "";
        if(isHead && !map[id].head) map[id].head = r;
        else map[id].members.push(r);
    });

    Object.keys(map).forEach(k=>{
        if(!map[k].head && map[k].members.length>0){
            map[k].head = map[k].members.shift();
        }
    });

    groups = Object.values(map).sort((a,b)=> Number(a.dataID) - Number(b.dataID));
}

/* ============ RENDER ============ */
function renderTable(){
    const thead = document.getElementById("tableHead");
    const tbody = document.getElementById("tableBody");
    thead.innerHTML = ""; tbody.innerHTML = "";

    // header row - FIXED: Only use header columns that exist in data
    let th = `<tr><th class="select-col"><input id="selectAll" type="checkbox"></th>`;
    header.forEach(c => th += `<th>${c}</th>`);
    th += `<th class="actions-col">Members</th><th class="actions-col">Actions</th></tr>`;
    thead.innerHTML = th;

    const start = (currentPage-1) * rowsPerPage;
    const pageRows = filteredGroups.slice(start, start + rowsPerPage);
    const keyword = document.getElementById("searchInput").value.trim();

    pageRows.forEach(g=>{
        const head = g.head || {};
        const mCount = g.members.length;

        let cls = mCount <= 1 ? "mem-small" : mCount <= 4 ? "mem-normal" : mCount <= 7 ? "mem-large" : "mem-critical";
        const tr = document.createElement("tr"); 
        tr.className = cls;

        // checkbox
        const tdSel = document.createElement("td"); 
        tdSel.className = "select-col";
        tdSel.innerHTML = `<input type="checkbox" class="row-select" data-id="${g.dataID}" ${selected.has(g.dataID) ? "checked" : ""}>`;
        tr.appendChild(tdSel);

        // header columns - FIXED: Only render columns from header array
        header.forEach(col=>{
            const td = document.createElement("td");
            let cellValue = head[col] || "";
            
            // Apply special formatting for date columns
            if (col === "Submitted On" || col === "Updated On") {
                cellValue = formatDateForDisplay(cellValue);
            }
            
            if (col === "Submitted On" && String(cellValue).includes("NaN")) {
                const rawData = rawRows.find(r => 
                    String(r["Data ID"]) === String(g.dataID) && 
                    (!r["Name of Household Member/s"] || String(r["Name of Household Member/s"]).trim() === "")
                );
                if (rawData && rawData[col] && !String(rawData[col]).includes("NaN")) {
                    td.innerHTML = highlight(formatDateForDisplay(rawData[col]), keyword);
                } else {
                    td.innerHTML = "Invalid Date";
                }
            } else {
                td.innerHTML = highlight(cellValue, keyword);
            }
            tr.appendChild(td);
        });

        // show toggle
        const tdShow = document.createElement("td"); 
        tdShow.className = "actions-col";
        tdShow.innerHTML = `<button class="show-toggle" onclick="toggleMembers('${g.dataID}')"><i class="fas fa-eye"></i> Show (${mCount})</button>`;
        tr.appendChild(tdShow);

        // action buttons - MODIFIED FOR IN-PLACE EDITING
        const tdAct = document.createElement("td"); 
        tdAct.className = "actions-col";
        tdAct.innerHTML = `
            <button class="icon-btn edit-btn" title="Edit" onclick="onEdit('${g.dataID}')">
                <i class="fas fa-edit"></i>
            </button>
            <button class="icon-btn delete-btn" title="Delete" onclick="onDelete('${g.dataID}', '${escapeHtml(head['Name of Household Head'] || '')}', '${escapeHtml(head['Barangay'] || '')}')">
                <i class="fas fa-trash"></i>
            </button>
        `;
        tr.appendChild(tdAct);

        tbody.appendChild(tr);

        // member rows
        g.members.forEach(m=>{
            const mr = document.createElement("tr");
            mr.className = "member-row hidden";
            mr.dataset.parent = g.dataID;
            mr.appendChild(document.createElement("td")); // empty select col
            
            header.forEach(col=>{
                const td = document.createElement("td");
                let cellValue = m[col] || "";
                
                // Apply special formatting for date columns
                if (col === "Submitted On" || col === "Updated On") {
                    cellValue = formatDateForDisplay(cellValue);
                }
                
                if (col === "Submitted On" && String(cellValue).includes("NaN")) {
                    const rawData = rawRows.find(r => 
                        String(r["Data ID"]) === String(g.dataID) && 
                        String(r["Name of Household Member/s"] || "").trim() === String(m["Name of Household Member/s"] || "").trim()
                    );
                    if (rawData && rawData[col] && !String(rawData[col]).includes("NaN")) {
                        td.innerHTML = highlight(formatDateForDisplay(rawData[col]), keyword);
                    } else {
                        td.innerHTML = "Invalid Date";
                    }
                } else {
                    td.innerHTML = highlight(cellValue, keyword);
                }
                mr.appendChild(td);
            });
            
            mr.appendChild(document.createElement("td")); // empty members column
            mr.appendChild(document.createElement("td")); // empty actions column
            tbody.appendChild(mr);
        });
    });

    // select all logic for page
    const selectAll = document.getElementById("selectAll");
    if(selectAll){
        selectAll.checked = pageRows.every(g => selected.has(g.dataID));
        selectAll.onchange = function(){
            pageRows.forEach(g => {
                if(this.checked) selected.add(g.dataID); 
                else selected.delete(g.dataID);
            });
            renderTable();
            updateCounts();
        };
    }

    // row selects
    document.querySelectorAll(".row-select").forEach(cb=>{
        cb.onchange = function(){
            const id = this.dataset.id;
            if(this.checked) selected.add(id); 
            else selected.delete(id);
            updateCounts();
        };
    });

    updateCounts();
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
} 

/* ============ TOGGLE MEMBERS ============ */
function toggleMembers(id){
    const memberRows = document.querySelectorAll(`tr.member-row[data-parent="${id}"]`);
    memberRows.forEach(r => {
        r.classList.toggle("hidden");
        const btn = document.querySelector(`.show-toggle[onclick*="${id}"]`);
        if(btn){
            const icon = btn.querySelector('i');
            if(r.classList.contains('hidden')){
                icon.className = 'fas fa-eye';
            } else {
                icon.className = 'fas fa-eye-slash';
            }
        }
    });
}

/* ============ PAGINATION ============ */
function renderPagination(){
    const div = document.getElementById("paginationArea");
    const total = Math.ceil(filteredGroups.length / rowsPerPage);
    
    if(total <= 1){ 
        div.innerHTML = ""; 
        return; 
    }

    let html = "";
    for(let i=1;i<=total;i++){
        html += `<button onclick="gotoPage(${i})" class="${i===currentPage ? 'active' : ''}">${i}</button>`;
    }
    div.innerHTML = html;
}

function gotoPage(p){ 
    if(p<1) p=1; 
    currentPage=p; 
    renderTable(); 
    renderPagination(); 
}

/* ============ COUNTS ============ */
function updateCounts(){
    document.getElementById("rowCount").innerText = groups.length;
    document.getElementById("matchCount").innerText = filteredGroups.length;
    
    let selectedCount = 0;
    filteredGroups.forEach(g => {
        if (selected.has(g.dataID)) {
            selectedCount++;
        }
    });
    document.getElementById("selectedCount").innerText = selectedCount;
}

/* ============ SYNC ANIMAL CHECKBOXES - UPDATED ============ */
function syncAnimalCheckboxes() {
  document.querySelectorAll('#editPanel .animal-card input[type="checkbox"]').forEach(checkbox => {
    const qtyInput = checkbox.closest('.animal-card').querySelector('.qty');
    
    // Set initial state
    qtyInput.disabled = !checkbox.checked;
    if (!checkbox.checked) qtyInput.value = '';
    
    // Add change listener - set to 1 when checked (like dataForm.html)
    checkbox.addEventListener('change', function() {
      qtyInput.disabled = !this.checked;
      if (this.checked) {
        qtyInput.value = qtyInput.value || '1';
      } else {
        qtyInput.value = '';
      }
    });
    
    // Also sync quantity input changes
    qtyInput.addEventListener('input', function() {
      if (this.value !== '' && this.value !== '0') {
        checkbox.checked = true;
        qtyInput.disabled = false;
      } else if (this.value === '' || this.value === '0') {
        checkbox.checked = false;
        qtyInput.disabled = true;
      }
    });
  });
}

/* ============ EDIT FUNCTION - MODIFIED FOR IN-PLACE EDITING ============ */
function onEdit(id){
    resetEditState();
    resetFormTracking(); // Reset tracking when starting new edit
    
    const group = groups.find(g => g.dataID === id) || filteredGroups.find(g => g.dataID === id);
    if(!group){ alert('Record not found'); return; }

    editDataID = id;
    
    // Deep copy head to avoid reference issues
    editHead = JSON.parse(JSON.stringify(group.head || {}));
    
    // Deep copy members to avoid reference issues
    editMembers = [];
    if (group.members && group.members.length > 0) {
      editMembers = JSON.parse(JSON.stringify(group.members));
      console.log(`Loaded ${editMembers.length} members for editing`);
    } else {
      console.log("No members found for this household");
    }

    // Show Data ID at the top of edit panel
    if ($('editDataIdDisplay')) {
        $('editDataIdDisplay').textContent = editDataID;
    }

    // Store original submittedBy value from head
    const originalSubmittedBy = editHead['Submitted By'] || editHead['submittedBy'] || '';
    
    // If no submittedBy in head, add current user's name
    if (!originalSubmittedBy) {
        editHead['Submitted By'] = getUserFullName();
    }
    
    // Prefill head inputs
    $('edit_coordinate').value = editHead['Coordinate'] || editHead['Coordinates'] || '';
    $('edit_barangay').value = editHead['Barangay'] || '';
    $('edit_sitio').value = editHead['Sitio / Purok'] || '';
    $('edit_householdHead').value = editHead['Name of Household Head'] || '';
    
    // FishR/RBIS Registered - FIXED
    let headRegistrationValue = '';

    // Try different possible field names
    if (editHead['FishR & RBIS'] && editHead['FishR & RBIS'] !== '') {
      headRegistrationValue = editHead['FishR & RBIS'];
    } else if (editHead['FishR Registered/RBIS Registered'] && editHead['FishR Registered/RBIS Registered'] !== '') {
      headRegistrationValue = editHead['FishR Registered/RBIS Registered'];
    }

    $('edit_headRegisteredCheckbox').checked = headRegistrationValue !== '';
    if (headRegistrationValue !== '') {
      $('edit_headRegistrationField').classList.add('show');
      $('edit_headRegistration').value = headRegistrationValue;
    } else {
      $('edit_headRegistrationField').classList.remove('show');
      $('edit_headRegistration').value = '';
    }
    
    $('edit_contactNo').value = formatContactForDisplay(editHead['Contact no.'] || '');
    
    // Set radio buttons - FIXED to use radio-line styling
    qAll("input[name='edit_head_sex']").forEach(r => r.checked = (r.value === (editHead['Sex'] || '')));
    $('edit_householdBirthdate').value = toInputDate(editHead['Birthdate'] || '');
    updateEditHeadAgeStage();
    
    // CRITICAL FIX: Use actual member count from the data, not from the head field
    const actualMemberCount = editMembers.length;
    $('edit_memberCount').value = actualMemberCount;
    console.log("Setting member count to actual:", actualMemberCount, "from data (head field had:", editHead['No. of Household Member/s'] || 0, ")");
    
    // Educational & Economic Status
    $('edit_educationalAttainment').value = editHead['Educational Attainment'] || '';
    if (editHead['Educational Attainment'] === 'College Graduate') {
        $('edit_collegeCourseField').classList.add('show');
        $('edit_collegeCourse').value = editHead['College Graduate Course'] || '';
    } else {
        $('edit_collegeCourseField').classList.remove('show');
        $('edit_collegeCourse').value = '';
    }
    
    $('edit_employment').value = editHead['Employment'] || '';
    if (editHead['Employment'] === 'Employed') {
        $('edit_jobTitleField').classList.add('show');
        $('edit_jobTitle').value = editHead['Job Title'] || '';
    } else {
        $('edit_jobTitleField').classList.remove('show');
        $('edit_jobTitle').value = '';
    }
    
    // Set OFW status - FIXED to use radio-line styling
    qAll("input[name='edit_ofw_status']").forEach(r => r.checked = (r.value === (editHead['Overseas Filipino Worker(OFW)'] || 'No')));
    if (editHead['Overseas Filipino Worker(OFW)'] === 'Yes') {
        $('edit_countryField').classList.add('show');
        $('edit_country').value = editHead['Country'] || '';
    } else {
        $('edit_countryField').classList.remove('show');
        $('edit_country').value = '';
    }
    
    // Additional Information checkboxes
    $('edit_soloParenting').checked = editHead['Solo Parenting'] === 'Yes';
    $('edit_lgbt').checked = editHead['LGBT'] === 'Yes';
    $('edit_lactating').checked = editHead['Lactating'] === 'Yes';
    $('edit_pregnant').checked = editHead['Pregnant'] === 'Yes';

    // PWD and Disability Type
    const pwdValue = editHead['Persons with Disability (PWD)'] || editHead['PWD'] || 'No';
    qAll("input[name='edit_head_pwd']").forEach(r => {
      r.checked = (r.value === pwdValue);
    });

    $('edit_disabilityType').value = editHead['Type of Disability'] || '';

    // Status field with Others option
    const statusValue = editHead['Status'] || '';
    if (statusValue === 'Others') {
      $('edit_head_status').value = 'Others';
      $('edit_statusOthersField').classList.add('show');
      $('edit_statusOthers').value = editHead['Status Others'] || editHead['Status'] || '';
    } else {
      $('edit_head_status').value = statusValue;
    }

    /* ============ CRITICAL FIX: DISPLACEMENT & EVACUATION FIELDS ============ */
    // Displacement reasons - INDIVIDUAL COLUMNS
    $('edit_displacement_taal').checked = editHead['Taal Volcano (Within 14-15 KM Danger Zone)'] === 'Yes';
    $('edit_displacement_typhoon').checked = editHead['Typhoon'] === 'Yes';
    $('edit_displacement_flood').checked = editHead['Flood'] === 'Yes';
    $('edit_displacement_landslide').checked = editHead['Landslide'] === 'Yes';
    $('edit_displacement_earthquake').checked = editHead['Earthquake'] === 'Yes';
    $('edit_displacement_fire').checked = editHead['Fire'] === 'Yes';

    // Check for "Other Reasons" 
    const otherReasons = editHead['Other Reasons'] || '';
    if (otherReasons && otherReasons.trim() !== '') {
      $('edit_displacement_other_check').checked = true;
      $('edit_displacementOtherField').classList.add('show');
      $('edit_displacement_other').value = otherReasons;
    } else {
      $('edit_displacement_other_check').checked = false;
      $('edit_displacementOtherField').classList.remove('show');
      $('edit_displacement_other').value = '';
    }

    // Check if any displacement reason is checked
    const anyDisplacementChecked = 
      $('edit_displacement_taal').checked ||
      $('edit_displacement_typhoon').checked ||
      $('edit_displacement_flood').checked ||
      $('edit_displacement_landslide').checked ||
      $('edit_displacement_earthquake').checked ||
      $('edit_displacement_fire').checked ||
      $('edit_displacement_other_check').checked;

    // Show assembly area options if any displacement reason is checked
    if (anyDisplacementChecked) {
      $('edit_assemblyAreaOptions').style.display = 'block';
    } else {
      $('edit_assemblyAreaOptions').style.display = 'none';
    }

    // Assembly area - check both Inside and Outside columns
    const insideAssembly = editHead['Inside Assembly Area'] === 'Yes';
    const outsideAssembly = editHead['Outside Assembly Area'] === 'Yes';

    if (insideAssembly) {
      $('edit_inside_assembly').checked = true;
      $('edit_outside_assembly').checked = false;
      // Make sure the container is visible
      if (anyDisplacementChecked) {
        $('edit_assemblyAreaOptions').style.display = 'block';
      }
      // Show the inside fields
      $('edit_insideAssemblyFields').style.display = 'block';
      $('edit_outsideAssemblyFields').style.display = 'none';
    } else if (outsideAssembly) {
      $('edit_inside_assembly').checked = false;
      $('edit_outside_assembly').checked = true;
      // Make sure the container is visible
      if (anyDisplacementChecked) {
        $('edit_assemblyAreaOptions').style.display = 'block';
      }
      // Show the outside fields
      $('edit_insideAssemblyFields').style.display = 'none';
      $('edit_outsideAssemblyFields').style.display = 'block';
    } else {
      $('edit_inside_assembly').checked = false;
      $('edit_outside_assembly').checked = false;
      // Hide the container if no displacement reasons
      if (!anyDisplacementChecked) {
        $('edit_assemblyAreaOptions').style.display = 'none';
      }
      $('edit_insideAssemblyFields').style.display = 'none';
      $('edit_outsideAssemblyFields').style.display = 'none';
    }

    // Assembly area fields
    $('edit_family_host').value = editHead['Family/Relative Host'] || '';
    $('edit_host_contact').value = editHead['Host_Contact'] || '';
    $('edit_pickup').value = editHead['Pick-Up Location'] || '';
    $('edit_assembly_area').value = editHead['Assembly Area'] || '';
    $('edit_head_transport').value = editHead['Transportation'] || '';
    /* ============ END DISPLACEMENT FIX ============ */

    $('edit_head_status').value = editHead['Status'] || '';
    
    // Domestic Animals - FIXED with checkbox sync
    $('edit_dog_chk').checked = (editHead['Dog'] === 'Yes');
    $('edit_dog_qty').value = editHead['Dog Qty.'] || '';
    $('edit_cat_chk').checked = (editHead['Cat'] === 'Yes');
    $('edit_cat_qty').value = editHead['Cat Qty.'] || '';
    $('edit_pig_chk').checked = (editHead['Pig'] === 'Yes');
    $('edit_pig_qty').value = editHead['Pig Qty.'] || '';
    $('edit_cow_chk').checked = (editHead['Cow'] === 'Yes');
    $('edit_cow_qty').value = editHead['Cow Qty.'] || '';
    $('edit_carabao_chk').checked = (editHead['Carabao'] === 'Yes');
    $('edit_carabao_qty').value = editHead['Carabao Qty.'] || '';
    $('edit_chicken_chk').checked = (editHead['Chicken'] === 'Yes');
    $('edit_chicken_qty').value = editHead['Chicken Qty.'] || '';
    $('edit_animals_others').value = editHead['Others'] || '';
    
    // Sync animal checkboxes with quantity fields
    syncAnimalCheckboxes();
    
    // Transportation & Evacuation (old fields - keep for backward compatibility)
    $('edit_dropoff').value = editHead['Drop-Off Point'] || editHead['Drop-Off Location'] || '';
    $('edit_campName').value = editHead['Name of Camp'] || editHead['Evacuation Camp Name'] || '';
    $('edit_capacity').value = editHead['Capacity'] || '';
    $('edit_insideCamp').value = editHead['No. of Individuals Inside Camp'] || editHead['Individuals Currently in Camp'] || '';
    $('edit_outsideCamp').value = editHead['No. of Individuals Outside Camp'] || editHead['Individuals Outside Camp'] || '';
    
    /* ============ CRITICAL FIX: Government Assistance with Date Fields ============ */
    // TUPAD
    const hasTUPAD = editHead['TUPAD'] === 'Yes';
    $('edit_ass_tupad').checked = hasTUPAD;
    $('edit_ass_tupad_date_input').value = toInputDate(editHead['TUPAD_Date'] || '');
    if (hasTUPAD) {
      $('edit_ass_tupad_date').classList.add('show');
    } else {
      $('edit_ass_tupad_date').classList.remove('show');
    }

    // Local 4Ps
    const hasLocal4Ps = editHead['Local 4Ps'] === 'Yes';
    $('edit_ass_local4ps').checked = hasLocal4Ps;
    $('edit_ass_local4ps_date_input').value = toInputDate(editHead['Local 4Ps_Date'] || '');
    if (hasLocal4Ps) {
      $('edit_ass_local4ps_date').classList.add('show');
    } else {
      $('edit_ass_local4ps_date').classList.remove('show');
    }

    // National 4Ps
    const hasNational4Ps = editHead['National 4Ps'] === 'Yes';
    $('edit_ass_intl4ps').checked = hasNational4Ps;
    $('edit_ass_intl4ps_date_input').value = toInputDate(editHead['National 4Ps_Date'] || '');
    if (hasNational4Ps) {
      $('edit_ass_intl4ps_date').classList.add('show');
    } else {
      $('edit_ass_intl4ps_date').classList.remove('show');
    }

    // Local Social Pension
    const hasLocalSP = editHead['Local Social Pension'] === 'Yes';
    $('edit_ass_locsp').checked = hasLocalSP;
    $('edit_ass_locsp_date_input').value = toInputDate(editHead['Local Social Pension_Date'] || '');
    if (hasLocalSP) {
      $('edit_ass_locsp_date').classList.add('show');
    } else {
      $('edit_ass_locsp_date').classList.remove('show');
    }

    // National Social Pension
    const hasNationalSP = editHead['National Social Pension'] === 'Yes';
    $('edit_ass_intlsp').checked = hasNationalSP;
    $('edit_ass_intlsp_date_input').value = toInputDate(editHead['National Social Pension_Date'] || '');
    if (hasNationalSP) {
      $('edit_ass_intlsp_date').classList.add('show');
    } else {
      $('edit_ass_intlsp_date').classList.remove('show');
    }

    // Solo Parent Assistance
    const hasSoloParent = editHead['Solo Parent Assistance'] === 'Yes';
    $('edit_ass_solo').checked = hasSoloParent;
    $('edit_ass_solo_date_input').value = toInputDate(editHead['Solo Parent Assistance_Date'] || '');
    if (hasSoloParent) {
      $('edit_ass_solo_date').classList.add('show');
    } else {
      $('edit_ass_solo_date').classList.remove('show');
    }

    // Relief Goods
    const hasReliefGoods = editHead['Relief Goods'] === 'Yes';
    $('edit_ass_relief').checked = hasReliefGoods;
    $('edit_ass_relief_date_input').value = toInputDate(editHead['Relief Goods_Date'] || '');
    if (hasReliefGoods) {
      $('edit_ass_relief_date').classList.add('show');
    } else {
      $('edit_ass_relief_date').classList.remove('show');
    }

    // Cash Subsidy
    const hasCashSubsidy = editHead['Cash Subsidy'] === 'Yes';
    $('edit_ass_cash').checked = hasCashSubsidy;
    $('edit_ass_cash_date_input').value = toInputDate(editHead['Cash Subsidy_Date'] || '');
    if (hasCashSubsidy) {
      $('edit_ass_cash_date').classList.add('show');
    } else {
      $('edit_ass_cash_date').classList.remove('show');
    }

    // AICS
    const hasAICS = editHead['AICS'] && editHead['AICS'] !== '';
    $('edit_ass_aics').value = editHead['AICS'] || '';
    $('edit_ass_aics_date_input').value = toInputDate(editHead['AICS_Date'] || '');
    if (hasAICS) {
      $('edit_ass_aics_date').classList.add('show');
    } else {
      $('edit_ass_aics_date').classList.remove('show');
    }

    updateEditMembersPreview();
    openEditPanel();
    
    // Capture original state AFTER prefill but before user makes changes
    setTimeout(() => {
      captureOriginalFormState();
    }, 200);
    
    setTimeout(()=> $('edit_householdHead')?.focus(), 120);
    setTimeout(() => {
        setupRealTimeValidationForEdit();
        setupContactValidation();
        setupEditGovernmentAssistanceDateHandlers();
        
        // CRITICAL: Manually trigger change events to ensure date fields show
        setTimeout(() => {
          if (hasTUPAD) $('edit_ass_tupad').dispatchEvent(new Event('change'));
          if (hasLocal4Ps) $('edit_ass_local4ps').dispatchEvent(new Event('change'));
          if (hasNational4Ps) $('edit_ass_intl4ps').dispatchEvent(new Event('change'));
          if (hasLocalSP) $('edit_ass_locsp').dispatchEvent(new Event('change'));
          if (hasNationalSP) $('edit_ass_intlsp').dispatchEvent(new Event('change'));
          if (hasSoloParent) $('edit_ass_solo').dispatchEvent(new Event('change'));
          if (hasReliefGoods) $('edit_ass_relief').dispatchEvent(new Event('change'));
          if (hasCashSubsidy) $('edit_ass_cash').dispatchEvent(new Event('change'));
          if (hasAICS) $('edit_ass_aics').dispatchEvent(new Event('change'));
          
          // Trigger change events for displacement and assembly fields
          if (anyDisplacementChecked) {
            $('edit_assemblyAreaOptions').style.display = 'block';
          }
          
          // Trigger change events for assembly area checkboxes
          if (insideAssembly) {
            $('edit_inside_assembly').dispatchEvent(new Event('change'));
          } else if (outsideAssembly) {
            $('edit_outside_assembly').dispatchEvent(new Event('change'));
          }
          
          // Trigger change event for other reason checkbox
          if ($('edit_displacement_other_check').checked) {
            $('edit_displacement_other_check').dispatchEvent(new Event('change'));
          }
        }, 300);
    }, 100);
}

function getUserFullName() {
  return localStorage.getItem('staffName') || 
         localStorage.getItem('userFullName') || 
         localStorage.getItem('fullName') || 
         localStorage.getItem('username') || 
         'System';
}

function updateEditHeadAgeStage(){
  const d = $('edit_householdBirthdate')?.value || '';
  const ageObj = computeAgeDetailed(d);
  if(!ageObj){ 
      if($('edit_householdAge')) $('edit_householdAge').value=''; 
      if($('edit_householdStage')) $('edit_householdStage').value=''; 
      return; 
  }
  $('edit_householdAge').value = ageObj.display;
  $('edit_householdStage').value = ageObj.stage;
}

function createEmptyMember(){
  return {
    'Data ID': editDataID || '',
    'Name of Household Member/s':'',
    'FishR Registered/RBIS Registered':'',
    'Contact no.':'',
    'Sex':'',
    'Birthdate':'',
    'Age':'',
    'Stage':'',
    'Solo Parenting': 'No',
    'LGBT': 'No',
    'Lactating': 'No',
    'Pregnant': 'No',
    'Persons with Disability (PWD)':'No',
    'Type of Disability': '',
    'Status':'',
    'Status Others': '',
    'Educational Attainment':'',
    'College Graduate Course':'',
    'Employment':'',
    'Job Title':'',
    'Overseas Filipino Worker(OFW)':'No',
    'Country':'',
    'Reasons for Displacement':'',
    'Assembly Area': '',
    'Pick-Up Location':'',
    'Assembly Area Name': '',
    'Transportation':'',
    'Family/Relative Host': '',
    'Host Contact No.': '',
    'Outside Transportation': '',
    
    // Government Assistance with Date Fields
    'TUPAD':'No',
    'TUPAD_Date':'',
    'Local 4Ps':'No',
    'Local 4Ps_Date':'',
    'National 4Ps':'No',
    'National 4Ps_Date':'',
    'Local Social Pension':'No',
    'Local Social Pension_Date':'',
    'National Social Pension':'No',
    'National Social Pension_Date':'',
    'Solo Parent Assistance':'No',
    'Solo Parent Assistance_Date':'',
    'Relief Goods':'No',
    'Relief Goods_Date':'',
    'Cash Subsidy':'No',
    'Cash Subsidy_Date':'',
    'AICS':'',
    'AICS_Date':'',
    
    'Submitted By': getUserFullName()
  };
}

/* ============ UPDATED updateEditMembersPreview FUNCTION WITH MODAL SUPPORT ============ */
function updateEditMembersPreview(){
  const ul = $('edit_membersPreview');
  if(!ul) return;
  ul.innerHTML = '';
  const n = editMembers.length || 0;
  if($('edit_previewCount')) $('edit_previewCount').innerText = n;
  for(let i=0;i<n;i++){
    const li = document.createElement('li');
    const m = editMembers[i] || {};
    li.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span>#${i+1} — ${escapeHtml(m['Name of Household Member/s'] || '(empty)')} (${m['Contact no.']||''})</span>
        <div class="member-actions">
          <!-- REMOVE INLINE STYLES - just clean icons -->
          <button class="edit-btn" title="Edit this member" onclick="event.stopPropagation(); openMemberPanelForEdit(${i})">
            <i class="fas fa-edit"></i>
          </button>
          <button class="remove-btn" title="Remove this member" onclick="event.stopPropagation(); removeMemberByIndex(${i})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    `;
    li.style.cursor = 'pointer';
    li.onclick = () => { memberEditIndex = i; openMemberPanelForEdit(i); };
    ul.appendChild(li);
  }
}

function escapeHtml(s){ return String(s ?? '').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

/* ============ SETUP CONDITIONAL FIELDS ============ */
function setupEditConditionalFields() {
    // Head Registered Checkbox
    const headRegisteredCheckbox = $('edit_headRegisteredCheckbox');
    const headRegistrationField = $('edit_headRegistrationField');
    const headRegistrationSelect = $('edit_headRegistration');
    
    if (headRegisteredCheckbox) {
        headRegisteredCheckbox.addEventListener('change', function() {
            if (this.checked) {
                headRegistrationField.classList.add('show');
                headRegistrationSelect.required = true;
            } else {
                headRegistrationField.classList.remove('show');
                headRegistrationSelect.required = false;
                headRegistrationSelect.value = '';
            }
        });
    }
    
    // Educational Attainment -> College Course
    const educationSelect = $('edit_educationalAttainment');
    const collegeCourseField = $('edit_collegeCourseField');
    const collegeCourseInput = $('edit_collegeCourse');
    
    if (educationSelect) {
        educationSelect.addEventListener('change', function() {
            if (this.value === 'College Graduate') {
                collegeCourseField.classList.add('show');
                collegeCourseInput.required = true;
            } else {
                collegeCourseField.classList.remove('show');
                collegeCourseInput.required = false;
                collegeCourseInput.value = '';
            }
        });
    }
    
    // Employment -> Job Title
    const employmentSelect = $('edit_employment');
    const jobTitleField = $('edit_jobTitleField');
    const jobTitleSelect = $('edit_jobTitle');
    
    if (employmentSelect) {
        employmentSelect.addEventListener('change', function() {
            if (this.value === 'Employed') {
                jobTitleField.classList.add('show');
                jobTitleSelect.required = true;
            } else {
                jobTitleField.classList.remove('show');
                jobTitleSelect.required = false;
                jobTitleSelect.value = '';
            }
        });
    }
    
    // OFW Status -> Country
    const ofwRadios = document.querySelectorAll('input[name="edit_ofw_status"]');
    const countryField = $('edit_countryField');
    const countrySelect = $('edit_country');
    
    if (ofwRadios.length > 0) {
        ofwRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'Yes') {
                    countryField.classList.add('show');
                    countrySelect.required = true;
                } else {
                    countryField.classList.remove('show');
                    countrySelect.required = false;
                    countrySelect.value = '';
                }
            });
        });
    }
    
    // Head PWD to Disability Type - ADDED THIS SECTION
    const headPwdRadios = document.querySelectorAll("input[name='edit_head_pwd']");
    const disabilityTypeField = $('edit_disabilityTypeField');
    
    if (headPwdRadios.length > 0) {
        headPwdRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'Yes') {
                    disabilityTypeField.classList.add('show');
                    $('edit_disabilityType').required = true;
                } else {
                    disabilityTypeField.classList.remove('show');
                    $('edit_disabilityType').required = false;
                    $('edit_disabilityType').value = '';
                }
            });
        });
        
        // Initialize based on current state
        const headPwdChecked = document.querySelector("input[name='edit_head_pwd']:checked");
        if (headPwdChecked && headPwdChecked.value === 'Yes') {
            disabilityTypeField.classList.add('show');
        }
    }
    
    // Head Status Others field
    const headStatusSelect = $('edit_head_status');
    const statusOthersField = $('edit_statusOthersField');
    
    if (headStatusSelect) {
        headStatusSelect.addEventListener('change', function() {
            if (this.value === 'Others') {
                statusOthersField.classList.add('show');
                $('edit_statusOthers').required = true;
            } else {
                statusOthersField.classList.remove('show');
                $('edit_statusOthers').required = false;
                $('edit_statusOthers').value = '';
            }
        });
    }
    
    // Member Registered Checkbox
    const memberRegisteredCheckbox = $('memberRegisteredCheckbox');
    const memberRegistrationField = $('memberRegistrationField');
    const memberRegistrationSelect = $('memberRegistration');
    
    if (memberRegisteredCheckbox) {
        memberRegisteredCheckbox.addEventListener('change', function() {
            if (this.checked) {
                memberRegistrationField.classList.add('show');
                memberRegistrationSelect.required = true;
            } else {
                memberRegistrationField.classList.remove('show');
                memberRegistrationSelect.required = false;
                memberRegistrationSelect.value = '';
            }
        });
    }
    
    // Member Educational Attainment -> College Course
    const memberEducationSelect = $('memberEducationalAttainment');
    const memberCollegeCourseField = $('memberCollegeCourseField');
    const memberCollegeCourseInput = $('memberCollegeCourse');
    
    if (memberEducationSelect) {
        memberEducationSelect.addEventListener('change', function() {
            if (this.value === 'College Graduate') {
                memberCollegeCourseField.classList.add('show');
                memberCollegeCourseInput.required = true;
            } else {
                memberCollegeCourseField.classList.remove('show');
                memberCollegeCourseInput.required = false;
                memberCollegeCourseInput.value = '';
            }
        });
    }
    
    // Member Employment -> Job Title
    const memberEmploymentSelect = $('memberEmployment');
    const memberJobTitleField = $('memberJobTitleField');
    const memberJobTitleSelect = $('memberJobTitle');
    
    if (memberEmploymentSelect) {
        memberEmploymentSelect.addEventListener('change', function() {
            if (this.value === 'Employed') {
                memberJobTitleField.classList.add('show');
                memberJobTitleSelect.required = true;
            } else {
                memberJobTitleField.classList.remove('show');
                memberJobTitleSelect.required = false;
                memberJobTitleSelect.value = '';
            }
        });
    }
    
    // Member PWD to Disability Type
    const memberPwdRadios = document.querySelectorAll("input[name='member_pwd']");
    const memberDisabilityTypeField = $('memberDisabilityTypeField');
    
    if (memberPwdRadios.length > 0) {
        memberPwdRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'Yes') {
                    memberDisabilityTypeField.classList.add('show');
                    $('memberDisabilityType').required = true;
                } else {
                    memberDisabilityTypeField.classList.remove('show');
                    $('memberDisabilityType').required = false;
                    $('memberDisabilityType').value = '';
                }
            });
        });
    }
    
    // Member Status Others field
    const memberStatusSelect = $('memberStatus');
    const memberStatusOthersField = $('memberStatusOthersField');
    
    if (memberStatusSelect) {
        memberStatusSelect.addEventListener('change', function() {
            if (this.value === 'Others') {
                memberStatusOthersField.classList.add('show');
                $('memberStatusOthers').required = true;
            } else {
                memberStatusOthersField.classList.remove('show');
                $('memberStatusOthers').required = false;
                $('memberStatusOthers').value = '';
            }
        });
    }
    
    // Member Displacement other field
    const memberDisplacementOtherCheck = $('member_displacement_other_check');
    const memberDisplacementOtherField = $('memberDisplacementOtherField');
    
    if (memberDisplacementOtherCheck) {
        memberDisplacementOtherCheck.addEventListener('change', function() {
            if (this.checked) {
                memberDisplacementOtherField.classList.add('show');
                $('member_displacement_other').required = true;
            } else {
                memberDisplacementOtherField.classList.remove('show');
                $('member_displacement_other').required = false;
                $('member_displacement_other').value = '';
            }
        });
    }
    
    // Member Assembly area options
    const memberAssemblyOptions = document.querySelectorAll('.member-assembly-option');
    const memberAssemblyAreaOptions = $('memberAssemblyAreaOptions');
    const memberInsideAssemblyFields = $('memberInsideAssemblyFields');
    const memberOutsideAssemblyFields = $('memberOutsideAssemblyFields');
    
    // Check if any member displacement reason is selected
    const memberDisplacementCheckboxes = document.querySelectorAll('.member-displacement-reason, #member_displacement_other_check');
    memberDisplacementCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            const anyChecked = Array.from(memberDisplacementCheckboxes).some(cb => cb.checked);
            if (anyChecked) {
                memberAssemblyAreaOptions.style.display = 'block';
            } else {
                memberAssemblyAreaOptions.style.display = 'none';
                memberInsideAssemblyFields.style.display = 'none';
                memberOutsideAssemblyFields.style.display = 'none';
                // Clear all assembly area fields
                $('memberPickup').value = '';
                $('memberAssemblyArea').value = '';
                $('memberTransport').value = '';
                $('memberFamilyHost').value = '';
                $('memberHostContact').value = '';
                $('memberOutsideTransport').value = '';
            }
        });
    });
    
    // Member Inside/Outside assembly area toggle
    if (memberAssemblyOptions.length > 0) {
        memberAssemblyOptions.forEach(option => {
            option.addEventListener('change', function() {
                if (this.id === 'member_inside_assembly' && this.checked) {
                    memberInsideAssemblyFields.style.display = 'block';
                    memberOutsideAssemblyFields.style.display = 'none';
                    // Clear outside assembly fields
                    $('memberFamilyHost').value = '';
                    $('memberHostContact').value = '';
                    $('memberOutsideTransport').value = '';
                } else if (this.id === 'member_outside_assembly' && this.checked) {
                    memberInsideAssemblyFields.style.display = 'none';
                    memberOutsideAssemblyFields.style.display = 'block';
                    // Clear inside assembly fields
                    $('memberPickup').value = '';
                    $('memberAssemblyArea').value = '';
                    $('memberTransport').value = '';
                }
            });
        });
    }
    
    // Member OFW Status -> Country
    const memberOfwRadios = document.querySelectorAll('input[name="member_ofw_status"]');
    const memberCountryField = $('memberCountryField');
    const memberCountrySelect = $('memberCountry');
    
    if (memberOfwRadios.length > 0) {
        memberOfwRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'Yes') {
                    memberCountryField.classList.add('show');
                    memberCountrySelect.required = true;
                } else {
                    memberCountryField.classList.remove('show');
                    memberCountrySelect.required = false;
                    memberCountrySelect.value = '';
                }
            });
        });
    }
}

/* ============ MEMBER PANEL FUNCTIONS ============ */
function validateEditPanelForMemberEditing() {
  // Check if household head has valid contact number
  if (!validateContactInput($('edit_contactNo'), $('edit_contactError'))) {
    alert('Please enter a valid Philippine mobile number for the household head first.');
    $('edit_contactNo').focus();
    return false;
  }
  
  // Check if household head name is filled
  const headName = $('edit_householdHead').value.trim();
  if (!headName) {
    alert('Please enter household head name first.');
    $('edit_householdHead').focus();
    return false;
  }
  
  // Check if barangay is selected
  const barangay = $('edit_barangay').value;
  if (!barangay) {
    alert('Please select barangay first.');
    $('edit_barangay').focus();
    return false;
  }
  
  return true;
}

/* ============ FIXED: fillMemberPanelFromEdit FUNCTION ============ */
function fillMemberPanelFromEdit(idx){
  const m = editMembers[idx] || createEmptyMember();
  
  // Basic Information - FIXED: Added missing fields
  $('memberName').value = m['Name of Household Member/s'] || '';
  
  // FishR/RBIS Registered - FIXED: Check both possible field names
  let registrationValue = '';
  
  // Try different possible field names
  if (m['FishR & RBIS'] && m['FishR & RBIS'] !== '') {
    registrationValue = m['FishR & RBIS'];
  } else if (m['FishR Registered/RBIS Registered'] && m['FishR Registered/RBIS Registered'] !== '') {
    registrationValue = m['FishR Registered/RBIS Registered'];
  }
  
  const hasRegistration = registrationValue !== '';
  $('memberRegisteredCheckbox').checked = hasRegistration;
  if (hasRegistration) {
    $('memberRegistrationField').classList.add('show');
    $('memberRegistration').value = registrationValue;
  } else {
    $('memberRegistrationField').classList.remove('show');
    $('memberRegistration').value = '';
  }
  
  $('memberContact').value = formatContactForDisplay(m['Contact no.'] || '');
  
  // FIXED: Ensure sex radio buttons are properly set
  const memberSex = m['Sex'] || '';
  qAll("input[name='member_sex']").forEach(r => {
    r.checked = (r.value === memberSex);
  });
  
  $('memberBirthdate').value = toInputDate(m['Birthdate'] || '');
  updateMemberAgeStage();
  
  // Additional Information checkboxes - FIXED: Set checkbox values
  $('member_soloParenting').checked = m['Solo Parenting'] === 'Yes';
  $('member_lgbt').checked = m['LGBT'] === 'Yes';
  $('member_lactating').checked = m['Lactating'] === 'Yes';
  $('member_pregnant').checked = m['Pregnant'] === 'Yes';
  
  // PWD and Disability Type - FIXED: Set PWD radio and disability type
  const memberPWD = m['Persons with Disability (PWD)'] || m['PWD'] || 'No';
  qAll("input[name='member_pwd']").forEach(r => {
    r.checked = (r.value === memberPWD);
  });
  
  if (memberPWD === 'Yes') {
    $('memberDisabilityTypeField').classList.add('show');
    $('memberDisabilityType').value = m['Type of Disability'] || '';
  } else {
    $('memberDisabilityTypeField').classList.remove('show');
    $('memberDisabilityType').value = '';
  }
  
  // Educational & Economic Status - FIXED: Added missing fields
  $('memberEducationalAttainment').value = m['Educational Attainment'] || '';
  if (m['Educational Attainment'] === 'College Graduate') {
    $('memberCollegeCourseField').classList.add('show');
    $('memberCollegeCourse').value = m['College Graduate Course'] || '';
  } else {
    $('memberCollegeCourseField').classList.remove('show');
    $('memberCollegeCourse').value = '';
  }
  
  $('memberEmployment').value = m['Employment'] || '';
  if (m['Employment'] === 'Employed') {
    $('memberJobTitleField').classList.add('show');
    $('memberJobTitle').value = m['Job Title'] || '';
  } else {
    $('memberJobTitleField').classList.remove('show');
    $('memberJobTitle').value = '';
  }
  
  // FIXED: Ensure OFW radio buttons are properly set
  const memberOFW = m['Overseas Filipino Worker(OFW)'] || 'No';
  qAll("input[name='member_ofw_status']").forEach(r => {
    r.checked = (r.value === memberOFW);
  });
  
  if (memberOFW === 'Yes') {
    $('memberCountryField').classList.add('show');
    $('memberCountry').value = m['Country'] || '';
  } else {
    $('memberCountryField').classList.remove('show');
    $('memberCountry').value = '';
  }
  
  // Health and Status - FIXED: Set status field
  const memberStatus = m['Status'] || '';
  if (memberStatus && ['Hypertension', 'Heart Disease', 'Stroke', 'Diabetes Mellitus', 'Cancer', 'Tuberculosis (TB)', 'Chronic Kidney Disease', 'Severe Asthma / COPD', 'Cough and colds', 'Fever', 'Headache', 'Diarrhea', 'Stomach ache / Hyperacidity', 'Skin disease (rashes, fungal infection)', 'Urinary Tract Infection (UTI)'].includes(memberStatus)) {
    $('memberStatus').value = memberStatus;
    $('memberStatusOthersField').classList.remove('show');
    $('memberStatusOthers').value = '';
  } else if (memberStatus) {
    $('memberStatus').value = 'Others';
    $('memberStatusOthersField').classList.add('show');
    $('memberStatusOthers').value = memberStatus;
  } else {
    $('memberStatus').value = '';
    $('memberStatusOthersField').classList.remove('show');
    $('memberStatusOthers').value = '';
  }
  
  /* ============ CRITICAL FIX: Displacement & Evacuation Fields ============ */
  // Displacement reasons - INDIVIDUAL COLUMNS
  $('member_displacement_taal').checked = m['Taal Volcano (Within 14-15 KM Danger Zone)'] === 'Yes';
  $('member_displacement_typhoon').checked = m['Typhoon'] === 'Yes';
  $('member_displacement_flood').checked = m['Flood'] === 'Yes';
  $('member_displacement_landslide').checked = m['Landslide'] === 'Yes';
  $('member_displacement_earthquake').checked = m['Earthquake'] === 'Yes';
  $('member_displacement_fire').checked = m['Fire'] === 'Yes';
  
  // Check for "Other Reasons" 
  const otherReasons = m['Other Reasons'] || '';
  if (otherReasons && otherReasons.trim() !== '') {
    $('member_displacement_other_check').checked = true;
    $('memberDisplacementOtherField').classList.add('show');
    $('member_displacement_other').value = otherReasons;
  } else {
    $('member_displacement_other_check').checked = false;
    $('memberDisplacementOtherField').classList.remove('show');
    $('member_displacement_other').value = '';
  }
  
  // Check if any displacement reason is checked
  const anyDisplacementChecked = 
    $('member_displacement_taal').checked ||
    $('member_displacement_typhoon').checked ||
    $('member_displacement_flood').checked ||
    $('member_displacement_landslide').checked ||
    $('member_displacement_earthquake').checked ||
    $('member_displacement_fire').checked ||
    $('member_displacement_other_check').checked;
  
  // Show assembly area options if any displacement reason is checked
  if (anyDisplacementChecked) {
    $('memberAssemblyAreaOptions').style.display = 'block';
  } else {
    $('memberAssemblyAreaOptions').style.display = 'none';
  }
  
  // Assembly area - check both Inside and Outside columns
  const insideAssembly = m['Inside Assembly Area'] === 'Yes';
  const outsideAssembly = m['Outside Assembly Area'] === 'Yes';
  
  if (insideAssembly) {
    $('member_inside_assembly').checked = true;
    $('member_outside_assembly').checked = false;
    // Make sure the container is visible
    if (anyDisplacementChecked) {
      $('memberAssemblyAreaOptions').style.display = 'block';
    }
    // Show the inside fields
    $('memberInsideAssemblyFields').style.display = 'block';
    $('memberOutsideAssemblyFields').style.display = 'none';
    // Populate inside assembly fields
    $('memberPickup').value = m['Pick-Up Location'] || '';
    $('memberAssemblyArea').value = m['Assembly Area'] || '';
    $('memberTransport').value = m['Transportation'] || '';
  } else if (outsideAssembly) {
    $('member_inside_assembly').checked = false;
    $('member_outside_assembly').checked = true;
    // Make sure the container is visible
    if (anyDisplacementChecked) {
      $('memberAssemblyAreaOptions').style.display = 'block';
    }
    // Show the outside fields
    $('memberInsideAssemblyFields').style.display = 'none';
    $('memberOutsideAssemblyFields').style.display = 'block';
    // Populate outside assembly fields
    $('memberFamilyHost').value = m['Family/Relative Host'] || '';
    $('memberHostContact').value = m['Host_Contact'] || '';
    $('memberOutsideTransport').value = m['Transportation'] || '';
  } else {
    $('member_inside_assembly').checked = false;
    $('member_outside_assembly').checked = false;
    // Hide the container if no displacement reasons
    if (!anyDisplacementChecked) {
      $('memberAssemblyAreaOptions').style.display = 'none';
    }
    $('memberInsideAssemblyFields').style.display = 'none';
    $('memberOutsideAssemblyFields').style.display = 'none';
  }
  
  // Government Assistance Programs WITH DATE FIELDS - FIXED: Populate all fields
  // TUPAD
  const hasMemberTUPAD = m['TUPAD'] === 'Yes';
  $('member_tupad').checked = hasMemberTUPAD;
  $('member_tupad_date_input').value = toInputDate(m['TUPAD_Date'] || '');
  
  // Local 4Ps
  const hasMemberLocal4Ps = m['Local 4Ps'] === 'Yes';
  $('member_local4ps').checked = hasMemberLocal4Ps;
  $('member_local4ps_date_input').value = toInputDate(m['Local 4Ps_Date'] || '');
  
  // National 4Ps
  const hasMemberNational4Ps = m['National 4Ps'] === 'Yes';
  $('member_intl4ps').checked = hasMemberNational4Ps;
  $('member_intl4ps_date_input').value = toInputDate(m['National 4Ps_Date'] || '');
  
  // Local Social Pension
  const hasMemberLocalSP = m['Local Social Pension'] === 'Yes';
  $('member_locsp').checked = hasMemberLocalSP;
  $('member_locsp_date_input').value = toInputDate(m['Local Social Pension_Date'] || '');
  
  // National Social Pension
  const hasMemberNationalSP = m['National Social Pension'] === 'Yes';
  $('member_intlsp').checked = hasMemberNationalSP;
  $('member_intlsp_date_input').value = toInputDate(m['National Social Pension_Date'] || '');
  
  // Solo Parent Assistance
  const hasMemberSoloParent = m['Solo Parent Assistance'] === 'Yes';
  $('member_solo').checked = hasMemberSoloParent;
  $('member_solo_date_input').value = toInputDate(m['Solo Parent Assistance_Date'] || '');
  
  // Relief Goods
  const hasMemberReliefGoods = m['Relief Goods'] === 'Yes';
  $('member_relief').checked = hasMemberReliefGoods;
  $('member_relief_date_input').value = toInputDate(m['Relief Goods_Date'] || '');
  
  // Cash Subsidy
  const hasMemberCashSubsidy = m['Cash Subsidy'] === 'Yes';
  $('member_cash').checked = hasMemberCashSubsidy;
  $('member_cash_date_input').value = toInputDate(m['Cash Subsidy_Date'] || '');
  
  // AICS
  const hasMemberAICS = m['AICS'] && m['AICS'] !== '';
  $('memberAics').value = m['AICS'] || '';
  $('member_aics_date_input').value = toInputDate(m['AICS_Date'] || '');
  
  // Setup member government assistance date handlers
  setupMemberGovernmentAssistanceDateHandlers();
  
  // Update panel title
  const total = Math.max(1, editMembers.length);
  $('memberPanelTitle').innerText = `Member ${idx+1} of ${total}`;
  
  // CRITICAL: Trigger change events to ensure date fields show
  setTimeout(() => {
    if (hasMemberTUPAD) $('member_tupad').dispatchEvent(new Event('change'));
    if (hasMemberLocal4Ps) $('member_local4ps').dispatchEvent(new Event('change'));
    if (hasMemberNational4Ps) $('member_intl4ps').dispatchEvent(new Event('change'));
    if (hasMemberLocalSP) $('member_locsp').dispatchEvent(new Event('change'));
    if (hasMemberNationalSP) $('member_intlsp').dispatchEvent(new Event('change'));
    if (hasMemberSoloParent) $('member_solo').dispatchEvent(new Event('change'));
    if (hasMemberReliefGoods) $('member_relief').dispatchEvent(new Event('change'));
    if (hasMemberCashSubsidy) $('member_cash').dispatchEvent(new Event('change'));
    if (hasMemberAICS) $('memberAics').dispatchEvent(new Event('change'));
    
    // Trigger change events for displacement and assembly fields
    if (anyDisplacementChecked) {
      $('memberAssemblyAreaOptions').style.display = 'block';
    }
    
    // Trigger change events for assembly area checkboxes
    if (insideAssembly) {
      $('member_inside_assembly').dispatchEvent(new Event('change'));
    } else if (outsideAssembly) {
      $('member_outside_assembly').dispatchEvent(new Event('change'));
    }
    
    // Trigger change event for other reason checkbox
    if ($('member_displacement_other_check').checked) {
      $('member_displacement_other_check').dispatchEvent(new Event('change'));
    }
  }, 300);
}
function getDisplacementReasons() {
    const reasons = [];
    const checkboxes = [
        { id: 'displacement_taal', value: 'Taal Volcano (Within 14-15 KM Danger Zone)' },
        { id: 'displacement_typhoon', value: 'Typhoon' },
        { id: 'displacement_flood', value: 'Flood' },
        { id: 'displacement_landslide', value: 'Landslide' },
        { id: 'displacement_earthquake', value: 'Earthquake' },
        { id: 'displacement_fire', value: 'Fire' }
    ];
    
    checkboxes.forEach(cb => {
        const element = $(cb.id);
        if (element && element.checked) {
            reasons.push(cb.value);
        }
    });
    
    // Check for "Other" reason
    const otherCheck = $('displacement_other_check');
    const otherText = $('displacement_other');
    if (otherCheck && otherCheck.checked && otherText && otherText.value.trim()) {
        reasons.push(otherText.value.trim());
    }
    
    return reasons.join('; ');
}

function getMemberDisplacementReasons() {
    const reasons = [];
    const checkboxes = [
        { id: 'member_displacement_taal', value: 'Taal Volcano (Within 14-15 KM Danger Zone)' },
        { id: 'member_displacement_typhoon', value: 'Typhoon' },
        { id: 'member_displacement_flood', value: 'Flood' },
        { id: 'member_displacement_landslide', value: 'Landslide' },
        { id: 'member_displacement_earthquake', value: 'Earthquake' },
        { id: 'member_displacement_fire', value: 'Fire' }
    ];
    
    checkboxes.forEach(cb => {
        const element = $(cb.id);
        if (element && element.checked) {
            reasons.push(cb.value);
        }
    });
    
    // Check for "Other" reason
    const otherCheck = $('member_displacement_other_check');
    const otherText = $('member_displacement_other');
    if (otherCheck && otherCheck.checked && otherText && otherText.value.trim()) {
        reasons.push(otherText.value.trim());
    }
    
    return reasons.join('; ');
}

function openMemberPanelForEdit(index){
  // Ensure we have valid head data first
  if (!validateEditPanelForMemberEditing()) {
    return;
  }
  
  // Collect head data
  collectHeadFromEditForm();
  
  // Ensure the members array exists
  if (!editMembers || !Array.isArray(editMembers)) {
    editMembers = [];
  }
  
  // Ensure we have enough members
  while (editMembers.length <= index) {
    editMembers.push(createEmptyMember());
  }
  
  memberEditIndex = index;
  const total = Math.max(1, editMembers.length);
  $('memberPanelTitle').innerText = `Member ${index+1} of ${total}`;
  fillMemberPanelFromEdit(index);
  $('memberPanel')?.classList.add('open');
  $('panelOverlay')?.classList.add('show');
  
  // Focus on the first field
  setTimeout(() => $('memberName')?.focus(), 100);
}

/* ============ FIXED: collectHeadFromEditForm() FUNCTION ============ */
function collectHeadFromEditForm() {
  console.log("Collecting head from edit form...");
  
  const bd_input = $('edit_householdBirthdate').value || '';
  const headBirthForSheet = toSheetDate(bd_input);
  const headAgeInfo = computeAgeDetailed(bd_input);
  const headAgeVal = headAgeInfo ? headAgeInfo.display : '';

  // Get head registration value only if checkbox is checked
  let headRegistrationValue = "";
  if ($('edit_headRegisteredCheckbox').checked) {
    headRegistrationValue = $('edit_headRegistration').value || "";
  }

  // Preserve the original submittedBy value
  const originalSubmittedBy = editHead['Submitted By'] || editHead['submittedBy'] || '';
  // FIXED: Preserve original Submitted On date
  const originalSubmittedOn = editHead['Submitted On'] || '';
  
  // FIXED: Preserve original Data ID to prevent duplication
  const originalDataID = editHead['Data ID'] || editDataID;
  
  editHead = {
    'Data ID': originalDataID,
    'Coordinate': $('edit_coordinate').value || '',
    'Coordinates': $('edit_coordinate').value || '',
    'Barangay': $('edit_barangay').value || '',
    'Sitio / Purok': $('edit_sitio').value || '',
    'Name of Household Head': ($('edit_householdHead').value || '').trim(),
    'FishR & RBIS': headRegistrationValue,
    'FishR Registered/RBIS Registered': headRegistrationValue,
    'Contact no.': formatContactNumber($('edit_contactNo').value || ''),
    'Sex': document.querySelector("input[name='edit_head_sex']:checked")?.value || '',
    'Birthdate': headBirthForSheet,
    'Age': headAgeVal,
    'Stage': headAgeInfo ? headAgeInfo.stage : '',
    'No. of Household Member/s': String($('edit_memberCount').value || '0'),
    
    // Additional Information fields - FIXED: Properly collect checkbox values
    'Solo Parenting': $('edit_soloParenting')?.checked ? 'Yes' : 'No',
    'LGBT': $('edit_lgbt')?.checked ? 'Yes' : 'No',
    'Lactating': $('edit_lactating')?.checked ? 'Yes' : 'No',
    'Pregnant': $('edit_pregnant')?.checked ? 'Yes' : 'No',
    
    // PWD to Basic Information
    'Persons with Disability (PWD)': document.querySelector("input[name='edit_head_pwd']:checked")?.value || 'No',
    'PWD': document.querySelector("input[name='edit_head_pwd']:checked")?.value || 'No',
    'Type of Disability': $('edit_disabilityType')?.value || '',
    
    'Status': $('edit_head_status').value || '',
    'Status Others': $('edit_statusOthers')?.value || '',
    'Educational Attainment': $('edit_educationalAttainment').value || '',
    'College Graduate Course': $('edit_collegeCourse').value || '',
    'Employment': $('edit_employment').value || '',
    'Job Title': $('edit_jobTitle').value || '',
    'Overseas Filipino Worker(OFW)': document.querySelector("input[name='edit_ofw_status']:checked")?.value || 'No',
    'Country': $('edit_country').value || '',
    
    /* ============ DISPLACEMENT & EVACUATION FIELDS ============ */
    // Displacement reasons - INDIVIDUAL COLUMNS - FIXED: Ensure all checkboxes are collected
    'Taal Volcano (Within 14-15 KM Danger Zone)': $('edit_displacement_taal').checked ? 'Yes' : '',
    'Typhoon': $('edit_displacement_typhoon').checked ? 'Yes' : '',
    'Flood': $('edit_displacement_flood').checked ? 'Yes' : '',
    'Landslide': $('edit_displacement_landslide').checked ? 'Yes' : '',
    'Earthquake': $('edit_displacement_earthquake').checked ? 'Yes' : '',
    'Fire': $('edit_displacement_fire').checked ? 'Yes' : '',
    'Other Reasons': $('edit_displacement_other_check').checked && $('edit_displacement_other').value.trim() ? $('edit_displacement_other').value.trim() : '',
    
    // Assembly area
    'Inside Assembly Area': $('edit_inside_assembly').checked ? 'Yes' : '',
    'Outside Assembly Area': $('edit_outside_assembly').checked ? 'Yes' : '',
    'Family/Relative Host': $('edit_family_host').value || '',
    'Host_Contact': $('edit_host_contact').value || '',
    'Pick-Up Location': $('edit_pickup').value || '',
    'Assembly Area': $('edit_assembly_area').value || '',
    'Transportation': $('edit_inside_assembly').checked ? $('edit_head_transport').value || '' : 
                     ($('edit_outside_assembly').checked ? $('edit_outside_transport').value || '' : ''),
    /* ============ END DISPLACEMENT FIELDS ============ */
    
    // Old fields for backward compatibility (keep these for now)
    'Designated Pick-Up Point': $('edit_pickup').value || '',
    'Drop-Off Point': $('edit_dropoff').value || '',
    'Drop-Off Location': $('edit_dropoff').value || '',
    'Name of Camp': $('edit_campName').value || '',
    'Evacuation Camp Name': $('edit_campName').value || '',
    'Capacity': $('edit_capacity').value || '',
    'No. of Individuals Inside Camp': $('edit_insideCamp').value || '',
    'Individuals Currently in Camp': $('edit_insideCamp').value || '',
    'No. of Individuals Outside Camp': $('edit_outsideCamp').value || '',
    'Individuals Outside Camp': $('edit_outsideCamp').value || '',
    'Reasons for Displacement': $('edit_reasons').value || '',
    
    // Domestic Animals
    'Dog': $('edit_dog_chk').checked ? 'Yes' : 'No',
    'Dog Qty.': $('edit_dog_qty').value || '',
    'Cat': $('edit_cat_chk').checked ? 'Yes' : 'No',
    'Cat Qty.': $('edit_cat_qty').value || '',
    'Pig': $('edit_pig_chk').checked ? 'Yes' : 'No',
    'Pig Qty.': $('edit_pig_qty').value || '',
    'Cow': $('edit_cow_chk').checked ? 'Yes' : 'No',
    'Cow Qty.': $('edit_cow_qty').value || '',
    'Carabao': $('edit_carabao_chk').checked ? 'Yes' : 'No',
    'Carabao Qty.': $('edit_carabao_qty').value || '',
    'Chicken': $('edit_chicken_chk').checked ? 'Yes' : 'No',
    'Chicken Qty.': $('edit_chicken_qty').value || '',
    'Others': $('edit_animals_others').value || '',
    
    // Government Assistance Programs with Date Fields
    'TUPAD': $('edit_ass_tupad').checked ? 'Yes' : 'No',
    'TUPAD_Date': $('edit_ass_tupad_date_input').value ? toSheetDate($('edit_ass_tupad_date_input').value) : '',
    'Local 4Ps': $('edit_ass_local4ps').checked ? 'Yes' : 'No',
    'Local 4Ps_Date': $('edit_ass_local4ps_date_input').value ? toSheetDate($('edit_ass_local4ps_date_input').value) : '',
    'National 4Ps': $('edit_ass_intl4ps').checked ? 'Yes' : 'No',
    'National 4Ps_Date': $('edit_ass_intl4ps_date_input').value ? toSheetDate($('edit_ass_intl4ps_date_input').value) : '',
    'Local Social Pension': $('edit_ass_locsp').checked ? 'Yes' : 'No',
    'Local Social Pension_Date': $('edit_ass_locsp_date_input').value ? toSheetDate($('edit_ass_locsp_date_input').value) : '',
    'National Social Pension': $('edit_ass_intlsp').checked ? 'Yes' : 'No',
    'National Social Pension_Date': $('edit_ass_intlsp_date_input').value ? toSheetDate($('edit_ass_intlsp_date_input').value) : '',
    'Solo Parent Assistance': $('edit_ass_solo').checked ? 'Yes' : 'No',
    'Solo Parent Assistance_Date': $('edit_ass_solo_date_input').value ? toSheetDate($('edit_ass_solo_date_input').value) : '',
    'Relief Goods': $('edit_ass_relief').checked ? 'Yes' : 'No',
    'Relief Goods_Date': $('edit_ass_relief_date_input').value ? toSheetDate($('edit_ass_relief_date_input').value) : '',
    'Cash Subsidy': $('edit_ass_cash').checked ? 'Yes' : 'No',
    'Cash Subsidy_Date': $('edit_ass_cash_date_input').value ? toSheetDate($('edit_ass_cash_date_input').value) : '',
    'AICS': $('edit_ass_aics').value || '',
    'AICS_Date': $('edit_ass_aics_date_input').value ? toSheetDate($('edit_ass_aics_date_input').value) : '',
    
    // Preserve the Submitted By and Submitted On fields
    'Submitted By': originalSubmittedBy || getUserFullName(),
    'Submitted On': originalSubmittedOn || formatTimestampPH_(new Date()),
    
    // Add Updated By and Updated On fields
    'Updated By': getUserFullName(),
    'Updated On': formatTimestampPH_(new Date()),
    
    // FIXED: Preserve original row index to prevent duplication
    '_originalRowIndex': editHead['_originalRowIndex'] || null
  };
}

/* ============ CONTACT NUMBER FORMATTING ============ */
function formatContactNumber(phone) {
  if (!phone) return '';
  
  // Remove all non-digit characters
  let cleaned = phone.replace(/\D/g, '');
  
  // If it starts with 63, convert to 0 format
  if (cleaned.startsWith('63') && cleaned.length === 11) {
    cleaned = '0' + cleaned.substring(2);
  }
  
  // Format as 09XX XXX XXXX or 09XXX XXX XXX
  if (cleaned.length === 11 && cleaned.startsWith('09')) {
    return cleaned.replace(/(\d{4})(\d{3})(\d{4})/, '$1 $2 $3');
  } else if (cleaned.length === 10 && cleaned.startsWith('9')) {
    return '0' + cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1 $2 $3');
  }
  
  // Return as is if doesn't match expected formats
  return phone;
}

/* ============ FIXED: formatTimestampPH_() FUNCTION ============ */
function formatTimestampPH_(date) {
  const d = date || new Date();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  const year = d.getFullYear();
  
  let hours = d.getHours();
  const minutes = String(d.getMinutes()).padStart(2, '0');
  const seconds = String(d.getSeconds()).padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  
  hours = hours % 12;
  hours = hours ? hours : 12;
  hours = String(hours).padStart(2, '0');
  
  return `${month}/${day}/${year}, ${hours}:${minutes}:${seconds} ${ampm}`;
}

function collectMemberPanelToEdit(){
  const name = $('memberName').value.trim();
  const birthdate_input = $('memberBirthdate').value || '';
  const birth_for_sheet = toSheetDate(birthdate_input);
  const ageObj = computeAgeDetailed(birthdate_input);
  const ageVal = ageObj ? ageObj.display : '';
  const stageVal = ageObj ? ageObj.stage : '';

  // Get registration value only if checkbox is checked
  let registrationValue = "";
  if ($('memberRegisteredCheckbox').checked) {
    registrationValue = $('memberRegistration').value || "";
  }

  // Get the current member to preserve existing submittedBy
  const currentMember = editMembers[memberEditIndex] || {};
  const existingSubmittedBy = currentMember['Submitted By'] || '';

  const obj = {
    'Data ID': editDataID,
    'Name of Household Member/s': name,
    'FishR & RBIS': registrationValue,
    'FishR Registered/RBIS Registered': registrationValue,
    'Contact no.': formatContactNumber($('memberContact').value || ''),
    'Sex': document.querySelector("input[name='member_sex']:checked")?.value || '',
    'Birthdate': birth_for_sheet,
    'Age': ageVal,
    'Stage': stageVal,
    
    // Additional Information - FIXED: Properly set checkbox values
    'Solo Parenting': $('member_soloParenting').checked ? 'Yes' : 'No',
    'LGBT': $('member_lgbt').checked ? 'Yes' : 'No',
    'Lactating': $('member_lactating').checked ? 'Yes' : 'No',
    'Pregnant': $('member_pregnant').checked ? 'Yes' : 'No',
    
    // PWD and Disability Type
    'Persons with Disability (PWD)': document.querySelector("input[name='member_pwd']:checked")?.value || 'No',
    'Type of Disability': $('memberDisabilityType').value || '',
    
    // Status with Others option
    'Status': $('memberStatus').value === 'Others' ? $('memberStatusOthers').value || '' : $('memberStatus').value || '',
    
    'Educational Attainment': $('memberEducationalAttainment').value || '',
    'College Graduate Course': $('memberCollegeCourse').value || '',
    'Employment': $('memberEmployment').value || '',
    'Job Title': $('memberJobTitle').value || '',
    'Overseas Filipino Worker(OFW)': document.querySelector("input[name='member_ofw_status']:checked")?.value || 'No',
    'Country': $('memberCountry').value || '',
    
    // Displacement reasons - FIXED: Include all checkbox values as separate columns
    'Taal Volcano (Within 14-15 KM Danger Zone)': $('member_displacement_taal').checked ? 'Yes' : '',
    'Typhoon': $('member_displacement_typhoon').checked ? 'Yes' : '',
    'Flood': $('member_displacement_flood').checked ? 'Yes' : '',
    'Landslide': $('member_displacement_landslide').checked ? 'Yes' : '',
    'Earthquake': $('member_displacement_earthquake').checked ? 'Yes' : '',
    'Fire': $('member_displacement_fire').checked ? 'Yes' : '',
    'Other Reasons': $('member_displacement_other_check').checked ? $('member_displacement_other').value || '' : '',
    
    // Assembly area - FIXED: Set proper values
    'Inside Assembly Area': $('member_inside_assembly').checked ? 'Yes' : '',
    'Outside Assembly Area': $('member_outside_assembly').checked ? 'Yes' : '',
    'Pick-Up Location': $('memberPickup').value || '',
    'Assembly Area': $('memberAssemblyArea').value || '',
    'Family/Relative Host': $('memberFamilyHost').value || '',
    'Host_Contact': $('memberHostContact').value || '',
    
    // Transportation - FIXED: Use correct field based on assembly area
    'Transportation': $('member_inside_assembly').checked ? $('memberTransport').value || '' : 
                     ($('member_outside_assembly').checked ? $('memberOutsideTransport').value || '' : ''),
    
    // Government Assistance with Date Fields
    'TUPAD': $('member_tupad').checked ? 'Yes' : 'No',
    'TUPAD_Date': $('member_tupad_date_input').value ? toSheetDate($('member_tupad_date_input').value) : '',
    'Local 4Ps': $('member_local4ps').checked ? 'Yes' : 'No',
    'Local 4Ps_Date': $('member_local4ps_date_input').value ? toSheetDate($('member_local4ps_date_input').value) : '',
    'National 4Ps': $('member_intl4ps').checked ? 'Yes' : 'No',
    'National 4Ps_Date': $('member_intl4ps_date_input').value ? toSheetDate($('member_intl4ps_date_input').value) : '',
    'Local Social Pension': $('member_locsp').checked ? 'Yes' : 'No',
    'Local Social Pension_Date': $('member_locsp_date_input').value ? toSheetDate($('member_locsp_date_input').value) : '',
    'National Social Pension': $('member_intlsp').checked ? 'Yes' : 'No',
    'National Social Pension_Date': $('member_intlsp_date_input').value ? toSheetDate($('member_intlsp_date_input').value) : '',
    'Solo Parent Assistance': $('member_solo').checked ? 'Yes' : 'No',
    'Solo Parent Assistance_Date': $('member_solo_date_input').value ? toSheetDate($('member_solo_date_input').value) : '',
    'Relief Goods': $('member_relief').checked ? 'Yes' : 'No',
    'Relief Goods_Date': $('member_relief_date_input').value ? toSheetDate($('member_relief_date_input').value) : '',
    'Cash Subsidy': $('member_cash').checked ? 'Yes' : 'No',
    'Cash Subsidy_Date': $('member_cash_date_input').value ? toSheetDate($('member_cash_date_input').value) : '',
    'AICS': $('memberAics').value || '',
    'AICS_Date': $('member_aics_date_input').value ? toSheetDate($('member_aics_date_input').value) : '',
    
    // Preserve existing submittedBy or use current user's full name
    'Submitted By': existingSubmittedBy || getUserFullName()
  };
  editMembers[memberEditIndex] = obj;
}

function updateMemberAgeStage(){
  const date = $('memberBirthdate').value;
  const ageObj = computeAgeDetailed(date);
  if(!ageObj){ 
      $('memberAge').value=''; 
      $('memberStage').value=''; 
      return; 
  }
  $('memberAge').value = ageObj.display;
  $('memberStage').value = ageObj.stage;
}

/* ============ UPDATED MEMBER PANEL NEXT FUNCTION ============ */
function memberPanelNext() {
    // Validate member form
    if (!validateMemberFormForEdit()) {
        return;
    }
    
    const name = $('memberName').value.trim();
    const contact = $('memberContact').value.trim();
    const birthdate = $('memberBirthdate').value;
    const sex = document.querySelector("input[name='member_sex']:checked")?.value;
    
    collectMemberPanelToEdit();
    memberEditIndex++;
    
    if(memberEditIndex >= editMembers.length){
        $('memberPanel')?.classList.remove('open');
        updateEditMembersPreview();
        if(sequenceMode){
            sequenceMode = false;
            saveEditedHousehold(true);
        }
        return;
    }
    
    fillMemberPanelFromEdit(memberEditIndex);
    $('memberPanelTitle').innerText = `Member ${memberEditIndex+1} of ${editMembers.length}`;
}

function memberPanelBack() {
    collectMemberPanelToEdit();
    if(memberEditIndex > 0){ 
        memberEditIndex--; 
        fillMemberPanelFromEdit(memberEditIndex); 
        $('memberPanelTitle').innerText = `Member ${memberEditIndex+1} of ${editMembers.length}`; 
    }
    else { 
        $('memberPanel')?.classList.remove('open'); 
        updateEditMembersPreview(); 
    }
}

/* ============ FIXED: saveEditedHousehold() FUNCTION WITH PREVENTION OF DUPLICATION ============ */
async function saveEditedHousehold(silentReload = false) {
  // Validate the form first
  if (!validateHeadFormForEdit()) {
    console.log("Head form validation failed");
    return;
  }

  console.log("=== DEBUG: Starting save process ===");
  console.log("Data ID:", editDataID);
  
  const btn = $('saveEditBtn');
  const originalText = btn ? btn.innerText : 'Save changes';

  try {
    console.log("Collecting head data...");
    collectHeadFromEditForm();
    
    console.log("Checking government assistance date fields in editHead:");
    console.log("TUPAD_Date:", editHead['TUPAD_Date']);
    console.log("Local 4Ps_Date:", editHead['Local 4Ps_Date']);
    console.log("AICS_Date:", editHead['AICS_Date']);
    
    const expected = Number($('edit_memberCount')?.value || 0);
    console.log("Expected members:", expected);
    
    while (editMembers.length < expected) editMembers.push(createEmptyMember());
    if (editMembers.length > expected) editMembers = editMembers.slice(0, expected);

    console.log("Number of members to save:", editMembers.length);

    const userFullName = getUserFullName();

    // Create properly formatted date for Philippines timezone
    const now = new Date();
    const formattedDate = formatTimestampPH_(now);

    // Add "Last Edited By" field with formatted date
    editHead['Last Edited By'] = userFullName;
    editHead['Last Edit Date'] = formattedDate;

    // Preserve original Submitted On date if it exists
    if (!editHead['Submitted On']) {
      editHead['Submitted On'] = formattedDate;
    }

    // Add Updated By and Updated On fields for tracking
    editHead['Updated By'] = userFullName;
    editHead['Updated On'] = formattedDate;

    // Ensure all members have the correct Data ID with formatted dates
    editMembers.forEach((member, index) => {
      member['Data ID'] = editDataID;
      member['Barangay'] = editHead['Barangay'];
      member['Sitio / Purok'] = editHead['Sitio / Purok'];
      member['Coordinate'] = editHead['Coordinate'];
      member['Coordinates'] = editHead['Coordinates'];

      if (!member['Submitted On']) {
        member['Submitted On'] = formattedDate;
      }

      member['Last Edited By'] = userFullName;
      member['Last Edit Date'] = formattedDate;
      member['Updated By'] = userFullName;
      member['Updated On'] = formattedDate;
    });

    // Clean data before sending - remove undefined, null, and empty objects
    const cleanHead = {};
    for (const key in editHead) {
      if (editHead[key] !== undefined && editHead[key] !== null && editHead[key] !== '') {
        cleanHead[key] = editHead[key];
      }
    }

    const cleanMembers = editMembers.map(member => {
      const cleanMember = {};
      for (const key in member) {
        if (member[key] !== undefined && member[key] !== null && member[key] !== '') {
          cleanMember[key] = member[key];
        }
      }
      return cleanMember;
    });

    console.log("Cleaned head data keys:", Object.keys(cleanHead));
    console.log("Sample government assistance fields in cleanHead:", {
      TUPAD: cleanHead['TUPAD'],
      TUPAD_Date: cleanHead['TUPAD_Date'],
      Local_4Ps: cleanHead['Local 4Ps'],
      Local_4Ps_Date: cleanHead['Local 4Ps_Date']
    });

    console.log("Cleaned head data keys:", Object.keys(cleanHead));
    console.log("Cleaned members count:", cleanMembers.length);

    const fd = new FormData();
    fd.append('action', 'updateHousehold');
    fd.append('dataID', editDataID);
    fd.append('actor', userFullName);
    fd.append('preserveHeadRow', 'true'); // CRITICAL FIX: Prevent head duplication
    fd.append('updateOnly', 'true'); // CRITICAL FIX: Update existing rows instead of creating new
    
    // CRITICAL FIX: Use clean data instead of original
    fd.append('head', JSON.stringify(cleanHead));
    fd.append('members', JSON.stringify(cleanMembers || []));
    
    fd.append('submittedBy', cleanHead['Submitted By'] || userFullName);
    fd.append('barangay', cleanHead['Barangay']);

    // CRITICAL: Add clearExisting flag to tell server to clear existing rows
    fd.append('clearExisting', 'true');

    // Set loading state AFTER validation
    if (btn) {
      btn.disabled = true;
      btn.innerText = 'Saving...';
    }

    console.log("Sending request to:", SCRIPT_URL);
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 45000);

    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: fd,
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    console.log("Response status:", res.status, res.statusText);
    
    if (!res.ok) {
      const errorText = await res.text();
      console.error("Server error response:", errorText);
      
      // Try to parse as JSON first
      try {
        const errorJson = JSON.parse(errorText);
        throw new Error(`Server error: ${errorJson.message || JSON.stringify(errorJson)}`);
      } catch (parseError) {
        // If not JSON, use raw text
        throw new Error(`Server responded with status: ${res.status} - ${res.statusText}. Response: ${errorText.substring(0, 200)}`);
      }
    }

    const text = await res.text();
    console.log("Raw server response:", text);
    
    let json;
    try {
      json = JSON.parse(text);
      console.log("Parsed server response:", json);
    } catch (e) {
      console.error("Failed to parse server response as JSON:", e);
      console.error("Response text that failed to parse:", text);
      throw new Error(`Server returned invalid JSON: ${e.message}. Response: ${text.substring(0, 200)}`);
    }

    if (!json.success) {
      console.error("Server returned success=false:", json);
      
      // Check for specific error messages
      let errorMessage = json.message || 'Unknown server error';
      if (typeof errorMessage === 'object') {
        errorMessage = JSON.stringify(errorMessage);
      }
      
      showError(`Save failed: ${errorMessage}`);
      
      // If there's a specific error about serialization, provide more info
      if (errorMessage.includes('JSON') || errorMessage.includes('serializ')) {
        console.error("Possible data serialization issue. Data sent:", {
          headKeys: Object.keys(cleanHead),
          membersCount: cleanMembers.length,
          headSample: Object.keys(cleanHead).slice(0, 5).map(key => `${key}: ${cleanHead[key]}`)
        });
      }
} else {
  console.log("Save successful! Response:", json);
  if (!silentReload) showSuccess(`Household updated (Data ID: ${editDataID || ''})`);
  closeEditPanel();
  resetFormTracking();

  // Clear cache and reload
  localStorage.removeItem('recordsCache');
  localStorage.removeItem('recordsCacheTime');
  loadRecords();
  
  // ============ CRITICAL: ADD THIS CODE FOR DASHBOARD NOTIFICATION ============
  // Notify dashboard about the update
  const headName = $('edit_householdHead')?.value?.trim() || editHead['Name of Household Head'] || 'Unknown';
  const barangay = $('edit_barangay')?.value || editHead['Barangay'] || 'Unknown';
  const username = localStorage.getItem("staffName") || localStorage.getItem("username") || "Unknown User";
  
  // Store activity for dashboard to pick up
  const activity = {
    action: 'Update Household',
    actor: username,
    details: `Updated household ${headName} in ${barangay} (ID: ${editDataID})`,
    timestamp: new Date().toISOString()
  };
  
  // Save to localStorage for dashboard
  const activities = JSON.parse(localStorage.getItem('crossTabActivities') || '[]');
  activities.push(activity);
  if (activities.length > 10) activities.shift(); // Keep only last 10
  localStorage.setItem('crossTabActivities', JSON.stringify(activities));
  
  // Trigger dashboard refresh
  localStorage.setItem('lastActivityTrigger', Date.now().toString());
  localStorage.setItem('dashboardUpdateTrigger', Date.now().toString());
  localStorage.removeItem('dashboardDataCache'); // Clear dashboard cache
  
  // Record activity to server audit trail
  try {
    const logFormData = new FormData();
    logFormData.append("action", "logActivity");
    logFormData.append("username", username);
    logFormData.append("action", "Update Household");
    logFormData.append("actor", username);
    logFormData.append("details", `Updated household ID ${editDataID} for ${headName}`);
    fetch(SCRIPT_URL, { method: "POST", body: logFormData }).catch(() => {});
  } catch (err) {
    console.log("Activity logging error:", err);
  }
  // ============ END OF ADDED CODE ============
  
  // Record activity for local tracking
  recordPageActivity('Household Updated', `Updated household ${editDataID} (${editHead['Name of Household Head'] || 'Unknown'})`);
}
  } catch (err) {
    console.error('Detailed save error:', {
      name: err.name,
      message: err.message,
      stack: err.stack,
      fullError: err
    });
    
    if (err.name === 'AbortError') {
      showError('Request timed out after 45 seconds. Please check your internet connection and try again.');
    } else if (err.message.includes('JSON')) {
      showError('Data format error. Please contact the administrator. Details: ' + err.message.substring(0, 100));
    } else {
      showError(`Error saving data: ${err.message}\nPlease try again.`);
    }
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.innerText = originalText || 'Save changes';
    }
  }
}

/* ============ DELETE HOUSEHOLD WITH MODAL ============ */
let deletePendingId = null;
let deletePendingHeadName = '';
let deletePendingBarangay = '';

function showDeleteConfirmation(id, headName = '', barangay = '') {
  deletePendingId = id;
  deletePendingHeadName = headName;
  deletePendingBarangay = barangay;
  
  const message = headName && barangay 
    ? `Are you sure you want to delete household "${headName}" from ${barangay}? This action cannot be undone.`
    : `Are you sure you want to delete household (ID: ${id})? This action cannot be undone.`;
  
  document.getElementById('deleteMessage').textContent = message;
  showModal('deleteConfirmationModal');
}

// Update the current onDelete function to use the modal
function onDelete(id, headName = '', barangay = ''){
    showDeleteConfirmation(id, headName, barangay);
}

async function performDelete() {
    if (!deletePendingId) return;
    
    const id = deletePendingId;
    const currentUserFullName = getUserFullName();

    // Get the delete button and its elements
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    
    // Store original button content
    const originalBtnContent = confirmDeleteBtn ? confirmDeleteBtn.innerHTML : '';
    
    // Set loading state on the button itself
    if (confirmDeleteBtn) {
        confirmDeleteBtn.disabled = true;
        // Replace button content with spinner and "Deleting..."
        confirmDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    }
    
    if (cancelDeleteBtn) {
        cancelDeleteBtn.disabled = true; // Disable cancel button during deletion
    }

    try {
        const fd = new FormData();
        fd.append("action", "deleteHousehold");
        fd.append("dataID", id);
        fd.append("actor", currentUserFullName);

        const res = await fetch(SCRIPT_URL, { 
            method: "POST", 
            body: fd 
        });
        
        if (!res.ok) {
            throw new Error(`Server responded with status: ${res.status}`);
        }
        
        const json = await res.json();

        if(json.success){
            showSuccess(`Household deleted successfully. Data ID: ${id}`);
            
            // ============ ADD THIS CODE FOR DASHBOARD NOTIFICATION ============
            // Notify dashboard about the deletion
            const username = localStorage.getItem("staffName") || localStorage.getItem("username") || "Unknown User";
            const headName = deletePendingHeadName || 'Unknown Household';
            const barangay = deletePendingBarangay || 'Unknown Barangay';
            
            // Store activity for dashboard to pick up
            const activity = {
                action: 'Delete Household',
                actor: username,
                details: `Deleted household ${headName} from ${barangay} (ID: ${id})`,
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage for dashboard
            const activities = JSON.parse(localStorage.getItem('crossTabActivities') || '[]');
            activities.push(activity);
            if (activities.length > 10) activities.shift(); // Keep only last 10
            localStorage.setItem('crossTabActivities', JSON.stringify(activities));
            
            // Trigger dashboard refresh
            localStorage.setItem('lastActivityTrigger', Date.now().toString());
            localStorage.setItem('dashboardUpdateTrigger', Date.now().toString());
            localStorage.removeItem('dashboardDataCache'); // Clear dashboard cache
            
            // Record activity to server audit trail
            try {
                const logFormData = new FormData();
                logFormData.append("action", "logActivity");
                logFormData.append("username", username);
                logFormData.append("action", "Delete Household");
                logFormData.append("actor", username);
                logFormData.append("details", `Deleted household ID ${id} - ${headName}`);
                fetch(SCRIPT_URL, { method: "POST", body: logFormData }).catch(() => {});
            } catch (err) {
                console.log("Activity logging error:", err);
            }
            // ============ END OF ADDED CODE ============
            
            // Clear cache and reload
            localStorage.removeItem('recordsCache');
            localStorage.removeItem('recordsCacheTime');
            
            // Close modal first
            hideModal('deleteConfirmationModal');
            deletePendingId = null;
            deletePendingHeadName = '';
            deletePendingBarangay = '';
            
            // Reset button state
            if (confirmDeleteBtn) {
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.innerHTML = originalBtnContent;
            }
            if (cancelDeleteBtn) {
                cancelDeleteBtn.disabled = false;
            }
            
            // Reload records after a short delay
            setTimeout(() => {
                loadRecords();
            }, 1000);
        } else {
            showError("Delete failed: " + (json.message || JSON.stringify(json)));
            // Reset button state on error
            if (confirmDeleteBtn) {
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.innerHTML = originalBtnContent;
            }
            if (cancelDeleteBtn) {
                cancelDeleteBtn.disabled = false;
            }
        }
    } catch(err) {
        console.error("Delete error", err);
        showError("Delete failed. Please check your connection and try again.");
        // Reset button state on error
        if (confirmDeleteBtn) {
            confirmDeleteBtn.disabled = false;
            confirmDeleteBtn.innerHTML = originalBtnContent;
        }
        if (cancelDeleteBtn) {
            cancelDeleteBtn.disabled = false;
        }
    }
}

function setLoadingState(loading) {
    const overlay = document.getElementById('loading');
    if (overlay) {
        overlay.style.display = loading ? 'flex' : 'none';
    }
    
    // Disable/enable modal buttons during loading
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    
    if (cancelDeleteBtn) cancelDeleteBtn.disabled = loading;
    if (confirmDeleteBtn) confirmDeleteBtn.disabled = loading;
}

/* ============ FIXED CONTACT VALIDATION ============ */
function setupContactValidation() {
  // Head contact validation
  const editContactInput = $('edit_contactNo');
  const editContactError = $('edit_contactError');
  
  if (editContactInput) {
    let previousValue = '';
    
    editContactInput.addEventListener('input', function() {
      const currentValue = this.value;
      
      // Only format if user is typing (not pasting) and we have 4+ digits
      if (currentValue.length > previousValue.length) { // User is adding characters
        // Remove all non-digit characters
        let digits = currentValue.replace(/\D/g, '');
        
        // Don't format until we have at least 4 digits
        if (digits.length >= 4) {
          // Apply formatting
          if (digits.startsWith('09') && digits.length <= 11) {
            // Format as 09XX XXX XXXX
            if (digits.length <= 4) {
              this.value = digits;
            } else if (digits.length <= 7) {
              this.value = digits.substring(0, 4) + ' ' + digits.substring(4);
            } else {
              this.value = digits.substring(0, 4) + ' ' + 
                          digits.substring(4, 7) + ' ' + 
                          digits.substring(7, 11);
            }
          } else if (digits.startsWith('9') && digits.length <= 10) {
            // Format as 0XXX XXX XXXX
            digits = '0' + digits;
            if (digits.length <= 4) {
              this.value = digits;
            } else if (digits.length <= 7) {
              this.value = digits.substring(0, 4) + ' ' + digits.substring(4);
            } else {
              this.value = digits.substring(0, 4) + ' ' + 
                          digits.substring(4, 7) + ' ' + 
                          digits.substring(7, 11);
            }
          } else {
            this.value = digits.substring(0, 13); // Limit to max length
          }
        } else {
          this.value = digits;
        }
      }
      
      previousValue = this.value;
      
      // Clear error on input
      this.classList.remove('input-error');
      if (editContactError) editContactError.style.display = 'none';
    });
    
    editContactInput.addEventListener('blur', function() {
      // Final format on blur
      const formatted = formatContactNumber(this.value);
      if (formatted !== this.value) {
        this.value = formatted;
      }
      validateContactInput(this, editContactError);
    });
  }
  
  // Member contact validation - apply same fix
  const memberContactInput = $('memberContact');
  const memberContactError = $('memberContactError');
  
  if (memberContactInput) {
    let previousMemberValue = '';
    
    memberContactInput.addEventListener('input', function() {
      const currentValue = this.value;
      
      // Only format if user is typing (not pasting)
      if (currentValue.length > previousMemberValue.length) {
        // Remove all non-digit characters
        let digits = currentValue.replace(/\D/g, '');
        
        // Don't format until we have at least 4 digits
        if (digits.length >= 4) {
          // Apply formatting
          if (digits.startsWith('09') && digits.length <= 11) {
            // Format as 09XX XXX XXXX
            if (digits.length <= 4) {
              this.value = digits;
            } else if (digits.length <= 7) {
              this.value = digits.substring(0, 4) + ' ' + digits.substring(4);
            } else {
              this.value = digits.substring(0, 4) + ' ' + 
                          digits.substring(4, 7) + ' ' + 
                          digits.substring(7, 11);
            }
          } else if (digits.startsWith('9') && digits.length <= 10) {
            // Format as 0XXX XXX XXXX
            digits = '0' + digits;
            if (digits.length <= 4) {
              this.value = digits;
            } else if (digits.length <= 7) {
              this.value = digits.substring(0, 4) + ' ' + digits.substring(4);
            } else {
              this.value = digits.substring(0, 4) + ' ' + 
                          digits.substring(4, 7) + ' ' + 
                          digits.substring(7, 11);
            }
          } else {
            this.value = digits.substring(0, 13); // Limit to max length
          }
        } else {
          this.value = digits;
        }
      }
      
      previousMemberValue = this.value;
      
      // Clear error on input
      this.classList.remove('input-error');
      if (memberContactError) memberContactError.style.display = 'none';
    });
    
    memberContactInput.addEventListener('blur', function() {
      // Final format on blur
      const formatted = formatContactNumber(this.value);
      if (formatted !== this.value) {
        this.value = formatted;
      }
      validateContactInput(this, memberContactError);
    });
  }
}

/* ============ TRACK UNSAVED CHANGES ============ */
let originalEditFormData = null;
let originalMemberFormData = null;

function captureOriginalFormState() {
  if ($('editPanel') && $('editPanel').classList.contains('open')) {
    // Capture head form state
    originalEditFormData = {
      barangay: $('edit_barangay').value,
      sitio: $('edit_sitio').value,
      householdHead: $('edit_householdHead').value,
      contactNo: $('edit_contactNo').value,
      head_sex: document.querySelector("input[name='edit_head_sex']:checked")?.value,
      householdBirthdate: $('edit_householdBirthdate').value,
      memberCount: $('edit_memberCount').value,
      coordinate: $('edit_coordinate').value,
      educationalAttainment: $('edit_educationalAttainment').value,
      employment: $('edit_employment').value,
      headRegistered: $('edit_headRegisteredCheckbox').checked,
      headRegistration: $('edit_headRegistration').value,
      // Add more fields for better change detection
      head_pwd: document.querySelector("input[name='edit_head_pwd']:checked")?.value,
      head_status: $('edit_head_status').value,
      head_transport: $('edit_head_transport').value,
      ofw_status: document.querySelector("input[name='edit_ofw_status']:checked")?.value,
      country: $('edit_country').value
    };
    
    // Capture member form state if open
    if ($('memberPanel') && $('memberPanel').classList.contains('open')) {
      originalMemberFormData = {
        memberName: $('memberName').value,
        memberContact: $('memberContact').value,
        member_sex: document.querySelector("input[name='member_sex']:checked")?.value,
        memberBirthdate: $('memberBirthdate').value,
        memberRegistered: $('memberRegisteredCheckbox').checked,
        memberRegistration: $('memberRegistration').value
      };
    }
  }
}

function hasUnsavedChanges() {
  if (!$('editPanel') || !$('editPanel').classList.contains('open')) {
    return false;
  }
  
  // If no original data captured yet, check if any field has data
  if (!originalEditFormData) {
    // Check required fields
    const requiredFields = [
      $('edit_barangay').value,
      $('edit_sitio').value,
      $('edit_householdHead').value,
      $('edit_contactNo').value,
      document.querySelector("input[name='edit_head_sex']:checked")?.value,
      $('edit_householdBirthdate').value
    ];
    
    return requiredFields.some(field => field && field.trim() !== '');
  }
  
  // Compare current form with original state
  const currentState = {
    barangay: $('edit_barangay').value,
    sitio: $('edit_sitio').value,
    householdHead: $('edit_householdHead').value,
    contactNo: $('edit_contactNo').value,
    head_sex: document.querySelector("input[name='edit_head_sex']:checked")?.value,
    householdBirthdate: $('edit_householdBirthdate').value,
    memberCount: $('edit_memberCount').value,
    coordinate: $('edit_coordinate').value,
    educationalAttainment: $('edit_educationalAttainment').value,
    employment: $('edit_employment').value,
    headRegistered: $('edit_headRegisteredCheckbox').checked,
    headRegistration: $('edit_headRegistration').value,
    head_pwd: document.querySelector("input[name='edit_head_pwd']:checked")?.value,
    head_status: $('edit_head_status').value,
    head_transport: $('edit_head_transport').value,
    ofw_status: document.querySelector("input[name='edit_ofw_status']:checked")?.value,
    country: $('edit_country').value
  };
  
  // Check if any field has changed
  for (const key in originalEditFormData) {
    if (originalEditFormData[key] !== currentState[key]) {
      return true;
    }
  }
  
  // Check member panel if open
  if ($('memberPanel') && $('memberPanel').classList.contains('open') && originalMemberFormData) {
    const currentMemberState = {
      memberName: $('memberName').value,
      memberContact: $('memberContact').value,
      member_sex: document.querySelector("input[name='member_sex']:checked")?.value,
      memberBirthdate: $('memberBirthdate').value,
      memberRegistered: $('memberRegisteredCheckbox').checked,
      memberRegistration: $('memberRegistration').value
    };
    
    for (const key in originalMemberFormData) {
      if (originalMemberFormData[key] !== currentMemberState[key]) {
        return true;
      }
    }
  }
  
  return false;
}

function resetFormTracking() {
  originalEditFormData = null;
  originalMemberFormData = null;
}

/* ============ EDIT CONFIRMATION MODAL FUNCTIONS ============ */
function showEditCloseConfirmation(source) {
  // Update modal message based on source
  let message = "You have unsaved changes. Are you sure you want to close the edit panel?";
  
  if (source === 'cancel') {
    message = "Discard ALL changes and close? This includes both head and member changes.";
  } else if (source === 'overlay') {
    message = "Close edit panel? ALL unsaved changes will be lost.";
  }
  
  document.getElementById('editMessage').textContent = message;
  showModal('editConfirmationModal');
  
  // Store the action to perform on confirmation
  const modal = document.getElementById('editConfirmationModal');
  modal.dataset.action = source;
}

function handleEditCloseConfirmation() {
  const modal = document.getElementById('editConfirmationModal');
  const action = modal.dataset.action;
  
  hideModal('editConfirmationModal');
  
  // Clear form and close panel
  clearValidationErrors('editForm');
  closeEditPanel();
  resetFormTracking();
  
  // If there's an action, we might want to do something specific
  console.log('Edit panel closed via action:', action);
  
  // Clear the stored action
  if (modal) {
    delete modal.dataset.action;
  }
}

function cancelEditClose() {
  hideModal('editConfirmationModal');
  // Reset the action data
  const modal = document.getElementById('editConfirmationModal');
  if (modal) {
    delete modal.dataset.action;
  }
}

/* ============ FIXED WIRE EDIT PANEL UI ============ */
function wireEditPanelUI() {
  console.log("wiring edit panel UI");
  
  // Coordinate buttons
  if ($('edit_getLocationBtn')) {
    $('edit_getLocationBtn').addEventListener('click', getCurrentLocation);
  }
  
  if ($('edit_hazardHunterBtn')) {
    $('edit_hazardHunterBtn').addEventListener('click', openHazardHunterPicker);
  }

  // Coordinate modal buttons
  if ($('modal_getLocationBtn')) {
    $('modal_getLocationBtn').addEventListener('click', getCurrentLocationForModal);
  }
  
  if ($('modal_hazardHunterBtn')) {
    $('modal_hazardHunterBtn').addEventListener('click', openHazardHunterForModal);
  }
  
  if ($('modal_saveBtn')) {
    $('modal_saveBtn').addEventListener('click', saveCoordinateFromModal);
  }
  
  if ($('modal_cancelBtn')) {
    $('modal_cancelBtn').addEventListener('click', closeCoordinateModal);
  }

  // Setup contact validation
  setupContactValidation();

  /* ============ DISPLACEMENT & EVACUATION EVENT LISTENERS ============ */
  // Add event listeners for displacement checkboxes to show assembly area options
const displacementCheckboxes = document.querySelectorAll('.edit_displacement-reason, #edit_displacement_other_check');
displacementCheckboxes.forEach(cb => {
  cb.addEventListener('change', function() {
    const anyChecked = Array.from(displacementCheckboxes).some(cb => cb.checked);
    if (anyChecked) {
      $('edit_assemblyAreaOptions').style.display = 'block';
    } else {
      $('edit_assemblyAreaOptions').style.display = 'none';
      $('edit_insideAssemblyFields').style.display = 'none';
      $('edit_outsideAssemblyFields').style.display = 'none';
      // Also uncheck assembly area checkboxes
      $('edit_inside_assembly').checked = false;
      $('edit_outside_assembly').checked = false;
      // Clear all assembly area fields
      $('edit_family_host').value = '';
      $('edit_host_contact').value = '';
      $('edit_pickup').value = '';
      $('edit_assembly_area').value = '';
      $('edit_head_transport').value = '';
      $('edit_outside_transport').value = '';
    }
  });
});

// Add event listeners for inside/outside assembly area checkboxes
const assemblyOptions = document.querySelectorAll('.edit_assembly-option');
assemblyOptions.forEach(option => {
  option.addEventListener('change', function() {
    // Make these checkboxes mutually exclusive
    if (this.id === 'edit_inside_assembly' && this.checked) {
      $('edit_outside_assembly').checked = false;
      $('edit_insideAssemblyFields').style.display = 'block';
      $('edit_outsideAssemblyFields').style.display = 'none';
      // Clear outside assembly fields
      $('edit_family_host').value = '';
      $('edit_host_contact').value = '';
      $('edit_outside_transport').value = '';
    } else if (this.id === 'edit_outside_assembly' && this.checked) {
      $('edit_inside_assembly').checked = false;
      $('edit_insideAssemblyFields').style.display = 'none';
      $('edit_outsideAssemblyFields').style.display = 'block';
      // Clear inside assembly fields
      $('edit_pickup').value = '';
      $('edit_assembly_area').value = '';
      $('edit_head_transport').value = '';
    }
  });
});

// Make inside/outside checkboxes mutually exclusive by default
if ($('edit_inside_assembly')) {
  $('edit_inside_assembly').addEventListener('click', function() {
    if (this.checked) {
      $('edit_outside_assembly').checked = false;
    }
  });
}

if ($('edit_outside_assembly')) {
  $('edit_outside_assembly').addEventListener('click', function() {
    if (this.checked) {
      $('edit_inside_assembly').checked = false;
    }
  });
}

// Add event listener for "Other Reason" checkbox
const displacementOtherCheck = $('edit_displacement_other_check');
if (displacementOtherCheck) {
  displacementOtherCheck.addEventListener('change', function() {
    if (this.checked) {
      $('edit_displacementOtherField').classList.add('show');
      $('edit_displacement_other').required = true;
    } else {
      $('edit_displacementOtherField').classList.remove('show');
      $('edit_displacement_other').required = false;
      $('edit_displacement_other').value = '';
    }
  });
}
  /* ============ END DISPLACEMENT EVENT LISTENERS ============ */

  // Add/Edit Members button - FIXED: Now properly adds members
  if($('edit_addMember')) $('edit_addMember').addEventListener('click', ()=>{
    // Validate the head information first
    if (!validateEditPanelForMemberEditing()) {
      return;
    }
    
    // Collect head data to ensure it's saved
    collectHeadFromEditForm();
    
    // Get current member count from input field
    const currentCount = parseInt($('edit_memberCount').value) || 0;
    
    // Update the member count input
    $('edit_memberCount').value = currentCount + 1;
    
    // Create a new empty member and add it to the array
    const newMember = createEmptyMember();
    editMembers.push(newMember);
    
    // Update the preview to show the new member
    updateEditMembersPreview();
    
    // Open the member panel for editing the new member
    memberEditIndex = editMembers.length - 1;
    openMemberPanelForEdit(memberEditIndex);
  });

  // Remove Member button - NEW MODAL VERSION
  if($('edit_removeMember')) $('edit_removeMember').addEventListener('click', showRemoveMemberModal);

  // Member panel navigation
  if($('memberNext')) $('memberNext').addEventListener('click', memberPanelNext);
  if($('memberBack')) $('memberBack').addEventListener('click', memberPanelBack);
  
  // NEW: Member panel Cancel button
  if($('memberCancel')) $('memberCancel').addEventListener('click', handleMemberCancel);
  
  // FIXED: Member panel close button - simple check for member panel
  if($('memberPanelClose')) $('memberPanelClose').addEventListener('click', ()=> {
    const memberName = $('memberName')?.value?.trim();
    const memberContact = $('memberContact')?.value?.trim();
    const memberBirthdate = $('memberBirthdate')?.value;
    
    if (memberName || memberContact || memberBirthdate) {
      if(confirm('Close member panel? Unsaved member changes will be lost.')) {
        // Clear form and close
        clearMemberForm();
        $('memberPanel')?.classList.remove('open');
      }
    } else {
      $('memberPanel')?.classList.remove('open');
    }
  });
  
  // Date change handlers
  if($('memberBirthdate')) $('memberBirthdate').addEventListener('change', updateMemberAgeStage);
  if($('edit_householdBirthdate')) $('edit_householdBirthdate').addEventListener('change', updateEditHeadAgeStage);
  
  // Member count change handler
  if ($('edit_memberCount')) {
    $('edit_memberCount').addEventListener('change', function() {
      const newCount = parseInt(this.value) || 0;
      const currentCount = editMembers.length;
      
      if (newCount < currentCount) {
        // Remove extra members
        if (confirm(`Reduce members from ${currentCount} to ${newCount}? This will remove the last ${currentCount - newCount} member(s).`)) {
          editMembers = editMembers.slice(0, newCount);
          updateEditMembersPreview();
        } else {
          this.value = currentCount;
        }
      } else if (newCount > currentCount) {
        // Add empty members
        const toAdd = newCount - currentCount;
        for (let i = 0; i < toAdd; i++) {
          editMembers.push(createEmptyMember());
        }
        updateEditMembersPreview();
      }
    });
  }

  // FIXED: Cancel button - check for unsaved changes with modal
  if($('cancelEditBtn')) $('cancelEditBtn').addEventListener('click', ()=> { 
    if(hasUnsavedChanges()) {
      showEditCloseConfirmation('cancel');
    } else {
      clearValidationErrors('editForm');
      closeEditPanel();
      resetFormTracking();
    }
  });

  // FIXED: Panel close button - check for unsaved changes with modal
  if($('panelClose')) $('panelClose').addEventListener('click', ()=> { 
    if(hasUnsavedChanges()) {
      showEditCloseConfirmation('close');
    } else {
      clearValidationErrors('editForm');
      closeEditPanel();
      resetFormTracking();
    }
  });

  // FIXED: Overlay click - separate logic for member panel vs edit panel with modal
  if($('panelOverlay')) $('panelOverlay').addEventListener('click', ()=>{
    if($('memberPanel')?.classList.contains('open')) {
      // For member panel, check if there are unsaved changes
      const memberName = $('memberName')?.value?.trim();
      const memberContact = $('memberContact')?.value?.trim();
      const memberBirthdate = $('memberBirthdate')?.value;
      
      if (memberName || memberContact || memberBirthdate) {
        if(confirm('Close member panel? Unsaved member changes will be lost.')) {
          // Clear form and close
          clearMemberForm();
          $('memberPanel')?.classList.remove('open');
        }
      } else {
        $('memberPanel')?.classList.remove('open');
      }
      return;
    }
    
    // For edit panel, check for unsaved changes with modal
    if(hasUnsavedChanges()) {
      showEditCloseConfirmation('overlay');
    } else {
      closeEditPanel();
      resetFormTracking();
    }
  });

  // Start sequence button
  if($('startSequenceBtn')) $('startSequenceBtn').addEventListener('click', (ev)=> {
    ev.preventDefault();
    
    // Validate ALL head required fields first
    const requiredFields = [
      { id: 'edit_barangay', name: 'Barangay' },
      { id: 'edit_sitio', name: 'Sitio/Purok' },
      { id: 'edit_householdHead', name: 'Household Head Name' },
      { id: 'edit_contactNo', name: 'Contact Number' },
      { id: 'edit_householdBirthdate', name: 'Birthdate' }
    ];
    
    for (const field of requiredFields) {
      const element = $(field.id);
      if (!element || !element.value.trim()) {
        alert(`Please fill in ${field.name}`);
        element?.focus();
        return;
      }
    }
    
    // Validate contact number
    if (!validateContactInput($('edit_contactNo'), $('edit_contactError'))) {
      alert('Please enter a valid Philippine mobile number for the household head');
      $('edit_contactNo').focus();
      return;
    }
    
    // Check if sex is selected
    const headSex = document.querySelector("input[name='edit_head_sex']:checked")?.value;
    if (!headSex) {
      alert('Please select head sex');
      qAll("input[name='edit_head_sex']")[0]?.focus();
      return;
    }
    
    collectHeadFromEditForm();
    const expected = Number($('edit_memberCount')?.value || 0);
    
    // Ensure we have the right number of members
    while(editMembers.length < expected) editMembers.push(createEmptyMember());
    if (expected === 0) {
        // No members, just save
        saveEditedHousehold(true);
        return;
    }
    
    // Start member sequence
    sequenceMode = true; 
    memberEditIndex = 0; 
    openMemberPanelForEdit(memberEditIndex);
  });

  // Save edit button - FIXED VERSION
  if($('saveEditBtn')) $('saveEditBtn').addEventListener('click', async (ev)=> { 
    ev.preventDefault(); 
    
    const btn = $('saveEditBtn');
    const originalBtnText = btn ? btn.innerText : 'Save changes';
    
    // Validate head data FIRST using the new function
    if (!validateHeadFormForEdit()) {
      return; // Stop if validation fails - validation summary will show automatically
    }
    
    // Validate all members if there are any
    if (editMembers.length > 0) {
      const invalidMembers = [];
      editMembers.forEach((member, index) => {
        if (!member['Name of Household Member/s'] || !member['Name of Household Member/s'].trim()) {
          invalidMembers.push(index + 1);
        }
      });
      
      if (invalidMembers.length > 0) {
        if (confirm(`Members #${invalidMembers.join(', ')} are missing names. Save anyway?`)) {
          // Set loading state
          if(btn){ btn.disabled = true; btn.innerText = 'Saving...'; }
          try {
            await saveEditedHousehold(false);
          } finally {
            if(btn){ 
              btn.disabled = false; 
              btn.innerText = originalBtnText; 
            }
          }
        }
        return;
      }
    }
    
    // Set loading state
    if(btn){ btn.disabled = true; btn.innerText = 'Saving...'; }
    try {
      await saveEditedHousehold(false);
    } finally {
      if(btn){ 
        btn.disabled = false; 
        btn.innerText = originalBtnText; 
      }
    }
  });
  
  // Setup government assistance date field handlers for edit panel
  setupEditGovernmentAssistanceDateHandlers();
  
  // Setup member government assistance date field handlers
  setupMemberGovernmentAssistanceDateHandlers();
  
  // Initialize government assistance date fields based on current state
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize head government assistance date fields
    const headGovCheckboxes = [
      'edit_ass_tupad', 'edit_ass_local4ps', 'edit_ass_intl4ps', 
      'edit_ass_locsp', 'edit_ass_intlsp', 'edit_ass_solo', 
      'edit_ass_relief', 'edit_ass_cash'
    ];
    
    headGovCheckboxes.forEach(checkboxId => {
      const checkbox = $(checkboxId);
      const dateFieldId = checkboxId + '_date';
      const dateField = $(dateFieldId);
      
      if (checkbox && dateField && checkbox.checked) {
        dateField.classList.add('show');
      }
    });
    
    // Initialize head AICS date field
    const aicsSelect = $('edit_ass_aics');
    const aicsDateField = $('edit_ass_aics_date');
    if (aicsSelect && aicsDateField && aicsSelect.value && aicsSelect.value !== "") {
      aicsDateField.classList.add('show');
    }
  });
}

/* ============ EXPORT ============ */
function exportAll(){ 
    exportCSV(filteredGroups); 
}

function exportSelected(){
    const arr = filteredGroups.filter(g => selected.has(g.dataID));
    if(!arr.length) return alert("No selected rows");
    exportCSV(arr);
}

function exportCSV(list){
    const cols = header.slice();
    const lines = [];
    lines.push(cols.map(c => `"${c.replace(/"/g,'""')}"`).join(","));
    
    list.forEach(g=>{
        lines.push(cols.map(c => `"${(g.head[c]||"").toString().replace(/"/g,'""')}"`).join(","));
        (g.members || []).forEach(m => {
            lines.push(cols.map(c => `"${(m[c]||"").toString().replace(/"/g,'""')}"`).join(","));
        });
    });
    
    const blob = new Blob([lines.join("\r\n")], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); 
    a.href = url; 
    a.download = "records.csv"; 
    a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 500);
}

/* ============ SIDEBAR COLLAPSE ============ */
function toggleSidebar() {
    const pageContainer = document.querySelector('.page-container');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const icon = sidebarToggle.querySelector('i');
    
    pageContainer.classList.toggle('collapsed');
    
    if (pageContainer.classList.contains('collapsed')) {
        icon.className = 'fas fa-chevron-right';
        sidebarToggle.title = "Expand sidebar";
    } else {
        icon.className = 'fas fa-bars';
        sidebarToggle.title = "Collapse sidebar";
    }
}

/* ============ MOBILE SIDEBAR TOGGLE ============ */
function toggleMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    const icon = mobileToggle.querySelector('i');
    
    sidebar.classList.toggle('mobile-open');
    
    if (sidebar.classList.contains('mobile-open')) {
        icon.className = 'fas fa-times';
        mobileToggle.title = "Close menu";
    } else {
        icon.className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
}


/* ============ UI BINDINGS ============ */
document.getElementById("refreshBtn").onclick = function() {
    localStorage.removeItem('recordsCache');
    localStorage.removeItem('recordsCacheTime');
    loadRecords();
};

// Client-side filtering for search and barangay dropdown
document.getElementById("filterBarangay").onchange = filterRecords;

// Real-time search filtering
document.getElementById("searchInput").addEventListener("input", filterRecords);

// Export dropdown toggle
document.getElementById("exportBtn").onclick = (e) => {
    e.stopPropagation();
    document.getElementById("exportDropdown").classList.toggle("hidden");
};

// Close dropdown when clicking outside
document.addEventListener("click", (e) => {
    const dropdown = document.getElementById("exportDropdown");
    const btn = document.getElementById("exportBtn");
    
    if(!btn.contains(e.target) && !dropdown.contains(e.target)){
        dropdown.classList.add("hidden");
    }
});

// Desktop sidebar toggle
document.getElementById('sidebarToggle').onclick = toggleSidebar;

// Logout button event listener
document.getElementById('logoutBtn').addEventListener('click', handleLogout);

/* ============ WINDOW RESIZE HANDLER ============ */
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        const sidebar = document.getElementById('sidebar');
        const mobileToggle = document.getElementById('mobileMenuToggle');
        
        sidebar.classList.remove('mobile-open');
        mobileToggle.querySelector('i').className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
});

/* ============ PREVENT BACK BUTTON ISSUES ============ */
window.addEventListener('pageshow', function(event) {
  if (event.persisted) {
    console.log('Page loaded from cache, checking session...');
    
    sessionCheck().then(isAuthenticated => {
      if (isAuthenticated) {
        loadRecords();
      }
    });
  }
});

/* ============ CHECK RETURN FROM HAZARD HUNTER ============ */
function checkReturnFromHazardHunter() {
    window.addEventListener('pageshow', (event) => {
        if (sessionStorage.getItem('awaitingCoordinates') === 'true') {
            // User returned from Hazard Hunter
            setTimeout(() => {
                const coordInput = $('edit_coordinate');
                if (coordInput && !coordInput.value.trim()) {
                    alert("Paste your Hazard Hunter coordinates (Ctrl+V) in the coordinate field.");
                }
            }, 1000);
            sessionStorage.removeItem('awaitingCoordinates');
        }
        
        // Restore form data if we have it
        const tempData = sessionStorage.getItem('tempFormData');
        if (tempData) {
            try {
                const data = JSON.parse(tempData);
                if (data.barangay) $('edit_barangay').value = data.barangay;
                if (data.sitio) $('edit_sitio').value = data.sitio;
                if (data.householdHead) $('edit_householdHead').value = data.householdHead;
                if (data.contactNo) $('edit_contactNo').value = data.contactNo;
                sessionStorage.removeItem('tempFormData');
            } catch (e) {
                console.error("Error restoring form data:", e);
            }
        }
    });
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

/* ============ INIT ============ */
window.addEventListener("DOMContentLoaded", async () => {
  console.log("DOMContentLoaded fired - records page");
  
  // First check session
  const isAuthenticated = await sessionCheck();
  console.log("Session check result:", isAuthenticated);
  
  if (isAuthenticated) {
    // Setup modal handlers BEFORE anything else
    setupModalHandlers();
    
    // Load data if authenticated
    const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
    // Remove 👤 emoji from user display
    document.getElementById("userName").innerText = userName;
    
    // Check if user is admin
    const isAdmin = localStorage.getItem("userRole") === "admin";
    const adminItems = document.querySelectorAll(".admin-only");
    adminItems.forEach(item => {
        item.style.display = isAdmin ? "block" : "none";
    });
    
    // Handle mobile nav for admin
    const mobileUsersNav = document.getElementById('mobileUsersNav');
    if (mobileUsersNav) {
        if (isAdmin) {
            mobileUsersNav.classList.add('admin-visible');
        } else {
            mobileUsersNav.classList.remove('admin-visible');
        }
    }
    
    // Check screen width and adjust sidebar
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.remove('mobile-open');
    }
    
    // Setup conditional fields
    setupEditConditionalFields();
    
    // Wire edit panel UI
    wireEditPanelUI();

    // Initialize government assistance date fields
    initializeGovernmentAssistanceDateFields(); 
    
    // Setup coordinate modal close on overlay click
    $('coordinateModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeCoordinateModal();
      }
    });
    
    // Setup keyboard shortcuts
    setupKeyboardShortcuts();
    
    // Check if returning from Hazard Hunter
    checkReturnFromHazardHunter();
    
    // CRITICAL: Load the records
    console.log("Calling loadRecords()");
    loadRecords();
    
    // Setup activity tracking
    setTimeout(() => {
        setupActivityTrackingForPages();
    }, 500);
  } else {
    console.log("User not authenticated, redirecting to login");
  }
});
</script>
<script src="js/data-broadcaster.js"></script>
<script src="js/form-notifier.js"></script>
<script src="js/common-utils.js"></script>
<script src="js/session-manager.js"></script>
<script src="js/common-session.js"></script>
<script src="js/activity-tracking-final.js"></script>
</body>
</html>
