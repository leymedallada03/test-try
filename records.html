<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MDRRMO Records</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
<div class="page-container">
  <header class="topbar">
    <button id="menuToggle" class="menu-btn">â˜°</button>
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="logo"/>
      <div>
        <div class="title">PUROK KALIGTASAN</div>
        <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
      </div>
    </div>
    <div class="user-info">
      <span id="userName"></span>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <ul>
      <li><a href="dashboard.html">ğŸ“Š Dashboard</a></li>
      <li><a href="dataForm.html">ğŸ“ Data Entry</a></li>
      <li><a href="records.html" class="active">ğŸ“ Records</a></li>
      <li><a href="charts.html">ğŸ“ˆ Charts</a></li>
      <li class="admin-only"><a href="users.html">ğŸ‘¥ User Management</a></li>
    </ul>
  </aside>

  <div id="loading">Loading records...</div>

  <!-- MAIN CONTENT -->
  <main class="content-area">
    <h2>ğŸ“ Household Records</h2>

    <!-- GLOBAL SEARCH -->
    <div class="search-container">
      <input id="searchInput" type="text" placeholder="Search by Barangay / Name / Data ID...">
    </div>
      <button onclick="loadRecords()" class="actions-btn view-btn">Refresh</button>

    <!-- FILTER BAR -->
    <div class="records-container">
      <div class="filter-bar">

        <select id="filterBarangay">
          <option value="">All Barangays</option>
          <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
          <option>Dalipit East</option><option>Dalipit West</option><option>Dominador East</option>
          <option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
          <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option>
          <option>Ping-As</option><option>Poblacion East</option><option>Poblacion West</option>
          <option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
        </select>
        <button onclick="loadRecords()" class="actions-btn view-btn">Refresh</button>
      </div>

      <div class="records-wrapper">
        <table id="recordsTable" class="records-table">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxWs1kxkyleYw6qcQlIx1xsecQS8x2O-nyXxbcdcm5DVst6IcmDKR-NmzSgBxyH7ErvpA/exec";

window.onload = () => loadRecords();

function showLoading(show) {
  document.getElementById('loading').style.display = show ? "flex" : "none";
}

function loadRecords() {
  showLoading(true);

  const filterBarangay = encodeURIComponent(document.getElementById("filterBarangay").value);
  const filterStage = encodeURIComponent(document.getElementById("filterStage").value);
  const q = encodeURIComponent(document.getElementById("searchInput").value);

  const callbackName = "recordsLoaded_" + Date.now();
  window[callbackName] = recordsLoaded;

  const url = `${scriptURL}?action=getRecords&filterBarangay=${filterBarangay}&filterStage=${filterStage}&q=${q}&callback=${callbackName}`;

  const s = document.createElement("script");
  s.src = url;

  s.onload = () => s.remove();
  s.onerror = () => {
    alert("Error loading records (JSONP failed)");
    showLoading(false);
  };

  document.body.appendChild(s);
}

function recordsLoaded(response) {
  if (!response || !response.success) {
    alert("Failed to load records");
    showLoading(false);
    return;
  }

  renderTable(response.header, response.rows);
  showLoading(false);
}

function renderTable(header, rows) {
  const thead = document.getElementById("tableHead");
  const tbody = document.getElementById("tableBody");

  thead.innerHTML = "";
  tbody.innerHTML = "";

  let h = "<tr>";
  header.forEach(col => h += `<th>${col}</th>`);
  h += `<th>Actions</th></tr>`;
  thead.innerHTML = h;

  rows.forEach(r => {
    let row = "<tr>";

    header.forEach(col => {
      row += `<td>${r[col] ?? ""}</td>`;
    });

    row += `
      <td>
        <button class="icon-btn" onclick="editRecord('${r["Data ID"]}')">âœï¸</button>
        <button class="icon-btn" onclick="deleteRecord('${r["Data ID"]}')">ğŸ—‘ï¸</button>
      </td>
    </tr>`;

    tbody.innerHTML += row;
  });
}

function editRecord(dataID) {
  localStorage.setItem("edit_dataID", dataID);
  window.location.href = "edit.html";
}

async function deleteRecord(dataID) {
  if (!confirm("Delete household " + dataID + "?")) return;

  const body = { action: "deleteHousehold", dataID };

  try {
    const res = await fetch(scriptURL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });

    const data = JSON.parse(await res.text());
    alert(data.message);

    loadRecords();
  } catch (err) {
    alert("Delete failed");
  }
}
</script>

</body>
</html>

