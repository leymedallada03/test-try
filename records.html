<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan ‚Äî Household Records</title>
<link rel="stylesheet" href="styles.css"/>

<style>
/* compact, finished styles for records page (overrides + small tweaks) */

.page-container{max-width:1200px;margin:20px auto;padding:12px;display:grid;grid-template-columns:260px 1fr;gap:18px;align-items:start}
.topbar{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-radius:12px;background:linear-gradient(90deg,#0f7a4a,#34b78f);color:#fff;box-shadow:0 6px 20px rgba(5,40,25,0.12)}
.brand{display:flex;gap:12px;align-items:center}.brand .logo{width:48px;height:48px;border-radius:8px;object-fit:contain}
.sidebar{background:linear-gradient(180deg,rgba(255,255,255,0.35),rgba(255,255,255,0.20));border-radius:12px;padding:12px;height:calc(100vh - 120px);position:sticky;top:72px;overflow:auto}
.content-area{background:linear-gradient(180deg,rgba(255,255,255,0.72),rgba(255,255,255,0.6));border-radius:12px;padding:18px;box-shadow:0 8px 22px rgba(10,20,16,0.06);min-height:72vh}

/* toolbar */
.search-box{padding:8px 12px;border:1px solid #bbb;border-radius:8px;min-width:220px}
.brgy-dropdown{padding:8px;border-radius:8px;border:1px solid #ccc}
.btn-main{padding:6px 10px;border-radius:8px;background:linear-gradient(90deg,#0f7a4a,#34b78f);color:#fff;border:0;font-weight:700;cursor:pointer}
.btn-secondary{padding:6px 10px;border-radius:8px;border:1px solid #0f7a4a;background:#fff;color:#0f7a4a;font-weight:700;cursor:pointer}

/* records wrapper/table */
.records-wrapper{margin-top:14px;background:rgba(255,255,255,0.95);border-radius:12px;box-shadow:0 8px 22px rgba(6,30,20,0.06);overflow:auto}
.records-table{width:100%;min-width:1400px;border-collapse:collapse}
.records-table th,.records-table td{padding:6px 8px;font-size:13px;border-bottom:1px solid rgba(15,122,74,0.12);vertical-align:middle}
.records-table thead th{background:rgba(15,122,74,0.08);font-weight:800;position:sticky;top:0;z-index:6}
.records-table tbody tr:hover{background:rgba(52,183,143,0.05)}

/* sticky columns */
.select-col{position:sticky;left:0;background:rgba(255,255,255,0.95);z-index:7;padding-left:10px}
.actions-col{position:sticky;right:0;background:rgba(255,255,255,0.95);z-index:7}

/* compact member rows */
.member-row{background:#fafafa}
.member-row.hidden{display:none}

/* color coding */
.mem-small{background:#d4f6ff !important}
.mem-normal{background:#d9ffd9 !important}
.mem-large{background:#fff7c2 !important}
.mem-critical{background:#ffd6d6 !important}

/* highlight */
.hl{background:#fffe8a;padding:2px 3px;border-radius:4px}

/* icon buttons small */
.icon-btn{background:none;border:0;font-size:14px;cursor:pointer;padding:4px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center;color:#0f7a4a}
.icon-btn:hover{background:rgba(15,122,74,0.08);transform:translateY(-1px)}

/* show toggle small, inline */
.show-toggle{font-size:13px;padding:4px 6px;border-radius:6px;border:1px solid rgba(6,30,20,0.06);background:transparent;cursor:pointer;color:#0f7a4a}
.show-toggle:hover{background:#e9fff4;}

/* export dropdown */
.export-wrapper{position:relative}
.export-dropdown{position:absolute;top:36px;right:0;background:#fff;border:1px solid #ccc;border-radius:10px;width:170px;box-shadow:0 6px 18px rgba(0,0,0,0.12);z-index:9999}
.export-dropdown div{padding:10px 14px;cursor:pointer}
.export-dropdown div:hover{background:#e9fff0}
.hidden{display:none}

/* pagination buttons */
#paginationArea button{padding:6px 10px;margin:0 3px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
#paginationArea button.active{background:#0f7a4a;color:#fff;border-color:#0f7a4a;font-weight:700}

/* legend */
.legend-box{margin-top:16px;display:inline-block;background:#fff;padding:12px;border-radius:10px;border:1px solid rgba(6,30,20,0.04);box-shadow:0 4px 14px rgba(6,30,20,0.06)}
.legend-item{display:flex;gap:8px;align-items:center;margin:6px 0;font-size:10px}
.legend-swatch{width:14px;height:14px;border-radius:4px}
</style>
</head>
<body>
<div class="page-container">

  <header class="topbar">
    <div style="display:flex;gap:12px;align-items:center">
      <button class="menu-btn" style="display:none">‚ò∞</button>
      <div class="brand">
        <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
        <div>
          <div class="title">PUROK KALIGTASAN</div>
          <div class="subtitle" style="font-size:12px;opacity:0.95">Disaster Risk Reduction & Management Office - Alitagtag</div>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center">
      <span id="userName"></span>
      <button id="logoutBtn" class="btn-secondary">Logout</button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <ul style="list-style:none;padding:6px;margin:0;display:flex;flex-direction:column;gap:6px">
      <li><a href="dashboard.html">üìä Dashboard</a></li>
      <li><a href="dataForm.html">üìù Data Entry</a></li>
      <li><a href="records.html" class="active">üìÅ Records</a></li>
      <li><a href="charts.html">üìà Charts</a></li>
      <li class="admin-only"><a href="users.html">üë• User Management</a></li>
    </ul>
  </aside>

  <main class="content-area">
    <h2 style="margin-top:0">üìÅ Household Records</h2>

    <!-- Counts -->
    <div style="display:flex;justify-content:flex-end;gap:12px;margin-bottom:12px">
      <span>Rows: <strong class="green" id="rowCount">0</strong></span>
      <span>Matches: <strong class="green" id="matchCount">0</strong></span>
      <span>Selected: <strong class="green" id="selectedCount">0</strong></span>
    </div>

    <!-- Toolbar -->
    <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:12px;align-items:center">
      <input id="searchInput" class="search-box" placeholder="Search by Name / Barangay / ID..." />

      <select id="filterBarangay" class="brgy-dropdown" aria-label="Filter by Barangay">
        <option value="">All Barangays</option>
        <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
        <option>Dalipit East</option><option>Dalipit West</option>
        <option>Dominador East</option><option>Dominador West</option>
        <option>Munlawin Sur</option><option>Munlawin Norte</option>
        <option>Muzon Primero</option><option>Muzon Segundo</option>
        <option>Pinagkurusan</option><option>Ping-As</option>
        <option>Poblacion East</option><option>Poblacion West</option>
        <option>San Jose</option><option>San Juan</option>
        <option>Santa Cruz</option><option>Tadlac</option>
      </select>

      <button id="refreshBtn" class="btn-main">‚ü≥ Refresh</button>

      <div class="export-wrapper">
        <button id="exportBtn" class="btn-secondary">üì§ Export ‚ñº</button>
        <div id="exportDropdown" class="export-dropdown hidden" role="menu" aria-hidden="true">
          <div onclick="exportAll()">Export All</div>
          <div onclick="exportSelected()">Export Selected</div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="records-wrapper">
      <table class="records-table" aria-describedby="records table">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div id="paginationArea" style="margin-top:12px"></div>

    <!-- Legend -->
    <div class="legend-box" style="margin-top:10px">
      <strong>Household Color Legend:</strong>
      <div class="legend-item"><div class="legend-swatch" style="background:#d4f6ff"></div>1 Member</div>
      <div class="legend-item"><div class="legend-swatch" style="background:#d9ffd9"></div>2‚Äì4 Members</div>
      <div class="legend-item"><div class="legend-swatch" style="background:#fff7c2"></div>5‚Äì7 Members</div>
      <div class="legend-item"><div class="legend-swatch" style="background:#ffd6d6"></div>8+ Members</div>
    </div>

  </main>
</div>

<!-- Loading overlay -->
<div id="loading" style="display:none;position:fixed;inset:0;background:rgba(255,255,255,0.75);align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.12)">Loading records‚Ä¶</div>
</div>

<script>
/* ============ CONFIG ============ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";

/* ============ STATE ============ */
let header = [];
let rawRows = [];
let groups = [];
let selected = new Set();
let currentPage = 1;
const rowsPerPage = 25;

/* ============ UTIL ============ */
function showLoading(yes){ document.getElementById("loading").style.display = yes ? "flex" : "none"; }
function highlight(text,q){
  text = String(text ?? "");
  if(!q) return text;
  const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");
  return text.replace(re, m => `<span class="hl">${m}</span>`);
}

/* ============ LOAD RECORDS ============ */
async function loadRecords(){
  showLoading(true);
  try{
    const barangay = document.getElementById("filterBarangay").value || "";
    const q = document.getElementById("searchInput").value.trim();

    const res = await fetch(`${SCRIPT_URL}?action=getRecords&filterBarangay=${encodeURIComponent(barangay)}&q=${encodeURIComponent(q)}`);
    const data = await res.json();
    if(!data.success){ alert("Load failed: " + (data.message||"")); showLoading(false); return; }

    header = data.header || [];
    rawRows = data.rows || [];
    groupRows();
    currentPage = 1;
    renderTable();
    renderPagination();
    updateCounts();
  } catch(err){
    console.error(err);
    alert("Error loading records");
  }
  showLoading(false);
}

/* ============ GROUPING ============ */
function groupRows(){
  const map = {};
  rawRows.forEach(r=>{
    const id = String(r["Data ID"] || "");
    if(!id) return;
    if(!map[id]) map[id] = { dataID:id, head:null, members:[] };

    const isHead = !r["Name of Household Member/s"] || String(r["Name of Household Member/s"]).trim() === "";
    if(isHead && !map[id].head) map[id].head = r;
    else map[id].members.push(r);
  });

  // ensure head exists
  Object.keys(map).forEach(k=>{
    if(!map[k].head && map[k].members.length>0){
      map[k].head = map[k].members.shift();
    }
  });

  groups = Object.values(map).sort((a,b)=> Number(a.dataID) - Number(b.dataID));
}

/* ============ RENDER ============ */
function renderTable(){
  const thead = document.getElementById("tableHead");
  const tbody = document.getElementById("tableBody");
  thead.innerHTML = ""; tbody.innerHTML = "";

  // header row
  let th = `<tr><th class="select-col"><input id="selectAll" type="checkbox"></th>`;
  header.forEach(c => th += `<th>${c}</th>`);
  th += `<th class="actions-col" style="min-width:96px">Members</th><th class="actions-col">Actions</th></tr>`;
  thead.innerHTML = th;

  const start = (currentPage-1) * rowsPerPage;
  const pageRows = groups.slice(start, start + rowsPerPage);
  const keyword = document.getElementById("searchInput").value.trim();

  pageRows.forEach(g=>{
    const head = g.head || {};
    const mCount = g.members.length;

    let cls = mCount <= 1 ? "mem-small" : mCount <= 4 ? "mem-normal" : mCount <= 7 ? "mem-large" : "mem-critical";
    const tr = document.createElement("tr"); tr.className = cls;

    // checkbox
    const tdSel = document.createElement("td"); tdSel.className = "select-col";
    tdSel.innerHTML = `<input type="checkbox" class="row-select" data-id="${g.dataID}" ${selected.has(g.dataID) ? "checked" : ""}>`;
    tr.appendChild(tdSel);

    // header columns
    header.forEach(col=>{
      const td = document.createElement("td");
      td.innerHTML = highlight(head[col] || "", keyword);
      tr.appendChild(td);
    });

    // show toggle (small)
    const tdShow = document.createElement("td"); tdShow.className = "actions-col";
    tdShow.innerHTML = `<button class="show-toggle" onclick="toggleMembers('${g.dataID}')">üëÅ Show (${mCount})</button>`;
    tr.appendChild(tdShow);

    // icons (smaller)
    const tdAct = document.createElement("td"); tdAct.className = "actions-col";
    tdAct.innerHTML = `
      <button class="icon-btn" title="Edit" onclick="onEdit('${g.dataID}')">‚úèÔ∏è</button>
      <button class="icon-btn" title="Delete" onclick="onDelete('${g.dataID}')">üóëÔ∏è</button>
    `;
    tr.appendChild(tdAct);

    tbody.appendChild(tr);

    // member rows
    g.members.forEach(m=>{
      const mr = document.createElement("tr");
      mr.className = "member-row hidden";
      mr.dataset.parent = g.dataID;
      mr.appendChild(document.createElement("td")); // empty select col
      header.forEach(col=>{
        const td = document.createElement("td");
        td.innerHTML = highlight(m[col] || "", keyword);
        mr.appendChild(td);
      });
      mr.appendChild(document.createElement("td"));
      mr.appendChild(document.createElement("td"));
      tbody.appendChild(mr);
    });
  });

  // select all logic for page
  const selectAll = document.getElementById("selectAll");
  if(selectAll){
    selectAll.checked = pageRows.every(g => selected.has(g.dataID));
    selectAll.onchange = function(){
      pageRows.forEach(g => {
        if(this.checked) selected.add(g.dataID); else selected.delete(g.dataID);
      });
      renderTable();
      updateCounts();
    };
  }

  // row selects
  document.querySelectorAll(".row-select").forEach(cb=>{
    cb.onchange = function(){
      const id = this.dataset.id;
      if(this.checked) selected.add(id); else selected.delete(id);
      updateCounts();
    };
  });

  updateCounts();
}

/* ============ TOGGLE MEMBERS ============ */
function toggleMembers(id){
  document.querySelectorAll(`tr.member-row[data-parent="${id}"]`).forEach(r => r.classList.toggle("hidden"));
}

/* ============ PAGINATION ============ */
function renderPagination(){
  const div = document.getElementById("paginationArea");
  const total = Math.ceil(groups.length / rowsPerPage);
  if(total <= 1){ div.innerHTML = ""; return; }

  let html = "";
  for(let i=1;i<=total;i++){
    html += `<button onclick="gotoPage(${i})" class="${i===currentPage ? 'active' : ''}">${i}</button>`;
  }
  div.innerHTML = html;
}
function gotoPage(p){ if(p<1) p=1; currentPage=p; renderTable(); renderPagination(); }

/* ============ COUNTS ============ */
function updateCounts(){
  document.getElementById("rowCount").innerText = groups.length;
  document.getElementById("matchCount").innerText = groups.length;
  document.getElementById("selectedCount").innerText = selected.size;
}

/* ============ EDIT & DELETE ============ */
function onEdit(id){
  localStorage.setItem("edit_dataID", id);
  location.href = "edit.html";
}

async function onDelete(id){
  if(!confirm("Delete household " + id + "?")) return;

  const fd = new FormData();
  fd.append("action", "deleteHousehold");
  fd.append("dataID", id);

  try{
    const res = await fetch(SCRIPT_URL, { method: "POST", body: fd });
    const json = await res.json();

    if(json.success){
      // Show user-friendly formatted confirmation (explicit as requested)
      alert(`Data has been deleted. Data ID: ${id} from Master and Barangay`);
      // reload
      await loadRecords();
    } else {
      alert("Delete failed: " + (json.message || JSON.stringify(json)));
    }
  }catch(err){
    console.error("Delete error", err);
    alert("Delete failed ‚Äî see console");
  }
}

/* ============ EXPORT ============ */
function exportAll(){ exportCSV(groups); }
function exportSelected(){
  const arr = groups.filter(g => selected.has(g.dataID));
  if(!arr.length) return alert("No selected rows");
  exportCSV(arr);
}
function exportCSV(list){
  const cols = header.slice();
  const lines = [];
  lines.push(cols.map(c => `"${c.replace(/"/g,'""')}"`).join(","));
  list.forEach(g=>{
    lines.push(cols.map(c => `"${(g.head[c]||"").toString().replace(/"/g,'""')}"`).join(","));
    (g.members || []).forEach(m => lines.push(cols.map(c => `"${(m[c]||"").toString().replace(/"/g,'""')}"`).join(",")));
  });
  const blob = new Blob([lines.join("\r\n")], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "records.csv"; a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 500);
}

/* ============ UI BINDINGS ============ */
document.getElementById("refreshBtn").onclick = loadRecords;
document.getElementById("filterBarangay").onchange = loadRecords;
document.getElementById("searchInput").addEventListener("input", ()=> setTimeout(loadRecords, 260));
document.getElementById("exportBtn").onclick = () => document.getElementById("exportDropdown").classList.toggle("hidden");
document.addEventListener("click", e=>{
  const box = document.getElementById("exportDropdown");
  const btn = document.getElementById("exportBtn");
  if(!btn.contains(e.target) && !box.contains(e.target)) box.classList.add("hidden");
});

/* ============ INIT ============ */
window.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("userName").innerText = localStorage.getItem("staffName") || localStorage.getItem("username") || "";
  loadRecords();
});
</script>
</body>
</html>
