<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Purok Kaligtasan ‚Äî Charts</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    h2{margin:0 0 6px 0}
    .small.muted{color:var(--muted);font-size:13px;margin-bottom:8px}
    .charts-container{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:20px;
      margin-top:15px;
    }
    .chart-card{
      background:var(--card-grad);
      border-radius:14px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(6,30,20,0.10);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(6,30,20,0.03);
    }
    .chart-card h4{
      margin:4px 0 12px 0;
      font-size:16px;
      font-weight:700;
      color:var(--green-1);
    }
    canvas{filter: drop-shadow(0 8px 16px rgba(6,30,20,0.08)); display:block; width:100% !important; height:auto !important}
    .floating-menu{
      position: fixed;
      right: 18px;
      top: 120px;
      width: 220px;
      background: white;
      border-radius: 14px;
      padding:12px;
      box-shadow:0 10px 35px rgba(6,30,20,0.18);
      z-index:9999;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .floating-menu h5{margin:0 0 6px 0;font-size:15px;font-weight:700;color:var(--green-1)}
    .btn{padding:8px;border-radius:8px;font-weight:700;cursor:pointer;background:linear-gradient(90deg,#0f7a4a,#34b78f);color:#fff;border:0}
    .small-desc{font-size:12px;color:var(--muted)}
    @media(max-width:980px){
      .charts-container{grid-template-columns:1fr}
      .sidebar{display:none}
      main.content-area{padding-top:86px}
      .floating-menu{left:8px;right:8px;bottom:18px;top:auto;width:auto;flex-direction:row;justify-content:space-between}
    }
  </style>
</head>
<body>
  <div class="page-container">
    <header class="topbar">
      <div class="brand">
        <img src="assets/MDRRMO Logo.png" class="logo" alt="logo"/>
        <div>
          <div class="title">PUROK KALIGTASAN</div>
          <div class="subtitle">DRRMO ‚Äî Alitagtag</div>
        </div>
      </div>
      <div class="user-info">
        <span id="userName"></span>
        <button id="logoutBtn" class="btn" style="background:transparent;color:var(--green-1);border:1px solid rgba(15,122,74,0.12);padding:6px 10px">Logout</button>
      </div>
    </header>

    <aside class="sidebar" aria-hidden="true" style="margin-top:64px">
      <ul>
        <li><a href="dashboard.html">üìä Dashboard</a></li>
        <li><a href="dataForm.html">üìù Data Entry</a></li>
        <li><a href="records.html">üìÅ Records</a></li>
        <li><a href="charts.html" class="active">üìà Charts</a></li>
        <li class="admin-only"><a href="users.html">üë• User Management</a></li>
      </ul>
    </aside>

    <main class="content-area">
      <h2>üìà Household Statistics & Trends</h2>
      <div class="small muted">Visual summary of all registered evacuees. Hover legends to toggle series. Charts refresh when page loads.</div>

      <div class="charts-container" id="chartsContainer">
        <div class="chart-card">
          <h4>1. Entry per Barangay</h4>
          <canvas id="chartBarangay" height="200"></canvas>
        </div>

        <div class="chart-card">
          <h4>2. Age Groups (0-11 months, ‚â§17, 18-59, 60+)</h4>
          <canvas id="chartAgeGroup" height="200"></canvas>
        </div>

        <div class="chart-card">
          <h4>3. Stage Distribution</h4>
          <canvas id="chartStage" height="200"></canvas>
        </div>

        <div class="chart-card">
          <h4>4. Persons With Disability (PWD)</h4>
          <canvas id="chartPWD" height="200"></canvas>
        </div>

        <div class="chart-card">
          <h4>5. Status Distribution</h4>
          <canvas id="chartStatus" height="200"></canvas>
        </div>

        <div class="chart-card">
          <h4>6. Government Support (ALL)</h4>
          <canvas id="chartSupport" height="240"></canvas>
        </div>
      </div>
    </main>
  </div>

  <div class="floating-menu" role="toolbar" aria-label="Export tools">
    <h5>Export & Print</h5>
    <button id="btnPrint" class="btn">Print</button>
    <button id="btnExportPDF" class="btn">Export PDF</button>
    <button id="btnExportPNGs" class="btn">Export PNG ZIP</button>
    <div class="small-desc">Use PDF for reports, PNG for slides.</div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/file-saver/2.0.5/FileSaver.min.js"></script>

  <script>
  (function(){
    // === CONFIG - set your Apps Script web app URL here ===
    const API_URL = "https://script.google.com/macros/s/AKfycbxWs1kxkyleYw6qcQlIx1xsecQS8x2O-nyXxbcdcm5DVst6IcmDKR-NmzSgBxyH7ErvpA/exec";

    // Chart instances container
    const CH = {};

    // Utilities: flexible date parsing (handles dd/mm/yyyy, yyyy-mm-dd, ISO)
    function parseAnyDate(v){
      if(!v && v!==0) return null;
      if(v instanceof Date) return v;
      v = String(v).trim();
      if(!v) return null;
      // DD/MM/YYYY
      if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(v)){
        const p = v.split('/');
        return new Date(Number(p[2]), Number(p[1]) - 1, Number(p[0]));
      }
      // yyyy-mm-dd or ISO
      if(/^\d{4}-\d{2}-\d{2}/.test(v)){
        // if includes T, Date() can parse timezone; use as-is
        return new Date(v);
      }
      // try Date()
      const d = new Date(v);
      return isNaN(d) ? null : d;
    }

    function monthsBetween(d1, d2){
      // d1 earlier, d2 later
      if(!d1 || !d2) return null;
      let years = d2.getFullYear() - d1.getFullYear();
      let months = d2.getMonth() - d1.getMonth();
      let m = years*12 + months;
      // adjust days
      if(d2.getDate() < d1.getDate()) m--;
      return m;
    }

    function ageInYearsFromBirth(bd){
      if(!bd) return null;
      const d = parseAnyDate(bd);
      if(!d) return null;
      const now = new Date();
      let years = now.getFullYear() - d.getFullYear();
      const m = now.getMonth() - d.getMonth();
      if(m < 0 || (m === 0 && now.getDate() < d.getDate())) years--;
      return years;
    }

    // map a row object into normalized values we need
    function normalizeRow(r){
      // r could have keys from spreadsheet; ensure access by header names
      const get = (k)=> (r[k]===undefined ? (r[k.toUpperCase()]===undefined ? "" : r[k.toUpperCase()]) : r[k]);

      const barangay = (get("Barangay") || "").toString().trim();
      const stage = (get("Stage") || "").toString().trim();
      const pwd = (get("Persons with Disability (PWD)") || get("PWD") || "").toString().trim().toLowerCase();
      const status = (get("Status") || "").toString().trim();
      const transportation = (get("Transportation") || "").toString().trim();
      const birthdateRaw = get("Birthdate") || "";
      const birthdate = birthdateRaw ? birthdateRaw.toString().trim() : "";
      // Age field may be number (years) or string; use Age if numeric >0; if 0 or blank, compute months
      let ageVal = get("Age");
      let ageYears = null;
      if (ageVal !== "" && ageVal !== null && ageVal !== undefined && !isNaN(Number(ageVal))) {
        ageYears = Number(ageVal);
      } else {
        // try compute from birthdate
        if (birthdate) {
          const years = ageInYearsFromBirth(birthdate);
          if (years !== null) ageYears = years;
        }
      }

      // compute infant months if ageYears === 0 or NaN
      let infantMonths = null;
      if ((ageVal === 0 || ageYears === 0 || ageYears === 0) && birthdate) {
        const bd = parseAnyDate(birthdate);
        if (bd) {
          infantMonths = monthsBetween(bd, new Date());
        }
      }

      // Assistance fields
      const assist = {
        TUPAD: (get("TUPAD") || "").toString().trim(),
        "Local 4Ps": (get("Local 4Ps") || "").toString().trim(),
        "National 4Ps": (get("National 4Ps") || "").toString().trim(),
        "Local Social Pension": (get("Local Social Pension") || "").toString().trim(),
        "National Social Pension": (get("National Social Pension") || "").toString().trim(),
        "Solo Parent Assistance": (get("Solo Parent Assistance") || "").toString().trim(),
        "Cash Subsidy": (get("Cash Subsidy") || "").toString().trim(),
        "Relief Goods": (get("Relief Goods") || "").toString().trim(),
        "AICS": (get("AICS") || "").toString().trim()
      };

      return {
        barangay, stage, pwd, status, transportation, birthdate, ageYears, infantMonths, assist
      };
    }

    // Categorize age group according to your rules:
    // 0-11 months => Infant
    // <=17 => School Children
    // 18-59 => Adult
    // 60+ => Elderly
    function bucketAgeGroup(norm){
      // prefer infantMonths if present
      if (typeof norm.infantMonths === "number" && norm.infantMonths >= 0 && norm.infantMonths <= 11) return "Infant (0-11 months)";
      const y = norm.ageYears;
      if (y === null || y === undefined || y === "") return "Unknown";
      if (y <= 0) {
        // treat as infant if months unknown
        return "Infant (0-11 months)";
      }
      if (y <= 17) return "School Children (‚â§17)";
      if (y >= 60) return "Elderly (60+)";
      return "Adult (18-59)";
    }

    // Fetch records from Apps Script getRecords action
    async function fetchRecords(){
      const url = API_URL + "?action=getRecords";
      const res = await fetch(url);
      if (!res.ok) throw new Error("Network error " + res.status);
      const j = await res.json();
      if (!j || !j.success) {
        // attempt fallback to listHouseholds or list
        // try action=listHouseholds
        try {
          const r2 = await fetch(API_URL + "?action=listHouseholds");
          const j2 = await r2.json();
          if (Array.isArray(j2)) return j2;
        } catch(e){}
        throw new Error("Bad response from API");
      }
      return j.rows || [];
    }

    // Build all datasets and render charts
    async function buildCharts(){
      try {
        const rows = await fetchRecords();
        // rows are array of objects; normalize
        const normalized = rows.map(normalizeRow);

        // 1) Barangay counts
        const barangayCounts = {};
        normalized.forEach(n => {
          const b = n.barangay || "Unknown";
          barangayCounts[b] = (barangayCounts[b] || 0) + 1;
        });

        drawBarChart('chartBarangay', sortObjByValue(barangayCounts), 'Evacuees');

        // 2) Age groups
        const ageCounts = {};
        normalized.forEach(n => {
          const g = bucketAgeGroup(n);
          ageCounts[g] = (ageCounts[g] || 0) + 1;
        });
        // ensure order: Infant, School, Adult, Elderly, Unknown
        const orderedAge = {
          "Infant (0-11 months)": ageCounts["Infant (0-11 months)"]||0,
          "School Children (‚â§17)": ageCounts["School Children (‚â§17)"]||0,
          "Adult (18-59)": ageCounts["Adult (18-59)"]||0,
          "Elderly (60+)": ageCounts["Elderly (60+)"]||0,
          "Unknown": ageCounts["Unknown"]||0
        };
        drawBarChart('chartAgeGroup', orderedAge, 'Count');

        // 3) Stage distribution (raw Stage field)
        const stageCounts = {};
        normalized.forEach(n => {
          const s = n.stage || "Unspecified";
          stageCounts[s] = (stageCounts[s]||0)+1;
        });
        drawDoughnut('chartStage', stageCounts, 'Stage');

        // 4) PWD
        const pwd = { Yes:0, No:0, Unknown:0 };
        normalized.forEach(n => {
          const v = (n.pwd||"").toString().trim().toLowerCase();
          if(v === "yes" || v === "y" || v === "true") pwd.Yes++;
          else if (v === "no" || v === "n" || v === "false" || v === "") pwd.No++;
          else pwd.Unknown++;
        });
        drawDoughnut('chartPWD', pwd, 'PWD');

        // 5) Status distribution
        const statusCounts = {};
        normalized.forEach(n => {
          const s = n.status || "Unspecified";
          statusCounts[s] = (statusCounts[s]||0)+1;
        });
        drawDoughnut('chartStatus', statusCounts, 'Status');

        // 6) Government support combined
        const supportKeys = ["TUPAD","Local 4Ps","National 4Ps","Local Social Pension","National Social Pension","Solo Parent Assistance","Cash Subsidy","Relief Goods","AICS"];
        const supportCounts = {};
        supportKeys.forEach(k => supportCounts[k]=0);
        normalized.forEach(n => {
          supportKeys.forEach(k=>{
            const v = (n.assist && n.assist[k]) ? n.assist[k].toString().trim().toLowerCase() : "";
            if(k === "AICS"){
              if(v) supportCounts[k]++; // count non-empty AICS entries
            } else {
              if(v === "yes" || v === "y" || v === "true") supportCounts[k]++;
            }
          });
        });
        drawHorizontalBar('chartSupport', supportCounts, 'Recipients');

      } catch(err){
        console.error("buildCharts failed:", err);
        alert("Unable to load chart data: " + err.message);
      }
    }

    // ====== Chart helpers ======
    function sortObjByValue(obj){
      // return ordered object with keys sorted descending
      const entries = Object.entries(obj).sort((a,b)=> b[1]-a[1]);
      const out = {};
      entries.forEach(([k,v])=> out[k]=v);
      return out;
    }

    function getGradient(ctx, area){
      const g = ctx.createLinearGradient(0,0,0,area.height||200);
      g.addColorStop(0, 'rgba(52,183,143,0.95)');
      g.addColorStop(1, 'rgba(15,122,74,0.85)');
      return g;
    }

    function drawBarChart(canvasId, countsObj, label){
      const labels = Object.keys(countsObj);
      const data = labels.map(k=>countsObj[k]||0);
      const ctx = document.getElementById(canvasId).getContext('2d');

      if(CH[canvasId]) CH[canvasId].destroy();

      const gradient = getGradient(ctx, ctx.canvas);

      CH[canvasId] = new Chart(ctx, {
        type:'bar',
        data:{
          labels,
          datasets:[{
            label,
            data,
            backgroundColor: labels.map((_,i)=> gradient),
            borderColor: labels.map(()=> '#0f7a4a'),
            borderWidth: 1,
            borderRadius: 8,
            barPercentage:0.7
          }]
        },
        options:{
          responsive:true,
          plugins:{
            legend:{ display:false },
            tooltip:{ mode:'index', intersect:false }
          },
          scales:{
            x:{ ticks:{ maxRotation:0, autoSkip:true } },
            y:{ beginAtZero:true, ticks:{ stepSize:1 } }
          }
        }
      });
    }

    function drawHorizontalBar(canvasId, countsObj, label){
      const labels = Object.keys(countsObj);
      const data = labels.map(k=>countsObj[k]||0);
      const ctx = document.getElementById(canvasId).getContext('2d');

      if(CH[canvasId]) CH[canvasId].destroy();

      // colors that are distinct
      const palette = [
        '#0f7a4a','#3fbf8b','#f6b042','#f26c4f','#7b61ff','#0096c7','#ff7ab6','#6c757d','#2d9cdb'
      ];
      CH[canvasId] = new Chart(ctx, {
        type:'bar',
        data:{
          labels,
          datasets:[{
            label,
            data,
            backgroundColor: labels.map((_,i)=> palette[i%palette.length]),
            borderColor: labels.map(()=> 'rgba(0,0,0,0.06)'),
            borderWidth: 1
          }]
        },
        options:{
          indexAxis: 'y',
          responsive:true,
          plugins:{ legend:{ display:false }, tooltip:{ mode:'nearest' } },
          scales:{ x:{ beginAtZero:true, ticks:{ stepSize:1 } } }
        }
      });
    }

    function drawDoughnut(canvasId, countsObj, title){
      const labels = Object.keys(countsObj);
      const data = labels.map(k=>countsObj[k]||0);
      const ctx = document.getElementById(canvasId).getContext('2d');
      if(CH[canvasId]) CH[canvasId].destroy();

      CH[canvasId] = new Chart(ctx, {
        type:'doughnut',
        data:{
          labels,
          datasets:[{
            data,
            backgroundColor: labels.map((_,i)=> `hsl(${(i*50)%360} 70% 52%)`),
            hoverOffset:8
          }]
        },
        options:{
          responsive:true,
          plugins:{
            legend:{ position:'bottom' }
          }
        }
      });
    }

    // ===== Export utilities (Print / PDF / PNG ZIP) =====
    document.getElementById('btnPrint').addEventListener('click', ()=> window.print());
    document.getElementById('btnExportPDF').addEventListener('click', exportToPDF);
    document.getElementById('btnExportPNGs').addEventListener('click', exportPNGsZip);

    async function exportToPDF(){
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation:'landscape' });
        const ids = ['chartBarangay','chartAgeGroup','chartStage','chartPWD','chartStatus','chartSupport'];
        let page = 0;
        for(const id of ids){
          const c = document.getElementById(id);
          if(!c) continue;
          const img = c.toDataURL('image/jpeg',0.95);
          if(page>0) doc.addPage();
          const w = doc.internal.pageSize.getWidth();
          const h = doc.internal.pageSize.getHeight();
          const margin = 12;
          doc.addImage(img,'JPEG',margin,margin,w - margin*2, h - margin*2);
          page++;
        }
        doc.save(`Charts_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`);
      } catch(err){
        console.error(err); alert("PDF export failed: "+err.message);
      }
    }

    async function exportPNGsZip(){
      try {
        const zip = new JSZip();
        const ids = ['chartBarangay','chartAgeGroup','chartStage','chartPWD','chartStatus','chartSupport'];
        for(const id of ids){
          const c = document.getElementById(id);
          if(!c) continue;
          const blob = await new Promise(res=> c.toBlob(res,'image/png',1.0));
          if(blob) zip.file(`${id}.png`, blob);
        }
        const content = await zip.generateAsync({ type:'blob' });
        saveAs(content, `Charts_PNGs_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`);
      } catch(err){
        console.error(err); alert("PNG export failed: "+err.message);
      }
    }

    // Init: show userName and load charts
    (function init(){
      document.getElementById('userName').innerText = localStorage.getItem('staffName') || '';
      document.getElementById('logoutBtn').addEventListener('click', ()=> { localStorage.clear(); location.href='login.html'; });
      buildCharts();
    })();

  })();
  </script>
</body>
</html>

