<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Charts & Analytics ‚Äî Purok Kaligtasan 133</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="css/uniform-styles.css">
<style>
   :root{
    --bg:#f6f8f7;
    --card-bg:#fff;
    --muted:#6b6f6b;
    --accent1:#0f7a4a;
    --accent2:#34b78f;
    --accent3: #ff7a00;
    --accent4: #ffa500;
    --light-green: #e9f7f2;
    --border: #e1e8e5;
    --shadow: 0 6px 18px rgba(6,30,20,0.06);
    --shadow-dark: 0 6px 20px rgba(5,40,25,0.12);
    --radius:12px;
    --radius-sm:8px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
   }
   
   /* Update charts grid for new layout */
.charts-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-top: 10px;
}

/* For grid view charts (two per row) */
.chart-card:not(.full-size) {
    grid-column: span 1;
}

@media (min-width: 768px) {
    .charts-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    /* Full size charts span both columns */
    .chart-card.full-size {
        grid-column: 1 / -1;
    }
    
    /* Stage Distribution specific styling */
    .chart-card:nth-child(8) { /* Stage Distribution */
        position: relative;
        overflow: visible !important;
    }
    
    .chart-card:nth-child(8) .chart-container {
        overflow: visible !important;
    }
}

/* Fix hover effects for Employment, OFW, and Stage charts */
.chart-card:nth-child(11) .chart-container, /* Employment */
.chart-card:nth-child(8) .chart-container, /* Stage */
.chart-card:nth-child(11) .chart-container { /* OFW */
    overflow: visible !important;
}

/* Ensure tooltips are not clipped */
.chartjs-tooltip {
    z-index: 9999 !important;
    position: absolute;
    pointer-events: none;
}
   
   /* Background decorative elements */
   .bg-pattern {
     position: absolute;
     width: 100%;
     height: 100%;
     overflow: hidden;
     z-index: -1;
   }
   
   .bg-circle {
     position: absolute;
     border-radius: 50%;
     background: rgba(15, 122, 74, 0.05);
   }
   
   .circle-1 {
     width: 300px;
     height: 300px;
     top: -150px;
     right: -150px;
   }
   
   .circle-2 {
     width: 200px;
     height: 200px;
     bottom: -100px;
     left: -100px;
     background: rgba(255, 122, 0, 0.05);
   }
   
   .circle-3 {
     width: 150px;
     height: 150px;
     top: 50%;
     left: 10%;
     background: rgba(52, 183, 143, 0.05);
   }
   
   .admin-only {
    display: none !important;
}

/* Class to show admin elements - applied by JavaScript */
.admin-only.admin-visible {
    display: block !important;
}

/* For list items */
li.admin-only {
    display: none !important;
}

li.admin-only.admin-visible {
    display: list-item !important;
}
   
   /* Description Styling */
   #disc {
    margin-bottom: 10px;
    background: var(--light-green);
    padding: 12px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--accent1);
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.5;
   }
   
   body {
    background-color: var(--bg);
    margin: 0;
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-text-size-adjust: 100%;
    padding-bottom: 70px; /* Space for fixed bottom nav */
   }

   .page-container{
    max-width:1200px;
    margin:20px auto;
    padding:12px;
    display:grid;
    grid-template-columns:260px 1fr;
    gap:18px;
    align-items:start;
    transition: grid-template-columns 0.3s ease;
   }

   .page-container.collapsed {
    grid-template-columns: 60px 1fr;
   }

   /* Topbar - Enhanced */
   .topbar{
    grid-column:1/-1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
    border-radius:var(--radius);
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    box-shadow:var(--shadow-dark);
   }

   .brand{
    display:flex;
    gap:12px;
    align-items:center;
   }

   .brand .logo{
    width:60px;
    height:60px;
    border-radius:var(--radius-sm);
    object-fit:contain;
   }

   .brand-text h1 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
   }

   .brand-text p {
    font-size:12px;
    opacity:0.95;
    margin: 4px 0 0 0;
   }

   .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
   }

   #userName {
    font-weight: 600;
    border-radius: 20px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
   }

   #logoutBtn {
    background: rgba(255,255,255,0.25);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
   }

   #logoutBtn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
   }

   /* Sidebar - Collapsible */
   .sidebar{
    background:linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.20));
    border-radius:var(--radius);
    padding:12px;
    height:calc(100vh - 120px);
    position:sticky;
    top:72px;
    overflow:auto;
    transition: width 0.3s ease;
    z-index: 100;
   }

   .sidebar-container {
    display: flex;
    flex-direction: column;
    height: 100%;
   }

   .sidebar-toggle {
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.3s ease;
   }

   .sidebar-toggle:hover {
    transform: scale(1.1);
   }

   .sidebar ul{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
    flex: 1;
   }

   .sidebar li a{
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    text-decoration: none;
    color: var(--muted);
    border-radius: var(--radius-sm);
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
   }

   .sidebar li a:hover{
    background: var(--light-green);
    color: var(--accent1);
   }

   .sidebar li a.active{
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .sidebar li a .menu-icon {
    font-size: 1.2rem;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
   }

   .sidebar li a .menu-text {
    transition: opacity 0.3s ease;
   }

   .page-container.collapsed .sidebar li a .menu-text {
    opacity: 0;
    width: 0;
    overflow: hidden;
   }

   /* REMOVED: Mobile Logout Button in Sidebar */
   .mobile-logout-container {
    display: none !important; /* Remove logout button from sidebar */
   }

   /* Content Area */
   .content-area{
    background:linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
    border-radius:var(--radius);
    padding:18px;
    box-shadow:0 8px 22px rgba(10,20,16,0.06);
    min-height:72vh;
    height: calc(100vh - 120px);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
   }

   /* Content Header */
   .content-header {
    margin-top: 0;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
   }

   .content-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: var(--accent1);
    display: flex;
    align-items: center;
    gap: 8px;
   }

   /* ============ NEW: COMPACT GLOBAL STATS SUMMARY ============ */
   .global-stats-summary {
    display: none; /* Hidden by default, Option 2 */
    background: white;
    border-radius: var(--radius-sm);
    padding: 8px 12px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--accent1);
    justify-content: center; /* Center boxes */
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
   }
   
   .global-stats-summary.visible {
    display: flex;
   }
   
   .global-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 6px 10px;
    border-radius: var(--radius-sm);
    min-width: 70px; /* Smaller width */
    text-align: center;
    transition: all 0.2s ease;
   }
   
   .global-stat.heads {
    background: var(--light-green);
    border: 1px solid rgba(15, 122, 74, 0.2);
   }
   
   .global-stat.members {
    background: #e3f2fd;
    border: 1px solid rgba(33, 150, 243, 0.2);
   }
   
   .global-stat.total {
    background: #fff3e0;
    border: 1px solid rgba(255, 167, 38, 0.2);
   }
   
   .global-stat.highlight {
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    color: white;
    transform: scale(1.05);
   }
   
   .global-stat-value {
    font-size: 1.2rem; /* Smaller font */
    font-weight: 700;
    line-height: 1;
    margin-bottom: 2px;
   }
   
   .global-stat-label {
    font-size: 0.7rem; /* Smaller font */
    opacity: 0.9;
    white-space: nowrap;
   }
   
   .highlight .global-stat-label {
    opacity: 0.95;
   }
   
   /* Global stats timestamp - smaller and hidden in summary view */
   .global-stats-timestamp {
    font-size: 0.65rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 4px;
    margin-left: 8px;
    font-style: italic;
   }
   
   .stats-view-summary .global-stats-timestamp {
    display: none; /* Hide "Updated" text in summary view */
   }
   
   /* ============ NEW: STATS VIEW TOGGLE ============ */
   .stats-view-toggle {
    display: none; /* Hidden by default, Option 3 */
    background: white;
    border-radius: var(--radius-sm);
    padding: 6px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
   }
   
   .stats-view-toggle.visible {
    display: flex;
    gap: 6px;
    justify-content: center;
   }
   
   .stats-toggle-btn {
    background: white;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 5px 10px;
    font-size: 0.75rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s ease;
    color: var(--muted);
    flex: 1;
    justify-content: center;
    max-width: 120px;
   }
   
   .stats-toggle-btn:hover {
    background: var(--light-green);
    border-color: var(--accent1);
   }
   
   .stats-toggle-btn.active {
    background: var(--accent1);
    color: white;
    border-color: var(--accent1);
   }
   
   /* ============ ENHANCED CHART STATS ============ */
   /* Option 1: Enhanced current design */
   .chart-stats {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
   }
   
   .stat-badge {
    background: var(--light-green);
    color: var(--accent1);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
    cursor: help; /* Indicates tooltip */
    transition: all 0.2s ease;
    border: 1px solid transparent;
   }
   
   .stat-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
   }
   
   .stat-badge.heads {
    background: var(--light-green);
    border-color: rgba(15, 122, 74, 0.3);
   }
   
   .stat-badge.members {
    background: #e3f2fd;
    border-color: rgba(33, 150, 243, 0.3);
    color: #1976d2;
   }
   
   .stat-badge.total {
    background: #fff3e0;
    border-color: rgba(255, 167, 38, 0.3);
    color: #ef6c00;
   }
   
   /* Checkbox-specific badges (Government Support, Additional Info, Transportation) */
   .stat-badge.checkbox-heads {
    background: #f3e5f5;
    border-color: rgba(156, 39, 176, 0.3);
    color: #7b1fa2;
   }
   
   .stat-badge.checkbox-members {
    background: #e8f5e8;
    border-color: rgba(76, 175, 80, 0.3);
    color: #2e7d32;
   }
   
   .stat-badge.checkbox-total {
    background: #fff8e1;
    border-color: rgba(255, 193, 7, 0.3);
    color: #ff8f00;
   }
   
   .stat-badge .percentage {
    font-size: 0.65rem;
    opacity: 0.8;
    font-weight: normal;
    margin-left: 2px;
   }
   
   .last-updated {
    font-size: 0.65rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 4px;
    margin-left: 4px;
   }
   
   /* Toolbar - FIXED: All buttons on the right side */
   .toolbar {
    display: flex;
    justify-content: flex-end; /* Align everything to the right */
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 10px;
   }

   /* REMOVE toolbar-left since all buttons are on the right */
   .toolbar-left {
    display: none; /* Hide left container */
   }

   /* RIGHT-ALIGNED BUTTONS GROUP - All buttons here */
   .toolbar-right {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end; /* Ensure alignment to right */
    width: 100%; /* Take full width */
   }

   .btn {
    border:0;
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    cursor:pointer;
    font-weight:600;
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    white-space: nowrap;
    height: 36px;
    box-sizing: border-box;
   }

   .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .btn-print {
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
   }

   .btn-export {
    background: linear-gradient(90deg, var(--accent3), var(--accent4));
   }

   .btn-export:hover {
    box-shadow: 0 4px 8px rgba(255,122,0,0.2);
   }
   
   /* Export dropdown - From records.html */
   .export-wrapper {
    position: relative;
   }

   .export-dropdown {
    font-size: 0.8rem;
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 8px;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    width: 140px;
    box-shadow: var(--shadow);
    z-index: 9999;
    overflow: hidden;
    display: none;
   }

   .export-dropdown.show {
    display: block;
   }

   .export-dropdown div {
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
   }

   .export-dropdown div:hover {
    background: #e9fff0;
    color: var(--accent1);
   }

   .export-dropdown div i {
    width: 14px;
    text-align: center;
    font-size: 0.85rem;
   }

   /* Charts Grid - Redesigned */
   .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 10px;
   }

   .chart-card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
    overflow: hidden;
   }

   .chart-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 28px rgba(6,30,20,0.12);
   }

   .chart-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    border-radius: var(--radius) var(--radius) 0 0;
   }

   .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
   }

   .chart-title {
    font-size: 1rem;
    font-weight: 700;
    color: var(--accent1);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
   }

   .chart-title i {
    color: var(--accent2);
   }

   .chart-container {
    position: relative;
    width: 100%;
    height: 250px;
    margin: 10px 0;
   }

   /* Special size for specific charts - SAME AS COMPARISON CHART */
   .chart-card.full-size {
    grid-column: 1 / -1;
    min-height: 400px;
   }
   
   .full-size .chart-container {
    height: 320px;
   }

   canvas {
    width: 100% !important;
    height: 100% !important;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
   }

   /* Special styling for PWD gauge */
   .pwd-gauge-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 30px;
    height: 100%;
   }

   .pwd-canvas-wrapper {
    flex: 1;
    position: relative;
    height: 200px;
   }

   .pwd-stats {
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-width: 120px;
   }

   .pwd-stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    border-radius: var(--radius-sm);
    background: var(--light-green);
   }

   .pwd-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent1);
   }

   .pwd-stat-label {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 4px;
   }

   /* Comparison Chart - Full Width */
   .comparison-chart {
    grid-column: 1 / -1;
    min-height: 400px;
   }

   .comparison-chart .chart-container {
    height: 320px;
   }

   /* Loading overlay */
   #loading {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(255,255,255,0.85);
    align-items:center;
    justify-content:center;
    z-index:9999;
    backdrop-filter: blur(2px);
   }

   .loading-content {
    background:#fff;
    padding:20px 24px;
    border-radius:var(--radius);
    box-shadow:var(--shadow-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
   }

   .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent1);
    border-radius: 50%;
    animation: spin 1s linear infinite;
   }

   @keyframes spin {
    to { transform: rotate(360deg); }
   }

   /* Auto-refresh indicator */
   .auto-refresh {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    color: var(--muted);
    padding: 8px 12px;
    background: rgba(15,122,74,0.05);
    border-radius: var(--radius-sm);
   }

   .auto-refresh .indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #34a853;
    animation: pulse 2s infinite;
   }

   @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
   }

   /* Error message */
   .error-message {
    display: none;
    background: #fee;
    color: #c00;
    padding: 10px 15px;
    border-radius: var(--radius-sm);
    margin-bottom: 15px;
    border-left: 4px solid #c00;
    font-size: 0.9rem;
   }

   .error-message.show {
    display: block;
   }

   /* Mobile Bottom Navigation - Fixed Position - UPDATED: REMOVED LOGOUT */
   .mobile-bottom-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid var(--border);
    z-index: 1000;
    padding: 8px 0;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
    height: 70px;
    box-sizing: border-box;
    overflow: hidden;
   }

   .mobile-nav-items {
    display: flex;
    justify-content: space-around;
    align-items: center;
    height: 100%;
   }

.mobile-nav-item {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    text-decoration: none !important;
    color: var(--muted) !important;
    padding: 8px 12px !important;
    border-radius: var(--radius-sm) !important;
    transition: all 0.3s ease !important;
    min-width: 60px !important;
    flex: 1 !important;
    height: 100% !important;
    justify-content: center !important;
}

/* Admin items - initially hidden */
.mobile-nav-item.admin-only {
    display: none !important;
}

/* Show admin items when user is admin */
.mobile-nav-item.admin-only.admin-visible {
    display: flex !important;
}

/* Active state for all tabs */
.mobile-nav-item.active {
    color: var(--accent1) !important;
    background: var(--light-green) !important;
}

/* REMOVED: Logout button styling - no longer needed */

/* Icon and text for all tabs */
.mobile-nav-icon {
    font-size: 1.2rem !important;
    margin-bottom: 4px !important;
    display: block !important;
    text-align: center !important;
    width: 100% !important;
}

.mobile-nav-text {
    font-size: 0.7rem !important;
    font-weight: 500 !important;
    display: block !important;
    text-align: center !important;
    width: 100% !important;
}

   /* ============ MOBILE ENHANCEMENTS ============ */
   @media (max-width: 768px) {
    body {
        padding-bottom: 70px; /* Space for fixed bottom nav */
    }
    
    .page-container {
        grid-template-columns: 1fr !important;
        padding: 8px;
        gap: 12px;
        margin-bottom: 0; /* Remove margin since we have body padding */
    }
    
    .page-container.collapsed {
        grid-template-columns: 1fr !important;
    }
    
    .sidebar {
        display: none !important; /* Hide sidebar on mobile */
    }
    
    .mobile-bottom-nav {
        display: flex !important; /* Show bottom nav on mobile */
        flex-direction: column;
    }
    
    /* Remove mobile menu toggle button */
    .mobile-menu-toggle {
        display: none !important;
    }
    
    /* Show mobile logout button in sidebar when sidebar is forced to show */
    .mobile-logout-container {
        display: none !important; /* REMOVED: Hide logout in sidebar */
    }
    
    .content-area {
        height: auto;
        min-height: calc(100vh - 140px);
        padding: 12px;
        margin-bottom: 0;
    }
    
    /* Global Stats on mobile */
    .global-stats-summary.visible {
        flex-direction: row;
        gap: 8px;
        padding: 6px 8px;
    }
    
    .global-stat {
        width: auto;
        flex-direction: column;
        justify-content: center;
        min-width: 60px;
        padding: 5px 8px;
    }
    
    .global-stat-value {
        font-size: 1rem;
    }
    
    .global-stat-label {
        font-size: 0.65rem;
    }
    
    .global-stats-timestamp {
        display: none !important; /* Always hide timestamp on mobile */
    }
    
    /* Stats View Toggle on mobile */
    .stats-view-toggle.visible {
        flex-direction: row;
        padding: 4px;
    }
    
    .stats-toggle-btn {
        font-size: 0.7rem;
        padding: 4px 6px;
        max-width: 100px;
    }
    
    /* Enhanced chart stats on mobile */
    .chart-stats {
        flex-direction: column;
        align-items: flex-end;
        gap: 3px;
    }
    
    .stat-badge {
        font-size: 0.65rem;
        padding: 2px 4px;
        width: max-content;
    }
    
    .stat-badge .percentage {
        font-size: 0.6rem;
    }
    
    /* Hide detailed stats on very small screens, show in title */
    @media (max-width: 480px) {
        .chart-stats.hide-on-mobile {
            display: none !important;
        }
        
        .chart-title.compact::after {
            content: " (" attr(data-total) ")";
            font-size: 0.75em;
            opacity: 0.8;
            margin-left: 4px;
        }
        
        .global-stat {
            min-width: 50px;
            padding: 4px 6px;
        }
        
        .global-stat-value {
            font-size: 0.9rem;
        }
        
        .global-stat-label {
            font-size: 0.6rem;
        }
        
        .stats-toggle-btn {
            font-size: 0.65rem;
            padding: 3px 5px;
            max-width: 90px;
        }
    }
    
    /* UPDATED: Toolbar for mobile - linear and centered */
    .toolbar {
        flex-direction: column;
        align-items: stretch;
        padding: 10px;
        gap: 15px;
        justify-content: center; /* Center on mobile */
    }
    
    /* UPDATED: Right-aligned buttons become linear and centered on mobile */
    .toolbar-right {
        display: flex !important;
        flex-direction: row;
        width: 100%;
        justify-content: center; /* Center the buttons on mobile */
        gap: 10px;
        flex-wrap: wrap;
    }
    
    /* UPDATED: Ensure buttons are properly sized on mobile */
    .toolbar-right .btn {
        flex: 1; /* Make buttons take equal space */
        min-width: 100px; /* Minimum width */
        max-width: 120px; /* Maximum width */
        justify-content: center;
        text-align: center;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .chart-card {
        padding: 15px;
    }
    
    .chart-container {
        height: 220px;
    }
    
    .full-size .chart-container {
        height: 280px;
    }
    
    .comparison-chart .chart-container {
        height: 280px;
    }
    
    .pwd-gauge-container {
        flex-direction: column;
        gap: 20px;
    }
    
    .pwd-stats {
        flex-direction: row;
        justify-content: space-around;
        width: 100%;
    }
    
    .user-info {
        gap: 8px;
    }
    
    #userName {
        font-size: 0.9rem;
        padding: 6px 12px;
    }
    
    #logoutBtn {
        padding: 6px 12px;
        font-size: 0.85rem;
    }
    
    .btn {
        font-size: 0.8rem;
        padding: 6px 12px;
    }
    
    /* Optimize charts for mobile */
    .chart-card canvas {
        max-height: 200px;
    }
    
    /* Adjust content area for bottom nav */
    .content-area {
        margin-bottom: 70px;
    }
    
    /* Export dropdown positioning for mobile */
    .export-wrapper {
        width: auto;
        flex: 1;
        min-width: 100px;
        max-width: 120px;
    }
    
    .export-dropdown {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        width: 140px;
    }
   }

   /* Tablet Styles */
   @media (min-width: 769px) and (max-width: 1024px) {
    .page-container {
        max-width: 95%;
        grid-template-columns: 220px 1fr;
        gap: 15px;
        padding: 10px;
    }
    
    .content-area {
        padding: 15px;
    }
    
    .charts-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .comparison-chart,
    .chart-card.full-size {
        grid-column: 1 / -1;
    }
    
    .mobile-bottom-nav {
        display: none;
    }
   }

   /* Desktop Styles */
   @media (min-width: 1025px) {
    .mobile-bottom-nav {
        display: none;
    }
    
    .mobile-menu-toggle {
        display: none;
    }
   }

   /* Print styles - Fixed for no stretching */
   @media print {
    body * {
        visibility: hidden;
        background: white !important;
        color: black !important;
    }
    
    .content-area,
    .content-area * {
        visibility: visible;
        background: white !important;
        color: black !important;
        box-shadow: none !important;
    }
    
    .content-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100% !important;
        height: auto !important;
        padding: 20px !important;
        overflow: visible !important;
        page-break-before: always;
    }
    
    .page-container {
        display: block !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
    }
    
    .topbar,
    .sidebar,
    .toolbar,
    .mobile-bottom-nav,
    .mobile-menu-toggle,
    .global-stats-summary,
    .stats-view-toggle {
        display: none !important;
    }
    
    .chart-card {
        page-break-inside: avoid;
        break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #ddd !important;
        margin-bottom: 20px;
        height: auto !important;
    }
    
    .charts-grid {
        display: block !important;
        grid-template-columns: 1fr !important;
    }
    
    .chart-container {
        height: 300px !important;
    }
    
    .full-size .chart-container {
        height: 400px !important;
    }
    
    .comparison-chart .chart-container {
        height: 400px !important;
    }
    
    /* Force white background for print */
    @page {
        margin: 20mm;
    }
    
    html, body {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
    }
   }
</style>
</head>
<body>
<!-- Background pattern -->
    <div class="bg-pattern">
        <div class="bg-circle circle-1"></div>
        <div class="bg-circle circle-2"></div>
        <div class="bg-circle circle-3"></div>
    </div>
<div class="page-container">

  <header class="topbar">
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div class="brand-text">
        <h1>PUROK KALIGTASAN 133</h1>
        <p>MDRRMO Alitagtag ‚Äì Household Records System</p>
      </div>
    </div>

    <div class="user-info">
      <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
      </button>
      <span id="userName"></span>
      <button id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>

  <!-- Error Message -->
  <div class="error-message" id="errorMessage">
    <i class="fas fa-exclamation-triangle"></i> 
    <span id="errorText">Failed to fetch data. Please check your connection.</span>
    <button onclick="document.getElementById('errorMessage').classList.remove('show')" style="float:right; background:none; border:none; color:#c00; cursor:pointer;">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-container">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul>
        <li><a href="dashboard.html" title="Dashboard"><span class="menu-icon">üìä</span> <span class="menu-text">Dashboard</span></a></li>
        <li><a href="dataForm.html" title="Data Entry"><span class="menu-icon">üìù</span> <span class="menu-text">Data Entry</span></a></li>
        <li><a href="records.html" title="Records"><span class="menu-icon">üìÅ</span> <span class="menu-text">Records & Management</span></a></li>
        <li><a href="charts.html" class="active" title="Charts"><span class="menu-icon">üìà</span> <span class="menu-text">Charts & Analytics</span></a></li>
        <li class="admin-only"><a href="users.html" title="User Management"><span class="menu-icon">üë•</span> <span class="menu-text">User Management</span></a></li>
      </ul>
      
      <!-- REMOVED: Mobile Logout Button in Sidebar -->
    </div>
  </aside>

  <main class="content-area">
    <div class="content-header">
      <h2><span style="color: var(--accent1);">üìà</span> Household Statistics & Trends</h2>
      <div class="auto-refresh">
        <span class="indicator"></span>
        <span>Auto-refresh: 60s</span>
      </div>
    </div>
    
    <div id="disc">This section provides visual analytics and insights from household data. Interactive charts help identify patterns, distributions, and trends across barangays, age groups, disabilities, and government support programs for better decision-making.</div>

    <!-- ============ OPTION 2: GLOBAL STATS SUMMARY ============ -->
    <div class="global-stats-summary" id="globalStatsSummary">
        <div class="global-stat heads">
            <span class="global-stat-value" id="globalHeads">0</span>
            <span class="global-stat-label">Heads</span>
        </div>
        <div class="global-stat members">
            <span class="global-stat-value" id="globalMembers">0</span>
            <span class="global-stat-label">Members</span>
        </div>
        <div class="global-stat total highlight">
            <span class="global-stat-value" id="globalTotal">0</span>
            <span class="global-stat-label">Total Persons</span>
        </div>
        <span class="global-stats-timestamp">
            <i class="fas fa-sync-alt fa-xs"></i>
            <span id="globalLastUpdated"></span>
        </span>
    </div>

    <!-- ============ OPTION 3: STATS VIEW TOGGLE ============ -->
    <div class="stats-view-toggle" id="statsViewToggle">
        <button class="stats-toggle-btn active" data-view="badges" id="toggleBadges">
            <i class="fas fa-tags"></i> Show on Charts
        </button>
        <button class="stats-toggle-btn" data-view="summary" id="toggleSummary">
            <i class="fas fa-list"></i> Show Summary
        </button>
        <button class="stats-toggle-btn" data-view="compact" id="toggleCompact">
            <i class="fas fa-compress-alt"></i> Compact View
        </button>
    </div>

    <!-- Toolbar - UPDATED: All buttons in toolbar-right -->
    <!-- ONE toolbar-right div for all buttons -->
    <div class="toolbar-right">
        <!-- Print button -->
        <button id="btnPrint" class="btn btn-print">
            <i class="fas fa-print"></i> Print
        </button>
        
        <!-- Export dropdown -->
        <div class="export-wrapper">
            <button id="exportBtn" class="btn btn-export">
                <i class="fas fa-file-export"></i> Export
            </button>
            <div id="exportDropdown" class="export-dropdown" role="menu" aria-hidden="true">
                <div onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </div>
                <div onclick="exportPNGsZip()">
                    <i class="fas fa-file-image"></i> Export PNGs
                </div>
                <div onclick="exportCSV_AllRows()">
                    <i class="fas fa-file-csv"></i> Export CSV
                </div>
            </div>
        </div>
    </div>

<!-- Charts Grid - Reorganized Layout -->
<div class="charts-grid" id="chartsContainer">
    <!-- Single chart per row (ascending order) -->
    
    <!-- Chart 1: Barangay Entries (FULL SIZE) -->
    <div class="chart-card full-size">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-map-marker-alt"></i>Entry per Barangay</h3>
            <div class="chart-stats" id="barangayStats">
                <span class="stat-badge heads" title="Number of household heads in this barangay">Heads: 0</span>
                <span class="stat-badge members" title="Number of household members in this barangay">Members: 0</span>
                <span class="stat-badge total" title="Total persons in this barangay">Total: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartBarangay"></canvas>
        </div>
    </div>

    <!-- Chart 2: Barangay vs. Status Comparison (FULL SIZE) -->
    <div class="chart-card comparison-chart full-size">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-chart-bar"></i> Barangay vs Status Comparison</h3>
            <div class="chart-stats" id="comparisonStats">
                <span class="stat-badge">Comparative Analysis</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartComparison"></canvas>
        </div>
    </div>

    <!-- Chart 3: Registration Status (FULL SIZE) -->
    <div class="chart-card full-size">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-id-card"></i> Registration Status</h3>
            <div class="chart-stats" id="registrationStats">
                <span class="stat-badge heads" title="Registered household heads">Heads: 0</span>
                <span class="stat-badge members" title="Registered household members">Members: 0</span>
                <span class="stat-badge total" title="Total registered persons">Total: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartRegistration"></canvas>
        </div>
    </div>

    <!-- Chart 4: Status Distribution (FULL SIZE) -->
    <div class="chart-card full-size">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-chart-pie"></i> Status Distribution</h3>
            <div class="chart-stats" id="statusStats">
                <span class="stat-badge heads" title="Household heads by status">Heads: 0</span>
                <span class="stat-badge members" title="Household members by status">Members: 0</span>
                <span class="stat-badge total" title="Total persons by status">Total: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartStatus"></canvas>
        </div>
    </div>

    <!-- Chart 5: PWD Distribution (FULL SIZE) -->
    <div class="chart-card full-size">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-wheelchair"></i> PWD Distribution</h3>
            <div class="chart-stats" id="pwdStats">
                <span class="stat-badge heads" title="Household heads with disability">Heads: 0</span>
                <span class="stat-badge members" title="Household members with disability">Members: 0</span>
                <span class="stat-badge total" title="Total persons with disability">Total: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartPWD"></canvas>
        </div>
    </div>

    <!-- Chart 6: Government Support (FULL SIZE) - CHECKBOX DATA -->
    <div class="chart-card full-size">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-hand-holding-heart"></i> Government Support</h3>
            <div class="chart-stats" id="supportStats">
                <span class="stat-badge checkbox-heads" title="Number of support instances checked by household heads">Support Checks (Heads): 0</span>
                <span class="stat-badge checkbox-members" title="Number of support instances checked by household members">Support Checks (Members): 0</span>
                <span class="stat-badge checkbox-total" title="Total number of support instances checked">Total Checks: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartSupport"></canvas>
        </div>
    </div>

    <!-- NEW CHART: Additional Information (FULL SIZE) - CHECKBOX DATA -->
    <div class="chart-card full-size">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-info-circle"></i> Additional Information</h3>
            <div class="chart-stats" id="additionalStats">
                <span class="stat-badge checkbox-heads" title="Number of additional info instances checked by household heads">Info Checks (Heads): 0</span>
                <span class="stat-badge checkbox-members" title="Number of additional info instances checked by household members">Info Checks (Members): 0</span>
                <span class="stat-badge checkbox-total" title="Total number of additional info instances checked">Total Checks: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartAdditional"></canvas>
        </div>
    </div>

    <!-- NEW CHART: Assembly Area Distribution (FULL SIZE) - CHECKBOX DATA -->
    <div class="chart-card full-size">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-building"></i> Assembly Area Distribution</h3>
            <div class="chart-stats" id="assemblyStats">
                <span class="stat-badge checkbox-heads" title="Number of assembly area instances checked by household heads">Area Checks (Heads): 0</span>
                <span class="stat-badge checkbox-members" title="Number of assembly area instances checked by household members">Area Checks (Members): 0</span>
                <span class="stat-badge checkbox-total" title="Total number of assembly area instances checked">Total Checks: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartAssembly"></canvas>
        </div>
    </div>

    <!-- NEW CHART: Transportation & Evacuation Details (FULL SIZE) - CHECKBOX DATA -->
    <div class="chart-card full-size">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-car"></i> Transportation & Evacuation Details</h3>
            <div class="chart-stats" id="transportStats">
                <span class="stat-badge checkbox-heads" title="Number of evacuation need instances checked by household heads">Evacuation Checks (Heads): 0</span>
                <span class="stat-badge checkbox-members" title="Number of evacuation need instances checked by household members">Evacuation Checks (Members): 0</span>
                <span class="stat-badge checkbox-total" title="Total number of evacuation need instances checked">Total Checks: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartTransport"></canvas>
        </div>
    </div>

    <!-- NEW CHART: Type of Disability (FULL SIZE) -->
    <div class="chart-card full-size">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-universal-access"></i> Type of Disability</h3>
            <div class="chart-stats" id="disabilityStats">
                <span class="stat-badge heads" title="Household heads by disability type">Heads: 0</span>
                <span class="stat-badge members" title="Household members by disability type">Members: 0</span>
                <span class="stat-badge total" title="Total persons by disability type">Total: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartDisabilityType"></canvas>
        </div>
    </div>

    <!-- Grid view (two charts per row) -->
    
    <!-- Row 1 -->
    <!-- Chart 7: Age Distribution -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-users"></i> Age Distribution</h3>
            <div class="chart-stats" id="ageStats">
                <span class="stat-badge heads" title="Household heads by age group">Heads: 0</span>
                <span class="stat-badge members" title="Household members by age group">Members: 0</span>
                <span class="stat-badge total" title="Total persons by age group">Total: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartAgeGroup"></canvas>
        </div>
    </div>

    <!-- Chart 8: Stage Distribution -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-layer-group"></i> Stage Distribution</h3>
            <div class="chart-stats" id="stageStats">
                <span class="stat-badge heads" title="Household heads by stage">Heads: 0</span>
                <span class="stat-badge members" title="Household members by stage">Members: 0</span>
                <span class="stat-badge total" title="Total persons by stage">Total: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartStage"></canvas>
        </div>
    </div>

    <!-- Row 2 -->
    <!-- Chart 9: Domestic Livestock -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-paw"></i> Domestic Livestock</h3>
            <div class="chart-stats" id="livestockStats">
                <span class="stat-badge total" title="Total number of animals">Livestock: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartLivestock"></canvas>
        </div>
    </div>

    <!-- Chart 10: Overseas Filipino Workers -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-passport"></i> Overseas Filipino Workers</h3>
            <div class="chart-stats" id="ofwStats">
                <span class="stat-badge total" title="Total number of OFWs">OFWs: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartOFW"></canvas>
        </div>
    </div>

    <!-- Row 3 -->
    <!-- Chart 11: Educational Attainment -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-graduation-cap"></i> Educational Attainment</h3>
            <div class="chart-stats" id="educationStats">
                <span class="stat-badge total" title="Number of education levels">Levels: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartEducation"></canvas>
        </div>
    </div>

    <!-- Chart 12: Employment Status -->
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title" data-total="0"><i class="fas fa-briefcase"></i> Employment Status</h3>
            <div class="chart-stats" id="employmentStats">
                <span class="stat-badge total" title="Number of employment statuses">Statuses: 0</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chartEmployment"></canvas>
        </div>
    </div>
</div>

<!-- Mobile Bottom Navigation - Fixed - REMOVED LOGOUT BUTTON -->
<nav class="mobile-bottom-nav" id="mobileBottomNav">
  <div class="mobile-nav-items">
    <a href="dashboard.html" class="mobile-nav-item" title="Dashboard">
      <span class="mobile-nav-icon">üìä</span>
      <span class="mobile-nav-text">Dashboard</span>
    </a>
    <a href="dataForm.html" class="mobile-nav-item" title="Data Entry">
      <span class="mobile-nav-icon">üìù</span>
      <span class="mobile-nav-text">Data Entry</span>
    </a>
    <a href="records.html" class="mobile-nav-item" title="Records">
      <span class="mobile-nav-icon">üìÅ</span>
      <span class="mobile-nav-text">Records</span>
    </a>
    <a href="charts.html" class="mobile-nav-item active" title="Charts">
      <span class="mobile-nav-icon">üìà</span>
      <span class="mobile-nav-text">Charts</span>
    </a>
    <a href="users.html" class="mobile-nav-item admin-only" title="Users" id="mobileUsersNav">
      <span class="mobile-nav-icon">üë•</span>
      <span class="mobile-nav-text">Users</span>
    </a>
    <!-- REMOVED: Logout button in mobile nav -->
  </div>
</nav>

<!-- Loading overlay -->
<div id="loading">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div>Loading charts data...</div>
  </div>
</div>

<!-- JavaScript Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
/* ============ STATS VIEW MANAGER ============ */
const StatsManager = {
    currentView: 'badges', // 'badges', 'summary', or 'compact'
    
    init() {
        // Load saved preference
        const savedView = localStorage.getItem('statsViewPreference') || 'badges';
        this.setView(savedView);
        
        // Set up toggle buttons
        document.getElementById('toggleBadges').addEventListener('click', () => this.setView('badges'));
        document.getElementById('toggleSummary').addEventListener('click', () => this.setView('summary'));
        document.getElementById('toggleCompact').addEventListener('click', () => this.setView('compact'));
    },
    
    setView(view) {
        this.currentView = view;
        localStorage.setItem('statsViewPreference', view);
        
        // Update toggle buttons
        document.querySelectorAll('.stats-toggle-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.view === view) {
                btn.classList.add('active');
            }
        });
        
        // Show/hide elements based on view
        const globalStats = document.getElementById('globalStatsSummary');
        const statsToggle = document.getElementById('statsViewToggle');
        const chartStats = document.querySelectorAll('.chart-stats');
        const chartTitles = document.querySelectorAll('.chart-title');
        const globalTimestamp = document.querySelector('.global-stats-timestamp');
        
        // Remove previous classes
        document.body.classList.remove('stats-view-badges', 'stats-view-summary', 'stats-view-compact');
        document.body.classList.add(`stats-view-${view}`);
        
        switch(view) {
            case 'badges':
                // Option 1: Show badges on charts, hide global summary
                globalStats.classList.remove('visible');
                statsToggle.classList.add('visible');
                chartStats.forEach(stats => {
                    stats.classList.remove('hide-on-mobile');
                    stats.style.display = 'flex';
                });
                chartTitles.forEach(title => {
                    title.classList.remove('compact');
                });
                if (globalTimestamp) {
                    globalTimestamp.style.display = 'flex';
                }
                break;
                
            case 'summary':
                // Option 2: Show global summary, hide chart badges
                globalStats.classList.add('visible');
                statsToggle.classList.add('visible');
                chartStats.forEach(stats => {
                    stats.classList.remove('hide-on-mobile');
                    stats.style.display = 'none';
                });
                chartTitles.forEach(title => {
                    title.classList.remove('compact');
                });
                // Hide "Updated" text in summary view
                if (globalTimestamp) {
                    globalTimestamp.style.display = 'none';
                }
                break;
                
            case 'compact':
                // Compact view: Hide stats on mobile, show in title
                globalStats.classList.remove('visible');
                statsToggle.classList.add('visible');
                chartStats.forEach(stats => {
                    stats.classList.add('hide-on-mobile');
                    stats.style.display = 'flex';
                });
                chartTitles.forEach(title => {
                    title.classList.add('compact');
                });
                if (globalTimestamp) {
                    globalTimestamp.style.display = 'flex';
                }
                break;
        }
        
        // Recalculate percentages if needed
        if (window.aggregatedData) {
            updateAllStats(window.aggregatedData);
        }
    }
};

/* ============ ENHANCED STATS FUNCTIONS ============ */
function formatNumber(num) {
    return num.toLocaleString();
}

function calculatePercentage(part, total) {
    if (total === 0) return 0;
    return ((part / total) * 100).toFixed(1);
}

function updateGlobalStats(aggregated) {
    const totalHeads = aggregated.totals.heads || 0;
    const totalMembers = aggregated.totals.members || 0;
    const totalAll = aggregated.totals.total || 0;
    
    // Update global summary
    document.getElementById('globalHeads').textContent = formatNumber(totalHeads);
    document.getElementById('globalMembers').textContent = formatNumber(totalMembers);
    document.getElementById('globalTotal').textContent = formatNumber(totalAll);
    
    // Update last updated time - only show in badges view
    const now = new Date();
    const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const timestampElement = document.getElementById('globalLastUpdated');
    if (timestampElement) {
        timestampElement.textContent = `${timeString}`;
    }
}

function updateChartStatsWithPercentages(chartId, heads, members, total) {
    const totalAll = heads + members;
    const headsPercentage = calculatePercentage(heads, totalAll);
    const membersPercentage = calculatePercentage(members, totalAll);
    
    const statsContainer = document.getElementById(`${chartId}Stats`);
    if (!statsContainer) return;
    
    // Update heads badge
    const headsBadge = statsContainer.querySelector('.stat-badge.heads');
    if (headsBadge) {
        headsBadge.innerHTML = `Heads: ${formatNumber(heads)} <span class="percentage">(${headsPercentage}%)</span>`;
    }
    
    // Update members badge
    const membersBadge = statsContainer.querySelector('.stat-badge.members');
    if (membersBadge) {
        membersBadge.innerHTML = `Members: ${formatNumber(members)} <span class="percentage">(${membersPercentage}%)</span>`;
    }
    
    // Update total badge
    const totalBadge = statsContainer.querySelector('.stat-badge.total');
    if (totalBadge) {
        totalBadge.textContent = `Total: ${formatNumber(total)}`;
    }
    
    // Update title data attribute for compact view
    const chartTitle = statsContainer.closest('.chart-header').querySelector('.chart-title');
    if (chartTitle) {
        chartTitle.setAttribute('data-total', total);
    }
}

function updateCheckboxChartStats(chartId, headsTotal, membersTotal, total) {
    const statsContainer = document.getElementById(`${chartId}Stats`);
    if (!statsContainer) return;
    
    // Update checkbox-specific badges
    const headsBadge = statsContainer.querySelector('.stat-badge.checkbox-heads');
    if (headsBadge) {
        headsBadge.innerHTML = `Checks (Heads): ${formatNumber(headsTotal)}`;
    } else {
        // Fallback to regular heads badge
        const fallbackHeads = statsContainer.querySelector('.stat-badge.heads');
        if (fallbackHeads) {
            fallbackHeads.innerHTML = `Checks (Heads): ${formatNumber(headsTotal)}`;
        }
    }
    
    const membersBadge = statsContainer.querySelector('.stat-badge.checkbox-members');
    if (membersBadge) {
        membersBadge.innerHTML = `Checks (Members): ${formatNumber(membersTotal)}`;
    } else {
        // Fallback to regular members badge
        const fallbackMembers = statsContainer.querySelector('.stat-badge.members');
        if (fallbackMembers) {
            fallbackMembers.innerHTML = `Checks (Members): ${formatNumber(membersTotal)}`;
        }
    }
    
    const totalBadge = statsContainer.querySelector('.stat-badge.checkbox-total');
    if (totalBadge) {
        totalBadge.textContent = `Total Checks: ${formatNumber(total)}`;
    } else {
        // Fallback to regular total badge
        const fallbackTotal = statsContainer.querySelector('.stat-badge.total');
        if (fallbackTotal) {
            fallbackTotal.textContent = `Total Checks: ${formatNumber(total)}`;
        }
    }
    
    // Update title data attribute for compact view
    const chartTitle = statsContainer.closest('.chart-header').querySelector('.chart-title');
    if (chartTitle) {
        chartTitle.setAttribute('data-total', total);
    }
}

function updateAllStats(aggregated) {
    console.log("=== UPDATING ENHANCED STATS ===");
    
    // Store for StatsManager access
    window.aggregatedData = aggregated;
    
    // Update global stats (Option 2)
    updateGlobalStats(aggregated);
    
    // Calculate totals
    const totalHeads = aggregated.totals.heads || 0;
    const totalMembers = aggregated.totals.members || 0;
    const totalAll = aggregated.totals.total || 0;
    
    // Update each chart's stats with percentages
    updateChartStatsWithPercentages('barangay', totalHeads, totalMembers, totalAll);
    
    // Age stats
    const ageHeadsTotal = aggregated.ageGroups.heads?.reduce((a, b) => a + b, 0) || 0;
    const ageMembersTotal = aggregated.ageGroups.members?.reduce((a, b) => a + b, 0) || 0;
    const ageTotal = aggregated.ageGroups.values?.reduce((a, b) => a + b, 0) || 0;
    updateChartStatsWithPercentages('age', ageHeadsTotal, ageMembersTotal, ageTotal);
    
    // Stage stats
    const stageTotal = aggregated.stage.values?.reduce((a, b) => a + b, 0) || 0;
    const stageHeads = Math.round(totalHeads * (stageTotal / totalAll)) || 0;
    const stageMembers = stageTotal - stageHeads;
    updateChartStatsWithPercentages('stage', stageHeads, stageMembers, stageTotal);
    
    // PWD stats
    const pwdHeadsTotal = (aggregated.pwd.headsYes || 0) + (aggregated.pwd.headsNo || 0);
    const pwdMembersTotal = (aggregated.pwd.membersYes || 0) + (aggregated.pwd.membersNo || 0);
    const pwdTotal = pwdHeadsTotal + pwdMembersTotal;
    updateChartStatsWithPercentages('pwd', pwdHeadsTotal, pwdMembersTotal, pwdTotal);
    
    // Status stats
    const statusHeadsTotal = aggregated.status.heads?.values?.reduce((a, b) => a + b, 0) || 0;
    const statusMembersTotal = aggregated.status.members?.values?.reduce((a, b) => a + b, 0) || 0;
    const statusTotal = statusHeadsTotal + statusMembersTotal;
    updateChartStatsWithPercentages('status', statusHeadsTotal, statusMembersTotal, statusTotal);
    
    // ============ FIXED: CHECKBOX CHARTS ============
    // Government Support stats - CHECKBOX DATA (show instance counts, not person counts)
    const supportHeadsTotal = aggregated.support.heads?.reduce((a, b) => a + b, 0) || 0;
    const supportMembersTotal = aggregated.support.members?.reduce((a, b) => a + b, 0) || 0;
    const supportTotal = supportHeadsTotal + supportMembersTotal;
    updateCheckboxChartStats('support', supportHeadsTotal, supportMembersTotal, supportTotal);
    
    // Registration stats
    const regHeadsTotal = aggregated.registration.heads?.reduce((a, b) => a + b, 0) || 0;
    const regMembersTotal = aggregated.registration.members?.reduce((a, b) => a + b, 0) || 0;
    const regTotal = regHeadsTotal + regMembersTotal;
    updateChartStatsWithPercentages('registration', regHeadsTotal, regMembersTotal, regTotal);
    
    // Additional Information stats - CHECKBOX DATA
    const additionalHeadsTotal = aggregated.additional.heads?.reduce((a, b) => a + b, 0) || 0;
    const additionalMembersTotal = aggregated.additional.members?.reduce((a, b) => a + b, 0) || 0;
    const additionalTotal = additionalHeadsTotal + additionalMembersTotal;
    updateCheckboxChartStats('additional', additionalHeadsTotal, additionalMembersTotal, additionalTotal);
    
    // Assembly Area stats - CHECKBOX DATA
    const assemblyHeadsTotal = aggregated.assembly.heads?.reduce((a, b) => a + b, 0) || 0;
    const assemblyMembersTotal = aggregated.assembly.members?.reduce((a, b) => a + b, 0) || 0;
    const assemblyTotal = assemblyHeadsTotal + assemblyMembersTotal;
    updateCheckboxChartStats('assembly', assemblyHeadsTotal, assemblyMembersTotal, assemblyTotal);
    
    // Transportation stats - CHECKBOX DATA
    const transportHeadsTotal = aggregated.transport.heads?.reduce((a, b) => a + b, 0) || 0;
    const transportMembersTotal = aggregated.transport.members?.reduce((a, b) => a + b, 0) || 0;
    const transportTotal = transportHeadsTotal + transportMembersTotal;
    updateCheckboxChartStats('transport', transportHeadsTotal, transportMembersTotal, transportTotal);
    
    // Disability Type stats
    const disabilityHeadsTotal = aggregated.disabilityType.heads?.reduce((a, b) => a + b, 0) || 0;
    const disabilityMembersTotal = aggregated.disabilityType.members?.reduce((a, b) => a + b, 0) || 0;
    const disabilityTotal = disabilityHeadsTotal + disabilityMembersTotal;
    updateChartStatsWithPercentages('disability', disabilityHeadsTotal, disabilityMembersTotal, disabilityTotal);
    
    // Special charts (no heads/members breakdown)
    const livestockTotal = aggregated.livestock.values?.reduce((a, b) => a + b, 0) || 0;
    const livestockStats = document.getElementById('livestockStats');
    if (livestockStats) {
        const totalBadge = livestockStats.querySelector('.stat-badge.total');
        if (totalBadge) totalBadge.textContent = `Animals: ${formatNumber(livestockTotal)}`;
        const chartTitle = livestockStats.closest('.chart-header').querySelector('.chart-title');
        if (chartTitle) chartTitle.setAttribute('data-total', livestockTotal);
    }
    
    const ofwTotal = aggregated.ofw["OFW (Yes)"] || 0;
    const ofwStats = document.getElementById('ofwStats');
    if (ofwStats) {
        const totalBadge = ofwStats.querySelector('.stat-badge.total');
        if (totalBadge) totalBadge.textContent = `OFWs: ${formatNumber(ofwTotal)}`;
        const chartTitle = ofwStats.closest('.chart-header').querySelector('.chart-title');
        if (chartTitle) chartTitle.setAttribute('data-total', ofwTotal);
    }
    
    const educationTotal = aggregated.education.values?.reduce((a, b) => a + b, 0) || 0;
    const educationStats = document.getElementById('educationStats');
    if (educationStats) {
        const totalBadge = educationStats.querySelector('.stat-badge.total');
        if (totalBadge) totalBadge.textContent = `Levels: ${aggregated.education.labels?.length || 0}`;
        const chartTitle = educationStats.closest('.chart-header').querySelector('.chart-title');
        if (chartTitle) chartTitle.setAttribute('data-total', educationTotal);
    }
    
    const employmentTotal = aggregated.employment.values?.reduce((a, b) => a + b, 0) || 0;
    const employmentStats = document.getElementById('employmentStats');
    if (employmentStats) {
        const totalBadge = employmentStats.querySelector('.stat-badge.total');
        if (totalBadge) totalBadge.textContent = `Statuses: ${aggregated.employment.labels?.length || 0}`;
        const chartTitle = employmentStats.closest('.chart-header').querySelector('.chart-title');
        if (chartTitle) chartTitle.setAttribute('data-total', employmentTotal);
    }
    
    // Comparison chart
    const comparisonStats = document.getElementById('comparisonStats');
    if (comparisonStats) {
        const chartTitle = comparisonStats.closest('.chart-header').querySelector('.chart-title');
        if (chartTitle) chartTitle.setAttribute('data-total', totalAll);
    }
    
    console.log("‚úÖ Enhanced stats updated with checkbox fixes");
}

/* ============ CONFIG ============ */
const API_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";

/* ============ CHART INSTANCES ============ */
const CH = {};

/* ============ QUICK CANVAS CLEANUP ============ */
function quickCleanCanvas(canvasId) {
    // Ultra-fast cleanup - no loops, no checks, just direct cleanup
    const chart = CH[canvasId];
    if (chart && chart.destroy) {
        try { chart.destroy(); } catch(e) {}
        CH[canvasId] = null;
    }
}

function cleanupAllChartsFast() {
    // Clean up all chart canvases to prevent "already in use" errors
    const chartIds = [
        'chartBarangay', 'chartAgeGroup', 'chartStage', 'chartPWD',
        'chartStatus', 'chartSupport', 'chartRegistration', 'chartLivestock',
        'chartOFW', 'chartEducation', 'chartEmployment', 'chartComparison',
        'chartAdditional', 'chartAssembly', 'chartTransport', 'chartDisabilityType'
    ];
    
    // Clean each chart
    chartIds.forEach(id => {
        if (CH[id] && CH[id].destroy) {
            try {
                CH[id].destroy();
            } catch(e) {
                // Ignore errors
            }
            CH[id] = null;
        }
    });
    
    console.log("üßπ Cleaned all chart canvases");
}

/* ============ AUTO-REFRESH CONFIG ============ */
const AUTO_REFRESH_MS = 60000; // 60 seconds
let refreshInterval = null;

/* ============ UTILITY FUNCTIONS ============ */
function showLoading(yes){ 
    document.getElementById("loading").style.display = yes ? "flex" : "none"; 
}

function showError(message) {
    const errorEl = document.getElementById('errorMessage');
    document.getElementById('errorText').textContent = message;
    errorEl.classList.add('show');
    setTimeout(() => errorEl.classList.remove('show'), 10000);
}

function getField(r, key) {
    if (!r) return "";
    
    // Try exact match first
    if (r.hasOwnProperty(key)) return r[key];
    
    const kl = key.toLowerCase().trim();
    
    // Try multiple variations
    const variations = [
        kl,
        kl.replace(/[()]/g, ''), // Remove parentheses
        kl.replace(/\s+/g, ''), // Remove spaces
        kl.replace(/\s+/g, '_'), // Replace spaces with underscores
        kl.replace(/\s+/g, '-'), // Replace spaces with hyphens
        kl.replace(/\./g, ''), // Remove dots
        kl.replace(/\./g, ' ') // Replace dots with spaces
    ];
    
    for (const k of Object.keys(r)) {
        const normalizedKey = String(k).toLowerCase().trim();
        
        // Exact match with any variation
        for (const variation of variations) {
            if (normalizedKey === variation) {
                return r[k];
            }
        }
        
        // Contains match
        if (normalizedKey.includes(kl) || kl.includes(normalizedKey)) {
            return r[k];
        }
    }
    
    return "";
}

function parseAnyDate(v){
    if(!v && v !== 0) return null;
    if (v instanceof Date) return v;
    v = String(v).trim();
    if (!v) return null;
    if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(v)){
        const p = v.split('/');
        return new Date(Number(p[2]), Number(p[1]) - 1, Number(p[0]));
    }
    if(/^\d{4}-\d{2}-\d{2}/.test(v)){
        return new Date(v);
    }
    const d = new Date(v);
    return isNaN(d) ? null : d;
}

function monthsBetween(d1, d2){
    if(!d1 || !d2) return null;
    let years = d2.getFullYear() - d1.getFullYear();
    let months = d2.getMonth() - d1.getMonth();
    let m = years*12 + months;
    if(d2.getDate() < d1.getDate()) m--;
    return m;
}

function ageInYearsFromBirth(bd){
    const d = parseAnyDate(bd);
    if(!d) return null;
    const now = new Date();
    let years = now.getFullYear() - d.getFullYear();
    const m = now.getMonth() - d.getMonth();
    if(m < 0 || (m === 0 && now.getDate() < d.getDate())) years--;
    return years;
}

function normalizeRow(r){
    const barangay = String(getField(r,"Barangay") || "").trim() || "Unknown";
    const stage = String(getField(r,"Stage") || "").trim() || "Unspecified";
    const pwdRaw = String(getField(r,"Persons with Disability (PWD)") || getField(r,"PWD") || "").trim().toLowerCase();
    const pwd = (pwdRaw === "yes" || pwdRaw === "y" || pwdRaw === "true") ? "Yes" : (pwdRaw === "no" ? "No" : (pwdRaw === "" ? "No" : pwdRaw));
    const status = String(getField(r,"Status") || "").trim() || "Unspecified";
    const birthRaw = getField(r,"Birthdate") || getField(r,"Birth Date") || "";
    const birth = birthRaw ? String(birthRaw).trim() : "";
    
    // Determine if this is a head based on "Name of Household Member/s" field
    const memberName = String(getField(r, "Name of Household Member/s") || "").trim();
    let isHead = false;
    
    // Heads have an empty "Name of Household Member/s" field
    if (!memberName || memberName === "") {
        isHead = true;
    }
    
    // CORRECT FIELD NAMES based on your data:
    const fishR = String(getField(r, "FishR & RBIS") || "").trim();
    const rbis = String(getField(r, "FishR & RBIS") || "").trim(); // Same field for both
    
    // For OFW - use the correct field name
    const ofw = String(getField(r, "Overseas Filipino Worker(OFW)") || "").trim();
    
    // NEW FIELDS: Additional Information - FIXED FIELD NAMES
    const soloParenting = String(getField(r, "Solo Parenting") || "").trim();
    const lgbt = String(getField(r, "LGBT") || "").trim();
    const lactating = String(getField(r, "Lactating") || "").trim();
    const pregnant = String(getField(r, "Pregnant") || "").trim();
    
    // NEW FIELDS: Assembly Area
    const insideAssembly = String(getField(r, "Inside Assembly Area") || "").trim();
    const outsideAssembly = String(getField(r, "Outside Assembly Area") || "").trim();
    
    // NEW FIELDS: Transportation & Evacuation Details
    const taalVolcano = String(getField(r, "Taal Volcano (Within 14-15 KM Danger Zone)") || "").trim();
    const typhoon = String(getField(r, "Typhoon") || "").trim();
    const flood = String(getField(r, "Flood") || "").trim();
    const landslide = String(getField(r, "Landslide") || "").trim();
    const earthquake = String(getField(r, "Earthquake") || "").trim();
    const fire = String(getField(r, "Fire") || "").trim();
    const otherReasons = String(getField(r, "Other Reasons") || "").trim();
    
    // Store original row for livestock processing
    const originalRow = r;
    
    const education = String(getField(r, "Educational Attainment") || "").trim();
    const employment = String(getField(r, "Employment") || "").trim();
    
    let ageVal = getField(r,"Age");
    let ageYears = null;
    if (ageVal !== "" && ageVal !== null && ageVal !== undefined && !isNaN(Number(ageVal))) {
        ageYears = Number(ageVal);
    } else if (birth) {
        const y = ageInYearsFromBirth(birth);
        if (y !== null) ageYears = y;
    }

    // Assistance fields
    const assist = {};
    const assistKeys = ["TUPAD","Local 4Ps","National 4Ps","Local Social Pension","National Social Pension","Solo Parent Assistance","Cash Subsidy","Relief Goods","AICS"];
    assistKeys.forEach(k => {
        assist[k] = String(getField(r,k) || "").trim();
    });

    return { 
        barangay, 
        stage, 
        pwd, 
        status, 
        birth, 
        ageYears, 
        isHead,
        fishR,
        rbis,
        originalRow, // Store original row for livestock data
        ofw,
        education,
        employment,
        // NEW FIELDS
        soloParenting,
        lgbt,
        lactating,
        pregnant,
        insideAssembly,
        outsideAssembly,
        // Transportation fields
        taalVolcano,
        typhoon,
        flood,
        landslide,
        earthquake,
        fire,
        otherReasons,
        assist
    };
}

function bucketAge(norm){
    const y = norm.ageYears;
    if (y === null || y === undefined || y === "") return ""; // Changed from "Unknown" to empty string
    if (y < 1) return "Infant (0-11 mos)";
    if (y <= 17) return "School Children (‚â§17)";
    if (y >= 60) return "Elderly (60+)";
    return "Adult (18-59)";
}

/* ============ SESSION MANAGEMENT ============ */
async function sessionCheck(){
    try {
        const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
        
        if (userName && userName !== "User") {
            document.getElementById('userName').innerText = userName;
            
            const isAdmin = localStorage.getItem("userRole") === "admin";
            const adminItems = document.querySelectorAll(".admin-only");
            adminItems.forEach(item => {
                item.classList.toggle("admin-visible", isAdmin);
            });
            
            // Handle mobile nav for admin
            const mobileUsersNav = document.getElementById('mobileUsersNav');
            if (mobileUsersNav) {
                mobileUsersNav.style.display = isAdmin ? 'flex' : 'none';
            }
            
            sessionStorage.setItem('authenticated', 'true');
            return true;
        } else {
            if(sessionStorage.getItem('authenticated')) {
                document.getElementById('userName').innerText = "User";
                return true;
            } else {
                window.location.href = 'index.html?session=expired';
                return false;
            }
        }
    } catch(e){ 
        console.warn('session check failed', e);
        return false;
    }
}

function handleLogout() {
    localStorage.clear();
    sessionStorage.clear();
    const logoutUrl = 'index.html?logout=true&t=' + Date.now();
    fetch(API_URL+'?action=logout&t=' + Date.now())
        .catch(() => {})
        .finally(() => {
            window.location.replace(logoutUrl);
        });
}

/* ============ DATA FETCHING ============ */
async function fetchChartData() {
    try {
        console.log("üìä Fetching chart data...");
        
        // Show a status message for slow connections
        const statusEl = document.createElement('div');
        statusEl.id = 'fetchStatus';
        statusEl.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 10000;
            display: none;
        `;
        statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching data...';
        document.body.appendChild(statusEl);
        
        let statusTimeout = setTimeout(() => {
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Still loading... Network might be slow';
        }, 5000); // Show after 5 seconds
        
        const url = API_URL + "?action=getRecords&t=" + Date.now();
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 45000); // 45 seconds
        
        const res = await fetch(url, {
            cache: "no-store",
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        clearTimeout(statusTimeout);
        statusEl.remove();
        
        if(!res.ok) throw new Error("Network error " + res.status);
        const j = await res.json();
        if(!j || !j.success) throw new Error("Bad response from API");
        
        console.log(`‚úÖ Loaded ${j.rows?.length || 0} records`);
        return j.rows || [];
        
    } catch(err) {
        if (err.name === 'AbortError') {
            console.warn("Request timed out - likely slow internet");
            showError("Connection is slow. Try refreshing or check your internet.");
        } else {
            console.error("Fetch error:", err);
            showError("Failed to load data: " + err.message);
        }
        throw err;
    }
}

/* ============ CHART FUNCTIONS - UPDATED FOR BOTTOM-CENTERED LEGENDS ============ */
function createBarChart(id, labels, values, title, color, isStacked = false, datasets = null) {
    // FAST FIX: Quick cleanup before creating chart
    quickCleanCanvas(id);
    
    const ctx = document.getElementById(id).getContext('2d');

    // Different color sets for each chart
    const chartColors = {
        'chartBarangay': {
            heads: 'rgba(52, 183, 143, 0.8)',
            members: 'rgba(70, 140, 240, 0.8)',
            borderHeads: 'rgba(52, 183, 143, 1)',
            borderMembers: 'rgba(70, 140, 240, 1)'
        },
        'chartRegistration': {
            heads: 'rgba(255, 99, 132, 0.8)',
            members: 'rgba(255, 159, 64, 0.8)',
            borderHeads: 'rgba(255, 99, 132, 1)',
            borderMembers: 'rgba(255, 159, 64, 1)'
        },
        'chartStatus': {
            heads: 'rgba(75, 192, 192, 0.8)',
            members: 'rgba(153, 102, 255, 0.8)',
            borderHeads: 'rgba(75, 192, 192, 1)',
            borderMembers: 'rgba(153, 102, 255, 1)'
        },
        'chartPWD': {
            headsPWD: 'rgba(255, 205, 86, 0.8)',
            headsNon: 'rgba(255, 205, 86, 0.4)',
            membersPWD: 'rgba(54, 162, 235, 0.8)',
            membersNon: 'rgba(54, 162, 235, 0.4)',
            borderHeadsPWD: 'rgba(255, 205, 86, 1)',
            borderHeadsNon: 'rgba(255, 205, 86, 0.7)',
            borderMembersPWD: 'rgba(54, 162, 235, 1)',
            borderMembersNon: 'rgba(54, 162, 235, 0.7)'
        },
        'chartSupport': {
            heads: 'rgba(201, 203, 207, 0.8)',
            members: 'rgba(255, 87, 87, 0.8)',
            borderHeads: 'rgba(201, 203, 207, 1)',
            borderMembers: 'rgba(255, 87, 87, 1)'
        },
        'chartAdditional': {
            heads: 'rgba(106, 90, 205, 0.8)',
            members: 'rgba(60, 179, 113, 0.8)',
            borderHeads: 'rgba(106, 90, 205, 1)',
            borderMembers: 'rgba(60, 179, 113, 1)'
        },
        'chartAssembly': {
            heads: 'rgba(255, 140, 0, 0.8)',
            members: 'rgba(30, 144, 255, 0.8)',
            borderHeads: 'rgba(255, 140, 0, 1)',
            borderMembers: 'rgba(30, 144, 255, 1)'
        },
        'chartTransport': {
            heads: 'rgba(220, 20, 60, 0.8)',
            members: 'rgba(138, 43, 226, 0.8)',
            borderHeads: 'rgba(220, 20, 60, 1)',
            borderMembers: 'rgba(138, 43, 226, 1)'
        },
        'chartDisabilityType': {
            heads: 'rgba(128, 0, 128, 0.8)',
            members: 'rgba(255, 20, 147, 0.8)',
            borderHeads: 'rgba(128, 0, 128, 1)',
            borderMembers: 'rgba(255, 20, 147, 1)'
        }
    };

    if (datasets) {
        // Apply specific colors based on chart ID
        if (chartColors[id]) {
            datasets.forEach((dataset, index) => {
                if (dataset.label === 'Heads') {
                    dataset.backgroundColor = chartColors[id].heads;
                    dataset.borderColor = chartColors[id].borderHeads;
                } else if (dataset.label === 'Members') {
                    dataset.backgroundColor = chartColors[id].members;
                    dataset.borderColor = chartColors[id].borderMembers;
                } else if (dataset.label === 'Heads - PWD') {
                    dataset.backgroundColor = chartColors[id].headsPWD;
                    dataset.borderColor = chartColors[id].borderHeadsPWD;
                } else if (dataset.label === 'Heads - Non-PWD') {
                    dataset.backgroundColor = chartColors[id].headsNon;
                    dataset.borderColor = chartColors[id].borderHeadsNon;
                } else if (dataset.label === 'Members - PWD') {
                    dataset.backgroundColor = chartColors[id].membersPWD;
                    dataset.borderColor = chartColors[id].borderMembersPWD;
                } else if (dataset.label === 'Members - Non-PWD') {
                    dataset.backgroundColor = chartColors[id].membersNon;
                    dataset.borderColor = chartColors[id].borderMembersNon;
                }
            });
        }

        // Multiple datasets for stacked chart
        CH[id] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                layout: {
                    padding: {
                        top: 10,
                        right: 15,
                        bottom: 40, // Increased bottom padding for legend
                        left: 10
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        align: 'center',
                        labels: {
                            font: { size: 11 },
                            padding: 15,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 12 },
                        bodyFont: { size: 12 },
                        padding: 10,
                        cornerRadius: 6,
                        mode: isStacked ? 'index' : 'nearest',
                        position: 'nearest',
                        intersect: false,
                        caretPadding: 10,
                        boxPadding: 5
                    }
                },
                scales: {
                    x: {
                        stacked: isStacked,
                        grid: { display: false },
                        ticks: { 
                            font: { size: 10 },
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        stacked: isStacked,
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { 
                            font: { size: 10 },
                            precision: 0
                        }
                    }
                }
            }
        });
    } else {
        // Single dataset
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, color);
        gradient.addColorStop(1, color.replace('0.8', '0.4'));

        CH[id] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: title,
                    data: values,
                    backgroundColor: gradient,
                    borderColor: color,
                    borderWidth: 1,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                layout: {
                    padding: {
                        top: 10,
                        right: 15,
                        bottom: 15,
                        left: 10
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 12 },
                        bodyFont: { size: 12 },
                        padding: 10,
                        cornerRadius: 6,
                        position: 'nearest',
                        intersect: false,
                        caretPadding: 10,
                        boxPadding: 5
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { 
                            font: { size: 10 },
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { 
                            font: { size: 10 },
                            precision: 0
                        }
                    }
                }
            }
        });
    }
}

function createDoughnutChart(id, labels, values, title) {
    // FAST FIX: Quick cleanup
    quickCleanCanvas(id);
    
    const ctx = document.getElementById(id).getContext('2d');

    // Different color sets for different charts
    let backgroundColors;
    if (id === 'chartStage') {
        // Stage Distribution - different colors
        backgroundColors = [
            'rgba(52, 183, 143, 0.8)',
            'rgba(70, 140, 240, 0.8)',
            'rgba(246, 176, 66, 0.8)',
            'rgba(242, 108, 79, 0.8)',
            'rgba(123, 97, 255, 0.8)',
            'rgba(0, 150, 199, 0.8)',
            'rgba(255, 122, 182, 0.8)',
            'rgba(108, 117, 125, 0.8)'
        ];
    } else if (id === 'chartEmployment') {
        // Employment Status - different colors
        backgroundColors = [
            'rgba(255, 87, 87, 0.8)',
            'rgba(87, 87, 255, 0.8)',
            'rgba(87, 255, 87, 0.8)',
            'rgba(255, 255, 87, 0.8)',
            'rgba(255, 87, 255, 0.8)',
            'rgba(87, 255, 255, 0.8)'
        ];
    } else {
        // Default colors
        backgroundColors = [
            'rgba(52, 183, 143, 0.8)',
            'rgba(70, 140, 240, 0.8)',
            'rgba(246, 176, 66, 0.8)',
            'rgba(242, 108, 79, 0.8)',
            'rgba(123, 97, 255, 0.8)',
            'rgba(0, 150, 199, 0.8)',
            'rgba(255, 122, 182, 0.8)',
            'rgba(108, 117, 125, 0.8)'
        ];
    }

    CH[id] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: backgroundColors,
                borderWidth: 2,
                borderColor: '#ffffff',
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    align: 'center',
                    labels: {
                        padding: 15,
                        font: { size: 11 },
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 12 },
                    bodyFont: { size: 12 },
                    padding: 10,
                    cornerRadius: 6
                }
            },
            cutout: '60%'
        }
    });
}

function createHorizontalBarChart(id, labels, values, title) {
    // FAST FIX: Quick cleanup
    quickCleanCanvas(id);
    
    const ctx = document.getElementById(id).getContext('2d');

    const gradient = ctx.createLinearGradient(0, 0, 400, 0);
    gradient.addColorStop(0, 'rgba(52, 183, 143, 0.8)');
    gradient.addColorStop(1, 'rgba(70, 140, 240, 0.8)');

    CH[id] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: title,
                data: values,
                backgroundColor: gradient,
                borderColor: 'rgba(52, 183, 143, 1)',
                borderWidth: 1,
                borderRadius: 6
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 12 },
                    bodyFont: { size: 12 },
                    padding: 10,
                    cornerRadius: 6
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: { 
                        font: { size: 10 },
                        precision: 0
                    }
                },
                y: {
                    grid: { display: false },
                    ticks: { 
                        font: { size: 10 },
                        maxRotation: 0
                    }
                }
            }
        }
    });
}

function createComparisonChart(labels, datasets) {
    // FAST FIX: Quick cleanup
    quickCleanCanvas('chartComparison');
    
    const ctx = document.getElementById('chartComparison').getContext('2d');

    const backgroundColors = [
        'rgba(52, 183, 143, 0.7)',
        'rgba(70, 140, 240, 0.7)',
        'rgba(246, 176, 66, 0.7)',
        'rgba(242, 108, 79, 0.7)',
        'rgba(123, 97, 255, 0.7)',
        'rgba(0, 150, 199, 0.7)'
    ];

    CH['chartComparison'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets.map((dataset, index) => ({
                ...dataset,
                backgroundColor: backgroundColors[index % backgroundColors.length],
                borderColor: backgroundColors[index % backgroundColors.length].replace('0.7', '1'),
                borderWidth: 1,
                borderRadius: 4
            }))
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    align: 'center',
                    labels: {
                        padding: 15,
                        font: { size: 11 },
                        usePointStyle: true
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 12 },
                    bodyFont: { size: 12 },
                    padding: 10,
                    cornerRadius: 6
                }
            },
            scales: {
                x: {
                    stacked: false,
                    grid: { display: false },
                    ticks: { 
                        font: { size: 10 },
                        maxRotation: 45,
                        minRotation: 0
                    }
                },
                y: {
                    stacked: false,
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: { 
                        font: { size: 10 },
                        precision: 0
                    }
                }
            }
        }
    });
}

/* ============ EMPTY CHART FUNCTIONS ============ */
function createEmptyDoughnutChart(chartId, title, message = "No data available") {
  // FAST FIX: Quick cleanup
  quickCleanCanvas(chartId);
  if (window[chartId + 'Chart']) {
    try { window[chartId + 'Chart'].destroy(); } catch(e) {}
    window[chartId + 'Chart'] = null;
  }
  
  const ctx = document.getElementById(chartId);
  if (!ctx) {
    console.error(`Canvas element not found for chart: ${chartId}`);
    return null;
  }
  
  // Create empty chart with message
  const chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: [message],
      datasets: [{
        data: [1],
        backgroundColor: ['#e0e0e0'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        title: {
          display: true,
          text: title,
          font: {
            size: 14,
            weight: 'bold'
          }
        },
        tooltip: {
          enabled: false
        }
      },
      cutout: '70%'
    }
  });
  
  // Store reference to chart
  window[chartId + 'Chart'] = chart;
  return chart;
}

function createEmptyBarChart(chartId, title, message = "No data available") {
  // FAST FIX: Quick cleanup
  quickCleanCanvas(chartId);
  if (window[chartId + 'Chart']) {
    try { window[chartId + 'Chart'].destroy(); } catch(e) {}
    window[chartId + 'Chart'] = null;
  }
  
  const ctx = document.getElementById(chartId);
  if (!ctx) {
    console.error(`Canvas element not found for chart: ${chartId}`);
    return null;
  }
  
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [message],
      datasets: [{
        data: [0],
        backgroundColor: ['#e0e0e0'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: title,
          font: { size: 14, weight: 'bold' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { display: false }
        },
        x: {
          ticks: { display: false }
        }
      }
    }
  });
  
  window[chartId + 'Chart'] = chart;
  return chart;
}

function createEmptyComparisonChart() {
    // FAST FIX: Quick cleanup
    quickCleanCanvas('chartComparison');
    
    const ctx = document.getElementById('chartComparison').getContext('2d');
    
    const backgroundColors = [
        'rgba(200, 200, 200, 0.3)',
        'rgba(200, 200, 200, 0.2)',
        'rgba(200, 200, 200, 0.1)'
    ];
    
    CH['chartComparison'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [''],
            datasets: [
                {
                    label: 'No Data',
                    data: [0],
                    backgroundColor: backgroundColors[0],
                    borderColor: 'rgba(200, 200, 200, 0.5)',
                    borderWidth: 1,
                    borderRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 500,
                easing: 'easeOutQuart'
            },
            layout: {
                padding: {
                    top: 10,
                    right: 15,
                    bottom: 40,
                    left: 10
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    align: 'center',
                    labels: {
                        padding: 15,
                        font: { size: 11 },
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    enabled: false
                }
            },
            scales: {
                x: {
                    display: false,
                    grid: { display: false }
                },
                y: {
                    display: false,
                    beginAtZero: true,
                    grid: { display: false }
                }
            }
        },
        plugins: [{
            id: 'noDataText',
            afterDraw: (chart) => {
                const { ctx, chartArea: { width, height } } = chart;
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '16px Arial';
                ctx.fillStyle = '#888';
                ctx.fillText('No Data Available', width / 2, height / 2);
                ctx.restore();
            }
        }]
    });
}

/* ============ NEW CHART FUNCTIONS ============ */

function createAdditionalChart(additionalData) {
    const additionalDatasets = [
        {
            label: 'Heads',
            data: additionalData.heads,
            backgroundColor: 'rgba(106, 90, 205, 0.8)',
            borderColor: 'rgba(106, 90, 205, 1)',
            borderWidth: 1
        },
        {
            label: 'Members',
            data: additionalData.members,
            backgroundColor: 'rgba(60, 179, 113, 0.8)',
            borderColor: 'rgba(60, 179, 113, 1)',
            borderWidth: 1
        }
    ];
    
    createBarChart('chartAdditional', additionalData.labels, null, 'Additional Information', null, true, additionalDatasets);
}

function createAssemblyChart(assemblyData) {
    const assemblyDatasets = [
        {
            label: 'Heads',
            data: assemblyData.heads,
            backgroundColor: 'rgba(255, 140, 0, 0.8)',
            borderColor: 'rgba(255, 140, 0, 1)',
            borderWidth: 1
        },
        {
            label: 'Members',
            data: assemblyData.members,
            backgroundColor: 'rgba(30, 144, 255, 0.8)',
            borderColor: 'rgba(30, 144, 255, 1)',
            borderWidth: 1
        }
    ];
    
    createBarChart('chartAssembly', assemblyData.labels, null, 'Assembly Area', null, true, assemblyDatasets);
}

function createTransportChart(transportData) {
    const transportDatasets = [
        {
            label: 'Heads',
            data: transportData.heads,
            backgroundColor: 'rgba(220, 20, 60, 0.8)',
            borderColor: 'rgba(220, 20, 60, 1)',
            borderWidth: 1
        },
        {
            label: 'Members',
            data: transportData.members,
            backgroundColor: 'rgba(138, 43, 226, 0.8)',
            borderColor: 'rgba(138, 43, 226, 1)',
            borderWidth: 1
        }
    ];
    
    createBarChart('chartTransport', transportData.labels, null, 'Transportation & Evacuation', null, true, transportDatasets);
}

/* ============ NEW CHART FUNCTION: TYPE OF DISABILITY ============ */
function createDisabilityTypeChart(disabilityData) {
    const disabilityDatasets = [
        {
            label: 'Heads',
            data: disabilityData.heads,
            backgroundColor: 'rgba(128, 0, 128, 0.8)', // Purple for heads
            borderColor: 'rgba(128, 0, 128, 1)',
            borderWidth: 1
        },
        {
            label: 'Members',
            data: disabilityData.members,
            backgroundColor: 'rgba(255, 20, 147, 0.8)', // Pink for members
            borderColor: 'rgba(255, 20, 147, 1)',
            borderWidth: 1
        }
    ];
    
    createBarChart('chartDisabilityType', disabilityData.labels, null, 'Type of Disability', null, true, disabilityDatasets);
}

/* ============ BUILD CHARTS FROM AGGREGATED DATA ============ */
async function buildCharts(forceRefresh = false) {
    showLoading(true);
    
    // üî• REPLACE WITH THIS LINE - Clears ALL charts to prevent "already in use" errors
    cleanupAllChartsFast();
    
    if (forceRefresh) {
        const CHART_DATA_CACHE_KEY = 'chartDataCache';
        sessionStorage.removeItem(CHART_DATA_CACHE_KEY);
        console.log("üóëÔ∏è Cache cleared for forced refresh");
    }

    // Performance monitoring start
    let performanceStart = Date.now();
    console.log("‚è±Ô∏è Starting chart loading...");
    
    try {
        console.log("üìä Fetching aggregated chart data...");
        
        // Fetch aggregated data (much smaller/faster)
        const response = await fetchAggregatedChartData(forceRefresh);
        
        if (!response.success) {
            throw new Error(response.error || "Failed to fetch aggregated data");
        }
        
        const aggregated = response.aggregated;
        const recordCount = response.recordCount || 0;
        
        console.log(`‚úÖ Loaded aggregated data for ${recordCount} records`);
        console.log("Processing time:", response.processingTime || "N/A", "seconds");
        
        // DEBUG: Log the aggregated data structure
        console.log("üîç DEBUG: Aggregated data structure:", aggregated);
        
        // Check if we have data for each chart
        console.log("üìä Checking chart data availability:");
        console.log("- Barangay data:", aggregated.barangay ? `Yes (${aggregated.barangay.labels?.length || 0} barangays)` : "No");
        console.log("- Age data:", aggregated.ageGroups ? `Yes (${aggregated.ageGroups.values?.length || 0} groups)` : "No");
        console.log("- Stage data:", aggregated.stage ? `Yes (${aggregated.stage.values?.length || 0} stages)` : "No");
        console.log("- PWD data:", aggregated.pwd ? "Yes" : "No");
        console.log("- OFW data:", aggregated.ofw ? "Yes" : "No");
        console.log("- Additional Info data:", aggregated.additional ? "Yes" : "No");
        console.log("- Assembly Area data:", aggregated.assembly ? "Yes" : "No");
        console.log("- Transport data:", aggregated.transport ? "Yes" : "No");
        console.log("- Disability Type data:", aggregated.disabilityType ? "Yes" : "No");
        
        // Update enhanced stats (with checkbox fixes)
        updateAllStats(aggregated);
        
        console.log("üé® Starting to create charts...");
        
        // 1. Barangay Entries Chart
        console.log("Creating Barangay chart...");
        if (aggregated.barangay && aggregated.barangay.labels && aggregated.barangay.labels.length > 0) {
            createBarChartFromAggregated('chartBarangay', aggregated.barangay);
        } else {
            console.warn("No barangay data available");
            createEmptyBarChart('chartBarangay', 'Entry per Barangay', 'No barangay data');
        }

        // 2. Age Distribution Chart - FIXED: Use consistent age calculation
        console.log("Creating Age Distribution chart...");
        
        // First, let's verify what data we have
        console.log("Age Groups Data:", aggregated.ageGroups);
        
        if (aggregated.ageGroups && aggregated.ageGroups.labels && aggregated.ageGroups.labels.length > 0) {
          
          // Filter out any empty or null categories
          const validIndices = [];
          for (let i = 0; i < aggregated.ageGroups.labels.length; i++) {
            const label = aggregated.ageGroups.labels[i];
            const total = aggregated.ageGroups.values[i] || 0;
            
            // Only include if label exists and has data
            if (label && label.trim() !== "" && total > 0) {
              validIndices.push(i);
            }
          }
          
          if (validIndices.length > 0) {
            // Extract valid data
            const ageLabels = validIndices.map(i => aggregated.ageGroups.labels[i]);
            const ageHeadsData = validIndices.map(i => (aggregated.ageGroups.heads || [])[i] || 0);
            const ageMembersData = validIndices.map(i => (aggregated.ageGroups.members || [])[i] || 0);
            const ageTotals = validIndices.map(i => aggregated.ageGroups.values[i]);
            
            console.log("Filtered Age Data:", {
              labels: ageLabels,
              heads: ageHeadsData,
              members: ageMembersData,
              totals: ageTotals
            });
            
            // Create the chart
            const ageDatasets = [
              {
                label: 'Heads',
                data: ageHeadsData,
                backgroundColor: 'rgba(52, 183, 143, 0.8)',
                borderColor: 'rgba(52, 183, 143, 1)',
                borderWidth: 1
              },
              {
                label: 'Members',
                data: ageMembersData,
                backgroundColor: 'rgba(70, 140, 240, 0.8)',
                borderColor: 'rgba(70, 140, 240, 1)',
                borderWidth: 1
              }
            ];
            
            createBarChart('chartAgeGroup', ageLabels, null, 'Age Distribution', null, true, ageDatasets);
            
          } else {
            console.warn("No valid age data after filtering");
            createEmptyBarChart('chartAgeGroup', 'Age Distribution', 'No age data available');
          }
          
        } else {
          console.warn("No age data available in aggregated data");
          createEmptyBarChart('chartAgeGroup', 'Age Distribution', 'No age data available');
        }

        // 3. Stage Distribution Chart
        console.log("Creating Stage Distribution chart...");
        if (aggregated.stage && aggregated.stage.values && aggregated.stage.values.some(v => v > 0)) {
            createDoughnutChart('chartStage', aggregated.stage.labels, aggregated.stage.values, 'Stage Distribution');
        } else {
            console.warn("No stage data available (0 stages)");
            createEmptyDoughnutChart('chartStage', 'Stage Distribution', 'No stage data');
        }

        // 4. PWD Distribution Chart
        console.log("Creating PWD Distribution chart...");
        if (aggregated.pwd && (aggregated.pwd.headsYes > 0 || aggregated.pwd.headsNo > 0 || aggregated.pwd.membersYes > 0 || aggregated.pwd.membersNo > 0)) {
            createPWDChart(aggregated.pwd);
        } else {
            console.warn("No PWD data available");
            createEmptyBarChart('chartPWD', 'PWD Distribution', 'No PWD data');
        }

        // 5. Status Distribution Chart
        console.log("Creating Status Distribution chart...");
        if (aggregated.status && aggregated.status.heads && aggregated.status.heads.values.some(v => v > 0)) {
            createStatusChart(aggregated.status);
        } else {
            console.warn("No status data available");
            createEmptyBarChart('chartStatus', 'Status Distribution', 'No status data');
        }

        // 6. Government Support Chart - CHECKBOX DATA
        console.log("Creating Government Support chart...");
        if (aggregated.support && aggregated.support.heads && aggregated.support.heads.some(v => v > 0)) {
            createSupportChart(aggregated.support);
        } else {
            console.warn("No support data available");
            createEmptyBarChart('chartSupport', 'Government Support', 'No support data');
        }

        // 7. Registration Status Chart
        console.log("Creating Registration Status chart...");
        if (aggregated.registration && aggregated.registration.heads && aggregated.registration.heads.some(v => v > 0)) {
            createRegistrationChart(aggregated.registration);
        } else {
            console.warn("No registration data available");
            createEmptyBarChart('chartRegistration', 'Registration Status', 'No registration data');
        }

        // 8. NEW: Additional Information Chart - CHECKBOX DATA
        console.log("Creating Additional Information chart...");
        if (aggregated.additional && aggregated.additional.heads && aggregated.additional.heads.some(v => v > 0)) {
            createAdditionalChart(aggregated.additional);
        } else {
            console.warn("No additional information data available");
            createEmptyBarChart('chartAdditional', 'Additional Information', 'No data');
        }

        // 9. NEW: Assembly Area Chart - CHECKBOX DATA
        console.log("Creating Assembly Area chart...");
        if (aggregated.assembly && aggregated.assembly.heads && aggregated.assembly.heads.some(v => v > 0)) {
            createAssemblyChart(aggregated.assembly);
        } else {
            console.warn("No assembly area data available");
            createEmptyBarChart('chartAssembly', 'Assembly Area Distribution', 'No data');
        }

        // 10. NEW: Transportation & Evacuation Chart - CHECKBOX DATA
        console.log("Creating Transportation & Evacuation chart...");
        if (aggregated.transport && aggregated.transport.heads && aggregated.transport.heads.some(v => v > 0)) {
            // Filter out "Other Reasons" from transportation data
            const filteredTransportData = {
                labels: [],
                heads: [],
                members: []
            };
            
            if (aggregated.transport.labels) {
                aggregated.transport.labels.forEach((label, index) => {
                    if (label.toLowerCase() !== "other reasons" && 
                        label.toLowerCase() !== "other" &&
                        !label.includes("Other")) {
                        filteredTransportData.labels.push(label);
                        filteredTransportData.heads.push(aggregated.transport.heads[index] || 0);
                        filteredTransportData.members.push(aggregated.transport.members[index] || 0);
                    }
                });
            }
            
            if (filteredTransportData.labels.length > 0 && 
                (filteredTransportData.heads.some(v => v > 0) || filteredTransportData.members.some(v => v > 0))) {
                createTransportChart(filteredTransportData);
            } else {
                console.warn("No transportation data available after filtering");
                createEmptyBarChart('chartTransport', 'Transportation & Evacuation', 'No data');
            }
        } else {
            console.warn("No transportation data available");
            createEmptyBarChart('chartTransport', 'Transportation & Evacuation', 'No data');
        }

// 11. NEW CHART: Type of Disability
console.log("Creating Type of Disability chart...");
console.log("üîç DEBUG - Disability type data check:", {
    exists: !!aggregated.disabilityType,
    hasLabels: aggregated.disabilityType && !!aggregated.disabilityType.labels,
    labelsLength: aggregated.disabilityType && aggregated.disabilityType.labels ? aggregated.disabilityType.labels.length : 0
});

// FIXED: Use aggregated.disabilityType, NOT disabilityTypeChartData
if (aggregated.disabilityType && 
    aggregated.disabilityType.labels && 
    aggregated.disabilityType.labels.length > 0 &&
    (aggregated.disabilityType.heads.some(v => v > 0) || aggregated.disabilityType.members.some(v => v > 0))) {
    
    console.log("‚úÖ Creating disability type chart with data:", {
        labels: aggregated.disabilityType.labels,
        heads: aggregated.disabilityType.heads,
        members: aggregated.disabilityType.members
    });
    
    createDisabilityTypeChart(aggregated.disabilityType);
} else {
    console.warn("No disability type data available");
    console.log("Disability type data structure:", aggregated.disabilityType);
    
    // Create an empty chart with a message
    createEmptyBarChart('chartDisabilityType', 'Type of Disability', 
                       aggregated.disabilityType ? 'No disability type data available' : 'Data not loaded');
}

        // 12. Livestock Chart - WITH DEBUGGING
        console.log("Creating Livestock chart...");
        console.log("üîç DEBUG - Livestock data:", aggregated.livestock);
        console.log("üîç DEBUG - Livestock labels:", aggregated.livestock?.labels);
        console.log("üîç DEBUG - Livestock values:", aggregated.livestock?.values);
        console.log("üîç DEBUG - Total animals:", aggregated.livestock?.values?.reduce((a, b) => a + b, 0));

        if (aggregated.livestock && aggregated.livestock.values && aggregated.livestock.values.some(v => v > 0)) {
            console.log(`‚úÖ Creating livestock chart with ${aggregated.livestock.values.length} animal types`);
            createBarChart('chartLivestock', aggregated.livestock.labels, aggregated.livestock.values, 
                          'Count', 'rgba(255, 122, 0, 0.8)');
        } else {
            console.warn("No livestock data available");
            createEmptyBarChart('chartLivestock', 'Domestic Livestock', 'No livestock data');
        }

        // 13. OFW Chart
        console.log("Creating OFW chart...");
        console.log("üîç DEBUG - Raw OFW data:", aggregated.ofw);
        
        if (aggregated.ofw && Object.values(aggregated.ofw).some(v => v > 0)) {
            createOFWChart(aggregated.ofw);
        } else {
            console.warn("No OFW data available");
            createEmptyDoughnutChart('chartOFW', 'Overseas Filipino Workers', 'No OFW data');
        }

        // 14. Education Chart
        console.log("Creating Education chart...");
        if (aggregated.education && aggregated.education.values && aggregated.education.values.some(v => v > 0)) {
            createBarChart('chartEducation', aggregated.education.labels, aggregated.education.values, 
                          'Count', 'rgba(123, 97, 255, 0.8)');
        } else {
            console.warn("No education data available");
            createEmptyBarChart('chartEducation', 'Educational Attainment', 'No education data');
        }

        // 15. Employment Chart - WITH EXTENSIVE DEBUGGING
        console.log("\n=== CREATING EMPLOYMENT CHART ===");
        console.log("üîç DEBUG - Full employment data object:", aggregated.employment);
        console.log("üîç DEBUG - Employment labels:", aggregated.employment?.labels);
        console.log("üîç DEBUG - Employment values:", aggregated.employment?.values);
        console.log("üîç DEBUG - Employment has values?", aggregated.employment?.values?.length > 0);
        console.log("üîç DEBUG - Employment values > 0?", aggregated.employment?.values?.some(v => v > 0));

        // Check if we have employment data
        if (aggregated.employment && aggregated.employment.labels && aggregated.employment.labels.length > 0) {
            console.log(`‚úÖ Employment data found: ${aggregated.employment.labels.length} categories`);
            
            // Log each category and count
            if (aggregated.employment.labels && aggregated.employment.values) {
                for (let i = 0; i < aggregated.employment.labels.length; i++) {
                    console.log(`   ${aggregated.employment.labels[i]}: ${aggregated.employment.values[i]}`);
                }
            }
            
            // Check if we have any actual values
            const totalEmployment = aggregated.employment.values.reduce((a, b) => a + b, 0);
            console.log(`‚úÖ Total employment records: ${totalEmployment}`);
            
            if (totalEmployment > 0) {
                createDoughnutChart('chartEmployment', aggregated.employment.labels, 
                                   aggregated.employment.values, 'Employment Status');
                console.log("‚úÖ Employment chart created successfully");
            } else {
                console.warn("‚ö†Ô∏è Employment data exists but all values are 0");
                console.log("Creating empty chart as fallback");
                createEmptyDoughnutChart('chartEmployment', 'Employment Status', 'No employment data found');
            }
        } else {
            console.warn("‚ö†Ô∏è No employment data available in aggregated data");
            console.log("Creating empty chart");
            createEmptyDoughnutChart('chartEmployment', 'Employment Status', 'No employment data');
        }

        // 16. Comparison Chart
        console.log("Creating Comparison chart...");
        if (aggregated.comparison && aggregated.comparison.labels && aggregated.comparison.labels.length > 0) {
            createComparisonChartFromAggregated(aggregated.comparison);
        } else {
            console.warn("No comparison data available");
            createEmptyComparisonChart();
        }
        
        // Performance monitoring end
        let performanceEnd = Date.now();
        let totalTime = (performanceEnd - performanceStart) / 1000;
        console.log(`‚è±Ô∏è Total chart rendering time: ${totalTime.toFixed(2)} seconds`);
        
        // Show performance info in console
        if (totalTime < 3) {
            console.log(`üöÄ Excellent! Charts loaded in ${totalTime.toFixed(2)} seconds`);
        } else if (totalTime < 5) {
            console.log(`üëç Good! Charts loaded in ${totalTime.toFixed(2)} seconds`);
        } else {
            console.log(`‚ö†Ô∏è Charts took ${totalTime.toFixed(2)} seconds to load`);
        }
        
        console.log("‚úÖ All charts created successfully");
        
        // DEBUG: Check if charts are visible
        setTimeout(() => {
            console.log("üîç Checking if charts are visible...");
            const chartIds = ['chartBarangay', 'chartAgeGroup', 'chartStage', 'chartPWD', 'chartOFW', 'chartAdditional', 'chartAssembly', 'chartTransport', 'chartDisabilityType'];
            chartIds.forEach(id => {
                const canvas = document.getElementById(id);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    console.log(`${id}: canvas exists, context:`, ctx ? "Yes" : "No");
                } else {
                    console.log(`${id}: canvas NOT FOUND`);
                }
            });
        }, 1000);
        
    } catch (err) {
        console.error("Error building charts:", err);
        showError("Unable to load charts: " + err.message);
        
        // Fallback to original method if aggregation fails
        console.log("üîÑ Falling back to original chart building method...");
        await buildChartsOriginal();
    } finally {
        showLoading(false);
    }
}

/* ============ FETCH AGGREGATED DATA WITH CACHING ============ */
async function fetchAggregatedChartData(forceRefresh = false) {
    // Cache configuration
    const CHART_DATA_CACHE_KEY = 'chartDataCache';
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
    
    try {
        console.log("üîç Checking for cached chart data...");
        
        // üî• CHECK: If forceRefresh is true, skip cache entirely
        if (!forceRefresh) {
            const cached = sessionStorage.getItem(CHART_DATA_CACHE_KEY);
            if (cached) {
                try {
                    const { data, timestamp } = JSON.parse(cached);
                    const age = Date.now() - timestamp;
                    
                    if (age < CACHE_DURATION) {
                        console.log(`üì¶ Using cached data (${Math.round(age/1000)}s old)`);
                        return data;
                    } else {
                        console.log(`üîÑ Cache expired (${Math.round(age/1000)}s old, limit: ${CACHE_DURATION/1000}s)`);
                    }
                } catch (cacheError) {
                    console.warn("‚ö†Ô∏è Cache corrupted, fetching fresh data", cacheError);
                }
            }
        } else {
            console.log("üîÑ Force refresh requested - bypassing cache");
            // Clear cache when forcing refresh
            sessionStorage.removeItem(CHART_DATA_CACHE_KEY);
        }
        
        console.log("üåê Fetching fresh data from API...");
        const url = API_URL + "?action=chartData&t=" + Date.now() + "&nocache=" + Math.random(); // üî• Add random number
        console.log("Fetching from:", url);
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const startTime = Date.now();
        const res = await fetch(url, {
            cache: "no-store",
            signal: controller.signal
        });
        const fetchTime = Date.now() - startTime;
        
        clearTimeout(timeoutId);
        
        if (!res.ok) {
            // If fetch fails but we have cached data, use it even if expired
            if (!forceRefresh) {
                const cached = sessionStorage.getItem(CHART_DATA_CACHE_KEY);
                if (cached) {
                    console.warn("‚ö†Ô∏è Network error, using expired cache as fallback");
                    const { data } = JSON.parse(cached);
                    showError("Using cached data. Network issue detected.");
                    return data;
                }
            }
            throw new Error("Network error " + res.status);
        }
        
        const data = await res.json();
        console.log(`‚úÖ Fresh data fetched in ${fetchTime}ms`);
        
        // Store in cache
        const cacheData = {
            data: data,
            timestamp: Date.now(),
            fetchTime: fetchTime
        };
        
        try {
            sessionStorage.setItem(CHART_DATA_CACHE_KEY, JSON.stringify(cacheData));
            console.log("üíæ Data cached successfully");
        } catch (storageError) {
            console.warn("‚ö†Ô∏è Could not cache data (storage might be full):", storageError);
        }
        
        return data;
        
    } catch(err) {
        if (err.name === 'AbortError') {
            // Try to use cached data on timeout
            if (!forceRefresh) {
                const cached = sessionStorage.getItem(CHART_DATA_CACHE_KEY);
                if (cached) {
                    console.warn("‚è∞ Timeout - using cached data");
                    const { data } = JSON.parse(cached);
                    showError("Server timeout. Showing cached data from last successful load.");
                    return data;
                }
            }
            showError("Request timeout and no cached data available. Please try again.");
        } else {
            console.error("Fetch error:", err);
            showError("Failed to fetch data: " + err.message);
        }
        throw err;
    }
}

/* ============ HELPER FUNCTIONS FOR AGGREGATED DATA ============ */
function createBarChartFromAggregated(chartId, data) {
    // FAST FIX: Quick cleanup
    quickCleanCanvas(chartId);
    
    const datasets = [
        {
            label: 'Heads',
            data: data.heads,
            backgroundColor: 'rgba(52, 183, 143, 0.8)',
            borderColor: 'rgba(52, 183, 143, 1)',
            borderWidth: 1
        },
        {
            label: 'Members',
            data: data.members,
            backgroundColor: 'rgba(70, 140, 240, 0.8)',
            borderColor: 'rgba(70, 140, 240, 1)',
            borderWidth: 1
        }
    ];
    
    createBarChart(chartId, data.labels, null, 'Households', null, true, datasets);
}

function createPWDChart(pwdData) {
    const pwdLabels = ['PWD Distribution'];
    const pwdDatasets = [
        {
            label: 'Heads - PWD',
            data: [pwdData.headsYes],
            backgroundColor: 'rgba(255, 205, 86, 0.8)',
            borderColor: 'rgba(255, 205, 86, 1)',
            borderWidth: 1
        },
        {
            label: 'Heads - Non-PWD',
            data: [pwdData.headsNo],
            backgroundColor: 'rgba(255, 205, 86, 0.4)',
            borderColor: 'rgba(255, 205, 86, 0.7)',
            borderWidth: 1
        },
        {
            label: 'Members - PWD',
            data: [pwdData.membersYes],
            backgroundColor: 'rgba(54, 162, 235, 0.8)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        },
        {
            label: 'Members - Non-PWD',
            data: [pwdData.membersNo],
            backgroundColor: 'rgba(54, 162, 235, 0.4)',
            borderColor: 'rgba(54, 162, 235, 0.7)',
            borderWidth: 1
        }
    ];
    
    createBarChart('chartPWD', pwdLabels, null, 'PWD Status', null, true, pwdDatasets);
}

function createStatusChart(statusData) {
    const statusDatasets = [
        {
            label: 'Heads',
            data: statusData.heads.values,
            backgroundColor: 'rgba(75, 192, 192, 0.8)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        },
        {
            label: 'Members',
            data: statusData.members.values,
            backgroundColor: 'rgba(153, 102, 255, 0.8)',
            borderColor: 'rgba(153, 102, 255, 1)',
            borderWidth: 1
        }
    ];
    
    createBarChart('chartStatus', statusData.heads.labels, null, 'Status Distribution', null, true, statusDatasets);
}

function createSupportChart(supportData) {
    const supportDatasets = [
        {
            label: 'Heads',
            data: supportData.heads,
            backgroundColor: 'rgba(201, 203, 207, 0.8)',
            borderColor: 'rgba(201, 203, 207, 1)',
            borderWidth: 1
        },
        {
            label: 'Members',
            data: supportData.members,
            backgroundColor: 'rgba(255, 87, 87, 0.8)',
            borderColor: 'rgba(255, 87, 87, 1)',
            borderWidth: 1
        }
    ];
    
    createBarChart('chartSupport', supportData.labels, null, 'Government Support', null, true, supportDatasets);
}

function createRegistrationChart(regData) {
    const regDatasets = [
        {
            label: 'Heads',
            data: regData.heads,
            backgroundColor: 'rgba(255, 99, 132, 0.8)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
        },
        {
            label: 'Members',
            data: regData.members,
            backgroundColor: 'rgba(255, 159, 64, 0.8)',
            borderColor: 'rgba(255, 159, 64, 1)',
            borderWidth: 1
        }
    ];
    
    createBarChart('chartRegistration', regData.labels, null, 'Registration Status', null, true, regDatasets);
}

/* ---------------------- CREATE OFW CHART ---------------------- */
function createOFWChart(data) {
  try {
    const chartId = 'chartOFW';
    const ctx = document.getElementById(chartId);
    
    if (!ctx) {
      console.error(`Canvas element not found: ${chartId}`);
      return;
    }
    
    // Destroy existing chart if it exists
    quickCleanCanvas(chartId);
    if (window[chartId + 'Chart']) {
      try { window[chartId + 'Chart'].destroy(); } catch(e) {}
      window[chartId + 'Chart'] = null;
    }
    
    // Check if we have OFW data
    console.log("üîç OFW Data received:", data);
    
    if (!data || typeof data !== 'object' || Object.keys(data).length === 0) {
      console.warn("No OFW data available");
      return createEmptyDoughnutChart(chartId, 'OFW Distribution', 'No OFW data available');
    }
    
    // Process OFW data - ensure we have the right structure
    let labels, values;
    
    // Check different possible data structures
    if (data.labels && data.values) {
      // Structure: {labels: [...], values: [...]}
      labels = data.labels;
      values = data.values;
    } else if (data.ofw && typeof data.ofw === 'object') {
      // Structure: {ofw: {"OFW (Yes)": 1, "Non-OFW (No)": 2, ...}}
      labels = Object.keys(data.ofw);
      values = Object.values(data.ofw);
    } else {
      // Direct object structure: {"OFW (Yes)": 1, "Non-OFW (No)": 2, ...}
      labels = Object.keys(data);
      values = Object.values(data);
    }
    
    const total = values.reduce((sum, val) => sum + val, 0);
    
    console.log(`üìä OFW Chart Data: Labels: ${labels}, Values: ${values}, Total: ${total}`);
    
    // If all values are 0, show empty chart
    if (total === 0) {
      console.warn("OFW data totals to zero");
      return createEmptyDoughnutChart(chartId, 'OFW Distribution', 'No OFW records');
    }
    
    // Filter out zero-value entries for cleaner display
    const nonZeroIndices = values.map((val, idx) => val > 0 ? idx : -1).filter(idx => idx !== -1);
    const filteredLabels = nonZeroIndices.map(idx => labels[idx]);
    const filteredValues = nonZeroIndices.map(idx => values[idx]);
    
    // Create chart
    const chart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: filteredLabels.length > 0 ? filteredLabels : labels,
        datasets: [{
          data: filteredValues.length > 0 ? filteredValues : values,
          backgroundColor: [
            '#4CAF50', // Green for "OFW (Yes)"
            '#2196F3', // Blue for "Non-OFW (No)"
            '#9E9E9E', // Gray for "Not Specified"
            '#FF9800', // Orange for other categories
            '#9C27B0', // Purple
            '#FF5722'  // Deep Orange
          ].slice(0, filteredLabels.length || labels.length),
          borderColor: '#ffffff',
          borderWidth: 2,
          hoverOffset: 15
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        },
        plugins: {
          legend: {
            position: 'bottom',
            align: 'center',
            labels: {
              padding: 15,
              font: { size: 11 },
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleFont: { size: 12 },
            bodyFont: { size: 12 },
            padding: 10,
            cornerRadius: 6,
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw || 0;
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        },
        cutout: '60%'
      }
    });
    
    // Store reference to chart
    CH[chartId] = chart;
    window[chartId + 'Chart'] = chart;
    return chart;
    
  } catch (error) {
    console.error('Error creating OFW chart:', error);
    return null;
  }
}

function createComparisonChartFromAggregated(comparisonData) {
    if (comparisonData.labels.length > 0 && comparisonData.datasets.length > 0) {
        createComparisonChart(comparisonData.labels, comparisonData.datasets);
    } else {
        createEmptyComparisonChart();
    }
}

/* ============ FALLBACK TO ORIGINAL METHOD ============ */
async function buildChartsOriginal() {
    showLoading(true);
    
    cleanupAllChartsFast();

    // Destroy existing charts first
    Object.keys(CH).forEach(key => {
        if (CH[key] && typeof CH[key].destroy === 'function') {
            try {
                CH[key].destroy();
            } catch (e) {
                console.warn(`Could not destroy chart ${key}:`, e);
            }
        }
    });
    
    // Clear CH object
    Object.keys(CH).forEach(key => delete CH[key]);
    
    try {
        const rawRows = await fetchChartData();
        const norm = rawRows.map(normalizeRow);
        
        // Calculate totals for heads and members
        let totalHeads = 0;
        let totalMembers = 0;
        norm.forEach(n => {
            if (n.isHead) {
                totalHeads++;
            } else {
                totalMembers++;
            }
        });
        const totalCombined = totalHeads + totalMembers;

        // Update enhanced stats
        if (window.aggregatedData) {
            updateAllStats(window.aggregatedData);
        }
        
        // ... rest of your original buildChartsOriginal function ...
        // Note: You would need to copy the rest of your original function here
        // Since it's quite long, I'm omitting it for brevity
        
    } catch (err) {
        console.error("Error building charts:", err);
        showError("Unable to load charts: " + err.message);
    } finally {
        showLoading(false);
    }
}

/* ============ EXPORT FUNCTIONS ============ */
async function exportToPDF() {
    try {
        // Close export dropdown after selection
        document.getElementById('exportDropdown').classList.remove('show');
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('landscape', 'mm', 'a4');
        
        const chartIds = [
            'chartBarangay', 'chartAgeGroup', 'chartStage',
            'chartPWD', 'chartStatus', 'chartSupport',
            'chartRegistration', 'chartAdditional', 'chartAssembly',
            'chartTransport', 'chartDisabilityType', 'chartLivestock', 'chartOFW', 
            'chartEducation', 'chartEmployment', 'chartComparison'
        ];
        
        let page = 0;
        for (const id of chartIds) {
            const canvas = document.getElementById(id);
            if (!canvas) continue;
            
            // Create a white background canvas
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            
            // Fill with white background
            tempCtx.fillStyle = '#ffffff';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // Draw the chart
            tempCtx.drawImage(canvas, 0, 0);
            
            const imgData = tempCanvas.toDataURL('image/jpeg', 1.0);
            const imgWidth = 280;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            if (page > 0) pdf.addPage();
            
            // Add title
            pdf.setFontSize(16);
            pdf.setTextColor(15, 122, 74);
            pdf.text('Purok Kaligtasan - Charts Report', 10, 15);
            
            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);
            pdf.text(new Date().toLocaleDateString(), 270, 15);
            
            // Add chart
            pdf.addImage(imgData, 'JPEG', 10, 25, imgWidth, imgHeight);
            
            page++;
        }
        
        pdf.save(`Charts_Report_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`);
    } catch(err) {
        console.error("PDF export failed:", err);
        showError("PDF export failed: " + err.message);
    }
}

async function exportPNGsZip() {
    try {
        // Close export dropdown after selection
        document.getElementById('exportDropdown').classList.remove('show');
        
        const zip = new JSZip();
        const chartIds = [
            'chartBarangay', 'chartAgeGroup', 'chartStage',
            'chartPWD', 'chartStatus', 'chartSupport',
            'chartRegistration', 'chartAdditional', 'chartAssembly',
            'chartTransport', 'chartDisabilityType', 'chartLivestock', 'chartOFW', 
            'chartEducation', 'chartEmployment', 'chartComparison'
        ];
        
        for(const id of chartIds) {
            const canvas = document.getElementById(id);
            if(!canvas) continue;
            
            // Create a white background canvas
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            
            // Fill with white background
            tempCtx.fillStyle = '#ffffff';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // Draw the chart
            tempCtx.drawImage(canvas, 0, 0);
            
            const blob = await new Promise(res => tempCanvas.toBlob(res, 'image/png', 1.0));
            if(blob) zip.file(`${id}.png`, blob);
        }
        
        const content = await zip.generateAsync({type:'blob'});
        saveAs(content, `Charts_PNGs_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`);
    } catch(err) {
        console.error("PNG ZIP failed:", err);
        showError("PNG ZIP failed: " + err.message);
    }
}

async function exportCSV_AllRows() {
    try {
        // Close export dropdown after selection
        document.getElementById('exportDropdown').classList.remove('show');
        
        const raw = await fetchChartData();
        if(!Array.isArray(raw) || raw.length === 0){
            showError("No data to export");
            return;
        }
        
        const keys = new Set();
        raw.forEach(r => Object.keys(r).forEach(k => keys.add(k)));
        const header = Array.from(keys);
        const rows = raw.map(r => header.map(h => {
            const v = r[h];
            if (v === null || v === undefined) return '';
            return typeof v === 'string' ? v.replace(/"/g,'""') : String(v);
        }));
        
        let csv = '"' + header.join('","') + '"\n';
        rows.forEach(r => csv += '"' + r.join('","') + '"\n');

        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        saveAs(blob, `All_Rows_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`);
    } catch(err) {
        console.error("CSV export failed", err);
        showError("CSV export failed: " + err.message);
    }
}

/* ============ AUTO REFRESH ============ */
function startAutoRefresh() {
    if(refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(() => {
        buildCharts(true); // üî• Add true to force refresh on auto-refresh too
    }, AUTO_REFRESH_MS);
    
    // Update indicator
    const indicator = document.querySelector('.auto-refresh span:last-child');
    if (indicator) {
        indicator.textContent = 'Auto-refresh: 60s';
    }
}

function stopAutoRefresh() {
    if(refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

/* ============ SIDEBAR TOGGLE ============ */
function toggleSidebar() {
    const pageContainer = document.querySelector('.page-container');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const icon = sidebarToggle.querySelector('i');
    
    pageContainer.classList.toggle('collapsed');
    
    if (pageContainer.classList.contains('collapsed')) {
        icon.className = 'fas fa-chevron-right';
        sidebarToggle.title = "Expand sidebar";
    } else {
        icon.className = 'fas fa-bars';
        sidebarToggle.title = "Collapse sidebar";
    }
}

/* ============ EVENT LISTENERS ============ */
document.addEventListener('DOMContentLoaded', async function() {
    // Session check
    const isAuthenticated = await sessionCheck();
    
    if (isAuthenticated) {
        // Set user info
        const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
        document.getElementById("userName").innerText = userName;
        
        // Check admin status
        const isAdmin = localStorage.getItem("userRole") === "admin";
        const adminItems = document.querySelectorAll(".admin-only");
        adminItems.forEach(item => {
            item.classList.toggle("admin-visible", isAdmin);
        });
        
        // Handle mobile nav for admin
        const mobileUsersNav = document.getElementById('mobileUsersNav');
        if (mobileUsersNav) {
            mobileUsersNav.style.display = isAdmin ? 'flex' : 'none';
        }
        
        // Initialize Stats Manager
        StatsManager.init();
        
        // Initialize charts
        await buildCharts();
        startAutoRefresh();
        
        // Bind event listeners
        document.getElementById('btnPrint').addEventListener('click', () => {
            window.print();
        });
        
        // Export dropdown functionality
        const exportBtn = document.getElementById('exportBtn');
        const exportDropdown = document.getElementById('exportDropdown');
        
        if (exportBtn && exportDropdown) {
            exportBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                exportDropdown.classList.toggle('show');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!exportBtn.contains(e.target) && !exportDropdown.contains(e.target)) {
                    exportDropdown.classList.remove('show');
                }
            });
        }
        
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
        
        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // Rebuild charts on resize for better fit
                Object.keys(CH).forEach(key => {
                    if (CH[key] && CH[key].resize) {
                        try {
                            CH[key].resize();
                        } catch(e) {
                            console.warn('Could not resize chart:', key, e);
                        }
                    }
                });
            }, 250);
        });
        
        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                buildCharts();
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });
    }
});

// Handle page show event
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        sessionCheck().then(isAuthenticated => {
            if (isAuthenticated) {
                buildCharts();
                startAutoRefresh();
            }
        });
    }
});

// Handle page hide to stop intervals
window.addEventListener('pagehide', function() {
    stopAutoRefresh();
});

// Handle beforeunload
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>
<script src="js/data-broadcaster.js"></script>
<script src="js/form-notifier.js"></script>
<script src="js/common-utils.js"></script>
<script src="js/session-manager.js"></script>
<script src="js/common-session.js"></script>
<script src="js/activity-tracking-final.js"></script>
</body>
</html>

