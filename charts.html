<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Charts & Analytics ‚Äî Purok Kaligtasan</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
   :root{
    --bg:#f6f8f7;
    --card-bg:#fff;
    --muted:#6b6f6b;
    --accent1:#0f7a4a;
    --accent2:#34b78f;
    --accent3: #ff7a00;
    --accent4: #ffa500;
    --light-green: #e9f7f2;
    --border: #e1e8e5;
    --shadow: 0 6px 18px rgba(6,30,20,0.06);
    --shadow-dark: 0 6px 20px rgba(5,40,25,0.12);
    --radius:12px;
    --radius-sm:8px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
   }
   .admin-only {
    display: none !important;
}

/* Class to show admin elements - applied by JavaScript */
.admin-only.admin-visible {
    display: block !important;
}

/* For list items */
li.admin-only {
    display: none !important;
}

li.admin-only.admin-visible {
    display: list-item !important;
}
   /* Description Styling */
   #disc {
    margin-bottom: 10px;
    background: var(--light-green);
    padding: 12px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--accent1);
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.5;
   }
   
   body {
    background-color: var(--bg);
    margin: 0;
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-text-size-adjust: 100%;
    padding-bottom: 70px; /* Space for fixed bottom nav */
   }

   .page-container{
    max-width:1200px;
    margin:20px auto;
    padding:12px;
    display:grid;
    grid-template-columns:260px 1fr;
    gap:18px;
    align-items:start;
    transition: grid-template-columns 0.3s ease;
   }

   .page-container.collapsed {
    grid-template-columns: 60px 1fr;
   }

   /* Topbar - Enhanced */
   .topbar{
    grid-column:1/-1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
    border-radius:var(--radius);
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    box-shadow:var(--shadow-dark);
   }

   .brand{
    display:flex;
    gap:12px;
    align-items:center;
   }

   .brand .logo{
    width:60px;
    height:60px;
    border-radius:var(--radius-sm);
    object-fit:contain;
   }

   .brand-text h1 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
   }

   .brand-text p {
    font-size:12px;
    opacity:0.95;
    margin: 4px 0 0 0;
   }

   .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
   }

   #userName {
    font-weight: 600;
    border-radius: 20px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
   }

   #logoutBtn {
    background: rgba(255,255,255,0.25);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
   }

   #logoutBtn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
   }

   /* Sidebar - Collapsible */
   .sidebar{
    background:linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.20));
    border-radius:var(--radius);
    padding:12px;
    height:calc(100vh - 120px);
    position:sticky;
    top:72px;
    overflow:auto;
    transition: width 0.3s ease;
    z-index: 100;
   }

   .sidebar-container {
    display: flex;
    flex-direction: column;
    height: 100%;
   }

   .sidebar-toggle {
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.3s ease;
   }

   .sidebar-toggle:hover {
    transform: scale(1.1);
   }

   .sidebar ul{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
    flex: 1;
   }

   .sidebar li a{
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    text-decoration: none;
    color: var(--muted);
    border-radius: var(--radius-sm);
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
   }

   .sidebar li a:hover{
    background: var(--light-green);
    color: var(--accent1);
   }

   .sidebar li a.active{
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .sidebar li a .menu-icon {
    font-size: 1.2rem;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
   }

   .sidebar li a .menu-text {
    transition: opacity 0.3s ease;
   }

   .page-container.collapsed .sidebar li a .menu-text {
    opacity: 0;
    width: 0;
    overflow: hidden;
   }

   /* REMOVED: Mobile Logout Button in Sidebar */
   .mobile-logout-container {
    display: none !important; /* Remove logout button from sidebar */
   }

   /* Content Area */
   .content-area{
    background:linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
    border-radius:var(--radius);
    padding:18px;
    box-shadow:0 8px 22px rgba(10,20,16,0.06);
    min-height:72vh;
    height: calc(100vh - 120px);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
   }

   /* Content Header */
   .content-header {
    margin-top: 0;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
   }

   .content-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: var(--accent1);
    display: flex;
    align-items: center;
    gap: 8px;
   }

   /* Toolbar - FIXED: All buttons on the right side */
   .toolbar {
    display: flex;
    justify-content: flex-end; /* Align everything to the right */
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 10px;
   }

   /* REMOVE toolbar-left since all buttons are on the right */
   .toolbar-left {
    display: none; /* Hide left container */
   }

   /* RIGHT-ALIGNED BUTTONS GROUP - All buttons here */
   .toolbar-right {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end; /* Ensure alignment to right */
    width: 100%; /* Take full width */
   }

   .btn {
    border:0;
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    cursor:pointer;
    font-weight:600;
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    white-space: nowrap;
    height: 36px;
    box-sizing: border-box;
   }

   .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .btn-print {
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
   }

   .btn-export {
    background: linear-gradient(90deg, var(--accent3), var(--accent4));
   }

   .btn-export:hover {
    box-shadow: 0 4px 8px rgba(255,122,0,0.2);
   }
   
   /* Export dropdown - From records.html */
   .export-wrapper {
    position: relative;
   }

   .export-dropdown {
    font-size: 0.8rem;
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 8px;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    width: 140px;
    box-shadow: var(--shadow);
    z-index: 9999;
    overflow: hidden;
    display: none;
   }

   .export-dropdown.show {
    display: block;
   }

   .export-dropdown div {
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
   }

   .export-dropdown div:hover {
    background: #e9fff0;
    color: var(--accent1);
   }

   .export-dropdown div i {
    width: 14px;
    text-align: center;
    font-size: 0.85rem;
   }

   /* Charts Grid - Redesigned */
   .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 10px;
   }

   .chart-card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
    overflow: hidden;
   }

   .chart-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 28px rgba(6,30,20,0.12);
   }

   .chart-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    border-radius: var(--radius) var(--radius) 0 0;
   }

   .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
   }

   .chart-title {
    font-size: 1rem;
    font-weight: 700;
    color: var(--accent1);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
   }

   .chart-title i {
    color: var(--accent2);
   }

   .chart-stats {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
   }

   .stat-badge {
    background: var(--light-green);
    color: var(--accent1);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
   }

   .chart-container {
    position: relative;
    width: 100%;
    height: 250px;
    margin: 10px 0;
   }

   /* Special size for specific charts - SAME AS COMPARISON CHART */
   .chart-card.full-size {
    grid-column: 1 / -1;
    min-height: 400px;
   }
   
   .full-size .chart-container {
    height: 320px;
   }

   canvas {
    width: 100% !important;
    height: 100% !important;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
   }

   /* Special styling for PWD gauge */
   .pwd-gauge-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 30px;
    height: 100%;
   }

   .pwd-canvas-wrapper {
    flex: 1;
    position: relative;
    height: 200px;
   }

   .pwd-stats {
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-width: 120px;
   }

   .pwd-stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    border-radius: var(--radius-sm);
    background: var(--light-green);
   }

   .pwd-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent1);
   }

   .pwd-stat-label {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 4px;
   }

   /* Comparison Chart - Full Width */
   .comparison-chart {
    grid-column: 1 / -1;
    min-height: 400px;
   }

   .comparison-chart .chart-container {
    height: 320px;
   }

   /* Loading overlay */
   #loading {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(255,255,255,0.85);
    align-items:center;
    justify-content:center;
    z-index:9999;
    backdrop-filter: blur(2px);
   }

   .loading-content {
    background:#fff;
    padding:20px 24px;
    border-radius:var(--radius);
    box-shadow:var(--shadow-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
   }

   .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent1);
    border-radius: 50%;
    animation: spin 1s linear infinite;
   }

   @keyframes spin {
    to { transform: rotate(360deg); }
   }

   /* Auto-refresh indicator */
   .auto-refresh {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    color: var(--muted);
    padding: 8px 12px;
    background: rgba(15,122,74,0.05);
    border-radius: var(--radius-sm);
   }

   .auto-refresh .indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #34a853;
    animation: pulse 2s infinite;
   }

   @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
   }

   /* Error message */
   .error-message {
    display: none;
    background: #fee;
    color: #c00;
    padding: 10px 15px;
    border-radius: var(--radius-sm);
    margin-bottom: 15px;
    border-left: 4px solid #c00;
    font-size: 0.9rem;
   }

   .error-message.show {
    display: block;
   }

   /* Mobile Bottom Navigation - Fixed Position - UPDATED: REMOVED LOGOUT */
   .mobile-bottom-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid var(--border);
    z-index: 1000;
    padding: 8px 0;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
    height: 70px;
    box-sizing: border-box;
    overflow: hidden;
   }

   .mobile-nav-items {
    display: flex;
    justify-content: space-around;
    align-items: center;
    height: 100%;
   }

.mobile-nav-item {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    text-decoration: none !important;
    color: var(--muted) !important;
    padding: 8px 12px !important;
    border-radius: var(--radius-sm) !important;
    transition: all 0.3s ease !important;
    min-width: 60px !important;
    flex: 1 !important;
    height: 100% !important;
    justify-content: center !important;
}

/* Admin items - initially hidden */
.mobile-nav-item.admin-only {
    display: none !important;
}

/* Show admin items when user is admin */
.mobile-nav-item.admin-only.admin-visible {
    display: flex !important;
}

/* Active state for all tabs */
.mobile-nav-item.active {
    color: var(--accent1) !important;
    background: var(--light-green) !important;
}

/* REMOVED: Logout button styling - no longer needed */

/* Icon and text for all tabs */
.mobile-nav-icon {
    font-size: 1.2rem !important;
    margin-bottom: 4px !important;
    display: block !important;
    text-align: center !important;
    width: 100% !important;
}

.mobile-nav-text {
    font-size: 0.7rem !important;
    font-weight: 500 !important;
    display: block !important;
    text-align: center !important;
    width: 100% !important;
}

   /* Mobile Styles - UPDATED for linear and centered buttons */
   @media (max-width: 768px) {
    body {
        padding-bottom: 70px; /* Space for fixed bottom nav */
    }
    
    .page-container {
        grid-template-columns: 1fr !important;
        padding: 8px;
        gap: 12px;
        margin-bottom: 0; /* Remove margin since we have body padding */
    }
    
    .page-container.collapsed {
        grid-template-columns: 1fr !important;
    }
    
    .sidebar {
        display: none !important; /* Hide sidebar on mobile */
    }
    
    .mobile-bottom-nav {
        display: flex !important; /* Show bottom nav on mobile */
        flex-direction: column;
    }
    
    /* Remove mobile menu toggle button */
    .mobile-menu-toggle {
        display: none !important;
    }
    
    /* Show mobile logout button in sidebar when sidebar is forced to show */
    .mobile-logout-container {
        display: none !important; /* REMOVED: Hide logout in sidebar */
    }
    
    .content-area {
        height: auto;
        min-height: calc(100vh - 140px);
        padding: 12px;
        margin-bottom: 0;
    }
    
    /* UPDATED: Toolbar for mobile - linear and centered */
    .toolbar {
        flex-direction: column;
        align-items: stretch;
        padding: 10px;
        gap: 15px;
        justify-content: center; /* Center on mobile */
    }
    
    /* UPDATED: Right-aligned buttons become linear and centered on mobile */
    .toolbar-right {
        display: flex !important;
        flex-direction: row;
        width: 100%;
        justify-content: center; /* Center the buttons on mobile */
        gap: 10px;
        flex-wrap: wrap;
    }
    
    /* UPDATED: Ensure buttons are properly sized on mobile */
    .toolbar-right .btn {
        flex: 1; /* Make buttons take equal space */
        min-width: 100px; /* Minimum width */
        max-width: 120px; /* Maximum width */
        justify-content: center;
        text-align: center;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .chart-card {
        padding: 15px;
    }
    
    .chart-container {
        height: 220px;
    }
    
    .full-size .chart-container {
        height: 280px;
    }
    
    .comparison-chart .chart-container {
        height: 280px;
    }
    
    .pwd-gauge-container {
        flex-direction: column;
        gap: 20px;
    }
    
    .pwd-stats {
        flex-direction: row;
        justify-content: space-around;
        width: 100%;
    }
    
    .user-info {
        gap: 8px;
    }
    
    #userName {
        font-size: 0.9rem;
        padding: 6px 12px;
    }
    
    #logoutBtn {
        padding: 6px 12px;
        font-size: 0.85rem;
    }
    
    .btn {
        font-size: 0.8rem;
        padding: 6px 12px;
    }
    
    /* Optimize charts for mobile */
    .chart-card canvas {
        max-height: 200px;
    }
    
    /* Adjust content area for bottom nav */
    .content-area {
        margin-bottom: 70px;
    }
    
    /* Export dropdown positioning for mobile */
    .export-wrapper {
        width: auto;
        flex: 1;
        min-width: 100px;
        max-width: 120px;
    }
    
    .export-dropdown {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        width: 140px;
    }
   }

   /* Tablet Styles */
   @media (min-width: 769px) and (max-width: 1024px) {
    .page-container {
        max-width: 95%;
        grid-template-columns: 220px 1fr;
        gap: 15px;
        padding: 10px;
    }
    
    .content-area {
        padding: 15px;
    }
    
    .charts-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .comparison-chart,
    .chart-card.full-size {
        grid-column: 1 / -1;
    }
    
    .mobile-bottom-nav {
        display: none;
    }
   }

   /* Desktop Styles */
   @media (min-width: 1025px) {
    .mobile-bottom-nav {
        display: none;
    }
    
    .mobile-menu-toggle {
        display: none;
    }
   }

   /* Print styles - Fixed for no stretching */
   @media print {
    body * {
        visibility: hidden;
        background: white !important;
        color: black !important;
    }
    
    .content-area,
    .content-area * {
        visibility: visible;
        background: white !important;
        color: black !important;
        box-shadow: none !important;
    }
    
    .content-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100% !important;
        height: auto !important;
        padding: 20px !important;
        overflow: visible !important;
        page-break-before: always;
    }
    
    .page-container {
        display: block !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
    }
    
    .topbar,
    .sidebar,
    .toolbar,
    .mobile-bottom-nav,
    .mobile-menu-toggle {
        display: none !important;
    }
    
    .chart-card {
        page-break-inside: avoid;
        break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #ddd !important;
        margin-bottom: 20px;
        height: auto !important;
    }
    
    .charts-grid {
        display: block !important;
        grid-template-columns: 1fr !important;
    }
    
    .chart-container {
        height: 300px !important;
    }
    
    .full-size .chart-container {
        height: 400px !important;
    }
    
    .comparison-chart .chart-container {
        height: 400px !important;
    }
    
    /* Force white background for print */
    @page {
        margin: 20mm;
    }
    
    html, body {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
    }
   }
</style>
</head>
<body>
<div class="page-container">

  <header class="topbar">
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div class="brand-text">
        <h1>PUROK KALIGTASAN</h1>
        <p>DRRMO Alitagtag ‚Äì Household Records System</p>
      </div>
    </div>

    <div class="user-info">
      <!-- Hamburger menu removed for mobile -->
      <span id="userName"></span>
      <button id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>

  <!-- Error Message -->
  <div class="error-message" id="errorMessage">
    <i class="fas fa-exclamation-triangle"></i> 
    <span id="errorText">Failed to fetch data. Please check your connection.</span>
    <button onclick="document.getElementById('errorMessage').classList.remove('show')" style="float:right; background:none; border:none; color:#c00; cursor:pointer;">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-container">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul>
        <li><a href="dashboard.html" title="Dashboard"><span class="menu-icon">üìä</span> <span class="menu-text">Dashboard</span></a></li>
        <li><a href="dataForm.html" title="Data Entry"><span class="menu-icon">üìù</span> <span class="menu-text">Data Entry</span></a></li>
        <li><a href="records.html" title="Records"><span class="menu-icon">üìÅ</span> <span class="menu-text">Records & Management</span></a></li>
        <li><a href="charts.html" class="active" title="Charts"><span class="menu-icon">üìà</span> <span class="menu-text">Charts & Analytics</span></a></li>
        <li class="admin-only"><a href="users.html" title="User Management"><span class="menu-icon">üë•</span> <span class="menu-text">User Management</span></a></li>
      </ul>
      
      <!-- REMOVED: Mobile Logout Button in Sidebar -->
    </div>
  </aside>

  <main class="content-area">
    <div class="content-header">
      <h2><span style="color: var(--accent1);">üìà</span> Household Statistics & Trends</h2>
      <div class="auto-refresh">
        <span class="indicator"></span>
        <span>Auto-refresh: 60s</span>
      </div>
    </div>
    
    <div id="disc">This section provides visual analytics and insights from household data. Interactive charts help identify patterns, distributions, and trends across barangays, age groups, disabilities, and government support programs for better decision-making.</div>

    <!-- Toolbar - UPDATED: All buttons in toolbar-right -->
    <div class="toolbar">
      <div class="toolbar-right">
        <button id="btnRefresh" class="btn btn-refresh">
          <i class="fas fa-redo"></i> Refresh Charts
        </button>
        
        <button id="btnPrint" class="btn btn-print">
          <i class="fas fa-print"></i> Print
        </button>
        
        <!-- Export Dropdown Button (Similar to records.html) -->
        <div class="export-wrapper">
          <button id="exportBtn" class="btn btn-export">
            <i class="fas fa-file-export"></i> Export
          </button>
          <div id="exportDropdown" class="export-dropdown" role="menu" aria-hidden="true">
            <div onclick="exportToPDF()">
              <i class="fas fa-file-pdf"></i> Export PDF
            </div>
            <div onclick="exportPNGsZip()">
              <i class="fas fa-file-image"></i> Export PNGs
            </div>
            <div onclick="exportCSV_AllRows()">
              <i class="fas fa-file-csv"></i> Export CSV
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid" id="chartsContainer">
      <!-- Chart 1: Barangay Entries (FULL SIZE) -->
      <div class="chart-card full-size">
        <div class="chart-header">
          <h3 class="chart-title"><i class="fas fa-map-marker-alt"></i>Barangay Entries</h3>
          <div class="chart-stats">
            <span class="stat-badge" id="headsBarangay">Heads: 0</span>
            <span class="stat-badge" id="membersBarangay">Members: 0</span>
            <span class="stat-badge" id="totalBarangay">Total: 0</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartBarangay"></canvas>
        </div>
      </div>

      <!-- Chart 2: Age Groups -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title"><i class="fas fa-users"></i> Age Distribution</h3>
          <div class="chart-stats">
            <span class="stat-badge" id="headsAge">Heads: 0</span>
            <span class="stat-badge" id="membersAge">Members: 0</span>
            <span class="stat-badge" id="totalAge">Total: 0</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartAgeGroup"></canvas>
        </div>
      </div>

      <!-- Chart 3: Stage Distribution -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title"><i class="fas fa-layer-group"></i> Stage Distribution</h3>
          <div class="chart-stats">
            <span class="stat-badge" id="headsStage">Heads: 0</span>
            <span class="stat-badge" id="membersStage">Members: 0</span>
            <span class="stat-badge" id="totalStage">Total: 0</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartStage"></canvas>
        </div>
      </div>

      <!-- Chart 4: PWD Distribution (FULL SIZE) -->
      <div class="chart-card full-size">
        <div class="chart-header">
          <h3 class="chart-title"><i class="fas fa-wheelchair"></i> PWD Distribution</h3>
          <div class="chart-stats">
            <span class="stat-badge" id="headsPWD">Heads: 0</span>
            <span class="stat-badge" id="membersPWD">Members: 0</span>
            <span class="stat-badge" id="totalPWD">Total: 0</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartPWD"></canvas>
        </div>
      </div>

      <!-- Chart 5: Status Distribution (FULL SIZE) -->
      <div class="chart-card full-size">
        <div class="chart-header">
          <h3 class="chart-title"><i class="fas fa-chart-pie"></i> Status Distribution</h3>
          <div class="chart-stats">
            <span class="stat-badge" id="headsStatus">Heads: 0</span>
            <span class="stat-badge" id="membersStatus">Members: 0</span>
            <span class="stat-badge" id="totalStatus">Total: 0</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartStatus"></canvas>
        </div>
      </div>

      <!-- Chart 6: Government Support (FULL SIZE) -->
      <div class="chart-card full-size">
        <div class="chart-header">
          <h3 class="chart-title"><i class="fas fa-hand-holding-heart"></i> Government Support</h3>
          <div class="chart-stats">
            <span class="stat-badge" id="headsSupport">Heads: 0</span>
            <span class="stat-badge" id="membersSupport">Members: 0</span>
            <span class="stat-badge" id="totalSupport">Total: 0</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartSupport"></canvas>
        </div>
      </div>

      <!-- Chart 7: Registration Status (FULL SIZE) -->
      <div class="chart-card full-size">
        <div class="chart-header">
          <h3 class="chart-title"><i class="fas fa-id-card"></i> Registration Status</h3>
          <div class="chart-stats">
            <span class="stat-badge" id="headsRegistration">Heads: 0</span>
            <span class="stat-badge" id="membersRegistration">Members: 0</span>
            <span class="stat-badge" id="totalRegistration">Total: 0</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartRegistration"></canvas>
        </div>
      </div>

      <!-- Chart 8: Domestic Livestock -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title"><i class="fas fa-paw"></i> Domestic Livestock</h3>
          <div class="chart-stats">
            <span class="stat-badge" id="totalLivestock">Livestock: 0</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartLivestock"></canvas>
        </div>
      </div>

      <!-- Chart 9: Reason for Displacement -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title"><i class="fas fa-home"></i> Reason for Displacement</h3>
          <div class="chart-stats">
            <span class="stat-badge" id="totalDisplacement">Reasons: 0</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartDisplacement"></canvas>
        </div>
      </div>

      <!-- Chart 10: Overseas Filipino Worker (OFW) -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title"><i class="fas fa-passport"></i> Overseas Filipino Workers</h3>
          <div class="chart-stats">
            <span class="stat-badge" id="totalOFW">OFWs: 0</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartOFW"></canvas>
        </div>
      </div>

      <!-- Chart 11: Educational Attainment -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title"><i class="fas fa-graduation-cap"></i> Educational Attainment</h3>
          <div class="chart-stats">
            <span class="stat-badge" id="totalEducation">Levels: 0</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartEducation"></canvas>
        </div>
      </div>

      <!-- Chart 12: Employment -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title"><i class="fas fa-briefcase"></i> Employment Status</h3>
          <div class="chart-stats">
            <span class="stat-badge" id="totalEmployment">Statuses: 0</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartEmployment"></canvas>
        </div>
      </div>

      <!-- Chart 13: Comparison Chart (FULL SIZE) -->
      <div class="chart-card comparison-chart full-size">
        <div class="chart-header">
          <h3 class="chart-title"><i class="fas fa-chart-bar"></i> Barangay vs Status Comparison</h3>
          <div class="chart-stats">
            <span class="stat-badge">Comparative Analysis</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chartComparison"></canvas>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Mobile Bottom Navigation - Fixed - REMOVED LOGOUT BUTTON -->
<nav class="mobile-bottom-nav" id="mobileBottomNav">
  <div class="mobile-nav-items">
    <a href="dashboard.html" class="mobile-nav-item" title="Dashboard">
      <span class="mobile-nav-icon">üìä</span>
      <span class="mobile-nav-text">Dashboard</span>
    </a>
    <a href="dataForm.html" class="mobile-nav-item" title="Data Entry">
      <span class="mobile-nav-icon">üìù</span>
      <span class="mobile-nav-text">Data Entry</span>
    </a>
    <a href="records.html" class="mobile-nav-item" title="Records">
      <span class="mobile-nav-icon">üìÅ</span>
      <span class="mobile-nav-text">Records</span>
    </a>
    <a href="charts.html" class="mobile-nav-item active" title="Charts">
      <span class="mobile-nav-icon">üìà</span>
      <span class="mobile-nav-text">Charts</span>
    </a>
    <a href="users.html" class="mobile-nav-item admin-only" title="Users" id="mobileUsersNav">
      <span class="mobile-nav-icon">üë•</span>
      <span class="mobile-nav-text">Users</span>
    </a>
    <!-- REMOVED: Logout button in mobile nav -->
  </div>
</nav>

<!-- Loading overlay -->
<div id="loading">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div>Loading charts data...</div>
  </div>
</div>

<!-- JavaScript Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
/* ============ CONFIG ============ */
const API_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";

/* ============ CHART INSTANCES ============ */
const CH = {};

/* ============ AUTO-REFRESH CONFIG ============ */
const AUTO_REFRESH_MS = 60000; // 60 seconds
let refreshInterval = null;

/* ============ UTILITY FUNCTIONS ============ */
function showLoading(yes){ 
    document.getElementById("loading").style.display = yes ? "flex" : "none"; 
}

function showError(message) {
    const errorEl = document.getElementById('errorMessage');
    document.getElementById('errorText').textContent = message;
    errorEl.classList.add('show');
    setTimeout(() => errorEl.classList.remove('show'), 10000);
}

function getField(r, key) {
    if (!r) return "";
    if (r.hasOwnProperty(key)) return r[key];
    const kl = key.toLowerCase().trim();
    for (const k of Object.keys(r)) {
        if (String(k).toLowerCase().trim() === kl) return r[k];
    }
    return "";
}

function parseAnyDate(v){
    if(!v && v !== 0) return null;
    if (v instanceof Date) return v;
    v = String(v).trim();
    if (!v) return null;
    if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(v)){
        const p = v.split('/');
        return new Date(Number(p[2]), Number(p[1]) - 1, Number(p[0]));
    }
    if(/^\d{4}-\d{2}-\d{2}/.test(v)){
        return new Date(v);
    }
    const d = new Date(v);
    return isNaN(d) ? null : d;
}

function monthsBetween(d1, d2){
    if(!d1 || !d2) return null;
    let years = d2.getFullYear() - d1.getFullYear();
    let months = d2.getMonth() - d1.getMonth();
    let m = years*12 + months;
    if(d2.getDate() < d1.getDate()) m--;
    return m;
}

function ageInYearsFromBirth(bd){
    const d = parseAnyDate(bd);
    if(!d) return null;
    const now = new Date();
    let years = now.getFullYear() - d.getFullYear();
    const m = now.getMonth() - d.getMonth();
    if(m < 0 || (m === 0 && now.getDate() < d.getDate())) years--;
    return years;
}

function normalizeRow(r){
    const barangay = String(getField(r,"Barangay") || "").trim() || "Unknown";
    const stage = String(getField(r,"Stage") || "").trim() || "Unspecified";
    const pwdRaw = String(getField(r,"Persons with Disability (PWD)") || getField(r,"PWD") || "").trim().toLowerCase();
    const pwd = (pwdRaw === "yes" || pwdRaw === "y" || pwdRaw === "true") ? "Yes" : (pwdRaw === "no" ? "No" : (pwdRaw === "" ? "No" : pwdRaw));
    const status = String(getField(r,"Status") || "").trim() || "Unspecified";
    const birthRaw = getField(r,"Birthdate") || getField(r,"Birth Date") || "";
    const birth = birthRaw ? String(birthRaw).trim() : "";
    
    // Determine if this is a head based on "Name of Household Member/s" field
    const memberName = String(getField(r, "Name of Household Member/s") || "").trim();
    let isHead = false;
    
    // Heads have an empty "Name of Household Member/s" field
    if (!memberName || memberName === "") {
        isHead = true;
    }
    
    // New fields
    const fishR = String(getField(r, "FishR Registered") || "").trim();
    const rbis = String(getField(r, "RBIS Registered") || "").trim();
    const livestock = String(getField(r, "Domestic Livestock") || "").trim();
    const displacement = String(getField(r, "Reason for Displacement") || "").trim();
    const ofw = String(getField(r, "Overseas Filipino Worker (OFW)") || "").trim();
    const education = String(getField(r, "Educational Attainment") || "").trim();
    const employment = String(getField(r, "Employment") || "").trim();
    
    let ageVal = getField(r,"Age");
    let ageYears = null;
    if (ageVal !== "" && ageVal !== null && ageVal !== undefined && !isNaN(Number(ageVal))) {
        ageYears = Number(ageVal);
    } else if (birth) {
        const y = ageInYearsFromBirth(birth);
        if (y !== null) ageYears = y;
    }

    // Assistance fields
    const assist = {};
    const assistKeys = ["TUPAD","Local 4Ps","National 4Ps","Local Social Pension","National Social Pension","Solo Parent Assistance","Cash Subsidy","Relief Goods","AICS"];
    assistKeys.forEach(k => {
        assist[k] = String(getField(r,k) || "").trim();
    });

    return { 
        barangay, 
        stage, 
        pwd, 
        status, 
        birth, 
        ageYears, 
        isHead,
        fishR,
        rbis,
        livestock,
        displacement,
        ofw,
        education,
        employment,
        assist
    };
}

function bucketAge(norm){
    const y = norm.ageYears;
    if (y === null || y === undefined || y === "") return "Unknown";
    if (y < 1) return "Infant (0-11 mos)";
    if (y <= 17) return "School Children (‚â§17)";
    if (y >= 60) return "Elderly (60+)";
    return "Adult (18-59)";
}

/* ============ SESSION MANAGEMENT ============ */
async function sessionCheck(){
    try {
        const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
        
        if (userName && userName !== "User") {
            document.getElementById('userName').innerText = userName;
            
            const isAdmin = localStorage.getItem("userRole") === "admin";
            const adminItems = document.querySelectorAll(".admin-only");
            adminItems.forEach(item => {
                item.classList.toggle("admin-visible", isAdmin);
            });
            
            // Handle mobile nav for admin
            const mobileUsersNav = document.getElementById('mobileUsersNav');
            if (mobileUsersNav) {
                mobileUsersNav.style.display = isAdmin ? 'flex' : 'none';
            }
            
            sessionStorage.setItem('authenticated', 'true');
            return true;
        } else {
            if(sessionStorage.getItem('authenticated')) {
                document.getElementById('userName').innerText = "User";
                return true;
            } else {
                window.location.href = 'index.html?session=expired';
                return false;
            }
        }
    } catch(e){ 
        console.warn('session check failed', e);
        return false;
    }
}

function handleLogout() {
    localStorage.clear();
    sessionStorage.clear();
    const logoutUrl = 'index.html?logout=true&t=' + Date.now();
    fetch(API_URL+'?action=logout&t=' + Date.now())
        .catch(() => {})
        .finally(() => {
            window.location.replace(logoutUrl);
        });
}

/* ============ DATA FETCHING ============ */
async function fetchChartData() {
    try {
        const url = API_URL + "?action=getRecords&t=" + Date.now();
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const res = await fetch(url, {
            cache: "no-store",
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        if(!res.ok) throw new Error("Network error " + res.status);
        const j = await res.json();
        if(!j || !j.success) throw new Error("Bad response from API");
        return j.rows || [];
    } catch(err) {
        if (err.name === 'AbortError') {
            throw new Error("Request timeout. Please try again.");
        }
        throw err;
    }
}

/* ============ CHART FUNCTIONS ============ */
function createBarChart(id, labels, values, title, color, isStacked = false, datasets = null) {
    const ctx = document.getElementById(id).getContext('2d');
    if (CH[id]) CH[id].destroy();

    if (datasets) {
        // Multiple datasets for stacked chart
        CH[id] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 11 },
                            padding: 10
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 12 },
                        bodyFont: { size: 12 },
                        padding: 10,
                        cornerRadius: 6,
                        mode: isStacked ? 'index' : 'nearest'
                    }
                },
                scales: {
                    x: {
                        stacked: isStacked,
                        grid: { display: false },
                        ticks: { 
                            font: { size: 10 },
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        stacked: isStacked,
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { 
                            font: { size: 10 },
                            precision: 0
                        }
                    }
                }
            }
        });
    } else {
        // Single dataset
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, color);
        gradient.addColorStop(1, color.replace('0.8', '0.4'));

        CH[id] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: title,
                    data: values,
                    backgroundColor: gradient,
                    borderColor: color,
                    borderWidth: 1,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 12 },
                        bodyFont: { size: 12 },
                        padding: 10,
                        cornerRadius: 6
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { 
                            font: { size: 10 },
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { 
                            font: { size: 10 },
                            precision: 0
                        }
                    }
                }
            }
        });
    }
}

function createDoughnutChart(id, labels, values, title) {
    const ctx = document.getElementById(id).getContext('2d');
    if (CH[id]) CH[id].destroy();

    const backgroundColors = [
        'rgba(52, 183, 143, 0.8)',
        'rgba(70, 140, 240, 0.8)',
        'rgba(246, 176, 66, 0.8)',
        'rgba(242, 108, 79, 0.8)',
        'rgba(123, 97, 255, 0.8)',
        'rgba(0, 150, 199, 0.8)',
        'rgba(255, 122, 182, 0.8)',
        'rgba(108, 117, 125, 0.8)'
    ];

    CH[id] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: backgroundColors,
                borderWidth: 2,
                borderColor: '#ffffff',
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            },
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 15,
                        font: { size: 11 },
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 12 },
                    bodyFont: { size: 12 },
                    padding: 10,
                    cornerRadius: 6
                }
            },
            cutout: '60%'
        }
    });
}

function createHorizontalBarChart(id, labels, values, title) {
    const ctx = document.getElementById(id).getContext('2d');
    if (CH[id]) CH[id].destroy();

    const gradient = ctx.createLinearGradient(0, 0, 400, 0);
    gradient.addColorStop(0, 'rgba(52, 183, 143, 0.8)');
    gradient.addColorStop(1, 'rgba(70, 140, 240, 0.8)');

    CH[id] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: title,
                data: values,
                backgroundColor: gradient,
                borderColor: 'rgba(52, 183, 143, 1)',
                borderWidth: 1,
                borderRadius: 6
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 12 },
                    bodyFont: { size: 12 },
                    padding: 10,
                    cornerRadius: 6
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: { 
                        font: { size: 10 },
                        precision: 0
                    }
                },
                y: {
                    grid: { display: false },
                    ticks: { 
                        font: { size: 10 },
                        maxRotation: 0
                    }
                }
            }
        }
    });
}

function createComparisonChart(labels, datasets) {
    const ctx = document.getElementById('chartComparison').getContext('2d');
    if (CH['chartComparison']) CH['chartComparison'].destroy();

    const backgroundColors = [
        'rgba(52, 183, 143, 0.7)',
        'rgba(70, 140, 240, 0.7)',
        'rgba(246, 176, 66, 0.7)',
        'rgba(242, 108, 79, 0.7)',
        'rgba(123, 97, 255, 0.7)',
        'rgba(0, 150, 199, 0.7)'
    ];

    CH['chartComparison'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets.map((dataset, index) => ({
                ...dataset,
                backgroundColor: backgroundColors[index % backgroundColors.length],
                borderColor: backgroundColors[index % backgroundColors.length].replace('0.7', '1'),
                borderWidth: 1,
                borderRadius: 4
            }))
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 11 },
                        usePointStyle: true
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 12 },
                    bodyFont: { size: 12 },
                    padding: 10,
                    cornerRadius: 6
                }
            },
            scales: {
                x: {
                    stacked: false,
                    grid: { display: false },
                    ticks: { 
                        font: { size: 10 },
                        maxRotation: 45,
                        minRotation: 0
                    }
                },
                y: {
                    stacked: false,
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: { 
                        font: { size: 10 },
                        precision: 0
                    }
                }
            }
        }
    });
}

/* ============ BUILD CHARTS ============ */
async function buildCharts() {
    showLoading(true);
    
    try {
        const rawRows = await fetchChartData();
        const norm = rawRows.map(normalizeRow);
        
        // Calculate totals for heads and members
        let totalHeads = 0;
        let totalMembers = 0;
        norm.forEach(n => {
            if (n.isHead) {
                totalHeads++;
            } else {
                totalMembers++;
            }
        });
        const totalCombined = totalHeads + totalMembers;

        console.log("Total Heads:", totalHeads, "Total Members:", totalMembers, "Total Combined:", totalCombined);

        // 1. Entries per Barangay (with head/member breakdown) - FULL SIZE
        const barangayCounts = {};
        const barangayHeads = {};
        const barangayMembers = {};
        
        norm.forEach(n => {
            const barangay = n.barangay;
            barangayCounts[barangay] = (barangayCounts[barangay] || 0) + 1;
            if (n.isHead) {
                barangayHeads[barangay] = (barangayHeads[barangay] || 0) + 1;
            } else {
                barangayMembers[barangay] = (barangayMembers[barangay] || 0) + 1;
            }
        });
        
        const brgEntries = Object.entries(barangayCounts).sort((a, b) => b[1] - a[1]);
        const brgLabels = brgEntries.map(e => e[0]);
        const brgHeadsValues = brgLabels.map(b => barangayHeads[b] || 0);
        const brgMembersValues = brgLabels.map(b => barangayMembers[b] || 0);
        const brgTotalValues = brgLabels.map(b => barangayCounts[b] || 0);
        
        // Update stats for barangay chart
        document.getElementById('headsBarangay').textContent = `Heads: ${totalHeads}`;
        document.getElementById('membersBarangay').textContent = `Members: ${totalMembers}`;
        document.getElementById('totalBarangay').textContent = `Total: ${totalCombined}`;
        
        // Create stacked bar chart for barangay
        const barangayDatasets = [
            {
                label: 'Heads',
                data: brgHeadsValues,
                backgroundColor: 'rgba(52, 183, 143, 0.8)',
                borderColor: 'rgba(52, 183, 143, 1)',
                borderWidth: 1
            },
            {
                label: 'Members',
                data: brgMembersValues,
                backgroundColor: 'rgba(70, 140, 240, 0.8)',
                borderColor: 'rgba(70, 140, 240, 1)',
                borderWidth: 1
            }
        ];
        
        createBarChart('chartBarangay', brgLabels, null, 'Households', null, true, barangayDatasets);

        // 2. Age Groups (with head/member breakdown)
        const ageBuckets = {
            "Infant (0-11 mos)": { total: 0, heads: 0, members: 0 },
            "School Children (‚â§17)": { total: 0, heads: 0, members: 0 },
            "Adult (18-59)": { total: 0, heads: 0, members: 0 },
            "Elderly (60+)": { total: 0, heads: 0, members: 0 },
            "Unknown": { total: 0, heads: 0, members: 0 }
        };
        
        norm.forEach(n => {
            const ageGroup = bucketAge(n);
            ageBuckets[ageGroup].total++;
            if (n.isHead) {
                ageBuckets[ageGroup].heads++;
            } else {
                ageBuckets[ageGroup].members++;
            }
        });
        
        const ageLabels = Object.keys(ageBuckets);
        const ageValues = ageLabels.map(label => ageBuckets[label].total);
        
        // Calculate age totals
        let ageHeadsTotal = 0;
        let ageMembersTotal = 0;
        Object.values(ageBuckets).forEach(group => {
            ageHeadsTotal += group.heads;
            ageMembersTotal += group.members;
        });
        
        // Update stats
        document.getElementById('headsAge').textContent = `Heads: ${ageHeadsTotal}`;
        document.getElementById('membersAge').textContent = `Members: ${ageMembersTotal}`;
        document.getElementById('totalAge').textContent = `Total: ${totalCombined}`;
        
        createBarChart('chartAgeGroup', ageLabels, ageValues, 'Persons', 'rgba(70, 140, 240, 0.8)');

        // 3. Stage Distribution (with head/member breakdown)
        const stageCounts = {};
        const stageHeads = {};
        const stageMembers = {};
        
        norm.forEach(n => {
            const stage = n.stage;
            stageCounts[stage] = (stageCounts[stage] || 0) + 1;
            if (n.isHead) {
                stageHeads[stage] = (stageHeads[stage] || 0) + 1;
            } else {
                stageMembers[stage] = (stageMembers[stage] || 0) + 1;
            }
        });
        
        const stageEntries = Object.entries(stageCounts).sort((a, b) => b[1] - a[1]);
        const stageLabels = stageEntries.map(e => e[0]);
        const stageValues = stageEntries.map(e => e[1]);
        
        // Calculate stage totals
        let stageHeadsTotal = 0;
        let stageMembersTotal = 0;
        Object.values(stageHeads).forEach(count => stageHeadsTotal += count);
        Object.values(stageMembers).forEach(count => stageMembersTotal += count);
        
        // Update stats
        document.getElementById('headsStage').textContent = `Heads: ${stageHeadsTotal}`;
        document.getElementById('membersStage').textContent = `Members: ${stageMembersTotal}`;
        document.getElementById('totalStage').textContent = `Total: ${totalCombined}`;
        
        createDoughnutChart('chartStage', stageLabels, stageValues, 'Stage Distribution');

        // 4. PWD Distribution - FULL SIZE
        let pwdHeadsYes = 0, pwdHeadsNo = 0;
        let pwdMembersYes = 0, pwdMembersNo = 0;
        
        norm.forEach(n => {
            const isPWD = String(n.pwd).toLowerCase() === 'yes';
            if (n.isHead) {
                if (isPWD) pwdHeadsYes++;
                else pwdHeadsNo++;
            } else {
                if (isPWD) pwdMembersYes++;
                else pwdMembersNo++;
            }
        });
        
        const pwdTotalYes = pwdHeadsYes + pwdMembersYes;
        const pwdTotalNo = pwdHeadsNo + pwdMembersNo;
        
        // Update stats
        document.getElementById('headsPWD').textContent = `Heads: ${pwdHeadsYes + pwdHeadsNo}`;
        document.getElementById('membersPWD').textContent = `Members: ${pwdMembersYes + pwdMembersNo}`;
        document.getElementById('totalPWD').textContent = `Total: ${totalCombined}`;
        
        // Create PWD chart as stacked bar
        const pwdLabels = ['PWD Distribution'];
        const pwdDatasets = [
            {
                label: 'Heads - PWD',
                data: [pwdHeadsYes],
                backgroundColor: 'rgba(52, 183, 143, 0.8)',
                borderColor: 'rgba(52, 183, 143, 1)',
                borderWidth: 1
            },
            {
                label: 'Heads - Non-PWD',
                data: [pwdHeadsNo],
                backgroundColor: 'rgba(52, 183, 143, 0.4)',
                borderColor: 'rgba(52, 183, 143, 0.7)',
                borderWidth: 1
            },
            {
                label: 'Members - PWD',
                data: [pwdMembersYes],
                backgroundColor: 'rgba(70, 140, 240, 0.8)',
                borderColor: 'rgba(70, 140, 240, 1)',
                borderWidth: 1
            },
            {
                label: 'Members - Non-PWD',
                data: [pwdMembersNo],
                backgroundColor: 'rgba(70, 140, 240, 0.4)',
                borderColor: 'rgba(70, 140, 240, 0.7)',
                borderWidth: 1
            }
        ];
        
        createBarChart('chartPWD', pwdLabels, null, 'PWD Status', null, true, pwdDatasets);

        // 5. Status Distribution - FULL SIZE
        const statusCounts = {};
        const statusHeads = {};
        const statusMembers = {};
        
        norm.forEach(n => {
            const status = n.status;
            statusCounts[status] = (statusCounts[status] || 0) + 1;
            if (n.isHead) {
                statusHeads[status] = (statusHeads[status] || 0) + 1;
            } else {
                statusMembers[status] = (statusMembers[status] || 0) + 1;
            }
        });
        
        const statusEntries = Object.entries(statusCounts).sort((a, b) => b[1] - a[1]);
        const statusLabels = statusEntries.map(e => e[0]);
        const statusHeadsValues = statusLabels.map(s => statusHeads[s] || 0);
        const statusMembersValues = statusLabels.map(s => statusMembers[s] || 0);
        const statusTotalValues = statusLabels.map(s => statusCounts[s] || 0);
        
        // Update stats
        document.getElementById('headsStatus').textContent = `Heads: ${totalHeads}`;
        document.getElementById('membersStatus').textContent = `Members: ${totalMembers}`;
        document.getElementById('totalStatus').textContent = `Total: ${totalCombined}`;
        
        // Create stacked bar chart for status
        const statusDatasets = [
            {
                label: 'Heads',
                data: statusHeadsValues,
                backgroundColor: 'rgba(52, 183, 143, 0.8)',
                borderColor: 'rgba(52, 183, 143, 1)',
                borderWidth: 1
            },
            {
                label: 'Members',
                data: statusMembersValues,
                backgroundColor: 'rgba(70, 140, 240, 0.8)',
                borderColor: 'rgba(70, 140, 240, 1)',
                borderWidth: 1
            }
        ];
        
        createBarChart('chartStatus', statusLabels, null, 'Status Distribution', null, true, statusDatasets);

        // 6. Government Support - FULL SIZE
        const supportKeys = [
            "TUPAD", "Local 4Ps", "National 4Ps", "Local Social Pension",
            "National Social Pension", "Solo Parent Assistance", "Cash Subsidy",
            "Relief Goods", "AICS"
        ];
        
        const supportHeads = {};
        const supportMembers = {};
        supportKeys.forEach(k => {
            supportHeads[k] = 0;
            supportMembers[k] = 0;
        });
        
        norm.forEach(n => {
            supportKeys.forEach(k => {
                const v = n.assist && n.assist[k] ? String(n.assist[k]).trim().toLowerCase() : "";
                if (k === 'AICS') {
                    if (v) {
                        if (n.isHead) supportHeads[k]++;
                        else supportMembers[k]++;
                    }
                } else {
                    if (v === 'yes' || v === 'y' || v === 'true') {
                        if (n.isHead) supportHeads[k]++;
                        else supportMembers[k]++;
                    }
                }
            });
        });
        
        const supportLabels = supportKeys;
        const supportHeadsValues = supportLabels.map(k => supportHeads[k]);
        const supportMembersValues = supportLabels.map(k => supportMembers[k]);
        const supportTotalValues = supportLabels.map(k => supportHeads[k] + supportMembers[k]);
        
        // Update stats
        document.getElementById('headsSupport').textContent = `Heads: ${totalHeads}`;
        document.getElementById('membersSupport').textContent = `Members: ${totalMembers}`;
        document.getElementById('totalSupport').textContent = `Total: ${totalCombined}`;
        
        // Create stacked bar chart for government support
        const supportDatasets = [
            {
                label: 'Heads',
                data: supportHeadsValues,
                backgroundColor: 'rgba(52, 183, 143, 0.8)',
                borderColor: 'rgba(52, 183, 143, 1)',
                borderWidth: 1
            },
            {
                label: 'Members',
                data: supportMembersValues,
                backgroundColor: 'rgba(70, 140, 240, 0.8)',
                borderColor: 'rgba(70, 140, 240, 1)',
                borderWidth: 1
            }
        ];
        
        createBarChart('chartSupport', supportLabels, null, 'Government Support', null, true, supportDatasets);

        // 7. Registration Status - FULL SIZE
        const registrationHeads = {
            "FishR Registered": 0,
            "RBIS Registered": 0,
            "Both Registered": 0,
            "Non Registered": 0
        };
        
        const registrationMembers = {
            "FishR Registered": 0,
            "RBIS Registered": 0,
            "Both Registered": 0,
            "Non Registered": 0
        };
        
        norm.forEach(n => {
            const hasFishR = n.fishR && (n.fishR.toLowerCase() === 'yes' || n.fishR.toLowerCase() === 'y' || n.fishR === 'true');
            const hasRBIS = n.rbis && (n.rbis.toLowerCase() === 'yes' || n.rbis.toLowerCase() === 'y' || n.rbis === 'true');
            
            let regType = "Non Registered";
            if (hasFishR && hasRBIS) {
                regType = "Both Registered";
            } else if (hasFishR) {
                regType = "FishR Registered";
            } else if (hasRBIS) {
                regType = "RBIS Registered";
            }
            
            if (n.isHead) {
                registrationHeads[regType]++;
            } else {
                registrationMembers[regType]++;
            }
        });
        
        const registrationLabels = Object.keys(registrationHeads);
        const registrationHeadsValues = registrationLabels.map(k => registrationHeads[k]);
        const registrationMembersValues = registrationLabels.map(k => registrationMembers[k]);
        const registrationTotalValues = registrationLabels.map(k => registrationHeads[k] + registrationMembers[k]);
        
        // Update stats
        document.getElementById('headsRegistration').textContent = `Heads: ${totalHeads}`;
        document.getElementById('membersRegistration').textContent = `Members: ${totalMembers}`;
        document.getElementById('totalRegistration').textContent = `Total: ${totalCombined}`;
        
        // Create stacked bar chart for registration
        const registrationDatasets = [
            {
                label: 'Heads',
                data: registrationHeadsValues,
                backgroundColor: 'rgba(52, 183, 143, 0.8)',
                borderColor: 'rgba(52, 183, 143, 1)',
                borderWidth: 1
            },
            {
                label: 'Members',
                data: registrationMembersValues,
                backgroundColor: 'rgba(70, 140, 240, 0.8)',
                borderColor: 'rgba(70, 140, 240, 1)',
                borderWidth: 1
            }
        ];
        
        createBarChart('chartRegistration', registrationLabels, null, 'Registration Status', null, true, registrationDatasets);

        // 8. Domestic Livestock
        const livestockCounts = {};
        norm.forEach(n => {
            if (n.livestock && n.livestock.trim() !== '') {
                const livestockItems = n.livestock.split(',').map(item => item.trim());
                livestockItems.forEach(item => {
                    livestockCounts[item] = (livestockCounts[item] || 0) + 1;
                });
            }
        });
        
        const livestockEntries = Object.entries(livestockCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
        const livestockLabels = livestockEntries.map(e => e[0]);
        const livestockValues = livestockEntries.map(e => e[1]);
        document.getElementById('totalLivestock').textContent = `Livestock: ${Object.keys(livestockCounts).length}`;
        createBarChart('chartLivestock', livestockLabels, livestockValues, 'Count', 'rgba(255, 122, 0, 0.8)');

        // 9. Reason for Displacement
        const displacementCounts = {};
        norm.forEach(n => {
            if (n.displacement && n.displacement.trim() !== '') {
                displacementCounts[n.displacement] = (displacementCounts[n.displacement] || 0) + 1;
            }
        });
        
        const displacementEntries = Object.entries(displacementCounts).sort((a, b) => b[1] - a[1]);
        const displacementLabels = displacementEntries.map(e => e[0]);
        const displacementValues = displacementEntries.map(e => e[1]);
        document.getElementById('totalDisplacement').textContent = `Reasons: ${displacementLabels.length}`;
        createHorizontalBarChart('chartDisplacement', displacementLabels, displacementValues, 'Count');

        // 10. Overseas Filipino Worker (OFW)
        const ofwCounts = {
            "OFW": 0,
            "Non-OFW": 0
        };
        
        norm.forEach(n => {
            if (n.ofw && (n.ofw.toLowerCase() === 'yes' || n.ofw.toLowerCase() === 'y' || n.ofw === 'true')) {
                ofwCounts["OFW"]++;
            } else {
                ofwCounts["Non-OFW"]++;
            }
        });
        
        const ofwLabels = Object.keys(ofwCounts);
        const ofwValues = Object.values(ofwCounts);
        document.getElementById('totalOFW').textContent = `OFWs: ${ofwCounts["OFW"]}`;
        createDoughnutChart('chartOFW', ofwLabels, ofwValues, 'OFW Status');

        // 11. Educational Attainment
        const educationCounts = {};
        norm.forEach(n => {
            if (n.education && n.education.trim() !== '') {
                educationCounts[n.education] = (educationCounts[n.education] || 0) + 1;
            }
        });
        
        const educationEntries = Object.entries(educationCounts).sort((a, b) => b[1] - a[1]);
        const educationLabels = educationEntries.map(e => e[0]);
        const educationValues = educationEntries.map(e => e[1]);
        document.getElementById('totalEducation').textContent = `Levels: ${educationLabels.length}`;
        createBarChart('chartEducation', educationLabels, educationValues, 'Count', 'rgba(123, 97, 255, 0.8)');

        // 12. Employment
        const employmentCounts = {};
        norm.forEach(n => {
            if (n.employment && n.employment.trim() !== '') {
                employmentCounts[n.employment] = (employmentCounts[n.employment] || 0) + 1;
            }
        });
        
        const employmentEntries = Object.entries(employmentCounts).sort((a, b) => b[1] - a[1]);
        const employmentLabels = employmentEntries.map(e => e[0]);
        const employmentValues = employmentEntries.map(e => e[1]);
        document.getElementById('totalEmployment').textContent = `Statuses: ${employmentLabels.length}`;
        createDoughnutChart('chartEmployment', employmentLabels, employmentValues, 'Employment Status');

        // 13. Comparison Chart - FULL SIZE
        const comparisonMatrix = {};
        const statusSet = new Set();
        norm.forEach(n => {
            const b = n.barangay || 'Unknown';
            const s = n.status || 'Unspecified';
            statusSet.add(s);
            if (!comparisonMatrix[b]) comparisonMatrix[b] = {};
            comparisonMatrix[b][s] = (comparisonMatrix[b][s] || 0) + 1;
        });
        
        const statusKeys = Array.from(statusSet).sort();
        const barangayLabels = Object.keys(comparisonMatrix).sort((a, b) => {
            const totalA = Object.values(comparisonMatrix[a] || {}).reduce((x, y) => x + y, 0);
            const totalB = Object.values(comparisonMatrix[b] || {}).reduce((x, y) => x + y, 0);
            return totalB - totalA;
        }).slice(0, 10); // Limit to top 10 barangays for readability
        
        const comparisonDatasets = statusKeys.slice(0, 6).map(status => ({ // Limit to 6 statuses
            label: status,
            data: barangayLabels.map(barangay => comparisonMatrix[barangay]?.[status] || 0)
        }));
        
        createComparisonChart(barangayLabels, comparisonDatasets);

    } catch (err) {
        console.error("Error building charts:", err);
        showError("Unable to load charts: " + err.message);
    } finally {
        showLoading(false);
    }
}

/* ============ EXPORT FUNCTIONS ============ */
async function exportToPDF() {
    try {
        // Close export dropdown after selection
        document.getElementById('exportDropdown').classList.remove('show');
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('landscape', 'mm', 'a4');
        
        const chartIds = [
            'chartBarangay', 'chartAgeGroup', 'chartStage',
            'chartPWD', 'chartStatus', 'chartSupport',
            'chartRegistration', 'chartLivestock', 'chartDisplacement',
            'chartOFW', 'chartEducation', 'chartEmployment',
            'chartComparison'
        ];
        
        let page = 0;
        for (const id of chartIds) {
            const canvas = document.getElementById(id);
            if (!canvas) continue;
            
            // Create a white background canvas
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            
            // Fill with white background
            tempCtx.fillStyle = '#ffffff';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // Draw the chart
            tempCtx.drawImage(canvas, 0, 0);
            
            const imgData = tempCanvas.toDataURL('image/jpeg', 1.0);
            const imgWidth = 280;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            if (page > 0) pdf.addPage();
            
            // Add title
            pdf.setFontSize(16);
            pdf.setTextColor(15, 122, 74);
            pdf.text('Purok Kaligtasan - Charts Report', 10, 15);
            
            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);
            pdf.text(new Date().toLocaleDateString(), 270, 15);
            
            // Add chart
            pdf.addImage(imgData, 'JPEG', 10, 25, imgWidth, imgHeight);
            
            page++;
        }
        
        pdf.save(`Charts_Report_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`);
    } catch(err) {
        console.error("PDF export failed:", err);
        showError("PDF export failed: " + err.message);
    }
}

async function exportPNGsZip() {
    try {
        // Close export dropdown after selection
        document.getElementById('exportDropdown').classList.remove('show');
        
        const zip = new JSZip();
        const chartIds = [
            'chartBarangay', 'chartAgeGroup', 'chartStage',
            'chartPWD', 'chartStatus', 'chartSupport',
            'chartRegistration', 'chartLivestock', 'chartDisplacement',
            'chartOFW', 'chartEducation', 'chartEmployment',
            'chartComparison'
        ];
        
        for(const id of chartIds) {
            const canvas = document.getElementById(id);
            if(!canvas) continue;
            
            // Create a white background canvas
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            
            // Fill with white background
            tempCtx.fillStyle = '#ffffff';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // Draw the chart
            tempCtx.drawImage(canvas, 0, 0);
            
            const blob = await new Promise(res => tempCanvas.toBlob(res, 'image/png', 1.0));
            if(blob) zip.file(`${id}.png`, blob);
        }
        
        const content = await zip.generateAsync({type:'blob'});
        saveAs(content, `Charts_PNGs_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`);
    } catch(err) {
        console.error("PNG ZIP failed:", err);
        showError("PNG ZIP failed: " + err.message);
    }
}

async function exportCSV_AllRows() {
    try {
        // Close export dropdown after selection
        document.getElementById('exportDropdown').classList.remove('show');
        
        const raw = await fetchChartData();
        if(!Array.isArray(raw) || raw.length === 0){
            showError("No data to export");
            return;
        }
        
        const keys = new Set();
        raw.forEach(r => Object.keys(r).forEach(k => keys.add(k)));
        const header = Array.from(keys);
        const rows = raw.map(r => header.map(h => {
            const v = r[h];
            if (v === null || v === undefined) return '';
            return typeof v === 'string' ? v.replace(/"/g,'""') : String(v);
        }));
        
        let csv = '"' + header.join('","') + '"\n';
        rows.forEach(r => csv += '"' + r.join('","') + '"\n');

        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        saveAs(blob, `All_Rows_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`);
    } catch(err) {
        console.error("CSV export failed", err);
        showError("CSV export failed: " + err.message);
    }
}

/* ============ AUTO REFRESH ============ */
function startAutoRefresh() {
    if(refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(() => {
        buildCharts();
    }, AUTO_REFRESH_MS);
    
    // Update indicator
    const indicator = document.querySelector('.auto-refresh span:last-child');
    if (indicator) {
        indicator.textContent = 'Auto-refresh: 60s';
    }
}

function stopAutoRefresh() {
    if(refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

/* ============ SIDEBAR TOGGLE ============ */
function toggleSidebar() {
    const pageContainer = document.querySelector('.page-container');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const icon = sidebarToggle.querySelector('i');
    
    pageContainer.classList.toggle('collapsed');
    
    if (pageContainer.classList.contains('collapsed')) {
        icon.className = 'fas fa-chevron-right';
        sidebarToggle.title = "Expand sidebar";
    } else {
        icon.className = 'fas fa-bars';
        sidebarToggle.title = "Collapse sidebar";
    }
}

/* ============ EVENT LISTENERS ============ */
document.addEventListener('DOMContentLoaded', async function() {
    // Session check
    const isAuthenticated = await sessionCheck();
    
    if (isAuthenticated) {
        // Set user info
        const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
        document.getElementById("userName").innerText = userName;
        
        // Check admin status
        const isAdmin = localStorage.getItem("userRole") === "admin";
        const adminItems = document.querySelectorAll(".admin-only");
        adminItems.forEach(item => {
            item.classList.toggle("admin-visible", isAdmin);
        });
        
        // Handle mobile nav for admin
        const mobileUsersNav = document.getElementById('mobileUsersNav');
        if (mobileUsersNav) {
            mobileUsersNav.style.display = isAdmin ? 'flex' : 'none';
        }
        
        // Initialize charts
        await buildCharts();
        startAutoRefresh();
        
        // Bind event listeners
        document.getElementById('btnRefresh').addEventListener('click', () => {
            buildCharts();
        });
        
        document.getElementById('btnPrint').addEventListener('click', () => {
            window.print();
        });
        
        // Export dropdown functionality - FIXED: Close after selection
        const exportBtn = document.getElementById('exportBtn');
        const exportDropdown = document.getElementById('exportDropdown');
        
        if (exportBtn && exportDropdown) {
            exportBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                exportDropdown.classList.toggle('show');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!exportBtn.contains(e.target) && !exportDropdown.contains(e.target)) {
                    exportDropdown.classList.remove('show');
                }
            });
            
            // Close dropdown when clicking on export options (they already call functions that close it)
        }
        
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
        
        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // Rebuild charts on resize for better fit
                Object.keys(CH).forEach(key => {
                    if (CH[key] && CH[key].resize) {
                        try {
                            CH[key].resize();
                        } catch(e) {
                            console.warn('Could not resize chart:', key, e);
                        }
                    }
                });
            }, 250);
        });
        
        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                buildCharts();
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });
        
        // Handle touch events for mobile
        document.addEventListener('touchstart', function(e) {
            // Prevent zoom on double tap
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Optimize for mobile performance
        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Chart is visible, ensure it's rendered
                        const canvas = entry.target.querySelector('canvas');
                        if (canvas && canvas.id && CH[canvas.id]) {
                            try {
                                CH[canvas.id].resize();
                            } catch(e) {}
                        }
                    }
                });
            }, { threshold: 0.1 });
            
            // Observe all chart cards
            document.querySelectorAll('.chart-card').forEach(card => {
                observer.observe(card);
            });
        }
    }
});

// Handle page show event
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        sessionCheck().then(isAuthenticated => {
            if (isAuthenticated) {
                buildCharts();
                startAutoRefresh();
            }
        });
    }
});

// Handle page hide to stop intervals
window.addEventListener('pagehide', function() {
    stopAutoRefresh();
});

// Handle beforeunload
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>
<script src="js/data-broadcaster.js"></script>
<script src="js/form-notifier.js"></script>
<script src="common-utils.js"></script>
<script src="session-manager.js"></script>
<script src="common-session.js"></script>
<script src="activity-tracking-final.js"></script>
</body>
</html>

