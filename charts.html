<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Purok Kaligtasan ‚Äî Charts</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>

    h2{ margin:0 0 6px 0; font-size:20px }
    .small.muted{ color:var(--muted); margin-bottom:6px }

    .charts-container{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:20px;
      margin-top:15px;
    }
    .chart-card{
      background:var(--card-grad);
      border-radius:14px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(6,30,20,0.06);
      border: 1px solid rgba(6,30,20,0.03);
    }
    .chart-card h4{
      margin:4px 0 12px 0;
      font-size:16px;
      font-weight:700;
      color:var(--green-1);
    }
    /* ensure charts export with white background */
    canvas{
      display:block;
      width:100% !important;
      height:auto !important;
      background: white;
      border-radius:6px;
      box-shadow: 0 10px 20px rgba(6,30,20,0.04);
    }

    .floating-menu{
      position: fixed;
      right: 18px;
      top: 120px;
      width: 220px;
      background: white;
      border-radius: 14px;
      padding:12px;
      box-shadow:0 10px 35px rgba(6,30,20,0.14);
      z-index:9999;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .floating-menu h5{ margin:0 0 6px 0; font-size:15px; font-weight:700; color:var(--green-1) }
    .btn{ padding:8px; border-radius:8px; font-weight:700; cursor:pointer; background:linear-gradient(90deg,#0f7a4a,#34b78f); color:#fff; border:0 }
    .small-desc{ font-size:12px; color:var(--muted) }

    @media(max-width:980px){
      .charts-container{ grid-template-columns:1fr }
      .sidebar{ display:none }
      main.content-area{ padding-top:86px; margin-left:0 }
      .floating-menu{ left:8px; right:8px; bottom:18px; top:auto; width:auto; flex-direction:row; justify-content:space-between }
    }

    /* print tweaks */
    @media print{
      body{ background:white }
      header, .sidebar, .floating-menu{ display:none !important }
      .chart-card{ page-break-inside:avoid; border:none; box-shadow:none; background:white }
      canvas{ filter:none !important; box-shadow:none !important; background:white !important }
    }
  </style>
</head>
<body>
<div class="page-container">

  <header class="topbar">
    <button id="menuToggle" class="menu-btn" aria-label="Toggle menu" aria-expanded="true">‚ò∞</button>

    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div>
        <div class="title">PUROK KALIGTASAN</div>
        <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
      </div>
    </div>

    <div class="user-info">
      <span id="userName"></span>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <ul>
      <li><a href="dashboard.html">üìä Dashboard</a></li>
      <li><a href="dataForm.html" class="active">üìù Data Entry</a></li>
      <li><a href="records.html">üìÅ Records</a></li>
      <li><a href="charts.html">üìà Charts</a></li>
      <li class="admin-only"><a href="users.html">üë• User Management</a></li>
    </ul>
  </aside>

  <main class="content-area">
    <h2>üìà Household Statistics & Trends</h2>
    <div class="small muted">Visual summary of all registered household. Hover legends to toggle series. Charts refresh when page loads.</div>

    <div class="charts-container" id="chartsContainer">
      <div class="chart-card">
        <h4>1. Entry per Barangay</h4>
        <canvas id="chartBarangay" height="220"></canvas>
      </div>

      <div class="chart-card">
        <h4>2. Age Groups </h4>
        <canvas id="chartAgeGroup" height="220"></canvas>
      </div>

      <div class="chart-card">
        <h4>3. Stage </h4>
        <canvas id="chartStage" height="220"></canvas>
      </div>

      <div class="chart-card">
        <h4>4. Persons With Disability (PWD)</h4>
        <canvas id="chartPWD" height="220"></canvas>
      </div>

      <div class="chart-card">
        <h4>5. Status </h4>
        <canvas id="chartStatus" height="220"></canvas>
      </div>

      <div class="chart-card">
        <h4>6. Government Support </h4>
        <canvas id="chartSupport" height="260"></canvas>
      </div>
    </div>
  </main>
</div>

<div class="floating-menu" role="toolbar" aria-label="Export tools">
  <h5>Export & Print</h5>
  <button id="btnPrint" class="btn">Print</button>
  <button id="btnExportPDF" class="btn">Export PDF</button>
  <button id="btnExportPNGs" class="btn">Export PNG ZIP</button>
  <div class="small-desc">Use PDF for reports, PNG for slides.</div>
</div>

<!-- Chart.js v4 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/file-saver/2.0.5/FileSaver.min.js"></script>
<script>window.saveAs = window.saveAs || saveAs;</script>


<script>
(function(){
  // === CONFIG ===
  const API_URL = "https://script.google.com/macros/s/AKfycbxWs1kxkyleYw6qcQlIx1xsecQS8x2O-nyXxbcdcm5DVst6IcmDKR-NmzSgBxyH7ErvpA/exec";

  // container for Chart instances so we can destroy them on re-render
  const CHARTS = {};

  /*******************
   * Utilities
   *******************/
  function safeGet(r, keyCandidates){
    for(const k of keyCandidates){
      if(r.hasOwnProperty(k)) return r[k];
      // case-insensitive match
      for(const kk of Object.keys(r)){
        if(String(kk).trim().toLowerCase() === String(k).trim().toLowerCase()) return r[kk];
      }
    }
    return "";
  }

  function parseAnyDate(v){
    if(!v && v !== 0) return null;
    if(v instanceof Date) return v;
    v = String(v).trim();
    if(!v) return null;
    // dd/mm/yyyy
    if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(v)){
      const p = v.split('/');
      return new Date(Number(p[2]), Number(p[1]) - 1, Number(p[0]));
    }
    // yyyy-mm-dd (optionally with time)
    if(/^\d{4}-\d{2}-\d{2}/.test(v)){
      // let Date parse it (handles timezone)
      const d = new Date(v);
      return isNaN(d) ? null : d;
    }
    // try Date constructor
    const d = new Date(v);
    return isNaN(d) ? null : d;
  }

  function monthsBetween(d1, d2){
    if(!d1 || !d2) return null;
    let years = d2.getFullYear() - d1.getFullYear();
    let months = d2.getMonth() - d1.getMonth();
    let total = years*12 + months;
    if(d2.getDate() < d1.getDate()) total--;
    return total;
  }

  function yearsFromBirth(bd){
    const d = parseAnyDate(bd);
    if(!d) return null;
    const now = new Date();
    let y = now.getFullYear() - d.getFullYear();
    const m = now.getMonth() - d.getMonth();
    if(m < 0 || (m === 0 && now.getDate() < d.getDate())) y--;
    return y;
  }

  // normalize row object from getRecords
  function normalizeRow(r){
    const barangay = String(safeGet(r, ["Barangay"])).trim() || "Unknown";
    const stage = String(safeGet(r, ["Stage"])).trim() || "";
    const pwd = String(safeGet(r, ["Persons with Disability (PWD)", "PWD"])).trim().toLowerCase();
    const status = String(safeGet(r, ["Status"])).trim() || "";
    const birthRaw = safeGet(r, ["Birthdate", "Birth Date", "Birthdate (Head)"]);
    const birthdate = birthRaw ? String(birthRaw).trim() : "";

    // Age field may already contain numeric years
    const ageField = safeGet(r, ["Age"]);
    let ageYears = null;
    if(ageField !== "" && ageField !== null && ageField !== undefined && !isNaN(Number(ageField))){
      ageYears = Number(ageField);
    } else {
      // compute from birthdate if possible
      if(birthdate) {
        const yrs = yearsFromBirth(birthdate);
        if(yrs !== null) ageYears = yrs;
      }
    }

    // infant months calc if ageYears is 0 or missing but birthdate exists
    let infantMonths = null;
    if(birthdate){
      const bd = parseAnyDate(birthdate);
      if(bd){
        const m = monthsBetween(bd, new Date());
        if(m !== null) infantMonths = m;
      }
    }

    // assistance fields (we count "yes" on checkboxes; AICS counts any non-empty)
    const assistFields = ["TUPAD","Local 4Ps","National 4Ps","Local Social Pension","National Social Pension","Solo Parent Assistance","Cash Subsidy","Relief Goods","AICS"];
    const assist = {};
    assistFields.forEach(k => {
      assist[k] = String(safeGet(r, [k])).trim();
    });

    return { barangay, stage, pwd, status, birthdate, ageYears, infantMonths, assist };
  }

  // Age bucket according to your rule
  // 0-11 months => Infant
  // <=17 => School Children
  // 18-59 => Adult
  // 60+ => Elderly
  function ageBucket(obj){
    if(obj.infantMonths !== null && obj.infantMonths !== undefined && obj.infantMonths >= 0 && obj.infantMonths <= 11){
      return "Infant (0-11 mos)";
    }
    const y = obj.ageYears;
    if(y === null || y === undefined) return "Unknown";
    if(y <= 17) return "School Children (‚â§17)";
    if(y >= 60) return "Elderly (60+)";
    return "Adult (18-59)";
  }

  /***********************
   * Fetch data from API
   ***********************/
  async function fetchRecords(){
    const url = API_URL + "?action=getRecords";
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("Network error: " + res.status);
    const j = await res.json();
    if(!j || !j.success) throw new Error("Bad response from API");
    return j.rows || [];
  }

  /***********************
   * Chart drawing helpers
   ***********************/
  function destroyIfExists(id){
    if(CHARTS[id]) {
      try { CHARTS[id].destroy(); } catch(e){}
      CHARTS[id] = null;
    }
  }

  function makeVerticalGradient(ctx, height, colorTop, colorBottom){
    const g = ctx.createLinearGradient(0,0,0,height || 200);
    g.addColorStop(0, colorTop);
    g.addColorStop(1, colorBottom);
    return g;
  }

  function drawBar(id, labels, data, opts = {}){
    const ctxEl = document.getElementById(id);
    if(!ctxEl) return;
    const ctx = ctxEl.getContext("2d");
    destroyIfExists(id);
    const gradient = makeVerticalGradient(ctx, ctxEl.height, opts.topColor || "rgba(52,183,143,0.95)", opts.botColor || "rgba(15,122,74,0.85)");

    CHARTS[id] = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: opts.label || "Count",
          data,
          backgroundColor: labels.map((_,i) => gradient),
          borderColor: labels.map(()=> opts.borderColor || "#0f7a4a"),
          borderWidth: 1,
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { precision:0 } },
          x: { ticks: { autoSkip: true, maxRotation:0 } }
        }
      }
    });
  }

  function drawHorizontalBar(id, labels, data){
    const ctxEl = document.getElementById(id);
    if(!ctxEl) return;
    const ctx = ctxEl.getContext("2d");
    destroyIfExists(id);

    const palette = [
      "#0f7a4a","#3fbf8b","#f6b042","#f26c4f","#7b61ff","#0096c7","#ff7ab6","#6c757d","#2d9cdb"
    ];

    CHARTS[id] = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Recipients",
          data,
          backgroundColor: labels.map((_,i)=> palette[i % palette.length]),
          borderColor: labels.map(()=> 'rgba(0,0,0,0.06)'),
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { x: { beginAtZero: true, ticks: { precision:0 } } }
      }
    });
  }

  function drawDoughnut(id, labels, data){
    const ctxEl = document.getElementById(id);
    if(!ctxEl) return;
    const ctx = ctxEl.getContext("2d");
    destroyIfExists(id);

    CHARTS[id] = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: labels.map((_,i)=> `hsl(${(i*55)%360} 70% 52%)`),
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }

  /***********************
   * Build charts main
   ***********************/
  async function buildCharts(){
    try {
      const raw = await fetchRecords();
      const normalized = raw.map(normalizeRow);

      // 1) Entry per Barangay
      const barangayMap = {};
      normalized.forEach(n => {
        const b = n.barangay || "Unknown";
        barangayMap[b] = (barangayMap[b] || 0) + 1;
      });
      // sort descending
      const brEntries = Object.entries(barangayMap).sort((a,b)=> b[1]-a[1]);
      const brLabels = brEntries.map(e => e[0]);
      const brCounts = brEntries.map(e => e[1]);
      drawBar("chartBarangay", brLabels, brCounts, {
  label: "Evacuees",
  topColor: "rgba(52,183,143,0.95)",   // green
  botColor: "rgba(15,122,74,0.85)",     // green darker
  borderColor: "#0f7a4a"
});


      // 2) Age groups
      const ageBuckets = {
        "Infant (0-11 mos)": 0,
        "School Children (‚â§17)": 0,
        "Adult (18-59)": 0,
        "Elderly (60+)": 0,
        "Unknown": 0
      };
      normalized.forEach(n => {
        ageBuckets[ ageBucket(n) ] = (ageBuckets[ ageBucket(n) ] || 0) + 1;
      });
      drawBar("chartAgeGroup", Object.keys(ageBuckets), Object.values(ageBuckets), {
  topColor: "rgba(79,129,255,0.95)",   // blue
  botColor: "rgba(52,83,255,0.85)",    // blue darker
  borderColor: "#2557d6"
});


      // 3) Stage distribution (doughnut)
      const stageMap = {};
      normalized.forEach(n => {
        const s = n.stage || "Unspecified";
        stageMap[s] = (stageMap[s]||0) + 1;
      });
      drawDoughnut("chartStage", Object.keys(stageMap), Object.values(stageMap));

      // 4) PWD
      const pwdCounts = { Yes:0, No:0, Unknown:0 };
      normalized.forEach(n => {
        const v = (n.pwd || "").toString().trim().toLowerCase();
        if(v === "yes" || v === "y" || v === "true") pwdCounts.Yes++;
        else if(v === "no" || v === "n" || v === "") pwdCounts.No++;
        else pwdCounts.Unknown++;
      });
      drawDoughnut("chartPWD", Object.keys(pwdCounts), Object.values(pwdCounts));

      // 5) Status distribution
      const statusMap = {};
      normalized.forEach(n => {
        const s = n.status || "Unspecified";
        statusMap[s] = (statusMap[s]||0) + 1;
      });
      drawDoughnut("chartStatus", Object.keys(statusMap), Object.values(statusMap));

      // 6) Government support
      const assistKeys = ["TUPAD","Local 4Ps","National 4Ps","Local Social Pension","National Social Pension","Solo Parent Assistance","Cash Subsidy","Relief Goods","AICS"];
      const assistCounts = {};
      assistKeys.forEach(k => assistCounts[k] = 0);
      normalized.forEach(n => {
        assistKeys.forEach(k => {
          const v = (n.assist && n.assist[k]) ? String(n.assist[k]).trim().toLowerCase() : "";
          if(k === "AICS"){
            if(v !== "") assistCounts[k]++; // count non-empty AICS
          } else {
            if(v === "yes" || v === "y" || v === "true") assistCounts[k]++;
          }
        });
      });
      drawHorizontalBar("chartSupport", assistKeys, assistKeys.map(k => assistCounts[k]));

    } catch(err){
      console.error("buildCharts error", err);
      alert("Unable to load charts: " + err.message);
    }
  }

  /***********************
   * Export helpers
   ***********************/
  // create a white background copy of a canvas and return its dataURL
  function canvasToDataURLWithWhiteBg(canvas, type = "image/png", quality = 0.95){
    // create an offscreen canvas
    const w = canvas.width;
    const h = canvas.height;
    const off = document.createElement('canvas');
    off.width = w;
    off.height = h;
    const ctx = off.getContext('2d');
    // white background
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,w,h);
    // draw original canvas over it
    ctx.drawImage(canvas, 0, 0, w, h);
    return off.toDataURL(type, quality);
  }

  async function exportAllToPDF(){
    try {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: "landscape" });
      const ids = ["chartBarangay","chartAgeGroup","chartStage","chartPWD","chartStatus","chartSupport"];
      let page = 0;
      for(const id of ids){
        const c = document.getElementById(id);
        if(!c) continue;
        const imgData = canvasToDataURLWithWhiteBg(c, "image/jpeg", 0.95);
        if(page > 0) pdf.addPage();
        // fit into pdf page with margins
        const pw = pdf.internal.pageSize.getWidth();
        const ph = pdf.internal.pageSize.getHeight();
        const margin = 12;
        const w = pw - margin * 2;
        const h = ph - margin * 2;
        pdf.addImage(imgData, "JPEG", margin, margin, w, h);
        page++;
      }
      pdf.save(`Charts_Report_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`);
    } catch(err){
      console.error("PDF export failed", err);
      alert("PDF export failed: " + err.message);
    }
  }

  async function exportPNGsZip(){
    try {
      const zip = new JSZip();
      const ids = ["chartBarangay","chartAgeGroup","chartStage","chartPWD","chartStatus","chartSupport"];
      for(const id of ids){
        const c = document.getElementById(id);
        if(!c) continue;
        const dataUrl = canvasToDataURLWithWhiteBg(c, "image/png", 1.0);
        // convert dataURL to blob
        const res = await fetch(dataUrl);
        const blob = await res.blob();
        zip.file(`${id}.png`, blob);
      }
      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, `Charts_PNGs_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`);
    } catch(err){
      console.error("PNG export failed", err);
      alert("PNG export failed: " + err.message);
    }
  }

  // Hook export buttons
  document.getElementById('btnPrint').addEventListener('click', () => window.print());
  document.getElementById('btnExportPDF').addEventListener('click', exportAllToPDF);
  document.getElementById('btnExportPNGs').addEventListener('click', exportPNGsZip);

  // Init
  (function init(){
    document.getElementById('userName').innerText = localStorage.getItem('staffName') || '';
    document.getElementById('logoutBtn').addEventListener('click', ()=> { localStorage.clear(); location.href='login.html'; });
    buildCharts();
  })();

})();
</script>
</body>
</html>


