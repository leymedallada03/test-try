<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Data Entry ‚Äî MDRRMO Alitagtag</title>
<link rel="stylesheet" href="styles.css"/>
<style>
/* BEGIN: Your existing styles ‚Äî kept exactly as requested */
/* Slide-in member panel (Option C) */
.member-panel {
  position: fixed;
  right: 0;
  top: 0;
  height: 100vh;
  width: 420px;
  max-width: 96%;
  background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,250,0.98));
  box-shadow: -18px 0 40px rgba(6,30,20,0.12);
  transform: translateX(110%);
  transition: transform 280ms cubic-bezier(.2,.9,.3,1);
  z-index: 6000;
  padding: 18px;
  overflow-y: auto;
}
.member-panel.open { transform: translateX(0%); }
.member-panel .panel-header { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
.member-panel h3 { margin:0; font-size:18px; color:var(--green-1); }
.member-panel .panel-body { margin-top:8px; }
.member-panel .panel-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

.radio-line { display:flex; gap:18px; align-items:center; padding:6px 0; }
.radio-item { display:flex; align-items:center; gap:6px; font-weight:700; font-size:14px; }

.assist-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:8px 12px; margin-top:8px; }
.assist-item { display:flex; align-items:center; gap:8px; font-size:14px; font-weight:700; }

.panel-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.32);
  opacity: 0;
  transition: opacity 200ms;
  pointer-events: none;
  z-index: 5900;
}
.panel-overlay.show { opacity: 1; pointer-events: auto; }

@media(max-width:720px){
  .member-panel { width: 100%; max-width: 100%; }
}

.member-preview { margin-top:8px; font-size:14px; }
.member-preview li { margin-bottom:6px; }

.input-inline { display:flex; gap:8px; align-items:center; }
.small-muted { font-size:13px; color:var(--muted); }

/* small tweak for buttons inside panel to match existing classes */
.btn { border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;background: linear-gradient(90deg,#0f7a4a,#34b78f); color:#fff; }
.btn.secondary { background: transparent; color: #0f7a4a; border:1px solid rgba(6,30,20,0.06); }
.card { padding:14px;border-radius:10px;background:#fff;margin-bottom:12px;box-shadow:0 6px 18px rgba(6,30,20,0.04); }
.form-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
.form-grid > div { min-width:0; }
.small { font-size:13px; }

.assist-card {
  background: #ffffff;
  border: 1px solid #cfd8dc;
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.assist-card h4 {
  margin: 0 0 10px 0;
  font-size: 15px;
  color: #0b4d28;
  font-weight: 700;
}

.assist-card-grid {
  display: grid;
  grid-template-columns: repeat(2,1fr);
  gap: 7px 12px;
  font-size: 14px;
}

.assist-card-grid label {
  display: flex;
  align-items: center;
  gap: 6px;
}
/* END: Your existing styles */
</style>
</head>

<body>
<div class="page-container">
  <header class="topbar">
    <button id="menuToggle" class="menu-btn" aria-label="Toggle menu" aria-expanded="true">‚ò∞</button>
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="logo"/>
      <div>
        <div class="title">PUROK KALIGTASAN</div>
        <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
      </div>
    </div>
    <div class="user-info">
      <span id="userName"></span>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <ul>
      <li><a href="Dashboard.html">üìä Dashboard</a></li>
      <li><a href="dataForm.html" class="active">üìù Data Entry</a></li>
      <li><a href="records.html">üìÅ Records</a></li>
      <li><a href="charts.html">üìà Charts</a></li>
      <li class="admin-only"><a href="users.html">üë• User Management</a></li>
    </ul>
  </aside>

  <main class="content-area" tabindex="-1">
    <h2>üìù Household Evacuation Information (Head first)</h2>

    <form id="headForm" novalidate onsubmit="return false;">
      <div class="form-section card">
        <h3>Basic Information (Household Head)</h3>
        <div class="form-grid">
          <div>
            <label>Barangay <span class="small">*</span></label>
            <select id="barangay" required>
              <option value="">Select Barangay...</option>
              <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
              <option>Dalipit East</option><option>Dalipit West</option><option>Dominador East</option>
              <option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
              <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option>
              <option>Ping-As</option><option>Poblacion East</option><option>Poblacion West</option>
              <option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
            </select>
          </div>

          <div>
            <label>Sitio / Purok <span class="small">*</span></label>
            <select id="sitio" required>
              <option value="">Select...</option>
              <option>Purok I</option><option>Purok II</option><option>Purok III</option>
              <option>Purok IV</option><option>Purok V</option><option>Purok VI</option>
              <option>Purok VII</option>
            </select>
          </div>

          <div>
            <label>Name of Household Head <span class="small">*</span></label>
            <input type="text" id="householdHead" required />
          </div>

          <div>
            <label>Sex <span class="small">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="head_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate <span class="small">*</span></label>
            <input type="date" id="householdBirthdate" />
          </div>

          <div>
            <label>Age</label>
            <input type="number" id="householdAge" readonly />
          </div>

          <div>
            <label>Stage</label>
            <input type="text" id="householdStage" readonly />
          </div>

          <div>
            <label>No. of Household Member/s <span class="small">*</span></label>
            <input type="number" id="memberCount" min="0" value="0" />
            <div class="small-muted">Set to 0 if no other members.</div>
          </div>
        </div>

        <hr style="margin:12px 0">

        <h4>Health and Status</h4>
        <div class="form-grid">
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_pwd" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="head_pwd" value="No"> No</label>
            </div>
          </div>

          <div>
            <label>Status</label>
            <select id="head_status">
              <option value="">Select...</option>
              <option>With Sickness</option><option>Pregnant</option><option>Others</option>
            </select>
          </div>

          <div>
            <label>Transportation</label>
            <select id="head_transport">
              <option value="">Select...</option>
              <option>Individual with Transportation</option>
              <option>Individual needing Transportation</option>
            </select>
          </div>
        </div>

        <hr style="margin:12px 0">

        <h4>Pickup  / Transport / Camp Details</h4>
        <div class="form-grid">
          <div>
            <label>Designated Pick-Up Point</label>
            <input type="text" id="pickup" />
          </div>
          <div>
            <label>Drop-Off Point</label>
            <input type="text" id="dropoff" />
          </div>
          <div>
            <label>Name of Camp</label>
            <input type="text" id="campName" />
          </div>
          <div>
            <label>Capacity</label>
            <input type="number" id="capacity" min="0" />
          </div>
          <div>
            <label>No. of Individuals Inside Camp</label>
            <input type="number" id="insideCamp" min="0" value="0" />
          </div>
          <div>
            <label>No. of Individuals Outside Camp</label>
            <input type="number" id="outsideCamp" min="0" value="0" />
          </div>
        </div>

        <div class="form-grid">
          <div style="grid-column:1/-1">
            <label>Reasons for Displacement</label>
            <select id="reasons">
              <option value="">Select...</option>
              <option>With-in 14-15 KM Danger Zone</option>
              <option>Others</option>
            </select>
          </div>
        </div>

        <hr style="margin:12px 0">
        <h4>Assistance Received (optional)</h4>
        <div class="assist-grid">
          <label class="assist-item"><input type="checkbox" id="ass_tupad"> TUPAD</label>
          <label class="assist-item"><input type="checkbox" id="ass_intlsp"> National Social Pension</label>
          <label class="assist-item"><input type="checkbox" id="ass_local4ps"> Local 4Ps</label>
          <label class="assist-item"><input type="checkbox" id="ass_cash"> Cash Subsidy</label>
          <label class="assist-item"><input type="checkbox" id="ass_intl4ps"> National 4Ps</label>
          <label class="assist-item"><input type="checkbox" id="ass_solo"> Solo Parent Assistance</label>
          <label class="assist-item"><input type="checkbox" id="ass_locsp"> Local Social Pension</label>
          <label class="assist-item"><input type="checkbox" id="ass_relief"> Relief Goods</label>
        </div>

        <div style="margin-top:8px">
          <label>AICS (if any)</label>
          <select id="ass_aics">
            <option value="">None</option>
            <option>Shelter Assistance</option>
            <option>Burial</option>
            <option>Scholarship</option>
          </select>
        </div>

        <div style="height:10px"></div>

        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="resetBtn" class="btn secondary" type="button">Reset</button>
          <button id="nextToMembers" class="btn" type="button">Next ‚Üí Members</button>
        </div>
      </div>

      <!-- preview of members to be added -->
      <div class="card">
        <h4>Members to be collected</h4>
        <div class="small-muted">Number of members chosen: <strong id="previewCount">0</strong></div>
        <ul id="membersPreview" class="member-preview"></ul>
      </div>

    </form>
  </main>
</div>

<!-- slide-in member panel overlay -->
<div id="panelOverlay" class="panel-overlay" aria-hidden="true"></div>

<!-- slide-in member panel -->
<div id="memberPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Member entry panel">

  <div class="panel-header">
    <button id="panelClose" class="btn secondary" title="Close panel">‚Üê</button>
    <h3 id="panelTitle">Member 1 of N</h3>
  </div>

  <div class="panel-body">
    <form id="memberForm" onsubmit="return false;">

      <div class="form-grid">

        <div>
          <label>Member Name <span class="small">*</span></label>
          <input type="text" id="memberName" required />
        </div>

        <div>
          <label>Sex</label>
          <div class="radio-line">
            <label class="radio-item"><input type="radio" name="member_sex" value="Male"> Male</label>
            <label class="radio-item"><input type="radio" name="member_sex" value="Female"> Female</label>
          </div>
        </div>

        <div>
          <label>Birthdate</label>
          <input type="date" id="memberBirthdate" />
        </div>

        <div>
          <label>Age</label>
          <input type="number" id="memberAge" readonly />
        </div>

        <div>
          <label>PWD</label>
          <div class="radio-line">
            <label class="radio-item"><input type="radio" name="member_pwd" value="Yes"> Yes</label>
            <label class="radio-item"><input type="radio" name="member_pwd" value="No" checked> No</label>
          </div>
        </div>

        <div>
          <label>Stage</label>
          <input type="text" id="memberStage" readonly />
        </div>

        <div>
          <label>Status</label>
          <select id="memberStatus">
            <option value="">Select...</option>
            <option>With Sickness</option>
            <option>Pregnant</option>
          </select>
        </div>

        <div>
          <label>Transportation</label>
          <select id="memberTransport">
            <option value="">Select...</option>
            <option>Individual with Transportation</option>
            <option>Individual needing Transportation</option>
          </select>
        </div>

        <div>
          <label>Pick-Up Point</label>
          <input type="text" id="memberPickup" />
        </div>

        <div>
          <label>Drop-Off Point</label>
          <input type="text" id="memberDropoff" />
        </div>

        <div>
          <label>Camp Name</label>
          <input type="text" id="memberCamp" />
        </div>

        <div>
          <label>Capacity</label>
          <input type="number" id="memberCampCap" min="0" />
        </div>

        <div>
          <label>Inside Camp</label>
          <input type="number" id="memberInside" min="0" />
        </div>

        <div>
          <label>Outside Camp</label>
          <input type="number" id="memberOutside" min="0" />
        </div>

        <div>
          <label>Reason</label>
          <select id="memberReason">
            <option value="">Select...</option>
            <option>With-in 14-15 KM Danger Zone</option>
            <option>Others</option>
          </select>
        </div>

        <!-- Government Support Section -->
        <div style="grid-column:1/-1">

          <div class="assist-card">
            <h4>Government Support</h4>

            <div class="assist-card-grid">
              <label><input type="checkbox" id="member_tupad"> TUPAD</label>
              <label><input type="checkbox" id="member_local4ps"> Local 4Ps</label>
              <label><input type="checkbox" id="member_intl4ps"> National 4Ps</label>
              <label><input type="checkbox" id="member_locsp"> Local Social Pension</label>
              <label><input type="checkbox" id="member_intlsp"> National Social Pension</label>
              <label><input type="checkbox" id="member_solo"> Solo Parent Assistance</label>
            </div>

          </div>

          <!-- Relief Goods Section -->
          <div class="assist-card">
            <h4>Relief Goods</h4>

            <div class="assist-card-grid">
              <label><input type="checkbox" id="member_cash"> Cash Subsidy</label>
              <label><input type="checkbox" id="member_relief"> Relief Goods</label>
            </div>

          </div>

        </div>

      </div> <!-- end form-grid -->

      <div class="panel-actions">
        <button id="memberBack" class="btn secondary" type="button">Back</button>
        <button id="memberNext" class="btn" type="button">Save & Next</button>
      </div>

    </form>
  </div>

</div>

<script>
/* Part 3 ‚Äî FINAL client script for dataForm.html
   - Uses FormData (no custom headers) to avoid CORS preflight.
   - Sends: action=createRecord, head (JSON string), members (JSON string), submittedBy
*/

const API_URL = "https://script.google.com/macros/s/AKfycbyCuVGQ-kTqjYSgrbmmbcX8DgcX-CQLbeVNrEmQCq5KbroE1Z6etiKBzgA-i_VFW0PYvw/exec";

/* ---------- Helpers ---------- */
function ensureLoginOrRedirect(){
  if(!localStorage.getItem('loggedIn')){ window.location.href='index.html'; return false; }
  return true;
}

function computeAgeFromBirthdate(dateStr){
  if(!dateStr) return null;
  const b = new Date(dateStr);
  if(isNaN(b)) return null;
  const now = new Date();
  let years = now.getFullYear() - b.getFullYear();
  const m = now.getMonth() - b.getMonth();
  if(m < 0 || (m === 0 && now.getDate() < b.getDate())) years--;
  if(years <= 0){
    const months = (now.getFullYear() - b.getFullYear()) * 12 + (now.getMonth() - b.getMonth());
    return { years: 0, months: Math.max(0, months) };
  }
  return { years };
}
function deriveStageFromAge(ageObj){
  if(!ageObj) return '';
  if(ageObj.years === 0){
    const months = ageObj.months || 0;
    if(months <= 10) return 'Infant';
    return 'Children';
  }
  if(ageObj.years <= 17) return 'School Children';
  if(ageObj.years >= 60) return 'Elderly';
  return 'Adult';
}

/* DOM helpers */
const $ = id => document.getElementById(id);
const q = sel => document.querySelector(sel);

/* Member collection state */
let membersToCollect = 0;
let currentMemberIndex = 0;
let collectedMembers = [];

/* ---------- UI utility functions ---------- */
function updateMemberPreview(){
  const n = parseInt($('memberCount').value || 0, 10) || 0;
  $('previewCount').innerText = n;
  const ul = $('membersPreview');
  ul.innerHTML = '';
  for(let i=0;i<n;i++){
    const li = document.createElement('li');
    const m = collectedMembers[i];
    li.textContent = `Member #${i+1}` + (m && m["Name of Household Member/s"] ? ` ‚Äî ${m["Name of Household Member/s"]}` : '');
    ul.appendChild(li);
  }
}

/* head age/stage */
function updateHeadAgeStage(){
  const date = $('householdBirthdate').value;
  const ageObj = computeAgeFromBirthdate(date);
  if(!ageObj){ $('householdAge').value=''; $('householdStage').value=''; return; }
  $('householdAge').value = (ageObj.years === 0 ? 0 : ageObj.years);
  $('householdStage').value = deriveStageFromAge(ageObj);
}

/* member age/stage */
function updateMemberAgeStage(){
  const date = $('memberBirthdate').value;
  const ageObj = computeAgeFromBirthdate(date);
  if(!ageObj){ $('memberAge').value=''; $('memberStage').value=''; return; }
  $('memberAge').value = (ageObj.years === 0 ? 0 : ageObj.years);
  $('memberStage').value = deriveStageFromAge(ageObj);
}

/* panel open/close */
function openPanel(){ $('memberPanel').classList.add('open'); $('panelOverlay').classList.add('show'); }
function closePanel(){ $('memberPanel').classList.remove('open'); $('panelOverlay').classList.remove('show'); }

/* clear member form */
function clearMemberForm(){
  $('memberForm').reset();
  $('memberAge').value = '';
  $('memberStage').value = '';
}

/* prefill from head */
function prefillMemberDefaults(){
  const pickup = $('pickup').value || '';
  const dropoff = $('dropoff').value || '';
  const camp = $('campName').value || '';
  const cap = $('capacity').value || '';
  if($('memberPickup')) $('memberPickup').value = pickup;
  if($('memberDropoff')) $('memberDropoff').value = dropoff;
  if($('memberCamp')) $('memberCamp').value = camp;
  if($('memberCampCap')) $('memberCampCap').value = cap;
}

/* collect current member into an object keyed to your sheet header names */
function collectCurrentMember(){
  return {
    "Name of Household Member/s": ($('memberName').value || '').trim(),
    "Sex": q('input[name="member_sex"]:checked')?.value || '',
    "Birthdate": $('memberBirthdate').value || '',
    "Age": $('memberAge').value || '',
    "Persons with Disability (PWD)": q('input[name="member_pwd"]:checked')?.value || 'No',
    "Stage": $('memberStage').value || '',
    "Status": $('memberStatus').value || '',
    "Transportation": $('memberTransport').value || '',
    "Designated Pick-Up Point": $('memberPickup').value || '',
    "Drop-Off Point": $('memberDropoff').value || '',
    "Name of Camp": $('memberCamp').value || '',
    "Capacity": $('memberCampCap').value || '',
    "No. of Individuals Inside Camp": $('memberInside').value || '',
    "No. of Individuals Outside Camp": $('memberOutside').value || '',
    "Reasons for Displacement": $('memberReason').value || '',
    "TUPAD": $('member_tupad')?.checked ? 'Yes' : 'No',
    "Local 4Ps": $('member_local4ps')?.checked ? 'Yes' : 'No',
    "National 4Ps": $('member_intl4ps')?.checked ? 'Yes' : 'No',
    "Local Social Pension": $('member_locsp')?.checked ? 'Yes' : 'No',
    "National Social Pension": $('member_intlsp')?.checked ? 'Yes' : 'No',
    "Solo Parent Assistance": $('member_solo')?.checked ? 'Yes' : 'No',
    "Cash Subsidy": $('member_cash')?.checked ? 'Yes' : 'No',
    "Relief Goods": $('member_relief')?.checked ? 'Yes' : 'No',
    "AICS": $('memberAICS')?.value || ''
  };
}

/* validate member name */
function validateMemberForm(){
  const name = ($('memberName').value || '').trim();
  if(!name){ alert('Please provide member name'); return false; }
  return true;
}

/* Member Next button behavior */
function onMemberNext(){
  if(!validateMemberForm()) return;
  const obj = collectCurrentMember();
  collectedMembers[currentMemberIndex] = obj;
  updateMemberPreview();

  currentMemberIndex++;
  if(currentMemberIndex >= membersToCollect){
    // finish
    closePanel();
    submitRecord(collectedMembers.filter(Boolean));
    return;
  }

  // prepare next
  $('panelTitle').innerText = `Member ${currentMemberIndex+1} of ${membersToCollect}`;
  clearMemberForm();
  prefillMemberDefaults();
  setTimeout(()=> $('memberName').focus(), 120);
}

/* Member Back (edit previous) */
function onMemberBack(){
  if(currentMemberIndex === 0){
    if(confirm('Close member entry? Progress will be lost.')) closePanel();
    return;
  }
  currentMemberIndex--;
  const obj = collectedMembers[currentMemberIndex] || {};
  $('panelTitle').innerText = `Member ${currentMemberIndex+1} of ${membersToCollect}`;

  // populate
  $('memberName').value = obj["Name of Household Member/s"] || '';
  if(obj.Sex){
    Array.from(document.getElementsByName('member_sex')).forEach(r=> r.checked = (r.value === obj.Sex));
  } else { Array.from(document.getElementsByName('member_sex')).forEach(r=> r.checked = false); }
  $('memberBirthdate').value = obj.Birthdate || '';
  updateMemberAgeStage();
  if(obj["Persons with Disability (PWD)"] === 'Yes') q('input[name="member_pwd"][value="Yes"]').checked = true;
  else q('input[name="member_pwd"][value="No"]').checked = true;
  $('memberStage').value = obj.Stage || '';
  $('memberStatus').value = obj.Status || '';
  $('memberTransport').value = obj.Transportation || '';
  $('memberPickup').value = obj["Designated Pick-Up Point"] || '';
  $('memberDropoff').value = obj["Drop-Off Point"] || '';
  $('memberCamp').value = obj["Name of Camp"] || '';
  $('memberCampCap').value = obj.Capacity || '';
  $('memberInside').value = obj["No. of Individuals Inside Camp"] || '';
  $('memberOutside').value = obj["No. of Individuals Outside Camp"] || '';
  $('memberReason').value = obj["Reasons for Displacement"] || '';
  $('member_tupad').checked = (obj.TUPAD === 'Yes');
  $('member_local4ps').checked = (obj["Local 4Ps"] === 'Yes');
  $('member_intl4ps').checked = (obj["National 4Ps"] === 'Yes');
  $('member_locsp').checked = (obj["Local Social Pension"] === 'Yes');
  $('member_intlsp').checked = (obj["National Social Pension"] === 'Yes');
  $('member_solo').checked = (obj["Solo Parent Assistance"] === 'Yes');
  $('member_cash').checked = (obj["Cash Subsidy"] === 'Yes');
  $('member_relief').checked = (obj["Relief Goods"] === 'Yes');
  $('memberAICS').value = obj.AICS || '';
}

/* ---------- Build head object (matches your Master sheet headers) ---------- */
function buildHeadObject(){
  return {
    "Barangay": $('barangay').value || '',
    "Sitio / Purok": $('sitio').value || '',
    "Name of Household Head": $('householdHead').value.trim() || '',
    "Sex": q('input[name="head_sex"]:checked')?.value || '',
    "Birthdate": $('householdBirthdate').value || '',
    "Age": $('householdAge').value || '',
    "No. of Household Member/s": String($('memberCount').value || '0'),
    "Name of Household Member/s": "", // head row doesn't list member names (members saved in subsequent rows)
    "Persons with Disability (PWD)": q('input[name="head_pwd"]:checked')?.value || 'No',
    "Stage": $('householdStage').value || '',
    "Status": $('head_status').value || '',
    "Transportation": $('head_transport').value || '',
    "Designated Pick-Up Point": $('pickup').value || '',
    "Drop-Off Point": $('dropoff').value || '',
    "Name of Camp": $('campName').value || '',
    "Capacity": $('capacity').value || '',
    "No. of Individuals Inside Camp": $('insideCamp').value || '',
    "No. of Individuals Outside Camp": $('outsideCamp').value || '',
    "Reasons for Displacement": $('reasons').value || '',
    "TUPAD": $('ass_tupad')?.checked ? 'Yes' : 'No',
    "Local 4Ps": $('ass_local4ps')?.checked ? 'Yes' : 'No',
    "National 4Ps": $('ass_intl4ps')?.checked ? 'Yes' : 'No',
    "Local Social Pension": $('ass_locsp')?.checked ? 'Yes' : 'No',
    "National Social Pension": $('ass_intlsp')?.checked ? 'Yes' : 'No',
    "Solo Parent Assistance": $('ass_solo')?.checked ? 'Yes' : 'No',
    "Cash Subsidy": $('ass_cash')?.checked ? 'Yes' : 'No',
    "Relief Goods": $('ass_relief')?.checked ? 'Yes' : 'No',
    "AICS": $('ass_aics').value || ''
  };
}

/* ---------- Submit (FormData) ---------- */
async function submitRecord(membersArray){
  // validation
  const barangay = $('barangay').value || '';
  const sitio = $('sitio').value || '';
  const headName = $('householdHead').value.trim() || '';
  const headSex = q('input[name="head_sex"]:checked')?.value || '';
  if(!barangay || !sitio || !headName || !headSex){
    alert('Please complete required household head fields (Barangay, Sitio, Head name, Sex).');
    return;
  }

  const headObj = buildHeadObject();
  const submittedBy = localStorage.getItem('staffName') || localStorage.getItem('username') || '';

  // Build FormData to avoid preflight
  const fd = new FormData();
  fd.append('action','createRecord');
  fd.append('head', JSON.stringify(headObj));        // server should JSON.parse if needed
  fd.append('members', JSON.stringify(membersArray || []));
  fd.append('submittedBy', submittedBy);
  // Optional auth fields (if your server verifies)
  fd.append('username', localStorage.getItem('username') || '');
  fd.append('pwHash', localStorage.getItem('pwHash') || '');

  try {
    const res = await fetch(API_URL, { method: 'POST', body: fd });
    const text = await res.text();

    let data;
    try { data = JSON.parse(text); } catch(e) {
      // If server returned HTML or text, show it in console for debugging
      console.error('Non-JSON response from API:', text);
      alert('Server error. Check console for details.');
      return;
    }

    if(data && data.success){
      alert('Saved ‚Äî Data ID: ' + (data.dataID || data.DataID || '(unknown)'));
      window.location.href = 'records.html';
    } else {
      // Attempt fallback: server may expect raw JSON (rare). Try sending JSON body (this may trigger CORS preflight).
      console.warn('FormData POST failed, server responded:', data);
      alert('Save failed: ' + (data.message || JSON.stringify(data)));
    }

  } catch (err) {
    console.error('Network/fetch error:', err);
    alert('Connection error: ' + (err && err.message ? err.message : err));
  }
}

/* ---------- Event bindings & initialization ---------- */
document.addEventListener('DOMContentLoaded', ()=>{

  if(!ensureLoginOrRedirect()) return;

  // display user
  $('userName').innerText = localStorage.getItem('staffName') || '';

  // head birth -> age & stage
  $('householdBirthdate').addEventListener('change', updateHeadAgeStage);

  // member count preview
  $('memberCount').addEventListener('input', updateMemberPreview);
  updateMemberPreview();

  // Next -> start member sequence (or submit head-only)
  $('nextToMembers').addEventListener('click', ()=>{
    const barangay = $('barangay').value || '';
    const sitio = $('sitio').value || '';
    const headName = $('householdHead').value.trim() || '';
    const headSex = q('input[name="head_sex"]:checked')?.value || '';
    if(!barangay || !sitio || !headName || !headSex){
      alert('Please complete required household head fields (Barangay, Sitio, Name, Sex).');
      return;
    }

    membersToCollect = parseInt($('memberCount').value || 0, 10) || 0;
    collectedMembers = new Array(membersToCollect);
    currentMemberIndex = 0;

    if(membersToCollect <= 0){
      submitRecord([]);
    } else {
      // open panel and set up
      $('panelTitle').innerText = `Member 1 of ${membersToCollect}`;
      clearMemberForm();
      prefillMemberDefaults();
      openPanel();
      setTimeout(()=> $('memberName').focus(), 200);
    }
  });

  // Reset
  $('resetBtn').addEventListener('click', ()=> {
    $('headForm').reset();
    $('membersPreview').innerHTML = '';
    $('previewCount').innerText = '0';
    $('householdAge').value = '';
    $('householdStage').value = '';
    collectedMembers = [];
  });

  // Panel controls
  $('panelClose').addEventListener('click', ()=> { if(confirm('Close member entry? Progress will be lost.')) closePanel(); });
  $('panelOverlay').addEventListener('click', ()=> { if(confirm('Close member entry? Progress will be lost.')) closePanel(); });

  // member form events
  $('memberBirthdate').addEventListener('change', updateMemberAgeStage);
  $('memberNext').addEventListener('click', onMemberNext);
  $('memberBack').addEventListener('click', onMemberBack);

  // allow Enter to save member
  $('memberForm').addEventListener('keydown', (ev)=> {
    if(ev.key === 'Enter'){ ev.preventDefault(); onMemberNext(); }
  });

}); // DOMContentLoaded
</script>
</body>
</html>
