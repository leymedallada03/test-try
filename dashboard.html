<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan â€” Dashboard</title>
<link rel="stylesheet" href="styles.css"/>

<style>
  .dashboard-cards{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:12px;
    margin:12px 0 18px 0
  }
  .card{
    padding:12px;
    border-radius:10px;
    background:#fff;
    box-shadow:0 6px 18px rgba(6,30,20,0.04)
  }
  .card h3{
    margin:0 0 8px 0;
    font-size:14px;
    color:#0f7a4a
  }
  .card-value{
    font-size:22px;
    font-weight:800;
    color:#153b26
  }
</style>
</head>

<body>
<div class="page-container">

  <header class="topbar">
    <button id="menuToggle" class="menu-btn" aria-label="Toggle menu">â˜°</button>

    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div>
        <div class="title">PUROK KALIGTASAN</div>
        <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
      </div>
    </div>

    <div class="user-info">
      <span id="userName"></span>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <aside class="sidebar">
    <ul>
      <li><a href="dashboard.html" class="active">ğŸ“Š Dashboard</a></li>
      <li><a href="dataForm.html">ğŸ“ Data Entry</a></li>
      <li><a href="records.html">ğŸ“ Records</a></li>
      <li><a href="charts.html">ğŸ“ˆ Charts</a></li>

      <!-- FIXED: Hidden by default -->
      <li id="navUsers" style="display:none;">
        <a href="users.html">ğŸ‘¥ User Management</a>
      </li>
    </ul>
  </aside>

  <main class="content-area" tabindex="-1">
    <h2>ğŸ“Š Dashboard Overview</h2>

    <div class="dashboard-cards">
      <div class="card">
        <h3>Total Household Heads</h3>
        <div id="totalHeads" class="card-value">0</div>
      </div>

      <div class="card">
        <h3>Total Household Members</h3>
        <div id="totalMembers" class="card-value">0</div>
      </div>

      <div class="card">
        <h3>Assigned Barangay</h3>
        <div id="assignedBarangay" class="card-value">---</div>
      </div>

      <div class="card">
        <h3>Last Updated</h3>
        <div id="lastUpdated" class="card-value">---</div>
      </div>
    </div>

    <div class="card">
      <h3>Household Distribution per Barangay</h3>
      <canvas id="barangayChart" height="160"></canvas>
    </div>

  </main>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
/* ============================
   ROLE CHECK â€” WORKS ON ALL PAGES
   ============================ */

const API_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";

async function checkRole() {
    try {
        const res = await fetch(API_URL + "?action=sessionCheck");
        const data = await res.json();

        if (!data.success) {
            return window.location.href = "index.html";
        }

        document.getElementById("userName").innerText = data.fullName || "";

        // Admin â†’ show User Management
        if (data.role === "Admin") {
            document.getElementById("navUsers").style.display = "block";
        }

        // Staff â†’ hide User Management and block access
        if (data.role === "Staff") {
            document.getElementById("navUsers").style.display = "none";

            if (location.pathname.includes("users.html")) {
                return window.location.href = "index.html";
            }
        }

    } catch (err) {
        console.error(err);
        window.location.href = "index.html";
    }
}

checkRole();

/* ============================
   DASHBOARD LOGIC
   ============================ */

let refreshTimer = null;
let currentChart = null;

// case-insensitive field lookup
function getField(obj, fieldName) {
  if (!obj) return "";
  const want = fieldName.toLowerCase().trim();
  for (const k of Object.keys(obj)) {
    if (k.toLowerCase().trim() === want) return obj[k];
  }
  return "";
}

async function fetchRecords() {
  const url = API_URL + "?action=getRecords";
  const res = await fetch(url, { cache: "no-store" });
  return await res.json();
}

function destroyChart() {
  if (currentChart) {
    try { currentChart.destroy(); } catch(e) {}
    currentChart = null;
  }
}

async function loadDashboard() {
  try {
    const data = await fetchRecords();
    const rows = data.rows || [];

    let headCount = 0;
    let memberCount = 0;

    const barangayMap = {};

    rows.forEach(r => {
      const memberName = String(getField(r, "Name of Household Member/s")).trim();
      const barangay = String(getField(r, "Barangay") || "Unknown").trim();

      const isHead = (memberName === "");

      if (isHead) headCount++;
      else memberCount++;

      if (!barangayMap[barangay]) barangayMap[barangay] = { heads: 0, members: 0 };
      if (isHead) barangayMap[barangay].heads++;
      else barangayMap[barangay].members++;
    });

    // Update dashboard values
    document.getElementById("totalHeads").innerText = headCount;
    document.getElementById("totalMembers").innerText = memberCount;
    document.getElementById("assignedBarangay").innerText = localStorage.getItem("assignedBarangay") || "---";
    document.getElementById("lastUpdated").innerText = new Date().toLocaleString();

    // Chart
    destroyChart();
    const labels = Object.keys(barangayMap).sort();
    const headData = labels.map(b => barangayMap[b].heads);
    const memberData = labels.map(b => barangayMap[b].members);

    const ctx = document.getElementById("barangayChart").getContext("2d");
    currentChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label:"Household Heads", data: headData, backgroundColor:"#2b9348" },
          { label:"Household Members", data: memberData, backgroundColor:"#55a630" }
        ]
      },
      options:{
        responsive:true,
        plugins:{ legend:{ position:"bottom" } },
        scales:{ y:{ beginAtZero:true } }
      }
    });

  } catch (err) {
    console.error("Dashboard error:", err);
  }
}

function autoRefresh() {
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(loadDashboard, 30000); // 30 seconds
}

document.getElementById("logoutBtn").addEventListener("click", () => {
  fetch(API_URL + "?action=logout");
  window.location.href = "index.html";
});

/* Init */
loadDashboard();
autoRefresh();

</script>
</body>
</html>


