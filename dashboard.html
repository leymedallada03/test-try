<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan â€” Dashboard</title>
<link rel="stylesheet" href="styles.css"/>
</head>
<body>
<div class="page-container">

  <header class="topbar">
    <button id="menuToggle" class="menu-btn" aria-label="Toggle menu">â˜°</button>

    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div>
        <div class="title">PUROK KALIGTASAN</div>
        <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
      </div>
    </div>

    <div class="user-info">
      <span id="userName"></span>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <aside class="sidebar">
    <ul>
      <li><a href="dashboard.html" class="active">ğŸ“Š Dashboard</a></li>
      <li><a href="dataForm.html">ğŸ“ Data Entry</a></li>
      <li><a href="records.html">ğŸ“ Records</a></li>
      <li><a href="charts.html">ğŸ“ˆ Charts</a></li>
      <li class="admin-only"><a href="users.html">ğŸ‘¥ User Management</a></li>
    </ul>
  </aside>

  <main class="content-area" tabindex="-1">
    <h2>ğŸ“Š Dashboard Overview</h2>

    <div class="dashboard-cards">
      <div class="card">
        <h3>Total Household Heads</h3>
        <div id="totalHeads" class="card-value">0</div>
      </div>

      <div class="card">
        <h3>Total Household Members</h3>
        <div id="totalMembers" class="card-value">0</div>
      </div>

      <div class="card">
        <h3>Assigned Barangay</h3>
        <div id="assignedBarangay" class="card-value">---</div>
      </div>

      <div class="card">
        <h3>Last Updated</h3>
        <div id="lastUpdated" class="card-value">---</div>
      </div>
    </div>

    <div class="card">
      <h3>Household Distribution per Barangay</h3>
      <canvas id="barangayChart" height="140"></canvas>
    </div>

  </main>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="app.js"></script>

<script>
/* DASHBOARD LOGIC */
document.addEventListener("DOMContentLoaded", async () => {
  // Auth check
  if (!localStorage.getItem("loggedIn")) return location.href = "login.html";

  document.getElementById("assignedBarangay").innerText =
    localStorage.getItem("assignedBarangay") || '---';
  document.getElementById("userName").innerText =
    localStorage.getItem("staffName") || "";

  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.clear();
    location.href = "login.html";
  });

  try {
    // === FIXED: call getRecords instead of list ===
    const response = await apiGet({ action: "getRecords" });

    if (!response || !response.rows) {
      console.error("Invalid API response:", response);
      return;
    }

    const rows = response.rows;

    // Count heads and members
    let headCount = 0;
    let memberCount = 0;

    rows.forEach(r => {
      if (String(r["RelationToHead"] || "").toLowerCase() === "head") {
        headCount++;
      } else {
        memberCount++;
      }
    });

    document.getElementById("totalHeads").innerText = headCount;
    document.getElementById("totalMembers").innerText = memberCount;

    // Last updated time
    document.getElementById("lastUpdated").innerText =
      new Date().toLocaleString();

    // Barangay distribution (heads + members)
    const barangayMap = {};

    rows.forEach(r => {
      const b = r["Barangay"] || "Unknown";
      if (!barangayMap[b]) barangayMap[b] = { heads: 0, members: 0 };

      if (String(r["RelationToHead"] || "").toLowerCase() === "head") {
        barangayMap[b].heads++;
      } else {
        barangayMap[b].members++;
      }
    });

    const brgyLabels = Object.keys(barangayMap);
    const brgyHeads = brgyLabels.map(b => barangayMap[b].heads);
    const brgyMembers = brgyLabels.map(b => barangayMap[b].members);

    // Draw chart
    const ctx = document.getElementById("barangayChart").getContext("2d");

    new Chart(ctx, {
      type: "bar",
      data: {
        labels: brgyLabels,
        datasets: [
          {
            label: "Household Heads",
            data: brgyHeads,
            backgroundColor: "#2b9348"
          },
          {
            label: "Household Members",
            data: brgyMembers,
            backgroundColor: "#55a630"
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

  } catch (err) {
    console.error("Dashboard Error:", err);
  }
});
</script>

</body>
</html>
