<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan ‚Äî Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
   :root{
    --bg:#f6f8f7;
    --card-bg:#fff;
    --muted:#6b6f6b;
    --accent1:#0f7a4a;
    --accent2:#34b78f;
    --accent3: #ff7a00;
    --accent4: #ffa500;
    --light-green: #e9f7f2;
    --border: #e1e8e5;
    --shadow: 0 6px 18px rgba(6,30,20,0.06);
    --shadow-dark: 0 6px 20px rgba(5,40,25,0.12);
    --radius:12px;
    --radius-sm:8px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
   }

   body {
    background-color: var(--bg);
    margin: 0;
    min-height: 100vh;
   }

   .page-container{
    max-width:1200px;
    margin:20px auto;
    padding:12px;
    display:grid;
    grid-template-columns:260px 1fr;
    gap:18px;
    align-items:start;
    transition: grid-template-columns 0.3s ease;
   }

   .page-container.collapsed {
    grid-template-columns: 60px 1fr;
   }

   /* Topbar - Enhanced */
   .topbar{
    grid-column:1/-1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
    border-radius:var(--radius);
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    box-shadow:var(--shadow-dark);
   }

   .brand{
    display:flex;
    gap:12px;
    align-items:center;
   }

   .brand .logo{
    width:48px;
    height:48px;
    border-radius:var(--radius-sm);
    object-fit:contain;
    background: rgba(255,255,255,0.1);
    padding: 4px;
    border: 2px solid rgba(255,255,255,0.2);
   }

   .brand-text h1 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
   }

   .brand-text p {
    font-size:12px;
    opacity:0.95;
    margin: 4px 0 0 0;
   }

   .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
   }

   #userName {
    font-weight: 600;
    background: rgba(255,255,255,0.1);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
   }

   #logoutBtn {
    background: rgba(255,255,255,0.15);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
   }

   #logoutBtn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
   }

   /* Sidebar - Collapsible */
   .sidebar{
    background:linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.20));
    border-radius:var(--radius);
    padding:12px;
    height:calc(100vh - 120px);
    position:sticky;
    top:72px;
    overflow:auto;
    transition: width 0.3s ease;
   }

   .sidebar-container {
    display: flex;
    flex-direction: column;
    height: 100%;
   }

   .sidebar-toggle {
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.3s ease;
   }

   .sidebar-toggle:hover {
    transform: scale(1.1);
   }

   .sidebar ul{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
    flex: 1;
   }

   .sidebar li a{
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    text-decoration: none;
    color: var(--muted);
    border-radius: var(--radius-sm);
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
   }

   .sidebar li a:hover{
    background: var(--light-green);
    color: var(--accent1);
   }

   .sidebar li a.active{
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .sidebar li a .menu-icon {
    font-size: 1.2rem;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
   }

   .sidebar li a .menu-text {
    transition: opacity 0.3s ease;
   }

   .page-container.collapsed .sidebar li a .menu-text {
    opacity: 0;
    width: 0;
    overflow: hidden;
   }

   /* Content Area - Fixed Size */
   .content-area{
    background:linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
    border-radius:var(--radius);
    padding:18px;
    box-shadow:0 8px 22px rgba(10,20,16,0.06);
    min-height:72vh;
    height: calc(100vh - 120px);
    overflow-y: auto;
   }

   /* Content Header - Fixed */
   .content-header {
    margin-top: 0;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
   }

   .content-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: var(--accent1);
    display: flex;
    align-items: center;
    gap: 8px;
   }

   /* Description Styling */
   #disc {
    margin-bottom: 10px;
    background: var(--light-green);
    padding: 12px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--accent1);
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.5;
   }

   .description p {
    margin: 0;
   }

   /* Dashboard Cards */
   .dashboard-cards{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:12px;
    margin:12px 0 18px 0;
   }

   .card{
    padding:16px;
    border-radius:var(--radius);
    background:var(--card-bg);
    box-shadow:var(--shadow);
    transition: transform 0.2s ease;
   }

   .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(6,30,20,0.1);
   }

   .card h3{ 
    margin:0 0 8px 0; 
    font-size:14px; 
    color:var(--accent1);
    font-weight: 600;
   }

   .card-value{ 
    font-size:22px; 
    font-weight:800; 
    color:#153b26;
    margin: 8px 0;
   }

   .mini { 
    font-size:13px; 
    color:var(--muted);
   }

   .stat-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
    gap:8px;
    margin-top: 12px;
   }

   /* Barangay Breakdown - FULL WIDTH STACK */
   .breakdown-section {
    margin-top: 24px;
    width: 100%;
   }

   .breakdown-section h3 {
    font-size: 1.2rem;
    color: var(--accent1);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--light-green);
    display: flex;
    align-items: center;
    gap: 8px;
   }

   .breakdown-table-container {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
    overflow-x: auto;
    width: 100%;
   }

   .breakdown-table {
    width: 100%;
    border-collapse: collapse;
    text-align: center;
    min-width: 600px;
   }

   .breakdown-table th {
    background: rgba(15,122,74,0.08);
    padding: 12px 10px;
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--accent1);
    border-bottom: 2px solid rgba(15,122,74,0.1);
    position: sticky;
    left: 0;
    white-space: nowrap;
   }

   .breakdown-table td {
    padding: 10px 8px;
    border-bottom: 1px solid rgba(15,122,74,0.08);
    font-size: 0.85rem;
    color: var(--muted);
   }

   .breakdown-table tbody tr:hover {
    background: rgba(52,183,143,0.05);
   }

   .breakdown-table th:first-child,
   .breakdown-table td:first-child {
    position: sticky;
    left: 0;
    background: var(--card-bg);
    z-index: 1;
    text-align: left;
    font-weight: 600;
    color: var(--accent1);
   }

   .breakdown-table th:first-child {
    background: rgba(15,122,74,0.1);
   }

   /* Legend Box */
   .legend-box{
    margin-top:16px;
    display:inline-block;
    background:#fff;
    padding:12px;
    border-radius:var(--radius-sm);
    border:1px solid rgba(6,30,20,0.04);
    box-shadow:0 4px 14px rgba(6,30,20,0.06);
   }

   .legend-box h4 {
    margin: 0 0 8px 0;
    font-size: 0.9rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 6px;
   }

   .legend-item{
    display:flex;
    gap:8px;
    align-items:center;
    margin:6px 0;
    font-size:0.8rem;
   }

   .legend-swatch{
    width:14px;
    height:14px;
    border-radius:4px;
    flex-shrink: 0;
   }

   /* Button styling */
   .btn {
    border:0;
    padding:10px 14px;
    border-radius:var(--radius-sm);
    cursor:pointer;
    font-weight:600;
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    white-space: nowrap;
   }

   .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   /* Mobile Styles */
   @media (max-width: 768px) {
    .page-container {
        grid-template-columns: 1fr !important;
        padding: 8px;
        gap: 12px;
    }
    
    .page-container.collapsed {
        grid-template-columns: 1fr !important;
    }
    
    .sidebar {
        position: fixed;
        top: 72px;
        left: 0;
        right: 0;
        height: auto;
        max-height: 0;
        overflow: hidden;
        z-index: 1000;
        margin: 0;
        padding: 0;
        border-radius: 0 0 var(--radius) var(--radius);
        background: white;
        box-shadow: var(--shadow);
        transition: max-height 0.3s ease;
    }
    
    .sidebar.mobile-open {
        max-height: 300px;
        padding: 12px;
        overflow-y: auto;
    }
    
    .sidebar-container {
        flex-direction: column;
    }
    
    .sidebar-toggle {
        display: none;
    }
    
    .mobile-menu-toggle {
        display: flex !important;
        background: linear-gradient(135deg, var(--accent1), var(--accent2));
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        width: 40px;
        height: 40px;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
    }
    
    .content-area {
        height: auto;
        min-height: calc(100vh - 140px);
    }
    
    .dashboard-cards {
        grid-template-columns: 1fr;
    }
    
    .stat-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .category-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .breakdown-table-container {
        padding: 12px;
        margin-bottom: 16px;
    }
    
    .breakdown-table {
        min-width: 800px;
    }
    
    .user-info {
        gap: 8px;
    }
    
    #userName {
        font-size: 0.9rem;
        padding: 6px 12px;
    }
    
    #logoutBtn {
        padding: 6px 12px;
        font-size: 0.85rem;
    }
   }

   /* Mobile menu toggle button */
   .mobile-menu-toggle {
    display: none;
   }

   /* Loading overlay */
   #loading {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(255,255,255,0.85);
    align-items:center;
    justify-content:center;
    z-index:9999;
    backdrop-filter: blur(2px);
   }

   .loading-content {
    background:#fff;
    padding:20px 24px;
    border-radius:var(--radius);
    box-shadow:var(--shadow-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
   }

   .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent1);
    border-radius: 50%;
    animation: spin 1s linear infinite;
   }

   @keyframes spin {
    to { transform: rotate(360deg); }
   }

   /* Chart container */
   .chart-container {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 20px 0;
    box-shadow: var(--shadow);
   }

   .chart-container h3 {
    margin: 0 0 16px 0;
    font-size: 1rem;
    color: var(--accent1);
    font-weight: 600;
   }

   /* Category Grid for Education, Employment, Job Categories, OFW */
   .category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
    margin-top: 10px;
   }
   
   .category-card {
    padding: 12px;
    background: var(--card-bg);
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow);
    transition: transform 0.2s ease;
   }
   
   .category-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(6,30,20,0.1);
   }
   
   .category-label {
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 5px;
    font-weight: 500;
   }
   
   .category-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent1);
   }
   
   /* Section headers */
   .category-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
   }
   
   .category-section h4 {
    margin: 0 0 12px 0;
    font-size: 1rem;
    color: var(--accent1);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
   }
</style>
</head>

<body>
<div class="page-container">

  <header class="topbar">
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div class="brand-text">
        <h1>PUROK KALIGTASAN</h1>
        <p>MDRRMO Alitagtag Household Records System</p>
      </div>
    </div>

    <div class="user-info">
      <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
      </button>
      <span id="userName"></span>
      <button id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-container">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul>
        <li><a href="dashboard.html" class="active" title="Dashboard"><span class="menu-icon">üìä</span> <span class="menu-text">Dashboard</span></a></li>
        <li><a href="dataForm.html" title="Data Entry"><span class="menu-icon">üìù</span> <span class="menu-text">Data Entry</span></a></li>
        <li><a href="records.html" title="Records"><span class="menu-icon">üìÅ</span> <span class="menu-text">Records</span></a></li>
        <li><a href="charts.html" title="Charts"><span class="menu-icon">üìà</span> <span class="menu-text">Charts</span></a></li>
        <li class="admin-only"><a href="users.html" title="User Management"><span class="menu-icon">üë•</span> <span class="menu-text">User Management</span></a></li>
      </ul>
    </div>
  </aside>

  <main class="content-area">
    <div class="content-header">
      <h2><span style="color: var(--accent1);">üìä</span> Dashboard Overview</h2>
    </div>

    <!-- Description -->
<div id="disc">This section presents a complete summary of all data recorded in the Purok Kaligtasan database. It provides quick insights into household profiles, population details, vulnerable groups, domestic animals, resources, and other important information gathered from the community. The dashboard helps users monitor trends, review totals at a glance, and easily understand the overall status of the purok for planning, reporting, and emergency response.</div>

    <!-- Top Cards -->
    <div class="breakdown-section">
      <h3><i class="fas fa-table"></i> Alitagtag Data Overview</h3></div>
    <div class="dashboard-cards">
      <div class="card">
        <h3>Total Household Heads</h3>
        <div id="totalHeads" class="card-value">0</div>
        <div class="mini">(rows without member name)</div>
      </div>

      <div class="card">
        <h3>Total Household Members</h3>
        <div id="totalMembers" class="card-value">0</div>
        <div class="mini">(all member rows)</div>
      </div>

      <div class="card">
        <h3>Households with Coordinates</h3>
        <div id="withCoords" class="card-value">0</div>
        <div class="mini">Heads that provided lat,lng</div>
      </div>

      <div class="card">
        <h3>Last Updated</h3>
        <div id="lastUpdated" class="card-value">---</div>
        <div class="mini">(m/d/yyyy hh:mm:ss AM/PM)</div>
      </div>
    </div>

    <!-- Basic Population Overview -->
    <div class="card">
      <h3>Basic Population Overview</h3>
      <div class="stat-grid" id="quickStats"></div>
    </div>

    <!-- Educational Attainment Section -->
    <div class="card">
      <h3>Educational Attainment</h3>
      <div class="category-grid" id="educationStats"></div>
    </div>

    <!-- Employment Status Section -->
    <div class="card">
      <h3>Employment Status</h3>
      <div class="category-grid" id="employmentStats"></div>
    </div>

    <!-- Job Categories Section -->
    <div class="card">
      <h3>Job Categories</h3>
      <div class="category-grid" id="jobCategoriesStats"></div>
    </div>

    <!-- OFW Countries Section -->
    <div class="card">
      <h3>OFW Countries</h3>
      <div class="category-grid" id="ofwCountriesStats"></div>
    </div>

    <!-- Chart Container -->
    <div class="chart-container">
      <h3>Household Distribution Within Alitagtag</h3>
      <canvas id="barangayChart" height="160"></canvas>
    </div>

    <!-- Barangay Breakdown Section -->
    <div class="breakdown-section">
      <h3><i class="fas fa-table"></i> Barangay Data Overview</h3>

      <!-- 1. Barangay Summary -->
      <div class="breakdown-table-container">
        <h4>Demographics & Location Availability</h4>
        <table class="breakdown-table" id="tblSummary">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>PWD</th>
              <th>Male</th>
              <th>Female</th>
              <th>With Coordinates</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 2. Government Support -->
      <div class="breakdown-table-container">
        <h4>Government Assistance Programs</h4>
        <table class="breakdown-table" id="tblSupport">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>TUPAD</th>
              <th>Local 4Ps</th>
              <th>National 4Ps</th>
              <th>Local SP</th>
              <th>National SP</th>
              <th>Solo Parent</th>
              <th>Relief Goods</th>
              <th>Cash Subsidy</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 3. Status Breakdown -->
      <div class="breakdown-table-container">
        <h4>Household Status</h4>
        <table class="breakdown-table" id="tblStatus">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>With Sickness</th>
              <th>Pregnant</th>
              <th>Solo Parent</th>
              <th>Lactating</th>
              <th>Severe Illness</th>
              <th>HIV Positive</th>
              <th>LGBTQ+</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 4. Age Buckets -->
      <div class="breakdown-table-container">
        <h4>Population Age Groups</h4>
        <table class="breakdown-table" id="tblAge">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>0-5</th>
              <th>6-17</th>
              <th>18-59</th>
              <th>60+</th>
               <th>Unspecified</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 5. Sitio/Purok Distribution -->
      <div class="breakdown-table-container">
        <h4>Sitio / Purok Summary</h4>
        <table class="breakdown-table" id="tblSitio">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>I</th>
              <th>II</th>
              <th>III</th>
              <th>IV</th>
              <th>V</th>
              <th>VI</th>
              <th>VII</th>
              <th>Unspecified</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 6. Household Livestock (removed Others column) -->
      <div class="breakdown-table-container">
        <h4>Domestic Livestock</h4>
        <table class="breakdown-table" id="tblLivestock">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>Dog (qty)</th>
              <th>Cat (qty)</th>
              <th>Pig (qty)</th>
              <th>Cow (qty)</th>
              <th>Carabao (qty)</th>
              <th>Chicken (qty)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 7. Barangay Educational Attainment -->
      <div class="breakdown-table-container">
        <h4>Educational Attainment by Barangay</h4>
        <table class="breakdown-table" id="tblBarangayEducation">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>No Formal Education</th>
              <th>Elementary Level</th>
              <th>Elementary Graduate</th>
              <th>Junior High School Level</th>
              <th>Junior High School Graduate</th>
              <th>Senior High School Level</th>
              <th>Senior High School Graduate</th>
              <th>College Level</th>
              <th>College Graduate</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 8. Barangay Employment -->
      <div class="breakdown-table-container">
        <h4>Employment Status by Barangay</h4>
        <table class="breakdown-table" id="tblBarangayEmployment">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>Employed</th>
              <th>Unemployed</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 9. Barangay OFW Countries -->
      <div class="breakdown-table-container">
        <h4>OFW Countries by Barangay</h4>
        <table class="breakdown-table" id="tblBarangayOFW">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>Saudi Arabia</th>
              <th>United Arab Emirates</th>
              <th>Qatar</th>
              <th>Kuwait</th>
              <th>Bahrain</th>
              <th>Oman</th>
              <th>Hong Kong</th>
              <th>Singapore</th>
              <th>Japan</th>
              <th>Taiwan</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div><!-- end breakdown-section -->

    <div class="small-muted" style="margin-top: 20px; font-size:12px; color:var(--muted);">
      Tip: Data auto-refreshes every 30 seconds. Tables are responsive and optimized for all devices.
    </div>

  </main>
</div>

<!-- Loading overlay -->
<div id="loading">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div>Loading dashboard data‚Ä¶</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
/* CONFIG */
const API_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";
let chart = null;
let lastUpdatedTime = null;
let refreshInterval = null;

/* helpers */
function getField(obj, name){
  if(!obj) return "";
  const want = String(name).toLowerCase().trim();
  for(const k of Object.keys(obj)){
    if(String(k).toLowerCase().trim() === want) return obj[k];
  }
  return "";
}

function formatTS(date){
  if(!date) date = new Date();
  const m = date.getMonth()+1;
  const d = date.getDate();
  const y = date.getFullYear();
  let hh = date.getHours();
  const mm = String(date.getMinutes()).padStart(2,'0');
  const ss = String(date.getSeconds()).padStart(2,'0');
  const ampm = hh>=12 ? 'PM' : 'AM';
  hh = hh%12; hh = hh? hh:12;
  return `${m}/${d}/${y} ${String(hh).padStart(2,'0')}:${mm}:${ss} ${ampm}`;
}

async function fetchRecords(){ 
  const res = await fetch(`${API_URL}?action=getRecords`); 
  return res.json(); 
}

function destroyChart(){ 
  if(chart){ 
    try{ chart.destroy(); }catch(e){} 
    chart = null; 
  } 
}

function showLoading(yes){ 
  document.getElementById("loading").style.display = yes ? "flex" : "none"; 
}

/* Load and store last updated time */
async function loadLastUpdated() {
  try {
    const storedTime = localStorage.getItem('lastDataUpdate');
    if (storedTime) {
      lastUpdatedTime = new Date(storedTime);
      document.getElementById('lastUpdated').innerText = formatTS(lastUpdatedTime);
    }
  } catch(err) {
    console.error('Error loading last updated time:', err);
  }
}

/* Update last updated time when data changes */
function updateLastUpdated() {
  lastUpdatedTime = new Date();
  localStorage.setItem('lastDataUpdate', lastUpdatedTime.toISOString());
  document.getElementById('lastUpdated').innerText = formatTS(lastUpdatedTime);
}

/* main dashboard load */
async function loadDashboard(){
  showLoading(true);
  try{
    const data = await fetchRecords();
    if(!data.success) throw new Error('Failed fetch');
    const rows = data.rows || [];

    // init containers
    let totalHeads = 0, totalMembers = 0, headsWithCoords = 0;
    const barangayMap = {};
    
    // Initialize statistics
    const overallEducation = {
      noFormalEducation: 0,
      elementaryLevel: 0,
      elementaryGraduate: 0,
      juniorHighSchoolLevel: 0,
      juniorHighSchoolGraduate: 0,
      seniorHighSchoolLevel: 0,
      seniorHighSchoolGraduate: 0,
      collegeLevel: 0,
      collegeGraduate: 0
    };
    
    const overallEmployment = {
      employed: 0,
      unemployed: 0
    };
    
    const jobCategories = {
      adminAssistant: 0,
      officeClerk: 0,
      secretary: 0,
      projectManager: 0,
      operationsManager: 0,
      hrStaff: 0,
      accountManager: 0,
      accountingStaff: 0,
      bookkeeper: 0,
      payrollOfficer: 0,
      auditor: 0,
      itSupport: 0,
      webDeveloper: 0,
      softwareDeveloper: 0,
      dataAnalyst: 0,
      systemAdministrator: 0,
      nurse: 0,
      medicalTechnologist: 0,
      caregiver: 0,
      pharmacist: 0,
      teacher: 0,
      tutor: 0,
      schoolAdministrator: 0,
      csr: 0,
      salesAssociate: 0,
      cashier: 0,
      storeSupervisor: 0,
      electrician: 0,
      plumber: 0,
      welder: 0,
      constructionWorker: 0,
      driver: 0,
      logisticsStaff: 0,
      rider: 0,
      cook: 0,
      waiter: 0,
      barista: 0,
      housekeepingStaff: 0,
      securityGuard: 0,
      barangayStaff: 0,
      policeOfficer: 0,
      fireOfficer: 0,
      graphicDesigner: 0,
      videoEditor: 0,
      contentWriter: 0,
      socialMediaManager: 0
    };
    
    const ofwCountries = {
      saudiArabia: 0,
      uae: 0,
      qatar: 0,
      kuwait: 0,
      bahrain: 0,
      oman: 0,
      hongKong: 0,
      singapore: 0,
      japan: 0,
      taiwan: 0,
      malaysia: 0,
      australia: 0,
      newZealand: 0,
      italy: 0,
      uk: 0,
      germany: 0,
      cyprus: 0,
      canada: 0,
      usa: 0,
      libya: 0,
      others: 0
    };

    rows.forEach(r=>{
      const isHead = String(getField(r,'Name of Household Member/s')||'').trim() === '';
      const barangay = String(getField(r,'Barangay')||'Unknown').trim() || 'Unknown';
      const sex = String(getField(r,'Sex')||'').trim().toLowerCase();
      const coord = String(getField(r,'Coordinate')||'').trim();

      if(!barangayMap[barangay]){
        barangayMap[barangay] = {
          heads:0, members:0, male:0, female:0, coords:0, pwds:0,
          status:{}, reasons:{}, livestock:{}, ageBuckets:{}, sitio:{},
          support: {
            "TUPAD":0, "Local 4Ps":0, "National 4Ps":0, "Local Social Pension":0, "National Social Pension":0,
            "Solo Parent Assistance":0, "Relief Goods":0, "Cash Subsidy":0
          },
          education: {
            noFormalEducation: 0,
            elementaryLevel: 0,
            elementaryGraduate: 0,
            juniorHighSchoolLevel: 0,
            juniorHighSchoolGraduate: 0,
            seniorHighSchoolLevel: 0,
            seniorHighSchoolGraduate: 0,
            collegeLevel: 0,
            collegeGraduate: 0
          },
          employment: {
            employed: 0,
            unemployed: 0
          },
          ofw: {
            saudiArabia: 0,
            uae: 0,
            qatar: 0,
            kuwait: 0,
            bahrain: 0,
            oman: 0,
            hongKong: 0,
            singapore: 0,
            japan: 0,
            taiwan: 0
          }
        };
      }
      const b = barangayMap[barangay];

      if(isHead){ 
        totalHeads++; 
        b.heads++; 
        // FIXED: Count coordinates correctly
        if(coord && coord.trim() !== '' && coord !== 'N/A' && coord !== 'none') { 
          headsWithCoords++; 
          b.coords++; 
        } 
      } else { 
        totalMembers++; 
        b.members++; 
      }

      // sex
      if(sex === 'male') b.male++; 
      else if(sex === 'female') b.female++;

      // PWD
      if(String(getField(r,'Persons with Disability (PWD)')||'').toLowerCase().trim()==='yes') b.pwds++;

      // STATUS accumulation
      const statusRaw = String(getField(r,'Status')||'').trim();
      if(statusRaw){
        b.status[statusRaw] = (b.status[statusRaw]||0) + 1;
      }

      // Reasons
      const reason = String(getField(r,'Reasons for Displacement')||'').trim();
      if(reason) b.reasons[reason] = (b.reasons[reason]||0) + 1;

      // Sitio / Purok
      const sitioRaw = String(getField(r,'Sitio / Purok')||'').trim();
      let sitioKey = 'Unknown';
      if(sitioRaw){
        const m = sitioRaw.match(/I{1,3}|IV|V|VI|VII|\b1\b|\b2\b|\b3\b|\b4\b|\b5\b|\b6\b|\b7\b/i);
        if(m){
          sitioKey = m[0].toString().replace(/\b1\b/,'I').replace(/\b2\b/,'II').replace(/\b3\b/,'III').replace(/\b4\b/,'IV').replace(/\b5\b/,'V').replace(/\b6\b/,'VI').replace(/\b7\b/,'VII').toUpperCase();
        } else {
          sitioKey = sitioRaw;
        }
      }
      b.sitio[sitioKey] = (b.sitio[sitioKey]||0) + 1;

      // Livestock - FIXED: Removed Others column
      const livestockKeys = ['Dog','Dog Qty.','Cat','Cat Qty.','Pig','Pig Qty.','Cow','Cow Qty.','Carabao','Carabao Qty.','Chicken','Chicken Qty.'];
      livestockKeys.forEach(key=>{
        const val = String(getField(r,key) || '').trim();
        if(!val) return;
        if(key.toLowerCase().includes('qty')){
          const animal = key.replace(/\s*Qty\.?$/i,'').trim();
          const n = Number(val) || 0;
          if(!b.livestock[animal]) b.livestock[animal] = {qty:0, count:0};
          b.livestock[animal].qty += n;
        } else {
          if(String(val).toLowerCase() === 'yes'){
            if(!b.livestock[key]) b.livestock[key] = {qty:0, count:0};
            b.livestock[key].count += 1;
          } else if(!isNaN(Number(val)) && val !== ''){
            if(!b.livestock[key]) b.livestock[key] = {qty:0, count:0};
            b.livestock[key].qty += Number(val);
          }
        }
      });

      // Government support flags
      ['TUPAD','Local 4Ps','National 4Ps','Local Social Pension','National Social Pension','Solo Parent Assistance','Relief Goods','Cash Subsidy'].forEach(k=>{
        if(String(getField(r,k)||'').toLowerCase().trim() === 'yes'){
          b.support[k] = (b.support[k]||0) + 1;
        }
      });

      // Age buckets
      const ageField = String(getField(r,'Age')||'').trim();
      let y = null;
      if(ageField){
        const m = ageField.match(/(\d+)/);
        if(m) y = Number(m[1]);
      }
      const ab = (y === null) ? 'Unknown' : (y <=5 ? '0-5' : y <=17 ? '6-17' : y <=59 ? '18-59' : '60+');
      b.ageBuckets[ab] = (b.ageBuckets[ab]||0) + 1;
      
      // Educational Attainment
      const educationField = String(getField(r,'Educational Attainment')||'').trim();
      if(educationField) {
        const eduLower = educationField.toLowerCase();
        
        if(eduLower.includes('no formal') || eduLower === 'none' || eduLower === 'no education') {
          b.education.noFormalEducation++;
          overallEducation.noFormalEducation++;
        }
        else if(eduLower.includes('elementary level') || eduLower === 'elementary undergraduate') {
          b.education.elementaryLevel++;
          overallEducation.elementaryLevel++;
        }
        else if(eduLower.includes('elementary graduate') || eduLower === 'elementary') {
          b.education.elementaryGraduate++;
          overallEducation.elementaryGraduate++;
        }
        else if(eduLower.includes('junior high school level') || eduLower.includes('junior high level') || eduLower === 'junior high') {
          b.education.juniorHighSchoolLevel++;
          overallEducation.juniorHighSchoolLevel++;
        }
        else if(eduLower.includes('junior high school graduate') || eduLower.includes('junior high graduate') || eduLower === 'junior high grad') {
          b.education.juniorHighSchoolGraduate++;
          overallEducation.juniorHighSchoolGraduate++;
        }
        else if(eduLower.includes('senior high school level') || eduLower.includes('senior high level') || eduLower === 'senior high') {
          b.education.seniorHighSchoolLevel++;
          overallEducation.seniorHighSchoolLevel++;
        }
        else if(eduLower.includes('senior high school graduate') || eduLower.includes('senior high graduate') || eduLower === 'senior high grad') {
          b.education.seniorHighSchoolGraduate++;
          overallEducation.seniorHighSchoolGraduate++;
        }
        else if(eduLower.includes('college level') || eduLower === 'college undergraduate' || eduLower === 'college') {
          b.education.collegeLevel++;
          overallEducation.collegeLevel++;
        }
        else if(eduLower.includes('college graduate') || eduLower === 'college grad') {
          b.education.collegeGraduate++;
          overallEducation.collegeGraduate++;
        }
      }
      
      // Employment Status - FIXED: Now counting correctly
      const employmentField = String(getField(r,'Employment Status')||'').trim().toLowerCase();
      if(employmentField) {
        if(employmentField === 'employed' || employmentField === 'yes' || employmentField === 'working' || employmentField === 'employed (please specify job)') {
          b.employment.employed++;
          overallEmployment.employed++;
        } else if(employmentField === 'unemployed' || employmentField === 'no' || employmentField === 'not working' || employmentField === 'unemployed (please specify reason)') {
          b.employment.unemployed++;
          overallEmployment.unemployed++;
        }
      }
      
      // Job Title/Description
      const jobField = String(getField(r,'Job Title/Description')||'').trim();
      if(jobField && employmentField && (employmentField.includes('employed') || employmentField === 'yes' || employmentField === 'working')) {
        const jobLower = jobField.toLowerCase();
        
        if(jobLower.includes('administrative assistant') || jobLower.includes('admin assistant') || jobLower.includes('admin staff')) {
          jobCategories.adminAssistant++;
        }
        else if(jobLower.includes('office clerk') || jobLower === 'clerk') {
          jobCategories.officeClerk++;
        }
        else if(jobLower.includes('secretary') || jobLower.includes('executive assistant')) {
          jobCategories.secretary++;
        }
        else if(jobLower.includes('project manager')) {
          jobCategories.projectManager++;
        }
        else if(jobLower.includes('operations manager')) {
          jobCategories.operationsManager++;
        }
        else if(jobLower.includes('hr staff') || jobLower.includes('hr officer') || jobLower.includes('human resources')) {
          jobCategories.hrStaff++;
        }
        else if(jobLower.includes('account manager')) {
          jobCategories.accountManager++;
        }
        else if(jobLower.includes('accounting staff') || jobLower.includes('accountant')) {
          jobCategories.accountingStaff++;
        }
        else if(jobLower.includes('bookkeeper') || jobLower.includes('book keeping')) {
          jobCategories.bookkeeper++;
        }
        else if(jobLower.includes('payroll officer') || jobLower.includes('payroll')) {
          jobCategories.payrollOfficer++;
        }
        else if(jobLower.includes('auditor')) {
          jobCategories.auditor++;
        }
        else if(jobLower.includes('it support') || jobLower.includes('it technician') || jobLower === 'it') {
          jobCategories.itSupport++;
        }
        else if(jobLower.includes('web developer') || jobLower.includes('web dev')) {
          jobCategories.webDeveloper++;
        }
        else if(jobLower.includes('software developer') || jobLower.includes('programmer') || jobLower.includes('coder')) {
          jobCategories.softwareDeveloper++;
        }
        else if(jobLower.includes('data analyst')) {
          jobCategories.dataAnalyst++;
        }
        else if(jobLower.includes('system administrator') || jobLower.includes('system admin')) {
          jobCategories.systemAdministrator++;
        }
        else if(jobLower.includes('nurse') || jobLower.includes('registered nurse')) {
          jobCategories.nurse++;
        }
        else if(jobLower.includes('medical technologist') || jobLower.includes('med tech')) {
          jobCategories.medicalTechnologist++;
        }
        else if(jobLower.includes('caregiver')) {
          jobCategories.caregiver++;
        }
        else if(jobLower.includes('pharmacist')) {
          jobCategories.pharmacist++;
        }
        else if(jobLower.includes('teacher') || jobLower.includes('instructor') || jobLower.includes('faculty')) {
          jobCategories.teacher++;
        }
        else if(jobLower.includes('tutor')) {
          jobCategories.tutor++;
        }
        else if(jobLower.includes('school administrator') || jobLower.includes('principal')) {
          jobCategories.schoolAdministrator++;
        }
        else if(jobLower.includes('customer service') || jobLower.includes('csr') || jobLower.includes('call center')) {
          jobCategories.csr++;
        }
        else if(jobLower.includes('sales associate') || jobLower.includes('salesperson') || jobLower.includes('sales agent')) {
          jobCategories.salesAssociate++;
        }
        else if(jobLower.includes('cashier')) {
          jobCategories.cashier++;
        }
        else if(jobLower.includes('store supervisor') || jobLower.includes('store manager')) {
          jobCategories.storeSupervisor++;
        }
        else if(jobLower.includes('electrician')) {
          jobCategories.electrician++;
        }
        else if(jobLower.includes('plumber')) {
          jobCategories.plumber++;
        }
        else if(jobLower.includes('welder')) {
          jobCategories.welder++;
        }
        else if(jobLower.includes('construction worker') || jobLower.includes('skilled laborer') || jobLower.includes('laborer')) {
          jobCategories.constructionWorker++;
        }
        else if(jobLower.includes('driver') || jobLower.includes('delivery driver') || jobLower.includes('truck driver')) {
          jobCategories.driver++;
        }
        else if(jobLower.includes('logistics staff') || jobLower.includes('logistics')) {
          jobCategories.logisticsStaff++;
        }
        else if(jobLower.includes('rider') || jobLower.includes('motorcycle delivery') || jobLower.includes('foodpanda') || jobLower.includes('grab')) {
          jobCategories.rider++;
        }
        else if(jobLower.includes('cook') || jobLower.includes('chef')) {
          jobCategories.cook++;
        }
        else if(jobLower.includes('waiter') || jobLower.includes('service crew') || jobLower.includes('waitress')) {
          jobCategories.waiter++;
        }
        else if(jobLower.includes('barista')) {
          jobCategories.barista++;
        }
        else if(jobLower.includes('housekeeping') || jobLower.includes('housekeeper')) {
          jobCategories.housekeepingStaff++;
        }
        else if(jobLower.includes('security guard') || jobLower.includes('guard')) {
          jobCategories.securityGuard++;
        }
        else if(jobLower.includes('barangay staff') || jobLower.includes('barangay council') || jobLower.includes('barangay official')) {
          jobCategories.barangayStaff++;
        }
        else if(jobLower.includes('police officer') || jobLower.includes('policeman') || jobLower.includes('police')) {
          jobCategories.policeOfficer++;
        }
        else if(jobLower.includes('fire officer') || jobLower.includes('fireman') || jobLower.includes('firefighter')) {
          jobCategories.fireOfficer++;
        }
        else if(jobLower.includes('graphic designer') || jobLower.includes('graphics designer')) {
          jobCategories.graphicDesigner++;
        }
        else if(jobLower.includes('video editor') || jobLower.includes('video editing')) {
          jobCategories.videoEditor++;
        }
        else if(jobLower.includes('content writer') || jobLower.includes('writer')) {
          jobCategories.contentWriter++;
        }
        else if(jobLower.includes('social media manager') || jobLower.includes('social media')) {
          jobCategories.socialMediaManager++;
        }
      }
      
      // OFW Country
      const ofwField = String(getField(r,'Overseas Filipino Worker (OFW)')||'').trim().toLowerCase();
      if(ofwField === 'yes') {
        const countryField = String(getField(r,'Country')||'').trim().toLowerCase();
        
        if(countryField.includes('saudi')) {
          ofwCountries.saudiArabia++;
          b.ofw.saudiArabia++;
        } else if(countryField.includes('uae') || countryField.includes('united arab emirates')) {
          ofwCountries.uae++;
          b.ofw.uae++;
        } else if(countryField.includes('qatar')) {
          ofwCountries.qatar++;
          b.ofw.qatar++;
        } else if(countryField.includes('kuwait')) {
          ofwCountries.kuwait++;
          b.ofw.kuwait++;
        } else if(countryField.includes('bahrain')) {
          ofwCountries.bahrain++;
          b.ofw.bahrain++;
        } else if(countryField.includes('oman')) {
          ofwCountries.oman++;
          b.ofw.oman++;
        } else if(countryField.includes('hong kong')) {
          ofwCountries.hongKong++;
          b.ofw.hongKong++;
        } else if(countryField.includes('singapore')) {
          ofwCountries.singapore++;
          b.ofw.singapore++;
        } else if(countryField.includes('japan')) {
          ofwCountries.japan++;
          b.ofw.japan++;
        } else if(countryField.includes('taiwan')) {
          ofwCountries.taiwan++;
          b.ofw.taiwan++;
        } else if(countryField.includes('malaysia')) {
          ofwCountries.malaysia++;
        } else if(countryField.includes('australia')) {
          ofwCountries.australia++;
        } else if(countryField.includes('new zealand')) {
          ofwCountries.newZealand++;
        } else if(countryField.includes('italy')) {
          ofwCountries.italy++;
        } else if(countryField.includes('uk') || countryField.includes('united kingdom')) {
          ofwCountries.uk++;
        } else if(countryField.includes('germany')) {
          ofwCountries.germany++;
        } else if(countryField.includes('cyprus')) {
          ofwCountries.cyprus++;
        } else if(countryField.includes('canada')) {
          ofwCountries.canada++;
        } else if(countryField.includes('usa') || countryField.includes('united states')) {
          ofwCountries.usa++;
        } else if(countryField.includes('libya')) {
          ofwCountries.libya++;
        } else if(countryField.trim() !== '') {
          ofwCountries.others++;
        }
      }
    });

    // Update top cards - FIXED: withCoords now shows correct count
    document.getElementById('totalHeads').innerText = totalHeads;
    document.getElementById('totalMembers').innerText = totalMembers;
    document.getElementById('withCoords').innerText = headsWithCoords;

    // Basic Population Overview
    const quick = document.getElementById('quickStats');
    quick.innerHTML = '';
    let totals = {male:0, female:0, pwd:0};
    Object.keys(barangayMap).forEach(bn=>{
      const s = barangayMap[bn];
      totals.male += s.male; 
      totals.female += s.female; 
      totals.pwd += s.pwds;
    });

    // show male/female/pwd
    [['Male', totals.male], ['Female', totals.female], ['PWD', totals.pwd]].forEach(it=>{
      const div = document.createElement('div'); 
      div.className = 'category-card'; 
      div.innerHTML = `<div class="category-label">${it[0]}</div><div class="category-value">${it[1]}</div>`;
      quick.appendChild(div);
    });

    // Educational Attainment Section
    const educationStats = document.getElementById('educationStats');
    educationStats.innerHTML = '';
    
    const educationLabels = {
      noFormalEducation: 'No Formal Education',
      elementaryLevel: 'Elementary Level',
      elementaryGraduate: 'Elementary Graduate',
      juniorHighSchoolLevel: 'Junior High School Level',
      juniorHighSchoolGraduate: 'Junior High School Graduate',
      seniorHighSchoolLevel: 'Senior High School Level',
      seniorHighSchoolGraduate: 'Senior High School Graduate',
      collegeLevel: 'College Level',
      collegeGraduate: 'College Graduate'
    };
    
    Object.entries(educationLabels).forEach(([key, label]) => {
      const count = overallEducation[key] || 0;
      if(count > 0) {
        const div = document.createElement('div'); 
        div.className = 'category-card'; 
        div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
        educationStats.appendChild(div);
      }
    });
    
    // Employment Status Section - FIXED: Now showing totals correctly
    const employmentStats = document.getElementById('employmentStats');
    employmentStats.innerHTML = '';
    
    // Always show both employed and unemployed
    ['Employed', 'Unemployed'].forEach(status => {
      const count = status === 'Employed' ? overallEmployment.employed : overallEmployment.unemployed;
      const div = document.createElement('div'); 
      div.className = 'category-card'; 
      div.innerHTML = `<div class="category-label">${status}</div><div class="category-value">${count}</div>`;
      employmentStats.appendChild(div);
    });
    
    // Job Categories Section (Don't Show Others)
    const jobCategoriesStats = document.getElementById('jobCategoriesStats');
    jobCategoriesStats.innerHTML = '';
    
    const jobLabels = {
      adminAssistant: 'Admin Assistant',
      officeClerk: 'Office Clerk',
      secretary: 'Secretary',
      projectManager: 'Project Manager',
      operationsManager: 'Operations Manager',
      hrStaff: 'HR Staff',
      accountManager: 'Account Manager',
      accountingStaff: 'Accounting Staff',
      bookkeeper: 'Bookkeeper',
      payrollOfficer: 'Payroll Officer',
      auditor: 'Auditor',
      itSupport: 'IT Support',
      webDeveloper: 'Web Developer',
      softwareDeveloper: 'Software Developer',
      dataAnalyst: 'Data Analyst',
      systemAdministrator: 'System Admin',
      nurse: 'Nurse',
      medicalTechnologist: 'Medical Technologist',
      caregiver: 'Caregiver',
      pharmacist: 'Pharmacist',
      teacher: 'Teacher',
      tutor: 'Tutor',
      schoolAdministrator: 'School Admin',
      csr: 'CSR',
      salesAssociate: 'Sales Associate',
      cashier: 'Cashier',
      storeSupervisor: 'Store Supervisor',
      electrician: 'Electrician',
      plumber: 'Plumber',
      welder: 'Welder',
      constructionWorker: 'Construction Worker',
      driver: 'Driver',
      logisticsStaff: 'Logistics Staff',
      rider: 'Rider',
      cook: 'Cook',
      waiter: 'Waiter',
      barista: 'Barista',
      housekeepingStaff: 'Housekeeping',
      securityGuard: 'Security Guard',
      barangayStaff: 'Barangay Staff',
      policeOfficer: 'Police Officer',
      fireOfficer: 'Fire Officer',
      graphicDesigner: 'Graphic Designer',
      videoEditor: 'Video Editor',
      contentWriter: 'Content Writer',
      socialMediaManager: 'Social Media Manager'
    };
    
    Object.entries(jobLabels).forEach(([key, label]) => {
      const count = jobCategories[key] || 0;
      if(count > 0) {
        const div = document.createElement('div'); 
        div.className = 'category-card'; 
        div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
        jobCategoriesStats.appendChild(div);
      }
    });
    
    // OFW Countries Section (show only when there's data)
    const ofwCountriesStats = document.getElementById('ofwCountriesStats');
    ofwCountriesStats.innerHTML = '';
    
    const ofwLabels = {
      saudiArabia: 'Saudi Arabia',
      uae: 'United Arab Emirates',
      qatar: 'Qatar',
      kuwait: 'Kuwait',
      bahrain: 'Bahrain',
      oman: 'Oman',
      hongKong: 'Hong Kong',
      singapore: 'Singapore',
      japan: 'Japan',
      taiwan: 'Taiwan',
      malaysia: 'Malaysia',
      australia: 'Australia',
      newZealand: 'New Zealand',
      italy: 'Italy',
      uk: 'United Kingdom',
      germany: 'Germany',
      cyprus: 'Cyprus',
      canada: 'Canada',
      usa: 'USA',
      libya: 'Libya'
    };
    
    Object.entries(ofwLabels).forEach(([key, label]) => {
      const count = ofwCountries[key] || 0;
      if(count > 0) {
        const div = document.createElement('div'); 
        div.className = 'category-card'; 
        div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
        ofwCountriesStats.appendChild(div);
      }
    });

    // Chart: heads vs members per barangay
    destroyChart();
    const labels = Object.keys(barangayMap).sort();
    const headsData = labels.map(l => barangayMap[l].heads || 0);
    const membersData = labels.map(l => barangayMap[l].members || 0);
    const ctx = document.getElementById('barangayChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'bar',
      data: { 
        labels, 
        datasets: [
          { 
            label: 'Heads', 
            data: headsData, 
            backgroundColor: '#2b9348' 
          }, 
          { 
            label: 'Members', 
            data: membersData, 
            backgroundColor: '#55a630' 
          }
        ] 
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: true,
        plugins:{ 
          legend:{ 
            position:'bottom',
            labels: {
              padding: 20,
              usePointStyle: true
            }
          } 
        }, 
        scales:{ 
          y:{ 
            beginAtZero:true,
            ticks: {
              precision: 0
            }
          } 
        } 
      }
    });

    // Populate all breakdown tables
    // 1) Summary table
    const tbodySummary = document.querySelector('#tblSummary tbody'); 
    tbodySummary.innerHTML = '';
    labels.forEach(l => {
      const s = barangayMap[l];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td><td>${s.pwds||0}</td><td>${s.male||0}</td><td>${s.female||0}</td><td>${s.coords||0}</td>`;
      tbodySummary.appendChild(tr);
    });

    // 2) Government Support
    const supportKeys = ['TUPAD','Local 4Ps','National 4Ps','Local Social Pension','National Social Pension','Solo Parent Assistance','Relief Goods','Cash Subsidy'];
    const tbodySupport = document.querySelector('#tblSupport tbody'); 
    tbodySupport.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = supportKeys.map(k => s.support && s.support[k] ? s.support[k] : 0);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodySupport.appendChild(tr);
    });

    // 3) Status breakdown
    const statusKeys = ['With Sickness','Pregnant','Solo Parent','Lactating','Severe Illness','HIV Positive','LGBTQ Plus'];
    const tbodyStatus = document.querySelector('#tblStatus tbody'); 
    tbodyStatus.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = statusKeys.map(k => s.status && s.status[k] ? s.status[k] : 0);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodyStatus.appendChild(tr);
    });

    // 4) Age buckets
    const ageKeys = ['0-5','6-17','18-59','60+','Unknown'];
    const tbodyAge = document.querySelector('#tblAge tbody'); 
    tbodyAge.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = ageKeys.map(k => s.ageBuckets && s.ageBuckets[k] ? s.ageBuckets[k] : 0);
      const tr = document.createElement('tr'); 
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodyAge.appendChild(tr);
    });

    // 5) Sitio / Purok
    const sitios = ['I','II','III','IV','V','VI','VII','Unknown'];
    const tbodySitio = document.querySelector('#tblSitio tbody'); 
    tbodySitio.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = sitios.map(pk => s.sitio && s.sitio[pk] ? s.sitio[pk] : 0);
      const tr = document.createElement('tr'); 
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodySitio.appendChild(tr);
    });

    // 6) Livestock - FIXED: Removed Others column
    const tbodyLiv = document.querySelector('#tblLivestock tbody'); 
    tbodyLiv.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const animals = ['Dog','Cat','Pig','Cow','Carabao','Chicken'];
      const cells = animals.map(a => {
        const data = s.livestock && (s.livestock[a] || s.livestock[a==='Dog' ? 'Dog' : a]);
        if(!data) return 0;
        return (data.qty && data.qty > 0) ? data.qty : (data.count || 0);
      });
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodyLiv.appendChild(tr);
    });
    
    // 7) Barangay Educational Attainment
    const tbodyBarangayEducation = document.querySelector('#tblBarangayEducation tbody'); 
    tbodyBarangayEducation.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = [
        s.education.noFormalEducation || 0,
        s.education.elementaryLevel || 0,
        s.education.elementaryGraduate || 0,
        s.education.juniorHighSchoolLevel || 0,
        s.education.juniorHighSchoolGraduate || 0,
        s.education.seniorHighSchoolLevel || 0,
        s.education.seniorHighSchoolGraduate || 0,
        s.education.collegeLevel || 0,
        s.education.collegeGraduate || 0
      ];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodyBarangayEducation.appendChild(tr);
    });
    
    // 8) Barangay Employment - FIXED: Now showing correct totals
    const tbodyBarangayEmployment = document.querySelector('#tblBarangayEmployment tbody'); 
    tbodyBarangayEmployment.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td><td>${s.employment.employed || 0}</td><td>${s.employment.unemployed || 0}</td>`;
      tbodyBarangayEmployment.appendChild(tr);
    });
    
    // 9) Barangay OFW Countries
    const tbodyBarangayOFW = document.querySelector('#tblBarangayOFW tbody'); 
    tbodyBarangayOFW.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = [
        s.ofw.saudiArabia || 0,
        s.ofw.uae || 0,
        s.ofw.qatar || 0,
        s.ofw.kuwait || 0,
        s.ofw.bahrain || 0,
        s.ofw.oman || 0,
        s.ofw.hongKong || 0,
        s.ofw.singapore || 0,
        s.ofw.japan || 0,
        s.ofw.taiwan || 0
      ];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodyBarangayOFW.appendChild(tr);
    });

  } catch(err){
    console.error('Load dashboard error', err);
    alert('Error loading dashboard data');
  }
  showLoading(false);
}

/* SIDEBAR FUNCTIONS */
function toggleSidebar() {
    const pageContainer = document.querySelector('.page-container');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const icon = sidebarToggle.querySelector('i');
    
    pageContainer.classList.toggle('collapsed');
    
    if (pageContainer.classList.contains('collapsed')) {
        icon.className = 'fas fa-chevron-right';
        sidebarToggle.title = "Expand sidebar";
    } else {
        icon.className = 'fas fa-bars';
        sidebarToggle.title = "Collapse sidebar";
    }
}

function toggleMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    const icon = mobileToggle.querySelector('i');
    
    sidebar.classList.toggle('mobile-open');
    
    if (sidebar.classList.contains('mobile-open')) {
        icon.className = 'fas fa-times';
        mobileToggle.title = "Close menu";
    } else {
        icon.className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
}

/* Close mobile sidebar on click outside */
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    
    if (window.innerWidth <= 768) {
        if (!sidebar.contains(event.target) && !mobileToggle.contains(event.target) && sidebar.classList.contains('mobile-open')) {
            sidebar.classList.remove('mobile-open');
            mobileToggle.querySelector('i').className = 'fas fa-bars';
            mobileToggle.title = "Open menu";
        }
    }
});

/* WINDOW RESIZE HANDLER */
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        const sidebar = document.getElementById('sidebar');
        const mobileToggle = document.getElementById('mobileMenuToggle');
        
        sidebar.classList.remove('mobile-open');
        mobileToggle.querySelector('i').className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
});

/* session + ui */
async function sessionCheck(){
  try {
    const r = await fetch(API_URL + '?action=sessionCheck');
    const j = await r.json();
    if(!j.success) return window.location.href = 'index.html';
    
    const userName = j.fullName || localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
    document.getElementById('userName').innerText = userName;
    
    const isAdmin = j.role === 'Admin' || localStorage.getItem("userRole") === "admin";
    const adminItems = document.querySelectorAll(".admin-only");
    adminItems.forEach(item => {
        item.style.display = isAdmin ? "block" : "none";
    });
    
  } catch(e){ 
    console.warn('session check failed', e);
    const staffName = localStorage.getItem("staffName");
    if (!staffName) {
      window.location.href = 'index.html';
    } else {
      document.getElementById('userName').innerText = staffName;
      
      const isAdmin = localStorage.getItem("userRole") === "admin";
      const adminItems = document.querySelectorAll(".admin-only");
      adminItems.forEach(item => {
          item.style.display = isAdmin ? "block" : "none";
      });
    }
  }
}

/* Event Listeners */
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  localStorage.removeItem('lastDataUpdate');
  if (refreshInterval) clearInterval(refreshInterval);
  fetch(API_URL+'?action=logout'); 
  window.location.href='index.html'; 
});

// Desktop sidebar toggle
document.getElementById('sidebarToggle').onclick = toggleSidebar;

// Mobile sidebar toggle
document.getElementById('mobileMenuToggle').onclick = toggleMobileSidebar;

/* INITIALIZATION */
window.addEventListener('DOMContentLoaded', async ()=>{
  await sessionCheck();
  await loadLastUpdated();
  
  // FIXED: Automatically load data when dashboard is opened
  await loadDashboard();
  
  // FIXED: Auto-refresh every 30 seconds (instead of 5 minutes)
  if (refreshInterval) clearInterval(refreshInterval);
  refreshInterval = setInterval(loadDashboard, 30000);
  
  // Check screen width and adjust sidebar
  if (window.innerWidth <= 768) {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.remove('mobile-open');
  }
});

/* Listen for data changes from other pages - FIXED: Now properly loads data */
window.addEventListener('storage', function(e) {
  if (e.key === 'lastDataUpdate') {
    console.log('Data updated from another tab, reloading dashboard...');
    loadDashboard();
  }
});

/* FIXED: Also listen for visibility change to refresh when tab becomes active */
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    console.log('Tab became active, refreshing dashboard...');
    loadDashboard();
  }
});

function notifyDataUpdated() {
  updateLastUpdated();
  localStorage.setItem('lastDataUpdate', new Date().toISOString());
}
</script>
</body>
</html>
