<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<!-- CACHE PREVENTION HEADERS -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Dashboard ‚Äî Purok Kaligtasan</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
.admin-only {
    display: none !important;
}

/* Class to show admin elements - applied by JavaScript */
.admin-only.admin-visible {
    display: block !important;
}

/* For list items */
li.admin-only {
    display: none !important;
}

li.admin-only.admin-visible {
    display: list-item !important;
}
   :root{
    --bg:#f6f8f7;
    --card-bg:#fff;
    --muted:#6b6f6b;
    --accent1:#0f7a4a;
    --accent2:#34b78f;
    --accent3: #ff7a00;
    --accent4: #ffa500;
    --light-green: #e9f7f2;
    --border: #e1e8e5;
    --shadow: 0 6px 18px rgba(6,30,20,0.06);
    --shadow-dark: 0 6px 20px rgba(5,40,25,0.12);
    --radius:12px;
    --radius-sm:8px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
   }
   body {
    background-color: var(--bg);
    margin: 0;
    min-height: 100vh;
   }

   .page-container{
    max-width:1200px;
    margin:20px auto;
    padding:12px;
    display:grid;
    grid-template-columns:260px 1fr;
    gap:18px;
    align-items:start;
    transition: grid-template-columns 0.3s ease;
   }

   .page-container.collapsed {
    grid-template-columns: 60px 1fr;
   }

   /* Topbar - Enhanced */
   .topbar{
    grid-column:1/-1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
    border-radius:var(--radius);
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    box-shadow:var(--shadow-dark);
   }

   .brand{
    display:flex;
    gap:12px;
    align-items:center;
   }

   .brand .logo{
    width:60px;
    height:60px;
    border-radius:var(--radius-sm);
    object-fit:contain;
   }

   .brand-text h1 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
   }

   .brand-text p {
    font-size:12px;
    opacity:0.95;
    margin: 4px 0 0 0;
   }

   .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
   }

   #userName {
    font-weight: 600;
    border-radius: 20px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
   }

   #logoutBtn {
    background: rgba(255,255,255,0.15);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
   }

   #logoutBtn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
   }

   /* Sidebar - Collapsible */
   .sidebar{
    background:linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.20));
    border-radius:var(--radius);
    padding:12px;
    height:calc(100vh - 120px);
    position:sticky;
    top:72px;
    overflow:auto;
    transition: width 0.3s ease;
   }

   .sidebar-container {
    display: flex;
    flex-direction: column;
    height: 100%;
   }

   .sidebar-toggle {
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.3s ease;
   }

   .sidebar-toggle:hover {
    transform: scale(1.1);
   }

   .sidebar ul{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
    flex: 1;
   }

   .sidebar li a{
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    text-decoration: none;
    color: var(--muted);
    border-radius: var(--radius-sm);
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
   }

   .sidebar li a:hover{
    background: var(--light-green);
    color: var(--accent1);
   }

   .sidebar li a.active{
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .sidebar li a .menu-icon {
    font-size: 1.2rem;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
   }

   .sidebar li a .menu-text {
    transition: opacity 0.3s ease;
   }

   .page-container.collapsed .sidebar li a .menu-text {
    opacity: 0;
    width: 0;
    overflow: hidden;
   }

   /* Content Area - Fixed Size */
   .content-area{
    background:linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
    border-radius:var(--radius);
    padding:18px;
    box-shadow:0 8px 22px rgba(10,20,16,0.06);
    min-height:72vh;
    height: calc(100vh - 120px);
    overflow-y: auto;
   }

   /* Content Header - Fixed */
   .content-header {
    margin-top: 0;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
   }

   .content-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: var(--accent1);
    display: flex;
    align-items: center;
    gap: 8px;
   }

   /* Description Styling */
   #disc {
    margin-bottom: 10px;
    background: var(--light-green);
    padding: 12px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--accent1);
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.5;
   }

   .description p {
    margin: 0;
   }

   /* Dashboard Cards */
   .dashboard-cards{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:12px;
    margin:12px 0 18px 0;
   }

   .card{
    padding:16px;
    border-radius:var(--radius);
    background:var(--card-bg);
    box-shadow:var(--shadow);
    transition: transform 0.2s ease;
   }

   .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(6,30,20,0.1);
   }

   .card h3{ 
    margin:0 0 8px 0; 
    font-size:14px; 
    color:var(--accent1);
    font-weight: 600;
   }

   .card-value{ 
    font-size:22px; 
    font-weight:800; 
    color:#153b26;
    margin: 8px 0;
   }

   .mini { 
    font-size:13px; 
    color:var(--muted);
   }

   .stat-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
    gap:8px;
    margin-top: 12px;
   }

   /* Basic Population Overview - Single Card with Sections */
   .population-overview-card {
    padding: 20px;
    margin: 20px 0;
   }
   
   .section-title {
    font-size: 0.9rem; /* SAME SIZE AS BASIC POPULATION OVERVIEW */
    color: var(--accent1);
    font-weight: 700;
    margin: 25px 0 15px 0;
    padding-bottom: 8px; /* Reduced from 10px */
    border-bottom: 1px solid #d1d9d6; /* Changed to light grey and thinner */
    display: flex;
    align-items: center;
    gap: 10px;
   }
   
   .section-title:first-child {
    margin-top: 0;
   }
   
   .category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
   }
   
   .category-card {
    padding: 14px;
    background: var(--light-green);
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
    border: 1px solid var(--border);
    min-height: 70px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
   }
   
   .category-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(6,30,20,0.1);
   }
   
   .category-label {
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 8px;
    font-weight: 600;
   }
   
   .category-value {
    font-size: 1.6rem;
    font-weight: 800;
    color: var(--accent1);
   }
   
   .category-card .mini {
    font-size: 0.8rem;
    color: var(--muted);
    margin-top: 4px;
    font-style: italic;
   }

   /* Barangay Breakdown - FULL WIDTH STACK */
   .breakdown-section1 {
    margin-top: 10px;
    width: 100%;
    color: var(--accent1);
   }
    .breakdown-section {
    margin-top: 40px;
    width: 100%;
   }

   .breakdown-section h3 {
    font-size: 1.2rem;
    color: var(--accent1);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--light-green);
    display: flex;
    align-items: center;
    gap: 8px;
   }

   /* FIXED: Table headers and scrollbar styling - REMOVED BORDER EFFECTS */
   .breakdown-table-container {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
    overflow-x: auto;
    width: 100%;
    position: relative;
   }

   .breakdown-table-container h4 {
    font-size: 0.9rem; /* SAME SIZE AS BASIC POPULATION OVERVIEW SECTIONS */
    color: var(--accent1);
    font-weight: 700;
    margin: 0 0 15px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid #d1d9d6; /* Same as .section-title */
    display: flex;
    align-items: center;
    gap: 10px;
   }

   .breakdown-table {
    width: 100%;
    border-collapse: collapse;
    text-align: center;
    min-width: 600px;
    position: relative;
   }

   .breakdown-table thead {
    position: sticky;
    top: 0;
    z-index: 20;
    background: var(--card-bg);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
   }

   .breakdown-table th {
    background: rgba(15,122,74,0.08);
    padding: 12px 10px;
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--accent1);
    border-bottom: 2px solid rgba(15,122,74,0.15);
    position: sticky;
    top: 0;
    z-index: 15;
    white-space: nowrap;
    /* REMOVED: border-right: 1px solid rgba(15,122,74,0.1); */
   }

   .breakdown-table th:last-child {
    border-right: none;
   }

   .breakdown-table td {
    padding: 10px 8px;
    border-bottom: 1px solid rgba(15,122,74,0.08);
    font-size: 0.85rem;
    color: var(--muted);
    /* REMOVED: border-right: 1px solid rgba(15,122,74,0.05); */
   }

   .breakdown-table td:last-child {
    border-right: none;
   }

   .breakdown-table tbody tr:hover {
    background: rgba(52,183,143,0.05);
   }

   .breakdown-table th:first-child {
    position: sticky;
    left: 0;
    z-index: 25;
    background: rgba(15,122,74,0.12);
    text-align: left;
    /* REMOVED: border-right: 2px solid rgba(15,122,74,0.2); */
   }

   .breakdown-table td:first-child {
    position: sticky;
    left: 0;
    z-index: 10;
    background: var(--card-bg);
    text-align: left;
    font-weight: 600;
    color: var(--accent1);
    /* REMOVED: border-right: 2px solid rgba(15,122,74,0.1); */
   }

   /* FIXED: Scrollbar styling - muted gray instead of green */
   .breakdown-table-container::-webkit-scrollbar {
    height: 10px;
   }

   .breakdown-table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 6px;
    margin: 0 4px;
   }

   .breakdown-table-container::-webkit-scrollbar-thumb {
    background: #cccccc;
    border-radius: 6px;
    border: 2px solid #f1f1f1;
   }

   .breakdown-table-container::-webkit-scrollbar-thumb:hover {
    background: #b3b3b3;
   }

   /* Firefox scrollbar */
   .breakdown-table-container {
    scrollbar-width: thin;
    scrollbar-color: #cccccc #f1f1f1;
   }

   /* Mobile Styles */
   @media (max-width: 768px) {
    .page-container {
        grid-template-columns: 1fr !important;
        padding: 8px;
        gap: 12px;
    }
    
    .page-container.collapsed {
        grid-template-columns: 1fr !important;
    }
    
    .sidebar {
        position: fixed;
        top: 72px;
        left: 0;
        right: 0;
        height: auto;
        max-height: 0;
        overflow: hidden;
        z-index: 1000;
        margin: 0;
        padding: 0;
        border-radius: 0 0 var(--radius) var(--radius);
        background: white;
        box-shadow: var(--shadow);
        transition: max-height 0.3s ease;
    }
    
    .sidebar.mobile-open {
        max-height: 300px;
        padding: 12px;
        overflow-y: auto;
    }
    
    .sidebar-container {
        flex-direction: column;
    }
    
    .sidebar-toggle {
        display: none;
    }
    
    .mobile-menu-toggle {
        display: flex !important;
        background: linear-gradient(135deg, var(--accent1), var(--accent2));
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        width: 40px;
        height: 40px;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
    }
    
    .content-area {
        height: auto;
        min-height: calc(100vh - 140px);
    }
    
    .dashboard-cards {
        grid-template-columns: 1fr;
    }
    
    .stat-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .category-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .breakdown-table-container {
        padding: 12px;
        margin-bottom: 16px;
    }
    
    .breakdown-table {
        min-width: 800px;
    }
    
    .breakdown-table-container h4 {
        font-size: 0.85rem;
    }
    
    .user-info {
        gap: 8px;
    }
    
    #userName {
        font-size: 0.9rem;
        padding: 6px 12px;
    }
    
    #logoutBtn {
        padding: 6px 12px;
        font-size: 0.85rem;
    }
   }

   /* Mobile menu toggle button */
   .mobile-menu-toggle {
    display: none;
   }

   /* Loading overlay */
   #loading {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(255,255,255,0.85);
    align-items:center;
    justify-content:center;
    z-index:9999;
    backdrop-filter: blur(2px);
   }

   .loading-content {
    background:#fff;
    padding:20px 24px;
    border-radius:var(--radius);
    box-shadow:var(--shadow-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
   }

   .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent1);
    border-radius:50%;
    animation: spin 1s linear infinite;
   }

   @keyframes spin {
    to { transform: rotate(360deg); }
   }

   /* Chart container */
   .chart-container {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 20px 0;
    box-shadow: var(--shadow);
   }

   .chart-container h3 {
    margin: 0 0 16px 0;
    font-size: 1rem;
    color: var(--accent1);
    font-weight: 600;
   }
   
   /* Job category sections */
   .job-category-group {
    margin-bottom: 15px;
   }
   
   .job-category-title {
    font-size: 0.9rem; /* Slightly smaller than main section titles */
    color: var(--accent2);
    font-weight: 600;
    margin: 10px 0 8px 0;
    padding-left: 5px;
    border-left: 2px solid var(--accent2);
   }
   
   /* Visual feedback for recent updates */
   @keyframes highlight-update {
       0% { background-color: rgba(52, 183, 143, 0.1); }
       100% { background-color: transparent; }
   }

   .recent-update {
       animation: highlight-update 2s ease;
   }

   /* Smooth transitions for activity updates */
   #lastUpdated {
       transition: all 0.3s ease;
   }

   #lastUpdatedDetails {
       transition: all 0.3s ease;
   }
   
   /* Pulse animation for activity updates */
   @keyframes pulse {
       0% { box-shadow: 0 0 0 0 rgba(15, 122, 74, 0.4); }
       70% { box-shadow: 0 0 0 10px rgba(15, 122, 74, 0); }
       100% { box-shadow: 0 0 0 0 rgba(15, 122, 74, 0); }
   }
</style>
</head>

<body>
<div class="page-container">

  <header class="topbar">
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div class="brand-text">
        <h1>PUROK KALIGTASAN</h1>
        <p>DRRMO Alitagtag ‚Äì Household Records System/p>
      </div>
    </div>

    <div class="user-info">
      <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
      </button>
      <span id="userName"></span>
      <button id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-container">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul>
        <li><a href="dashboard.html" title="Dashboard"><span class="menu-icon">üìä</span> <span class="menu-text">Dashboard</span></a></li>
        <li><a href="dataForm.html" title="Data Entry"><span class="menu-icon">üìù</span> <span class="menu-text">Data Entry</span></a></li>
        <li><a href="records.html" title="Records"><span class="menu-icon">üìÅ</span> <span class="menu-text">Records & Management</span></a></li>
        <li><a href="charts.html" title="Charts"><span class="menu-icon">üìà</span> <span class="menu-text">Charts & Analytics</span></a></li>
        <li class="admin-only"><a href="users.html" title="User Management"><span class="menu-icon">üë•</span> <span class="menu-text">User Management</span></a></li>
      </ul>
    </div>
  </aside>

  <main class="content-area">
    <div class="content-header">
      <h2><span style="color: var(--accent1);">üìä</span> Dashboard Overview</h2>
    </div>

    <!-- Description -->
<div id="disc">This section presents a complete summary of all data recorded in the Purok Kaligtasan database. It provides quick insights into household profiles, population details, vulnerable groups, domestic animals, resources, and other important information gathered from the community. The dashboard helps users monitor trends, review totals at a glance, and easily understand the overall status of the purok for planning, reporting, and emergency response.</div>

    <!-- Top Cards -->
    <div class="breakdown-section1">
      <h3><i class="fas fa-table"></i> Alitagtag Data Overview</h3></div>
    <div class="dashboard-cards">
      <div class="card">
        <h3>Total Household Heads</h3>
        <div id="totalHeads" class="card-value">0</div>
      </div>

      <div class="card">
        <h3>Total Household Members</h3>
        <div id="totalMembers" class="card-value">0</div>
      </div>

      <div class="card" id="lastUpdatedCard">
        <h3>Last Updated</h3>
        <div id="lastUpdated" class="card-value">---</div>
        <div class="mini" id="lastUpdatedDetails">No recent updates</div>
      </div>
    </div>

    <!-- Basic Population Overview - Single Card with Sections -->
    <div class="card population-overview-card">
      <h3>Basic Population Overview</h3>
      
      <!-- Demographics Section - NOW INCLUDES 4 CARDS -->
      <div class="section-title">
        <i class="fas fa-users"></i> Demographics
      </div>
      <div class="category-grid" id="demographicsStats">
        <!-- Male, Female, PWD, and Households with Coordinates will be inserted here -->
      </div>
      
      <!-- Educational Attainment Section -->
      <div class="section-title">
        <i class="fas fa-graduation-cap"></i> Educational Attainment
      </div>
      <div class="category-grid" id="educationStats"></div>
      
      <!-- Employment Status Section -->
      <div class="section-title">
        <i class="fas fa-briefcase"></i> Employment Status
      </div>
      <div class="category-grid" id="employmentStats"></div>
      
      <!-- FishR & RBIS Section -->
      <div class="section-title">
        <i class="fas fa-fish"></i> FishR & RBIS Registered
      </div>
      <div class="category-grid" id="fishrStats"></div>
      
      <!-- Job Categories Section -->
      <div class="section-title">
        <i class="fas fa-tasks"></i> Job Title and Description
      </div>
      
      <!-- Office & Administrative Jobs -->
      <div class="job-category-group">
        <div class="job-category-title">Office & Administrative Jobs</div>
        <div class="category-grid" id="officeJobs"></div>
      </div>
      
      <!-- Business & Management -->
      <div class="job-category-group">
        <div class="job-category-title">Business & Management</div>
        <div class="category-grid" id="businessJobs"></div>
      </div>
      
      <!-- Accounting & Finance -->
      <div class="job-category-group">
        <div class="job-category-title">Accounting & Finance</div>
        <div class="category-grid" id="accountingJobs"></div>
      </div>
      
      <!-- IT & Tech -->
      <div class="job-category-group">
        <div class="job-category-title">IT & Tech</div>
        <div class="category-grid" id="itJobs"></div>
      </div>
      
      <!-- Healthcare -->
      <div class="job-category-group">
        <div class="job-category-title">Healthcare</div>
        <div class="category-grid" id="healthcareJobs"></div>
      </div>
      
      <!-- Education -->
      <div class="job-category-group">
        <div class="job-category-title">Education</div>
        <div class="category-grid" id="educationJobs"></div>
      </div>
      
      <!-- Sales & Customer Service -->
      <div class="job-category-group">
        <div class="job-category-title">Sales & Customer Service</div>
        <div class="category-grid" id="salesJobs"></div>
      </div>
      
      <!-- Skilled Work & Labor -->
      <div class="job-category-group">
        <div class="job-category-title">Skilled Work & Labor</div>
        <div class="category-grid" id="skilledJobs"></div>
      </div>
      
      <!-- Delivery & Logistics -->
      <div class="job-category-group">
        <div class="job-category-title">Delivery & Logistics</div>
        <div class="category-grid" id="deliveryJobs"></div>
      </div>
      
      <!-- Food & Hospitality -->
      <div class="job-category-group">
        <div class="job-category-title">Food & Hospitality</div>
        <div class="category-grid" id="foodJobs"></div>
      </div>
      
      <!-- Security & Public Service -->
      <div class="job-category-group">
        <div class="job-category-title">Security & Public Service</div>
        <div class="category-grid" id="securityJobs"></div>
      </div>
      
      <!-- Media, Design & Creative -->
      <div class="job-category-group">
        <div class="job-category-title">Media, Design & Creative</div>
        <div class="category-grid" id="mediaJobs"></div>
      </div>
      
      <!-- OFW Countries Section -->
      <div class="section-title">
        <i class="fas fa-globe-asia"></i> OFW Countries
      </div>
      <div class="category-grid" id="ofwCountriesStats"></div>
      
      <!-- Domestic Livestock Section -->
      <div class="section-title">
        <i class="fas fa-paw"></i> Domestic Livestock
      </div>
      <div class="category-grid" id="livestockStats"></div>
    </div>

    <!-- Chart Container -->
    <div class="chart-container">
      <h3>Household Distribution Within Alitagtag</h3>
      <canvas id="barangayChart" height="160"></canvas>
    </div>

    <!-- Barangay Breakdown Section -->
    <div class="breakdown-section">
      <h3><i class="fas fa-table"></i> Barangay Data Overview</h3>

      <!-- 1. Barangay Summary -->
      <div class="breakdown-table-container">
        <h4><i class="fas fa-chart-bar"></i> Demographics & Location Availability</h4>
        <table class="breakdown-table" id="tblSummary">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>PWD</th>
              <th>Male</th>
              <th>Female</th>
              <th>With Coordinates</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 2. Government Support -->
      <div class="breakdown-table-container">
        <h4><i class="fas fa-handshake"></i> Government Assistance Programs</h4>
        <table class="breakdown-table" id="tblSupport">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>TUPAD</th>
              <th>Local 4Ps</th>
              <th>National 4Ps</th>
              <th>Local SP</th>
              <th>National SP</th>
              <th>Solo Parent</th>
              <th>Relief Goods</th>
              <th>Cash Subsidy</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 3. Status Breakdown -->
      <div class="breakdown-table-container">
        <h4><i class="fas fa-heartbeat"></i> Household Status</h4>
        <table class="breakdown-table" id="tblStatus">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>With Sickness</th>
              <th>Pregnant</th>
              <th>Solo Parent</th>
              <th>Lactating</th>
              <th>Severe Illness</th>
              <th>HIV Positive</th>
              <th>LGBTQ+</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 4. Age Buckets -->
      <div class="breakdown-table-container">
        <h4><i class="fas fa-users"></i> Population Age Groups</h4>
        <table class="breakdown-table" id="tblAge">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>0-5</th>
              <th>6-17</th>
              <th>18-59</th>
              <th>60+</th>
              <th>Unspecified</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 5. Sitio/Purok Distribution -->
      <div class="breakdown-table-container">
        <h4><i class="fas fa-map-marker-alt"></i> Sitio / Purok Summary</h4>
        <table class="breakdown-table" id="tblSitio">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>I</th>
              <th>II</th>
              <th>III</th>
              <th>IV</th>
              <th>V</th>
              <th>VI</th>
              <th>VII</th>
              <th>Unspecified</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 6. Household Livestock -->
      <div class="breakdown-table-container">
        <h4><i class="fas fa-paw"></i> Domestic Livestock</h4>
        <table class="breakdown-table" id="tblLivestock">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>Dog</th>
              <th>Cat</th>
              <th>Pig</th>
              <th>Cow</th>
              <th>Carabao</th>
              <th>Chicken</th>
              <th>Others</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 7. Barangay Educational Attainment -->
      <div class="breakdown-table-container">
        <h4><i class="fas fa-graduation-cap"></i> Educational Attainment by Barangay</h4>
        <table class="breakdown-table" id="tblBarangayEducation">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>No Formal Education</th>
              <th>Elementary Level</th>
              <th>Elementary Graduate</th>
              <th>Junior High School Level</th>
              <th>Junior High School Graduate</th>
              <th>Senior High School Level</th>
              <th>Senior High School Graduate</th>
              <th>College Level</th>
              <th>College Graduate</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 8. Barangay Employment -->
      <div class="breakdown-table-container">
        <h4><i class="fas fa-briefcase"></i> Employment Status by Barangay</h4>
        <table class="breakdown-table" id="tblBarangayEmployment">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>Employed</th>
              <th>Unemployed</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 9. Barangay FishR & RBIS -->
      <div class="breakdown-table-container">
        <h4><i class="fas fa-fish"></i> FishR & RBIS Registration by Barangay</h4>
        <table class="breakdown-table" id="tblBarangayFishR">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>FishR Registered</th>
              <th>RBIS Registered</th>
              <th>FishR & RBIS Registered</th>
              <th>Not Registered</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 10. Barangay OFW Countries -->
      <div class="breakdown-table-container">
        <h4><i class="fas fa-globe-asia"></i> OFW Countries by Barangay</h4>
        <table class="breakdown-table" id="tblBarangayOFW">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>Saudi Arabia</th>
              <th>United Arab Emirates</th>
              <th>Qatar</th>
              <th>Kuwait</th>
              <th>Bahrain</th>
              <th>Oman</th>
              <th>Hong Kong</th>
              <th>Singapore</th>
              <th>Japan</th>
              <th>Taiwan</th>
              <th>Malaysia</th>
              <th>Australia</th>
              <th>New Zealand</th>
              <th>Italy</th>
              <th>United Kingdom</th>
              <th>Germany</th>
              <th>Cyprus</th>
              <th>Canada</th>
              <th>United States</th>
              <th>Libya</th>
              <th>Others</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div><!-- end breakdown-section -->
  </main>
</div>

<!-- Loading overlay -->
<div id="loading">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div>Loading dashboard data‚Ä¶</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Define allowed actions for Last Activity display - DECLARE AT TOP LEVEL
//const ALLOWED_ACTIONS = ['Update Household', 'Create Record', 'Delete Household'];
/* CONFIG */
const API_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";
let chart = null;
let lastUpdatedTime = null;
let refreshInterval = null;
let sessionMonitorInterval = null; // Added for session monitoring

/* ENHANCED SESSION VALIDATION FUNCTIONS */
// Validate session with server
async function validateSession() {
    const username = localStorage.getItem("username");
    const sessionId = sessionStorage.getItem("sessionId");
    
    if (!username || !sessionId) {
        return false;
    }
    
    try {
        // Add timeout to prevent hanging
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        
        const formData = new FormData();
        formData.append("action", "validateSession");
        formData.append("username", username);
        formData.append("sessionId", sessionId);
        
        const response = await fetch(API_URL, {
            method: "POST",
            body: formData,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const data = await response.json();
        
        if (data.success && data.isLoggedIn) {
            return true;
        } else {
            console.log("Session invalid:", data.message);
            return false;
        }
    } catch (error) {
        console.error("Session validation error:", error);
        if (error.name === 'AbortError') {
            console.log("Session validation timeout");
        }
        return false; // On any error, consider session invalid
    }
}

/* FIXED: Auto-load dashboard when dashboard tab is clicked */
function setupDashboardAutoLoad() {
    // Get all dashboard tab links
    const dashboardLinks = document.querySelectorAll('a[href*="dashboard.html"]');
    
    dashboardLinks.forEach(link => {
        // Remove any existing click handlers
        const newLink = link.cloneNode(true);
        link.parentNode.replaceChild(newLink, link);
        
        newLink.addEventListener('click', function(e) {
            // If we're already on dashboard.html, reload data
            if (window.location.pathname.includes('dashboard.html')) {
                e.preventDefault();
                
                console.log("üîÑ Dashboard tab clicked, refreshing data...");
                
                // Create or show refresh indicator
                let refreshIndicator = document.getElementById('refreshIndicator');
                if (!refreshIndicator) {
                    refreshIndicator = document.createElement('div');
                    refreshIndicator.id = 'refreshIndicator';
                    refreshIndicator.style.cssText = `
                        position: fixed;
                        top: 70px;
                        right: 20px;
                        background: #10b981;
                        color: white;
                        padding: 8px 15px;
                        border-radius: 20px;
                        font-size: 14px;
                        display: none;
                        z-index: 1000;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    `;
                    document.body.appendChild(refreshIndicator);
                }
                
                // Show refresh indicator
                refreshIndicator.style.display = 'block';
                refreshIndicator.innerHTML = '<i class="fas fa-sync fa-spin"></i> Refreshing...';
                
                // Clear cache for fresh data
                localStorage.removeItem('dashboardDataCache');
                
                // Load fresh data in background
                loadDashboard(false).then(() => {
                    // Also update activity log
                    loadActivityLog();
                    
                    // Update last refresh time
                    const now = new Date();
                    const lastUpdatedElement = document.getElementById('lastUpdated');
                    const lastUpdatedDetailsElement = document.getElementById('lastUpdatedDetails');
                    
                    if (lastUpdatedElement) {
                        lastUpdatedElement.innerText = formatTS(now);
                    }
                    
                    if (lastUpdatedDetailsElement) {
                        lastUpdatedDetailsElement.innerText = 'Dashboard data refreshed';
                    }
                    
                    // Hide indicator after success
                    setTimeout(() => {
                        refreshIndicator.style.display = 'none';
                        refreshIndicator.innerHTML = '<i class="fas fa-check"></i> Updated!';
                        setTimeout(() => {
                            refreshIndicator.style.display = 'none';
                        }, 1500);
                    }, 1000);
                    
                    console.log("‚úÖ Dashboard data refreshed");
                }).catch(error => {
                    console.error("Error refreshing dashboard:", error);
                    refreshIndicator.innerHTML = '<i class="fas fa-exclamation-circle"></i> Update failed';
                    setTimeout(() => {
                        refreshIndicator.style.display = 'none';
                    }, 2000);
                });
            }
        });
    });
}
    
    // Add a refresh indicator to the dashboard page
    if (!document.getElementById('refreshIndicator')) {
        const indicator = document.createElement('div');
        indicator.id = 'refreshIndicator';
        indicator.style.cssText = `
            position: fixed;
            top: 70px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        `;
        document.body.appendChild(indicator);
    }
    
    // Add a refresh indicator to the dashboard page
    if (!document.getElementById('refreshIndicator')) {
        const indicator = document.createElement('div');
        indicator.id = 'refreshIndicator';
        indicator.style.cssText = `
            position: fixed;
            top: 70px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        `;
        document.body.appendChild(indicator);
    }

// Start session monitoring
function startSessionMonitoring() {
    // Clear any existing interval
    if (sessionMonitorInterval) {
        clearInterval(sessionMonitorInterval);
    }
    
    // Check session every 30 seconds (increased from 10 to prevent spamming)
    sessionMonitorInterval = setInterval(async () => {
        // Use sessionManager for better error handling
        if (window.sessionManager && typeof window.sessionManager.validateSession === 'function') {
            try {
                const isValid = await window.sessionManager.validateSession();
                if (!isValid) {
                    // Session invalidated
                    stopSessionMonitoring();
                    // Use session manager's method instead of alert
                    window.sessionManager.showSessionExpiredMessage();
                    return;
                }
            } catch (error) {
                console.log("Session monitoring error:", error);
                // Don't logout on error, just continue
            }
        }
    }, 30000); // Check every 30 seconds
    
    // Also check when page becomes visible
    document.addEventListener("visibilitychange", async () => {
        if (!document.hidden && window.sessionManager) {
            try {
                await window.sessionManager.validateSession();
            } catch (error) {
                console.log("Visibility change validation error:", error);
            }
        }
    });
    
    console.log("Session monitoring started (30s interval)");
}

// Stop session monitoring
function stopSessionMonitoring() {
    if (sessionMonitorInterval) {
        clearInterval(sessionMonitorInterval);
        sessionMonitorInterval = null;
    }
}

/* FIXED: Enhanced session check for page refresh */
async function enhancedSessionCheck() {
    try {
        // Check if we have required session data
        const loggedIn = localStorage.getItem("loggedIn");
        const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
        const sessionId = sessionStorage.getItem("sessionId");
        
        // Special handling for page refresh
        const isPageRefresh = performance.navigation.type === 1 || 
                            performance.getEntriesByType("navigation")[0]?.type === "reload";
        
        if (isPageRefresh) {
            console.log("üì± Page refresh detected, using session manager validation");
            
            // Use sessionManager.validateSession() instead of validateSession()
            // It has better error handling and no-cors mode
            if (window.sessionManager && typeof window.sessionManager.validateSession === 'function') {
                try {
                    const isValid = await window.sessionManager.validateSession();
                    if (!isValid) {
                        console.log("Session invalidated during refresh");
                        window.location.href = 'index.html?session=expired';
                        return false;
                    }
                } catch (error) {
                    console.log("Session validation error on refresh, continuing with local state:", error);
                    // Continue with local state on error
                }
            }
            
            // Try to restore session from localStorage if sessionStorage was cleared
            if (!sessionId && localStorage.getItem("lastSessionId")) {
                sessionStorage.setItem("sessionId", localStorage.getItem("lastSessionId"));
                console.log("Restored session ID from localStorage");
            }
        }
        
        // Store session ID in localStorage as backup
        if (sessionId) {
            localStorage.setItem("lastSessionId", sessionId);
        }
        
        // Basic validation
        if (loggedIn !== "true" || !userName || userName === "User") {
            console.log("Missing session data, redirecting...");
            window.location.href = 'index.html?session=expired';
            return false;
        }
        
        // For non-refresh loads, use the session manager
        if (!isPageRefresh && window.sessionManager) {
            const isValid = await window.sessionManager.validateSession();
            if (!isValid) {
                console.log("Session invalidated by server");
                window.location.href = 'index.html?session=invalid';
                return false;
            }
        }
        
        // Session is valid, set up UI
        document.getElementById('userName').innerText = userName;
        
        // FIXED: Check admin status with case-insensitive comparison
        const userRole = localStorage.getItem("userRole") || "Staff";
        const isAdmin = userRole.toLowerCase() === "admin";
        
        console.log("Dashboard: User role is", userRole, "Admin?", isAdmin);
        
        // Hide admin-only elements if not admin
        if (!isAdmin) {
            // Hide immediately to prevent flash
            document.querySelectorAll('.admin-only').forEach(item => {
                item.style.display = 'none';
            });
            
            // Also hide any parent list items
            const adminMenuItems = document.querySelectorAll('li.admin-only');
            adminMenuItems.forEach(li => {
                li.style.display = 'none';
            });
        } else {
            // Show admin elements
            document.querySelectorAll('.admin-only').forEach(item => {
                item.style.display = '';
            });
        }
        
        // Set session flag
        sessionStorage.setItem('authenticated', 'true');
        
        // Start session monitoring (but not on initial load to prevent loops)
        if (!isPageRefresh) {
            startSessionMonitoring();
        } else {
            // For refresh, start monitoring after a delay
            setTimeout(() => startSessionMonitoring(), 5000);
        }
        
        return true;
        
    } catch(e){ 
        console.warn('Session check failed', e);
        // On refresh, try to continue with cached data
        if (performance.navigation.type === 1) {
            console.log("Refresh detected, allowing continuation");
            return true;
        }
        window.location.href = 'index.html?session=error';
        return false;
    }
}

/* FIXED: Prevent multiple session checks on refresh */
let sessionCheckInProgress = false;
async function safeSessionCheck() {
    if (sessionCheckInProgress) {
        console.log("Session check already in progress");
        return true;
    }
    
    sessionCheckInProgress = true;
    try {
        return await enhancedSessionCheck();
    } finally {
        // Reset flag after a delay to prevent rapid successive checks
        setTimeout(() => {
            sessionCheckInProgress = false;
        }, 1000);
    }
}

/* ENHANCED LOGOUT FUNCTION */
async function enhancedLogout() {
  try {
    const username = localStorage.getItem("username");
    const sessionId = sessionStorage.getItem("sessionId");
    
    // 1. Stop all intervals
    if (refreshInterval) {
      clearInterval(refreshInterval);
      refreshInterval = null;
    }
    
    if (sessionMonitorInterval) {
      clearInterval(sessionMonitorInterval);
      sessionMonitorInterval = null;
    }
    
    // 2. Call server logout if we have session data
    if (username && sessionId) {
      try {
        const formData = new FormData();
        formData.append("action", "logout");
        formData.append("username", username);
        formData.append("sessionId", sessionId);
        
        // Fire and forget - don't wait for response
        fetch(API_URL, {
          method: "POST",
          body: formData,
          // Add timeout to prevent hanging
          signal: AbortSignal.timeout(5000)
        }).catch(() => { /* ignore errors */ });
      } catch (e) {
        console.error("Logout API error:", e);
      }
    }
    
  } catch (err) {
    console.error("Logout error:", err);
  } finally {
    // 3. Always clear storage
    localStorage.clear();
    sessionStorage.clear();
    
    // 4. Redirect with cache-busting
    window.location.replace('index.html?logout=true&t=' + Date.now());
  }
}

/* SETUP AUTO LOGOUT FOR INACTIVITY */
function setupAutoLogout() {
    let inactivityTimer;
    
    function resetTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
            // Show warning 1 minute before logout (29 minutes of inactivity)
            if (confirm("You've been inactive for 29 minutes. Click OK to stay logged in, or Cancel to logout.")) {
                resetTimer();
            } else {
                enhancedLogout();
            }
        }, 29 * 60 * 1000); // 29 minutes
    }
    
    // Reset timer on user activity
    ['click', 'keypress', 'mousemove', 'scroll'].forEach(event => {
        document.addEventListener(event, resetTimer);
    });
    
    // Start the timer
    resetTimer();
}

/* helpers */
function getField(obj, name){
  if(!obj) return "";
  const want = String(name).toLowerCase().trim();
  for(const k of Object.keys(obj)){
    if(String(k).toLowerCase().trim() === want) return obj[k];
  }
  return "";
}

function formatTS(date){
  if(!date) date = new Date();
  const m = date.getMonth()+1;
  const d = date.getDate();
  const y = date.getFullYear();
  let hh = date.getHours();
  const mm = String(date.getMinutes()).padStart(2,'0');
  const ss = String(date.getSeconds()).padStart(2,'0');
  const ampm = hh>=12 ? 'PM' : 'AM';
  hh = hh%12; hh = hh? hh:12;
  return `${m}/${d}/${y} ${String(hh).padStart(2,'0')}:${mm}:${ss} ${ampm}`;
}

async function fetchRecords(){ 
  const res = await fetch(`${API_URL}?action=getRecords`); 
  return res.json(); 
}

function destroyChart(){ 
  if(chart){ 
    try{ chart.destroy(); }catch(e){} 
    chart = null; 
  } 
}

function showLoading(yes){ 
  document.getElementById("loading").style.display = yes ? "flex" : "none"; 
}

/* FIXED: Load activity log from Google Sheets API */
async function loadActivityLog() {
  try {
    console.log("Loading activity log...");
    
    // First check localStorage (for backward compatibility)
    const localActivityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
    
    if (localActivityLog.length > 0) {
      // Filter to only show allowed actions
      const filteredLog = localActivityLog.filter(activity => 
        ALLOWED_ACTIONS.includes(activity.action)
      );
      
      if (filteredLog.length > 0) {
        const latestActivity = filteredLog[filteredLog.length - 1];
        lastUpdatedTime = new Date(latestActivity.timestamp);
        updateActivityDisplay(latestActivity);
        return;
      }
    }
    
    // If no local activities, fetch from API
    console.log("Fetching audit logs from API...");
    const response = await fetch(`${API_URL}?action=logs`);
    const data = await response.json();
    
    if (data.success && data.logs && data.logs.length > 0) {
      // Filter to only show allowed actions
      const filteredLogs = data.logs.filter(log => 
        ALLOWED_ACTIONS.includes(log.Action || log.action)
      );
      
      if (filteredLogs.length > 0) {
        // Get the most recent log
        const latestLog = filteredLogs[0];
        
        // Try to parse the timestamp
        let timestamp = new Date();
        if (latestLog.Timestamp) {
          timestamp = new Date(latestLog.Timestamp);
        } else if (latestLog.timestamp) {
          timestamp = new Date(latestLog.timestamp);
        }
        
        const activity = {
          action: latestLog.Action || latestLog.action || "Unknown",
          actor: latestLog.Actor || latestLog.actor || "Unknown",
          details: latestLog.Details || latestLog.details || "",
          timestamp: timestamp.toISOString()
        };
        
        updateActivityDisplay(activity);
        
        // Also store in localStorage for next time
        const activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
        activityLog.push(activity);
        
        // Keep only last 10 activities
        if (activityLog.length > 10) {
          activityLog.splice(0, activityLog.length - 10);
        }
        
        localStorage.setItem('activityLog', JSON.stringify(activityLog));
        
        console.log("Latest activity loaded from API:", activity);
      } else {
        showDefaultMessage();
      }
    } else {
      showDefaultMessage();
    }
    
  } catch(err) {
    console.error('Error loading activity log:', err);
    showDefaultMessage();
  }
}

function showDefaultMessage() {
  document.getElementById('lastUpdated').innerText = '---';
  document.getElementById('lastUpdatedDetails').innerText = 'No recent activity';
}

/* FIXED: Update activity display immediately when actions occur */
function updateActivityDisplay(activity) {
    if (!activity) return;
    
    const timestamp = new Date(activity.timestamp || Date.now());
    lastUpdatedTime = timestamp;
    
    document.getElementById('lastUpdated').innerText = formatTS(timestamp);
    
    const detailsDiv = document.getElementById('lastUpdatedDetails');
    detailsDiv.innerHTML = `
        <div style="font-size: 11px; line-height: 1.4;">
            <strong>Action:</strong> ${activity.action || 'Unknown'}<br>
            <strong>Actor:</strong> ${activity.actor || 'Unknown'}<br>
            <strong>Details:</strong> ${activity.details || 'No details'}
        </div>
    `;
    
    // Add visual feedback for recent update
    const lastUpdatedCard = document.getElementById('lastUpdatedCard');
    if (lastUpdatedCard) {
        lastUpdatedCard.style.animation = 'none';
        setTimeout(() => {
            lastUpdatedCard.style.animation = 'pulse 1s';
        }, 10);
    }
}

/* ENHANCED: Record user activity with cross-tab communication */
function recordUserActivity(action, details = '') {
    try {
        // Only record allowed actions
        if (!ALLOWED_ACTIONS.includes(action)) {
            return;
        }
        
        const username = localStorage.getItem('staffName') || localStorage.getItem('username') || 'Unknown User';
        const timestamp = new Date().toISOString();
        
        const activity = {
            action: action,
            actor: username,
            details: details,
            timestamp: timestamp
        };
        
        // Get existing log or create new one
        const activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
        
        // Add new activity
        activityLog.push(activity);
        
        // Keep only last 10 activities to prevent storage bloat
        if (activityLog.length > 10) {
            activityLog.splice(0, activityLog.length - 10);
        }
        
        // Save to localStorage
        localStorage.setItem('activityLog', JSON.stringify(activityLog));
        
        // Also store as recent activity for immediate access
        localStorage.setItem('recentActivity', JSON.stringify(activity));
        
        // Log to Google Sheets via API
        logActivityToAPI(username, action, details);
        
        // Update display immediately
        updateActivityDisplay(activity);
        
        // Broadcast to other tabs
        broadcastActivityUpdate(activity);
        
        console.log(`Activity recorded: ${action} by ${username}`);
        
    } catch(err) {
        console.error('Error recording activity:', err);
    }
}

/* Broadcast activity to other tabs */
function broadcastActivityUpdate(activity) {
    try {
        // Update localStorage to trigger storage event
        localStorage.setItem('activityUpdateTrigger', Date.now().toString());
        
        // Also use BroadcastChannel if supported
        if (typeof BroadcastChannel !== 'undefined') {
            const channel = new BroadcastChannel('activity_updates');
            channel.postMessage({
                type: 'activityUpdate',
                activity: activity
            });
            channel.close();
        }
    } catch(err) {
        console.error('Error broadcasting activity:', err);
    }
}

/* Helper function to log activity to Google Sheets API */
async function logActivityToAPI(username, action, details) {
  try {
    const formData = new FormData();
    formData.append("action", "logActivity");
    formData.append("username", username);
    formData.append("action", action); // The activity action
    formData.append("actor", username);
    formData.append("details", details);
    
    // Fire and forget - don't wait for response
    fetch(API_URL, {
      method: "POST",
      body: formData
    }).catch(() => { /* ignore errors */ });
    
  } catch(err) {
    console.error('Error logging activity to API:', err);
  }
}

/* Initialize activity monitoring */
function setupActivityMonitoring() {
  // Listen for messages from other pages
  window.addEventListener('storage', function(e) {
    if (e.key === 'activityLog') {
      loadActivityLog();
    }
  });
  
  // Check if we need to record an activity from another tab/page
  const pendingActivity = sessionStorage.getItem('pendingActivity');
  if (pendingActivity) {
    try {
      const activity = JSON.parse(pendingActivity);
      // Only record if it's an allowed action
      if (ALLOWED_ACTIONS.includes(activity.action)) {
        recordUserActivity(activity.action, activity.details);
      }
      sessionStorage.removeItem('pendingActivity');
    } catch(err) {
      console.error('Error processing pending activity:', err);
    }
  }
}

/* ENHANCED: Real-time activity monitoring and display */
function setupRealTimeActivityUpdates() {
    // Listen for storage events (when other tabs update activity)
    window.addEventListener('storage', function(e) {
        if (e.key === 'activityLog' || e.key === 'recentActivity' || e.key === 'activityUpdateTrigger') {
            console.log('Activity updated from another tab, refreshing...');
            loadActivityLog();
            
            // Also refresh dashboard data
            loadDashboard(false);
        }
    });
    
    // Listen for messages from other pages
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'activityUpdate') {
            console.log('Activity message received:', event.data);
            loadActivityLog();
        }
    });
    
    // Poll for recent activity every 5 seconds
    setInterval(() => {
        loadActivityLog();
    }, 5000);
}

/* ENHANCED: Reload dashboard when dashboard tab is clicked */
function setupDashboardTabReload() {
    const dashboardTab = document.querySelector('a[href="dashboard.html"]');
    if (dashboardTab) {
        // Remove existing click handler if any
        const newTab = dashboardTab.cloneNode(true);
        dashboardTab.parentNode.replaceChild(newTab, dashboardTab);
        
        newTab.addEventListener('click', function(e) {
            // Only intercept if we're already on dashboard
            if (window.location.pathname.includes('dashboard.html')) {
                e.preventDefault();
                
                // Clear cache and force fresh load
                localStorage.removeItem('dashboardDataCache');
                
                // Show loading indicator
                showLoading(true);
                
                // Load fresh data
                loadDashboard(true).then(() => {
                    showLoading(false);
                    
                    // Also update activity log
                    loadActivityLog();
                });
            }
        });
    }
}

/* NEW: Load cached dashboard data - Shows instantly without loading screen */
function loadCachedDashboardData() {
    try {
        const cached = localStorage.getItem('dashboardDataCache');
        if (cached) {
            console.log("üìä Loading dashboard from cache (instant)");
            const data = JSON.parse(cached);
            if (data.rows && data.rows.length > 0) {
                // Process and display cached data
                processDashboardData(data);
                return true;
            }
        }
    } catch (err) {
        console.error('Error loading cached data:', err);
    }
    return false;
}

/* NEW: Store dashboard data in cache */
function cacheDashboardData(data) {
    try {
        localStorage.setItem('dashboardDataCache', JSON.stringify(data));
        console.log("üìä Dashboard data cached");
    } catch (err) {
        console.error('Error caching data:', err);
    }
}

/* NEW: Main dashboard load - shows cached data immediately, loads fresh in background */
async function loadDashboard(showLoader = false){
    // Only show loading if explicitly requested AND no cache exists
    const hasCache = localStorage.getItem('dashboardDataCache');
    const shouldShowLoader = showLoader && !hasCache;
    
    if (shouldShowLoader) {
        showLoading(true);
    }
    
    try{
        const data = await fetchRecords();
        if(!data.success) throw new Error('Failed fetch');
        const rows = data.rows || [];
        
        // Cache the data for next time
        cacheDashboardData(data);
        
        // Process and display the fresh data
        processDashboardData(data);
        
        console.log("üìä Fresh dashboard data loaded");
        
    } catch(err){
        console.error('Load dashboard error', err);
        // Don't alert if we have cache, just log error
        if (!hasCache && showLoader) {
            alert('Error loading dashboard data');
        }
    }
    
    if (shouldShowLoader) {
        showLoading(false);
    }
}

/* Process dashboard data (used by both cache and fresh load) */
function processDashboardData(data) {
    const rows = data.rows || [];
    
    // init containers
    let totalHeads = 0, totalMembers = 0, headsWithCoords = 0;
    const barangayMap = {};
    
    // Initialize statistics
    const demographicsStats = {
        male: 0,
        female: 0,
        pwd: 0
    };
    
    const overallEducation = {
        noFormalEducation: 0,
        elementaryLevel: 0,
        elementaryGraduate: 0,
        juniorHighSchoolLevel: 0,
        juniorHighSchoolGraduate: 0,
        seniorHighSchoolLevel: 0,
        seniorHighSchoolGraduate: 0,
        collegeLevel: 0,
        collegeGraduate: 0
    };
    
    const overallEmployment = {
        employed: 0,
        unemployed: 0
    };
    
    const fishrStats = {
        fishrRegistered: 0,
        rbisRegistered: 0,
        bothRegistered: 0,
        notRegistered: 0
    };
    
    // Job Categories
    const jobCategories = {
        // Office & Administrative Jobs
        adminAssistant: 0,
        officeClerk: 0,
        secretary: 0,
        
        // Business & Management
        projectManager: 0,
        operationsManager: 0,
        hrStaff: 0,
        accountManager: 0,
        
        // Accounting & Finance
        accountingStaff: 0,
        bookkeeper: 0,
        payrollOfficer: 0,
        auditor: 0,
        
        // IT & Tech
        itSupport: 0,
        webDeveloper: 0,
        softwareDeveloper: 0,
        dataAnalyst: 0,
        systemAdministrator: 0,
        
        // Healthcare
        nurse: 0,
        medicalTechnologist: 0,
        caregiver: 0,
        pharmacist: 0,
        
        // Education
        teacher: 0,
        tutor: 0,
        schoolAdministrator: 0,
        
        // Sales & Customer Service
        csr: 0,
        salesAssociate: 0,
        cashier: 0,
        storeSupervisor: 0,
        
        // Skilled Work & Labor
        electrician: 0,
        plumber: 0,
        welder: 0,
        constructionWorker: 0,
        
        // Delivery & Logistics
        driver: 0,
        logisticsStaff: 0,
        rider: 0,
        
        // Food & Hospitality
        cook: 0,
        waiter: 0,
        barista: 0,
        housekeepingStaff: 0,
        
        // Security & Public Service
        securityGuard: 0,
        barangayStaff: 0,
        policeOfficer: 0,
        fireOfficer: 0,
        
        // Media, Design & Creative
        graphicDesigner: 0,
        videoEditor: 0,
        contentWriter: 0,
        socialMediaManager: 0
    };
    
    const ofwCountries = {
        saudiArabia: 0,
        uae: 0,
        qatar: 0,
        kuwait: 0,
        bahrain: 0,
        oman: 0,
        hongKong: 0,
        singapore: 0,
        japan: 0,
        taiwan: 0,
        malaysia: 0,
        australia: 0,
        newZealand: 0,
        italy: 0,
        uk: 0,
        germany: 0,
        cyprus: 0,
        canada: 0,
        usa: 0,
        libya: 0,
        others: 0
    };
    
    const livestockStats = {
        dog: 0,
        cat: 0,
        pig: 0,
        cow: 0,
        carabao: 0,
        chicken: 0,
        others: 0
    };

    rows.forEach(r=>{
        const isHead = String(getField(r,'Name of Household Member/s')||'').trim() === '';
        const barangay = String(getField(r,'Barangay')||'Unknown').trim() || 'Unknown';
        const sex = String(getField(r,'Sex')||'').trim().toLowerCase();
        
        // FIXED: Check multiple possible coordinate field names
        const coord = String(getField(r,'Coordinate') || getField(r,'Coordinates') || '').trim();

        if(!barangayMap[barangay]){
            barangayMap[barangay] = {
                heads:0, members:0, male:0, female:0, coords:0, pwds:0,
                status:{}, reasons:{}, livestock:{}, ageBuckets:{}, sitio:{},
                support: {
                    "TUPAD":0, "Local 4Ps":0, "National 4Ps":0, "Local Social Pension":0, "National Social Pension":0,
                    "Solo Parent Assistance":0, "Relief Goods":0, "Cash Subsidy":0
                },
                education: {
                    noFormalEducation: 0,
                    elementaryLevel: 0,
                    elementaryGraduate: 0,
                    juniorHighSchoolLevel: 0,
                    juniorHighSchoolGraduate: 0,
                    seniorHighSchoolLevel: 0,
                    seniorHighSchoolGraduate: 0,
                    collegeLevel: 0,
                    collegeGraduate: 0
                },
                employment: {
                    employed: 0,
                    unemployed: 0
                },
                fishr: {
                    fishrRegistered: 0,
                    rbisRegistered: 0,
                    bothRegistered: 0,
                    notRegistered: 0
                },
                ofw: {
                    saudiArabia: 0,
                    uae: 0,
                    qatar: 0,
                    kuwait: 0,
                    bahrain: 0,
                    oman: 0,
                    hongKong: 0,
                    singapore: 0,
                    japan: 0,
                    taiwan: 0,
                    malaysia: 0,
                    australia: 0,
                    newZealand: 0,
                    italy: 0,
                    uk: 0,
                    germany: 0,
                    cyprus: 0,
                    canada: 0,
                    usa: 0,
                    libya: 0,
                    others: 0
                },
                livestock: {
                    dog: 0,
                    cat: 0,
                    pig: 0,
                    cow: 0,
                    carabao: 0,
                    chicken: 0,
                    others: 0
                }
            };
        }
        const b = barangayMap[barangay];

        if(isHead){ 
            totalHeads++; 
            b.heads++; 
            // FIXED: Households with Coordinates - Check for valid coordinates
            if(coord && coord.trim() !== '' && coord !== 'N/A' && coord !== 'none' && coord !== 'undefined' && !coord.toLowerCase().includes('no')) { 
                // Check if it looks like coordinates (contains numbers and maybe comma)
                if (coord.match(/[-]?\d+\.?\d*[,\s]*[-]?\d+\.?\d*/) || coord.includes(',') || coord.includes('.')) {
                    headsWithCoords++; 
                    b.coords++; 
                }
            } 
        } else { 
            totalMembers++; 
            b.members++; 
        }

        // sex
        if(sex === 'male') { 
            b.male++; 
            demographicsStats.male++;
        }
        else if(sex === 'female') { 
            b.female++; 
            demographicsStats.female++;
        }

        // PWD
        const pwdField = String(getField(r,'Persons with Disability (PWD)')||'').toLowerCase().trim();
        if(pwdField === 'yes' || pwdField === 'true' || pwdField === '1') {
            b.pwds++;
            demographicsStats.pwd++;
        }

        // STATUS accumulation
        const statusRaw = String(getField(r,'Status')||'').trim();
        if(statusRaw){
            b.status[statusRaw] = (b.status[statusRaw]||0) + 1;
        }

        // Reasons
        const reason = String(getField(r,'Reasons for Displacement')||'').trim();
        if(reason) b.reasons[reason] = (b.reasons[reason]||0) + 1;

        // Sitio / Purok
        const sitioRaw = String(getField(r,'Sitio / Purok')||'').trim();
        let sitioKey = 'Unknown';
        if(sitioRaw){
            const m = sitioRaw.match(/I{1,3}|IV|V|VI|VII|\b1\b|\b2\b|\b3\b|\b4\b|\b5\b|\b6\b|\b7\b/i);
            if(m){
                sitioKey = m[0].toString().replace(/\b1\b/,'I').replace(/\b2\b/,'II').replace(/\b3\b/,'III').replace(/\b4\b/,'IV').replace(/\b5\b/,'V').replace(/\b6\b/,'VI').replace(/\b7\b/,'VII').toUpperCase();
            } else {
                sitioKey = sitioRaw;
            }
        }
        b.sitio[sitioKey] = (b.sitio[sitioKey]||0) + 1;

        // Livestock - FIXED: Collect livestock data
        if (isHead) {
            const animals = ['Dog', 'Cat', 'Pig', 'Cow', 'Carabao', 'Chicken', 'Others'];
            animals.forEach(animal => {
                const qtyField = animal === 'Others' ? 'Others' : animal + ' Qty.';
                const val = String(getField(r, animal) || getField(r, qtyField) || '').trim();
                if (val) {
                    const num = parseInt(val) || 1;
                    b.livestock[animal.toLowerCase()] += num;
                    livestockStats[animal.toLowerCase()] += num;
                }
            });
        }

        // Government support flags
        ['TUPAD','Local 4Ps','National 4Ps','Local Social Pension','National Social Pension','Solo Parent Assistance','Relief Goods','Cash Subsidy'].forEach(k=>{
            if(String(getField(r,k)||'').toLowerCase().trim() === 'yes'){
                b.support[k] = (b.support[k]||0) + 1;
            }
        });

        // Age buckets
        const ageField = String(getField(r,'Age')||'').trim();
        let y = null;
        if(ageField){
            const m = ageField.match(/(\d+)/);
            if(m) y = Number(m[1]);
        }
        const ab = (y === null) ? 'Unknown' : (y <=5 ? '0-5' : y <=17 ? '6-17' : y <=59 ? '18-59' : '60+');
        b.ageBuckets[ab] = (b.ageBuckets[ab]||0) + 1;
        
        // Educational Attainment - FIXED: Check multiple field names
        const educationField = String(getField(r,'Educational Attainment')||getField(r,'Educational')||'').trim();
        if(educationField) {
            const eduLower = educationField.toLowerCase();
            
            if(eduLower.includes('no formal') || eduLower === 'none' || eduLower === 'no education') {
                b.education.noFormalEducation++;
                overallEducation.noFormalEducation++;
            }
            else if(eduLower.includes('elementary level') || eduLower === 'elementary undergraduate') {
                b.education.elementaryLevel++;
                overallEducation.elementaryLevel++;
            }
            else if(eduLower.includes('elementary graduate') || eduLower === 'elementary') {
                b.education.elementaryGraduate++;
                overallEducation.elementaryGraduate++;
            }
            else if(eduLower.includes('junior high school level') || eduLower.includes('junior high level') || eduLower === 'junior high') {
                b.education.juniorHighSchoolLevel++;
                overallEducation.juniorHighSchoolLevel++;
            }
            else if(eduLower.includes('junior high school graduate') || eduLower.includes('junior high graduate') || eduLower === 'junior high grad') {
                b.education.juniorHighSchoolGraduate++;
                overallEducation.juniorHighSchoolGraduate++;
            }
            else if(eduLower.includes('senior high school level') || eduLower.includes('senior high level') || eduLower === 'senior high') {
                b.education.seniorHighSchoolLevel++;
                overallEducation.seniorHighSchoolLevel++;
            }
            else if(eduLower.includes('senior high school graduate') || eduLower.includes('senior high graduate') || eduLower === 'senior high grad') {
                b.education.seniorHighSchoolGraduate++;
                overallEducation.seniorHighSchoolGraduate++;
            }
            else if(eduLower.includes('college level') || eduLower === 'college undergraduate' || eduLower === 'college') {
                b.education.collegeLevel++;
                overallEducation.collegeLevel++;
            }
            else if(eduLower.includes('college graduate') || eduLower === 'college grad') {
                b.education.collegeGraduate++;
                overallEducation.collegeGraduate++;
            }
        }
        
        // Employment Status - FIXED: Check multiple field names
        const employmentField = String(getField(r,'Employment Status')||getField(r,'Employment')||'').trim().toLowerCase();
        if(employmentField) {
            if(employmentField.includes('employed') || employmentField === 'yes' || employmentField === 'working' || employmentField === 'work') {
                b.employment.employed++;
                overallEmployment.employed++;
            } else if(employmentField.includes('unemployed') || employmentField === 'no' || employmentField === 'not working' || employmentField === 'not work' || employmentField === 'none') {
                b.employment.unemployed++;
                overallEmployment.unemployed++;
            }
        }
        
        // Job Title/Description - FIXED: Check multiple field names
        const jobField = String(getField(r,'Job Title/Description')||getField(r,'Job Title')||getField(r,'Job')||'').trim();
        if(jobField && overallEmployment.employed > 0) {
            const jobLower = jobField.toLowerCase();
            
            // Office & Administrative Jobs
            if(jobLower.includes('administrative assistant') || jobLower.includes('admin assistant') || jobLower.includes('admin staff') || jobLower.includes('administrative')) {
                jobCategories.adminAssistant++;
            }
            else if(jobLower.includes('office clerk') || jobLower === 'clerk') {
                jobCategories.officeClerk++;
            }
            else if(jobLower.includes('secretary') || jobLower.includes('executive assistant')) {
                jobCategories.secretary++;
            }
            // Business & Management
            else if(jobLower.includes('project manager')) {
                jobCategories.projectManager++;
            }
            else if(jobLower.includes('operations manager')) {
                jobCategories.operationsManager++;
            }
            else if(jobLower.includes('hr staff') || jobLower.includes('hr officer') || jobLower.includes('human resources')) {
                jobCategories.hrStaff++;
            }
            else if(jobLower.includes('account manager')) {
                jobCategories.accountManager++;
            }
            // Accounting & Finance
            else if(jobLower.includes('accounting staff') || jobLower.includes('accountant')) {
                jobCategories.accountingStaff++;
            }
            else if(jobLower.includes('bookkeeper') || jobLower.includes('book keeping')) {
                jobCategories.bookkeeper++;
            }
            else if(jobLower.includes('payroll officer') || jobLower.includes('payroll')) {
                jobCategories.payrollOfficer++;
            }
            else if(jobLower.includes('auditor')) {
                jobCategories.auditor++;
            }
            // IT & Tech
            else if(jobLower.includes('it support') || jobLower.includes('it technician') || jobLower === 'it') {
                jobCategories.itSupport++;
            }
            else if(jobLower.includes('web developer') || jobLower.includes('web dev')) {
                jobCategories.webDeveloper++;
            }
            else if(jobLower.includes('software developer') || jobLower.includes('programmer') || jobLower.includes('coder')) {
                jobCategories.softwareDeveloper++;
            }
            else if(jobLower.includes('data analyst')) {
                jobCategories.dataAnalyst++;
            }
            else if(jobLower.includes('system administrator') || jobLower.includes('system admin')) {
                jobCategories.systemAdministrator++;
            }
            // Healthcare
            else if(jobLower.includes('nurse') || jobLower.includes('registered nurse')) {
                jobCategories.nurse++;
            }
            else if(jobLower.includes('medical technologist') || jobLower.includes('med tech')) {
                jobCategories.medicalTechnologist++;
            }
            else if(jobLower.includes('caregiver')) {
                jobCategories.caregiver++;
            }
            else if(jobLower.includes('pharmacist')) {
                jobCategories.pharmacist++;
            }
            // Education
            else if(jobLower.includes('teacher') || jobLower.includes('instructor') || jobLower.includes('faculty')) {
                jobCategories.teacher++;
            }
            else if(jobLower.includes('tutor')) {
                jobCategories.tutor++;
            }
            else if(jobLower.includes('school administrator') || jobLower.includes('principal')) {
                jobCategories.schoolAdministrator++;
            }
            // Sales & Customer Service
            else if(jobLower.includes('customer service') || jobLower.includes('csr') || jobLower.includes('call center')) {
                jobCategories.csr++;
            }
            else if(jobLower.includes('sales associate') || jobLower.includes('salesperson') || jobLower.includes('sales agent')) {
                jobCategories.salesAssociate++;
            }
            else if(jobLower.includes('cashier')) {
                jobCategories.cashier++;
            }
            else if(jobLower.includes('store supervisor') || jobLower.includes('store manager')) {
                jobCategories.storeSupervisor++;
            }
            // Skilled Work & Labor
            else if(jobLower.includes('electrician')) {
                jobCategories.electrician++;
            }
            else if(jobLower.includes('plumber')) {
                jobCategories.plumber++;
            }
            else if(jobLower.includes('welder')) {
                jobCategories.welder++;
            }
            else if(jobLower.includes('construction worker') || jobLower.includes('skilled laborer') || jobLower.includes('laborer')) {
                jobCategories.constructionWorker++;
            }
            // Delivery & Logistics
            else if(jobLower.includes('driver') || jobLower.includes('delivery driver') || jobLower.includes('truck driver')) {
                jobCategories.driver++;
            }
            else if(jobLower.includes('logistics staff') || jobLower.includes('logistics')) {
                jobCategories.logisticsStaff++;
            }
            else if(jobLower.includes('rider') || jobLower.includes('motorcycle delivery') || jobLower.includes('foodpanda') || jobLower.includes('grab')) {
                jobCategories.rider++;
            }
            // Food & Hospitality
            else if(jobLower.includes('cook') || jobLower.includes('chef')) {
                jobCategories.cook++;
            }
            else if(jobLower.includes('waiter') || jobLower.includes('service crew') || jobLower.includes('waitress')) {
                jobCategories.waiter++;
            }
            else if(jobLower.includes('barista')) {
                jobCategories.barista++;
            }
            else if(jobLower.includes('housekeeping') || jobLower.includes('housekeeper')) {
                jobCategories.housekeepingStaff++;
            }
            // Security & Public Service
            else if(jobLower.includes('security guard') || jobLower.includes('guard')) {
                jobCategories.securityGuard++;
            }
            else if(jobLower.includes('barangay staff') || jobLower.includes('barangay council') || jobLower.includes('barangay official')) {
                jobCategories.barangayStaff++;
            }
            else if(jobLower.includes('police officer') || jobLower.includes('policeman') || jobLower.includes('police')) {
                jobCategories.policeOfficer++;
            }
            else if(jobLower.includes('fire officer') || jobLower.includes('fireman') || jobLower.includes('firefighter')) {
                jobCategories.fireOfficer++;
            }
            // Media, Design & Creative
            else if(jobLower.includes('graphic designer') || jobLower.includes('graphics designer')) {
                jobCategories.graphicDesigner++;
            }
            else if(jobLower.includes('video editor') || jobLower.includes('video editing')) {
                jobCategories.videoEditor++;
            }
            else if(jobLower.includes('content writer') || jobLower.includes('writer')) {
                jobCategories.contentWriter++;
            }
            else if(jobLower.includes('social media manager') || jobLower.includes('social media')) {
                jobCategories.socialMediaManager++;
            }
        }
        
        // FishR & RBIS Registration - FIXED: Check multiple field names
        const fishrField = String(getField(r,'FishR & RBIS')||getField(r,'FishR Registered/RBIS Registered')||getField(r,'FishR')||'').trim().toLowerCase();
        if(fishrField) {
            if(fishrField.includes('fishr') && fishrField.includes('rbis')) {
                b.fishr.bothRegistered++;
                fishrStats.bothRegistered++;
            } else if(fishrField.includes('fishr')) {
                b.fishr.fishrRegistered++;
                fishrStats.fishrRegistered++;
            } else if(fishrField.includes('rbis')) {
                b.fishr.rbisRegistered++;
                fishrStats.rbisRegistered++;
            } else {
                b.fishr.notRegistered++;
                fishrStats.notRegistered++;
            }
        } else {
            b.fishr.notRegistered++;
            fishrStats.notRegistered++;
        }
        
        // OFW Country - FIXED: Check multiple field names
        const ofwField = String(getField(r,'Overseas Filipino Worker(OFW)')||getField(r,'Overseas Filipino Worker (OFW)')||getField(r,'OFW')||'').trim().toLowerCase();
        if(ofwField === 'yes' || ofwField === 'true' || ofwField === '1' || ofwField.includes('ofw')) {
            const countryField = String(getField(r,'Country')||'').trim().toLowerCase();
            
            if(countryField.includes('saudi')) {
                ofwCountries.saudiArabia++;
                b.ofw.saudiArabia++;
            } else if(countryField.includes('uae') || countryField.includes('united arab emirates')) {
                ofwCountries.uae++;
                b.ofw.uae++;
            } else if(countryField.includes('qatar')) {
                ofwCountries.qatar++;
                b.ofw.qatar++;
            } else if(countryField.includes('kuwait')) {
                ofwCountries.kuwait++;
                b.ofw.kuwait++;
            } else if(countryField.includes('bahrain')) {
                ofwCountries.bahrain++;
                b.ofw.bahrain++;
            } else if(countryField.includes('oman')) {
                ofwCountries.oman++;
                b.ofw.oman++;
            } else if(countryField.includes('hong kong')) {
                ofwCountries.hongKong++;
                b.ofw.hongKong++;
            } else if(countryField.includes('singapore')) {
                ofwCountries.singapore++;
                b.ofw.singapore++;
            } else if(countryField.includes('japan')) {
                ofwCountries.japan++;
                b.ofw.japan++;
            } else if(countryField.includes('taiwan')) {
                ofwCountries.taiwan++;
                b.ofw.taiwan++;
            } else if(countryField.includes('malaysia')) {
                ofwCountries.malaysia++;
                b.ofw.malaysia++;
            } else if(countryField.includes('australia')) {
                ofwCountries.australia++;
                b.ofw.australia++;
            } else if(countryField.includes('new zealand')) {
                ofwCountries.newZealand++;
                b.ofw.newZealand++;
            } else if(countryField.includes('italy')) {
                ofwCountries.italy++;
                b.ofw.italy++;
            } else if(countryField.includes('uk') || countryField.includes('united kingdom')) {
                ofwCountries.uk++;
                b.ofw.uk++;
            } else if(countryField.includes('germany')) {
                ofwCountries.germany++;
                b.ofw.germany++;
            } else if(countryField.includes('cyprus')) {
                ofwCountries.cyprus++;
                b.ofw.cyprus++;
            } else if(countryField.includes('canada')) {
                ofwCountries.canada++;
                b.ofw.canada++;
            } else if(countryField.includes('usa') || countryField.includes('united states')) {
                ofwCountries.usa++;
                b.ofw.usa++;
            } else if(countryField.includes('libya')) {
                ofwCountries.libya++;
                b.ofw.libya++;
            } else if(countryField.trim() !== '') {
                ofwCountries.others++;
                b.ofw.others++;
            }
        }
    });

    // Update top cards
    document.getElementById('totalHeads').innerText = totalHeads;
    document.getElementById('totalMembers').innerText = totalMembers;

    // Update Basic Population Overview - Single Card
    // Demographics Section - NOW WITH 4 CARDS INCLUDING COORDINATES
    const demographicsStatsDiv = document.getElementById('demographicsStats');
    demographicsStatsDiv.innerHTML = '';
    
    // Create array with all demographics stats INCLUDING coordinates
    const demographicsData = [
        ['Male', demographicsStats.male],
        ['Female', demographicsStats.female], 
        ['PWD', demographicsStats.pwd],
        ['With Coordinates', headsWithCoords] // ADD THIS LINE
    ];
    
    demographicsData.forEach(it => {
        const div = document.createElement('div'); 
        div.className = 'category-card'; 
        
        // For "With Coordinates" card, add mini text
        if (it[0] === 'With Coordinates') {
            div.innerHTML = `
                <div class="category-label">${it[0]}</div>
                <div class="category-value">${it[1]}</div>
            `;
        } else {
            div.innerHTML = `
                <div class="category-label">${it[0]}</div>
                <div class="category-value">${it[1]}</div>
            `;
        }
        
        demographicsStatsDiv.appendChild(div);
    });
    
    // Educational Attainment Section
    const educationStatsDiv = document.getElementById('educationStats');
    educationStatsDiv.innerHTML = '';
    
    const educationLabels = {
        noFormalEducation: 'No Formal Education',
        elementaryLevel: 'Elementary Level',
        elementaryGraduate: 'Elementary Graduate',
        juniorHighSchoolLevel: 'Junior High School Level',
        juniorHighSchoolGraduate: 'Junior High School Graduate',
        seniorHighSchoolLevel: 'Senior High School Level',
        seniorHighSchoolGraduate: 'Senior High School Graduate',
        collegeLevel: 'College Level',
        collegeGraduate: 'College Graduate'
    };
    
    Object.entries(educationLabels).forEach(([key, label]) => {
        const count = overallEducation[key] || 0;
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            educationStatsDiv.appendChild(div);
        }
    });
    
    // Employment Status Section - FIXED: Now shows data
    const employmentStatsDiv = document.getElementById('employmentStats');
    employmentStatsDiv.innerHTML = '';
    
    // Always show both employed and unemployed
    ['Employed', 'Unemployed'].forEach(status => {
        const count = status === 'Employed' ? overallEmployment.employed : overallEmployment.unemployed;
        const div = document.createElement('div'); 
        div.className = 'category-card'; 
        div.innerHTML = `<div class="category-label">${status}</div><div class="category-value">${count}</div>`;
        employmentStatsDiv.appendChild(div);
    });
    
    // FishR & RBIS Section
    const fishrStatsDiv = document.getElementById('fishrStats');
    fishrStatsDiv.innerHTML = '';
    
    [['FishR Registered', fishrStats.fishrRegistered], 
     ['RBIS Registered', fishrStats.rbisRegistered], 
     ['FishR & RBIS Registered', fishrStats.bothRegistered]].forEach(it=>{
        const div = document.createElement('div'); 
        div.className = 'category-card'; 
        div.innerHTML = `<div class="category-label">${it[0]}</div><div class="category-value">${it[1]}</div>`;
        fishrStatsDiv.appendChild(div);
    });
    
    // Job Categories Sections
    
    // Office & Administrative Jobs
    const officeJobsDiv = document.getElementById('officeJobs');
    officeJobsDiv.innerHTML = '';
    [['Admin Assistant', jobCategories.adminAssistant], 
     ['Office Clerk', jobCategories.officeClerk], 
     ['Secretary', jobCategories.secretary]].forEach(([label, count]) => {
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            officeJobsDiv.appendChild(div);
        }
    });
    
    // Business & Management
    const businessJobsDiv = document.getElementById('businessJobs');
    businessJobsDiv.innerHTML = '';
    [['Project Manager', jobCategories.projectManager], 
     ['Operations Manager', jobCategories.operationsManager], 
     ['HR Staff', jobCategories.hrStaff], 
     ['Account Manager', jobCategories.accountManager]].forEach(([label, count]) => {
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            businessJobsDiv.appendChild(div);
        }
    });
    
    // Accounting & Finance
    const accountingJobsDiv = document.getElementById('accountingJobs');
    accountingJobsDiv.innerHTML = '';
    [['Accounting Staff', jobCategories.accountingStaff], 
     ['Bookkeeper', jobCategories.bookkeeper], 
     ['Payroll Officer', jobCategories.payrollOfficer], 
     ['Auditor', jobCategories.auditor]].forEach(([label, count]) => {
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            accountingJobsDiv.appendChild(div);
        }
    });
    
    // IT & Tech
    const itJobsDiv = document.getElementById('itJobs');
    itJobsDiv.innerHTML = '';
    [['IT Support', jobCategories.itSupport], 
     ['Web Developer', jobCategories.webDeveloper], 
     ['Software Developer', jobCategories.softwareDeveloper], 
     ['Data Analyst', jobCategories.dataAnalyst], 
     ['System Admin', jobCategories.systemAdministrator]].forEach(([label, count]) => {
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            itJobsDiv.appendChild(div);
        }
    });
    
    // Healthcare
    const healthcareJobsDiv = document.getElementById('healthcareJobs');
    healthcareJobsDiv.innerHTML = '';
    [['Nurse', jobCategories.nurse], 
     ['Medical Technologist', jobCategories.medicalTechnologist], 
     ['Caregiver', jobCategories.caregiver], 
     ['Pharmacist', jobCategories.pharmacist]].forEach(([label, count]) => {
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            healthcareJobsDiv.appendChild(div);
        }
    });
    
    // Education
    const educationJobsDiv = document.getElementById('educationJobs');
    educationJobsDiv.innerHTML = '';
    [['Teacher', jobCategories.teacher], 
     ['Tutor', jobCategories.tutor], 
     ['School Admin', jobCategories.schoolAdministrator]].forEach(([label, count]) => {
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            educationJobsDiv.appendChild(div);
        }
    });
    
    // Sales & Customer Service
    const salesJobsDiv = document.getElementById('salesJobs');
    salesJobsDiv.innerHTML = '';
    [['CSR', jobCategories.csr], 
     ['Sales Associate', jobCategories.salesAssociate], 
     ['Cashier', jobCategories.cashier], 
     ['Store Supervisor', jobCategories.storeSupervisor]].forEach(([label, count]) => {
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            salesJobsDiv.appendChild(div);
        }
    });
    
    // Skilled Work & Labor
    const skilledJobsDiv = document.getElementById('skilledJobs');
    skilledJobsDiv.innerHTML = '';
    [['Electrician', jobCategories.electrician], 
     ['Plumber', jobCategories.plumber], 
     ['Welder', jobCategories.welder], 
     ['Construction Worker', jobCategories.constructionWorker]].forEach(([label, count]) => {
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            skilledJobsDiv.appendChild(div);
        }
    });
    
    // Delivery & Logistics
    const deliveryJobsDiv = document.getElementById('deliveryJobs');
    deliveryJobsDiv.innerHTML = '';
    [['Driver', jobCategories.driver], 
     ['Logistics Staff', jobCategories.logisticsStaff], 
     ['Rider', jobCategories.rider]].forEach(([label, count]) => {
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            deliveryJobsDiv.appendChild(div);
        }
    });
    
    // Food & Hospitality
    const foodJobsDiv = document.getElementById('foodJobs');
    foodJobsDiv.innerHTML = '';
    [['Cook', jobCategories.cook], 
     ['Waiter', jobCategories.waiter], 
     ['Barista', jobCategories.barista], 
     ['Housekeeping', jobCategories.housekeepingStaff]].forEach(([label, count]) => {
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            foodJobsDiv.appendChild(div);
        }
    });
    
    // Security & Public Service
    const securityJobsDiv = document.getElementById('securityJobs');
    securityJobsDiv.innerHTML = '';
    [['Security Guard', jobCategories.securityGuard], 
     ['Barangay Staff', jobCategories.barangayStaff], 
     ['Police Officer', jobCategories.policeOfficer], 
     ['Fire Officer', jobCategories.fireOfficer]].forEach(([label, count]) => {
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            securityJobsDiv.appendChild(div);
        }
    });
    
    // Media, Design & Creative
    const mediaJobsDiv = document.getElementById('mediaJobs');
    mediaJobsDiv.innerHTML = '';
    [['Graphic Designer', jobCategories.graphicDesigner], 
     ['Video Editor', jobCategories.videoEditor], 
     ['Content Writer', jobCategories.contentWriter], 
     ['Social Media Manager', jobCategories.socialMediaManager]].forEach(([label, count]) => {
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            mediaJobsDiv.appendChild(div);
        }
    });
    
    // OFW Countries Section - FIXED: Now shows data
    const ofwCountriesStatsDiv = document.getElementById('ofwCountriesStats');
    ofwCountriesStatsDiv.innerHTML = '';
    
    const ofwLabels = {
        saudiArabia: 'Saudi Arabia',
        uae: 'United Arab Emirates',
        qatar: 'Qatar',
        kuwait: 'Kuwait',
        bahrain: 'Bahrain',
        oman: 'Oman',
        hongKong: 'Hong Kong',
        singapore: 'Singapore',
        japan: 'Japan',
        taiwan: 'Taiwan',
        malaysia: 'Malaysia',
        australia: 'Australia',
        newZealand: 'New Zealand',
        italy: 'Italy',
        uk: 'United Kingdom',
        germany: 'Germany',
        cyprus: 'Cyprus',
        canada: 'Canada',
        usa: 'United States',
        libya: 'Libya'
    };
    
    Object.entries(ofwLabels).forEach(([key, label]) => {
        const count = ofwCountries[key] || 0;
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            ofwCountriesStatsDiv.appendChild(div);
        }
    });
    
    // Domestic Livestock Section
    const livestockStatsDiv = document.getElementById('livestockStats');
    livestockStatsDiv.innerHTML = '';
    
    const livestockLabels = {
        dog: 'Dog',
        cat: 'Cat',
        pig: 'Pig',
        cow: 'Cow',
        carabao: 'Carabao',
        chicken: 'Chicken',
        others: 'Others'
    };
    
    Object.entries(livestockLabels).forEach(([key, label]) => {
        const count = livestockStats[key] || 0;
        if(count > 0) {
            const div = document.createElement('div'); 
            div.className = 'category-card'; 
            div.innerHTML = `<div class="category-label">${label}</div><div class="category-value">${count}</div>`;
            livestockStatsDiv.appendChild(div);
        }
    });

    // Chart: heads vs members per barangay
    destroyChart();
    const labels = Object.keys(barangayMap).sort();
    const headsData = labels.map(l => barangayMap[l].heads || 0);
    const membersData = labels.map(l => barangayMap[l].members || 0);
    const ctx = document.getElementById('barangayChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'bar',
        data: { 
            labels, 
            datasets: [
                { 
                    label: 'Heads', 
                    data: headsData, 
                    backgroundColor: '#2b9348' 
                }, 
                { 
                    label: 'Members', 
                    data: membersData, 
                    backgroundColor: '#55a630' 
                }
            ] 
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: true,
            plugins:{ 
                legend:{ 
                    position:'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                } 
            }, 
            scales:{ 
                y:{ 
                    beginAtZero:true,
                    ticks: {
                        precision: 0
                    }
                } 
            } 
        }
    });

    // Populate all breakdown tables
    // 1) Summary table
    const tbodySummary = document.querySelector('#tblSummary tbody'); 
    tbodySummary.innerHTML = '';
    labels.forEach(l => {
        const s = barangayMap[l];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${l}</td><td>${s.pwds||0}</td><td>${s.male||0}</td><td>${s.female||0}</td><td>${s.coords||0}</td>`;
        tbodySummary.appendChild(tr);
    });

    // 2) Government Support
    const supportKeys = ['TUPAD','Local 4Ps','National 4Ps','Local Social Pension','National Social Pension','Solo Parent Assistance','Relief Goods','Cash Subsidy'];
    const tbodySupport = document.querySelector('#tblSupport tbody'); 
    tbodySupport.innerHTML = '';
    labels.forEach(l=>{
        const s = barangayMap[l];
        const cells = supportKeys.map(k => s.support && s.support[k] ? s.support[k] : 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
        tbodySupport.appendChild(tr);
    });

    // 3) Status breakdown
    const statusKeys = ['With Sickness','Pregnant','Solo Parent','Lactating','Severe Illness','HIV Positive','LGBTQ Plus'];
    const tbodyStatus = document.querySelector('#tblStatus tbody'); 
    tbodyStatus.innerHTML = '';
    labels.forEach(l=>{
        const s = barangayMap[l];
        const cells = statusKeys.map(k => s.status && s.status[k] ? s.status[k] : 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
        tbodyStatus.appendChild(tr);
    });

    // 4) Age buckets
    const ageKeys = ['0-5','6-17','18-59','60+','Unknown'];
    const tbodyAge = document.querySelector('#tblAge tbody'); 
    tbodyAge.innerHTML = '';
    labels.forEach(l=>{
        const s = barangayMap[l];
        const cells = ageKeys.map(k => s.ageBuckets && s.ageBuckets[k] ? s.ageBuckets[k] : 0);
        const tr = document.createElement('tr'); 
        tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
        tbodyAge.appendChild(tr);
    });

    // 5) Sitio / Purok
    const sitios = ['I','II','III','IV','V','VI','VII','Unknown'];
    const tbodySitio = document.querySelector('#tblSitio tbody'); 
    tbodySitio.innerHTML = '';
    labels.forEach(l=>{
        const s = barangayMap[l];
        const cells = sitios.map(pk => s.sitio && s.sitio[pk] ? s.sitio[pk] : 0);
        const tr = document.createElement('tr'); 
        tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
        tbodySitio.appendChild(tr);
    });

    // 6) Livestock (with Others column)
    const tbodyLiv = document.querySelector('#tblLivestock tbody'); 
    tbodyLiv.innerHTML = '';
    labels.forEach(l=>{
        const s = barangayMap[l];
        const animals = ['dog', 'cat', 'pig', 'cow', 'carabao', 'chicken', 'others'];
        const cells = animals.map(a => s.livestock && s.livestock[a] ? s.livestock[a] : 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
        tbodyLiv.appendChild(tr);
    });
    
    // 7) Barangay Educational Attainment
    const tbodyBarangayEducation = document.querySelector('#tblBarangayEducation tbody'); 
    tbodyBarangayEducation.innerHTML = '';
    labels.forEach(l=>{
        const s = barangayMap[l];
        const cells = [
            s.education.noFormalEducation || 0,
            s.education.elementaryLevel || 0,
            s.education.elementaryGraduate || 0,
            s.education.juniorHighSchoolLevel || 0,
            s.education.juniorHighSchoolGraduate || 0,
            s.education.seniorHighSchoolLevel || 0,
            s.education.seniorHighSchoolGraduate || 0,
            s.education.collegeLevel || 0,
            s.education.collegeGraduate || 0
        ];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
        tbodyBarangayEducation.appendChild(tr);
    });
    
    // 8) Barangay Employment - FIXED: Now showing correct totals
    const tbodyBarangayEmployment = document.querySelector('#tblBarangayEmployment tbody'); 
    tbodyBarangayEmployment.innerHTML = '';
    labels.forEach(l=>{
        const s = barangayMap[l];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${l}</td><td>${s.employment.employed || 0}</td><td>${s.employment.unemployed || 0}</td>`;
        tbodyBarangayEmployment.appendChild(tr);
    });
    
    // 9) Barangay FishR & RBIS
    const tbodyBarangayFishR = document.querySelector('#tblBarangayFishR tbody'); 
    tbodyBarangayFishR.innerHTML = '';
    labels.forEach(l=>{
        const s = barangayMap[l];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${l}</td><td>${s.fishr.fishrRegistered || 0}</td><td>${s.fishr.rbisRegistered || 0}</td><td>${s.fishr.bothRegistered || 0}</td><td>${s.fishr.notRegistered || 0}</td>`;
        tbodyBarangayFishR.appendChild(tr);
    });
    
    // 10) Barangay OFW Countries - FIXED: All countries in header
    const tbodyBarangayOFW = document.querySelector('#tblBarangayOFW tbody'); 
    tbodyBarangayOFW.innerHTML = '';
    labels.forEach(l=>{
        const s = barangayMap[l];
        const cells = [
            s.ofw.saudiArabia || 0,
            s.ofw.uae || 0,
            s.ofw.qatar || 0,
            s.ofw.kuwait || 0,
            s.ofw.bahrain || 0,
            s.ofw.oman || 0,
            s.ofw.hongKong || 0,
            s.ofw.singapore || 0,
            s.ofw.japan || 0,
            s.ofw.taiwan || 0,
            s.ofw.malaysia || 0,
            s.ofw.australia || 0,
            s.ofw.newZealand || 0,
            s.ofw.italy || 0,
            s.ofw.uk || 0,
            s.ofw.germany || 0,
            s.ofw.cyprus || 0,
            s.ofw.canada || 0,
            s.ofw.usa || 0,
            s.ofw.libya || 0,
            s.ofw.others || 0
        ];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
        tbodyBarangayOFW.appendChild(tr);
    });
}

function notifyDataUpdated(action = 'Data Updated', details = 'Dashboard data refreshed') {
  // Only record allowed actions
  if (ALLOWED_ACTIONS.includes(action)) {
    recordUserActivity(action, details);
  }
  localStorage.setItem('dashboardDataCache', JSON.stringify({})); // Clear cache to force refresh
}

/* ENHANCED INITIALIZATION */
window.addEventListener('DOMContentLoaded', async () => {
    console.log("Dashboard initializing...");
    
    // Ensure user role is set BEFORE session check
    ensureUserRole();
    
    // First check session with enhanced validation
    const isAuthenticated = await safeSessionCheck();
    
    if (!isAuthenticated) {
        console.log("Not authenticated, redirecting...");
        return;
    }
    
    console.log("Authenticated, setting up dashboard...");
    
    // Setup auto-logout for inactivity
    setupAutoLogout();
    
    // Initialize activity monitoring with real-time updates
    setupActivityMonitoring();
    setupRealTimeActivityUpdates();
    loadActivityLog();
    
    // Setup dashboard auto-load functionality when dashboard tab is clicked
    setupDashboardAutoLoad();
    
    // STEP 1: Load cached dashboard data IMMEDIATELY (no loading screen)
    const hasCache = loadCachedDashboardData();
    
    // STEP 2: Load fresh data from server in background
    // Only show loading if there's NO cache (first visit)
    loadDashboard(!hasCache);
    
    // Auto-refresh dashboard data every 30 seconds (no loading screen)
    if (refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(() => {
        console.log("Auto-refreshing dashboard data...");
        loadDashboard(false);
    }, 30000);
    
    // Check screen width and adjust sidebar
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.remove('mobile-open');
    }
    
    console.log("Dashboard initialization complete");
});

/* SIDEBAR FUNCTIONS */
function toggleSidebar() {
    const pageContainer = document.querySelector('.page-container');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const icon = sidebarToggle.querySelector('i');
    
    pageContainer.classList.toggle('collapsed');
    
    if (pageContainer.classList.contains('collapsed')) {
        icon.className = 'fas fa-chevron-right';
        sidebarToggle.title = "Expand sidebar";
    } else {
        icon.className = 'fas fa-bars';
        sidebarToggle.title = "Collapse sidebar";
    }
}

function toggleMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    const icon = mobileToggle.querySelector('i');
    
    sidebar.classList.toggle('mobile-open');
    
    if (sidebar.classList.contains('mobile-open')) {
        icon.className = 'fas fa-times';
        mobileToggle.title = "Close menu";
    } else {
        icon.className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
}

/* Close mobile sidebar on click outside */
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    
    if (window.innerWidth <= 768) {
        if (!sidebar.contains(event.target) && !mobileToggle.contains(event.target) && sidebar.classList.contains('mobile-open')) {
            sidebar.classList.remove('mobile-open');
            mobileToggle.querySelector('i').className = 'fas fa-bars';
            mobileToggle.title = "Open menu";
        }
    }
});

/* WINDOW RESIZE HANDLER */
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        const sidebar = document.getElementById('sidebar');
        const mobileToggle = document.getElementById('mobileMenuToggle');
        
        sidebar.classList.remove('mobile-open');
        mobileToggle.querySelector('i').className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
});

/* Event Listeners */
document.getElementById('logoutBtn').addEventListener('click', enhancedLogout);

// Desktop sidebar toggle
document.getElementById('sidebarToggle').onclick = toggleSidebar;

// Mobile sidebar toggle
document.getElementById('mobileMenuToggle').onclick = toggleMobileSidebar;

/* PREVENT BACK BUTTON ISSUES - SIMPLIFIED */
window.addEventListener('pageshow', function(event) {
  // If page is loaded from cache (back/forward button)
  if (event.persisted) {
    console.log('Page loaded from cache, checking session...');
    
    // Don't automatically redirect. Just reload the dashboard data
    loadDashboard(false);
  }
});

/* Listen for data changes from other pages */
window.addEventListener('storage', function(e) {
  if (e.key === 'dashboardDataCache') {
    console.log('Dashboard data updated from another tab, refreshing...');
    loadCachedDashboardData();
  }
});

/* Also listen for visibility change to refresh when tab becomes active */
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    console.log('Tab became active, refreshing dashboard...');
    loadDashboard(false);
  }
});
</script>
<script src="js/data-broadcaster.js"></script>
<script src="js/dashboard-listener.js"></script>
<script src="common-utils.js"></script>
<script src="session-manager.js"></script>
<script src="common-session.js"></script>
<script src="activity-tracking-final.js"></script>
</body>
</html>











