<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan ‚Äî Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
   :root{
    --bg:#f6f8f7;
    --card-bg:#fff;
    --muted:#6b6f6b;
    --accent1:#0f7a4a;
    --accent2:#34b78f;
    --accent3: #ff7a00;
    --accent4: #ffa500;
    --light-green: #e9f7f2;
    --border: #e1e8e5;
    --shadow: 0 6px 18px rgba(6,30,20,0.06);
    --shadow-dark: 0 6px 20px rgba(5,40,25,0.12);
    --radius:12px;
    --radius-sm:8px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
   }

   body {
    background-color: var(--bg);
    margin: 0;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
   }

   .page-container{
    max-width:1200px;
    margin:20px auto;
    padding:12px;
    display:grid;
    grid-template-columns:260px 1fr;
    gap:18px;
    align-items:start;
    transition: grid-template-columns 0.3s ease;
   }

   .page-container.collapsed {
    grid-template-columns: 60px 1fr;
   }

   /* Topbar - Matching dataForm.html */
   .topbar{
    grid-column:1/-1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
    border-radius:var(--radius);
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    box-shadow:var(--shadow-dark);
   }

   .brand{
    display:flex;
    gap:12px;
    align-items:center;
   }

   .brand .logo{
    width:48px;
    height:48px;
    border-radius:var(--radius-sm);
    object-fit:contain;
    background: rgba(255,255,255,0.1);
    padding: 4px;
    border: 2px solid rgba(255,255,255,0.2);
   }

   .brand-text h1 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
   }

   .brand-text p {
    font-size:12px;
    opacity:0.95;
    margin: 4px 0 0 0;
   }

   .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
   }

   #userName {
    font-weight: 600;
    background: rgba(255,255,255,0.1);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
   }

   #logoutBtn {
    background: rgba(255,255,255,0.15);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.85rem;
    transition: all 0.2s ease;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
   }

   #logoutBtn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
   }

   /* Sidebar - Matching dataForm.html */
   .sidebar{
    background:linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.20));
    border-radius:var(--radius);
    padding:12px;
    height:calc(100vh - 120px);
    position:sticky;
    top:72px;
    overflow:auto;
    transition: width 0.3s ease;
   }

   .sidebar ul{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
   }

   .sidebar li a{
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    text-decoration: none;
    color: var(--muted);
    border-radius: var(--radius-sm);
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
   }

   .sidebar li a:hover{
    background: var(--light-green);
    color: var(--accent1);
   }

   .sidebar li a.active{
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .sidebar li a .menu-icon {
    font-size: 1.2rem;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
   }

   /* Content Area - Matching dataForm.html */
   .content-area{
    background:linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
    border-radius:var(--radius);
    padding:18px;
    box-shadow:0 8px 22px rgba(10,20,16,0.06);
    min-height:72vh;
    height: calc(100vh - 120px);
    overflow-y: auto;
    max-width: 100%;
    box-sizing: border-box;
   }

   /* Content Header - Matching dataForm.html */
   .content-header {
    margin-top: 0;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
   }

   .content-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: var(--accent1);
    display: flex;
    align-items: center;
    gap: 8px;
   }

   /* Description - Matching dataForm.html */
   #disc {
    margin-bottom: 16px;
    background: var(--light-green);
    padding: 12px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--accent1);
    font-size: 0.9rem;
    color: var(--muted);
    line-height: 1.5;
   }

   /* Card Styling */
   .card{ 
     padding:16px;
     border-radius:var(--radius);
     background:var(--card-bg);
     margin-bottom:12px;
     box-shadow:var(--shadow);
     border: 1px solid rgba(255,255,255,0.8);
     overflow: hidden;
   }

   /* Dashboard Cards */
   .dashboard-cards{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:12px;
    margin:12px 0 18px 0;
   }

   .card h3{ 
     margin:0 0 8px 0; 
     font-size:0.9rem; 
     color:var(--accent1);
     font-weight: 700;
   }
   
   .card-value{ 
     font-size:1.8rem; 
     font-weight:800; 
     color:#153b26;
     line-height: 1.2;
   }
   
   .mini { 
     font-size:0.8rem; 
     color:var(--muted);
     margin-top: 4px;
   }
   
   .stat-grid{
     display:grid;
     grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
     gap:12px;
   }

   /* Full-width breakdown layout */
   .break-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
    gap:16px;
    margin-top:16px;
    align-items:start;
    width:100%;
   }

   .break-card { 
     padding:16px; 
     border-radius:var(--radius); 
     background:var(--card-bg); 
     box-shadow:var(--shadow);
     overflow:auto;
     max-width:100%;
     width:100%;
   }

   .break-card h4 { 
     margin:0 0 12px 0; 
     font-size:0.95rem; 
     color:var(--accent1);
     font-weight: 700;
     display: flex;
     align-items: center;
     gap: 8px;
   }

   .break-table { 
     width:100%; 
     border-collapse:collapse; 
     text-align:center;
     font-size:0.85rem;
   }

   .break-table th, .break-table td { 
     padding:8px 10px; 
     border-bottom:1px solid var(--border);
   }

   .break-table thead th { 
     background: rgba(15,122,74,0.08); 
     font-weight:700; 
     color: var(--accent1);
     position: sticky; 
     top:0; 
     z-index:2;
     white-space: nowrap;
   }

   .break-table tbody tr:hover {
     background: var(--light-green);
   }

   .center-wrap { 
     display:flex; 
     justify-content:center;
     overflow-x: auto;
   }

   .small-muted { 
     font-size:0.85rem; 
     color:var(--muted); 
     margin-top:8px;
     text-align: center;
   }

   /* Improved responsive design */
   @media (max-width: 768px) {
     .page-container {
         grid-template-columns: 1fr !important;
         padding: 8px;
         gap: 12px;
         max-width: 100%;
     }
     
     .page-container.collapsed {
         grid-template-columns: 1fr !important;
     }
     
     .sidebar {
         position: fixed;
         top: 72px;
         left: 0;
         right: 0;
         height: auto;
         max-height: 0;
         overflow: hidden;
         z-index: 1000;
         margin: 0;
         padding: 0;
         border-radius: 0 0 var(--radius) var(--radius);
         background: white;
         box-shadow: var(--shadow);
         transition: max-height 0.3s ease;
     }
     
     .sidebar.mobile-open {
         max-height: 300px;
         padding: 12px;
         overflow-y: auto;
     }
     
     .content-area {
         height: auto;
         min-height: calc(100vh - 140px);
         padding: 16px;
     }
     
     .dashboard-cards {
         grid-template-columns: repeat(2, 1fr);
         gap: 10px;
     }
     
     .break-grid {
         grid-template-columns: 1fr;
         gap: 12px;
     }
     
     .break-card {
         padding: 12px;
         overflow-x: auto;
     }
     
     .break-table {
         font-size: 0.8rem;
     }
     
     .break-table th, .break-table td {
         padding: 6px 8px;
     }
     
     .card-value {
         font-size: 1.5rem;
     }
   }

   /* Small mobile devices */
   @media (max-width: 480px) {
     .dashboard-cards {
         grid-template-columns: 1fr;
     }
     
     .stat-grid {
         grid-template-columns: repeat(2, 1fr);
         gap: 8px;
     }
     
     .brand-text h1 {
         font-size: 1rem;
     }
     
     .brand-text p {
         font-size: 0.7rem;
     }
     
     #userName {
         font-size: 0.8rem;
         padding: 4px 8px;
     }
     
     .content-header h2 {
         font-size: 1.2rem;
     }
     
     .card {
         padding: 12px;
     }
   }

   /* Tablet-specific improvements */
   @media (min-width: 769px) and (max-width: 1024px) {
     .page-container {
         max-width: 95%;
         padding: 10px;
         gap: 16px;
     }
     
     .break-grid {
         grid-template-columns: repeat(2, 1fr);
         gap: 14px;
     }
     
     .dashboard-cards {
         grid-template-columns: repeat(2, 1fr);
     }
   }

   /* Sidebar toggle for mobile */
   .mobile-menu-toggle {
     display: none;
     background: linear-gradient(135deg, var(--accent1), var(--accent2));
     color: white;
     border: none;
     border-radius: var(--radius-sm);
     width: 36px;
     height: 36px;
     align-items: center;
     justify-content: center;
     cursor: pointer;
     font-size: 1rem;
     -webkit-tap-highlight-color: transparent;
     touch-action: manipulation;
   }

   @media (max-width: 768px) {
     .mobile-menu-toggle {
         display: flex !important;
     }
     
     .sidebar-toggle {
         display: none;
     }
   }

   /* Print styles */
   @media print {
     .sidebar, .topbar, .btn, .mobile-menu-toggle {
         display: none !important;
     }
     
     .page-container {
         grid-template-columns: 1fr !important;
         margin: 0;
         padding: 0;
     }
     
     .content-area {
         box-shadow: none;
         background: white;
         height: auto;
         overflow: visible;
     }
     
     .card {
         box-shadow: none;
         border: 1px solid #ddd;
         break-inside: avoid;
     }
   }

   /* High DPI/Retina display improvements */
   @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
     .logo {
         image-rendering: -webkit-optimize-contrast;
         image-rendering: crisp-edges;
     }
   }

   /* Chart container */
   #barangayChart {
     width: 100% !important;
     height: 160px !important;
   }

   /* Last updated styling */
   #lastUpdated {
     font-size: 0.95rem;
     font-weight: 600;
     color: var(--accent1);
   }
</style>
</head>

<body>
<div class="page-container">

  <header class="topbar">
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div class="brand-text">
        <h1>PUROK KALIGTASAN</h1>
        <p>Disaster Risk Reduction & Management Office - Alitagtag</p>
      </div>
    </div>

    <div class="user-info">
      <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
      </button>
      <span id="userName"></span>
      <button id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-container">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul>
        <li><a href="dashboard.html" class="active"><span class="menu-icon">üìä</span> <span class="menu-text">Dashboard</span></a></li>
        <li><a href="dataForm.html"><span class="menu-icon">üìù</span> <span class="menu-text">Data Entry</span></a></li>
        <li><a href="records.html"><span class="menu-icon">üìÅ</span> <span class="menu-text">Records</span></a></li>
        <li><a href="charts.html"><span class="menu-icon">üìà</span> <span class="menu-text">Charts</span></a></li>
        <li class="admin-only" id="navUsers" style="display:none;"><a href="users.html"><span class="menu-icon">üë•</span> <span class="menu-text">User Management</span></a></li>
      </ul>
    </div>
  </aside>

  <main class="content-area" tabindex="-1">
    <div class="content-header">
      <h2><span style="color: var(--accent1);">üìä</span> Dashboard Overview</h2>
    </div>

    <div id="disc">This dashboard provides a comprehensive overview of all household data collected. Monitor key metrics, track government support distribution, analyze demographic patterns, and view detailed breakdowns per barangay to make informed decisions for disaster risk reduction and management initiatives.</div>

    <div class="dashboard-cards">
      <div class="card">
        <h3>Total Household Heads</h3>
        <div id="totalHeads" class="card-value">0</div>
        <div class="mini">(rows without member name)</div>
      </div>

      <div class="card">
        <h3>Total Household Members</h3>
        <div id="totalMembers" class="card-value">0</div>
        <div class="mini">(all member rows)</div>
      </div>

      <div class="card">
        <h3>Households with Coordinates</h3>
        <div id="withCoords" class="card-value">0</div>
        <div class="mini">Heads that provided lat,lng</div>
      </div>

      <div class="card">
        <h3>Last Updated</h3>
        <div id="lastUpdated" class="card-value">---</div>
        <div class="mini">(m/d/yyyy hh:mm:ss AM/PM)</div>
      </div>
    </div>

    <div class="card">
      <h3>Quick Totals</h3>
      <div class="stat-grid" id="quickStats"></div>
    </div>

    <div class="card">
      <h3>Household Distribution per Barangay</h3>
      <canvas id="barangayChart" height="160"></canvas>
    </div>

    <!-- breakdowns grid - Full width but contained -->
    <div class="break-grid">

      <!-- Basic barangay summary (PWD + male/female/coords) -->
      <div class="break-card">
        <h4><i class="fas fa-chart-bar" style="color: var(--accent1);"></i> Barangay Summary</h4>
        <div class="center-wrap">
          <table class="break-table" id="tblSummary">
            <thead>
              <tr><th>Barangay</th><th>PWD</th><th>Male</th><th>Female</th><th>With Coord</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Government support -->
      <div class="break-card">
        <h4><i class="fas fa-hand-holding-heart" style="color: var(--accent1);"></i> Government Support (per Barangay)</h4>
        <div class="center-wrap">
          <table class="break-table" id="tblSupport">
            <thead>
              <tr>
                <th>Barangay</th>
                <th>TUPAD</th><th>Local 4Ps</th><th>National 4Ps</th>
                <th>Local SP</th><th>National SP</th><th>Solo Parent</th><th>Relief Goods</th><th>Cash Subsidy</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Status breakdown -->
      <div class="break-card">
        <h4><i class="fas fa-user-tag" style="color: var(--accent1);"></i> Status Breakdown (per Barangay)</h4>
        <div class="center-wrap">
          <table class="break-table" id="tblStatus">
            <thead>
              <tr>
                <th>Barangay</th>
                <th>With Sickness</th><th>Pregnant</th><th>Solo Parent</th><th>Lactating</th>
                <th>Severe Illness</th><th>HIV Positive</th><th>LGBTQ+</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Age buckets -->
      <div class="break-card">
        <h4><i class="fas fa-user-clock" style="color: var(--accent1);"></i> Age Buckets (per Barangay)</h4>
        <div class="center-wrap">
          <table class="break-table" id="tblAge">
            <thead><tr><th>Barangay</th><th>0-5</th><th>6-17</th><th>18-59</th><th>60+</th><th>Unknown</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Sitio/Purok -->
      <div class="break-card">
        <h4><i class="fas fa-map-marker-alt" style="color: var(--accent1);"></i> Sitio / Purok Distribution</h4>
        <div class="center-wrap">
          <table class="break-table" id="tblSitio">
            <thead><tr><th>Barangay</th><th>I</th><th>II</th><th>III</th><th>IV</th><th>V</th><th>VI</th><th>VII</th><th>Unknown</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Livestock -->
      <div class="break-card">
        <h4><i class="fas fa-paw" style="color: var(--accent1);"></i> Household Livestock (per Barangay)</h4>
        <div class="center-wrap">
          <table class="break-table" id="tblLivestock">
            <thead>
              <tr><th>Barangay</th><th>Dog (qty)</th><th>Cat (qty)</th><th>Pig (qty)</th><th>Cow (qty)</th><th>Carabao (qty)</th><th>Chicken (qty)</th><th>Others (list)</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div><!-- end break-grid -->

    <div class="small-muted">Tip: Data refreshes automatically every 30 seconds. Tables are responsive and scrollable on smaller screens.</div>

  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
/* CONFIG */
const API_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";
let chart = null;
let lastUpdateTime = null;

/* helpers */
function getField(obj, name){
  if(!obj) return "";
  const want = String(name).toLowerCase().trim();
  for(const k of Object.keys(obj)){
    if(String(k).toLowerCase().trim() === want) return obj[k];
  }
  return "";
}

function formatTS(date){
  if(!date) date = new Date();
  const m = date.getMonth()+1;
  const d = date.getDate();
  const y = date.getFullYear();
  let hh = date.getHours();
  const mm = String(date.getMinutes()).padStart(2,'0');
  const ss = String(date.getSeconds()).padStart(2,'0');
  const ampm = hh>=12 ? 'PM' : 'AM';
  hh = hh%12; hh = hh? hh:12;
  return `${m}/${d}/${y} ${String(hh).padStart(2,'0')}:${mm}:${ss} ${ampm}`;
}

async function fetchRecords(){ 
  const res = await fetch(`${API_URL}?action=getRecords`); 
  return res.json(); 
}

async function fetchLastUpdated(){
  try {
    // Try to get the last update time from server
    const res = await fetch(`${API_URL}?action=getLastUpdated`);
    const data = await res.json();
    if(data.success && data.lastUpdated) {
      lastUpdateTime = new Date(data.lastUpdated);
      return formatTS(lastUpdateTime);
    }
  } catch(err) {
    console.warn('Could not fetch last updated time:', err);
  }
  // Fallback to current time if server doesn't provide
  return formatTS(new Date());
}

function destroyChart(){ if(chart){ try{ chart.destroy(); }catch(e){} chart = null; } }

/* main */
async function loadDashboard(){
  try{
    const data = await fetchRecords();
    if(!data.success) throw new Error('Failed fetch');
    const rows = data.rows || [];

    // Get last updated time
    const lastUpdatedStr = await fetchLastUpdated();
    document.getElementById('lastUpdated').innerText = lastUpdatedStr || formatTS(new Date());

    // init containers
    let totalHeads = 0, totalMembers = 0, headsWithCoords = 0;
    const barangayMap = {}; // bn -> stats

    rows.forEach(r=>{
      const isHead = String(getField(r,'Name of Household Member/s')||'').trim() === '';
      const barangay = String(getField(r,'Barangay')||'Unknown').trim() || 'Unknown';
      const sex = String(getField(r,'Sex')||'').trim().toLowerCase();
      const coord = String(getField(r,'Coordinate')||'').trim();

      if(!barangayMap[barangay]){
        barangayMap[barangay] = {
          heads:0, members:0, male:0, female:0, coords:0, pwds:0,
          status:{}, reasons:{}, livestock:{}, ageBuckets:{}, sitio:{},
          // support counters:
          support: {
            "TUPAD":0, "Local 4Ps":0, "National 4Ps":0, "Local Social Pension":0, "National Social Pension":0,
            "Solo Parent Assistance":0, "Relief Goods":0, "Cash Subsidy":0
          }
        };
      }
      const b = barangayMap[barangay];

      if(isHead){ totalHeads++; b.heads++; if(coord){ headsWithCoords++; b.coords++; } }
      else { totalMembers++; b.members++; }

      // sex
      if(sex === 'male') b.male++; else if(sex === 'female') b.female++;

      // PWD
      if(String(getField(r,'Persons with Disability (PWD)')||'').toLowerCase().trim()==='yes') b.pwds++;

      // STATUS accumulation (map by known statuses)
      const statusRaw = String(getField(r,'Status')||'').trim();
      if(statusRaw){
        // sometimes multiple statuses? we treat as single if exact
        b.status[statusRaw] = (b.status[statusRaw]||0) + 1;
      }

      // Reasons
      const reason = String(getField(r,'Reasons for Displacement')||'').trim();
      if(reason) b.reasons[reason] = (b.reasons[reason]||0) + 1;

      // Sitio / Purok
      const sitioRaw = String(getField(r,'Sitio / Purok')||'').trim();
      let sitioKey = 'Unknown';
      if(sitioRaw){
        // normalize: allow "Purok I" or "I" variants
        const m = sitioRaw.match(/I{1,3}|IV|V|VI|VII|\b1\b|\b2\b|\b3\b|\b4\b|\b5\b|\b6\b|\b7\b/i);
        if(m){
          sitioKey = m[0].toString().replace(/\b1\b/,'I').replace(/\b2\b/,'II').replace(/\b3\b/,'III').replace(/\b4\b/,'IV').replace(/\b5\b/,'V').replace(/\b6\b/,'VI').replace(/\b7\b/,'VII').toUpperCase();
        } else {
          sitioKey = sitioRaw;
        }
      }
      b.sitio[sitioKey] = (b.sitio[sitioKey]||0) + 1;

      // Livestock keys present in spreadsheet header (qty fields are separate)
      const livestockKeys = ['Dog','Dog Qty.','Cat','Cat Qty.','Pig','Pig Qty.','Cow','Cow Qty.','Carabao','Carabao Qty.','Chicken','Chicken Qty.','Others'];
      livestockKeys.forEach(key=>{
        const val = String(getField(r,key) || '').trim();
        if(!val) return;
        if(key.toLowerCase().includes('qty')){
          const animal = key.replace(/\s*Qty\.?$/i,'').trim();
          const n = Number(val) || 0;
          if(!b.livestock[animal]) b.livestock[animal] = {qty:0, count:0};
          b.livestock[animal].qty += n;
        } else if(key.toLowerCase().trim() === 'others'){
          if(!b.livestock['Others']) b.livestock['Others'] = [];
          if(val) b.livestock['Others'].push(val);
        } else {
          // column like 'Dog' may be 'Yes' or blank or number -> if 'Yes' increment count else if numeric treat as qty
          if(String(val).toLowerCase() === 'yes'){
            if(!b.livestock[key]) b.livestock[key] = {qty:0, count:0};
            b.livestock[key].count += 1;
          } else if(!isNaN(Number(val)) && val !== ''){
            if(!b.livestock[key]) b.livestock[key] = {qty:0, count:0};
            b.livestock[key].qty += Number(val);
          }
        }
      });

      // Government support flags
      ['TUPAD','Local 4Ps','National 4Ps','Local Social Pension','National Social Pension','Solo Parent Assistance','Relief Goods','Cash Subsidy'].forEach(k=>{
        if(String(getField(r,k)||'').toLowerCase().trim() === 'yes'){
          b.support[k] = (b.support[k]||0) + 1;
        }
      });

      // Age buckets from Age field (try to parse number)
      const ageField = String(getField(r,'Age')||'').trim();
      let y = null;
      if(ageField){
        const m = ageField.match(/(\d+)/);
        if(m) y = Number(m[1]);
      }
      const ab = (y === null) ? 'Unknown' : (y <=5 ? '0-5' : y <=17 ? '6-17' : y <=59 ? '18-59' : '60+');
      b.ageBuckets[ab] = (b.ageBuckets[ab]||0) + 1;
    });

    // Update top cards
    document.getElementById('totalHeads').innerText = totalHeads;
    document.getElementById('totalMembers').innerText = totalMembers;
    document.getElementById('withCoords').innerText = headsWithCoords;

    // Quick totals
    const quick = document.getElementById('quickStats');
    quick.innerHTML = '';
    let totals = {male:0, female:0, pwd:0};
    const livestockTotals = {}, reasonsTotals = {}, supportTotals = {};
    Object.keys(barangayMap).forEach(bn=>{
      const s = barangayMap[bn];
      totals.male += s.male; totals.female += s.female; totals.pwd += s.pwds;
      // livestock aggregation
      Object.keys(s.livestock || {}).forEach(a=>{
        if(a === 'Others'){
          livestockTotals['Others'] = (livestockTotals['Others']||0) + (s.livestock['Others'] ? s.livestock['Others'].length : 0);
        } else {
          livestockTotals[a] = livestockTotals[a] || 0;
          livestockTotals[a] += (s.livestock[a] && s.livestock[a].qty) ? s.livestock[a].qty : (s.livestock[a] && s.livestock[a].count ? s.livestock[a].count : 0);
        }
      });
      // reasons
      Object.keys(s.reasons || {}).forEach(r => reasonsTotals[r] = (reasonsTotals[r]||0) + s.reasons[r]);
      // support totals
      Object.keys(s.support || {}).forEach(k => { supportTotals[k] = (supportTotals[k]||0) + s.support[k]; });
    });

    // show male/female/pwd
    [['Male', totals.male], ['Female', totals.female], ['PWD', totals.pwd]].forEach(it=>{
      const div = document.createElement('div'); div.className = 'card'; div.style.padding = '10px';
      div.innerHTML = `<div class="mini">${it[0]}</div><div class="card-value">${it[1]}</div>`;
      quick.appendChild(div);
    });
    // livestock (top few)
    Object.keys(livestockTotals).slice(0,6).forEach(k=>{
      const div = document.createElement('div'); div.className='card'; div.style.padding='10px';
      div.innerHTML = `<div class="mini">${k}</div><div class="card-value">${livestockTotals[k]}</div>`;
      quick.appendChild(div);
    });

    // Chart: heads vs members per barangay (same as before)
    destroyChart();
    const labels = Object.keys(barangayMap).sort();
    const headsData = labels.map(l => barangayMap[l].heads || 0);
    const membersData = labels.map(l => barangayMap[l].members || 0);
    const ctx = document.getElementById('barangayChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'bar',
      data: { 
        labels, 
        datasets: [
          { label: 'Heads', data: headsData, backgroundColor: '#0f7a4a' }, 
          { label: 'Members', data: membersData, backgroundColor: '#34b78f' }
        ] 
      },
      options: { 
        responsive:true, 
        maintainAspectRatio: false,
        plugins:{ 
          legend:{ 
            position:'bottom',
            labels: {
              font: {
                size: 12
              }
            }
          } 
        }, 
        scales:{ 
          y:{ 
            beginAtZero:true,
            ticks: {
              font: {
                size: 11
              }
            }
          },
          x: {
            ticks: {
              font: {
                size: 11
              }
            }
          }
        } 
      }
    });

    // Populate all breakdown tables (centered)
    // 1) Summary table (PWD / sex / coords)
    const tbodySummary = document.querySelector('#tblSummary tbody'); tbodySummary.innerHTML = '';
    labels.forEach(l => {
      const s = barangayMap[l];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td><td>${s.pwds||0}</td><td>${s.male||0}</td><td>${s.female||0}</td><td>${s.coords||0}</td>`;
      tbodySummary.appendChild(tr);
    });

    // 2) Government Support
    const supportKeys = ['TUPAD','Local 4Ps','National 4Ps','Local Social Pension','National Social Pension','Solo Parent Assistance','Relief Goods','Cash Subsidy'];
    const tbodySupport = document.querySelector('#tblSupport tbody'); tbodySupport.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = supportKeys.map(k => s.support && s.support[k] ? s.support[k] : 0);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodySupport.appendChild(tr);
    });

    // 3) Status breakdown (normalized to your list)
    const statusKeys = ['With Sickness','Pregnant','Solo Parent','Lactating','Severe Illness','HIV Positive','LGBTQ Plus'];
    const tbodyStatus = document.querySelector('#tblStatus tbody'); tbodyStatus.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = statusKeys.map(k => s.status && s.status[k] ? s.status[k] : 0);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodyStatus.appendChild(tr);
    });

    // 4) Age buckets
    const ageKeys = ['0-5','6-17','18-59','60+','Unknown'];
    const tbodyAge = document.querySelector('#tblAge tbody'); tbodyAge.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = ageKeys.map(k => s.ageBuckets && s.ageBuckets[k] ? s.ageBuckets[k] : 0);
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodyAge.appendChild(tr);
    });

    // 5) Sitio / Purok (I-VII + Unknown)
    const sitios = ['I','II','III','IV','V','VI','VII','Unknown'];
    const tbodySitio = document.querySelector('#tblSitio tbody'); tbodySitio.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = sitios.map(pk => s.sitio && s.sitio[pk] ? s.sitio[pk] : 0);
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodySitio.appendChild(tr);
    });

    // 6) Livestock: show total qty (or count) and list others
    const tbodyLiv = document.querySelector('#tblLivestock tbody'); tbodyLiv.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const animals = ['Dog','Cat','Pig','Cow','Carabao','Chicken'];
      const cells = animals.map(a => {
        const data = s.livestock && (s.livestock[a] || s.livestock[a==='Dog' ? 'Dog' : a]);
        if(!data) return 0;
        return (data.qty && data.qty > 0) ? data.qty : (data.count || 0);
      });
      const others = (s.livestock && s.livestock['Others']) ? s.livestock['Others'].slice(0,5).join('; ') : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('') + `<td title="${others}">${others.length > 30 ? others.substring(0, 30) + '...' : others}</td>`;
      tbodyLiv.appendChild(tr);
    });

  } catch(err){
    console.error('Load dashboard error', err);
    document.getElementById('lastUpdated').innerText = 'Error loading data';
  }
}

/* session + ui */
async function sessionCheck(){
  try {
    const r = await fetch(API_URL + '?action=sessionCheck');
    const j = await r.json();
    if(!j.success) return window.location.href = 'index.html';
    document.getElementById('userName').innerText = j.fullName || '';
    if(j.role === 'Admin') document.getElementById('navUsers').style.display = 'block';
  } catch(e){ console.warn('session check failed'); }
}

/* Sidebar toggle functionality */
function toggleSidebar() {
    const pageContainer = document.querySelector('.page-container');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const icon = sidebarToggle.querySelector('i');
    
    pageContainer.classList.toggle('collapsed');
    
    if (pageContainer.classList.contains('collapsed')) {
        icon.className = 'fas fa-chevron-right';
        sidebarToggle.title = "Expand sidebar";
    } else {
        icon.className = 'fas fa-bars';
        sidebarToggle.title = "Collapse sidebar";
    }
}

function toggleMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    const icon = mobileToggle.querySelector('i');
    
    sidebar.classList.toggle('mobile-open');
    
    if (sidebar.classList.contains('mobile-open')) {
        icon.className = 'fas fa-times';
        mobileToggle.title = "Close menu";
    } else {
        icon.className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
}

/* Close mobile sidebar on click outside */
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    
    if (window.innerWidth <= 768) {
        if (!sidebar.contains(event.target) && !mobileToggle.contains(event.target) && sidebar.classList.contains('mobile-open')) {
            sidebar.classList.remove('mobile-open');
            mobileToggle.querySelector('i').className = 'fas fa-bars';
            mobileToggle.title = "Open menu";
        }
    }
});

/* Window resize handler */
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        // On desktop, ensure sidebar is not in mobile-open state
        const sidebar = document.getElementById('sidebar');
        const mobileToggle = document.getElementById('mobileMenuToggle');
        
        sidebar.classList.remove('mobile-open');
        mobileToggle.querySelector('i').className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
});

/* Event listeners */
document.getElementById('logoutBtn').addEventListener('click', ()=>{ 
  fetch(API_URL+'?action=logout'); 
  window.location.href='index.html'; 
});

// Desktop sidebar toggle
document.getElementById('sidebarToggle').onclick = toggleSidebar;

// Mobile sidebar toggle
document.getElementById('mobileMenuToggle').onclick = toggleMobileSidebar;

/* Initialize dashboard */
window.addEventListener('DOMContentLoaded', async ()=>{
  await sessionCheck();
  await loadDashboard();
  setInterval(loadDashboard, 30000); // Refresh every 30 seconds
});
</script>
</body>
</html>
