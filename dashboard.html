<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan ‚Äî Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
   :root{
    --bg:#f6f8f7;
    --card-bg:#fff;
    --muted:#6b6f6b;
    --accent1:#0f7a4a;
    --accent2:#34b78f;
    --accent3: #ff7a00;
    --accent4: #ffa500;
    --light-green: #e9f7f2;
    --border: #e1e8e5;
    --shadow: 0 6px 18px rgba(6,30,20,0.06);
    --shadow-dark: 0 6px 20px rgba(5,40,25,0.12);
    --radius:12px;
    --radius-sm:8px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
   }

   body {
    background-color: var(--bg);
    margin: 0;
    min-height: 100vh;
   }

   .page-container{
    max-width:1200px;
    margin:20px auto;
    padding:12px;
    display:grid;
    grid-template-columns:260px 1fr;
    gap:18px;
    align-items:start;
    transition: grid-template-columns 0.3s ease;
   }

   .page-container.collapsed {
    grid-template-columns: 60px 1fr;
   }

   /* Topbar - Enhanced */
   .topbar{
    grid-column:1/-1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
    border-radius:var(--radius);
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    box-shadow:var(--shadow-dark);
   }

   .brand{
    display:flex;
    gap:12px;
    align-items:center;
   }

   .brand .logo{
    width:48px;
    height:48px;
    border-radius:var(--radius-sm);
    object-fit:contain;
    background: rgba(255,255,255,0.1);
    padding: 4px;
    border: 2px solid rgba(255,255,255,0.2);
   }

   .brand-text h1 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
   }

   .brand-text p {
    font-size:12px;
    opacity:0.95;
    margin: 4px 0 0 0;
   }

   .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
   }

   #userName {
    font-weight: 600;
    background: rgba(255,255,255,0.1);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
   }

   #logoutBtn {
    background: rgba(255,255,255,0.15);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
   }

   #logoutBtn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
   }

   /* Sidebar - Collapsible */
   .sidebar{
    background:linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.20));
    border-radius:var(--radius);
    padding:12px;
    height:calc(100vh - 120px);
    position:sticky;
    top:72px;
    overflow:auto;
    transition: width 0.3s ease;
   }

   .sidebar-container {
    display: flex;
    flex-direction: column;
    height: 100%;
   }

   .sidebar-toggle {
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.3s ease;
   }

   .sidebar-toggle:hover {
    transform: scale(1.1);
   }

   .sidebar ul{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
    flex: 1;
   }

   .sidebar li a{
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    text-decoration: none;
    color: var(--muted);
    border-radius: var(--radius-sm);
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
   }

   .sidebar li a:hover{
    background: var(--light-green);
    color: var(--accent1);
   }

   .sidebar li a.active{
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .sidebar li a .menu-icon {
    font-size: 1.2rem;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
   }

   .sidebar li a .menu-text {
    transition: opacity 0.3s ease;
   }

   .page-container.collapsed .sidebar li a .menu-text {
    opacity: 0;
    width: 0;
    overflow: hidden;
   }

   /* Content Area - Fixed Size */
   .content-area{
    background:linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
    border-radius:var(--radius);
    padding:18px;
    box-shadow:0 8px 22px rgba(10,20,16,0.06);
    min-height:72vh;
    height: calc(100vh - 120px);
    overflow-y: auto;
   }

   /* Content Header - Fixed */
   .content-header {
    margin-top: 0;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
   }

   .content-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: var(--accent1);
    display: flex;
    align-items: center;
    gap: 8px;
   }

   /* Description Styling */
   #disc {
    margin-bottom: 10px;
    background: var(--light-green);
    padding: 12px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--accent1);
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.5;
   }

   .description p {
    margin: 0;
   }

   /* Dashboard Cards */
   .dashboard-cards{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:12px;
    margin:12px 0 18px 0;
   }

   .card{
    padding:16px;
    border-radius:var(--radius);
    background:var(--card-bg);
    box-shadow:var(--shadow);
    transition: transform 0.2s ease;
   }

   .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(6,30,20,0.1);
   }

   .card h3{ 
    margin:0 0 8px 0; 
    font-size:14px; 
    color:var(--accent1);
    font-weight: 600;
   }

   .card-value{ 
    font-size:22px; 
    font-weight:800; 
    color:#153b26;
    margin: 8px 0;
   }

   .mini { 
    font-size:13px; 
    color:var(--muted);
   }

   .stat-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
    gap:8px;
    margin-top: 12px;
   }

   /* New: Extended Quick Stats Grid */
   .extended-quick-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin-top: 20px;
   }

   .extended-quick-stats .card {
    padding: 12px;
    min-height: 60px;
   }

   /* Barangay Breakdown - FULL WIDTH STACK */
   .breakdown-section {
    margin-top: 24px;
    width: 100%;
   }

   .breakdown-section h3 {
    font-size: 1.2rem;
    color: var(--accent1);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--light-green);
    display: flex;
    align-items: center;
    gap: 8px;
   }

   .breakdown-table-container {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
    overflow-x: auto;
    width: 100%;
   }

   .breakdown-table {
    width: 100%;
    border-collapse: collapse;
    text-align: center;
    min-width: 600px;
   }

   .breakdown-table th {
    background: rgba(15,122,74,0.08);
    padding: 12px 10px;
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--accent1);
    border-bottom: 2px solid rgba(15,122,74,0.1);
    position: sticky;
    left: 0;
    white-space: nowrap;
   }

   .breakdown-table td {
    padding: 10px 8px;
    border-bottom: 1px solid rgba(15,122,74,0.08);
    font-size: 0.85rem;
    color: var(--muted);
   }

   .breakdown-table tbody tr:hover {
    background: rgba(52,183,143,0.05);
   }

   .breakdown-table th:first-child,
   .breakdown-table td:first-child {
    position: sticky;
    left: 0;
    background: var(--card-bg);
    z-index: 1;
    text-align: left;
    font-weight: 600;
    color: var(--accent1);
   }

   .breakdown-table th:first-child {
    background: rgba(15,122,74,0.1);
   }

   /* Legend Box */
   .legend-box{
    margin-top:16px;
    display:inline-block;
    background:#fff;
    padding:12px;
    border-radius:var(--radius-sm);
    border:1px solid rgba(6,30,20,0.04);
    box-shadow:0 4px 14px rgba(6,30,20,0.06);
   }

   .legend-box h4 {
    margin: 0 0 8px 0;
    font-size: 0.9rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 6px;
   }

   .legend-item{
    display:flex;
    gap:8px;
    align-items:center;
    margin:6px 0;
    font-size:0.8rem;
   }

   .legend-swatch{
    width:14px;
    height:14px;
    border-radius:4px;
    flex-shrink: 0;
   }

   /* Button styling */
   .btn {
    border:0;
    padding:10px 14px;
    border-radius:var(--radius-sm);
    cursor:pointer;
    font-weight:600;
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    white-space: nowrap;
   }

   .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   /* Mobile Styles */
   @media (max-width: 768px) {
    .page-container {
        grid-template-columns: 1fr !important;
        padding: 8px;
        gap: 12px;
    }
    
    .page-container.collapsed {
        grid-template-columns: 1fr !important;
    }
    
    .sidebar {
        position: fixed;
        top: 72px;
        left: 0;
        right: 0;
        height: auto;
        max-height: 0;
        overflow: hidden;
        z-index: 1000;
        margin: 0;
        padding: 0;
        border-radius: 0 0 var(--radius) var(--radius);
        background: white;
        box-shadow: var(--shadow);
        transition: max-height 0.3s ease;
    }
    
    .sidebar.mobile-open {
        max-height: 300px;
        padding: 12px;
        overflow-y: auto;
    }
    
    .sidebar-container {
        flex-direction: column;
    }
    
    .sidebar-toggle {
        display: none;
    }
    
    .mobile-menu-toggle {
        display: flex !important;
        background: linear-gradient(135deg, var(--accent1), var(--accent2));
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        width: 40px;
        height: 40px;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
    }
    
    .content-area {
        height: auto;
        min-height: calc(100vh - 140px);
    }
    
    .dashboard-cards {
        grid-template-columns: 1fr;
    }
    
    .stat-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .extended-quick-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .breakdown-table-container {
        padding: 12px;
        margin-bottom: 16px;
    }
    
    .breakdown-table {
        min-width: 800px; /* Allow horizontal scroll on mobile */
    }
    
    .user-info {
        gap: 8px;
    }
    
    #userName {
        font-size: 0.9rem;
        padding: 6px 12px;
    }
    
    #logoutBtn {
        padding: 6px 12px;
        font-size: 0.85rem;
    }
   }

   /* Mobile menu toggle button */
   .mobile-menu-toggle {
    display: none;
   }

   /* Loading overlay */
   #loading {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(255,255,255,0.85);
    align-items:center;
    justify-content:center;
    z-index:9999;
    backdrop-filter: blur(2px);
   }

   .loading-content {
    background:#fff;
    padding:20px 24px;
    border-radius:var(--radius);
    box-shadow:var(--shadow-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
   }

   .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent1);
    border-radius: 50%;
    animation: spin 1s linear infinite;
   }

   @keyframes spin {
    to { transform: rotate(360deg); }
   }

   /* Chart container */
   .chart-container {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 20px 0;
    box-shadow: var(--shadow);
   }

   .chart-container h3 {
    margin: 0 0 16px 0;
    font-size: 1rem;
    color: var(--accent1);
    font-weight: 600;
   }

   /* Toggle buttons for extended quick stats */
   .toggle-stats-btn {
    margin-top: 10px;
    background: var(--light-green);
    color: var(--accent1);
    border: 1px solid var(--border);
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s ease;
   }

   .toggle-stats-btn:hover {
    background: var(--accent1);
    color: white;
   }
   
   /* Overall Totals Section */
   .overall-totals-section {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 20px 0;
    box-shadow: var(--shadow);
   }
   
   .overall-totals-section h3 {
    margin: 0 0 16px 0;
    font-size: 1.1rem;
    color: var(--accent1);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
   }
   
   .job-category-container {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
   }
   
   .job-category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 10px;
    margin-top: 10px;
   }
   
   .job-category-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: var(--light-green);
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
   }
   
   .job-category-label {
    color: var(--muted);
   }
   
   .job-category-value {
    font-weight: 600;
    color: var(--accent1);
    background: white;
    padding: 2px 8px;
    border-radius: 4px;
    min-width: 40px;
    text-align: center;
   }
   
   .job-category-header {
    font-weight: 600;
    color: var(--accent2);
    margin: 15px 0 8px 0;
    padding-bottom: 5px;
    border-bottom: 1px solid var(--border);
   }
</style>
</head>

<body>
<div class="page-container">

  <header class="topbar">
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div class="brand-text">
        <h1>PUROK KALIGTASAN</h1>
        <p>MDRRMO Alitagtag Household Records System</p>
      </div>
    </div>

    <div class="user-info">
      <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
      </button>
      <span id="userName"></span>
      <button id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-container">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul>
        <li><a href="dashboard.html" class="active" title="Dashboard"><span class="menu-icon">üìä</span> <span class="menu-text">Dashboard</span></a></li>
        <li><a href="dataForm.html" title="Data Entry"><span class="menu-icon">üìù</span> <span class="menu-text">Data Entry</span></a></li>
        <li><a href="records.html" title="Records"><span class="menu-icon">üìÅ</span> <span class="menu-text">Records</span></a></li>
        <li><a href="charts.html" title="Charts"><span class="menu-icon">üìà</span> <span class="menu-text">Charts</span></a></li>
        <li class="admin-only"><a href="users.html" title="User Management"><span class="menu-icon">üë•</span> <span class="menu-text">User Management</span></a></li>
      </ul>
    </div>
  </aside>

  <main class="content-area">
    <div class="content-header">
      <h2><span style="color: var(--accent1);">üìä</span> Dashboard Overview</h2>
    </div>

    <!-- Description -->
<div id="disc">This section presents a complete summary of all data recorded in the Purok Kaligtasan database. It provides quick insights into household profiles, population details, vulnerable groups, domestic animals, resources, and other important information gathered from the community. The dashboard helps users monitor trends, review totals at a glance, and easily understand the overall status of the purok for planning, reporting, and emergency response.</div>

    <!-- Top Cards -->
    <div class="breakdown-section">
      <h3><i class="fas fa-table"></i> Alitagtag Data Overview</h3></div>
    <div class="dashboard-cards">
      <div class="card">
        <h3>Total Household Heads</h3>
        <div id="totalHeads" class="card-value">0</div>
        <div class="mini">(rows without member name)</div>
      </div>

      <div class="card">
        <h3>Total Household Members</h3>
        <div id="totalMembers" class="card-value">0</div>
        <div class="mini">(all member rows)</div>
      </div>

      <div class="card">
        <h3>Households with Coordinates</h3>
        <div id="withCoords" class="card-value">0</div>
        <div class="mini">Heads that provided lat,lng</div>
      </div>

      <div class="card">
        <h3>Last Updated</h3>
        <div id="lastUpdated" class="card-value">---</div>
        <div class="mini">(m/d/yyyy hh:mm:ss AM/PM)</div>
      </div>
    </div>

    <!-- Basic Quick Stats -->
    <div class="card">
      <h3>Basic Population Overview</h3>
      <div class="stat-grid" id="quickStats"></div>
    </div>

    <!-- Overall (Quick Totals/OVERALL TOTAL) Section -->
    <div class="overall-totals-section">
      <h3><i class="fas fa-chart-bar"></i> OVERALL TOTAL - Employment & Education</h3>
      
      <!-- Employment Status -->
      <div>
        <h4 style="color: var(--accent1); margin-bottom: 10px;">Employment Status</h4>
        <div class="stat-grid" id="employmentOverall"></div>
      </div>
      
      <!-- Educational Attainment -->
      <div style="margin-top: 20px;">
        <h4 style="color: var(--accent1); margin-bottom: 10px;">Educational Attainment</h4>
        <div class="extended-quick-stats" id="educationOverall"></div>
      </div>
      
      <!-- Job Categories -->
      <div class="job-category-container">
        <h4 style="color: var(--accent1); margin-bottom: 10px;">Job Categories (Overall Total)</h4>
        
        <!-- Office & Administrative Jobs -->
        <div class="job-category-header">Office & Administrative Jobs</div>
        <div class="job-category-grid" id="officeJobs"></div>
        
        <!-- Business & Management -->
        <div class="job-category-header">Business & Management</div>
        <div class="job-category-grid" id="businessJobs"></div>
        
        <!-- Accounting & Finance -->
        <div class="job-category-header">Accounting & Finance</div>
        <div class="job-category-grid" id="accountingJobs"></div>
        
        <!-- IT & Tech -->
        <div class="job-category-header">IT & Tech</div>
        <div class="job-category-grid" id="itJobs"></div>
        
        <!-- Healthcare -->
        <div class="job-category-header">Healthcare</div>
        <div class="job-category-grid" id="healthcareJobs"></div>
        
        <!-- Education -->
        <div class="job-category-header">Education</div>
        <div class="job-category-grid" id="educationJobs"></div>
        
        <!-- Sales & Customer Service -->
        <div class="job-category-header">Sales & Customer Service</div>
        <div class="job-category-grid" id="salesJobs"></div>
        
        <!-- Skilled Work & Labor -->
        <div class="job-category-header">Skilled Work & Labor</div>
        <div class="job-category-grid" id="skilledJobs"></div>
        
        <!-- Delivery & Logistics -->
        <div class="job-category-header">Delivery & Logistics</div>
        <div class="job-category-grid" id="deliveryJobs"></div>
        
        <!-- Food & Hospitality -->
        <div class="job-category-header">Food & Hospitality</div>
        <div class="job-category-grid" id="foodJobs"></div>
        
        <!-- Security & Public Service -->
        <div class="job-category-header">Security & Public Service</div>
        <div class="job-category-grid" id="securityJobs"></div>
        
        <!-- Media, Design & Creative -->
        <div class="job-category-header">Media, Design & Creative</div>
        <div class="job-category-grid" id="mediaJobs"></div>
        
        <!-- Others -->
        <div id="othersJobsContainer" style="display: none;">
          <div class="job-category-header">Others</div>
          <div class="job-category-grid" id="othersJobs"></div>
        </div>
      </div>
    </div>

    <!-- Chart Container -->
    <div class="chart-container">
      <h3>Household Distribution Within Alitagtag</h3>
      <canvas id="barangayChart" height="160"></canvas>
    </div>

    <!-- Barangay Breakdown Section -->
    <div class="breakdown-section">
      <h3><i class="fas fa-table"></i> Barangay Data Overview</h3>

      <!-- 1. Barangay Summary -->
      <div class="breakdown-table-container">
        <h4>Demographics & Location Availability</h4>
        <table class="breakdown-table" id="tblSummary">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>PWD</th>
              <th>Male</th>
              <th>Female</th>
              <th>With Coordinates</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 2. Government Support -->
      <div class="breakdown-table-container">
        <h4>Government Assistance Programs</h4>
        <table class="breakdown-table" id="tblSupport">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>TUPAD</th>
              <th>Local 4Ps</th>
              <th>National 4Ps</th>
              <th>Local SP</th>
              <th>National SP</th>
              <th>Solo Parent</th>
              <th>Relief Goods</th>
              <th>Cash Subsidy</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 3. Status Breakdown -->
      <div class="breakdown-table-container">
        <h4>Household Status</h4>
        <table class="breakdown-table" id="tblStatus">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>With Sickness</th>
              <th>Pregnant</th>
              <th>Solo Parent</th>
              <th>Lactating</th>
              <th>Severe Illness</th>
              <th>HIV Positive</th>
              <th>LGBTQ+</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 4. Age Buckets -->
      <div class="breakdown-table-container">
        <h4>Population Age Groups</h4>
        <table class="breakdown-table" id="tblAge">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>0-5</th>
              <th>6-17</th>
              <th>18-59</th>
              <th>60+</th>
               <th>Unspecified</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 5. Sitio/Purok Distribution -->
      <div class="breakdown-table-container">
        <h4>Sitio / Purok Summary</h4>
        <table class="breakdown-table" id="tblSitio">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>I</th>
              <th>II</th>
              <th>III</th>
              <th>IV</th>
              <th>V</th>
              <th>VI</th>
              <th>VII</th>
              <th>Unspecified</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 6. Household Livestock -->
      <div class="breakdown-table-container">
        <h4>Domestic Livestock</h4>
        <table class="breakdown-table" id="tblLivestock">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>Dog (qty)</th>
              <th>Cat (qty)</th>
              <th>Pig (qty)</th>
              <th>Cow (qty)</th>
              <th>Carabao (qty)</th>
              <th>Chicken (qty)</th>
              <th>Others (list)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 7. Barangay Educational Attainment -->
      <div class="breakdown-table-container">
        <h4>Educational Attainment by Barangay</h4>
        <table class="breakdown-table" id="tblBarangayEducation">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>No Formal Education</th>
              <th>Elementary Level</th>
              <th>Elementary Graduate</th>
              <th>Junior High School Level</th>
              <th>Junior High School Graduate</th>
              <th>Senior High School Level</th>
              <th>Senior High School Graduate</th>
              <th>College Level</th>
              <th>College Graduate</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 8. Barangay Employment -->
      <div class="breakdown-table-container">
        <h4>Employment Status by Barangay</h4>
        <table class="breakdown-table" id="tblBarangayEmployment">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>Employed</th>
              <th>Unemployed</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div><!-- end breakdown-section -->

    <div class="small-muted" style="margin-top: 20px; font-size:12px; color:var(--muted);">
      Tip: Refresh or reopen page to recalc. Tables are responsive and optimized for all devices.
    </div>

  </main>
</div>

<!-- Loading overlay -->
<div id="loading">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div>Loading dashboard data‚Ä¶</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
/* CONFIG */
const API_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";
let chart = null;
let lastUpdatedTime = null;

/* helpers */
function getField(obj, name){
  if(!obj) return "";
  const want = String(name).toLowerCase().trim();
  for(const k of Object.keys(obj)){
    if(String(k).toLowerCase().trim() === want) return obj[k];
  }
  return "";
}

function formatTS(date){
  if(!date) date = new Date();
  const m = date.getMonth()+1;
  const d = date.getDate();
  const y = date.getFullYear();
  let hh = date.getHours();
  const mm = String(date.getMinutes()).padStart(2,'0');
  const ss = String(date.getSeconds()).padStart(2,'0');
  const ampm = hh>=12 ? 'PM' : 'AM';
  hh = hh%12; hh = hh? hh:12;
  return `${m}/${d}/${y} ${String(hh).padStart(2,'0')}:${mm}:${ss} ${ampm}`;
}

async function fetchRecords(){ 
  const res = await fetch(`${API_URL}?action=getRecords`); 
  return res.json(); 
}

function destroyChart(){ 
  if(chart){ 
    try{ chart.destroy(); }catch(e){} 
    chart = null; 
  } 
}

function showLoading(yes){ 
  document.getElementById("loading").style.display = yes ? "flex" : "none"; 
}

/* Load and store last updated time */
async function loadLastUpdated() {
  try {
    const storedTime = localStorage.getItem('lastDataUpdate');
    if (storedTime) {
      lastUpdatedTime = new Date(storedTime);
      document.getElementById('lastUpdated').innerText = formatTS(lastUpdatedTime);
    }
  } catch(err) {
    console.error('Error loading last updated time:', err);
  }
}

/* Update last updated time when data changes */
function updateLastUpdated() {
  lastUpdatedTime = new Date();
  localStorage.setItem('lastDataUpdate', lastUpdatedTime.toISOString());
  document.getElementById('lastUpdated').innerText = formatTS(lastUpdatedTime);
}

/* main dashboard load */
async function loadDashboard(){
  showLoading(true);
  try{
    const data = await fetchRecords();
    if(!data.success) throw new Error('Failed fetch');
    const rows = data.rows || [];

    // init containers
    let totalHeads = 0, totalMembers = 0, headsWithCoords = 0;
    const barangayMap = {};
    
    // Initialize overall totals
    const overallEmployment = {
      employed: 0,
      unemployed: 0
    };
    
    const overallEducation = {
      noFormalEducation: 0,
      elementaryLevel: 0,
      elementaryGraduate: 0,
      juniorHighSchoolLevel: 0,
      juniorHighSchoolGraduate: 0,
      seniorHighSchoolLevel: 0,
      seniorHighSchoolGraduate: 0,
      collegeLevel: 0,
      collegeGraduate: 0
    };
    
    const overallJobCategories = {
      // Office & Administrative Jobs
      adminAssistant: 0,
      officeClerk: 0,
      secretary: 0,
      
      // Business & Management
      projectManager: 0,
      operationsManager: 0,
      hrStaff: 0,
      accountManager: 0,
      
      // Accounting & Finance
      accountingStaff: 0,
      bookkeeper: 0,
      payrollOfficer: 0,
      auditor: 0,
      
      // IT & Tech
      itSupport: 0,
      webDeveloper: 0,
      softwareDeveloper: 0,
      dataAnalyst: 0,
      systemAdministrator: 0,
      
      // Healthcare
      nurse: 0,
      medicalTechnologist: 0,
      caregiver: 0,
      pharmacist: 0,
      
      // Education
      teacher: 0,
      tutor: 0,
      schoolAdministrator: 0,
      
      // Sales & Customer Service
      csr: 0,
      salesAssociate: 0,
      cashier: 0,
      storeSupervisor: 0,
      
      // Skilled Work & Labor
      electrician: 0,
      plumber: 0,
      welder: 0,
      constructionWorker: 0,
      
      // Delivery & Logistics
      driver: 0,
      logisticsStaff: 0,
      rider: 0,
      
      // Food & Hospitality
      cook: 0,
      waiter: 0,
      barista: 0,
      housekeepingStaff: 0,
      
      // Security & Public Service
      securityGuard: 0,
      barangayStaff: 0,
      policeOfficer: 0,
      fireOfficer: 0,
      
      // Media, Design & Creative
      graphicDesigner: 0,
      videoEditor: 0,
      contentWriter: 0,
      socialMediaManager: 0,
      
      // Others
      others: 0
    };
    
    // Track all unique job titles for "Others" category
    const otherJobTitles = {};

    rows.forEach(r=>{
      const isHead = String(getField(r,'Name of Household Member/s')||'').trim() === '';
      const barangay = String(getField(r,'Barangay')||'Unknown').trim() || 'Unknown';
      const sex = String(getField(r,'Sex')||'').trim().toLowerCase();
      const coord = String(getField(r,'Coordinate')||'').trim();

      if(!barangayMap[barangay]){
        barangayMap[barangay] = {
          heads:0, members:0, male:0, female:0, coords:0, pwds:0,
          status:{}, reasons:{}, livestock:{}, ageBuckets:{}, sitio:{},
          support: {
            "TUPAD":0, "Local 4Ps":0, "National 4Ps":0, "Local Social Pension":0, "National Social Pension":0,
            "Solo Parent Assistance":0, "Relief Goods":0, "Cash Subsidy":0
          },
          // Barangay specific education and employment
          education: {
            noFormalEducation: 0,
            elementaryLevel: 0,
            elementaryGraduate: 0,
            juniorHighSchoolLevel: 0,
            juniorHighSchoolGraduate: 0,
            seniorHighSchoolLevel: 0,
            seniorHighSchoolGraduate: 0,
            collegeLevel: 0,
            collegeGraduate: 0
          },
          employment: {
            employed: 0,
            unemployed: 0
          }
        };
      }
      const b = barangayMap[barangay];

      if(isHead){ 
        totalHeads++; 
        b.heads++; 
        if(coord){ 
          headsWithCoords++; 
          b.coords++; 
        } 
      } else { 
        totalMembers++; 
        b.members++; 
      }

      // sex
      if(sex === 'male') b.male++; 
      else if(sex === 'female') b.female++;

      // PWD
      if(String(getField(r,'Persons with Disability (PWD)')||'').toLowerCase().trim()==='yes') b.pwds++;

      // STATUS accumulation
      const statusRaw = String(getField(r,'Status')||'').trim();
      if(statusRaw){
        b.status[statusRaw] = (b.status[statusRaw]||0) + 1;
      }

      // Reasons
      const reason = String(getField(r,'Reasons for Displacement')||'').trim();
      if(reason) b.reasons[reason] = (b.reasons[reason]||0) + 1;

      // Sitio / Purok
      const sitioRaw = String(getField(r,'Sitio / Purok')||'').trim();
      let sitioKey = 'Unknown';
      if(sitioRaw){
        const m = sitioRaw.match(/I{1,3}|IV|V|VI|VII|\b1\b|\b2\b|\b3\b|\b4\b|\b5\b|\b6\b|\b7\b/i);
        if(m){
          sitioKey = m[0].toString().replace(/\b1\b/,'I').replace(/\b2\b/,'II').replace(/\b3\b/,'III').replace(/\b4\b/,'IV').replace(/\b5\b/,'V').replace(/\b6\b/,'VI').replace(/\b7\b/,'VII').toUpperCase();
        } else {
          sitioKey = sitioRaw;
        }
      }
      b.sitio[sitioKey] = (b.sitio[sitioKey]||0) + 1;

      // Livestock
      const livestockKeys = ['Dog','Dog Qty.','Cat','Cat Qty.','Pig','Pig Qty.','Cow','Cow Qty.','Carabao','Carabao Qty.','Chicken','Chicken Qty.','Others'];
      livestockKeys.forEach(key=>{
        const val = String(getField(r,key) || '').trim();
        if(!val) return;
        if(key.toLowerCase().includes('qty')){
          const animal = key.replace(/\s*Qty\.?$/i,'').trim();
          const n = Number(val) || 0;
          if(!b.livestock[animal]) b.livestock[animal] = {qty:0, count:0};
          b.livestock[animal].qty += n;
        } else if(key.toLowerCase().trim() === 'others'){
          if(!b.livestock['Others']) b.livestock['Others'] = [];
          if(val) b.livestock['Others'].push(val);
        } else {
          if(String(val).toLowerCase() === 'yes'){
            if(!b.livestock[key]) b.livestock[key] = {qty:0, count:0};
            b.livestock[key].count += 1;
          } else if(!isNaN(Number(val)) && val !== ''){
            if(!b.livestock[key]) b.livestock[key] = {qty:0, count:0};
            b.livestock[key].qty += Number(val);
          }
        }
      });

      // Government support flags
      ['TUPAD','Local 4Ps','National 4Ps','Local Social Pension','National Social Pension','Solo Parent Assistance','Relief Goods','Cash Subsidy'].forEach(k=>{
        if(String(getField(r,k)||'').toLowerCase().trim() === 'yes'){
          b.support[k] = (b.support[k]||0) + 1;
        }
      });

      // Age buckets
      const ageField = String(getField(r,'Age')||'').trim();
      let y = null;
      if(ageField){
        const m = ageField.match(/(\d+)/);
        if(m) y = Number(m[1]);
      }
      const ab = (y === null) ? 'Unknown' : (y <=5 ? '0-5' : y <=17 ? '6-17' : y <=59 ? '18-59' : '60+');
      b.ageBuckets[ab] = (b.ageBuckets[ab]||0) + 1;
      
      // Educational Attainment - More precise matching
      const educationField = String(getField(r,'Educational Attainment')||'').trim();
      if(educationField) {
        const eduLower = educationField.toLowerCase();
        
        if(eduLower.includes('no formal') || eduLower === 'none' || eduLower === 'no education') {
          b.education.noFormalEducation++;
          overallEducation.noFormalEducation++;
        }
        else if(eduLower.includes('elementary level') || eduLower === 'elementary undergraduate') {
          b.education.elementaryLevel++;
          overallEducation.elementaryLevel++;
        }
        else if(eduLower.includes('elementary graduate') || eduLower === 'elementary') {
          b.education.elementaryGraduate++;
          overallEducation.elementaryGraduate++;
        }
        else if(eduLower.includes('junior high school level') || eduLower.includes('junior high level') || eduLower === 'junior high') {
          b.education.juniorHighSchoolLevel++;
          overallEducation.juniorHighSchoolLevel++;
        }
        else if(eduLower.includes('junior high school graduate') || eduLower.includes('junior high graduate') || eduLower === 'junior high grad') {
          b.education.juniorHighSchoolGraduate++;
          overallEducation.juniorHighSchoolGraduate++;
        }
        else if(eduLower.includes('senior high school level') || eduLower.includes('senior high level') || eduLower === 'senior high') {
          b.education.seniorHighSchoolLevel++;
          overallEducation.seniorHighSchoolLevel++;
        }
        else if(eduLower.includes('senior high school graduate') || eduLower.includes('senior high graduate') || eduLower === 'senior high grad') {
          b.education.seniorHighSchoolGraduate++;
          overallEducation.seniorHighSchoolGraduate++;
        }
        else if(eduLower.includes('college level') || eduLower === 'college undergraduate' || eduLower === 'college') {
          b.education.collegeLevel++;
          overallEducation.collegeLevel++;
        }
        else if(eduLower.includes('college graduate') || eduLower === 'college grad') {
          b.education.collegeGraduate++;
          overallEducation.collegeGraduate++;
        }
      }
      
      // Employment Status - More precise matching
      const employmentField = String(getField(r,'Employment Status')||'').trim().toLowerCase();
      if(employmentField) {
        if(employmentField === 'employed' || employmentField === 'yes' || employmentField === 'working') {
          b.employment.employed++;
          overallEmployment.employed++;
        } else if(employmentField === 'unemployed' || employmentField === 'no' || employmentField === 'not working') {
          b.employment.unemployed++;
          overallEmployment.unemployed++;
        }
      }
      
      // Job Title/Description - More precise matching
      const jobField = String(getField(r,'Job Title/Description')||'').trim();
      if(jobField && (employmentField === 'employed' || employmentField === 'yes' || employmentField === 'working')) {
        const jobLower = jobField.toLowerCase();
        let matched = false;
        
        // Office & Administrative Jobs
        if(jobLower.includes('administrative assistant') || jobLower.includes('admin assistant') || jobLower.includes('admin staff')) {
          overallJobCategories.adminAssistant++;
          matched = true;
        }
        else if(jobLower.includes('office clerk') || jobLower === 'clerk') {
          overallJobCategories.officeClerk++;
          matched = true;
        }
        else if(jobLower.includes('secretary') || jobLower.includes('executive assistant')) {
          overallJobCategories.secretary++;
          matched = true;
        }
        // Business & Management
        else if(jobLower.includes('project manager')) {
          overallJobCategories.projectManager++;
          matched = true;
        }
        else if(jobLower.includes('operations manager')) {
          overallJobCategories.operationsManager++;
          matched = true;
        }
        else if(jobLower.includes('hr staff') || jobLower.includes('hr officer') || jobLower.includes('human resources')) {
          overallJobCategories.hrStaff++;
          matched = true;
        }
        else if(jobLower.includes('account manager')) {
          overallJobCategories.accountManager++;
          matched = true;
        }
        // Accounting & Finance
        else if(jobLower.includes('accounting staff') || jobLower.includes('accountant')) {
          overallJobCategories.accountingStaff++;
          matched = true;
        }
        else if(jobLower.includes('bookkeeper') || jobLower.includes('book keeping')) {
          overallJobCategories.bookkeeper++;
          matched = true;
        }
        else if(jobLower.includes('payroll officer') || jobLower.includes('payroll')) {
          overallJobCategories.payrollOfficer++;
          matched = true;
        }
        else if(jobLower.includes('auditor')) {
          overallJobCategories.auditor++;
          matched = true;
        }
        // IT & Tech
        else if(jobLower.includes('it support') || jobLower.includes('it technician') || jobLower === 'it') {
          overallJobCategories.itSupport++;
          matched = true;
        }
        else if(jobLower.includes('web developer') || jobLower.includes('web dev')) {
          overallJobCategories.webDeveloper++;
          matched = true;
        }
        else if(jobLower.includes('software developer') || jobLower.includes('programmer') || jobLower.includes('coder')) {
          overallJobCategories.softwareDeveloper++;
          matched = true;
        }
        else if(jobLower.includes('data analyst')) {
          overallJobCategories.dataAnalyst++;
          matched = true;
        }
        else if(jobLower.includes('system administrator') || jobLower.includes('system admin')) {
          overallJobCategories.systemAdministrator++;
          matched = true;
        }
        // Healthcare
        else if(jobLower.includes('nurse') || jobLower.includes('registered nurse')) {
          overallJobCategories.nurse++;
          matched = true;
        }
        else if(jobLower.includes('medical technologist') || jobLower.includes('med tech')) {
          overallJobCategories.medicalTechnologist++;
          matched = true;
        }
        else if(jobLower.includes('caregiver')) {
          overallJobCategories.caregiver++;
          matched = true;
        }
        else if(jobLower.includes('pharmacist')) {
          overallJobCategories.pharmacist++;
          matched = true;
        }
        // Education
        else if(jobLower.includes('teacher') || jobLower.includes('instructor') || jobLower.includes('faculty')) {
          overallJobCategories.teacher++;
          matched = true;
        }
        else if(jobLower.includes('tutor')) {
          overallJobCategories.tutor++;
          matched = true;
        }
        else if(jobLower.includes('school administrator') || jobLower.includes('principal')) {
          overallJobCategories.schoolAdministrator++;
          matched = true;
        }
        // Sales & Customer Service
        else if(jobLower.includes('customer service') || jobLower.includes('csr') || jobLower.includes('call center')) {
          overallJobCategories.csr++;
          matched = true;
        }
        else if(jobLower.includes('sales associate') || jobLower.includes('salesperson') || jobLower.includes('sales agent')) {
          overallJobCategories.salesAssociate++;
          matched = true;
        }
        else if(jobLower.includes('cashier')) {
          overallJobCategories.cashier++;
          matched = true;
        }
        else if(jobLower.includes('store supervisor') || jobLower.includes('store manager')) {
          overallJobCategories.storeSupervisor++;
          matched = true;
        }
        // Skilled Work & Labor
        else if(jobLower.includes('electrician')) {
          overallJobCategories.electrician++;
          matched = true;
        }
        else if(jobLower.includes('plumber')) {
          overallJobCategories.plumber++;
          matched = true;
        }
        else if(jobLower.includes('welder')) {
          overallJobCategories.welder++;
          matched = true;
        }
        else if(jobLower.includes('construction worker') || jobLower.includes('skilled laborer') || jobLower.includes('laborer')) {
          overallJobCategories.constructionWorker++;
          matched = true;
        }
        // Delivery & Logistics
        else if(jobLower.includes('driver') || jobLower.includes('delivery driver') || jobLower.includes('truck driver')) {
          overallJobCategories.driver++;
          matched = true;
        }
        else if(jobLower.includes('logistics staff') || jobLower.includes('logistics')) {
          overallJobCategories.logisticsStaff++;
          matched = true;
        }
        else if(jobLower.includes('rider') || jobLower.includes('motorcycle delivery') || jobLower.includes('foodpanda') || jobLower.includes('grab')) {
          overallJobCategories.rider++;
          matched = true;
        }
        // Food & Hospitality
        else if(jobLower.includes('cook') || jobLower.includes('chef')) {
          overallJobCategories.cook++;
          matched = true;
        }
        else if(jobLower.includes('waiter') || jobLower.includes('service crew') || jobLower.includes('waitress')) {
          overallJobCategories.waiter++;
          matched = true;
        }
        else if(jobLower.includes('barista')) {
          overallJobCategories.barista++;
          matched = true;
        }
        else if(jobLower.includes('housekeeping') || jobLower.includes('housekeeper')) {
          overallJobCategories.housekeepingStaff++;
          matched = true;
        }
        // Security & Public Service
        else if(jobLower.includes('security guard') || jobLower.includes('guard')) {
          overallJobCategories.securityGuard++;
          matched = true;
        }
        else if(jobLower.includes('barangay staff') || jobLower.includes('barangay council') || jobLower.includes('barangay official')) {
          overallJobCategories.barangayStaff++;
          matched = true;
        }
        else if(jobLower.includes('police officer') || jobLower.includes('policeman') || jobLower.includes('police')) {
          overallJobCategories.policeOfficer++;
          matched = true;
        }
        else if(jobLower.includes('fire officer') || jobLower.includes('fireman') || jobLower.includes('firefighter')) {
          overallJobCategories.fireOfficer++;
          matched = true;
        }
        // Media, Design & Creative
        else if(jobLower.includes('graphic designer') || jobLower.includes('graphics designer')) {
          overallJobCategories.graphicDesigner++;
          matched = true;
        }
        else if(jobLower.includes('video editor') || jobLower.includes('video editing')) {
          overallJobCategories.videoEditor++;
          matched = true;
        }
        else if(jobLower.includes('content writer') || jobLower.includes('writer')) {
          overallJobCategories.contentWriter++;
          matched = true;
        }
        else if(jobLower.includes('social media manager') || jobLower.includes('social media')) {
          overallJobCategories.socialMediaManager++;
          matched = true;
        }
        
        // If not matched to any specific category, add to "Others"
        if(!matched && jobField.trim() !== '') {
          overallJobCategories.others++;
          // Track the actual job title for display
          if(!otherJobTitles[jobField]) {
            otherJobTitles[jobField] = 0;
          }
          otherJobTitles[jobField]++;
        }
      }
    });

    // Update top cards
    document.getElementById('totalHeads').innerText = totalHeads;
    document.getElementById('totalMembers').innerText = totalMembers;
    document.getElementById('withCoords').innerText = headsWithCoords;

    // Quick totals
    const quick = document.getElementById('quickStats');
    quick.innerHTML = '';
    let totals = {male:0, female:0, pwd:0};
    const livestockTotals = {}, reasonsTotals = {}, supportTotals = {};
    Object.keys(barangayMap).forEach(bn=>{
      const s = barangayMap[bn];
      totals.male += s.male; totals.female += s.female; totals.pwd += s.pwds;
      Object.keys(s.livestock || {}).forEach(a=>{
        if(a === 'Others'){
          livestockTotals['Others'] = (livestockTotals['Others']||0) + (s.livestock['Others'] ? s.livestock['Others'].length : 0);
        } else {
          livestockTotals[a] = livestockTotals[a] || 0;
          livestockTotals[a] += (s.livestock[a] && s.livestock[a].qty) ? s.livestock[a].qty : (s.livestock[a] && s.livestock[a].count ? s.livestock[a].count : 0);
        }
      });
      Object.keys(s.reasons || {}).forEach(r => reasonsTotals[r] = (reasonsTotals[r]||0) + s.reasons[r]);
      Object.keys(s.support || {}).forEach(k => { supportTotals[k] = (supportTotals[k]||0) + s.support[k]; });
    });

    // show male/female/pwd
    [['Male', totals.male], ['Female', totals.female], ['PWD', totals.pwd]].forEach(it=>{
      const div = document.createElement('div'); 
      div.className = 'card'; 
      div.style.padding = '10px';
      div.innerHTML = `<div class="mini">${it[0]}</div><div class="card-value">${it[1]}</div>`;
      quick.appendChild(div);
    });

    // livestock (top few)
    Object.keys(livestockTotals).slice(0,6).forEach(k=>{
      const div = document.createElement('div'); 
      div.className='card'; 
      div.style.padding='10px';
      div.innerHTML = `<div class="mini">${k}</div><div class="card-value">${livestockTotals[k]}</div>`;
      quick.appendChild(div);
    });
    
    // Update Overall Employment Section
    const employmentOverall = document.getElementById('employmentOverall');
    employmentOverall.innerHTML = '';
    
    // Always show Employed and Unemployed (even if 0)
    ['Employed', 'Unemployed'].forEach(status => {
      const count = status === 'Employed' ? overallEmployment.employed : overallEmployment.unemployed;
      const div = document.createElement('div'); 
      div.className = 'card'; 
      div.style.padding = '10px';
      div.innerHTML = `<div class="mini">${status}</div><div class="card-value">${count}</div>`;
      employmentOverall.appendChild(div);
    });
    
    // Update Overall Education Section
    const educationOverall = document.getElementById('educationOverall');
    educationOverall.innerHTML = '';
    
    // Always show all education levels
    const educationLabels = {
      noFormalEducation: 'No Formal Education',
      elementaryLevel: 'Elementary Level',
      elementaryGraduate: 'Elementary Graduate',
      juniorHighSchoolLevel: 'Junior High School Level',
      juniorHighSchoolGraduate: 'Junior High School Graduate',
      seniorHighSchoolLevel: 'Senior High School Level',
      seniorHighSchoolGraduate: 'Senior High School Graduate',
      collegeLevel: 'College Level',
      collegeGraduate: 'College Graduate'
    };
    
    Object.entries(educationLabels).forEach(([key, label]) => {
      const count = overallEducation[key] || 0;
      const div = document.createElement('div'); 
      div.className = 'card'; 
      div.style.padding = '10px';
      div.innerHTML = `<div class="mini">${label}</div><div class="card-value">${count}</div>`;
      educationOverall.appendChild(div);
    });
    
    // Update Job Categories Section
    // Office & Administrative Jobs
    const officeJobs = document.getElementById('officeJobs');
    officeJobs.innerHTML = '';
    ['Admin Assistant', 'Office Clerk', 'Secretary'].forEach((label, index) => {
      const key = ['adminAssistant', 'officeClerk', 'secretary'][index];
      const count = overallJobCategories[key] || 0;
      if(count > 0) {
        const div = document.createElement('div');
        div.className = 'job-category-item';
        div.innerHTML = `
          <span class="job-category-label">${label}</span>
          <span class="job-category-value">${count}</span>
        `;
        officeJobs.appendChild(div);
      }
    });
    
    // Business & Management
    const businessJobs = document.getElementById('businessJobs');
    businessJobs.innerHTML = '';
    ['Project Manager', 'Operations Manager', 'HR Staff', 'Account Manager'].forEach((label, index) => {
      const key = ['projectManager', 'operationsManager', 'hrStaff', 'accountManager'][index];
      const count = overallJobCategories[key] || 0;
      if(count > 0) {
        const div = document.createElement('div');
        div.className = 'job-category-item';
        div.innerHTML = `
          <span class="job-category-label">${label}</span>
          <span class="job-category-value">${count}</span>
        `;
        businessJobs.appendChild(div);
      }
    });
    
    // Accounting & Finance
    const accountingJobs = document.getElementById('accountingJobs');
    accountingJobs.innerHTML = '';
    ['Accounting Staff', 'Bookkeeper', 'Payroll Officer', 'Auditor'].forEach((label, index) => {
      const key = ['accountingStaff', 'bookkeeper', 'payrollOfficer', 'auditor'][index];
      const count = overallJobCategories[key] || 0;
      if(count > 0) {
        const div = document.createElement('div');
        div.className = 'job-category-item';
        div.innerHTML = `
          <span class="job-category-label">${label}</span>
          <span class="job-category-value">${count}</span>
        `;
        accountingJobs.appendChild(div);
      }
    });
    
    // IT & Tech
    const itJobs = document.getElementById('itJobs');
    itJobs.innerHTML = '';
    ['IT Support', 'Web Developer', 'Software Developer', 'Data Analyst', 'System Admin'].forEach((label, index) => {
      const key = ['itSupport', 'webDeveloper', 'softwareDeveloper', 'dataAnalyst', 'systemAdministrator'][index];
      const count = overallJobCategories[key] || 0;
      if(count > 0) {
        const div = document.createElement('div');
        div.className = 'job-category-item';
        div.innerHTML = `
          <span class="job-category-label">${label}</span>
          <span class="job-category-value">${count}</span>
        `;
        itJobs.appendChild(div);
      }
    });
    
    // Healthcare
    const healthcareJobs = document.getElementById('healthcareJobs');
    healthcareJobs.innerHTML = '';
    ['Nurse', 'Medical Technologist', 'Caregiver', 'Pharmacist'].forEach((label, index) => {
      const key = ['nurse', 'medicalTechnologist', 'caregiver', 'pharmacist'][index];
      const count = overallJobCategories[key] || 0;
      if(count > 0) {
        const div = document.createElement('div');
        div.className = 'job-category-item';
        div.innerHTML = `
          <span class="job-category-label">${label}</span>
          <span class="job-category-value">${count}</span>
        `;
        healthcareJobs.appendChild(div);
      }
    });
    
    // Education
    const educationJobs = document.getElementById('educationJobs');
    educationJobs.innerHTML = '';
    ['Teacher', 'Tutor', 'School Admin'].forEach((label, index) => {
      const key = ['teacher', 'tutor', 'schoolAdministrator'][index];
      const count = overallJobCategories[key] || 0;
      if(count > 0) {
        const div = document.createElement('div');
        div.className = 'job-category-item';
        div.innerHTML = `
          <span class="job-category-label">${label}</span>
          <span class="job-category-value">${count}</span>
        `;
        educationJobs.appendChild(div);
      }
    });
    
    // Sales & Customer Service
    const salesJobs = document.getElementById('salesJobs');
    salesJobs.innerHTML = '';
    ['CSR', 'Sales Associate', 'Cashier', 'Store Supervisor'].forEach((label, index) => {
      const key = ['csr', 'salesAssociate', 'cashier', 'storeSupervisor'][index];
      const count = overallJobCategories[key] || 0;
      if(count > 0) {
        const div = document.createElement('div');
        div.className = 'job-category-item';
        div.innerHTML = `
          <span class="job-category-label">${label}</span>
          <span class="job-category-value">${count}</span>
        `;
        salesJobs.appendChild(div);
      }
    });
    
    // Skilled Work & Labor
    const skilledJobs = document.getElementById('skilledJobs');
    skilledJobs.innerHTML = '';
    ['Electrician', 'Plumber', 'Welder', 'Construction Worker'].forEach((label, index) => {
      const key = ['electrician', 'plumber', 'welder', 'constructionWorker'][index];
      const count = overallJobCategories[key] || 0;
      if(count > 0) {
        const div = document.createElement('div');
        div.className = 'job-category-item';
        div.innerHTML = `
          <span class="job-category-label">${label}</span>
          <span class="job-category-value">${count}</span>
        `;
        skilledJobs.appendChild(div);
      }
    });
    
    // Delivery & Logistics
    const deliveryJobs = document.getElementById('deliveryJobs');
    deliveryJobs.innerHTML = '';
    ['Driver', 'Logistics Staff', 'Rider'].forEach((label, index) => {
      const key = ['driver', 'logisticsStaff', 'rider'][index];
      const count = overallJobCategories[key] || 0;
      if(count > 0) {
        const div = document.createElement('div');
        div.className = 'job-category-item';
        div.innerHTML = `
          <span class="job-category-label">${label}</span>
          <span class="job-category-value">${count}</span>
        `;
        deliveryJobs.appendChild(div);
      }
    });
    
    // Food & Hospitality
    const foodJobs = document.getElementById('foodJobs');
    foodJobs.innerHTML = '';
    ['Cook', 'Waiter', 'Barista', 'Housekeeping'].forEach((label, index) => {
      const key = ['cook', 'waiter', 'barista', 'housekeepingStaff'][index];
      const count = overallJobCategories[key] || 0;
      if(count > 0) {
        const div = document.createElement('div');
        div.className = 'job-category-item';
        div.innerHTML = `
          <span class="job-category-label">${label}</span>
          <span class="job-category-value">${count}</span>
        `;
        foodJobs.appendChild(div);
      }
    });
    
    // Security & Public Service
    const securityJobs = document.getElementById('securityJobs');
    securityJobs.innerHTML = '';
    ['Security Guard', 'Barangay Staff', 'Police Officer', 'Fire Officer'].forEach((label, index) => {
      const key = ['securityGuard', 'barangayStaff', 'policeOfficer', 'fireOfficer'][index];
      const count = overallJobCategories[key] || 0;
      if(count > 0) {
        const div = document.createElement('div');
        div.className = 'job-category-item';
        div.innerHTML = `
          <span class="job-category-label">${label}</span>
          <span class="job-category-value">${count}</span>
        `;
        securityJobs.appendChild(div);
      }
    });
    
    // Media, Design & Creative
    const mediaJobs = document.getElementById('mediaJobs');
    mediaJobs.innerHTML = '';
    ['Graphic Designer', 'Video Editor', 'Content Writer', 'Social Media Manager'].forEach((label, index) => {
      const key = ['graphicDesigner', 'videoEditor', 'contentWriter', 'socialMediaManager'][index];
      const count = overallJobCategories[key] || 0;
      if(count > 0) {
        const div = document.createElement('div');
        div.className = 'job-category-item';
        div.innerHTML = `
          <span class="job-category-label">${label}</span>
          <span class="job-category-value">${count}</span>
        `;
        mediaJobs.appendChild(div);
      }
    });
    
    // Others (only show if there are data)
    const othersJobs = document.getElementById('othersJobs');
    othersJobs.innerHTML = '';
    const othersContainer = document.getElementById('othersJobsContainer');
    
    if(overallJobCategories.others > 0) {
      othersContainer.style.display = 'block';
      
      // Show top 10 unique other job titles
      const sortedOthers = Object.entries(otherJobTitles)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      
      sortedOthers.forEach(([jobTitle, count]) => {
        const div = document.createElement('div');
        div.className = 'job-category-item';
        div.innerHTML = `
          <span class="job-category-label">${jobTitle}</span>
          <span class="job-category-value">${count}</span>
        `;
        othersJobs.appendChild(div);
      });
    } else {
      othersContainer.style.display = 'none';
    }

    // Chart: heads vs members per barangay
    destroyChart();
    const labels = Object.keys(barangayMap).sort();
    const headsData = labels.map(l => barangayMap[l].heads || 0);
    const membersData = labels.map(l => barangayMap[l].members || 0);
    const ctx = document.getElementById('barangayChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'bar',
      data: { 
        labels, 
        datasets: [
          { 
            label: 'Heads', 
            data: headsData, 
            backgroundColor: '#2b9348' 
          }, 
          { 
            label: 'Members', 
            data: membersData, 
            backgroundColor: '#55a630' 
          }
        ] 
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: true,
        plugins:{ 
          legend:{ 
            position:'bottom',
            labels: {
              padding: 20,
              usePointStyle: true
            }
          } 
        }, 
        scales:{ 
          y:{ 
            beginAtZero:true,
            ticks: {
              precision: 0
            }
          } 
        } 
      }
    });

    // Populate all breakdown tables
    // 1) Summary table
    const tbodySummary = document.querySelector('#tblSummary tbody'); 
    tbodySummary.innerHTML = '';
    labels.forEach(l => {
      const s = barangayMap[l];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td><td>${s.pwds||0}</td><td>${s.male||0}</td><td>${s.female||0}</td><td>${s.coords||0}</td>`;
      tbodySummary.appendChild(tr);
    });

    // 2) Government Support
    const supportKeys = ['TUPAD','Local 4Ps','National 4Ps','Local Social Pension','National Social Pension','Solo Parent Assistance','Relief Goods','Cash Subsidy'];
    const tbodySupport = document.querySelector('#tblSupport tbody'); 
    tbodySupport.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = supportKeys.map(k => s.support && s.support[k] ? s.support[k] : 0);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodySupport.appendChild(tr);
    });

    // 3) Status breakdown
    const statusKeys = ['With Sickness','Pregnant','Solo Parent','Lactating','Severe Illness','HIV Positive','LGBTQ Plus'];
    const tbodyStatus = document.querySelector('#tblStatus tbody'); 
    tbodyStatus.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = statusKeys.map(k => s.status && s.status[k] ? s.status[k] : 0);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodyStatus.appendChild(tr);
    });

    // 4) Age buckets
    const ageKeys = ['0-5','6-17','18-59','60+','Unknown'];
    const tbodyAge = document.querySelector('#tblAge tbody'); 
    tbodyAge.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = ageKeys.map(k => s.ageBuckets && s.ageBuckets[k] ? s.ageBuckets[k] : 0);
      const tr = document.createElement('tr'); 
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodyAge.appendChild(tr);
    });

    // 5) Sitio / Purok
    const sitios = ['I','II','III','IV','V','VI','VII','Unknown'];
    const tbodySitio = document.querySelector('#tblSitio tbody'); 
    tbodySitio.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = sitios.map(pk => s.sitio && s.sitio[pk] ? s.sitio[pk] : 0);
      const tr = document.createElement('tr'); 
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodySitio.appendChild(tr);
    });

    // 6) Livestock
    const tbodyLiv = document.querySelector('#tblLivestock tbody'); 
    tbodyLiv.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const animals = ['Dog','Cat','Pig','Cow','Carabao','Chicken'];
      const cells = animals.map(a => {
        const data = s.livestock && (s.livestock[a] || s.livestock[a==='Dog' ? 'Dog' : a]);
        if(!data) return 0;
        return (data.qty && data.qty > 0) ? data.qty : (data.count || 0);
      });
      const others = (s.livestock && s.livestock['Others']) ? s.livestock['Others'].slice(0,5).join('; ') : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('') + `<td>${others}</td>`;
      tbodyLiv.appendChild(tr);
    });
    
    // 7) Barangay Educational Attainment
    const tbodyBarangayEducation = document.querySelector('#tblBarangayEducation tbody'); 
    tbodyBarangayEducation.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const cells = [
        s.education.noFormalEducation || 0,
        s.education.elementaryLevel || 0,
        s.education.elementaryGraduate || 0,
        s.education.juniorHighSchoolLevel || 0,
        s.education.juniorHighSchoolGraduate || 0,
        s.education.seniorHighSchoolLevel || 0,
        s.education.seniorHighSchoolGraduate || 0,
        s.education.collegeLevel || 0,
        s.education.collegeGraduate || 0
      ];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td>` + cells.map(c=>`<td>${c}</td>`).join('');
      tbodyBarangayEducation.appendChild(tr);
    });
    
    // 8) Barangay Employment
    const tbodyBarangayEmployment = document.querySelector('#tblBarangayEmployment tbody'); 
    tbodyBarangayEmployment.innerHTML = '';
    labels.forEach(l=>{
      const s = barangayMap[l];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${l}</td><td>${s.employment.employed || 0}</td><td>${s.employment.unemployed || 0}</td>`;
      tbodyBarangayEmployment.appendChild(tr);
    });

  } catch(err){
    console.error('Load dashboard error', err);
    alert('Error loading dashboard data');
  }
  showLoading(false);
}

/* SIDEBAR FUNCTIONS */
function toggleSidebar() {
    const pageContainer = document.querySelector('.page-container');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const icon = sidebarToggle.querySelector('i');
    
    pageContainer.classList.toggle('collapsed');
    
    if (pageContainer.classList.contains('collapsed')) {
        icon.className = 'fas fa-chevron-right';
        sidebarToggle.title = "Expand sidebar";
    } else {
        icon.className = 'fas fa-bars';
        sidebarToggle.title = "Collapse sidebar";
    }
}

function toggleMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    const icon = mobileToggle.querySelector('i');
    
    sidebar.classList.toggle('mobile-open');
    
    if (sidebar.classList.contains('mobile-open')) {
        icon.className = 'fas fa-times';
        mobileToggle.title = "Close menu";
    } else {
        icon.className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
}

/* Close mobile sidebar on click outside */
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    
    if (window.innerWidth <= 768) {
        if (!sidebar.contains(event.target) && !mobileToggle.contains(event.target) && sidebar.classList.contains('mobile-open')) {
            sidebar.classList.remove('mobile-open');
            mobileToggle.querySelector('i').className = 'fas fa-bars';
            mobileToggle.title = "Open menu";
        }
    }
});

/* WINDOW RESIZE HANDLER */
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        // On desktop, ensure sidebar is not in mobile-open state
        const sidebar = document.getElementById('sidebar');
        const mobileToggle = document.getElementById('mobileMenuToggle');
        
        sidebar.classList.remove('mobile-open');
        mobileToggle.querySelector('i').className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
});

/* session + ui */
async function sessionCheck(){
  try {
    const r = await fetch(API_URL + '?action=sessionCheck');
    const j = await r.json();
    if(!j.success) return window.location.href = 'index.html';
    
    const userName = j.fullName || localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
    document.getElementById('userName').innerText = userName;
    
    const isAdmin = j.role === 'Admin' || localStorage.getItem("userRole") === "admin";
    const adminItems = document.querySelectorAll(".admin-only");
    adminItems.forEach(item => {
        item.style.display = isAdmin ? "block" : "none";
    });
    
  } catch(e){ 
    console.warn('session check failed', e);
    const staffName = localStorage.getItem("staffName");
    if (!staffName) {
      window.location.href = 'index.html';
    } else {
      document.getElementById('userName').innerText = staffName;
      
      const isAdmin = localStorage.getItem("userRole") === "admin";
      const adminItems = document.querySelectorAll(".admin-only");
      adminItems.forEach(item => {
          item.style.display = isAdmin ? "block" : "none";
      });
    }
  }
}

/* Event Listeners */
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  localStorage.removeItem('lastDataUpdate');
  fetch(API_URL+'?action=logout'); 
  window.location.href='index.html'; 
});

// Desktop sidebar toggle
document.getElementById('sidebarToggle').onclick = toggleSidebar;

// Mobile sidebar toggle
document.getElementById('mobileMenuToggle').onclick = toggleMobileSidebar;

/* INITIALIZATION */
window.addEventListener('DOMContentLoaded', async ()=>{
  await sessionCheck();
  await loadLastUpdated();
  await loadDashboard();
  
  // Set up auto-refresh (every 5 minutes)
  setInterval(loadDashboard, 300000);
  
  // Check screen width and adjust sidebar
  if (window.innerWidth <= 768) {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.remove('mobile-open');
  }
});

/* Listen for data changes from other pages */
window.addEventListener('storage', function(e) {
  if (e.key === 'lastDataUpdate') {
    loadDashboard();
  }
});

function notifyDataUpdated() {
  updateLastUpdated();
  localStorage.setItem('lastDataUpdate', new Date().toISOString());
}
</script>
</body>
</html>
