<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan â€” Dashboard</title>
<link rel="stylesheet" href="styles.css"/>
</head>
<body>
<div class="page-container">

  <!-- HEADER -->
  <header class="topbar">
    <button id="menuToggle" class="menu-btn" aria-label="Toggle menu">â˜°</button>

    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div>
        <div class="title">PUROK KALIGTASAN</div>
        <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
      </div>
    </div>

    <div class="user-info">
      <span id="userName"></span>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <ul>
      <li><a href="dashboard.html" class="active">ğŸ“Š Dashboard</a></li>
      <li><a href="dataForm.html">ğŸ“ Data Entry</a></li>
      <li><a href="records.html">ğŸ“ Records</a></li>
      <li><a href="charts.html">ğŸ“ˆ Charts</a></li>
      <li class="admin-only"><a href="users.html">ğŸ‘¥ User Management</a></li>
    </ul>
  </aside>

  <!-- CONTENT -->
  <main class="content-area">
    <h2>ğŸ“Š Dashboard Overview</h2>

    <!-- TOP CARDS -->
    <div class="dashboard-cards">

      <div class="card">
        <h3>Total Household Heads</h3>
        <div id="totalHHHeads" class="card-value">0</div>
      </div>

      <div class="card">
        <h3>Total Household Members</h3>
        <div id="totalHHMembers" class="card-value">0</div>
      </div>

      <div class="card">
        <h3>Assigned Barangay</h3>
        <div id="assignedBarangay" class="card-value">---</div>
      </div>

      <div class="card">
        <h3>Last Updated</h3>
        <div id="lastUpdated" class="card-value">---</div>
      </div>

    </div>

    <!-- CHART: Household per Barangay -->
    <div class="card">
      <h3>Households Per Barangay (Household Heads)</h3>
      <canvas id="chartHHHeadBrgy" height="140"></canvas>
    </div>

    <!-- CHART: Members per Barangay -->
    <div class="card">
      <h3>Household Members Per Barangay</h3>
      <canvas id="chartHHMemberBrgy" height="140"></canvas>
    </div>

  </main>

</div>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="app.js"></script>

<script>
/* DASHBOARD JS */
document.addEventListener("DOMContentLoaded", async () => {
  if (!localStorage.getItem("loggedIn")) return location.href = "login.html";

  document.getElementById("userName").innerText = localStorage.getItem("staffName") || "";
  document.getElementById("assignedBarangay").innerText = localStorage.getItem("assignedBarangay") || '---';

  try {
    const data = await apiGet({ action: "list" });
    document.getElementById("lastUpdated").innerText = new Date().toLocaleString();

    // --------------------------
    // TOTAL HOUSEHOLD HEADS + MEMBERS
    // --------------------------
    const totalHeads = data.length;
    let totalMembers = 0;

    data.forEach(r => {
      const num = Number(r["No. of Household Member/s"]) || 0;
      totalMembers += num;
    });

    document.getElementById("totalHHHeads").innerText = totalHeads;
    document.getElementById("totalHHMembers").innerText = totalMembers;

    // --------------------------
    // PER BARANGAY CALCULATIONS
    // --------------------------
    const headPerBrgy = {};
    const memberPerBrgy = {};

    data.forEach(r => {
      const brgy = r.Barangay || "Unknown";
      const members = Number(r["No. of Household Member/s"]) || 0;

      // household head count
      headPerBrgy[brgy] = (headPerBrgy[brgy] || 0) + 1;

      // household member count
      memberPerBrgy[brgy] = (memberPerBrgy[brgy] || 0) + members;
    });

    const brgyLabels = Object.keys(headPerBrgy);

    // --------------------------
    // CHART 1 â€” Household heads per barangay
    // --------------------------
    new Chart(document.getElementById("chartHHHeadBrgy"), {
      type: "bar",
      data: {
        labels: brgyLabels,
        datasets: [{
          label: "Household Heads",
          data: brgyLabels.map(b => headPerBrgy[b]),
          backgroundColor: "#0f7a4a"
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    // --------------------------
    // CHART 2 â€” Household members per barangay
    // --------------------------
    new Chart(document.getElementById("chartHHMemberBrgy"), {
      type: "bar",
      data: {
        labels: brgyLabels,
        datasets: [{
          label: "Household Members",
          data: brgyLabels.map(b => memberPerBrgy[b]),
          backgroundColor: "#3498db"
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

  } catch (err) {
    console.error(err);
    alert("Error loading dashboard data");
  }
});
</script>

</body>
</html>
