<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<!-- CACHE PREVENTION HEADERS -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Purok Kaligtasan ‚Äî Data Entry of household</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
   :root{
    --bg:#f6f8f7;
    --card-bg:#fff;
    --muted:#6b6f6b;
    --accent1:#0f7a4a;
    --accent2:#34b78f;
    --accent3: #ff7a00;
    --accent4: #ffa500;
    --hazard-red: #dc2626;
    --hazard-orange: #ef4444;
    --light-green: #e9f7f2;
    --border: #e1e8e5;
    --shadow: 0 6px 18px rgba(6,30,20,0.06);
    --shadow-dark: 0 6px 20px rgba(5,40,25,0.12);
    --radius:12px;
    --radius-sm:8px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
   }
           /* Background decorative elements */
        .bg-pattern {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .bg-circle {
            position: absolute;
            border-radius: 50%;
            background: rgba(15, 122, 74, 0.05);
        }

        .circle-1 {
            width: 300px;
            height: 300px;
            top: -150px;
            right: -150px;
        }

        .circle-2 {
            width: 200px;
            height: 200px;
            bottom: -100px;
            left: -100px;
            background: rgba(255, 122, 0, 0.05);
        }

        .circle-3 {
            width: 150px;
            height: 150px;
            top: 50%;
            left: 10%;
            background: rgba(52, 183, 143, 0.05);
        }

   /* ============ ENHANCE: Better cross-platform compatibility ============ */
   body {
    background-color: var(--bg);
    margin: 0;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
   }

   .page-container{
    max-width:1200px;
    margin:20px auto;
    padding:12px;
    display:grid;
    grid-template-columns:260px 1fr;
    gap:18px;
    align-items:start;
    transition: grid-template-columns 0.3s ease;
   }

   .page-container.collapsed {
    grid-template-columns: 60px 1fr;
   }

   /* Topbar - Enhanced */
   .topbar{
    grid-column:1/-1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
    border-radius:var(--radius);
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    box-shadow:var(--shadow-dark);
   }

   .brand{
    display:flex;
    gap:12px;
    align-items:center;
   }

   .brand .logo{
    width:48px;
    height:48px;
    border-radius:var(--radius-sm);
    object-fit:contain;
    background: rgba(255,255,255,0.1);
    padding: 4px;
    border: 2px solid rgba(255,255,255,0.2);
   }

   .brand-text h1 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
   }

   .brand-text p {
    font-size:12px;
    opacity:0.95;
    margin: 4px 0 0 0;
   }

   .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
   }

   #userName {
    font-weight: 600;
    border-radius: 20px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
   }

   #logoutBtn {
    background: rgba(255,255,255,0.15);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
   }

   #logoutBtn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
   }

   /* Sidebar - Collapsible with Icon Size Change */
   .sidebar{
    background:linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.20));
    border-radius:var(--radius);
    padding:12px;
    height:calc(100vh - 120px);
    position:sticky;
    top:72px;
    overflow:auto;
    transition: width 0.3s ease;
   }

   .sidebar-container {
    display: flex;
    flex-direction: column;
    height: 100%;
   }

   .sidebar-toggle {
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    width: 32px; /* Reduced from 36px */
    height: 32px; /* Reduced from 36px */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.3s ease;
    font-size: 0.9rem; /* Added for consistency */
    -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
    touch-action: manipulation; /* Improve touch response */
   }

   .sidebar-toggle:hover {
    transform: scale(1.1);
   }

   .sidebar ul{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
    flex: 1;
   }

   .sidebar li a{
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    text-decoration: none;
    color: var(--muted);
    border-radius: var(--radius-sm);
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
   }

   .sidebar li a:hover{
    background: var(--light-green);
    color: var(--accent1);
   }

   .sidebar li a.active{
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .sidebar li a .menu-icon {
    font-size: 1.2rem;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
    transition: all 0.3s ease;
   }

   /* When sidebar is collapsed, make icons normal size (FIXED) */
   .page-container.collapsed .sidebar li a .menu-icon {
    font-size: 1.2rem !important; /* Changed from 1.6rem to normal size */
    transform: scale(1) !important; /* Changed from scale(1.2) to normal */
   }
   
   /* For active tab in collapsed state - icon remains white */
   .page-container.collapsed .sidebar li a.active .menu-icon {
    color: white;
   }
   
   /* For inactive tabs in collapsed state - return to original color (no green) */
   .page-container.collapsed .sidebar li a:not(.active) .menu-icon {
    color: var(--muted); /* Original muted color, not green */
   }

   .sidebar li a .menu-text {
    transition: opacity 0.3s ease;
   }

   .page-container.collapsed .sidebar li a .menu-text {
    opacity: 0;
    width: 0;
    overflow: hidden;
   }

   /* Content Area - Fixed Size with No Overflow */
   .content-area{
    background:linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
    border-radius:var(--radius);
    padding:18px;
    box-shadow:0 8px 22px rgba(10,20,16,0.06);
    min-height:72vh;
    height: calc(100vh - 120px);
    overflow-y: auto;
     /* Prevent content from overflowing */
    max-width: 100%;
    box-sizing: border-box;
   }

   /* Content Header - Fixed */
   .content-header {
    margin-top: 0;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
   }

   .content-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: var(--accent1);
    display: flex;
    align-items: center;
    gap: 8px;
   }

   #disc {
    margin-bottom: 10px;
    background: var(--light-green);
    padding: 12px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--accent1);
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.5;
   }

   /* Card Styling */
   .card{ 
     padding:16px;
     border-radius:var(--radius);
     background:var(--card-bg);
     margin-bottom:12px;
     box-shadow:var(--shadow);
     border: 1px solid rgba(255,255,255,0.8);
     /* Prevent card content from overflowing */
     overflow: hidden;
   }

   .form-grid{ 
     display:grid; 
     grid-template-columns:repeat(2,1fr); 
     gap:12px; 
     align-items:start;
   }

   /* Label Styling */
   label{
     display:block;
     font-weight:700;
     margin-bottom:6px;
     color:var(--accent1);
     font-size: 0.9rem;
   }

   /* Input Fields - Fixed to prevent bumping */
   input[type="text"], input[type="date"], input[type="number"], select, textarea{
     width:100%;
     padding:10px;
     border-radius:var(--radius-sm);
     border:2px solid var(--border);
     font-size:0.9rem;
     transition: all 0.3s ease;
     background:#fff;
     box-sizing: border-box; /* Include padding in width calculation */
     min-width: 0; /* Prevent flexbox overflow */
     -webkit-appearance: none;
     -moz-appearance: none;
     appearance: none;
   }

   /* Fix for iOS date input */
   input[type="date"] {
     min-height: 44px; /* Better touch target for iOS */
   }

   /* Fix for input elements to prevent bumping */
   .page-container.collapsed .content-area input[type="text"],
   .page-container.collapsed .content-area input[type="date"],
   .page-container.collapsed .content-area input[type="number"],
   .page-container.collapsed .content-area select,
   .page-container.collapsed .content-area textarea {
     width: 100%;
     max-width: 100%;
   }

   input[type="date"]::-webkit-calendar-picker-indicator{
     filter:invert(20%) sepia(50%) saturate(600%) hue-rotate(120deg) brightness(90%);
   }

   input:focus, select:focus, textarea:focus{
     outline:none;
     border-color:var(--accent1);
     box-shadow:0 0 0 3px rgba(15,122,74,0.1);
   }

   .small-muted{ 
     font-size:0.85rem; 
     color:var(--muted);
     margin-top: 4px;
   }

   /* Required field indicator */
   .required {
     color: #dc2626;
     margin-left: 2px;
   }

   /* Radio / Checkbox Alignment - FIXED */
   .radio-line, .checkbox-grid { 
     display:flex; 
     gap:16px; 
     align-items:center; 
     flex-wrap:wrap;
     padding: 8px 0;
   }

   .radio-item, .checkbox-item{ 
     display:flex; 
     align-items:center; 
     gap:8px; 
     font-weight:600; 
     color:var(--accent1);
     cursor: pointer;
     -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
   }

   .radio-item input, .checkbox-item input{
     transform:scale(1.1);
     accent-color: var(--accent1);
     cursor: pointer;
   }

   /* Member preview */
   .member-preview{ 
     margin-top:8px; 
     font-size:0.9rem;
     background: var(--light-green);
     padding: 12px;
     border-radius: var(--radius-sm);
     max-height: 200px;
     overflow-y: auto;
   }

   .member-preview li{ 
     margin-bottom:6px;
     padding: 4px 0;
     border-bottom: 1px solid rgba(15,122,74,0.1);
   }

   /* Section Styling */
   .section-title{
     display:flex;
     align-items:center;
     gap:12px; 
     margin-bottom:16px;
   }

   .section-title h3 {
    margin: 0;
    color: var(--accent1);
    flex: 1; /* Allow title to take available space */
   }

   .chip{
     padding:6px 10px;
     border-radius:20px;
     background:linear-gradient(90deg, var(--accent1), var(--accent2));
     color:#fff;
     font-size:0.9rem;
     font-weight:700;
     min-width: 32px;
     text-align: center;
     flex-shrink: 0; /* Prevent chip from shrinking */
   }

   /* Instruction label - Fixed alignment */
   .instruction-label {
     color: var(--muted);
     display: block;
     margin: 0 0 16px 44px; /* Align with chip + text */
     font-size: 0.85rem;
     line-height: 1.4;
   }

   /* ============ FIXED: Government Support Grid - Proper responsive behavior ============ */
   .gov-support-grid {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Flexible columns */
     gap: 12px 20px;
     margin-top: 12px;
   }

   /* When sidebar is collapsed, the grid should adapt properly */
   .page-container.collapsed .content-area .gov-support-grid {
     grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* Slightly smaller min-width */
   }

   .gov-support-grid .checkbox-item {
     display: flex;
     align-items: center;
     gap: 10px;
     padding: 10px 0;
     min-height: 40px; /* Consistent height for all items */
     -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
   }

   /* Ensure all checkboxes and labels are perfectly aligned */
   .gov-support-grid .checkbox-item input[type="checkbox"] {
     margin: 0;
     flex-shrink: 0;
     width: 18px;
     height: 18px;
     min-width: 18px; /* Ensure checkbox doesn't shrink */
   }

   .gov-support-grid .checkbox-item label {
     margin: 0;
     font-weight: 600;
     color: var(--accent1);
     cursor: pointer;
     flex: 1;
     display: flex;
     align-items: center;
     word-break: break-word; /* Allow long text to break */
     hyphens: auto; /* Better text wrapping */
   }

   /* Domestic Animals Grid - REDESIGNED */
   .domestic-grid-container {
     margin-top: 12px;
   }

   .domestic-grid{ 
     display:grid; 
     grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
     gap:12px;
     align-items:center;
   }

   .animal-card {
     background: var(--light-green);
     padding: 16px;
     border-radius: var(--radius-sm);
     border: 2px solid var(--border);
     transition: all 0.3s ease;
     display: flex;
     flex-direction: column;
     gap: 12px;
   }

   .animal-card:hover {
     border-color: var(--accent1);
     transform: translateY(-2px);
     box-shadow: 0 4px 12px rgba(15,122,74,0.1);
   }

   .animal-header {
     display: flex;
     align-items: center;
     gap: 12px;
     margin-bottom: 8px;
   }

   .animal-header label {
     margin: 0;
     font-size: 0.95rem; /* Reduced from 1rem */
     display: flex;
     align-items: center;
     gap: 8px;
   }

   .animal-qty {
     display: flex;
     align-items: center;
     gap: 8px;
   }

   .animal-qty label {
     margin: 0;
     font-weight: 600;
     color: var(--muted);
     font-size: 0.9rem;
   }

   .qty{
     width: 70px; /* Reduced from 80px */
     padding: 6px; /* Reduced from 8px */
     border-radius: var(--radius-sm);
     border: 2px solid var(--border);
     text-align: center;
     font-size: 0.85rem;
   }

   .others-box{
     width:100%;
     min-height:80px;
     padding:12px;
     border-radius:var(--radius-sm);
     border:2px solid var(--border);
     font-family: inherit;
     font-size: 0.9rem;
     margin-top: 8px;
     resize: vertical;
   }

   /* Buttons - Made Smaller */
   .btn { 
     border:0;
     padding: 8px 14px; /* Reduced from 10px 16px */
     border-radius:var(--radius-sm);
     cursor:pointer;
     font-weight:600;
     background: linear-gradient(90deg, var(--accent1), var(--accent2));
     color:#fff;
     font-size: 0.85rem; /* Reduced from 0.9rem */
     display: inline-flex;
     align-items: center;
     gap: 8px;
     transition: all 0.2s ease;
     white-space: nowrap;
     min-height: 36px; /* Added for consistency */
     -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
     touch-action: manipulation; /* Improve touch response */
   }

   .btn:hover {
     transform: translateY(-2px);
     box-shadow: 0 4px 12px rgba(15,122,74,0.2);
   }

   /* Secondary button - Made Smaller */
   .btn.secondary { 
     background: transparent; 
     color: var(--accent1); 
     border:2px solid var(--border);
     padding: 6px 12px; /* Added for secondary buttons */
   }

   .btn.secondary:hover {
     background: var(--light-green);
     border-color: var(--accent1);
   }

   /* Hazard Hunter Button Styling */
   .btn.hazard-hunter {
     background: linear-gradient(90deg, var(--hazard-red), var(--hazard-orange)) !important;
     color: white !important;
     border: none !important;
   }

   .btn.hazard-hunter:hover {
     background: linear-gradient(90deg, #b91c1c, var(--hazard-red)) !important;
     box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2) !important;
   }

   /* Coordinate container button */
   .coordinate-container .btn {
     padding: 8px 12px; /* Ensure consistent padding */
   }

   /* Reset Button - Same as Export Button in records.html */
   .btn-reset { 
     background: linear-gradient(90deg, var(--accent3), var(--accent4)) !important;
     color:#fff !important;
     border: none !important;
   }

   .btn-reset:hover {
     box-shadow: 0 4px 12px rgba(255,122,0,0.2) !important;
   }

   /* Back Button - Same as Export Button */
   .btn-back {
     background: linear-gradient(90deg, var(--accent3), var(--accent4)) !important;
     color:#fff !important;
     border: none !important;
   }

   .btn-back:hover {
     box-shadow: 0 4px 12px rgba(255,122,0,0.2) !important;
   }

   /* Actions Row */
   .actions-row{
     display:flex;
     gap: 10px; /* Reduced from 12px */
     justify-content:flex-end;
     margin-top: 14px; /* Reduced from 16px */
   }

   /* Coordinate container */
   .coordinate-container {
     display: flex;
     gap: 8px;
     align-items: flex-start;
     flex-wrap: wrap;
   }

   .coordinate-container .btn {
     white-space: nowrap;
   }

   /* Member Panel (Slide-in) - FIXED with Better Button Spacing */
   .member-panel { 
     position: fixed; 
     right: 0; 
     top: 0; 
     height: 100vh; 
     width: 500px; 
     max-width: 96%; 
     background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,250,0.98)); 
     box-shadow: -18px 0 40px rgba(6,30,20,0.12); 
     transform: translateX(110%); 
     transition: transform 320ms cubic-bezier(.2,.9,.3,1); 
     z-index: 6000; 
     padding: 24px; 
     overflow-y: auto; 
     border-radius: 8px 0 0 8px;
     display: flex;
     flex-direction: column;
   }

   .member-panel.open { 
     transform: translateX(0%); 
   }

   .panel-overlay { 
     position: fixed; 
     inset: 0; 
     background: rgba(0,0,0,0.32); 
     opacity: 0; 
     transition: opacity 200ms; 
     pointer-events: none; 
     z-index: 5900; 
   }

   .panel-overlay.show { 
     opacity: 1; 
     pointer-events: auto; 
   }

   .panel-header {
     display: flex;
     align-items: center;
     gap: 12px;
     margin-bottom: 20px;
     padding-bottom: 12px;
     border-bottom: 2px solid var(--light-green);
     flex-shrink: 0; /* Prevent header from shrinking */
   }

   .panel-header h3 {
     margin: 0;
     color: var(--accent1);
   }

   /* Panel Chip */
   .panel-chip {
     padding: 4px 10px; /* Reduced from 6px 12px */
     border-radius: 20px;
     background: linear-gradient(90deg, var(--accent3), var(--accent4));
     color: white;
     font-size: 0.8rem; /* Reduced from 0.85rem */
     font-weight: 700;
     flex-shrink: 0;
   }

   /* Panel Body with Scroll */
   .panel-body {
     flex: 1;
     overflow-y: auto;
     padding-right: 8px; /* Space for scrollbar */
     margin-bottom: 20px; /* Space for buttons */
   }

   /* Member Form Grid in Panel - FIXED */
   .panel-body .form-grid {
     display: grid;
     grid-template-columns: repeat(2, 1fr);
     gap: 12px;
   }

   /* Panel Checkbox Grid - FIXED ALIGNMENT (same as main form) */
   .panel-checkbox-grid {
     display: grid;
     grid-template-columns: repeat(2, 1fr);
     gap: 12px 24px; /* Same spacing as main form */
     margin: 12px 0;
     padding: 12px;
     background: var(--light-green);
     border-radius: var(--radius-sm);
     align-items: center; /* Align items vertically */
   }

   .panel-checkbox-grid label {
     display: flex;
     align-items: center;
     gap: 10px;
     font-weight: 600;
     color: var(--accent1);
     cursor: pointer;
     min-height: 40px; /* Consistent height */
     word-break: break-word; /* Allow long text to break */
     hyphens: auto; /* Better text wrapping */
   }

   .panel-checkbox-grid input[type="checkbox"] {
     accent-color: var(--accent1);
     transform: scale(1.1);
     width: 18px;
     height: 18px;
     flex-shrink: 0;
     margin: 0;
     min-width: 18px; /* Ensure checkbox doesn't shrink */
   }

   /* Panel Actions - FIXED SPACING (Always visible at bottom) */
   .panel-actions {
     display: flex;
     gap: 16px; /* Increased gap for better spacing */
     justify-content: flex-end;
     margin-top: auto; /* Push to bottom */
     padding-top: 20px;
     padding-bottom: 10px;
     border-top: 2px solid var(--light-green);
     background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
     position: sticky;
     bottom: 0;
     z-index: 10;
     flex-shrink: 0; /* Prevent buttons from shrinking */
   }

   /* Make buttons larger in panel (but still smaller than before) */
   .panel-actions .btn {
     padding: 10px 16px; /* Reduced from 12px 20px */
     font-size: 0.9rem; /* Reduced from 1rem */
     min-width: 100px; /* Reduced from 120px */
   }

   /* Panel header buttons */
   .panel-header .btn {
     padding: 6px 12px;
     font-size: 0.85rem;
   }

   /* Loading overlay */
   .loading-overlay {
     display: none;
     position: fixed;
     inset: 0;
     background: rgba(255,255,255,0.9);
     align-items: center;
     justify-content: center;
     z-index: 9999;
     backdrop-filter: blur(2px);
   }

   .loading-spinner {
     width: 40px;
     height: 40px;
     border: 3px solid var(--border);
     border-top-color: var(--accent1);
     border-radius: 50%;
     animation: spin 1s linear infinite;
   }

   @keyframes spin {
     to { transform: rotate(360deg); }
   }

   /* Error message styling */
   .error-message {
     color: #dc2626;
     font-size: 0.85rem;
     margin-top: 4px;
     display: none;
   }

   .input-error {
     border-color: #dc2626 !important;
   }

   .input-error:focus {
     box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1) !important;
   }

   /* ============ NEW EDUCATIONAL/ECONOMIC SECTION STYLING ============ */
   .conditional-field {
     margin-top: 12px;
     display: none;
     animation: fadeIn 0.3s ease;
   }

   .conditional-field.show {
     display: block;
   }

   @keyframes fadeIn {
     from { opacity: 0; transform: translateY(-5px); }
     to { opacity: 1; transform: translateY(0); }
   }

   /* Head name with checkbox container - FIXED */
   .head-name-container {
     display: flex;
     align-items: flex-start;
     gap: 0;
     flex-wrap: wrap;
     margin-bottom: 0;
   }

   .head-name-container input[type="text"] {
     flex: 1;
     min-width: 200px;
     margin-bottom: 0;
   }

   /* FIXED: Remove space between Household Head Full Name and FishR/RBIS Registered button */
   .head-registration-container {
     display: flex;
     align-items: center;
     gap: 16px;
     margin-top: 3px;
     padding: 0;
     background: transparent;
     border-radius: 0;
     border-left: none;
   }

   .head-registration-container .checkbox-item {
     margin: 0;
   }

   /* FIXED: Better alignment for conditional field in Educational & Economic Status */
   .form-grid > div {
     margin-bottom: 0;
   }

   .form-grid .conditional-field {
     grid-column: 1 / -1;
     margin-top: 8px;
     margin-bottom: 0;
   }

   /* FIXED: Ensure proper spacing in form grids */
   .form-grid > div:not(:last-child) {
     margin-bottom: 0;
   }

   /* ============ MODAL STYLING ============ */
   .modal {
     display: none;
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background: rgba(0,0,0,0.7);
     z-index: 9999;
     align-items: center;
     justify-content: center;
   }

   .modal-content {
     background: white;
     padding: 24px;
     border-radius: var(--radius);
     max-width: 500px;
     width: 90%;
     max-height: 80vh;
     overflow-y: auto;
   }

   .modal-actions {
     display: flex;
     gap: 12px;
     justify-content: flex-end;
     margin-top: 20px;
   }

   /* ============ RESPONSIVE DESIGN ============ */
   /* Tablet-specific improvements */
   @media (min-width: 769px) and (max-width: 1024px) {
     .page-container {
         max-width: 95%;
         padding: 10px;
         gap: 16px;
     }
     
     .form-grid {
         grid-template-columns: repeat(2, 1fr);
         gap: 14px;
     }
     
     .gov-support-grid {
         grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
         gap: 10px 16px;
     }
     
     .domestic-grid {
         grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
     }
     
     .member-panel {
         width: 450px;
     }
   }

   /* Mobile Responsive */
   @media (max-width: 768px) {
     .page-container {
         grid-template-columns: 1fr !important;
         padding: 8px;
         gap: 12px;
         max-width: 100%;
     }
     
     .page-container.collapsed {
         grid-template-columns: 1fr !important;
     }
     
     .sidebar {
         position: fixed;
         top: 72px;
         left: 0;
         right: 0;
         height: auto;
         max-height: 0;
         overflow: hidden;
         z-index: 1000;
         margin: 0;
         padding: 0;
         border-radius: 0 0 var(--radius) var(--radius);
         background: white;
         box-shadow: var(--shadow);
         transition: max-height 0.3s ease;
     }
     
     .sidebar.mobile-open {
         max-height: 300px;
         padding: 12px;
         overflow-y: auto;
     }
     
     .sidebar-container {
         flex-direction: column;
     }
     
     .sidebar-toggle {
         display: none;
     }
     
     .mobile-menu-toggle {
         display: flex !important;
         background: linear-gradient(135deg, var(--accent1), var(--accent2));
         color: white;
         border: none;
         border-radius: var(--radius-sm);
         width: 36px; /* Reduced from 40px */
         height: 36px; /* Reduced from 40px */
         align-items: center;
         justify-content: center;
         cursor: pointer;
         font-size: 1rem; /* Reduced from 1.2rem */
         -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
         touch-action: manipulation; /* Improve touch response */
     }
     
     .content-area {
         height: auto;
         min-height: calc(100vh - 140px);
         padding: 16px;
     }
     
     .form-grid {
         grid-template-columns: 1fr !important;
         gap: 16px;
     }
     
     .gov-support-grid {
         grid-template-columns: repeat(2, 1fr) !important;
         gap: 10px 14px !important;
     }
     
     .domestic-grid {
         grid-template-columns: 1fr !important;
     }
     
     .member-panel .form-grid {
         grid-template-columns: 1fr !important;
     }
     
     .panel-checkbox-grid {
         grid-template-columns: 1fr !important;
         gap: 12px !important;
     }
     
     .user-info {
         gap: 8px;
     }
     
     #userName {
         font-size: 0.9rem;
         padding: 6px 12px;
     }
     
     #logoutBtn {
         padding: 6px 12px;
         font-size: 0.85rem;
     }
     
     .member-panel {
         width: 100%;
         max-width: 100%;
         padding: 16px;
     }
     
     .chip {
         min-width: 28px;
         padding: 4px 8px;
     }
     
     .instruction-label {
         margin-left: 0;
         margin-top: 8px;
     }
     
     .section-title {
         flex-wrap: wrap;
     }
     
     /* Coordinate container on mobile */
     .coordinate-container {
         flex-direction: column;
         align-items: stretch;
     }
     
     .coordinate-container .btn {
         width: 100%;
         justify-content: center;
     }
     
     /* Mobile: Make panel buttons full width */
     .panel-actions {
         flex-direction: column;
         gap: 12px;
     }
     
     .panel-actions .btn {
         width: 100%;
         justify-content: center;
     }
     
     /* Make buttons even smaller on mobile */
     .btn {
         padding: 8px 12px;
         font-size: 0.82rem;
     }
     
     .panel-actions .btn {
         padding: 10px 14px;
         font-size: 0.85rem;
     }
     
     /* Adjust government support grid on mobile */
     .gov-support-grid .checkbox-item {
         min-height: 38px;
         padding: 8px 0;
     }
     
     .gov-support-grid .checkbox-item label {
         font-size: 0.82rem;
     }
     
     /* Better touch targets for mobile */
     input[type="text"], input[type="date"], input[type="number"], select, textarea {
         padding: 12px;
         font-size: 1rem; /* Slightly larger for mobile readability */
     }
     
     /* Ensure date input is tap-friendly on mobile */
     input[type="date"] {
         min-height: 48px;
     }
     
     /* Mobile adjustments for new sections */
     .head-name-container {
         flex-direction: column;
         align-items: stretch;
         gap: 12px;
     }
     
     .head-registration-container {
         flex-direction: column;
         gap: 12px;
     }
   }

   /* Small mobile devices */
   @media (max-width: 480px) {
     .gov-support-grid {
         grid-template-columns: 1fr !important;
         gap: 10px !important;
     }
     
     .brand-text h1 {
         font-size: 1rem;
     }
     
     .brand-text p {
         font-size: 0.7rem;
     }
     
     #userName {
         font-size: 0.8rem;
         padding: 4px 8px;
     }
     
     .btn {
         padding: 7px 10px;
         font-size: 0.8rem;
     }
     
     .content-header h2 {
         font-size: 1.2rem;
     }
     
     .card {
         padding: 12px;
     }
   }

   /* Mobile menu toggle button */
   .mobile-menu-toggle {
     display: none;
   }

   /* Select styling */
   select.animated {
     appearance: none;
     padding-right: 36px;
     background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%230f7a4a' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
     background-position: calc(100% - 12px) center;
     background-repeat: no-repeat;
     background-size: 12px;
   }

   /* High DPI/Retina display improvements */
   @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
     .logo {
         image-rendering: -webkit-optimize-contrast;
         image-rendering: crisp-edges;
     }
   }

   /* Print styles for better printing experience */
   @media print {
     .sidebar, .topbar, .btn, .sidebar-toggle, .mobile-menu-toggle {
         display: none !important;
     }
     
     .page-container {
         grid-template-columns: 1fr !important;
         margin: 0;
         padding: 0;
     }
     
     .content-area {
         box-shadow: none;
         background: white;
         height: auto;
         overflow: visible;
     }
     
     .card {
         box-shadow: none;
         border: 1px solid #ddd;
         break-inside: avoid;
     }
   }
</style>
</head>
<body>
       <!-- Background pattern -->
    <div class="bg-pattern">
        <div class="bg-circle circle-1"></div>
        <div class="bg-circle circle-2"></div>
        <div class="bg-circle circle-3"></div>
    </div>
<div class="page-container">

  <header class="topbar">
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div class="brand-text">
        <h1>PUROK KALIGTASAN</h1>
        <p>MDRRMO Alitagtag Household Records System</p>
      </div>
    </div>

    <div class="user-info">
      <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
      </button>
      <span id="userName"></span>
      <button id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-container">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul>
        <li><a href="dashboard.html" title="Dashboard"><span class="menu-icon">üìä</span> <span class="menu-text">Dashboard</span></a></li>
        <li><a href="dataForm.html" class="active" title="Data Entry"><span class="menu-icon">üìù</span> <span class="menu-text">Data Entry</span></a></li>
        <li><a href="records.html" title="Records"><span class="menu-icon">üìÅ</span> <span class="menu-text">Records</span></a></li>
        <li><a href="charts.html" title="Charts"><span class="menu-icon">üìà</span> <span class="menu-text">Charts</span></a></li>
        <li class="admin-only"><a href="users.html" title="User Management"><span class="menu-icon">üë•</span> <span class="menu-text">User Management</span></a></li>
      </ul>
    </div>
  </aside>

  <main class="content-area" tabindex="-1">
    <div class="content-header">
      <h2><span style="color: var(--accent1);">üìù</span> Household Information (Head)</h2>
    </div>

    <div id="disc">This section captures all key information about the household head, including personal data, contact details, demographic profile, and any government support or programs currently availed. The information will help establish the primary point of contact and provide a clear understanding of the household's overall status.</div>

    <form id="headForm" novalidate onsubmit="return false;">
      <!-- BASIC -->
      <div class="card form-section">
        <div class="section-title"><div class="chip">1</div><h3>Basic Information</h3></div>
        <div class="form-grid">
          <div>
            <label>Coordinates (optional)</label>
            <div class="coordinate-container">
              <input type="text" id="coordinate" placeholder="Latitude, Longitude" />
              <button type="button" id="getLocationBtn" class="btn secondary">
                <i class="fas fa-map-marker-alt"></i> Get My Location
              </button>
              <!-- NEW HAZARD HUNTER BUTTON -->
              <button type="button" id="hazardHunterBtn" class="btn hazard-hunter">
                <i class="fas fa-map-marked-alt"></i> Pick from Hazard Hunter
              </button>
            </div>
            <div class="small-muted">Optional ‚Äî paste `lat, lng` if available, or use the buttons above.</div>
          </div>
          
          <div>
            <label>Barangay <span class="required">*</span></label>
            <select id="barangay" required class="animated">
              <option value="">Select Barangay...</option>
              <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
              <option>Dalipit East</option><option>Dalipit West</option><option>Dominador East</option>
              <option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
              <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option>
              <option>Ping-As</option><option>Poblacion East</option><option>Poblacion West</option>
              <option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
            </select>
          </div>

          <div>
            <label>Sitio / Purok <span class="required">*</span></label>
            <select id="sitio" required class="animated">
              <option value="">Select...</option>
              <option>Purok I</option><option>Purok II</option><option>Purok III</option>
              <option>Purok IV</option><option>Purok V</option><option>Purok VI</option>
              <option>Purok VII</option>
            </select>
          </div>

          <!-- FIXED: Household Head Full Name with proper spacing -->
          <div style="grid-column: 1 / -1;">
            <label>Household Head Full Name<span class="required">*</span></label>
            <div class="head-name-container">
              <input type="text" id="householdHead" required />
            </div>
            
            <!-- FIXED: FishR/RBIS Registered button moved inline -->
            <div class="head-registration-container">
              <div class="checkbox-item" style="margin-bottom: 0;">
                <input type="checkbox" id="headRegisteredCheckbox">
                <label for="headRegisteredCheckbox">FishR/RBIS Registered</label>
              </div>
            </div>
            
            <div id="headRegistrationField" class="conditional-field">
              <label>FishR Registered/RBIS Registered</label>
              <select id="headRegistration" class="animated">
                <option value="">Select...</option>
                <option value="FishR Registered">FishR Registered</option>
                <option value="RBIS Registered">RBIS Registered</option>
                <option value="FishR & RBIS Registered">FishR & RBIS Registered</option>
              </select>
            </div>
          </div>

          <div>
            <label>Contact no. <span class="required">*</span></label>
            <input type="text" id="contactNo" placeholder="09XXXXXXXXX" required 
                   pattern="^(09|\+639)\d{9}$" 
                   title="Please enter a valid Philippine mobile number (09XXXXXXXXX or +639XXXXXXXXX)" />
            <div class="error-message" id="contactError">Please enter a valid Philippine mobile number (09XXXXXXXXX)</div>
          </div>

          <div>
            <label>Sex <span class="required">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="head_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate <span class="required">*</span></label>
            <input type="date" id="householdBirthdate" required />
          </div>

          <div>
            <label>Age</label>
            <input type="text" id="householdAge" readonly />
          </div>

          <div>
            <label>Age Category</label>
            <input type="text" id="householdStage" readonly />
          </div>

          <div>
            <label>No. of Household Member/s <span class="required">*</span></label>
            <input type="number" id="memberCount" min="0" value="0" required />
            <div class="small-muted">Set to 0 if no other members.</div>
          </div>
        </div>
      </div>

      <!-- FIXED: EDUCATIONAL & ECONOMIC STATUS -->
      <div class="card">
        <div class="section-title"><div class="chip">2</div><h3>Educational & Economic Status</h3></div>
        <div class="form-grid">
          <div>
            <label>Educational Attainment</label>
            <select id="educationalAttainment" class="animated">
              <option value="">Select...</option>
              <option value="No Formal Education">No Formal Education</option>
              <option value="Elementary Level">Elementary Level</option>
              <option value="Elementary Graduate">Elementary Graduate</option>
              <option value="High School Level">High School Level</option>
              <option value="High School Graduate">High School Graduate</option>
              <option value="Senior High School Level">Senior High School Level</option>
              <option value="Senior High School Graduate">Senior High School Graduate</option>
              <option value="College Level">College Level</option>
              <option value="College Graduate">College Graduate</option>
            </select>
          </div>

          <div id="collegeCourseField" class="conditional-field">
            <label>College Graduate Course</label>
            <input type="text" id="collegeCourse" placeholder="Enter course name" />
          </div>

          <div>
            <label>Employment</label>
            <select id="employment" class="animated">
              <option value="">Select...</option>
              <option value="Employed">Employed</option>
              <option value="Unemployed">Unemployed</option>
            </select>
          </div>

          <div id="jobTitleField" class="conditional-field">
            <label>Job Title</label>
            <select id="jobTitle" class="animated">
              <option value="">Select...</option>
              <optgroup label="Office & Administrative Jobs">
                <option>Administrative Assistant / Admin Staff</option>
                <option>Office Clerk</option>
                <option>Secretary / Executive Assistant</option>
              </optgroup>
              <optgroup label="Business & Management">
                <option>Project Manager</option>
                <option>Operations Manager</option>
                <option>HR Staff / HR Officer</option>
                <option>Account Manager</option>
              </optgroup>
              <optgroup label="Accounting & Finance">
                <option>Accounting Staff</option>
                <option>Bookkeeper</option>
                <option>Payroll Officer</option>
                <option>Auditor</option>
              </optgroup>
              <optgroup label="IT & Tech">
                <option>IT Support / IT Technician</option>
                <option>Web Developer</option>
                <option>Software Developer / Programmer</option>
                <option>Data Analyst</option>
                <option>System Administrator</option>
              </optgroup>
              <optgroup label="Healthcare">
                <option>Nurse (Staff Nurse / Company Nurse)</option>
                <option>Medical Technologist</option>
                <option>Caregiver</option>
                <option>Pharmacist</option>
              </optgroup>
              <optgroup label="Education">
                <option>Teacher / Instructor</option>
                <option>Tutor</option>
                <option>School Administrator</option>
              </optgroup>
              <optgroup label="Sales & Customer Service">
                <option>Customer Service Representative (CSR)</option>
                <option>Sales Associate</option>
                <option>Cashier</option>
                <option>Store Supervisor</option>
              </optgroup>
              <optgroup label="Skilled Work & Labor">
                <option>Electrician</option>
                <option>Plumber</option>
                <option>Welder</option>
                <option>Construction Worker / Skilled Laborer</option>
              </optgroup>
              <optgroup label="Delivery & Logistics">
                <option>Driver (Company Driver / Delivery Driver)</option>
                <option>Logistics Staff</option>
                <option>Rider / Motorcycle Delivery</option>
              </optgroup>
              <optgroup label="Food & Hospitality">
                <option>Cook / Chef</option>
                <option>Waiter / Service Crew</option>
                <option>Barista</option>
                <option>Housekeeping Staff</option>
              </optgroup>
              <optgroup label="Security & Public Service">
                <option>Security Guard</option>
                <option>Barangay Staff / Barangay Council Employee</option>
                <option>Police Officer</option>
                <option>Fire Officer</option>
              </optgroup>
              <optgroup label="Media, Design & Creative">
                <option>Graphic Designer</option>
                <option>Video Editor</option>
                <option>Content Writer</option>
                <option>Social Media Manager</option>
              </optgroup>
              <option>Others</option>
            </select>
          </div>

          <div>
            <label>Overseas Filipino Worker (OFW)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="ofw_status" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="ofw_status" value="No" checked> No</label>
            </div>
          </div>

          <div id="countryField" class="conditional-field">
            <label>Country</label>
            <select id="country" class="animated">
              <option value="">Select...</option>
              <option>Saudi Arabia</option>
              <option>United Arab Emirates (UAE)</option>
              <option>Qatar</option>
              <option>Kuwait</option>
              <option>Bahrain</option>
              <option>Oman</option>
              <option>Hong Kong</option>
              <option>Singapore</option>
              <option>Japan</option>
              <option>Taiwan</option>
              <option>Malaysia</option>
              <option>Australia</option>
              <option>New Zealand</option>
              <option>Italy</option>
              <option>United Kingdom (UK)</option>
              <option>Germany</option>
              <option>Cyprus</option>
              <option>Canada</option>
              <option>United States (USA)</option>
              <option>Libya</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <!-- HEALTH & STATUS -->
      <div class="card">
        <div class="section-title"><div class="chip">3</div><h3>Health and Status</h3></div>
        <div class="form-grid">
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_pwd" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="head_pwd" value="No"> No</label>
            </div>
          </div>

          <div>
            <label>Status</label>
            <select id="head_status" class="animated">
              <option value="">Select...</option>
              <option>With Sickness</option><option>Pregnant</option><option>Solo Parent</option><option>Lactating</option><option>Severe Illness</option><option>HIV Positive</option><option>LGBTQ Plus</option>
            </select>
          </div>
        </div>
      </div>

      <!-- DOMESTIC ANIMALS - REDESIGNED -->
      <div class="card">
        <div class="section-title"><div class="chip">4</div><h3>Domestic Livestock</h3></div>
        <div class="instruction-label">Please check (‚úì) all items that apply.</div>

        <div class="domestic-grid-container">
          <div class="domestic-grid">
            <div class="animal-card">
              <div class="animal-header">
                <label class="checkbox-item"><input type="checkbox" id="dog_chk"> <span style="font-size: 1.2rem;">üêï</span> Dog</label>
              </div>
              <div class="animal-qty">
                <label>Quantity:</label>
                <input type="number" id="dog_qty" class="qty" min="0" placeholder="0" />
              </div>
            </div>

            <div class="animal-card">
              <div class="animal-header">
                <label class="checkbox-item"><input type="checkbox" id="cat_chk"> <span style="font-size: 1.2rem;">üêà</span> Cat</label>
              </div>
              <div class="animal-qty">
                <label>Quantity:</label>
                <input type="number" id="cat_qty" class="qty" min="0" placeholder="0" />
              </div>
            </div>

            <div class="animal-card">
              <div class="animal-header">
                <label class="checkbox-item"><input type="checkbox" id="pig_chk"> <span style="font-size: 1.2rem;">üêñ</span> Pig</label>
              </div>
              <div class="animal-qty">
                <label>Quantity:</label>
                <input type="number" id="pig_qty" class="qty" min="0" placeholder="0" />
              </div>
            </div>

            <div class="animal-card">
              <div class="animal-header">
                <label class="checkbox-item"><input type="checkbox" id="cow_chk"> <span style="font-size: 1.2rem;">üêÑ</span> Cow</label>
              </div>
              <div class="animal-qty">
                <label>Quantity:</label>
                <input type="number" id="cow_qty" class="qty" min="0" placeholder="0" />
              </div>
            </div>

            <div class="animal-card">
              <div class="animal-header">
                <label class="checkbox-item"><input type="checkbox" id="carabao_chk"> <span style="font-size: 1.2rem;">üêÉ</span> Carabao</label>
              </div>
              <div class="animal-qty">
                <label>Quantity:</label>
                <input type="number" id="carabao_qty" class="qty" min="0" placeholder="0" />
              </div>
            </div>

            <div class="animal-card">
              <div class="animal-header">
                <label class="checkbox-item"><input type="checkbox" id="chicken_chk"> <span style="font-size: 1.2rem;">üêî</span> Chicken</label>
              </div>
              <div class="animal-qty">
                <label>Quantity:</label>
                <input type="number" id="chicken_qty" class="qty" min="0" placeholder="0" />
              </div>
            </div>
          </div>

          <div style="margin-top: 16px;">
            <label>Others</label>
            <textarea id="animals_others" class="others-box" placeholder="Use this field to describe other animals owned in a brief sentence (e.g., '5 goats and 2 ducks')."></textarea>
          </div>
        </div>
      </div>

      <!-- PICKUP / TRANSPORT / CAMP -->
      <div class="card">
        <div class="section-title"><div class="chip">5</div><h3>Transportation & Evacuation Details</h3></div>
        <div class="form-grid">
          <div>
            <label>Transportation</label>
            <select id="head_transport" class="animated">
              <option value="">Select...</option>
              <option>Has Transportation</option>
              <option>Needs Transportation</option>
            </select>
          </div>
          
          <div>
            <label>Pick-Up Location</label>
            <input type="text" id="pickup" />
          </div>
          
          <div>
            <label>Drop-Off Location</label>
            <input type="text" id="dropoff" />
          </div>
          
          <div>
            <label>Evacuation Camp Name</label>
            <input type="text" id="campName" />
          </div>
          
          <div>
            <label>Camp Capacity</label>
            <input type="number" id="capacity" min="0" />
          </div>
          
          <div>
            <label>Individuals Currently in Camp</label>
            <input type="number" id="insideCamp" min="0" />
          </div>
          
          <div>
            <label>Individuals Outside Camp</label>
            <input type="number" id="outsideCamp" min="0"/>
          </div>

          <div style="grid-column:1/-1">
            <label>Reason for Displacement</label>
            <select id="reasons" class="animated">
              <option value="">Select...</option>
              <option>Taal Volcano (Within 14-15 KM Danger Zone)</option>
              <option>Typhoon</option>
              <option>Flood</option>
              <option>Landslide</option>
              <option>Earthquake</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <!-- GOVERNMENT SUPPORT - FIXED ALIGNMENT -->
      <div class="card">
        <div class="section-title"><div class="chip">6</div><h3>Government Assistance Programs</h3></div>
        <div class="instruction-label">Please check (‚úì) all items that apply.</div>

        <div class="gov-support-grid">
          <div class="checkbox-item">
            <input type="checkbox" id="ass_tupad">
            <label for="ass_tupad">TUPAD</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ass_local4ps">
            <label for="ass_local4ps">Local 4Ps</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ass_intl4ps">
            <label for="ass_intl4ps">National 4Ps</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ass_locsp">
            <label for="ass_locsp">Local Social Pension</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ass_intlsp">
            <label for="ass_intlsp">National Social Pension</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ass_solo">
            <label for="ass_solo">Solo Parent Assistance</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ass_relief">
            <label for="ass_relief">Relief Goods</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ass_cash">
            <label for="ass_cash">Cash Subsidy</label>
          </div>
        </div>

        <div style="grid-column:1/-1;margin-top:16px">
          <label>AICS (if any)</label>
          <select id="ass_aics" class="animated">
            <option value="">None</option>
            <option>Shelter Assistance</option>
            <option>Burial</option>
            <option>Scholarship</option>
          </select>
        </div>
      </div>

      <!-- MEMBERS PREVIEW + ACTION -->
      <div class="card">
        <div class="section-title"><div class="chip">7</div><h3>Members to be collected</h3></div>
        <div class="small-muted">Member/s: <strong id="previewCount">0</strong></div>
        <ul id="membersPreview" class="member-preview"></ul>

        <div class="actions-row">
          <button id="resetBtn" class="btn btn-reset" type="button">
            <i class="fas fa-redo"></i> Reset Form
          </button>
          <button id="nextToMembers" class="btn" type="button">
            <i class="fas fa-save"></i> Save & Continue to Members
          </button>
        </div>
      </div>
    </form>
  </main>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
</div>

<!-- Hazard Hunter Modal -->
<div id="hazardHunterModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h3 style="color: var(--accent1); margin-top: 0;">Pick Coordinates from Hazard Hunter</h3>
    <div style="background: var(--light-green); padding: 16px; border-radius: var(--radius-sm); margin: 16px 0;">
      <h4 style="color: var(--hazard-red); margin-top: 0; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-map-marked-alt"></i> Instructions:
      </h4>
      <ol style="margin: 12px 0 0 20px; line-height: 1.6;">
        <li>Click the button below to open Hazard Hunter in a new tab</li>
        <li>Navigate to the desired location on the map</li>
        <li>Click on the map to get coordinates</li>
        <li>Copy the coordinates (latitude, longitude)</li>
        <li>Return to this tab and paste them in the coordinate field</li>
      </ol>
      <div style="margin-top: 16px; padding: 12px; background: white; border-radius: var(--radius-sm); border-left: 3px solid var(--accent1);">
        <strong>üìã Expected format:</strong> <code>14.123456, 121.123456</code>
      </div>
    </div>
    <div class="modal-actions">
      <button id="cancelHazardHunter" class="btn secondary">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button id="confirmHazardHunter" class="btn hazard-hunter">
        <i class="fas fa-external-link-alt"></i> Open Hazard Hunter
      </button>
    </div>
  </div>
</div>

<!-- Overlay + Member Panel -->
<div id="panelOverlay" class="panel-overlay" aria-hidden="true"></div>

<div id="memberPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Member entry panel">
  <div class="panel-header">
    <button id="panelClose" class="btn btn-back" title="Close panel">
      <i class="fas fa-arrow-left"></i>
    </button>
    <div class="panel-chip" id="panelChip">Member 1</div>
    <h3 id="panelTitle">Household Member Details</h3>
  </div>

  <div class="panel-body">
    <form id="memberForm" onsubmit="return false;">
      <!-- Basic Information -->
      <div class="card form-section">
        <div class="section-title"><div class="chip" style="background: linear-gradient(90deg, var(--accent3), var(--accent4));">1</div><h3>Basic Information</h3></div>
        <div class="form-grid">
          <div style="grid-column: 1 / -1;">
            <label>Household Member Full Name<span class="required">*</span></label>
            <input type="text" id="memberName" required />
          </div>

          <div>
            <div class="checkbox-item" style="margin-bottom: 8px;">
              <input type="checkbox" id="memberRegisteredCheckbox">
              <label for="memberRegisteredCheckbox">Member Registered</label>
            </div>
            
            <div id="memberRegistrationField" class="conditional-field">
              <label>Member Registered</label>
              <select id="memberRegistration" class="animated">
                <option value="">Select...</option>
                <option value="FishR Registered">FishR Registered</option>
                <option value="RBIS Registered">RBIS Registered</option>
                <option value="FishR & RBIS Registered">FishR & RBIS Registered</option>
              </select>
            </div>
          </div>

          <div>
            <label>Contact no. <span class="required">*</span></label>
            <input type="text" id="memberContact" placeholder="09XXXXXXXXX" required
                   pattern="^(09|\+639)\d{9}$"
                   title="Please enter a valid Philippine mobile number (09XXXXXXXXX or +639XXXXXXXXX)" />
            <div class="error-message" id="memberContactError">Please enter a valid Philippine mobile number (09XXXXXXXXX)</div>
          </div>

          <div>
            <label>Sex <span class="required">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="member_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="member_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate <span class="required">*</span></label>
            <input type="date" id="memberBirthdate" required />
          </div>

          <div>
            <label>Age</label>
            <input type="text" id="memberAge" readonly />
          </div>

          <div>
            <label>Age Category</label>
            <input type="text" id="memberStage" readonly />
          </div>
        </div>
      </div>

      <!-- Educational & Economic Status -->
      <div class="card">
        <div class="section-title"><div class="chip" style="background: linear-gradient(90deg, var(--accent3), var(--accent4));">2</div><h3>Educational & Economic Status</h3></div>
        <div class="form-grid">
          <div>
            <label>Educational Attainment</label>
            <select id="memberEducationalAttainment" class="animated">
              <option value="">Select...</option>
              <option value="No Formal Education">No Formal Education</option>
              <option value="Elementary Level">Elementary Level</option>
              <option value="Elementary Graduate">Elementary Graduate</option>
              <option value="High School Level">High School Level</option>
              <option value="High School Graduate">High School Graduate</option>
              <option value="Senior High School Level">Senior High School Level</option>
              <option value="Senior High School Graduate">Senior High School Graduate</option>
              <option value="College Level">College Level</option>
              <option value="College Graduate">College Graduate</option>
            </select>
          </div>

          <div id="memberCollegeCourseField" class="conditional-field">
            <label>College Graduate Course</label>
            <input type="text" id="memberCollegeCourse" placeholder="Enter course name" />
          </div>

          <div>
            <label>Employment</label>
            <select id="memberEmployment" class="animated">
              <option value="">Select...</option>
              <option value="Employed">Employed</option>
              <option value="Unemployed">Unemployed</option>
            </select>
          </div>

          <div id="memberJobTitleField" class="conditional-field">
            <label>Job Title</label>
            <select id="memberJobTitle" class="animated">
              <option value="">Select...</option>
              <optgroup label="Office & Administrative Jobs">
                <option>Administrative Assistant / Admin Staff</option>
                <option>Office Clerk</option>
                <option>Secretary / Executive Assistant</option>
              </optgroup>
              <optgroup label="Business & Management">
                <option>Project Manager</option>
                <option>Operations Manager</option>
                <option>HR Staff / HR Officer</option>
                <option>Account Manager</option>
              </optgroup>
              <optgroup label="Accounting & Finance">
                <option>Accounting Staff</option>
                <option>Bookkeeper</option>
                <option>Payroll Officer</option>
                <option>Auditor</option>
              </optgroup>
              <optgroup label="IT & Tech">
                <option>IT Support / IT Technician</option>
                <option>Web Developer</option>
                <option>Software Developer / Programmer</option>
                <option>Data Analyst</option>
                <option>System Administrator</option>
              </optgroup>
              <optgroup label="Healthcare">
                <option>Nurse (Staff Nurse / Company Nurse)</option>
                <option>Medical Technologist</option>
                <option>Caregiver</option>
                <option>Pharmacist</option>
              </optgroup>
              <optgroup label="Education">
                <option>Teacher / Instructor</option>
                <option>Tutor</option>
                <option>School Administrator</option>
              </optgroup>
              <optgroup label="Sales & Customer Service">
                <option>Customer Service Representative (CSR)</option>
                <option>Sales Associate</option>
                <option>Cashier</option>
                <option>Store Supervisor</option>
              </optgroup>
              <optgroup label="Skilled Work & Labor">
                <option>Electrician</option>
                <option>Plumber</option>
                <option>Welder</option>
                <option>Construction Worker / Skilled Laborer</option>
              </optgroup>
              <optgroup label="Delivery & Logistics">
                <option>Driver (Company Driver / Delivery Driver)</option>
                <option>Logistics Staff</option>
                <option>Rider / Motorcycle Delivery</option>
              </optgroup>
              <optgroup label="Food & Hospitality">
                <option>Cook / Chef</option>
                <option>Waiter / Service Crew</option>
                <option>Barista</option>
                <option>Housekeeping Staff</option>
              </optgroup>
              <optgroup label="Security & Public Service">
                <option>Security Guard</option>
                <option>Barangay Staff / Barangay Council Employee</option>
                <option>Police Officer</option>
                <option>Fire Officer</option>
              </optgroup>
              <optgroup label="Media, Design & Creative">
                <option>Graphic Designer</option>
                <option>Video Editor</option>
                <option>Content Writer</option>
                <option>Social Media Manager</option>
              </optgroup>
              <option>Others</option>
            </select>
          </div>

          <div>
            <label>Overseas Filipino Worker (OFW)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="member_ofw_status" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="member_ofw_status" value="No" checked> No</label>
            </div>
          </div>

          <div id="memberCountryField" class="conditional-field">
            <label>Country</label>
            <select id="memberCountry" class="animated">
              <option value="">Select...</option>
              <option>Saudi Arabia</option>
              <option>United Arab Emirates (UAE)</option>
              <option>Qatar</option>
              <option>Kuwait</option>
              <option>Bahrain</option>
              <option>Oman</option>
              <option>Hong Kong</option>
              <option>Singapore</option>
              <option>Japan</option>
              <option>Taiwan</option>
              <option>Malaysia</option>
              <option>Australia</option>
              <option>New Zealand</option>
              <option>Italy</option>
              <option>United Kingdom (UK)</option>
              <option>Germany</option>
              <option>Cyprus</option>
              <option>Canada</option>
              <option>United States (USA)</option>
              <option>Libya</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Health and Status -->
      <div class="card">
        <div class="section-title"><div class="chip" style="background: linear-gradient(90deg, var(--accent3), var(--accent4));">3</div><h3>Health and Status</h3></div>
        <div class="form-grid">
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="member_pwd" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="member_pwd" value="No" checked> No</label>
            </div>
          </div>

          <div>
            <label>Status</label>
            <select id="memberStatus" class="animated">
              <option value="">Select...</option>
              <option>With Sickness</option><option>Pregnant</option><option>Solo Parent</option><option>Lactating</option><option>Severe Illness</option><option>HIV Positive</option><option>LGBTQ Plus</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Transportation & Evacuation Details -->
      <div class="card">
        <div class="section-title"><div class="chip" style="background: linear-gradient(90deg, var(--accent3), var(--accent4));">4</div><h3>Transportation & Evacuation Details</h3></div>
        <div class="form-grid">
          <div>
            <label>Transportation</label>
            <select id="memberTransport" class="animated">
              <option value="">Select...</option>
              <option>Has Transportation</option>
              <option>Needs Transportation</option>
            </select>
          </div>
          
          <div>
            <label>Pick-Up Location</label>
            <input type="text" id="memberPickup" />
          </div>
          
          <div>
            <label>Drop-Off Location</label>
            <input type="text" id="memberDropoff" />
          </div>
          
          <div>
            <label>Evacuation Camp Name</label>
            <input type="text" id="memberCamp" />
          </div>
          
          <div>
            <label>Camp Capacity</label>
            <input type="number" id="memberCampCap" min="0" />
          </div>
          
          <div>
            <label>Individuals Currently in Camp</label>
            <input type="number" id="memberInside" min="0" />
          </div>
          
          <div>
            <label>Individuals Outside Camp</label>
            <input type="number" id="memberOutside" min="0"/>
          </div>

          <div style="grid-column:1/-1">
            <label>Reason for Displacement</label>
            <select id="memberReason" class="animated">
              <option value="">Select...</option>
              <option>Taal Volcano (Within 14-15 KM Danger Zone)</option>
              <option>Typhoon</option>
              <option>Flood</option>
              <option>Landslide</option>
              <option>Earthquake</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Government Assistance Programs -->
      <div class="card">
        <div class="section-title"><div class="chip" style="background: linear-gradient(90deg, var(--accent3), var(--accent4));">5</div><h3>Government Assistance Programs</h3></div>
        <div class="instruction-label">Please check (‚úì) all items that apply.</div>

        <div class="gov-support-grid">
          <div class="checkbox-item">
            <input type="checkbox" id="member_tupad">
            <label for="member_tupad">TUPAD</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_local4ps">
            <label for="member_local4ps">Local 4Ps</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_intl4ps">
            <label for="member_intl4ps">National 4Ps</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_locsp">
            <label for="member_locsp">Local Social Pension</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_intlsp">
            <label for="member_intlsp">National Social Pension</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_solo">
            <label for="member_solo">Solo Parent Assistance</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_relief">
            <label for="member_relief">Relief Goods</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_cash">
            <label for="member_cash">Cash Subsidy</label>
          </div>
        </div>

        <div style="grid-column:1/-1;margin-top:16px">
          <label>AICS (if any)</label>
          <select id="memberAics" class="animated">
            <option value="">None</option>
            <option>Shelter Assistance</option>
            <option>Burial</option>
            <option>Scholarship</option>
          </select>
        </div>
      </div>

      <!-- Panel Actions - Always visible at bottom -->
      <div class="panel-actions">
        <button id="memberBack" class="btn btn-reset" type="button">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button id="memberNext" class="btn" type="button">
          Save & Next <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </form>
  </div>
</div>

<script>
/* final merged client-side script (age, panel, submit). Keep API_URL updated if needed */
const API_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";

/* ============ HAZARD HUNTER INTEGRATION ============ */
const HAZARD_HUNTER_URL = "https://hazardhunter.georisk.gov.ph/map#";

/* ============ PHILIPPINE MOBILE NUMBER VALIDATION ============ */
function validatePhilippineMobileNumber(number) {
    // Remove spaces and special characters
    const cleaned = number.replace(/\s+/g, '').replace(/[^\d+]/g, '');
    
    // Pattern for Philippine mobile numbers:
    // 09XXXXXXXXX (11 digits starting with 09)
    // +639XXXXXXXXX (13 digits starting with +639)
    const pattern = /^(09|\+639)\d{9}$/;
    
    if (!pattern.test(cleaned)) {
        return false;
    }
    
    // Additional check: ensure it's exactly 11 digits for 09 format or 13 for +639 format
    if (cleaned.startsWith('09') && cleaned.length !== 11) {
        return false;
    }
    if (cleaned.startsWith('+639') && cleaned.length !== 13) {
        return false;
    }
    
    return true;
}

function formatPhilippineMobileNumber(number) {
    const cleaned = number.replace(/\s+/g, '').replace(/[^\d+]/g, '');
    
    if (cleaned.startsWith('+639')) {
        // Format: +639 XX XXX XXXX
        return cleaned.replace(/(\+639)(\d{2})(\d{3})(\d{4})/, '$1 $2 $3 $4');
    } else if (cleaned.startsWith('09')) {
        // Format: 09XX XXX XXXX
        return cleaned.replace(/(09\d{2})(\d{3})(\d{4})/, '$1 $2 $3');
    }
    
    return number;
}

/* ============ INPUT VALIDATION FUNCTIONS ============ */
function validateContactInput(input, errorElement) {
    const value = input.value.trim();
    const isValid = validatePhilippineMobileNumber(value);
    
    if (value && !isValid) {
        input.classList.add('input-error');
        errorElement.style.display = 'block';
        return false;
    } else {
        input.classList.remove('input-error');
        errorElement.style.display = 'none';
        
        // Format the number if valid
        if (isValid) {
            input.value = formatPhilippineMobileNumber(value);
        }
        return true;
    }
}

/* ---------------- helpers ---------------- */
function toSheetDateFormat(inputVal){
  if(!inputVal) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputVal)){
    const [y,m,d] = inputVal.split('-');
    return `${d}/${m}/${y}`;
  }
  const dt = new Date(inputVal);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dd}/${mm}/${dt.getFullYear()}`;
  }
  return String(inputVal);
}

function toInputDate(val){
  if(!val) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(val)){
    const [d,m,y] = val.split('/');
    return `${y}-${m}-${d}`;
  }
  const dt = new Date(val);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dt.getFullYear()}-${mm}-${dd}`;
  }
  return "";
}

/* compute age display + stage */
function computeAgeDetailed(inputDateValue){
  if(!inputDateValue) return null;
  let d;
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputDateValue)){
    const parts = inputDateValue.split('-');
    d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
  } else {
    d = new Date(inputDateValue);
  }
  if(isNaN(d)) return null;

  const now = new Date();
  const birth = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  let years = today.getFullYear() - birth.getFullYear();
  let months = today.getMonth() - birth.getMonth();
  let days = today.getDate() - birth.getDate();

  if(days < 0){
    months -= 1;
    const prev = new Date(today.getFullYear(), today.getMonth(), 0);
    days += prev.getDate();
  }
  if(months < 0){
    years -= 1;
    months += 12;
  }

  let display = "";
  if(years >= 1){
    display = String(years);
  } else {
    if(months >= 1) display = `${months} month/s`;
    else display = `${days} day/s`;
  }

  let stage = "";
  if(years === 0){
    if(months <= 10) stage = "Infant";
    else stage = "Children";
  } else if(years <= 17) stage = "School Children";
  else if(years >= 60) stage = "Elderly";
  else stage = "Adult";

  return { years, months, days, display, stage };
}

/* ============ COORDINATE HANDLING FUNCTIONS ============ */

/* Parse coordinates from Hazard Hunter format */
function parseHazardHunterCoordinates(coordinateString) {
    if (!coordinateString) return null;
    
    // Remove any extra spaces and special characters
    let cleaned = coordinateString.trim();
    
    // Common formats from Hazard Hunter:
    // 1. "14.123456, 121.123456" (lat, lng)
    // 2. "14¬∞07'24.4\"N 121¬∞07'24.4\"E" (DMS format)
    // 3. "14.123456¬∞ N, 121.123456¬∞ E" (Decimal degrees with directions)
    
    // Try to parse decimal format first (most common)
    const decimalMatch = cleaned.match(/([-+]?\d+\.\d+)\s*,\s*([-+]?\d+\.\d+)/);
    if (decimalMatch) {
        const lat = parseFloat(decimalMatch[1]);
        const lng = parseFloat(decimalMatch[2]);
        if (!isNaN(lat) && !isNaN(lng)) {
            return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }
    }
    
    // Try to parse DMS format (if Hazard Hunter provides it)
    const dmsMatch = cleaned.match(/(\d+)¬∞\s*(\d+)'\s*([\d.]+)"\s*([NS])\s*(\d+)¬∞\s*(\d+)'\s*([\d.]+)"\s*([EW])/i);
    if (dmsMatch) {
        const [_, latDeg, latMin, latSec, latDir, lngDeg, lngMin, lngSec, lngDir] = dmsMatch;
        
        let lat = parseInt(latDeg) + (parseInt(latMin) / 60) + (parseFloat(latSec) / 3600);
        let lng = parseInt(lngDeg) + (parseInt(lngMin) / 60) + (parseFloat(lngSec) / 3600);
        
        if (latDir.toUpperCase() === 'S') lat = -lat;
        if (lngDir.toUpperCase() === 'W') lng = -lng;
        
        return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }
    
    return null;
}

/* Get location from Hazard Hunter (manual selection) */
function openHazardHunterPicker() {
    // Store current form data temporarily
    const formData = {
        barangay: document.getElementById("barangay").value,
        sitio: document.getElementById("sitio").value,
        householdHead: document.getElementById("householdHead").value,
        contactNo: document.getElementById("contactNo").value,
    };
    
    // Store in sessionStorage so we can retrieve it when we come back
    sessionStorage.setItem('tempFormData', JSON.stringify(formData));
    sessionStorage.setItem('awaitingCoordinates', 'true');
    
    // Show modal with instructions
    const modal = document.getElementById('hazardHunterModal');
    modal.style.display = 'flex';
}

/* Get location using browser geolocation */
function getCurrentLocation() {
    if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
    }

    // Show loading
    const loadingOverlay = document.getElementById("loadingOverlay");
    loadingOverlay.style.display = "flex";

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude.toFixed(6);
            const lng = pos.coords.longitude.toFixed(6);
            document.getElementById("coordinate").value = `${lat}, ${lng}`;
            loadingOverlay.style.display = "none";
            
            // Ask user if they want to verify on Hazard Hunter
            if (confirm("Location captured successfully!\n\nWould you like to verify this location on Hazard Hunter to check for hazards?")) {
                openHazardHunterVerification(lat, lng);
            }
        },
        (err) => {
            loadingOverlay.style.display = "none";
            alert("Unable to retrieve GPS location. Please allow location access or use the Hazard Hunter option.");
            console.error("GPS Error:", err);
        },
        {
            enableHighAccuracy: true,
            timeout: 8000,
            maximumAge: 0
        }
    );
}

/* Open Hazard Hunter with pre-filled coordinates for verification */
function openHazardHunterVerification(lat, lng) {
    // Hazard Hunter URL format for specific coordinates
    const verificationUrl = `${HAZARD_HUNTER_URL}?lat=${lat}&lng=${lng}`;
    
    // Store that we're in verification mode
    sessionStorage.setItem('verifyingCoordinates', 'true');
    sessionStorage.setItem('originalCoordinates', `${lat}, ${lng}`);
    
    // Open in new tab
    window.open(verificationUrl, '_blank');
    
    alert("Hazard Hunter opened with your location.\n\nYou can check for hazards and update coordinates if needed.\n\nReturn to this tab and update the coordinates field if necessary.");
}

/* Setup coordinate paste handler */
function setupCoordinatePasteHandler() {
    const coordInput = document.getElementById("coordinate");
    
    if (!coordInput) return;
    
    coordInput.addEventListener('paste', (e) => {
        // Allow the paste to happen first
        setTimeout(() => {
            const pastedText = coordInput.value;
            const parsed = parseHazardHunterCoordinates(pastedText);
            
            if (parsed) {
                coordInput.value = parsed;
                // Show success message
                showToast("Coordinates parsed successfully!", "success");
            } else {
                // Show format hint
                showToast("Please ensure format is: latitude, longitude (e.g., 14.123456, 121.123456)", "warning");
            }
        }, 100);
    });
}

/* Show toast notification */
function showToast(message, type = "info") {
    // Remove existing toast
    const existingToast = document.querySelector('.toast-notification');
    if (existingToast) {
        existingToast.remove();
    }
    
    // Create new toast
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()">√ó</button>
    `;
    
    // Add styles
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
        color: white;
        padding: 12px 16px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: var(--shadow);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    // Add close button styles
    toast.querySelector('button').style.cssText = `
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0 4px;
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

/* ============ MODAL HANDLING ============ */
function setupModalHandlers() {
    const modal = document.getElementById('hazardHunterModal');
    const cancelBtn = document.getElementById('cancelHazardHunter');
    const confirmBtn = document.getElementById('confirmHazardHunter');
    
    if (!modal || !cancelBtn || !confirmBtn) return;
    
    // Cancel button
    cancelBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });
    
    // Confirm button
    confirmBtn.addEventListener('click', () => {
        modal.style.display = 'none';
        
        // Open Hazard Hunter in new tab
        window.open(HAZARD_HUNTER_URL, '_blank');
        
        // Show reminder message
        showToast("Hazard Hunter opened in new tab. Copy coordinates and return to paste them.", "info");
        
        // Set flag that we're expecting coordinates
        sessionStorage.setItem('awaitingCoordinates', 'true');
    });
    
    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
}

/* ============ SESSION MANAGEMENT ============ */

/* SIMPLE SESSION CHECK */
async function sessionCheck(){
  try {
    // Try to get user info from localStorage (set during login)
    const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
    
    // If we have a username, show it and allow access
    if (userName && userName !== "User") {
      document.getElementById('userName').innerText = userName;
      
      // Check admin status
      const isAdmin = localStorage.getItem("userRole") === "admin";
      const adminItems = document.querySelectorAll(".admin-only");
      adminItems.forEach(item => {
          item.style.display = isAdmin ? "block" : "none";
      });
      
      // Set session flag
      sessionStorage.setItem('authenticated', 'true');
      return true;
    } else {
      // No user info found in localStorage
      console.log('No user info found in localStorage');
      
      // Check if we have a session flag from before (tab restore, etc.)
      if(sessionStorage.getItem('authenticated')) {
        // We were authenticated before, keep going
        console.log('Session flag found, allowing access');
        document.getElementById('userName').innerText = "User";
        return true;
      } else {
        // No session at all, redirect to login
        console.log('No session found, redirecting to login...');
        window.location.href = 'index.html?session=expired';
        return false;
      }
    }
  } catch(e){ 
    console.warn('session check failed', e);
    return false;
  }
}

/* ENHANCED LOGOUT FUNCTION */
function handleLogout() {
  // Clear all storage
  localStorage.clear();
  sessionStorage.clear();
  
  // Add a parameter to prevent caching
  const logoutUrl = 'index.html?logout=true&t=' + Date.now();
  
  // Call server-side logout with timestamp to prevent caching
  fetch(API_URL+'?action=logout&t=' + Date.now())
    .catch(() => { /* ignore errors on logout */ })
    .finally(() => {
      // Replace current history entry with login page
      // This prevents back button from returning to dashboard
      window.location.replace(logoutUrl);
    });
}

/* ---------------- UI + state ---------------- */
function ensureLoginOrRedirect(){
  if(!localStorage.getItem("loggedIn")){ /* keep as-is or redirect to login */ return true; }
  return true;
}

let membersToCollect = 0;
let currentMemberIndex = 0;
let collectedMembers = [];

function updateMemberPreview(){
  const n = parseInt(document.getElementById("memberCount").value || 0);
  document.getElementById("previewCount").innerText = n;
  const list = document.getElementById("membersPreview");
  list.innerHTML = "";
  for(let i=0;i<n;i++){
    const mem = collectedMembers[i];
    const li = document.createElement('li');
    li.innerText = mem ? `#${i+1} ‚Äî ${mem["Name of Household Member/s"] || "(empty)"} (${mem["Contact no."]||""})` : `#${i+1} ‚Äî (empty)`;
    list.appendChild(li);
  }
}

/* fill member panel */
function fillMemberPanel(idx){
  const mem = collectedMembers[idx] || {};
  
  // Basic Information
  document.getElementById("memberName").value = mem["Name of Household Member/s"] || "";
  
  // Set checkbox based on whether registration field has value
  const hasRegistration = mem["FishR Registered/RBIS Registered"] && mem["FishR Registered/RBIS Registered"] !== "";
  document.getElementById("memberRegisteredCheckbox").checked = hasRegistration;
  
  // Show/hide registration field based on checkbox
  const memberRegistrationField = document.getElementById("memberRegistrationField");
  if (hasRegistration) {
    memberRegistrationField.classList.add('show');
    document.getElementById("memberRegistration").value = mem["FishR Registered/RBIS Registered"] || "";
  } else {
    memberRegistrationField.classList.remove('show');
    document.getElementById("memberRegistration").value = "";
  }
  
  document.getElementById("memberContact").value = mem["Contact no."] || "";
  Array.from(document.getElementsByName("member_sex")).forEach(r => r.checked = (r.value === (mem["Sex"] || "")));
  document.getElementById("memberBirthdate").value = mem["Birthdate"] ? toInputDate(mem["Birthdate"]) : "";
  document.getElementById("memberAge").value = mem["Age"] || "";
  document.getElementById("memberStage").value = mem["Stage"] || "";
  
  // Educational & Economic Status
  document.getElementById("memberEducationalAttainment").value = mem["Educational Attainment"] || "";
  document.getElementById("memberCollegeCourse").value = mem["College Graduate Course"] || "";
  document.getElementById("memberEmployment").value = mem["Employment"] || "";
  document.getElementById("memberJobTitle").value = mem["Job Title"] || "";
  Array.from(document.getElementsByName("member_ofw_status")).forEach(r => r.checked = (r.value === (mem["Overseas Filipino Worker(OFW)"] || "")));
  document.getElementById("memberCountry").value = mem["Country"] || "";
  
  // Health and Status
  Array.from(document.getElementsByName("member_pwd")).forEach(r => r.checked = (r.value === (mem["PWD"] || "")));
  document.getElementById("memberStatus").value = mem["Status"] || "";
  
  // Transportation & Evacuation Details
  document.getElementById("memberTransport").value = mem["Transportation"] || "";
  document.getElementById("memberPickup").value = mem["Designated Pick-Up Point"] || mem["Pick-Up Location"] || "";
  document.getElementById("memberDropoff").value = mem["Drop-Off Point"] || mem["Drop-Off Location"] || "";
  document.getElementById("memberCamp").value = mem["Name of Camp"] || mem["Evacuation Camp Name"] || "";
  document.getElementById("memberCampCap").value = mem["Capacity"] || "";
  document.getElementById("memberInside").value = mem["No. of Individuals Inside Camp"] || mem["Individuals Currently in Camp"] || "";
  document.getElementById("memberOutside").value = mem["No. of Individuals Outside Camp"] || mem["Individuals Outside Camp"] || "";
  document.getElementById("memberReason").value = mem["Reasons for Displacement"] || "";
  
  // Government Assistance Programs
  document.getElementById("member_tupad").checked = (mem["TUPAD"] === "Yes");
  document.getElementById("member_local4ps").checked = (mem["Local 4Ps"] === "Yes");
  document.getElementById("member_intl4ps").checked = (mem["National 4Ps"] === "Yes");
  document.getElementById("member_locsp").checked = (mem["Local Social Pension"] === "Yes");
  document.getElementById("member_intlsp").checked = (mem["National Social Pension"] === "Yes");
  document.getElementById("member_solo").checked = (mem["Solo Parent Assistance"] === "Yes");
  document.getElementById("member_relief").checked = (mem["Relief Goods"] === "Yes");
  document.getElementById("member_cash").checked = (mem["Cash Subsidy"] === "Yes");
  document.getElementById("memberAics").value = mem["AICS"] || "";
  
  // Handle conditional fields
  setupMemberConditionalFields();
  
  // Update panel chip
  document.getElementById("panelChip").textContent = `Member ${idx + 1}`;
  document.getElementById("panelTitle").textContent = `of ${membersToCollect}`;
}

/* collect member data */
function collectMemberDataFromPanel(){
  const name = document.getElementById("memberName").value.trim();
  const birth_input = document.getElementById("memberBirthdate").value || "";
  const birth_for_sheet = toSheetDateFormat(birth_input);
  const ageObj = computeAgeDetailed(birth_input);
  const ageVal = ageObj ? ageObj.display : "";
  const stageVal = ageObj ? ageObj.stage : "";

  // Get registration value only if checkbox is checked
  let registrationValue = "";
  if (document.getElementById("memberRegisteredCheckbox").checked) {
    registrationValue = document.getElementById("memberRegistration").value || "";
  }

  return {
    "Name of Household Member/s": name,
    "FishR Registered/RBIS Registered": registrationValue,
    "Contact no.": document.getElementById("memberContact").value || "",
    "Sex": document.querySelector("input[name='member_sex']:checked")?.value || "",
    "Birthdate": birth_for_sheet,
    "Age": ageVal,
    "Stage": stageVal,
    "PWD": document.querySelector("input[name='member_pwd']:checked")?.value || "No",
    "Status": document.getElementById("memberStatus").value || "",
    "Educational Attainment": document.getElementById("memberEducationalAttainment").value || "",
    "College Graduate Course": document.getElementById("memberCollegeCourse").value || "",
    "Employment": document.getElementById("memberEmployment").value || "",
    "Job Title": document.getElementById("memberJobTitle").value || "",
    "Overseas Filipino Worker(OFW)": document.querySelector("input[name='member_ofw_status']:checked")?.value || "No",
    "Country": document.getElementById("memberCountry").value || "",
    "Transportation": document.getElementById("memberTransport").value || "",
    "Designated Pick-Up Point": document.getElementById("memberPickup").value || "",
    "Pick-Up Location": document.getElementById("memberPickup").value || "", // Compatibility field
    "Drop-Off Point": document.getElementById("memberDropoff").value || "",
    "Drop-Off Location": document.getElementById("memberDropoff").value || "", // Compatibility field
    "Name of Camp": document.getElementById("memberCamp").value || "",
    "Evacuation Camp Name": document.getElementById("memberCamp").value || "", // Compatibility field
    "Capacity": document.getElementById("memberCampCap").value || "",
    "No. of Individuals Inside Camp": document.getElementById("memberInside").value || "",
    "Individuals Currently in Camp": document.getElementById("memberInside").value || "", // Compatibility field
    "No. of Individuals Outside Camp": document.getElementById("memberOutside").value || "",
    "Individuals Outside Camp": document.getElementById("memberOutside").value || "", // Compatibility field
    "Reasons for Displacement": document.getElementById("memberReason").value || "",
    "TUPAD": document.getElementById("member_tupad").checked ? "Yes" : "No",
    "Local 4Ps": document.getElementById("member_local4ps").checked ? "Yes" : "No",
    "National 4Ps": document.getElementById("member_intl4ps").checked ? "Yes" : "No",
    "Local Social Pension": document.getElementById("member_locsp").checked ? "Yes" : "No",
    "National Social Pension": document.getElementById("member_intlsp").checked ? "Yes" : "No",
    "Solo Parent Assistance": document.getElementById("member_solo").checked ? "Yes" : "No",
    "Relief Goods": document.getElementById("member_relief").checked ? "Yes" : "No",
    "Cash Subsidy": document.getElementById("member_cash").checked ? "Yes" : "No",
    "AICS": document.getElementById("memberAics").value || ""
  };
}

/* ============ CONDITIONAL FIELD HANDLERS ============ */
function setupConditionalFields() {
    // Head Registered Checkbox -> Registration Field
    const headRegisteredCheckbox = document.getElementById('headRegisteredCheckbox');
    const headRegistrationField = document.getElementById('headRegistrationField');
    const headRegistrationSelect = document.getElementById('headRegistration');
    
    if (headRegisteredCheckbox) {
        headRegisteredCheckbox.addEventListener('change', function() {
            if (this.checked) {
                headRegistrationField.classList.add('show');
                headRegistrationSelect.required = true;
            } else {
                headRegistrationField.classList.remove('show');
                headRegistrationSelect.required = false;
                headRegistrationSelect.value = '';
            }
        });
        
        // Initialize based on current value
        if (headRegisteredCheckbox.checked) {
            headRegistrationField.classList.add('show');
            headRegistrationSelect.required = true;
        }
    }
    
    // Member Registered Checkbox -> Registration Field
    const memberRegisteredCheckbox = document.getElementById('memberRegisteredCheckbox');
    const memberRegistrationField = document.getElementById('memberRegistrationField');
    const memberRegistrationSelect = document.getElementById('memberRegistration');
    
    if (memberRegisteredCheckbox) {
        memberRegisteredCheckbox.addEventListener('change', function() {
            if (this.checked) {
                memberRegistrationField.classList.add('show');
                memberRegistrationSelect.required = true;
            } else {
                memberRegistrationField.classList.remove('show');
                memberRegistrationSelect.required = false;
                memberRegistrationSelect.value = '';
            }
        });
        
        // Initialize based on current value
        if (memberRegisteredCheckbox.checked) {
            memberRegistrationField.classList.add('show');
            memberRegistrationSelect.required = true;
        }
    }
    
    // Educational Attainment -> College Course
    const educationSelect = document.getElementById('educationalAttainment');
    const collegeCourseField = document.getElementById('collegeCourseField');
    const collegeCourseInput = document.getElementById('collegeCourse');
    
    if (educationSelect) {
        educationSelect.addEventListener('change', function() {
            if (this.value === 'College Graduate') {
                collegeCourseField.classList.add('show');
                collegeCourseInput.required = true;
            } else {
                collegeCourseField.classList.remove('show');
                collegeCourseInput.required = false;
                collegeCourseInput.value = '';
            }
        });
        
        // Initialize based on current value
        if (educationSelect.value === 'College Graduate') {
            collegeCourseField.classList.add('show');
            collegeCourseInput.required = true;
        }
    }
    
    // Employment -> Job Title
    const employmentSelect = document.getElementById('employment');
    const jobTitleField = document.getElementById('jobTitleField');
    const jobTitleSelect = document.getElementById('jobTitle');
    
    if (employmentSelect) {
        employmentSelect.addEventListener('change', function() {
            if (this.value === 'Employed') {
                jobTitleField.classList.add('show');
                jobTitleSelect.required = true;
            } else {
                jobTitleField.classList.remove('show');
                jobTitleSelect.required = false;
                jobTitleSelect.value = '';
            }
        });
        
        // Initialize based on current value
        if (employmentSelect.value === 'Employed') {
            jobTitleField.classList.add('show');
            jobTitleSelect.required = true;
        }
    }
    
    // OFW Status -> Country
    const ofwRadios = document.querySelectorAll('input[name="ofw_status"]');
    const countryField = document.getElementById('countryField');
    const countrySelect = document.getElementById('country');
    
    if (ofwRadios.length > 0) {
        ofwRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'Yes') {
                    countryField.classList.add('show');
                    countrySelect.required = true;
                } else {
                    countryField.classList.remove('show');
                    countrySelect.required = false;
                    countrySelect.value = '';
                }
            });
        });
        
        // Initialize based on current value
        const checkedOfw = document.querySelector('input[name="ofw_status"]:checked');
        if (checkedOfw && checkedOfw.value === 'Yes') {
            countryField.classList.add('show');
            countrySelect.required = true;
        }
    }
}

function setupMemberConditionalFields() {
    // Member Educational Attainment -> College Course
    const memberEducationSelect = document.getElementById('memberEducationalAttainment');
    const memberCollegeCourseField = document.getElementById('memberCollegeCourseField');
    const memberCollegeCourseInput = document.getElementById('memberCollegeCourse');
    
    if (memberEducationSelect) {
        memberEducationSelect.addEventListener('change', function() {
            if (this.value === 'College Graduate') {
                memberCollegeCourseField.classList.add('show');
                memberCollegeCourseInput.required = true;
            } else {
                memberCollegeCourseField.classList.remove('show');
                memberCollegeCourseInput.required = false;
                memberCollegeCourseInput.value = '';
            }
        });
        
        // Initialize based on current value
        if (memberEducationSelect.value === 'College Graduate') {
            memberCollegeCourseField.classList.add('show');
            memberCollegeCourseInput.required = true;
        }
    }
    
    // Member Employment -> Job Title
    const memberEmploymentSelect = document.getElementById('memberEmployment');
    const memberJobTitleField = document.getElementById('memberJobTitleField');
    const memberJobTitleSelect = document.getElementById('memberJobTitle');
    
    if (memberEmploymentSelect) {
        memberEmploymentSelect.addEventListener('change', function() {
            if (this.value === 'Employed') {
                memberJobTitleField.classList.add('show');
                memberJobTitleSelect.required = true;
            } else {
                memberJobTitleField.classList.remove('show');
                memberJobTitleSelect.required = false;
                memberJobTitleSelect.value = '';
            }
        });
        
        // Initialize based on current value
        if (memberEmploymentSelect.value === 'Employed') {
            memberJobTitleField.classList.add('show');
            memberJobTitleSelect.required = true;
        }
    }
    
    // Member OFW Status -> Country
    const memberOfwRadios = document.querySelectorAll('input[name="member_ofw_status"]');
    const memberCountryField = document.getElementById('memberCountryField');
    const memberCountrySelect = document.getElementById('memberCountry');
    
    if (memberOfwRadios.length > 0) {
        memberOfwRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'Yes') {
                    memberCountryField.classList.add('show');
                    memberCountrySelect.required = true;
                } else {
                    memberCountryField.classList.remove('show');
                    memberCountrySelect.required = false;
                    memberCountrySelect.value = '';
                }
            });
        });
        
        // Initialize based on current value
        const checkedMemberOfw = document.querySelector('input[name="member_ofw_status"]:checked');
        if (checkedMemberOfw && checkedMemberOfw.value === 'Yes') {
            memberCountryField.classList.add('show');
            memberCountrySelect.required = true;
        }
    }
}

/* live age update */
document.addEventListener('input', (ev) => {
  if(ev.target && ev.target.id === "memberBirthdate"){
    const v = ev.target.value;
    const info = computeAgeDetailed(v);
    document.getElementById("memberAge").value = info ? info.display : "";
    document.getElementById("memberStage").value = info ? info.stage : "";
  }
  if(ev.target && ev.target.id === "householdBirthdate"){
    const v = ev.target.value;
    const info = computeAgeDetailed(v);
    document.getElementById("householdAge").value = info ? info.display : "";
    document.getElementById("householdStage").value = info ? info.stage : "";
  }
});

/* ---------------- DOM loaded bindings ---------------- */
document.addEventListener('DOMContentLoaded', async () => {
  // First check session
  const isAuthenticated = await sessionCheck();
  
  if (!isAuthenticated) {
    return; // Stop if not authenticated
  }

  // Original DOMContentLoaded code continues here...
  ensureLoginOrRedirect(); // You can remove this if using sessionCheck()
  document.getElementById("userName").innerText = localStorage.getItem("staffName") || "";

  // Check if user is admin - THIS IS NOW HANDLED IN sessionCheck()
  // But keep for backward compatibility
  const isAdmin = localStorage.getItem("userRole") === "admin";
  const adminItems = document.querySelectorAll(".admin-only");
  adminItems.forEach(item => {
    item.style.display = isAdmin ? "block" : "none";
  });

  // Setup conditional fields
  setupConditionalFields();

  // Setup modal handlers
  setupModalHandlers();

  // Setup coordinate paste handler
  setupCoordinatePasteHandler();

  // Contact number validation
  const contactInput = document.getElementById("contactNo");
  const contactError = document.getElementById("contactError");
  
  contactInput.addEventListener('blur', () => {
    validateContactInput(contactInput, contactError);
  });
  
  contactInput.addEventListener('input', () => {
    // Clear error while typing
    contactInput.classList.remove('input-error');
    contactError.style.display = 'none';
  });

  // Member contact number validation
  const memberContactInput = document.getElementById("memberContact");
  const memberContactError = document.getElementById("memberContactError");
  
  if (memberContactInput) {
    memberContactInput.addEventListener('blur', () => {
      validateContactInput(memberContactInput, memberContactError);
    });
    
    memberContactInput.addEventListener('input', () => {
      memberContactInput.classList.remove('input-error');
      memberContactError.style.display = 'none';
    });
  }

  // Coordinate buttons
  document.getElementById("getLocationBtn").addEventListener("click", getCurrentLocation);
  document.getElementById("hazardHunterBtn").addEventListener("click", openHazardHunterPicker);

  // reset
  document.getElementById("resetBtn").addEventListener('click', () => {
    if (confirm("Are you sure you want to reset the form? All entered data will be lost.")) {
      document.getElementById("headForm").reset();
      collectedMembers = [];
      updateMemberPreview();
      document.getElementById("householdAge").value = "";
      document.getElementById("householdStage").value = "";
      
      // Clear conditional fields
      document.getElementById('collegeCourseField').classList.remove('show');
      document.getElementById('jobTitleField').classList.remove('show');
      document.getElementById('countryField').classList.remove('show');
      document.getElementById('headRegistrationField').classList.remove('show');
      
      // Clear any error states
      contactInput.classList.remove('input-error');
      contactError.style.display = 'none';
      
      if (memberContactInput) {
        memberContactInput.classList.remove('input-error');
        memberContactError.style.display = 'none';
      }
    }
  });

  // next (head -> members)
  document.getElementById("nextToMembers").addEventListener('click', () => {
    const barangay = document.getElementById("barangay").value.trim();
    const sitio = document.getElementById("sitio").value.trim();
    const headName = document.getElementById("householdHead").value.trim();
    const headContact = document.getElementById("contactNo").value.trim();
    
    // Validate required fields
    if(!barangay || !sitio || !headName || !headContact){ 
      alert("Please fill Barangay, Sitio/Purok, Name of Household Head and Contact no."); 
      return; 
    }
    
    // Validate contact number
    if (!validateContactInput(contactInput, contactError)) {
      alert("Please enter a valid Philippine mobile number (09XXXXXXXXX or +639XXXXXXXXX)");
      contactInput.focus();
      return;
    }

    membersToCollect = parseInt(document.getElementById("memberCount").value || 0);
    collectedMembers = []; 
    currentMemberIndex = 0;
    updateMemberPreview();

    if(membersToCollect === 0){
      // no members -> submit head only
      submitHeadAndMembers();
      return;
    }

    // open member panel first
    fillMemberPanel(0);
    currentMemberIndex = 0;
    openPanel();
  });

  // panel close/back
  document.getElementById("panelClose").addEventListener('click', () => { closePanel(); });
  document.getElementById("memberBack").addEventListener('click', () => {
    if(currentMemberIndex > 0){
      collectedMembers[currentMemberIndex] = collectMemberDataFromPanel();
      currentMemberIndex--;
      fillMemberPanel(currentMemberIndex);
      updateMemberPreview();
    } else {
      closePanel();
    }
  });

  // memberNext (save & next)
  document.getElementById("memberNext").addEventListener('click', () => {
    const name = document.getElementById("memberName").value.trim();
    const contact = document.getElementById("memberContact").value.trim();
    
    if(!name || !contact){ 
      alert("Please enter member's name and contact no."); 
      return; 
    }
    
    // Validate member contact number
    if (!validateContactInput(memberContactInput, memberContactError)) {
      alert("Please enter a valid Philippine mobile number (09XXXXXXXXX or +639XXXXXXXXX)");
      memberContactInput.focus();
      return;
    }

    collectedMembers[currentMemberIndex] = collectMemberDataFromPanel();
    updateMemberPreview();

    currentMemberIndex++;
    if(currentMemberIndex >= membersToCollect){
      // done
      closePanel();
      submitHeadAndMembers();
      return;
    }
    fillMemberPanel(currentMemberIndex);
  });

  document.getElementById("householdBirthdate").addEventListener('change', () => {
    const info = computeAgeDetailed(document.getElementById("householdBirthdate").value);
    document.getElementById("householdAge").value = info ? info.display : "";
    document.getElementById("householdStage").value = info ? info.stage : "";
  });

  // Animal quantity input handling
  document.querySelectorAll('.animal-card input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const qtyInput = this.closest('.animal-card').querySelector('.qty');
      if (this.checked) {
        qtyInput.disabled = false;
        qtyInput.value = qtyInput.value || '1';
      } else {
        qtyInput.disabled = true;
        qtyInput.value = '';
      }
    });
  });

  // Initialize animal card states
  document.querySelectorAll('.animal-card').forEach(card => {
    const checkbox = card.querySelector('input[type="checkbox"]');
    const qtyInput = card.querySelector('.qty');
    if (!checkbox.checked) {
      qtyInput.disabled = true;
    }
  });

  // Add logout event listener
  document.getElementById('logoutBtn').addEventListener('click', handleLogout);

  // Check if returning from Hazard Hunter
  checkReturnFromHazardHunter();

  updateMemberPreview();
});

/* Check if user is returning from Hazard Hunter */
function checkReturnFromHazardHunter() {
    window.addEventListener('pageshow', (event) => {
        if (sessionStorage.getItem('awaitingCoordinates') === 'true') {
            // User returned from Hazard Hunter
            setTimeout(() => {
                const coordInput = document.getElementById("coordinate");
                if (coordInput && !coordInput.value.trim()) {
                    showToast("Paste your Hazard Hunter coordinates (Ctrl+V) in the coordinate field.", "info");
                }
            }, 1000);
            sessionStorage.removeItem('awaitingCoordinates');
        }
        
        // Restore form data if we have it
        const tempData = sessionStorage.getItem('tempFormData');
        if (tempData) {
            try {
                const data = JSON.parse(tempData);
                if (data.barangay) document.getElementById("barangay").value = data.barangay;
                if (data.sitio) document.getElementById("sitio").value = data.sitio;
                if (data.householdHead) document.getElementById("householdHead").value = data.householdHead;
                if (data.contactNo) document.getElementById("contactNo").value = data.contactNo;
                sessionStorage.removeItem('tempFormData');
            } catch (e) {
                console.error("Error restoring form data:", e);
            }
        }
    });
}

/* ============ PREVENT BACK BUTTON ISSUES ============ */

/* pageshow event listener */
window.addEventListener('pageshow', function(event) {
  // If page is loaded from cache (back/forward button)
  if (event.persisted) {
    console.log('Page loaded from cache, checking session...');
    
    // Check session again
    sessionCheck();
  }
});

/* panel helpers */
function openPanel(){ 
  document.getElementById("memberPanel").classList.add("open"); 
  document.getElementById("panelOverlay").classList.add("show"); 
}
function closePanel(){ 
  document.getElementById("memberPanel").classList.remove("open"); 
  document.getElementById("panelOverlay").classList.remove("show"); 
}

/* ---------------- Submit head + members ---------------- */
async function submitHeadAndMembers(){
  // Get current user - try to get full name from localStorage
  // First, try to get the full name that was saved during login
  const currentUserFullName = localStorage.getItem("userFullName") || 
                             localStorage.getItem("staffFullName") || 
                             localStorage.getItem("staffName") || 
                             localStorage.getItem("username") || 
                             "Unknown";
  
  // gather head
  const headBirthInput = document.getElementById("householdBirthdate").value || "";
  const headBirthForSheet = toSheetDateFormat(headBirthInput);
  const headAgeInfo = computeAgeDetailed(headBirthInput);
  const headAgeVal = headAgeInfo ? headAgeInfo.display : "";

  // Get head registration value only if checkbox is checked
  let headRegistrationValue = "";
  if (document.getElementById("headRegisteredCheckbox").checked) {
    headRegistrationValue = document.getElementById("headRegistration").value || "";
  }

  const head = {
    "Coordinate": document.getElementById("coordinate").value || "",
    "Coordinates": document.getElementById("coordinate").value || "", // Added for compatibility
    "Barangay": document.getElementById("barangay").value || "",
    "Sitio / Purok": document.getElementById("sitio").value || "",
    "Name of Household Head": document.getElementById("householdHead").value || "",
    "FishR Registered/RBIS Registered": headRegistrationValue,
    "Contact no.": document.getElementById("contactNo").value || "",
    "Sex": document.querySelector("input[name='head_sex']:checked")?.value || "",
    "Birthdate": headBirthForSheet,
    "Age": headAgeVal,
    "No. of Household Member/s": document.getElementById("memberCount").value || "0",
    "Name of Household Member/s": "", // head row has this empty
    "PWD": document.querySelector("input[name='head_pwd']:checked")?.value || "No",
    "Stage": headAgeInfo ? headAgeInfo.stage : "",
    "Status": document.getElementById("head_status").value || "",
    "Educational Attainment": document.getElementById("educationalAttainment").value || "",
    "College Graduate Course": document.getElementById("collegeCourse").value || "",
    "Employment": document.getElementById("employment").value || "",
    "Job Title": document.getElementById("jobTitle").value || "",
    "Overseas Filipino Worker(OFW)": document.querySelector("input[name='ofw_status']:checked")?.value || "No",
    "Country": document.getElementById("country").value || "",
    "Transportation": document.getElementById("head_transport").value || "",
    "Designated Pick-Up Point": document.getElementById("pickup").value || "",
    "Pick-Up Location": document.getElementById("pickup").value || "", // Added for compatibility
    "Drop-Off Point": document.getElementById("dropoff").value || "",
    "Drop-Off Location": document.getElementById("dropoff").value || "", // Added for compatibility
    "Name of Camp": document.getElementById("campName").value || "",
    "Evacuation Camp Name": document.getElementById("campName").value || "", // Added for compatibility
    "Capacity": document.getElementById("capacity").value || "",
    "No. of Individuals Inside Camp": document.getElementById("insideCamp").value || "",
    "Individuals Currently in Camp": document.getElementById("insideCamp").value || "", // Added for compatibility
    "No. of Individuals Outside Camp": document.getElementById("outsideCamp").value || "",
    "Individuals Outside Camp": document.getElementById("outsideCamp").value || "", // Added for compatibility
    "Reasons for Displacement": document.getElementById("reasons").value || "",
    "TUPAD": document.getElementById("ass_tupad").checked ? "Yes" : "No",
    "Local 4Ps": document.getElementById("ass_local4ps").checked ? "Yes" : "No",
    "National 4Ps": document.getElementById("ass_intl4ps").checked ? "Yes" : "No",
    "Local Social Pension": document.getElementById("ass_locsp").checked ? "Yes" : "No",
    "National Social Pension": document.getElementById("ass_intlsp").checked ? "Yes" : "No",
    "Solo Parent Assistance": document.getElementById("ass_solo").checked ? "Yes" : "No",
    "Relief Goods": document.getElementById("ass_relief").checked ? "Yes" : "No",
    "Cash Subsidy": document.getElementById("ass_cash").checked ? "Yes" : "No",
    "AICS": document.getElementById("ass_aics").value || "",
    /* Domestic animals ‚Äî store as separate fields matching your header */
    "Dog": document.getElementById("dog_chk").checked ? "Yes" : "No",
    "Dog Qty.": document.getElementById("dog_qty").value || "",
    "Cat": document.getElementById("cat_chk").checked ? "Yes" : "No",
    "Cat Qty.": document.getElementById("cat_qty").value || "",
    "Pig": document.getElementById("pig_chk").checked ? "Yes" : "No",
    "Pig Qty.": document.getElementById("pig_qty").value || "",
    "Cow": document.getElementById("cow_chk").checked ? "Yes" : "No",
    "Cow Qty.": document.getElementById("cow_qty").value || "",
    "Carabao": document.getElementById("carabao_chk").checked ? "Yes" : "No",
    "Carabao Qty.": document.getElementById("carabao_qty").value || "",
    "Chicken": document.getElementById("chicken_chk").checked ? "Yes" : "No",
    "Chicken Qty.": document.getElementById("chicken_qty").value || "",
    "Others": document.getElementById("animals_others").value || "",
    "Submitted By": currentUserFullName, // Use the full name instead of username
    "Submitted On": new Date().toLocaleString()
  };

  // ensure members length matches selected
  const expected = parseInt(document.getElementById("memberCount").value || 0);
  const members = collectedMembers.slice(0);
  for(let i=0;i<expected;i++){
    if(!members[i]){
      members[i] = {
        "Name of Household Member/s": "",
        "FishR Registered/RBIS Registered": "",
        "Contact no.": "",
        "Sex": "",
        "Birthdate": "",
        "Age": "",
        "Stage": "",
        "PWD": "No",
        "Status": "",
        "Educational Attainment": "",
        "College Graduate Course": "",
        "Employment": "",
        "Job Title": "",
        "Overseas Filipino Worker(OFW)": "No",
        "Country": "",
        "Transportation": "",
        "Designated Pick-Up Point": "",
        "Pick-Up Location": "", // Added for compatibility
        "Drop-Off Point": "",
        "Drop-Off Location": "", // Added for compatibility
        "Name of Camp": "",
        "Evacuation Camp Name": "", // Added for compatibility
        "Capacity": "",
        "No. of Individuals Inside Camp": "",
        "Individuals Currently in Camp": "", // Added for compatibility
        "No. of Individuals Outside Camp": "",
        "Individuals Outside Camp": "", // Added for compatibility
        "Reasons for Displacement": "",
        "TUPAD": "No",
        "Local 4Ps": "No",
        "National 4Ps": "No",
        "Local Social Pension": "No",
        "National Social Pension": "No",
        "Solo Parent Assistance": "No",
        "Relief Goods": "No",
        "Cash Subsidy": "No",
        "AICS": ""
      };
    }
    // ensure birthdate format DD/MM/YYYY
    if(members[i]["Birthdate"]){
      members[i]["Birthdate"] = (members[i]["Birthdate"].indexOf('/') === -1) ? toSheetDateFormat(members[i]["Birthdate"]) : members[i]["Birthdate"];
    }
  }

  // Build request
// Get current user
const currentUser = localStorage.getItem("username") || 
                   localStorage.getItem("staffName") || 
                   "System";

// Build request
  const form = new FormData();
  form.append("action", "createRecord");
  form.append("actor", currentUserFullName);  // Use full name for actor
  form.append("head", JSON.stringify(head));
  form.append("members", JSON.stringify(members));
  form.append("submittedBy", currentUserFullName);  // Use full name for submittedBy

  // UI disable
  const submitBtn = document.getElementById("nextToMembers");
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

  try{
    console.log("Submitting HEAD:", head);
    console.log("Submitting MEMBERS:", members);
    const res = await fetch(API_URL, { method: "POST", body: form });
    const text = await res.text();
    console.log("RAW RESPONSE:", text);

    let data;
    try { data = JSON.parse(text); } catch (e) {
      // server returned non-JSON (error). Show raw.
      throw new Error("Invalid response from server: " + text);
    }

    if(data.success){
      alert("Record saved successfully! (Data ID: " + (data.dataID || "n/a") + ")");
      window.location.href = "records.html";
    } else {
      alert("Save failed: " + (data.message || "Unknown error"));
      console.error("SAVE ERROR:", data);
    }
  }catch(err){
    console.error("SUBMIT ERROR:", err);
    alert("Network / Server error: " + (err.message || err));
  }finally{
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-save"></i> Save & Continue to Members';
  }
}

/* ============ SIDEBAR COLLAPSE ============ */
function toggleSidebar() {
    const pageContainer = document.querySelector('.page-container');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const icon = sidebarToggle.querySelector('i');
    
    pageContainer.classList.toggle('collapsed');
    
    if (pageContainer.classList.contains('collapsed')) {
        icon.className = 'fas fa-chevron-right';
        sidebarToggle.title = "Expand sidebar";
    } else {
        icon.className = 'fas fa-bars';
        sidebarToggle.title = "Collapse sidebar";
    }
}

/* ============ MOBILE SIDEBAR TOGGLE ============ */
function toggleMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    const icon = mobileToggle.querySelector('i');
    
    sidebar.classList.toggle('mobile-open');
    
    if (sidebar.classList.contains('mobile-open')) {
        icon.className = 'fas fa-times';
        mobileToggle.title = "Close menu";
    } else {
        icon.className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
}

/* ============ CLOSE MOBILE SIDEBAR ON CLICK OUTSIDE ============ */
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    
    if (window.innerWidth <= 768) {
        if (!sidebar.contains(event.target) && !mobileToggle.contains(event.target) && sidebar.classList.contains('mobile-open')) {
            sidebar.classList.remove('mobile-open');
            mobileToggle.querySelector('i').className = 'fas fa-bars';
            mobileToggle.title = "Open menu";
        }
    }
});

/* ============ UI BINDINGS ============ */
// Desktop sidebar toggle
document.getElementById('sidebarToggle').onclick = toggleSidebar;

// Mobile sidebar toggle
document.getElementById('mobileMenuToggle').onclick = toggleMobileSidebar;

/* ============ WINDOW RESIZE HANDLER ============ */
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        // On desktop, ensure sidebar is not in mobile-open state
        const sidebar = document.getElementById('sidebar');
        const mobileToggle = document.getElementById('mobileMenuToggle');
        
        sidebar.classList.remove('mobile-open');
        mobileToggle.querySelector('i').className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
});

/* ============ INPUT WIDTH FIX ============ */
// Fix input widths when sidebar collapses/expands
const sidebarToggle = document.getElementById('sidebarToggle');
if (sidebarToggle) {
    sidebarToggle.addEventListener('click', function() {
        // Force reflow to fix input widths
        setTimeout(() => {
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.style.width = '100%';
            });
        }, 300); // Match the transition duration
    });
}

/* ============ VISIBILITY CHANGE HANDLER ============ */
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    // Tab became active, check session
    sessionCheck();
  }
});
</script>
<!-- Activity Tracking -->
<script src="activity-tracking.js"></script>
</body>
</html>
