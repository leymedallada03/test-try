<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Data Entry ‚Äî MDRRMO Alitagtag</title>
<link rel="stylesheet" href="styles.css"/>
<style>
/* Slide-in member panel (Option C) */
.member-panel {
  position: fixed;
  right: 0;
  top: 0;
  height: 100vh;
  width: 420px;
  max-width: 96%;
  background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,250,0.98));
  box-shadow: -18px 0 40px rgba(6,30,20,0.12);
  transform: translateX(110%);
  transition: transform 280ms cubic-bezier(.2,.9,.3,1);
  z-index: 6000;
  padding: 18px;
  overflow-y: auto;
}
.member-panel.open { transform: translateX(0%); }
.member-panel .panel-header { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
.member-panel h3 { margin:0; font-size:18px; color:var(--green-1); }
.member-panel .panel-body { margin-top:8px; }
.member-panel .panel-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

.radio-line { display:flex; gap:18px; align-items:center; padding:6px 0; }
.radio-item { display:flex; align-items:center; gap:6px; font-weight:700; font-size:14px; }

.assist-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:8px 12px; margin-top:8px; }
.assist-item { display:flex; align-items:center; gap:8px; font-size:14px; font-weight:700; }

.panel-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.32);
  opacity: 0;
  transition: opacity 200ms;
  pointer-events: none;
  z-index: 5900;
}
.panel-overlay.show { opacity: 1; pointer-events: auto; }

@media(max-width:720px){
  .member-panel { width: 100%; max-width: 100%; }
}

.member-preview { margin-top:8px; font-size:14px; }
.member-preview li { margin-bottom:6px; }

.input-inline { display:flex; gap:8px; align-items:center; }
.small-muted { font-size:13px; color:var(--muted); }

/* small tweak for buttons inside panel to match existing classes */
.btn { border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;background: linear-gradient(90deg,#0f7a4a,#34b78f); color:#fff; }
.btn.secondary { background: transparent; color: #0f7a4a; border:1px solid rgba(6,30,20,0.06); }
.card { padding:14px;border-radius:10px;background:#fff;margin-bottom:12px;box-shadow:0 6px 18px rgba(6,30,20,0.04); }
.form-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
.form-grid > div { min-width:0; }
.small { font-size:13px; }

.assist-card {
  background: #ffffff;
  border: 1px solid #cfd8dc;
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.assist-card h4 {
  margin: 0 0 10px 0;
  font-size: 15px;
  color: #0b4d28;
  font-weight: 700;
}

.assist-card-grid {
  display: grid;
  grid-template-columns: repeat(2,1fr);
  gap: 7px 12px;
  font-size: 14px;
}

.assist-card-grid label {
  display: flex;
  align-items: center;
  gap: 6px;
}
</style>
</head>

<body>
<div class="page-container">
  <header class="topbar">
    <button id="menuToggle" class="menu-btn" aria-label="Toggle menu" aria-expanded="true">‚ò∞</button>
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="logo"/>
      <div>
        <div class="title">PUROK KALIGTASAN</div>
        <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
      </div>
    </div>
    <div class="user-info">
      <span id="userName"></span>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <ul>
      <li><a href="dashboard.html">üìä Dashboard</a></li>
      <li><a href="dataForm.html" class="active">üìù Data Entry</a></li>
      <li><a href="records.html">üìÅ Records</a></li>
      <li><a href="charts.html">üìà Charts</a></li>
      <li class="admin-only"><a href="users.html">üë• User Management</a></li>
    </ul>
  </aside>

  <main class="content-area" tabindex="-1">
    <h2>üìù Household Evacuation Information (Head first)</h2>

    <form id="headForm" novalidate onsubmit="return false;">
      <div class="form-section card">
        <h3>Basic Information (Household Head)</h3>
        <div class="form-grid">
          <div>
            <label>Barangay <span class="small">*</span></label>
            <select id="barangay" required>
              <option value="">Select Barangay...</option>
              <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
              <option>Dalipit East</option><option>Dalipit West</option><option>Dominador East</option>
              <option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
              <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option>
              <option>Ping-As</option><option>Poblacion East</option><option>Poblacion West</option>
              <option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
            </select>
          </div>

          <div>
            <label>Sitio / Purok <span class="small">*</span></label>
            <select id="sitio" required>
              <option value="">Select...</option>
              <option>Purok I</option><option>Purok II</option><option>Purok III</option>
              <option>Purok IV</option><option>Purok V</option><option>Purok VI</option>
              <option>Purok VII</option>
            </select>
          </div>

          <div>
            <label>Name of Household Head <span class="small">*</span></label>
            <input type="text" id="householdHead" required />
          </div>

          <div>
            <label>Sex <span class="small">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="head_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate <span class="small">*</span></label>
            <input type="date" id="householdBirthdate" />
          </div>

          <div>
            <label>Age</label>
            <input type="number" id="householdAge" readonly />
          </div>

          <div>
            <label>Stage</label>
            <input type="text" id="householdStage" readonly />
          </div>

          <div>
            <label>No. of Household Member/s <span class="small">*</span></label>
            <input type="number" id="memberCount" min="0" value="0" />
            <div class="small-muted">Set to 0 if no other members.</div>
          </div>
        </div>

        <hr style="margin:12px 0">

        <h4>Health and Status</h4>
        <div class="form-grid">
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_pwd" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="head_pwd" value="No"> No</label>
            </div>
          </div>

          <div>
            <label>Status</label>
            <select id="head_status">
              <option value="">Select...</option>
              <option>With Sickness</option><option>Pregnant</option><option>Others</option>
            </select>
          </div>

          <div>
            <label>Transportation</label>
            <select id="head_transport">
              <option value="">Select...</option>
              <option>Individual with Transportation</option>
              <option>Individual needing Transportation</option>
            </select>
          </div>
        </div>

        <hr style="margin:12px 0">

        <h4>Pickup  / Transport / Camp Details</h4>
        <div class="form-grid">
          <div>
            <label>Designated Pick-Up Point</label>
            <input type="text" id="pickup" />
          </div>
          <div>
            <label>Drop-Off Point</label>
            <input type="text" id="dropoff" />
          </div>
          <div>
            <label>Name of Camp</label>
            <input type="text" id="campName" />
          </div>
          <div>
            <label>Capacity</label>
            <input type="number" id="capacity" min="0" />
          </div>
          <div>
            <label>No. of Individuals Inside Camp</label>
            <input type="number" id="insideCamp" min="0" value="0" />
          </div>
          <div>
            <label>No. of Individuals Outside Camp</label>
            <input type="number" id="outsideCamp" min="0" value="0" />
          </div>
        </div>

        <div class="form-grid">
          <div style="grid-column:1/-1">
            <label>Reasons for Displacement</label>
            <select id="reasons">
              <option value="">Select...</option>
              <option>With-in 14-15 KM Danger Zone</option>
              <option>Others</option>
            </select>
          </div>
        </div>

        <hr style="margin:12px 0">
        <h4>Assistance Received (optional)</h4>
        <div class="assist-grid">
          <label class="assist-item"><input type="checkbox" id="ass_tupad"> TUPAD</label>
          <label class="assist-item"><input type="checkbox" id="ass_intlsp"> National Social Pension</label>
          <label class="assist-item"><input type="checkbox" id="ass_local4ps"> Local 4Ps</label>
          <label class="assist-item"><input type="checkbox" id="ass_cash"> Cash Subsidy</label>
          <label class="assist-item"><input type="checkbox" id="ass_intl4ps"> National 4Ps</label>
          <label class="assist-item"><input type="checkbox" id="ass_solo"> Solo Parent Assistance</label>
          <label class="assist-item"><input type="checkbox" id="ass_locsp"> Local Social Pension</label>
          <label class="assist-item"><input type="checkbox" id="ass_relief"> Relief Goods</label>
        </div>

        <div style="margin-top:8px">
          <label>AICS (if any)</label>
          <select id="ass_aics">
            <option value="">None</option>
            <option>Shelter Assistance</option>
            <option>Burial</option>
            <option>Scholarship</option>
          </select>
        </div>

        <div style="height:10px"></div>

        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="resetBtn" class="btn secondary" type="button">Reset</button>
          <button id="nextToMembers" class="btn" type="button">Save ‚Üí Next Members</button>
        </div>
      </div>

      <!-- preview of members to be added -->
      <div class="card">
        <h4>Members to be collected</h4>
        <div class="small-muted">Number of members chosen: <strong id="previewCount">0</strong></div>
        <ul id="membersPreview" class="member-preview"></ul>
      </div>

    </form>
  </main>
</div>

<!-- slide-in member panel -->
<div id="panelOverlay" class="panel-overlay" aria-hidden="true"></div>

<div id="memberPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Member entry panel">
  <div class="panel-header">
    <button id="panelClose" class="btn secondary" title="Close panel">‚Üê</button>
    <h3 id="panelTitle">Member 1 of N</h3>
  </div>

  <div class="panel-body">
    <form id="memberForm" onsubmit="return false;">
      <div class="form-grid">
        <div>
          <label>Member Name <span class="small">*</span></label>
          <input type="text" id="memberName" required />
        </div>

        <div>
          <label>Sex</label>
          <div class="radio-line">
            <label class="radio-item"><input type="radio" name="member_sex" value="Male"> Male</label>
            <label class="radio-item"><input type="radio" name="member_sex" value="Female"> Female</label>
          </div>
        </div>

        <div>
          <label>Birthdate</label>
          <input type="date" id="memberBirthdate" />
        </div>

        <div>
          <label>Age</label>
          <input type="number" id="memberAge" readonly />
        </div>

        <div>
          <label>PWD</label>
          <div class="radio-line">
            <label class="radio-item"><input type="radio" name="member_pwd" value="Yes"> Yes</label>
            <label class="radio-item"><input type="radio" name="member_pwd" value="No" checked> No</label>
          </div>
        </div>

        <div>
          <label>Stage</label>
          <input type="text" id="memberStage" readonly />
        </div>

        <div>
          <label>Status</label>
          <select id="memberStatus">
            <option value="">Select...</option><option>With Sickness</option><option>Pregnant</option>
          </select>
        </div>

        <div>
          <label>Transportation</label>
          <select id="memberTransport">
            <option value="">Select...</option>
            <option>Individual with Transportation</option>
            <option>Individual needing Transportation</option>
          </select>
        </div>

        <div>
          <label>Pick-Up Point</label>
          <input type="text" id="memberPickup"/>
        </div>

        <div>
          <label>Drop-Off Point</label>
          <input type="text" id="memberDropoff"/>
        </div>

        <div>
          <label>Camp Name</label>
          <input type="text" id="memberCamp"/>
        </div>

        <div>
          <label>Capacity</label>
          <input type="number" id="memberCampCap" min="0"/>
        </div>

        <div>
          <label>Inside Camp</label>
          <input type="number" id="memberInside" min="0"/>
        </div>

        <div>
          <label>Outside Camp</label>
          <input type="number" id="memberOutside" min="0"/>
        </div>

        <div>
          <label>Reason</label>
          <select id="memberReason"><option value="">Select...</option><option>With-in 14-15 KM Danger Zone</option><option>Others</option></select>
        </div>

<div style="grid-column:1/-1">

  <!-- Government Support Section -->
  <div class="assist-card">
    <h4>Government Support</h4>

    <div class="assist-card-grid">
      <label><input type="checkbox" id="member_tupad"> TUPAD</label>
      <label><input type="checkbox" id="member_local4ps"> Local 4Ps</label>
      <label><input type="checkbox" id="member_intl4ps"> National 4Ps</label>
      <label><input type="checkbox" id="member_locsp"> Local Social Pension</label>
      <label><input type="checkbox" id="member_intlsp"> National Social Pension</label>
      <label><input type="checkbox" id="member_solo"> Solo Parent Assistance</label>
    </div>

    <div class="sub-section-title">Financial & Goods</div>
  </div>

  <!-- Relief Goods Section -->
  <div class="assist-card">
    <h4>Relief Goods</h4>

    <div class="assist-card-grid">
      <label><input type="checkbox" id="member_cash"> Cash Subsidy</label>
      <label><input type="checkbox" id="member_relief"> Relief Goods</label>
    </div>
  </div>

</div>
</div>

      </div>

      <div class="panel-actions">
        <button id="memberBack" class="btn secondary" type="button">Back</button>
        <button id="memberNext" class="btn" type="button">Save & Next</button>
      </div>
    </form>
  </div>
</div>

<script>


const API_URL = "https://script.google.com/macros/s/AKfycbxWs1kxkyleYw6qcQlIx1xsecQS8x2O-nyXxbcdcm5DVst6IcmDKR-NmzSgBxyH7ErvpA/exec";

/* -------- LOGIN CHECK -------- */
function ensureLoginOrRedirect() {
    if (!localStorage.getItem("loggedIn")) {
        window.location.href = "index.html";
        return false;
    }
    return true;
}

/* -------- AGE / STAGE HELPERS -------- */
function computeAge(dateStr) {
    if (!dateStr) return null;
    const d = new Date(dateStr);
    if (isNaN(d)) return null;

    const now = new Date();
    let age = now.getFullYear() - d.getFullYear();

    if (
        now.getMonth() < d.getMonth() ||
        (now.getMonth() === d.getMonth() && now.getDate() < d.getDate())
    ) {
        age--;
    }

    return age;
}

function getStageFromAge(age) {
    if (age === null || age === undefined) return "";
    if (age <= 1) return "Infant";
    if (age <= 12) return "Children";
    if (age <= 17) return "School Children";
    if (age >= 60) return "Elderly";
    return "Adult";
}

/* -------- PANEL VARIABLES -------- */
let membersToCollect = 0;
let currentMemberIndex = 0;
let collectedMembers = [];

/* -------- OPEN/CLOSE PANEL -------- */
function openPanel() {
    document.getElementById("memberPanel").classList.add("open");
    document.getElementById("panelOverlay").classList.add("show");
}
function closePanel() {
    document.getElementById("memberPanel").classList.remove("open");
    document.getElementById("panelOverlay").classList.remove("show");
}

/* -------- PREVIEW UPDATE -------- */
function updateMemberPreview() {
    const n = parseInt(document.getElementById("memberCount").value || 0);
    document.getElementById("previewCount").innerText = n;
    const list = document.getElementById("membersPreview");
    list.innerHTML = "";

    for (let i = 0; i < n; i++) {
        let li = document.createElement("li");
        const mem = collectedMembers[i];
        li.innerText = mem ? `Member #${i+1} ‚Äî ${mem["Name"]}` : `Member #${i+1}`;
        list.appendChild(li);
    }
}
function collectMemberData() {
    const name = document.getElementById("memberName").value.trim();
    const sex = document.querySelector("input[name='member_sex']:checked")?.value || "";
    const birthdate = document.getElementById("memberBirthdate").value;
    const age = computeAge(birthdate);
    const stage = getStageFromAge(age);
    const pwd = document.getElementById("memberPWD").checked ? "Yes" : "No";

    return {
        "Name of Household Member/s": name,
        "Sex": sex,
        "Birthdate": birthdate,
        "Age": age,
        "Stage": stage,
        "Persons with Disability (PWD)": pwd,
        // These columns match your master sheet
        "Status": "",
        "Transportation": "",
        "Drop-Off Point": "",
        "Designated Pick-Up Point": "",
        "Reasons for Displacement": ""
    };
}
/* -------- MEMBER FORM: COLLECT DATA -------- */
async function submitHeadAndMembers() {

    // Prepare FormData to avoid CORS problems
    const form = new FormData();

    form.append("action", "createRecord");

    // HEAD
    form.append("Barangay", document.getElementById("barangay").value);
    form.append("Sitio / Purok", document.getElementById("sitio").value);
    form.append("Name of Household Head", document.getElementById("householdHead").value);
    form.append("Sex", document.querySelector("input[name='head_sex']:checked")?.value || "");
    form.append("Birthdate", document.getElementById("householdBirthdate").value);
    form.append("Age", document.getElementById("householdAge").value);
    form.append("Stage", document.getElementById("householdStage").value);
    form.append("No. of Household Member/s", document.getElementById("memberCount").value);
    form.append("Reasons for Displacement", document.getElementById("reasons").value || "");
    form.append("Transportation", document.getElementById("head_transport").value || "");
    form.append("Drop-Off Point", document.getElementById("dropoff").value || "");
    form.append("Designated Pick-Up Point", document.getElementById("pickup").value || "");
    form.append("Status", document.getElementById("head_status").value || "");
    form.append("Name of Camp", document.getElementById("campName").value || "");
    form.append("Capacity", document.getElementById("capacity").value || "");
    form.append("No. of Individuals Inside Camp", document.getElementById("insideCamp").value || "");
    form.append("No. of Individuals Outside Camp", document.getElementById("outsideCamp").value || "");

    // Assistance
    form.append("TUPAD", document.getElementById("ass_tupad").checked ? "Yes" : "No");
    form.append("Local 4Ps", document.getElementById("ass_local4ps").checked ? "Yes" : "No");
    form.append("National 4Ps", document.getElementById("ass_intl4ps").checked ? "Yes" : "No");
    form.append("Local Social Pension", document.getElementById("ass_locsp").checked ? "Yes" : "No");
    form.append("National Social Pension", document.getElementById("ass_intlsp").checked ? "Yes" : "No");
    form.append("Solo Parent Assistance", document.getElementById("ass_solo").checked ? "Yes" : "No");
    form.append("Relief Goods", document.getElementById("ass_relief").checked ? "Yes" : "No");
    form.append("AICS", document.getElementById("ass_aics").value || "");

    // MEMBERS ‚Äî send as JSON text (Apps Script reads it with JSON.parse)
    form.append("members", JSON.stringify(collectedMembers || []));

    // Staff who submitted
    form.append("submittedBy", localStorage.getItem("staffName") || "Unknown");

    try {
        const res = await fetch("https://script.google.com/macros/s/AKfycbxWs1kxkyleYw6qcQlIx1xsecQS8x2O-nyXxbcdcm5DVst6IcmDKR-NmzSgBxyH7ErvpA/exec", {
            method: "POST",
            body: form
        });

        const text = await res.text();
        console.log("RAW RESPONSE:", text);

        let data;
        try { data = JSON.parse(text); }
        catch (err) {
            alert("Invalid response from server");
            console.error(err);
            return;
        }

        if (data.success) {
            alert("Record saved successfully!");
            window.location.href = "records.html";
        } else {
            alert("Save failed: " + data.message);
            console.error("ERROR:", data);
        }

    } catch (err) {
        alert("Network error ‚Äî check internet or deployment URL");
        console.error(err);
    }
}


  
/* -------- MEMBER NEXT BUTTON -------- */
function onMemberNext() {
    const name = document.getElementById("memberName").value.trim();
    if (!name) {
        alert("Please enter member's name.");
        return;
    }

    collectedMembers[currentMemberIndex] = collectMemberData();
    updateMemberPreview();

    currentMemberIndex++;

    if (currentMemberIndex >= membersToCollect) {
        closePanel();
        submitHeadAndMembers();
        return;
    }

    loadMemberForm(currentMemberIndex);
}

/* -------- LOAD MEMBER FORM -------- */
function loadMemberForm(i) {
    document.getElementById("panelTitle").innerText = `Member ${i+1} of ${membersToCollect}`;
    document.getElementById("memberForm").reset();

    document.getElementById("memberName").focus();
}

/* ------------------- INIT ------------------- */
document.addEventListener("DOMContentLoaded", function () {

    if (!ensureLoginOrRedirect()) return;

    document.getElementById("userName").innerText =
        localStorage.getItem("staffName");

    // Handle head birthdate ‚Üí age
    document.getElementById("householdBirthdate").addEventListener("change", () => {
        const age = computeAge(document.getElementById("householdBirthdate").value);
        document.getElementById("householdAge").value = age;
        document.getElementById("householdStage").value = getStageFromAge(age);
    });

    document.getElementById("memberCount").addEventListener("input", updateMemberPreview);

    document.getElementById("nextToMembers").addEventListener("click", () => {
        const barangay = document.getElementById("barangay").value;
        const sitio = document.getElementById("sitio").value;
        const head = document.getElementById("householdHead").value;

        if (!barangay || !sitio || !head) {
            alert("Please fill out required fields.");
            return;
        }

        membersToCollect = parseInt(document.getElementById("memberCount").value);
        collectedMembers = [];
        currentMemberIndex = 0;

        if (membersToCollect === 0) {
            submitHeadAndMembers();
        } else {
            openPanel();
            loadMemberForm(0);
        }
    });

    document.getElementById("memberNext").addEventListener("click", onMemberNext);

});
</script>
</body>
</html>











