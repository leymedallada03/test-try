<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Data Entry ‚Äî MDRRMO Alitagtag</title>
<link rel="stylesheet" href="styles.css"/>

<style>
/* ---------------- GLOBAL LAYOUT FIX ---------------- */
.page-container {
  display: flex;
  min-height: 100vh;
  background: #f6f9f6;
}

/* ---------------- TOPBAR ---------------- */
.topbar {
  position: fixed;
  top:0; left:0; right:0;
  height: 62px;
  background: linear-gradient(90deg,#0f7a4a,#34b78f);
  color:white;
  display:flex;
  align-items:center;
  padding:0 16px;
  z-index:5000;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
}

.topbar .brand {
  display: flex;
  align-items: center;
  gap: 10px;
}

.topbar .logo {
  width: 44px; height: 44px;
}

.topbar .title { font-size:18px; font-weight:700; margin-bottom:2px; }
.topbar .subtitle { font-size:13px; opacity:0.9; }

.menu-btn {
  font-size:22px;
  border:0;background:none;
  cursor:pointer;color:white;
  margin-right:14px;
}

/* ---------------- SIDEBAR ---------------- */
.sidebar {
  width:220px;
  background:white;
  padding-top:70px;
  border-right:1px solid rgba(0,0,0,0.08);
  position:fixed;
  left:0; top:0; bottom:0;
}

.sidebar ul { list-style:none; padding:0; margin:0; }
.sidebar li a {
  display:block;
  padding:12px 18px;
  color:#0b4630;
  text-decoration:none;
  font-weight:600;
}
.sidebar li a:hover,
.sidebar li a.active {
  background:#e7faf1;
  color:#0f7a4a;
}

/* ---------------- MAIN CONTENT ---------------- */
.content-area {
  flex:1;
  margin-left:220px;
  padding:86px 22px 40px;
}

.card {
  background:white;
  padding:16px;
  margin-bottom:14px;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.06);
}

h3 { margin-top:0; }

/* ---------------- GRID ---------------- */
.form-grid {
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
}

.radio-line {
  display:flex;
  gap:14px;
}

/* ---------------- BUTTONS ---------------- */
.btn {
  border:0;
  padding:10px 16px;
  border-radius:10px;
  cursor:pointer;
  font-weight:700;
  background: linear-gradient(90deg,#0f7a4a,#34b78f);
  color:#fff;
}

.btn.secondary {
  background:#fff;
  color:#0f7a4a;
  border:1px solid #0f7a4a33;
}

/* ---------------- ASSISTANCE STYLE ‚Äî OPTION A ---------------- */
.assistance-grid {
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap:10px 18px;
  margin-top:10px;
}

.assistance-grid label {
  display:flex;
  align-items:center;
  gap:6px;
  font-size:15px;
  font-weight:600;
  color:#0b4630;
}

/* Fix the AICS select spacing */
.ass-aics-container {
  margin-top: 12px;
}

.small-muted {
  font-size:13px;
  color:#666;
}
</style>
</head>

<body>
<div class="page-container">

<!-- -------------------- TOPBAR -------------------- -->
<header class="topbar">
  <button id="menuToggle" class="menu-btn">‚ò∞</button>
  <div class="brand">
    <img src="assets/MDRRMO Logo.png" class="logo" alt="logo"/>
    <div>
      <div class="title">PUROK KALIGTASAN</div>
      <div class="subtitle">DRRMO - Alitagtag</div>
    </div>
  </div>

  <div class="user-info" style="margin-left:auto; display:flex;align-items:center;gap:10px;">
    <span id="userName"></span>
    <button id="logoutBtn" class="btn secondary">Logout</button>
  </div>
</header>

<!-- -------------------- SIDEBAR -------------------- -->
<aside class="sidebar" id="sidebar">
  <ul>
    <li><a href="dashboard.html">üìä Dashboard</a></li>
    <li><a href="dataForm.html" class="active">üìù Data Entry</a></li>
    <li><a href="records.html">üìÅ Records</a></li>
    <li><a href="charts.html">üìà Charts</a></li>
    <li class="admin-only"><a href="users.html">üë• User Management</a></li>
  </ul>
</aside>

<!-- -------------------- MAIN CONTENT -------------------- -->
<main class="content-area">
  <h2>üìù Household Evacuation Information (Head First)</h2>

<form id="headForm" onsubmit="return false;">

<div class="card">
  <h3>Basic Information (Household Head)</h3>

  <div class="form-grid">
    <div>
      <label>Barangay <span class="small-muted">*</span></label>
      <select id="barangay" required>
        <option value="">Select Barangay...</option>
        <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
        <option>Dalipit East</option><option>Dalipit West</option>
        <option>Dominador East</option><option>Dominador West</option>
        <option>Munlawin Sur</option><option>Munlawin Norte</option>
        <option>Muzon Primero</option><option>Muzon Segundo</option>
        <option>Pinagkurusan</option><option>Ping-As</option>
        <option>Poblacion East</option><option>Poblacion West</option>
        <option>San Jose</option><option>San Juan</option>
        <option>Santa Cruz</option><option>Tadlac</option>
      </select>
    </div>

    <div>
      <label>Sitio / Purok <span class="small-muted">*</span></label>
      <select id="sitio" required>
        <option value="">Select...</option>
        <option>Purok I</option><option>Purok II</option><option>Purok III</option>
        <option>Purok IV</option><option>Purok V</option><option>Purok VI</option>
        <option>Purok VII</option>
      </select>
    </div>

    <div>
      <label>Name of Household Head <span class="small-muted">*</span></label>
      <input type="text" id="householdHead" required>
    </div>

    <div>
      <label>Sex <span class="small-muted">*</span></label>
      <div class="radio-line">
        <label><input type="radio" name="head_sex" value="Male"> Male</label>
        <label><input type="radio" name="head_sex" value="Female"> Female</label>
      </div>
    </div>

    <div>
      <label>Birthdate</label>
      <input type="date" id="householdBirthdate">
    </div>

    <div>
      <label>Age</label>
      <input type="text" id="householdAge" readonly>
    </div>

    <div>
      <label>Stage</label>
      <input type="text" id="householdStage" readonly>
    </div>

    <div>
      <label>No. of Household Members</label>
      <input type="number" id="memberCount" min="0" value="0">
    </div>
  </div>

  <hr>

  <h3>Health and Status</h3>
  <div class="form-grid">
    <div>
      <label>PWD</label>
      <div class="radio-line">
        <label><input type="radio" name="head_pwd" value="Yes"> Yes</label>
        <label><input type="radio" name="head_pwd" value="No"> No</label>
      </div>
    </div>

    <div>
      <label>Status</label>
      <select id="head_status">
        <option value="">Select...</option>
        <option>With Sickness</option>
        <option>Pregnant</option>
        <option>Others</option>
      </select>
    </div>

    <div>
      <label>Transportation</label>
      <select id="head_transport">
        <option value="">Select...</option>
        <option>Individual with Transportation</option>
        <option>Individual needing Transportation</option>
      </select>
    </div>
  </div>

  <hr>

  <h3>Pickup / Transport / Camp</h3>
  <div class="form-grid">
    <div>
      <label>Pick-Up Point</label>
      <input type="text" id="pickup">
    </div>

    <div>
      <label>Drop-Off Point</label>
      <input type="text" id="dropoff">
    </div>

    <div>
      <label>Name of Camp</label>
      <input type="text" id="campName">
    </div>

    <div>
      <label>Capacity</label>
      <input type="number" id="capacity" min="0">
    </div>

    <div>
      <label>Individuals Inside Camp</label>
      <input type="number" id="insideCamp" min="0">
    </div>

    <div>
      <label>Individuals Outside Camp</label>
      <input type="number" id="outsideCamp" min="0">
    </div>
  </div>

  <hr>

  <h3>Reasons for Displacement</h3>
  <select id="reasons">
    <option value="">Select...</option>
    <option>With-in 14-15 KM Danger Zone</option>
    <option>Others</option>
  </select>

  <hr>

  <!-- ---------------- ASSISTANCE ‚Äî OPTION A (Aligned) ---------------- -->
  <h3>Assistance Received (optional)</h3>

  <div class="assistance-grid">
    <label><input type="checkbox" id="ass_tupad"> TUPAD</label>
    <label><input type="checkbox" id="ass_local4ps"> Local 4Ps</label>
    <label><input type="checkbox" id="ass_intl4ps"> National 4Ps</label>
    <label><input type="checkbox" id="ass_locsp"> Local Social Pension</label>
    <label><input type="checkbox" id="ass_intlsp"> National Social Pension</label>
    <label><input type="checkbox" id="ass_solo"> Solo Parent Assistance</label>
    <label><input type="checkbox" id="ass_relief"> Relief Goods</label>
    <label><input type="checkbox" id="ass_cash"> Cash Subsidy</label>
  </div>

  <div class="ass-aics-container">
    <label>AICS</label>
    <select id="ass_aics">
      <option value="">None</option>
      <option>Shelter Assistance</option>
      <option>Burial</option>
      <option>Scholarship</option>
    </select>
  </div>

<!-- Members preview card -->
  <div class="card" style="margin-top:12px">
    <h3>Members to be collected</h3>
    <div class="small-muted">Number of members chosen: <strong id="previewCount">0</strong></div>
    <ul id="membersPreview" class="member-preview"></ul>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="resetBtn" class="btn secondary" type="button">Reset</button>
      <button id="nextToMembers" class="btn" type="button">Save ‚Üí Next Members</button>
    </div>
  </div>

</form>
</main>

</div> <!-- end page-container -->

<!-- panel overlay + member panel -->
<div id="panelOverlay" class="panel-overlay" aria-hidden="true"></div>

<div id="memberPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Member entry panel" style="max-width:420px;">
  <div class="panel-header" style="padding:12px 18px;">
    <button id="panelClose" class="btn secondary" title="Close panel">‚Üê</button>
    <h3 id="panelTitle" style="margin:0 0 0 8px">Member 1 of N</h3>
  </div>

  <div class="panel-body" style="padding:12px 18px 22px;">
    <form id="memberForm" onsubmit="return false;">
      <div class="form-grid">
        <div>
          <label>Member Name <span class="small-muted">*</span></label>
          <input type="text" id="memberName" required>
        </div>

        <div>
          <label>Sex</label>
          <div class="radio-line">
            <label><input type="radio" name="member_sex" value="Male"> Male</label>
            <label><input type="radio" name="member_sex" value="Female"> Female</label>
          </div>
        </div>

        <div>
          <label>Birthdate</label>
          <input type="date" id="memberBirthdate">
        </div>

        <div>
          <label>Age</label>
          <input type="text" id="memberAge" readonly>
        </div>

        <div>
          <label>PWD</label>
          <div class="radio-line">
            <label><input type="radio" name="member_pwd" value="Yes"> Yes</label>
            <label><input type="radio" name="member_pwd" value="No" checked> No</label>
          </div>
        </div>

        <div>
          <label>Stage</label>
          <input type="text" id="memberStage" readonly>
        </div>

        <div>
          <label>Status</label>
          <select id="memberStatus">
            <option value="">Select...</option><option>With Sickness</option><option>Pregnant</option>
          </select>
        </div>

        <div>
          <label>Transportation</label>
          <select id="memberTransport">
            <option value="">Select...</option>
            <option>Individual with Transportation</option>
            <option>Individual needing Transportation</option>
          </select>
        </div>

        <div>
          <label>Pick-Up Point</label>
          <input type="text" id="memberPickup">
        </div>

        <div>
          <label>Drop-Off Point</label>
          <input type="text" id="memberDropoff">
        </div>

        <div>
          <label>Name of Camp</label>
          <input type="text" id="memberCamp">
        </div>

        <div>
          <label>Capacity</label>
          <input type="number" id="memberCampCap" min="0">
        </div>

        <div>
          <label>Inside Camp</label>
          <input type="number" id="memberInside" min="0">
        </div>

        <div>
          <label>Outside Camp</label>
          <input type="number" id="memberOutside" min="0">
        </div>

        <div style="grid-column:1/-1;margin-top:6px;">
          <label>Reason</label>
          <select id="memberReason">
            <option value="">Select...</option>
            <option>With-in 14-15 KM Danger Zone</option><option>Others</option>
          </select>
        </div>

        <!-- Assistance grid for member (Option B aligned) -->
        <div style="grid-column:1/-1; margin-top:8px;">
          <h4 style="margin:6px 0 8px 0">Government Support</h4>
          <div class="assistance-grid" style="grid-template-columns: repeat(2,1fr);">
            <label><input type="checkbox" id="member_tupad"> TUPAD</label>
            <label><input type="checkbox" id="member_local4ps"> Local 4Ps</label>
            <label><input type="checkbox" id="member_intl4ps"> National 4Ps</label>
            <label><input type="checkbox" id="member_locsp"> Local Social Pension</label>
            <label><input type="checkbox" id="member_intlsp"> National Social Pension</label>
            <label><input type="checkbox" id="member_solo"> Solo Parent Assistance</label>
            <label><input type="checkbox" id="member_relief"> Relief Goods</label>
            <label><input type="checkbox" id="member_cash"> Cash Subsidy</label>
          </div>

          <div style="margin-top:8px;">
            <label>AICS (if any)</label>
            <select id="memberAics">
              <option value="">None</option>
              <option>Shelter Assistance</option>
              <option>Burial</option>
              <option>Scholarship</option>
            </select>
          </div>
        </div>

      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="memberBack" class="btn secondary" type="button">Back</button>
        <button id="memberNext" class="btn" type="button">Save & Next</button>
      </div>
    </form>
  </div>
</div>

<!-- ========================= SCRIPT (improved) ========================= -->
<script>
/* ----------------- CONFIG ----------------- */
const API_URL = "https://script.google.com/macros/s/AKfycbxWs1kxkyleYw6qcQlIx1xsecQS8x2O-nyXxbcdcm5DVst6IcmDKR-NmzSgBxyH7ErvpA/exec";

/* ----------------- UTIL: convert yyyy-mm-dd -> DD/MM/YYYY ----------------- */
function toSheetDateFormat(dateYMD){
  if(!dateYMD) return "";
  // input usually yyyy-mm-dd from <input type=date>
  if(/^\d{4}-\d{2}-\d{2}$/.test(dateYMD)){
    const parts = dateYMD.split("-");
    return parts[2] + "/" + parts[1] + "/" + parts[0];
  }
  // try Date parse fallback
  const dt = new Date(dateYMD);
  if(!isNaN(dt)){
    const d = ("0"+dt.getDate()).slice(-2);
    const m = ("0"+(dt.getMonth()+1)).slice(-2);
    const y = dt.getFullYear();
    return d + "/" + m + "/" + y;
  }
  return "";
}

/* ----------------- UTIL: age object (years + months) ----------------- */
function computeAgeObject(dateYMD){
  if(!dateYMD) return null;
  const d = new Date(dateYMD);
  if(isNaN(d)) return null;
  const now = new Date();
  let years = now.getFullYear() - d.getFullYear();
  let months = now.getMonth() - d.getMonth();
  let days = now.getDate() - d.getDate();
  if(days < 0){ months--; }
  if(months < 0){ years--; months += 12; }
  if(years < 0) { years = 0; }
  return { years: years, months: months };
}

/* ----------------- UTIL: human age text ----------------- */
function ageTextFromObj(ageObj){
  if(!ageObj) return "";
  if(ageObj.years === 0){
    // months representation, show "11 months" etc. If months is 0 show "0 months"
    return (ageObj.months || 0) + " months";
  }
  return String(ageObj.years);
}

/* ----------------- STAGE derivation ----------------- */
function deriveStageFromAgeObj(ageObj){
  if(!ageObj) return "";
  if(ageObj.years === 0){
    // infants: months <=10 -> Infant else Children
    if((ageObj.months || 0) <= 10) return "Infant";
    return "Children";
  }
  if(ageObj.years <= 17) return "School Children";
  if(ageObj.years >= 60) return "Elderly";
  return "Adult";
}

/* ----------------- UI state ----------------- */
let membersToCollect = 0;
let currentMemberIndex = 0;
let collectedMembers = [];

/* ----------------- UI helpers ----------------- */
function openPanel(){ document.getElementById("memberPanel").classList.add("open"); document.getElementById("panelOverlay").classList.add("show"); }
function closePanel(){ document.getElementById("memberPanel").classList.remove("open"); document.getElementById("panelOverlay").classList.remove("show"); }

function updateMemberPreview(){
  const n = parseInt(document.getElementById("memberCount").value || 0);
  document.getElementById("previewCount").innerText = n;
  const list = document.getElementById("membersPreview");
  list.innerHTML = "";
  for(let i=0;i<n;i++){
    const mem = collectedMembers[i];
    const li = document.createElement("li");
    li.innerText = mem ? `#${i+1} ‚Äî ${mem["Name of Household Member/s"] || "(empty)"}` : `#${i+1} ‚Äî (empty)`;
    list.appendChild(li);
  }
}

/* ----------------- fill panel ----------------- */
function fillMemberPanel(idx){
  const mem = collectedMembers[idx] || {};
  document.getElementById("memberName").value = mem["Name of Household Member/s"] || "";
  Array.from(document.getElementsByName("member_sex")).forEach(r=> r.checked = (r.value === (mem["Sex"]||"")));
  // memberBirthdate input expects yyyy-mm-dd; try to convert if mem has DD/MM/YYYY
  if(mem["Birthdate"] && /^\d{2}\/\d{2}\/\d{4}$/.test(mem["Birthdate"])){
    const parts = mem["Birthdate"].split("/");
    document.getElementById("memberBirthdate").value = parts[2]+"-"+parts[1]+"-"+parts[0];
  } else {
    document.getElementById("memberBirthdate").value = mem["Birthdate"] || "";
  }
  document.getElementById("memberAge").value = mem["Age"] || "";
  document.getElementById("memberStage").value = mem["Stage"] || "";
  document.getElementById("memberStatus").value = mem["Status"] || "";
  document.getElementById("memberTransport").value = mem["Transportation"] || "";
  document.getElementById("memberPickup").value = mem["Designated Pick-Up Point"] || "";
  document.getElementById("memberDropoff").value = mem["Drop-Off Point"] || "";
  document.getElementById("memberCamp").value = mem["Name of Camp"] || "";
  document.getElementById("memberCampCap").value = mem["Capacity"] || "";
  document.getElementById("memberInside").value = mem["No. of Individuals Inside Camp"] || "";
  document.getElementById("memberOutside").value = mem["No. of Individuals Outside Camp"] || "";
  document.getElementById("memberReason").value = mem["Reasons for Displacement"] || "";
  document.getElementById("member_tupad").checked = (mem["TUPAD"] === "Yes");
  document.getElementById("member_local4ps").checked = (mem["Local 4Ps"] === "Yes");
  document.getElementById("member_intl4ps").checked = (mem["National 4Ps"] === "Yes");
  document.getElementById("member_locsp").checked = (mem["Local Social Pension"] === "Yes");
  document.getElementById("member_intlsp").checked = (mem["National Social Pension"] === "Yes");
  document.getElementById("member_solo").checked = (mem["Solo Parent Assistance"] === "Yes");
  document.getElementById("member_relief").checked = (mem["Relief Goods"] === "Yes");
  document.getElementById("member_cash").checked = (mem["Cash Subsidy"] === "Yes");
  document.getElementById("memberAics").value = mem["AICS"] || "";
}

/* ----------------- collect member data from panel ----------------- */
function collectMemberDataFromPanel(){
  const name = document.getElementById("memberName").value.trim();
  const sex = document.querySelector("input[name='member_sex']:checked")?.value || "";
  const birthYMD = document.getElementById("memberBirthdate").value || "";
  const ageObj = computeAgeObject(birthYMD);
  const ageText = ageTextFromObj(ageObj);
  const stage = deriveStageFromAgeObj(ageObj);

  return {
    "Name of Household Member/s": name,
    "Sex": sex,
    "Birthdate": toSheetDateFormat(birthYMD), // convert to DD/MM/YYYY text
    "Age": ageText,
    "Stage": stage,
    "Persons with Disability (PWD)": (document.querySelector("input[name='member_pwd']:checked")?.value || "No"),
    "Status": document.getElementById("memberStatus").value || "",
    "Transportation": document.getElementById("memberTransport").value || "",
    "Designated Pick-Up Point": document.getElementById("memberPickup").value || "",
    "Drop-Off Point": document.getElementById("memberDropoff").value || "",
    "Name of Camp": document.getElementById("memberCamp").value || "",
    "Capacity": document.getElementById("memberCampCap").value || "",
    "No. of Individuals Inside Camp": document.getElementById("memberInside").value || "",
    "No. of Individuals Outside Camp": document.getElementById("memberOutside").value || "",
    "Reasons for Displacement": document.getElementById("memberReason").value || "",
    "TUPAD": document.getElementById("member_tupad").checked ? "Yes" : "No",
    "Local 4Ps": document.getElementById("member_local4ps").checked ? "Yes" : "No",
    "National 4Ps": document.getElementById("member_intl4ps").checked ? "Yes" : "No",
    "Local Social Pension": document.getElementById("member_locsp").checked ? "Yes" : "No",
    "National Social Pension": document.getElementById("member_intlsp").checked ? "Yes" : "No",
    "Solo Parent Assistance": document.getElementById("member_solo").checked ? "Yes" : "No",
    "Relief Goods": document.getElementById("member_relief").checked ? "Yes" : "No",
    "Cash Subsidy": document.getElementById("member_cash").checked ? "Yes" : "No",
    "AICS": document.getElementById("memberAics").value || ""
  };
}

/* ----------------- head birthdate live updates ----------------- */
document.getElementById("householdBirthdate").addEventListener("input", ()=>{
  const ymd = document.getElementById("householdBirthdate").value;
  const ageObj = computeAgeObject(ymd);
  document.getElementById("householdAge").value = ageObj ? ageTextFromObj(ageObj) : "";
  document.getElementById("householdStage").value = ageObj ? deriveStageFromAgeObj(ageObj) : "";
});

/* ----------------- member birthdate live updates ----------------- */
document.getElementById("memberBirthdate").addEventListener("input", ()=>{
  const ymd = document.getElementById("memberBirthdate").value;
  const ageObj = computeAgeObject(ymd);
  document.getElementById("memberAge").value = ageObj ? ageTextFromObj(ageObj) : "";
  document.getElementById("memberStage").value = ageObj ? deriveStageFromAgeObj(ageObj) : "";
});

/* ----------------- DOMContentLoaded bindings ----------------- */
document.addEventListener("DOMContentLoaded", ()=> {
  // username (simple guard)
  document.getElementById("userName").innerText = localStorage.getItem("staffName") || "";

  document.getElementById("resetBtn").addEventListener("click", ()=>{
    document.getElementById("headForm").reset();
    collectedMembers = [];
    updateMemberPreview();
  });

  document.getElementById("nextToMembers").addEventListener("click", ()=>{
    const barangay = document.getElementById("barangay").value.trim();
    const sitio = document.getElementById("sitio").value.trim();
    const headName = document.getElementById("householdHead").value.trim();
    if(!barangay || !sitio || !headName){
      alert("Please fill Barangay, Sitio/Purok and Name of Household Head.");
      return;
    }
    membersToCollect = parseInt(document.getElementById("memberCount").value || 0);
    collectedMembers = [];
    currentMemberIndex = 0;
    updateMemberPreview();
    if(membersToCollect === 0){
      submitHeadAndMembers();
      return;
    }
    // open first member panel
    fillMemberPanel(0);
    document.getElementById("panelTitle").innerText = `Member 1 of ${membersToCollect}`;
    openPanel();
  });

  document.getElementById("panelClose").addEventListener("click", ()=> { if(confirm("Close member panel? Unsaved member edits will be kept in preview.")) closePanel(); });

  document.getElementById("memberBack").addEventListener("click", ()=>{
    if(currentMemberIndex > 0){
      // save current
      collectedMembers[currentMemberIndex] = collectMemberDataFromPanel();
      currentMemberIndex--;
      fillMemberPanel(currentMemberIndex);
      document.getElementById("panelTitle").innerText = `Member ${currentMemberIndex+1} of ${membersToCollect}`;
      updateMemberPreview();
    } else {
      // close
      closePanel();
    }
  });

  document.getElementById("memberNext").addEventListener("click", ()=>{
    const name = document.getElementById("memberName").value.trim();
    if(!name){ alert("Please enter member's name."); return; }
    // collect & save
    collectedMembers[currentMemberIndex] = collectMemberDataFromPanel();
    updateMemberPreview();
    currentMemberIndex++;
    if(currentMemberIndex >= membersToCollect){
      // finish
      closePanel();
      submitHeadAndMembers();
      return;
    }
    fillMemberPanel(currentMemberIndex);
    document.getElementById("panelTitle").innerText = `Member ${currentMemberIndex+1} of ${membersToCollect}`;
  });
});

/* ----------------- SUBMIT head + members ----------------- */
async function submitHeadAndMembers(){
  // prepare head
  const headBirthYMD = document.getElementById("householdBirthdate").value || "";
  const ageObj = computeAgeObject(headBirthYMD);
  const ageText = ageTextFromObj(ageObj);

  const head = {
    "Barangay": document.getElementById("barangay").value || "",
    "Sitio / Purok": document.getElementById("sitio").value || "",
    "Name of Household Head": document.getElementById("householdHead").value || "",
    "Sex": document.querySelector("input[name='head_sex']:checked")?.value || "",
    "Birthdate": toSheetDateFormat(headBirthYMD),
    "Age": ageText || "",
    "Stage": ageObj ? deriveStageFromAgeObj(ageObj) : "",
    "No. of Household Member/s": document.getElementById("memberCount").value || "0",
    "Persons with Disability (PWD)": document.querySelector("input[name='head_pwd']:checked")?.value || "No",
    "Reasons for Displacement": document.getElementById("reasons").value || "",
    "Transportation": document.getElementById("head_transport").value || "",
    "Drop-Off Point": document.getElementById("dropoff").value || "",
    "Designated Pick-Up Point": document.getElementById("pickup").value || "",
    "Status": document.getElementById("head_status").value || "",
    "Name of Camp": document.getElementById("campName").value || "",
    "Capacity": document.getElementById("capacity").value || "",
    "No. of Individuals Inside Camp": document.getElementById("insideCamp").value || "",
    "No. of Individuals Outside Camp": document.getElementById("outsideCamp").value || "",
    "TUPAD": document.getElementById("ass_tupad").checked ? "Yes" : "No",
    "Local 4Ps": document.getElementById("ass_local4ps").checked ? "Yes" : "No",
    "National 4Ps": document.getElementById("ass_intl4ps").checked ? "Yes" : "No",
    "Local Social Pension": document.getElementById("ass_locsp").checked ? "Yes" : "No",
    "National Social Pension": document.getElementById("ass_intlsp").checked ? "Yes" : "No",
    "Solo Parent Assistance": document.getElementById("ass_solo").checked ? "Yes" : "No",
    "Relief Goods": document.getElementById("ass_relief").checked ? "Yes" : "No",
    "Cash Subsidy": document.getElementById("ass_cash").checked ? "Yes" : "No",
    "AICS": document.getElementById("ass_aics").value || ""
  };

  // Ensure members array length == memberCount
  const expected = parseInt(document.getElementById("memberCount").value || 0);
  const members = collectedMembers.slice();
  for(let i=0;i<expected;i++){
    if(!members[i]){
      members[i] = {
        "Name of Household Member/s": "",
        "Sex": "",
        "Birthdate": "",
        "Age": "",
        "Stage": "",
        "Persons with Disability (PWD)": "No",
        "Status": "",
        "Transportation": "",
        "Designated Pick-Up Point": "",
        "Drop-Off Point": "",
        "Name of Camp": "",
        "Capacity": "",
        "No. of Individuals Inside Camp": "",
        "No. of Individuals Outside Camp": "",
        "Reasons for Displacement": "",
        "TUPAD": "No",
        "Local 4Ps": "No",
        "National 4Ps": "No",
        "Local Social Pension": "No",
        "National Social Pension": "No",
        "Solo Parent Assistance": "No",
        "Relief Goods": "No",
        "Cash Subsidy": "No",
        "AICS": ""
      };
    }
  }

  // disable UI
  const btn = document.getElementById("nextToMembers");
  btn.disabled = true; btn.innerText = "Saving...";

  try {
    const fd = new FormData();
    fd.append("action","createRecord");
    fd.append("head", JSON.stringify(head));
    fd.append("members", JSON.stringify(members));
    fd.append("submittedBy", localStorage.getItem("staffName") || localStorage.getItem("username") || "Unknown");

    const res = await fetch(API_URL, { method: "POST", body: fd });
    const txt = await res.text();
    let json;
    try { json = JSON.parse(txt); } catch(e){ throw new Error("Invalid server response"); }

    if(json.success){
      alert("Saved (Data ID: " + (json.dataID || "n/a") + ")");
      window.location.href = "records.html";
    } else {
      alert("Save failed: " + (json.message || "Unknown"));
      console.error("SAVE ERROR", json);
    }
  } catch(err){
    console.error("SUBMIT ERROR", err);
    alert("Network/server error ‚Äî check console");
  } finally {
    btn.disabled = false; btn.innerText = "Save ‚Üí Next Members";
  }
}
</script>
</body>
</html>
