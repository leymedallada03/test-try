<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan ‚Äî Data Entry of household</title>
<link rel="stylesheet" href="styles.css"/>
<style>
   :root{
    --bg:#f6f8f7;
    --card-bg:#fff;
    --muted:#6b6f6b;
    --accent1:#0f7a4a;
    --accent2:#34b78f;
    --shadow: 0 6px 18px rgba(6,30,20,0.06);
    --radius:12px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  #disc {
  margin-bottom: 10px;
}
   .gov-support-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* 3 columns */
  gap: 10px 20px; /* row-gap, column-gap */
  margin-top: 12px;
}

.gov-support-grid .checkbox-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0;
}
.sub-label1 {
  color: var(--muted);
  display: block;       /* makes it sit below the title */
  margin-left: 39px;    /* indent */
  margin-bottom: 10px;  /* space below */
  font-size: 12px;
   margin-top: -4px;    /* pulls text closer upward */
}
   textarea {
  font-family: inherit;   /* use your website font */
  font-size: 13px;        /* smaller text */
  line-height: 1.4;       /* nicer spacing */
}

  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#f4f6f5);color:#072016}
  .page-container{display:grid;grid-template-columns:260px 1fr;min-height:100vh;gap:18px}
  .sidebar{background:transparent;padding:18px}
  .sidebar ul{list-style:none;padding:0;margin:0}
  .sidebar li{margin-bottom:10px}
  .sidebar a{display:block;padding:10px;border-radius:10px;text-decoration:none;color:#0b4630;font-weight:700}
  .sidebar a.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff}
  .content-area{padding:18px}
  h2{margin:8px 0 18px 0}
  .card{ padding:16px;border-radius:var(--radius);background:var(--card-bg);margin-bottom:12px;box-shadow:var(--shadow) }
  .form-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; align-items:start }
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{display:block;font-weight:700;margin-bottom:6px;color:#0b4630}
  input[type="text"], input[type="date"], input[type="number"], select, textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid rgba(6,30,20,0.06);box-shadow:none;font-size:14px;
    transition: box-shadow .18s ease, transform .12s ease;
    background:#fff;
  }
  input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(20%) sepia(50%) saturate(600%) hue-rotate(120deg) brightness(90%)}
  input:focus, select:focus, textarea:focus{outline:none;box-shadow:0 8px 22px rgba(6,30,20,0.06);transform:translateY(-1px)}
  .small-muted{ font-size:12px; color:var(--muted) }
  .member-preview{ margin-top:8px; font-size:14px }
  .member-preview li{ margin-bottom:6px }

  /* radio / checkbox alignment */
  .radio-line, .checkbox-grid { display:flex; gap:12px; align-items:center; flex-wrap:wrap }
  .radio-item, .checkbox-item{ display:flex; align-items:center; gap:8px; font-weight:600; color:#0b4630 }
  .radio-item input, .checkbox-item input{transform:scale(1.05)}

  /* member panel (slide-in) */
  .member-panel { position: fixed; right: 0; top: 0; height: 100vh; width: 420px; max-width: 96%; background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,250,0.98)); box-shadow: -18px 0 40px rgba(6,30,20,0.12); transform: translateX(110%); transition: transform 320ms cubic-bezier(.2,.9,.3,1); z-index: 6000; padding: 18px; overflow-y: auto; border-radius: 8px 0 0 8px;}
  .member-panel.open { transform: translateX(0%); }
  .panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.32); opacity: 0; transition: opacity 200ms; pointer-events: none; z-index: 5900; }
  .panel-overlay.show { opacity: 1; pointer-events: auto; }

  .btn { border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;background: linear-gradient(90deg,var(--accent1),var(--accent2)); color:#fff; }
  .btn.secondary { background: transparent; color: var(--accent1); border:1px solid rgba(6,30,20,0.06); }

  .actions-row{display:flex;gap:8px;justify-content:flex-end}

  /* domestic animals grid */
  .domestic-grid{ display:grid; grid-template-columns: repeat(2,1fr); gap:10px 18px; align-items:center }
  .animal-row{ display:flex; gap:8px; align-items:center; justify-content:space-between; background:#fbfffb;padding:8px;border-radius:10px;border:1px solid rgba(6,30,20,0.03) }
  .animal-left{display:flex;gap:8px;align-items:center}
  .animal-left label{margin:0;font-weight:700}
  .qty{width:86px}
  .others-box{width:100%;min-height:72px;padding:10px;border-radius:10px;border:1px solid rgba(6,30,20,0.06)}

  /* responsive */
  @media (max-width:980px){
    .page-container{grid-template-columns:1fr}
    .sidebar{display:none}
    .form-grid{grid-template-columns:1fr}
    .domestic-grid{grid-template-columns:1fr}
  }

  /* subtle animations for selects */
  select.animated{appearance:none;padding-right:36px;background-image:linear-gradient(45deg,transparent 50%,#0b4630 50%),linear-gradient(135deg,#0b4630 50%,transparent 50%);background-position:calc(100% - 20px) calc(1em + 2px), calc(100% - 15px) calc(1em + 2px);background-size:6px 6px,6px 6px;background-repeat:no-repeat}
  .section-title{display:flex;align-items:center;gap:10px; margin-bottom:10px}
   .section-title1{display:flex;align-items:center;gap:10px;}
  .chip{padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;font-size:13px;font-weight:800}
  .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(6,30,20,0.04),transparent);margin:12px 0;border-radius:6px}

  /* small helpers */
  .muted{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="page-container">

  <header class="topbar">
    <button id="menuToggle" class="menu-btn" aria-label="Toggle menu" aria-expanded="true">‚ò∞</button>

    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div>
        <div class="title">PUROK KALIGTASAN</div>
        <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
      </div>
    </div>

    <div style="margin-left:auto;display:flex;gap:12px;align-items:center">
      <div class="muted">Signed in as <strong id="userName"></strong></div>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <ul>
      <li><a href="dashboard.html" id="navUsers">üìä Dashboard</a></li>
      <li><a href="dataForm.html" id="navUsers"  class="active" >üìù Data Entry</a></li>
      <li><a href="records.html" id="navUsers" >üìÅ Records</a></li>
      <li><a href="charts.html" id="navUsers" >üìà Charts</a></li>
      <li id="navUsers" style="display:none;">
    <a href="users.html">üë• User Management</a>
    </ul>
  </aside>

  <main class="content-area" tabindex="-1">
    <h2>üìù Household Information (Head)</h2>
   <div class="small-muted" id="disc">This section captures all key information about the household head, including personal data, contact details, demographic profile, and any government support or programs currently availed. The information will help establish the primary point of contact and provide a clear understanding of the household‚Äôs overall status..</div>

    <form id="headForm" novalidate onsubmit="return false;">
      <!-- BASIC -->
      <div class="card form-section">
        <div class="section-title"><div class="chip">1</div><h3>Basic Information </h3></div>
        <div class="form-grid">
          <div>
  <label>Coordinate (optional)</label>
  <input type="text" id="coordinate" placeholder="Latitude, Longitude (optional)" />

  <div style="margin-top:6px; display:flex; gap:6px;">
    <!-- GPS Button -->
    <button type="button" id="getLocationBtn" class="btn secondary">
      Get Current Location
    </button>

    <!-- üÜï Map Picker Button -->
    <button type="button" id="pickOnMapBtn" class="btn secondary">
      Pick on Map
</button>
<div class="small-muted">Optional ‚Äî paste `lat, lng` if available.</div>

          </div>

          <div>
            <label>Barangay <span class="small">*</span></label>
            <select id="barangay" required class="animated">
              <option value="">Select Barangay...</option>
              <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
              <option>Dalipit East</option><option>Dalipit West</option><option>Dominador East</option>
              <option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
              <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option>
              <option>Ping-As</option><option>Poblacion East</option><option>Poblacion West</option>
              <option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
            </select>
          </div>

          <div>
            <label>Sitio / Purok <span class="small">*</span></label>
            <select id="sitio" required class="animated">
              <option value="">Select...</option>
              <option>Purok I</option><option>Purok II</option><option>Purok III</option>
              <option>Purok IV</option><option>Purok V</option><option>Purok VI</option>
              <option>Purok VII</option>
            </select>
          </div>

          <div>
            <label>Name of Household Head <span class="small">*</span></label>
            <input type="text" id="householdHead" required />
          </div>

          <div>
            <label>Contact no. <span class="small">*</span></label>
            <input type="text" id="contactNo" placeholder="09XXXXXXXXX" required />
          </div>

          <div>
            <label>Sex <span class="small">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="head_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate <span class="small">*</span></label>
            <input type="date" id="householdBirthdate" required />
          </div>

          <div>
            <label>Age</label>
            <input type="text" id="householdAge" readonly />
          </div>

          <div>
            <label>Age Category</label>
            <input type="text" id="householdStage" readonly />
          </div>

          <div>
            <label>No. of Household Member/s <span class="small">*</span></label>
            <input type="number" id="memberCount" min="0" value="0" />
            <div class="small-muted">Set to 0 if no other members.</div>
          </div>
        </div>
      </div>

      <!-- HEALTH & STATUS -->
      <div class="card">
        <div class="section-title"><div class="chip">2</div><h3>Health and Status</h3></div>
        <div class="form-grid">
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_pwd" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="head_pwd" value="No"> No</label>
            </div>
          </div>

          <div>
            <label>Status</label>
            <select id="head_status" class="animated">
              <option value="">Select...</option>
              <option>With Sickness</option><option>Pregnant</option><option>Solo Parent</option><option>Lactating</option><option>Severe Illness</option><option>HIV Positive</option><option>LGBTQ Plus</option>
            </select>
          </div>
          </div>
        </div>

      <!-- DOMESTIC ANIMALS -->
      <div class="card">
        <div class="section-title1"><div class="chip">3</div><h3>Household Livestock</h3></div>
         <div class="sub-label1">Please check (‚úì) all items that apply.</div>

        <div class="domestic-grid">
          <div class="animal-row">
            <div class="animal-left">
              <label class="checkbox-item"><input type="checkbox" id="dog_chk"> Dog</label>
            </div>
            <div><input type="number" id="dog_qty" class="qty" min="0" placeholder="Qty" /></div>
          </div>

          <div class="animal-row">
            <div class="animal-left">
              <label class="checkbox-item"><input type="checkbox" id="cat_chk"> Cat</label>
            </div>
            <div><input type="number" id="cat_qty" class="qty" min="0" placeholder="Qty" /></div>
          </div>

          <div class="animal-row">
            <div class="animal-left">
              <label class="checkbox-item"><input type="checkbox" id="pig_chk"> Pig</label>
            </div>
            <div><input type="number" id="pig_qty" class="qty" min="0" placeholder="Qty" /></div>
          </div>

          <div class="animal-row">
            <div class="animal-left">
              <label class="checkbox-item"><input type="checkbox" id="cow_chk"> Cow</label>
            </div>
            <div><input type="number" id="cow_qty" class="qty" min="0" placeholder="Qty" /></div>
          </div>

          <div class="animal-row">
            <div class="animal-left">
              <label class="checkbox-item"><input type="checkbox" id="carabao_chk"> Carabao</label>
            </div>
            <div><input type="number" id="carabao_qty" class="qty" min="0" placeholder="Qty" /></div>
          </div>

          <div class="animal-row">
            <div class="animal-left">
              <label class="checkbox-item"><input type="checkbox" id="chicken_chk"> Chicken</label>
            </div>
            <div><input type="number" id="chicken_qty" class="qty" min="0" placeholder="Qty" /></div>
          </div>

          <div style="grid-column:1/-1">
            <label>Others (describe ‚Äî max ~2 sentences)</label>
            <textarea id="animals_others" class="others-box" placeholder="Describe other domestic animals or notes..."></textarea>
          </div>
        </div>
      </div>

      <!-- PICKUP / TRANSPORT / CAMP -->
      <div class="card">
        <div class="section-title"><div class="chip">4</div><h3>Pickup / Transport / Camp Details</h3></div>
        <div class="form-grid">
            <div>
            <label>Transportation</label>
            <select id="head_transport" class="animated">
              <option value="">Select...</option>
              <option>Individual with Transportation</option>
              <option>Individual needing Transportation</option>
            </select>
               </div>
          <div>
            <label>Designated Pick-Up Point</label>
            <input type="text" id="pickup" />
          </div>
          <div>
            <label>Drop-Off Point</label>
            <input type="text" id="dropoff" />
          </div>
          <div>
            <label>Name of Camp</label>
            <input type="text" id="campName" />
          </div>
          <div>
            <label>Capacity</label>
            <input type="number" id="capacity" min="0" />
          </div>
          <div>
            <label>No. of Individuals Inside Camp</label>
            <input type="number" id="insideCamp" min="0" />
          </div>
          <div>
            <label>No. of Individuals Outside Camp</label>
            <input type="number" id="outsideCamp" min="0"/>
          </div>

          <div style="grid-column:1/-1">
            <label>Reason for Displacement</label>
            <select id="reasons" class="animated">
              <option value="">Select...</option>
              <option>Taal Volcano (With-in 14-15 KM Danger Zone)</option>
               <option>Typhoon</option>
               <option>Flood</option>
               <option>Landslide</option>
               <option>Earthquake</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <!-- GOVERNMENT SUPPORT -->
<div class="card">
  <div class="section-title1"><div class="chip">5</div><h3>Government Support</h3></div>
<label class="sub-label1">Please check (‚úì) all items that apply.</label>

  <div class="gov-support-grid">
    <label class="checkbox-item"><input type="checkbox" id="ass_tupad"> TUPAD</label>
    <label class="checkbox-item"><input type="checkbox" id="ass_local4ps"> Local 4Ps</label>
    <label class="checkbox-item"><input type="checkbox" id="ass_intl4ps"> National 4Ps</label>
    <label class="checkbox-item"><input type="checkbox" id="ass_locsp"> Local Social Pension</label>
    <label class="checkbox-item"><input type="checkbox" id="ass_intlsp"> National Social Pension</label>
    <label class="checkbox-item"><input type="checkbox" id="ass_solo"> Solo Parent Assistance</label>
    <label class="checkbox-item"><input type="checkbox" id="ass_relief"> Relief Goods</label>
    <label class="checkbox-item"><input type="checkbox" id="ass_cash"> Cash Subsidy</label>
  </div>
</div>

          <div style="grid-column:1/-1;margin-top:8px;margin-bottom:8px">
            <label>AICS (if any)</label>
            <select id="ass_aics" class="animated">
              <option value="">None</option>
              <option>Shelter Assistance</option>
              <option>Burial</option>
              <option>Scholarship</option>
            </select>
          </div>

      <!-- MEMBERS PREVIEW + ACTION -->
      <div class="card">
        <div class="section-title"><div class="chip">6</div><h3>Members to be collected</h3></div>
        <div class="small-muted">Member/s: <strong id="previewCount">0</strong></div>
        <ul id="membersPreview" class="member-preview"></ul>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="resetBtn" class="btn secondary" type="button">Reset</button>
          <button id="nextToMembers" class="btn" type="button">Save ‚Üí Next Members</button>
        </div>
      </div>
    </form>
  </main>
</div>

<!-- overlay + member panel -->
<div id="panelOverlay" class="panel-overlay" aria-hidden="true"></div>

<div id="memberPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Member entry panel">
  <div class="panel-header" style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
    <button id="panelClose" class="btn secondary" title="Close panel">‚Üê</button>
    <h3 id="panelTitle">Member 1 of N</h3>
  </div>

  <div class="panel-body">
    <form id="memberForm" onsubmit="return false;">
      <div class="form-grid">
        <div>
          <label>Member Name <span class="small">*</span></label>
          <input type="text" id="memberName" class="member-name" required />
        </div>

        <div>
          <label>Contact no. <span class="small">*</span></label>
          <input type="text" id="memberContact" class="member-contact" placeholder="09XXXXXXXXX" required />
        </div>

        <div>
          <label>Sex</label>
          <div class="radio-line">
            <label class="radio-item"><input type="radio" name="member_sex" value="Male" class="member-sex"> Male</label>
            <label class="radio-item"><input type="radio" name="member_sex" value="Female" class="member-sex"> Female</label>
          </div>
        </div>

        <div>
          <label>Birthdate</label>
          <input type="date" id="memberBirthdate" class="member-birthdate" />
        </div>

        <div>
          <label>Age</label>
          <input type="text" id="memberAge" class="member-age" readonly />
        </div>

        <div>
          <label>PWD</label>
          <div class="radio-line">
            <label class="radio-item"><input type="radio" name="member_pwd" value="Yes" class="member-pwd"> Yes</label>
            <label class="radio-item"><input type="radio" name="member_pwd" value="No" checked class="member-pwd"> No</label>
          </div>
        </div>

        <div>
          <label>Age Category</label>
          <input type="text" id="memberStage" class="member-stage" readonly />
        </div>

        <div>
          <label>Status</label>
          <select id="memberStatus" class="member-status animated">
            <option>With Sickness</option><option>Pregnant</option><option>Solo Parent</option><option>Lactating</option><option>Severe Illness</option><option>HIV Positive</option><option>LGBTQ Plus</option>
          </select>
        </div>

        <div>
          <label>Transportation</label>
          <select id="memberTransport" class="member-transport animated">
            <option value="">Select...</option>
            <option>Individual with Transportation</option>
            <option>Individual needing Transportation</option>
          </select>
        </div>

        <div>
          <label>Designated Pick-Up Point</label>
          <input type="text" id="memberPickup" class="member-pickup"/>
        </div>

        <div>
          <label>Drop-Off Point</label>
          <input type="text" id="memberDropoff" class="member-dropoff"/>
        </div>

        <div>
          <label>Name of Camp</label>
          <input type="text" id="memberCamp" class="member-camp"/>
        </div>

        <div>
          <label>Capacity</label>
          <input type="number" id="memberCampCap" class="member-cap" min="0"/>
        </div>

        <div>
          <label>No. of Individuals Inside Camp</label>
          <input type="number" id="memberInside" class="member-inside" min="0"/>
        </div>

        <div>
          <label>No. of Individuals Outside Camp</label>
          <input type="number" id="memberOutside" class="member-outside" min="0"/>
        </div>

        <div>
          <label>Reason for Displacement</label>
          <select id="memberReason" class="member-reason animated">
              <option>Taal Volcano (With-in 14-15 KM Danger Zone)</option>
               <option>Typhoon</option>
               <option>Flood</option>
               <option>Landslide</option>
               <option>Earthquake</option>
              <option>Others</option>
          </select>
        </div>

        <div style="grid-column:1/-1; margin-top:8px">
          <h4 style="margin:6px 0 8px 0">Government Support</h4>
         <div class="small-muted">Please check (‚úì) all items that apply.</div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px 12px">
            <label><input type="checkbox" id="member_tupad" class="member_tupad"> TUPAD</label>
            <label><input type="checkbox" id="member_local4ps" class="member_local4ps"> Local 4Ps</label>
            <label><input type="checkbox" id="member_intl4ps" class="member_intl4ps"> National 4Ps</label>
            <label><input type="checkbox" id="member_locsp" class="member_locsp"> Local Social Pension</label>
            <label><input type="checkbox" id="member_intlsp" class="member_intlsp"> National Social Pension</label>
            <label><input type="checkbox" id="member_solo" class="member_solo"> Solo Parent Assistance</label>
            <label><input type="checkbox" id="member_cash" class="member_cash"> Cash Subsidy</label>
            <label><input type="checkbox" id="member_relief" class="member_relief"> Relief Goods</label>
          </div>

          <div style="margin-top:8px">
            <label>AICS (if any)</label>
            <select id="memberAics" class="member_aics animated">
              <option value="">None</option>
              <option>Shelter Assistance</option>
              <option>Burial</option>
              <option>Scholarship</option>
            </select>
          </div>
        </div>

      </div>

      <div class="panel-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="memberBack" class="btn secondary" type="button">Back</button>
        <button id="memberNext" class="btn" type="button">Save & Next</button>
      </div>
    </form>
  </div>
</div>

<script>
/* final merged client-side script (age, panel, submit). Keep API_URL updated if needed */
const API_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";

/* ---------------- helpers ---------------- */
function toSheetDateFormat(inputVal){
  if(!inputVal) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputVal)){
    const [y,m,d] = inputVal.split('-');
    return `${d}/${m}/${y}`;
  }
  const dt = new Date(inputVal);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dd}/${mm}/${dt.getFullYear()}`;
  }
  return String(inputVal);
}
function toInputDate(val){
  if(!val) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(val)){
    const [d,m,y] = val.split('/');
    return `${y}-${m}-${d}`;
  }
  const dt = new Date(val);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dt.getFullYear()}-${mm}-${dd}`;
  }
  return "";
}

/* compute age display + stage */
function computeAgeDetailed(inputDateValue){
  if(!inputDateValue) return null;
  let d;
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputDateValue)){
    const parts = inputDateValue.split('-');
    d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
  } else {
    d = new Date(inputDateValue);
  }
  if(isNaN(d)) return null;

  const now = new Date();
  const birth = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  let years = today.getFullYear() - birth.getFullYear();
  let months = today.getMonth() - birth.getMonth();
  let days = today.getDate() - birth.getDate();

  if(days < 0){
    months -= 1;
    const prev = new Date(today.getFullYear(), today.getMonth(), 0);
    days += prev.getDate();
  }
  if(months < 0){
    years -= 1;
    months += 12;
  }

  let display = "";
  if(years >= 1){
    display = String(years);
  } else {
    if(months >= 1) display = `${months} month/s`;
    else display = `${days} day/s`;
  }

  let stage = "";
  if(years === 0){
    if(months <= 10) stage = "Infant";
    else stage = "Children";
  } else if(years <= 17) stage = "School Children";
  else if(years >= 60) stage = "Elderly";
  else stage = "Adult";

  return { years, months, days, display, stage };
}

/* ---------------- UI + state ---------------- */
function ensureLoginOrRedirect(){
  if(!localStorage.getItem("loggedIn")){ /* keep as-is or redirect to login */ return true; }
  return true;
}

let membersToCollect = 0;
let currentMemberIndex = 0;
let collectedMembers = [];

function updateMemberPreview(){
  const n = parseInt(document.getElementById("memberCount").value || 0);
  document.getElementById("previewCount").innerText = n;
  const list = document.getElementById("membersPreview");
  list.innerHTML = "";
  for(let i=0;i<n;i++){
    const mem = collectedMembers[i];
    const li = document.createElement('li');
    li.innerText = mem ? `#${i+1} ‚Äî ${mem["Name of Household Member/s"] || "(empty)"} (${mem["Contact no."]||""})` : `#${i+1} ‚Äî (empty)`;
    list.appendChild(li);
  }
}

/* fill member panel */
function fillMemberPanel(idx){
  const mem = collectedMembers[idx] || {};
  document.getElementById("memberName").value = mem["Name of Household Member/s"] || "";
  document.getElementById("memberContact").value = mem["Contact no."] || "";
  Array.from(document.getElementsByName("member_sex")).forEach(r => r.checked = (r.value === (mem["Sex"] || "")));
  document.getElementById("memberBirthdate").value = mem["Birthdate"] ? toInputDate(mem["Birthdate"]) : "";
  document.getElementById("memberAge").value = mem["Age"] || "";
  document.getElementById("memberStage").value = mem["Stage"] || "";
  document.getElementById("memberStatus").value = mem["Status"] || "";
  document.getElementById("memberTransport").value = mem["Transportation"] || "";
  document.getElementById("memberPickup").value = mem["Designated Pick-Up Point"] || "";
  document.getElementById("memberDropoff").value = mem["Drop-Off Point"] || "";
  document.getElementById("memberCamp").value = mem["Name of Camp"] || "";
  document.getElementById("memberCampCap").value = mem["Capacity"] || "";
  document.getElementById("memberInside").value = mem["No. of Individuals Inside Camp"] || "";
  document.getElementById("memberOutside").value = mem["No. of Individuals Outside Camp"] || "";
  document.getElementById("memberReason").value = mem["Reasons for Displacement"] || "";
  document.getElementById("member_tupad").checked = (mem["TUPAD"] === "Yes");
  document.getElementById("member_local4ps").checked = (mem["Local 4Ps"] === "Yes");
  document.getElementById("member_intl4ps").checked = (mem["National 4Ps"] === "Yes");
  document.getElementById("member_locsp").checked = (mem["Local Social Pension"] === "Yes");
  document.getElementById("member_intlsp").checked = (mem["National Social Pension"] === "Yes");
  document.getElementById("member_solo").checked = (mem["Solo Parent Assistance"] === "Yes");
  document.getElementById("member_relief").checked = (mem["Relief Goods"] === "Yes");
  document.getElementById("member_cash").checked = (mem["Cash Subsidy"] === "Yes");
  document.getElementById("memberAics").value = mem["AICS"] || "";
}

/* collect member data */
function collectMemberDataFromPanel(){
  const name = document.getElementById("memberName").value.trim();
  const sex = document.querySelector("input[name='member_sex']:checked")?.value || "";
  const birth_input = document.getElementById("memberBirthdate").value || "";
  const birth_for_sheet = toSheetDateFormat(birth_input);
  const ageObj = computeAgeDetailed(birth_input);
  const ageVal = ageObj ? ageObj.display : "";
  const stageVal = ageObj ? ageObj.stage : "";

  return {
    "Name of Household Member/s": name,
    "Contact no.": document.getElementById("memberContact").value || "",
    "Sex": sex,
    "Birthdate": birth_for_sheet,
    "Age": ageVal,
    "Stage": stageVal,
    "PWD": (document.querySelector("input[name='member_pwd']:checked")?.value || "No"),
    "Status": document.getElementById("memberStatus").value || "",
    "Transportation": document.getElementById("memberTransport").value || "",
    "Designated Pick-Up Point": document.getElementById("memberPickup").value || "",
    "Drop-Off Point": document.getElementById("memberDropoff").value || "",
    "Name of Camp": document.getElementById("memberCamp").value || "",
    "Capacity": document.getElementById("memberCampCap").value || "",
    "No. of Individuals Inside Camp": document.getElementById("memberInside").value || "",
    "No. of Individuals Outside Camp": document.getElementById("memberOutside").value || "",
    "Reasons for Displacement": document.getElementById("memberReason").value || "",
    "TUPAD": document.getElementById("member_tupad").checked ? "Yes" : "No",
    "Local 4Ps": document.getElementById("member_local4ps").checked ? "Yes" : "No",
    "National 4Ps": document.getElementById("member_intl4ps").checked ? "Yes" : "No",
    "Local Social Pension": document.getElementById("member_locsp").checked ? "Yes" : "No",
    "National Social Pension": document.getElementById("member_intlsp").checked ? "Yes" : "No",
    "Solo Parent Assistance": document.getElementById("member_solo").checked ? "Yes" : "No",
    "Relief Goods": document.getElementById("member_relief").checked ? "Yes" : "No",
    "Cash Subsidy": document.getElementById("member_cash").checked ? "Yes" : "No",
    "AICS": document.getElementById("memberAics").value || ""
  };
}

/* live age update */
document.addEventListener('input', (ev) => {
  if(ev.target && ev.target.id === "memberBirthdate"){
    const v = ev.target.value;
    const info = computeAgeDetailed(v);
    document.getElementById("memberAge").value = info ? info.display : "";
    document.getElementById("memberStage").value = info ? info.stage : "";
  }
  if(ev.target && ev.target.id === "householdBirthdate"){
    const v = ev.target.value;
    const info = computeAgeDetailed(v);
    document.getElementById("householdAge").value = info ? info.display : "";
    document.getElementById("householdStage").value = info ? info.stage : "";
  }
});

/* ---------------- DOM loaded bindings ---------------- */
document.addEventListener('DOMContentLoaded', () => {
  ensureLoginOrRedirect();
  document.getElementById("userName").innerText = localStorage.getItem("staffName") || "";

  // reset
  document.getElementById("resetBtn").addEventListener('click', () => {
    document.getElementById("headForm").reset();
    collectedMembers = [];
    updateMemberPreview();
    document.getElementById("householdAge").value = "";
    document.getElementById("householdStage").value = "";
  });

  // next (head -> members)
  document.getElementById("nextToMembers").addEventListener('click', () => {
    const barangay = document.getElementById("barangay").value.trim();
    const sitio = document.getElementById("sitio").value.trim();
    const headName = document.getElementById("householdHead").value.trim();
    const headContact = document.getElementById("contactNo").value.trim();
    if(!barangay || !sitio || !headName || !headContact){ alert("Please fill Barangay, Sitio/Purok, Name of Household Head and Contact no."); return; }

    membersToCollect = parseInt(document.getElementById("memberCount").value || 0);
    collectedMembers = []; currentMemberIndex = 0;
    updateMemberPreview();

    if(membersToCollect === 0){
      // no members -> submit head only
      submitHeadAndMembers();
      return;
    }

    // open member panel first
    fillMemberPanel(0);
    currentMemberIndex = 0;
    document.getElementById('panelTitle').innerText = `Member 1 of ${membersToCollect}`;
    openPanel();
  });

  // panel close/back
  document.getElementById("panelClose").addEventListener('click', () => { closePanel(); });
  document.getElementById("memberBack").addEventListener('click', () => {
    if(currentMemberIndex > 0){
      collectedMembers[currentMemberIndex] = collectMemberDataFromPanel();
      currentMemberIndex--;
      fillMemberPanel(currentMemberIndex);
      document.getElementById('panelTitle').innerText = `Member ${currentMemberIndex+1} of ${membersToCollect}`;
      updateMemberPreview();
    } else {
      closePanel();
    }
  });

  // memberNext (save & next)
  document.getElementById("memberNext").addEventListener('click', () => {
    const name = document.getElementById("memberName").value.trim();
    const contact = document.getElementById("memberContact").value.trim();
    if(!name || !contact){ alert("Please enter member's name and contact no."); return; }

    collectedMembers[currentMemberIndex] = collectMemberDataFromPanel();
    updateMemberPreview();

    currentMemberIndex++;
    if(currentMemberIndex >= membersToCollect){
      // done
      closePanel();
      submitHeadAndMembers();
      return;
    }
    fillMemberPanel(currentMemberIndex);
    document.getElementById('panelTitle').innerText = `Member ${currentMemberIndex+1} of ${membersToCollect}`;
  });

  document.getElementById("householdBirthdate").addEventListener('change', () => {
    const info = computeAgeDetailed(document.getElementById("householdBirthdate").value);
    document.getElementById("householdAge").value = info ? info.display : "";
    document.getElementById("householdStage").value = info ? info.stage : "";
  });

  updateMemberPreview();
});

/* panel helpers */
function openPanel(){ document.getElementById("memberPanel").classList.add("open"); document.getElementById("panelOverlay").classList.add("show"); }
function closePanel(){ document.getElementById("memberPanel").classList.remove("open"); document.getElementById("panelOverlay").classList.remove("show"); }

/* ---------------- Submit head + members ---------------- */
async function submitHeadAndMembers(){
  // gather head
  const headBirthInput = document.getElementById("householdBirthdate").value || "";
  const headBirthForSheet = toSheetDateFormat(headBirthInput);
  const headAgeInfo = computeAgeDetailed(headBirthInput);
  const headAgeVal = headAgeInfo ? headAgeInfo.display : "";

  const head = {
    "Coordinate": document.getElementById("coordinate").value || "",
    "Barangay": document.getElementById("barangay").value || "",
    "Sitio / Purok": document.getElementById("sitio").value || "",
    "Name of Household Head": document.getElementById("householdHead").value || "",
    "Contact no.": document.getElementById("contactNo").value || "",
    "Sex": document.querySelector("input[name='head_sex']:checked")?.value || "",
    "Birthdate": headBirthForSheet,
    "Age": headAgeVal,
    "No. of Household Member/s": document.getElementById("memberCount").value || "0",
    "Name of Household Member/s": "", // head row has this empty
    "PWD": document.querySelector("input[name='head_pwd']:checked")?.value || "No",
    "Stage": headAgeInfo ? headAgeInfo.stage : "",
    "Status": document.getElementById("head_status").value || "",
    "Transportation": document.getElementById("head_transport").value || "",
    "Designated Pick-Up Point": document.getElementById("pickup").value || "",
    "Drop-Off Point": document.getElementById("dropoff").value || "",
    "Name of Camp": document.getElementById("campName").value || "",
    "Capacity": document.getElementById("capacity").value || "",
    "No. of Individuals Inside Camp": document.getElementById("insideCamp").value || "",
    "No. of Individuals Outside Camp": document.getElementById("outsideCamp").value || "",
    "Reasons for Displacement": document.getElementById("reasons").value || "",
    "TUPAD": document.getElementById("ass_tupad").checked ? "Yes" : "No",
    "Local 4Ps": document.getElementById("ass_local4ps").checked ? "Yes" : "No",
    "National 4Ps": document.getElementById("ass_intl4ps").checked ? "Yes" : "No",
    "Local Social Pension": document.getElementById("ass_locsp").checked ? "Yes" : "No",
    "National Social Pension": document.getElementById("ass_intlsp").checked ? "Yes" : "No",
    "Solo Parent Assistance": document.getElementById("ass_solo").checked ? "Yes" : "No",
    "Relief Goods": document.getElementById("ass_relief").checked ? "Yes" : "No",
    "Cash Subsidy": document.getElementById("ass_cash").checked ? "Yes" : "No",
    "AICS": document.getElementById("ass_aics").value || "",
    /* Domestic animals ‚Äî store as separate fields matching your header */
    "Dog": document.getElementById("dog_chk").checked ? "Yes" : "No",
    "Dog Qty.": document.getElementById("dog_qty").value || "",
    "Cat": document.getElementById("cat_chk").checked ? "Yes" : "No",
    "Cat Qty.": document.getElementById("cat_qty").value || "",
    "Pig": document.getElementById("pig_chk").checked ? "Yes" : "No",
    "Pig Qty.": document.getElementById("pig_qty").value || "",
    "Cow": document.getElementById("cow_chk").checked ? "Yes" : "No",
    "Cow Qty.": document.getElementById("cow_qty").value || "",
    "Carabao": document.getElementById("carabao_chk").checked ? "Yes" : "No",
    "Carabao Qty.": document.getElementById("carabao_qty").value || "",
    "Chicken": document.getElementById("chicken_chk").checked ? "Yes" : "No",
    "Chicken Qty.": document.getElementById("chicken_qty").value || "",
    "Others": document.getElementById("animals_others").value || "",
    "Submitted By": localStorage.getItem("staffName") || localStorage.getItem("username") || "Unknown",
    "Submitted On": new Date().toLocaleString() // the server will replace with formatted timestamp, but we include for debugging
  };

  // ensure members length matches selected
  const expected = parseInt(document.getElementById("memberCount").value || 0);
  const members = collectedMembers.slice(0);
  for(let i=0;i<expected;i++){
    if(!members[i]){
      members[i] = {
        "Name of Household Member/s": "",
        "Contact no.": "",
        "Sex": "",
        "Birthdate": "",
        "Age": "",
        "Stage": "",
        "PWD": "No",
        "Status": "",
        "Transportation": "",
        "Designated Pick-Up Point": "",
        "Drop-Off Point": "",
        "Name of Camp": "",
        "Capacity": "",
        "No. of Individuals Inside Camp": "",
        "No. of Individuals Outside Camp": "",
        "Reasons for Displacement": "",
        "TUPAD": "No",
        "Local 4Ps": "No",
        "National 4Ps": "No",
        "Local Social Pension": "No",
        "National Social Pension": "No",
        "Solo Parent Assistance": "No",
        "Relief Goods": "No",
        "Cash Subsidy": "No",
        "AICS": ""
      };
    }
    // ensure birthdate format DD/MM/YYYY
    if(members[i]["Birthdate"]){
      members[i]["Birthdate"] = (members[i]["Birthdate"].indexOf('/') === -1) ? toSheetDateFormat(members[i]["Birthdate"]) : members[i]["Birthdate"];
    }
  }

  // Build request
  const form = new FormData();
  form.append("action","createRecord");
  form.append("head", JSON.stringify(head));
  form.append("members", JSON.stringify(members));
  form.append("submittedBy", localStorage.getItem("staffName") || localStorage.getItem("username") || "Unknown");

  // UI disable
  const submitBtn = document.getElementById("nextToMembers");
  submitBtn.disabled = true;
  submitBtn.innerText = "Saving...";

  try{
    console.log("Submitting HEAD:", head);
    console.log("Submitting MEMBERS:", members);
    const res = await fetch(API_URL, { method: "POST", body: form });
    const text = await res.text();
    console.log("RAW RESPONSE:", text);

    let data;
    try { data = JSON.parse(text); } catch (e) {
      // server returned non-JSON (error). Show raw.
      throw new Error("Invalid response from server: " + text);
    }

    if(data.success){
      alert("Record saved successfully! (Data ID: " + (data.dataID || "n/a") + ")");
      window.location.href = "records.html";
    } else {
      alert("Save failed: " + (data.message || "Unknown error"));
      console.error("SAVE ERROR:", data);
    }
  }catch(err){
    console.error("SUBMIT ERROR:", err);
    alert("Network / Server error: " + (err.message || err));
  }finally{
    submitBtn.disabled = false;
    submitBtn.innerText = "Save ‚Üí Next Members";
  }
}
// ======================================================
// üìå GPS COORDINATE BUTTON ‚Äî CLEAN FINAL VERSION
// ======================================================
document.getElementById("getLocationBtn").addEventListener("click", () => {

  // Check browser support
  if (!navigator.geolocation) {
    alert("Geolocation is not supported by your browser.");
    return;
  }

  // Request position
  navigator.geolocation.getCurrentPosition(

    // SUCCESS
    (pos) => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);

      // Put coordinates into the input
      document.getElementById("coordinate").value = `${lat}, ${lng}`;

      alert("Location captured successfully!");
    },

    // ERROR
    (err) => {
      alert("Unable to retrieve GPS location. Please allow location access.");
      console.error("GPS Error:", err);
    },

    // Options
    {
      enableHighAccuracy: true,
      timeout: 8000,
      maximumAge: 0
    }
  );
});
   document.getElementById("getLocationBtn").addEventListener("click", () => {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude.toFixed(6);
                const lng = position.coords.longitude.toFixed(6);
                document.getElementById("coordinate").value = `${lat}, ${lng}`;
            },
            () => alert("Unable to retrieve location")
        );
    } else {
        alert("Geolocation not supported.");
    }
});

document.getElementById("pickOnMapBtn").addEventListener("click", () => {
    alert("üìç Here you will open the map picker modal or page!");
    // later: show a modal with your map
});
</script>
</body>
</html>


























