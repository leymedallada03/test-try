<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<!-- CACHE PREVENTION HEADERS -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Data Entry ‚Äî Purok Kaligtasan</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
   :root{
    --bg:#f6f8f7;
    --card-bg:#fff;
    --muted:#6b6f6b;
    --accent1:#0f7a4a;
    --accent2:#34b78f;
    --accent3: #ff7a00;
    --accent4: #ffa500;
    --hazard-red: #dc2626;
    --hazard-orange: #ef4444;
    --light-green: #e9f7f2;
    --border: #e1e8e5;
    --shadow: 0 6px 18px rgba(6,30,20,0.06);
    --shadow-dark: 0 6px 20px rgba(5,40,25,0.12);
    --radius:12px;
    --radius-sm:8px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
   }
   .admin-only {
    display: none !important;
}

/* Class to show admin elements - applied by JavaScript */
.admin-only.admin-visible {
    display: block !important;
}

/* For list items */
li.admin-only {
    display: none !important;
}

li.admin-only.admin-visible {
    display: list-item !important;
}
   
   /* EDIT PANEL STYLES FROM RECORDS.HTML */
   .member-panel {
     position: fixed;
     right: 0;
     top: 0;
     height: 100vh;
     width: 520px;
     max-width: 96%;
     background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,250,0.98));
     box-shadow: -18px 0 40px rgba(6,30,20,0.12);
     transform: translateX(110%);
     transition: transform 280ms cubic-bezier(.2,.9,.3,1);
     z-index: 6000;
     padding: 18px;
     overflow-y: auto;
   }
   
   .member-panel.open {
     transform: translateX(0%);
   }
   
   .member-panel .panel-header {
     display: flex;
     align-items: center;
     gap: 10px;
     margin-bottom: 10px;
   }
   
   .member-panel h3 {
     margin: 0;
     font-size: 18px;
     color: var(--accent1);
   }
   
   .member-panel .panel-body {
     margin-top: 8px;
   }
   
   .member-panel .panel-actions {
     display: flex;
     gap: 8px;
     justify-content: flex-end;
     margin-top: 12px;
   }
   
   .panel-overlay {
     position: fixed;
     inset: 0;
     background: rgba(0,0,0,0.32);
     opacity: 0;
     transition: opacity 200ms;
     pointer-events: none;
     z-index: 5900;
   }
   
   .panel-overlay.show {
     opacity: 1;
     pointer-events: auto;
   }
   
   /* FIX 1: Improved radio button alignment - UPDATED to match records.html */
   .form-row {
     margin-bottom: 12px;
   }
   
   .radio-line, .radio-group {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
    padding: 8px 0;
   }
   
   .radio-item {
     display: flex;
     align-items: center;
     gap: 8px;
     font-weight: 600;
     color: var(--accent1);
     cursor: pointer;
   }
   
   .radio-item input[type="radio"] {
     accent-color: var(--accent1);
     width: 18px;
     margin: 0;
     transform: scale(1.1);
   }
   
   .btn.secondary {
     background: transparent;
     color: #0f7a4a;
     border: 1px solid rgba(6,30,20,0.06);
   }
   
   /* Card styling for edit form */
   .edit-card {
     padding: 16px;
     border-radius: var(--radius);
     background: white;
     margin-bottom: 16px;
     box-shadow: 0 4px 12px rgba(6,30,20,0.08);
     border: 1px solid var(--border);
   }
   
   /* FIX 4: Consistent form section headers */
   .form-section {
     background: var(--light-green);
     padding: 10px 14px;
     border-radius: var(--radius-sm);
     margin: 20px 0 16px 0;
     border-left: 4px solid var(--accent1);
   }
   
   .form-section h5 {
     margin: 0;
     color: var(--accent1);
     font-size: 15px;
     font-weight: 700;
   }
   
   .form-grid {
     display: grid;
     grid-template-columns: repeat(2,1fr);
     gap: 16px;
   }
   
   .small-muted {
     font-size:0.75rem; 
     color:var(--muted);
     margin-bottom: 10px;
   }
   
   .green {
     color: #0f7a4a;
     font-weight: 700;
   }
   
   /* Form controls */
   .member-panel input,
   .member-panel select,
   .member-panel textarea {
     width: 100%;
     padding: 10px 12px;
     border: 2px solid var(--border);
     border-radius: var(--radius-sm);
     font-size: 14px;
     font-family: inherit;
     box-sizing: border-box;
     margin-top: 6px;
   }
   
   .member-panel input:focus,
   .member-panel select:focus,
   .member-panel textarea:focus {
     outline: none;
     border-color: var(--accent1);
     box-shadow: 0 0 0 3px rgba(15,122,74,0.1);
   }
   
   .member-panel label {
     font-weight: 600;
     font-size: 14px;
     color: var(--accent1);
     display: block;
     margin-bottom: 6px;
   }
   
   /* FIX 2: Larger checkboxes like dataForm.html - UPDATED */
   .checkbox-item {
     display: flex;
     align-items: center;
     gap: 10px;
     font-weight: 600;
     color: var(--accent1);
     cursor: pointer;
     margin: 6px 0;
     padding: 4px 0;
   }
   
   .checkbox-item input[type="checkbox"] {
     accent-color: var(--accent1);
     width: 20px;
     height: 20px;
     margin: 0;
     cursor: pointer;
     transform: scale(1.1);
   }
   
   .checkbox-item1 {
     display: flex;
     align-items: center;
     gap: 8px;
     margin-top: 4px;
   }
   
   .checkbox-item1 input[type="checkbox"] {
     accent-color: var(--accent1);
     width: 20px;
     cursor: pointer;
     transform: scale(1.1);
     margin: 0;
   }
   
   .checkbox-item1 label {
     margin: 0;
     line-height: 1;
     font-weight: 600;
     color: #0a7a43;
   }
   
   /* Conditional fields */
   .conditional-field {
     display: none;
     margin-top: 8px;
     animation: fadeIn 0.3s ease;
   }
   
   .conditional-field.show {
     display: block;
   }
   
   @keyframes fadeIn {
     from { opacity: 0; transform: translateY(-5px); }
     to { opacity: 1; transform: translateY(0); }
   }
   
   /* Animal grid */
   .domestic-grid {
     display: grid;
     grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
     gap: 12px;
     margin-top: 12px;
   }
   
   .animal-card {
     background: var(--light-green);
     padding: 12px;
     border-radius: var(--radius-sm);
     border: 2px solid var(--border);
     transition: all 0.3s ease;
   }
   
   .animal-card:hover {
     border-color: var(--accent1);
     transform: translateY(-2px);
     box-shadow: 0 4px 12px rgba(15,122,74,0.1);
   }
   
   .animal-header {
     display: flex;
     align-items: center;
     gap: 12px;
     margin-bottom: 8px;
   }
   
   .animal-qty {
     display: flex;
     align-items: center;
     gap: 8px;
   }
   
   .animal-qty label {
     margin: 0;
     font-weight: 600;
     color: var(--muted);
     font-size: 14px;
   }
   
   .qty {
     width: 70px;
     padding: 8px;
     border-radius: var(--radius-sm);
     border: 2px solid var(--border);
     text-align: center;
     font-size: 14px;
   }
   
   .others-box {
     width: 100%;
     min-height: 80px;
     padding: 12px;
     border-radius: var(--radius-sm);
     border: 2px solid var(--border);
     font-family: inherit;
     font-size: 14px;
     margin-top: 8px;
     resize: vertical;
   }
   
   /* Government support grid */
   .gov-support-grid {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
     gap: 10px 16px;
     margin-top: 0px;
   }
   
   .gov-support-grid .checkbox-item {
     display: flex;
     align-items: center;
     gap: 10px;
     min-height: 40px;
     -webkit-tap-highlight-color: transparent;
   }
   
   /* Error messages */
   .error-message {
     color: #dc2626;
     font-size: 12px;
     margin-top: 4px;
     display: none;
   }
   
   .input-error {
     border-color: #dc2626 !important;
   }
   
   /* Required field indicator */
   .required {
     color: #dc2626;
     margin-left: 2px;
   }
   
   /* Panel improvements */
   .panel-body {
     padding-right: 8px;
   }
   
   /* Data ID display */
   .data-id-display {
     background: #f0f9ff;
     padding: 10px 14px;
     border-radius: 8px;
     border: 1px solid #d1e9ff;
     margin-bottom: 16px;
     font-weight: bold;
     color: #0f7a4a;
   }
   
   .data-id-display span {
     background: #e3f2fd;
     padding: 4px 8px;
     border-radius: 4px;
   }
   
   /* Head name with checkbox container - FIXED */
   .head-name-container {
     display: flex;
     align-items: flex-start;
     gap: 0;
     flex-wrap: wrap;
     margin-bottom: 0;
   }
   
   .head-name-container input[type="text"] {
     flex: 1;
     min-width: 200px;
     margin-bottom: 0;
   }
   
   /* FIXED: Remove space between Household Head Full Name and FishR/RBIS Registered button */
   .head-registration-container {
     display: flex;
     align-items: center;
     gap: 16px;
     padding: 0;
     background: transparent;
     border-radius: 0;
     border-left: none;
   }
   
   .head-registration-container .checkbox-item {
     margin: 0;
   }
   
   /* FIXED: Better alignment for conditional field in Educational & Economic Status */
   .form-grid .conditional-field {
     grid-column: 1 / -1;
     margin-top: 8px;
     margin-bottom: 0;
   }
   
   /* FIXED: Ensure proper spacing in form grids */
   .form-grid > div:not(:last-child) {
     margin-bottom: 0;
   }
   
   /* FIX 5: Center align text in all buttons */
   .btn {
     text-align: center;
     justify-content: center;
   }
   
   /* Specific alignment for action buttons */
   .panel-actions .btn,
   #memberPanel .panel-actions .btn {
     display: flex;
     align-items: center;
     justify-content: center;
     text-align: center;
   }
   
   /* For Back, Save & Next buttons specifically - FIX 5 */
   #memberBack, #memberNext {
     text-align: center !important;
     display: flex !important;
     align-items: center !important;
     justify-content: center !important;
   }
   
   /* Ensure member panel action buttons are visible */
   #memberPanel .panel-actions {
     display: flex !important;
     gap: 8px;
     justify-content: flex-end;
     margin-top: 20px;
     padding: 16px 0;
     border-top: 1px solid var(--border);
   }
   
   /* ORIGINAL DATAFORM STYLES CONTINUE BELOW */
   /* Background decorative elements */
   .bg-pattern {
     position: absolute;
     width: 100%;
     height: 100%;
     overflow: hidden;
     z-index: -1;
   }
   
   .bg-circle {
     position: absolute;
     border-radius: 50%;
     background: rgba(15, 122, 74, 0.05);
   }
   
   .circle-1 {
     width: 300px;
     height: 300px;
     top: -150px;
     right: -150px;
   }
   
   .circle-2 {
     width: 200px;
     height: 200px;
     bottom: -100px;
     left: -100px;
     background: rgba(255, 122, 0, 0.05);
   }
   
   .circle-3 {
     width: 150px;
     height: 150px;
     top: 50%;
     left: 10%;
     background: rgba(52, 183, 143, 0.05);
   }
   
   /* ============ ENHANCE: Better cross-platform compatibility ============ */
   body {
    background-color: var(--bg);
    margin: 0;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
   }
   
   .page-container{
    max-width:1200px;
    margin:20px auto;
    padding:12px;
    display:grid;
    grid-template-columns:260px 1fr;
    gap:18px;
    align-items:start;
    transition: grid-template-columns 0.3s ease;
   }
   
   .page-container.collapsed {
    grid-template-columns: 60px 1fr;
   }
   
   /* Topbar - Enhanced */
   .topbar{
    grid-column:1/-1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
    border-radius:var(--radius);
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    box-shadow:var(--shadow-dark);
   }
   
   .brand{
    display:flex;
    gap:12px;
    align-items:center;
   }
   
   .brand .logo{
    width:60px;
    height:60px;
    border-radius:var(--radius-sm);
    object-fit:contain;
   }
   
   .brand-text h1 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
   }
   
   .brand-text p {
    font-size:12px;
    opacity:0.95;
    margin: 4px 0 0 0;
   }
   
   .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
   }
   
   #userName {
    font-weight: 600;
    border-radius: 20px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
   }
   
   #logoutBtn {
    background: rgba(255,255,255,0.15);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
   }
   
   #logoutBtn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
   }
   
   /* Sidebar - Collapsible with Icon Size Change */
   .sidebar{
    background:linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.20));
    border-radius:var(--radius);
    padding:12px;
    height:calc(100vh - 120px);
    position:sticky;
    top:72px;
    overflow:auto;
    transition: width 0.3s ease;
   }
   
   .sidebar-container {
    display: flex;
    flex-direction: column;
    height: 100%;
   }
   
   .sidebar-toggle {
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
   }
   
   .sidebar-toggle:hover {
    transform: scale(1.1);
   }
   
   .sidebar ul{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
    flex: 1;
   }
   
   .sidebar li a{
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    text-decoration: none;
    color: var(--muted);
    border-radius: var(--radius-sm);
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
   }
   
   .sidebar li a:hover{
    background: var(--light-green);
    color: var(--accent1);
   }
   
   .sidebar li a.active{
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }
   
   .sidebar li a .menu-icon {
    font-size: 1.2rem;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
    transition: all 0.3s ease;
   }
   
   /* When sidebar is collapsed, make icons normal size (FIXED) */
   .page-container.collapsed .sidebar li a .menu-icon {
    font-size: 1.2rem !important;
    transform: scale(1) !important;
   }
   
   /* For active tab in collapsed state - icon remains white */
   .page-container.collapsed .sidebar li a.active .menu-icon {
    color: white;
   }
   
   /* For inactive tabs in collapsed state - return to original color (no green) */
   .page-container.collapsed .sidebar li a:not(.active) .menu-icon {
    color: var(--muted);
   }
   
   .sidebar li a .menu-text {
    transition: opacity 0.3s ease;
   }
   
   .page-container.collapsed .sidebar li a .menu-text {
    opacity: 0;
    width: 0;
    overflow: hidden;
   }
   
   /* Content Area - Fixed Size with No Overflow */
   .content-area{
    background:linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
    border-radius:var(--radius);
    padding:18px;
    box-shadow:0 8px 22px rgba(10,20,16,0.06);
    min-height:72vh;
    height: calc(100vh - 120px);
    overflow-y: auto;
    max-width: 100%;
    box-sizing: border-box;
   }
   
   /* Content Header - Fixed */
   .content-header {
    margin-top: 0;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
   }
   
   .content-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: var(--accent1);
    display: flex;
    align-items: center;
    gap: 8px;
   }
   
   #disc {
    margin-bottom: 10px;
    background: var(--light-green);
    padding: 12px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--accent1);
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.5;
   }
   
   /* Card Styling */
   .card{ 
     padding:16px;
     border-radius:var(--radius);
     background:var(--card-bg);
     margin-bottom:12px;
     box-shadow:var(--shadow);
     border: 1px solid rgba(255,255,255,0.8);
     overflow: hidden;
   }
   
   .form-grid{ 
     display:grid; 
     grid-template-columns:repeat(2,1fr); 
     gap:12px; 
     align-items:start;
   }
   
   /* Label Styling */
   label{
     display:block;
     font-weight:700;
     margin-bottom:6px;
     color:var(--accent1);
     font-size: 0.9rem;
   }
   
   /* Input Fields - Fixed to prevent bumping */
   input[type="text"], input[type="date"], input[type="number"], select, textarea{
     width:100%;
     padding:10px;
     border-radius:var(--radius-sm);
     border:2px solid var(--border);
     font-size:0.9rem;
     transition: all 0.3s ease;
     background:#fff;
     box-sizing: border-box;
     min-width: 0;
     -webkit-appearance: none;
     -moz-appearance: none;
     appearance: none;
   }
   
   /* Fix for iOS date input */
   input[type="date"] {
     min-height: 44px;
   }
   
   /* Fix for input elements to prevent bumping */
   .page-container.collapsed .content-area input[type="text"],
   .page-container.collapsed .content-area input[type="date"],
   .page-container.collapsed .content-area input[type="number"],
   .page-container.collapsed .content-area select,
   .page-container.collapsed .content-area textarea {
     width: 100%;
     max-width: 100%;
   }
   
   input[type="date"]::-webkit-calendar-picker-indicator{
     filter:invert(20%) sepia(50%) saturate(600%) hue-rotate(120deg) brightness(90%);
   }
   
   input:focus, select:focus, textarea:focus{
     outline:none;
     border-color:var(--accent1);
     box-shadow:0 0 0 3px rgba(15,122,74,0.1);
   }
   
   .small-muted{ 
     font-size:0.75rem; 
     color:var(--muted);
     margin-top: 4px;
   }
   
   /* Radio / Checkbox Alignment - FIXED */
   .radio-line, .checkbox-grid { 
     display:flex; 
     gap:16px; 
     align-items:center; 
     flex-wrap:wrap;
     padding: 8px 0;
   }
   
   /* Member preview */
   .member-preview{ 
     margin-top:8px; 
     font-size:0.9rem;
     background: var(--light-green);
     padding: 12px;
     border-radius: var(--radius-sm);
     max-height: 200px;
     overflow-y: auto;
   }
   
   .member-preview li{ 
     margin-bottom:6px;
     padding: 4px 0;
     border-bottom: 1px solid rgba(15,122,74,0.1);
   }
   
   /* Section Styling */
   .section-title{
     display:flex;
     align-items:center;
     gap:12px; 
     margin-bottom: 15px;
   }
   
   .section-title1{
     display:flex;
     align-items:center;
     gap:12px; 
     color: var(--accent1);
   }
   
   .section-title h3 {
    margin: 0;
    color: var(--accent1);
    flex: 1;
   }
   
   .chip{
     padding:3px 8px;
     border-radius:20px;
     background:linear-gradient(90deg, var(--accent1), var(--accent2));
     color:#fff;
     font-size:0.9rem;
     font-weight:700;
     text-align: center;
     flex-shrink: 0;
   }
   
   .chip1{
    margin-top: 20px;
     padding:3px 8px;
     border-radius:20px;
     background:linear-gradient(90deg, var(--accent1), var(--accent2));
     color:#fff;
     font-size:0.9rem;
     font-weight:700;
     text-align: center;
     flex-shrink: 0;
   }
   
   /* Instruction label - Fixed alignment */
   .instruction-label {
     color: var(--muted);
     display: block;
    margin: 0 0 4px 37px;
     font-size: 0.85rem;
     line-height: 1.4;
   }
   
   /* ============ FIXED: Government Support Grid - Proper responsive behavior ============ */
   .gov-support-grid {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
     gap: 12px 20px;
    margin-top: 0px;
   }
   
   /* When sidebar is collapsed, the grid should adapt properly */
   .page-container.collapsed .content-area .gov-support-grid {
     grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
   }
   
   /* Ensure all checkboxes and labels are perfectly aligned */
   .gov-support-grid .checkbox-item input[type="checkbox"] {
     margin: 0;
     flex-shrink: 0;
     width: 18px;
     height: 18px;
     min-width: 18px;
   }
   
   .gov-support-grid .checkbox-item label {
     margin: 0;
     font-weight: 600;
     color: var(--accent1);
     cursor: pointer;
     flex: 1;
     display: flex;
     align-items: center;
     word-break: break-word;
     hyphens: auto;
   }
   
   /* Domestic Animals Grid - REDESIGNED */
   .domestic-grid-container {
     margin-top: 12px;
   }
   
   .domestic-grid{ 
     display:grid; 
     grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
     gap:12px;
     align-items:center;
   }
   
   .animal-card {
     background: var(--light-green);
     padding: 16px;
     border-radius: var(--radius-sm);
     border: 2px solid var(--border);
     transition: all 0.3s ease;
     display: flex;
     flex-direction: column;
     gap: 12px;
   }
   
   .animal-card:hover {
     border-color: var(--accent1);
     transform: translateY(-2px);
     box-shadow: 0 4px 12px rgba(15,122,74,0.1);
   }
   
   .animal-header {
     display: flex;
     align-items: center;
     gap: 12px;
     margin-bottom: 8px;
   }
   
   .animal-header label {
     margin: 0;
     font-size: 0.95rem;
     display: flex;
     align-items: center;
     gap: 8px;
   }
   
   .animal-qty label {
     margin: 0;
     font-weight: 600;
     color: var(--muted);
     font-size: 0.9rem;
   }
   
   .others-box{
     width:100%;
     min-height:80px;
     padding:12px;
     border-radius:var(--radius-sm);
     border:2px solid var(--border);
     font-family: inherit;
     font-size: 0.9rem;
     margin-top: 8px;
     resize: vertical;
   }
   
   /* Buttons - Made Smaller */
   .btn { 
     border:0;
     padding: 8px 14px;
     border-radius:var(--radius-sm);
     cursor:pointer;
     font-weight:600;
     background: linear-gradient(90deg, var(--accent1), var(--accent2));
     color:#fff;
     font-size: 0.85rem;
     display: inline-flex;
     align-items: center;
     gap: 8px;
     transition: all 0.2s ease;
     white-space: nowrap;
     min-height: 36px;
     -webkit-tap-highlight-color: transparent;
     touch-action: manipulation;
   }
   
   .btn:hover {
     transform: translateY(-2px);
     box-shadow: 0 4px 12px rgba(15,122,74,0.2);
   }
   
   /* Secondary button - Made Smaller */
   .btn.secondary { 
     background: transparent; 
     color: var(--accent1); 
     border:2px solid var(--border);
     padding: 6px 12px;
   }
   
   .btn.secondary:hover {
     background: var(--light-green);
     border-color: var(--accent1);
   }
   
   /* Hazard Hunter Button Styling */
   .btn.hazard-hunter {
     background: linear-gradient(90deg, var(--hazard-red), var(--hazard-orange)) !important;
     color: white !important;
     border: none !important;
   }
   
   .btn.hazard-hunter:hover {
     background: linear-gradient(90deg, #b91c1c, var(--hazard-red)) !important;
     box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2) !important;
   }
   
   /* Reset Button - Same as Export Button in records.html */
   .btn-reset { 
     background: linear-gradient(90deg, var(--accent3), var(--accent4)) !important;
     color:#fff !important;
     border: none !important;
   }
   
   .btn-reset:hover {
     box-shadow: 0 4px 12px rgba(255,122,0,0.2) !important;
   }
   
   /* Back Button - Same as Export Button */
   .btn-back {
     background: linear-gradient(90deg, var(--accent3), var(--accent4)) !important;
     color:#fff !important;
     border: none !important;
   }
   
   .btn-back:hover {
     box-shadow: 0 4px 12px rgba(255,122,0,0.2) !important;
   }
   
   /* Actions Row */
   .actions-row{
     display:flex;
     gap: 10px;
     justify-content:flex-end;
     margin-top: 14px;
   }
   
   /* Coordinate container */
   .coordinate-container {
     display: flex;
     gap: 8px;
     align-items: flex-start;
     flex-wrap: wrap;
   }
   
   .coordinate-container .btn {
     white-space: nowrap;
   }
   
   /* Loading overlay */
   .loading-overlay {
     display: none;
     position: fixed;
     inset: 0;
     background: rgba(255,255,255,0.9);
     align-items: center;
     justify-content: center;
     z-index: 9999;
     backdrop-filter: blur(2px);
   }
   
   .loading-spinner {
     width: 40px;
     height: 40px;
     border: 3px solid var(--border);
     border-top-color: var(--accent1);
     border-radius: 50%;
     animation: spin 1s linear infinite;
   }
   
   @keyframes spin {
     to { transform: rotate(360deg); }
   }
   
   /* Error message styling */
   .error-message {
     color: #dc2626;
     font-size: 0.85rem;
     margin-top: 4px;
     display: none;
   }
   
   .input-error {
     border-color: #dc2626 !important;
   }
   
   .input-error:focus {
     box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1) !important;
   }
   
   /* ============ NEW EDUCATIONAL/ECONOMIC SECTION STYLING ============ */
   
   /* Head name with checkbox container - FIXED */
   .head-name-container {
     display: flex;
     align-items: flex-start;
     gap: 0;
     flex-wrap: wrap;
     margin-bottom: 0;
   }
   
   .head-name-container input[type="text"] {
     flex: 1;
     min-width: 200px;
     margin-bottom: 0;
   }
   
   /* FIXED: Remove space between Household Head Full Name and FishR/RBIS Registered button */
   .head-registration-container {
     display: flex;
     align-items: center;
     gap: 16px;
     padding: 0;
     background: transparent;
     border-radius: 0;
     border-left: none;
   }
   
   .head-registration-container .checkbox-item {
     margin: 0;
   }
   
   /* FIXED: Better alignment for conditional field in Educational & Economic Status */
   .form-grid > div {
     margin-bottom: 0;
   }
   
   .form-grid .conditional-field {
     grid-column: 1 / -1;
     margin-top: 8px;
     margin-bottom: 0;
   }
   
   /* FIXED: Ensure proper spacing in form grids */
   .form-grid > div:not(:last-child) {
     margin-bottom: 0;
   }
   
   /* ============ SMALLER MODAL STYLING ============ */
   .modal {
     display: none;
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background: rgba(0,0,0,0.7);
     z-index: 9999;
     align-items: center;
     justify-content: center;
   }
   
   .modal-content {
     background: white;
     padding: 20px;
     border-radius: var(--radius);
     max-width: 420px; /* Reduced from 500px */
     width: 85%; /* Reduced from 90% */
     max-height: 70vh; /* Reduced from 80vh */
     overflow-y: auto;
     box-shadow: 0 10px 30px rgba(0,0,0,0.2);
     margin: 20px;
   }
   
   .modal-actions {
     display: flex;
     gap: 10px;
     justify-content: flex-end;
     margin-top: 16px;
   }
   
   /* Success Modal - Smaller */
   .modal-success {
     border-top: 4px solid var(--accent1);
   }
   
   .modal-success .modal-header {
     color: var(--accent1);
     margin-top: 0;
     font-size: 1.2rem; /* Smaller font */
     margin-bottom: 10px;
   }
   
   .modal-success .modal-icon {
     color: var(--accent1);
     font-size: 2rem; /* Reduced from 2.5rem */
     text-align: center;
     margin: 8px 0; /* Reduced margin */
   }
   
   /* Warning Modal - Smaller */
   .modal-warning {
     border-top: 4px solid var(--accent3);
   }
   
   .modal-warning .modal-header {
     color: var(--accent3);
     margin-top: 0;
     font-size: 1.2rem; /* Smaller font */
     margin-bottom: 10px;
   }
   
   .modal-warning .modal-icon {
     color: var(--accent3);
     font-size: 2rem; /* Reduced from 2.5rem */
     text-align: center;
     margin: 8px 0; /* Reduced margin */
   }
   
   /* Error Modal - Smaller */
   .modal-error {
     border-top: 4px solid var(--hazard-red);
   }
   
   .modal-error .modal-header {
     color: var(--hazard-red);
     margin-top: 0;
     font-size: 1.2rem; /* Smaller font */
     margin-bottom: 10px;
   }
   
   .modal-error .modal-icon {
     color: var(--hazard-red);
     font-size: 2rem; /* Reduced from 2.5rem */
     text-align: center;
     margin: 8px 0; /* Reduced margin */
   }
   
   /* Info Modal - Smaller */
   .modal-info {
     border-top: 4px solid var(--accent2);
   }
   
   .modal-info .modal-header {
     color: var(--accent2);
     margin-top: 0;
     font-size: 1.2rem; /* Smaller font */
     margin-bottom: 10px;
   }
   
   .modal-info .modal-icon {
     color: var(--accent2);
     font-size: 2rem; /* Reduced from 2.5rem */
     text-align: center;
     margin: 8px 0; /* Reduced margin */
   }
   
   /* Modal text styling */
   .modal-content p {
     margin: 0 0 12px 0;
     line-height: 1.5;
     font-size: 0.95rem; /* Smaller text */
   }
   
   /* Smaller buttons in modals */
   .modal-actions .btn {
     padding: 7px 12px; /* Smaller padding */
     font-size: 0.8rem; /* Smaller font */
     min-height: 32px; /* Smaller height */
   }
   
   /* ============ FIELD-LEVEL VALIDATION STYLES ============ */
   /* Make these more specific than the general input styles */
input[type="text"].validation-error,
input[type="date"].validation-error,
input[type="number"].validation-error,
select.validation-error,
textarea.validation-error {
    border: 0.5px solid rgba(220, 38, 38, 0.3) !important;
    background-color: rgba(220, 38, 38, 0.05) !important;
}

/* Override focus states for validation errors */
input[type="text"].validation-error:focus,
input[type="date"].validation-error:focus,
input[type="number"].validation-error:focus,
select.validation-error:focus,
textarea.validation-error:focus {
    border: 0.5px solid rgba(220, 38, 38, 0.3) !important;
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1) !important;
}
   .validation-error{
     border-color: #dc2626 !important;
     border: 0.5px solid rgba(220, 38, 38, 0.3);
     background-color: rgba(220, 38, 38, 0.05) !important;
   }
   
   .validation-error-label {
     color: #dc2626 !important;
   }
   
   .validation-summary {
     background-color: rgba(220, 38, 38, 0.1);
     border: 0.5px solid rgba(220, 38, 38, 0.3);
     border-radius: var(--radius-sm);
     padding: 12px;
     margin-bottom: 16px;
     display: none;
   }
   
   .validation-summary.show {
     display: block;
     animation: fadeIn 0.3s ease;
   }
   
   .validation-summary h4 {
     margin: 0 0 8px 0;
     color: #dc2626;
     display: flex;
     align-items: center;
     gap: 8px;
     font-size: 0.9rem;
   }
   
   .validation-summary ul {
     margin: 0;
     padding-left: 20px;
   }
   
   .validation-summary li {
     margin-bottom: 4px;
     font-size: 0.8rem;
   }
   
   /* Sex field specific styling - for red border removal */
   .radio-line.validation-error {
     border-radius: var(--radius-sm);
     padding: 6px !important;
   }
   /* Make Sex label red when there's a validation error */
.sex-label.validation-error-label {
  color: #dc2626 !important;
}
   
   /* ============ RESPONSIVE DESIGN ============ */
   /* Tablet-specific improvements */
   @media (min-width: 769px) and (max-width: 1024px) {
     .page-container {
         max-width: 95%;
         padding: 10px;
         gap: 16px;
     }
     
     .form-grid {
         grid-template-columns: repeat(2, 1fr);
         gap: 14px;
     }
     
     .gov-support-grid {
         grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
         gap: 10px 16px;
     }
     
     .domestic-grid {
         grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
     }
     
     .member-panel {
         width: 450px;
     }
   }
   
   /* Mobile Responsive */
   @media (max-width: 768px) {
     .page-container {
         grid-template-columns: 1fr !important;
         padding: 8px;
         gap: 12px;
         max-width: 100%;
     }
     
     .page-container.collapsed {
         grid-template-columns: 1fr !important;
     }
     
     .sidebar {
         position: fixed;
         top: 72px;
         left: 0;
         right: 0;
         height: auto;
         max-height: 0;
         overflow: hidden;
         z-index: 1000;
         margin: 0;
         padding: 0;
         border-radius: 0 0 var(--radius) var(--radius);
         background: white;
         box-shadow: var(--shadow);
         transition: max-height 0.3s ease;
     }
     
     .sidebar.mobile-open {
         max-height: 300px;
         padding: 12px;
         overflow-y: auto;
     }
     
     .sidebar-container {
         flex-direction: column;
     }
     
     .sidebar-toggle {
         display: none;
     }
     
     .mobile-menu-toggle {
         display: flex !important;
         background: linear-gradient(135deg, var(--accent1), var(--accent2));
         color: white;
         border: none;
         border-radius: var(--radius-sm);
         width: 36px;
         height: 36px;
         align-items: center;
         justify-content: center;
         cursor: pointer;
         font-size: 1rem;
         -webkit-tap-highlight-color: transparent;
         touch-action: manipulation;
     }
     
     .content-area {
         height: auto;
         min-height: calc(100vh - 140px);
         padding: 16px;
     }
     
     .form-grid {
         grid-template-columns: 1fr !important;
         gap: 16px;
     }
     
     .gov-support-grid {
         grid-template-columns: repeat(2, 1fr) !important;
         gap: 10px 14px !important;
     }
     
     .domestic-grid {
         grid-template-columns: 1fr !important;
     }
     
     .member-panel .form-grid {
         grid-template-columns: 1fr !important;
     }
     
     .user-info {
         gap: 8px;
     }
     
     #userName {
         font-size: 0.9rem;
         padding: 6px 12px;
     }
     
     #logoutBtn {
         padding: 6px 12px;
         font-size: 0.85rem;
     }
     
     .member-panel {
         width: 100%;
         max-width: 100%;
         padding: 16px;
     }
     
     .chip {
         min-width: 28px;
         padding: 4px 8px;
     }
     
     .instruction-label {
         margin-left: 0;
         margin-top: 8px;
     }
     
     .section-title {
         flex-wrap: wrap;
     }
     
     /* Coordinate container on mobile */
     .coordinate-container {
         flex-direction: column;
         align-items: stretch;
     }
     
     .coordinate-container .btn {
         width: 100%;
         justify-content: center;
     }
     
     /* Mobile: Make panel buttons full width */
     .panel-actions {
         flex-direction: column;
         gap: 12px;
     }
     
     .panel-actions .btn {
         width: 100%;
         justify-content: center;
     }
     
     /* Make buttons even smaller on mobile */
     .btn {
         padding: 8px 12px;
         font-size: 0.82rem;
     }
     
     .panel-actions .btn {
         padding: 10px 14px;
         font-size: 0.85rem;
     }
     
     /* Adjust government support grid on mobile */
     .gov-support-grid .checkbox-item {
         min-height: 38px;
         padding: 8px 0;
     }
     
     .gov-support-grid .checkbox-item label {
         font-size: 0.82rem;
     }
     
     /* Better touch targets for mobile */
     input[type="text"], input[type="date"], input[type="number"], select, textarea {
         padding: 12px;
         font-size: 1rem;
     }
     
     /* Ensure date input is tap-friendly on mobile */
     input[type="date"] {
         min-height: 48px;
     }
     
     /* Mobile adjustments for new sections */
     .head-name-container {
         flex-direction: column;
         align-items: stretch;
         gap: 12px;
     }
     
     .head-registration-container {
         flex-direction: column;
         gap: 12px;
     }
     
     /* Smaller modals on mobile */
     .modal-content {
         max-width: 95%; /* Increased for mobile */
         width: 95%;
         padding: 16px; /* Less padding on mobile */
         margin: 10px;
     }
     
     .modal-header {
         font-size: 1.1rem !important; /* Even smaller on mobile */
     }
     
     .modal-icon {
         font-size: 1.8rem !important; /* Even smaller on mobile */
     }
     
     .modal-content p {
         font-size: 0.9rem; /* Smaller text on mobile */
     }
   }
   
   /* Small mobile devices */
   @media (max-width: 480px) {
     .gov-support-grid {
         grid-template-columns: 1fr !important;
         gap: 10px !important;
     }
     
     .brand-text h1 {
         font-size: 1rem;
     }
     
     .brand-text p {
         font-size: 0.7rem;
     }
     
     #userName {
         font-size: 0.8rem;
         padding: 4px 8px;
     }
     
     .btn {
         padding: 7px 10px;
         font-size: 0.8rem;
     }
     
     .content-header h2 {
         font-size: 1.2rem;
     }
     
     .card {
         padding: 12px;
     }
     
     /* Even smaller modals on very small screens */
     .modal-content {
         max-width: 98%;
         width: 98%;
         padding: 14px;
         margin: 8px;
     }
     
     .modal-header {
         font-size: 1rem !important;
     }
     
     .modal-icon {
         font-size: 1.6rem !important;
     }
     
     .modal-content p {
         font-size: 0.85rem;
     }
     
     .modal-actions {
         flex-direction: column;
         gap: 8px;
     }
     
     .modal-actions .btn {
         width: 100%;
         justify-content: center;
     }
   }
   
   /* Mobile menu toggle button */
   .mobile-menu-toggle {
     display: none;
   }
   
   /* Select styling */
   select.animated {
     appearance: none;
     padding-right: 36px;
     background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%230f7a4a' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
     background-position: calc(100% - 12px) center;
     background-repeat: no-repeat;
     background-size: 9px;
   }
   
   /* High DPI/Retina display improvements */
   @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
     .logo {
         image-rendering: -webkit-optimize-contrast;
         image-rendering: crisp-edges;
     }
   }
   
   /* Print styles for better printing experience */
   @media print {
     .sidebar, .topbar, .btn, .sidebar-toggle, .mobile-menu-toggle {
         display: none !important;
     }
     
     .page-container {
         grid-template-columns: 1fr !important;
         margin: 0;
         padding: 0;
     }
     
     .content-area {
         box-shadow: none;
         background: white;
         height: auto;
         overflow: visible;
     }
     
     .card {
         box-shadow: none;
         border: 1px solid #ddd;
         break-inside: avoid;
     }
   }
</style>
</head>
<body>
       <!-- Background pattern -->
    <div class="bg-pattern">
        <div class="bg-circle circle-1"></div>
        <div class="bg-circle circle-2"></div>
        <div class="bg-circle circle-3"></div>
    </div>
<div class="page-container">

  <header class="topbar">
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div class="brand-text">
        <h1>PUROK KALIGTASAN</h1>
        <p>DRRMO Alitagtag ‚Äì Household Records System</p>
      </div>
    </div>

    <div class="user-info">
      <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
      </button>
      <span id="userName"></span>
      <button id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-container">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul>
        <li><a href="dashboard.html" title="Dashboard"><span class="menu-icon">üìä</span> <span class="menu-text">Dashboard</span></a></li>
        <li><a href="dataForm.html" class="active" title="Data Entry"><span class="menu-icon">üìù</span> <span class="menu-text">Data Entry</span></a></li>
        <li><a href="records.html" title="Records"><span class="menu-icon">üìÅ</span> <span class="menu-text">Records & Management</span></a></li>
        <li><a href="charts.html" title="Charts"><span class="menu-icon">üìà</span> <span class="menu-text">Charts & Analytics</span></a></li>
        <li class="admin-only"><a href="users.html" title="User Management"><span class="menu-icon">üë•</span> <span class="menu-text">User Management</span></a></li>
      </ul>
    </div>
  </aside>

  <main class="content-area" tabindex="-1">
    <!-- Validation Summary -->
    <div id="validationSummaryHead" class="validation-summary">
      <h4><i class="fas fa-exclamation-triangle"></i> Required Fields ‚Äì The following information must be provided before submission:</h4>
      <ul id="headValidationErrors"></ul>
    </div>

    <div class="content-header">
      <h2><span style="color: var(--accent1);">üìù</span> Household Information (Head)</h2>
    </div>

    <div id="disc">This section captures all key information about the household head, including personal data, contact details, demographic profile, and any government support or programs currently availed. The information will help establish the primary point of contact and provide a clear understanding of the household's overall status.</div>

    <form id="headForm" novalidate onsubmit="return false;">
      <!-- BASIC -->
      <div class="card form-section">
        <div class="section-title"><div class="chip">1</div><h3>Basic Information</h3></div>
        <div class="form-grid">
          <div>
            <label>Coordinates (optional)</label>
            <div class="coordinate-container">
              <input type="text" id="coordinate" placeholder="Latitude, Longitude" />
              <button type="button" id="getLocationBtn" class="btn secondary">
                <i class="fas fa-map-marker-alt"></i> Get My Location
              </button>
              <!-- NEW HAZARD HUNTER BUTTON -->
              <button type="button" id="hazardHunterBtn" class="btn hazard-hunter">
                <i class="fas fa-map-marked-alt"></i> Pick from Hazard Hunter
              </button>
            </div>
            <div class="small-muted">Optional ‚Äî paste `lat, lng` if available, or use the buttons above.</div>
          </div>
          
          <div>
            <label>Barangay <span class="required">*</span></label>
            <select id="barangay" required class="animated">
              <option value="">Select Barangay...</option>
              <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
              <option>Dalipit East</option><option>Dalipit West</option><option>Dominador East</option>
              <option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
              <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option>
              <option>Ping-As</option><option>Poblacion East</option><option>Poblacion West</option>
              <option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
            </select>
          </div>

          <div>
            <label>Sitio / Purok <span class="required">*</span></label>
            <select id="sitio" required class="animated">
              <option value="">Select...</option>
              <option>Purok I</option><option>Purok II</option><option>Purok III</option>
              <option>Purok IV</option><option>Purok V</option><option>Purok VI</option>
              <option>Purok VII</option>
            </select>
          </div>

          <!-- FIXED: Household Head Full Name with proper spacing -->
          <div style="grid-column: 1 / -1;">
            <label>Household Head Full Name<span class="required">*</span></label>
            <div class="head-name-container">
              <input type="text" id="householdHead" required>
            </div>
            
            <!-- FIXED: FishR/RBIS Registered button moved inline -->
            <div class="head-registration-container">
              <div class="checkbox-item1" style="margin-bottom: 0;">
                <input type="checkbox" id="headRegisteredCheckbox">
                <label for="headRegisteredCheckbox">FishR/RBIS Registered</label>
              </div>
            </div>
            
            <div id="headRegistrationField" class="conditional-field">
              <label>FishR Registered/RBIS Registered</label>
              <select id="headRegistration">
                <option value="">Select...</option>
                <option value="FishR Registered">FishR Registered</option>
                <option value="RBIS Registered">RBIS Registered</option>
                <option value="FishR & RBIS Registered">FishR & RBIS Registered</option>
              </select>
            </div>
          </div>

          <div>
            <label>Contact no. <span class="required">*</span></label>
            <input type="text" id="contactNo" placeholder="09XXXXXXXXX" required 
                   pattern="^(09|\+639)\d{9}$" 
                   title="Please enter a valid Philippine mobile number (09XXXXXXXXX or +639XXXXXXXXX)" />
            <div class="error-message animated" id="contactError">Please enter a valid Philippine mobile number (09XXXXXXXXX)</div>
          </div>

          <div>
            <label>Sex <span class="required">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="head_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate <span class="required">*</span></label>
            <input type="date" id="householdBirthdate" required />
          </div>

          <div>
            <label>Age</label>
            <input type="text" id="householdAge" readonly />
          </div>

          <div>
            <label>Age Category</label>
            <input type="text" id="householdStage" readonly />
          </div>

          <div>
            <label>No. of Household Member/s</label>
            <input type="number" id="memberCount" min="0" value="0" >
            <div class="small-muted">Set to 0 if no other members.</div>
          </div>
        </div>
      </div>

      <!-- FIXED: EDUCATIONAL & ECONOMIC STATUS -->
      <div class="card">
        <div class="section-title"><div class="chip">2</div><h3>Educational & Economic Status</h3></div>
        <div class="form-grid">
          <div>
            <label>Educational Attainment</label>
            <select id="educationalAttainment" class="animated">
              <option value="">Select...</option>
              <option value="No Formal Education">No Formal Education</option>
              <option value="Elementary Level">Elementary Level</option>
              <option value="Elementary Graduate">Elementary Graduate</option>
              <option value="High School Level">High School Level</option>
              <option value="High School Graduate">High School Graduate</option>
              <option value="Senior High School Level">Senior High School Level</option>
              <option value="Senior High School Graduate">Senior High School Graduate</option>
              <option value="College Level">College Level</option>
              <option value="College Graduate">College Graduate</option>
            </select>
          </div>

          <div id="collegeCourseField" class="conditional-field">
            <label>College Graduate Course</label>
            <input type="text" id="collegeCourse" placeholder="Enter course name" />
          </div>

          <div>
            <label>Employment</label>
            <select id="employment" class="animated">
              <option value="">Select...</option>
              <option value="Employed">Employed</option>
              <option value="Unemployed">Unemployed</option>
            </select>
          </div>

          <div id="jobTitleField" class="conditional-field">
            <label>Job Title</label>
            <select id="jobTitle" class="animated">
              <option value="">Select...</option>
              <optgroup label="Office & Administrative Jobs">
                <option>Administrative Assistant / Admin Staff</option>
                <option>Office Clerk</option>
                <option>Secretary / Executive Assistant</option>
              </optgroup>
              <optgroup label="Business & Management">
                <option>Project Manager</option>
                <option>Operations Manager</option>
                <option>HR Staff / HR Officer</option>
                <option>Account Manager</option>
              </optgroup>
              <optgroup label="Accounting & Finance">
                <option>Accounting Staff</option>
                <option>Bookkeeper</option>
                <option>Payroll Officer</option>
                <option>Auditor</option>
              </optgroup>
              <optgroup label="IT & Tech">
                <option>IT Support / IT Technician</option>
                <option>Web Developer</option>
                <option>Software Developer / Programmer</option>
                <option>Data Analyst</option>
                <option>System Administrator</option>
              </optgroup>
              <optgroup label="Healthcare">
                <option>Nurse (Staff Nurse / Company Nurse)</option>
                <option>Medical Technologist</option>
                <option>Caregiver</option>
                <option>Pharmacist</option>
              </optgroup>
              <optgroup label="Education">
                <option>Teacher / Instructor</option>
                <option>Tutor</option>
                <option>School Administrator</option>
              </optgroup>
              <optgroup label="Sales & Customer Service">
                <option>Customer Service Representative (CSR)</option>
                <option>Sales Associate</option>
                <option>Cashier</option>
                <option>Store Supervisor</option>
              </optgroup>
              <optgroup label="Skilled Work & Labor">
                <option>Electrician</option>
                <option>Plumber</option>
                <option>Welder</option>
                <option>Construction Worker / Skilled Laborer</option>
              </optgroup>
              <optgroup label="Delivery & Logistics">
                <option>Driver (Company Driver / Delivery Driver)</option>
                <option>Logistics Staff</option>
                <option>Rider / Motorcycle Delivery</option>
              </optgroup>
              <optgroup label="Food & Hospitality">
                <option>Cook / Chef</option>
                <option>Waiter / Service Crew</option>
                <option>Barista</option>
                <option>Housekeeping Staff</option>
              </optgroup>
              <optgroup label="Security & Public Service">
                <option>Security Guard</option>
                <option>Barangay Staff / Barangay Council Employee</option>
                <option>Police Officer</option>
                <option>Fire Officer</option>
              </optgroup>
              <optgroup label="Media, Design & Creative">
                <option>Graphic Designer</option>
                <option>Video Editor</option>
                <option>Content Writer</option>
                <option>Social Media Manager</option>
              </optgroup>
              <option>Others</option>
            </select>
          </div>

          <div>
            <label>Overseas Filipino Worker (OFW)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="ofw_status" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="ofw_status" value="No" checked> No</label>
            </div>
          </div>

          <div id="countryField" class="conditional-field">
            <label>Country</label>
            <select id="country" class="animated">
              <option value="">Select...</option>
              <option>Saudi Arabia</option>
              <option>United Arab Emirates (UAE)</option>
              <option>Qatar</option>
              <option>Kuwait</option>
              <option>Bahrain</option>
              <option>Oman</option>
              <option>Hong Kong</option>
              <option>Singapore</option>
              <option>Japan</option>
              <option>Taiwan</option>
              <option>Malaysia</option>
              <option>Australia</option>
              <option>New Zealand</option>
              <option>Italy</option>
              <option>United Kingdom (UK)</option>
              <option>Germany</option>
              <option>Cyprus</option>
              <option>Canada</option>
              <option>United States (USA)</option>
              <option>Libya</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <!-- HEALTH & STATUS -->
      <div class="card">
        <div class="section-title"><div class="chip">3</div><h3>Health and Status</h3></div>
        <div class="form-grid">
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_pwd" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="head_pwd" value="No"> No</label>
            </div>
          </div>

          <div>
            <label>Status</label>
            <select id="head_status" class="animated">
              <option value="">Select...</option>
              <option>With Sickness</option><option>Pregnant</option><option>Solo Parent</option><option>Lactating</option><option>Severe Illness</option><option>HIV Positive</option><option>LGBTQ Plus</option>
            </select>
          </div>
        </div>
      </div>

      <!-- DOMESTIC ANIMALS - REDESIGNED -->
      <div class="card">
        <div class="section-title1"><div class="chip">4</div><h3 style="margin-bottom: 0; margin-top: 0;">Domestic Livestock</h3></div>
        <div class="instruction-label">Please check (‚úì) all items that apply.</div>

        <div class="domestic-grid-container">
          <div class="domestic-grid">
            <div class="animal-card">
              <div class="animal-header">
                <label class="checkbox-item1"><input type="checkbox" id="dog_chk"> <span style="font-size: 1.2rem;">üêï</span> Dog</label>
              </div>
              <div class="animal-qty">
                <label>Quantity:</label>
                <input type="number" id="dog_qty" class="qty" min="0" placeholder="0" />
              </div>
            </div>

            <div class="animal-card">
              <div class="animal-header">
                <label class="checkbox-item1"><input type="checkbox" id="cat_chk"> <span style="font-size: 1.2rem;">üêà</span> Cat</label>
              </div>
              <div class="animal-qty">
                <label>Quantity:</label>
                <input type="number" id="cat_qty" class="qty" min="0" placeholder="0" />
              </div>
            </div>

            <div class="animal-card">
              <div class="animal-header">
                <label class="checkbox-item1"><input type="checkbox" id="pig_chk"> <span style="font-size: 1.2rem;">üêñ</span> Pig</label>
              </div>
              <div class="animal-qty">
                <label>Quantity:</label>
                <input type="number" id="pig_qty" class="qty" min="0" placeholder="0" />
              </div>
            </div>

            <div class="animal-card">
              <div class="animal-header">
                <label class="checkbox-item1"><input type="checkbox" id="cow_chk"> <span style="font-size: 1.2rem;">üêÑ</span> Cow</label>
              </div>
              <div class="animal-qty">
                <label>Quantity:</label>
                <input type="number" id="cow_qty" class="qty" min="0" placeholder="0" />
              </div>
            </div>

            <div class="animal-card">
              <div class="animal-header">
                <label class="checkbox-item1"><input type="checkbox" id="carabao_chk"> <span style="font-size: 1.2rem;">üêÉ</span> Carabao</label>
              </div>
              <div class="animal-qty">
                <label>Quantity:</label>
                <input type="number" id="carabao_qty" class="qty" min="0" placeholder="0" />
              </div>
            </div>

            <div class="animal-card">
              <div class="animal-header">
                <label class="checkbox-item1"><input type="checkbox" id="chicken_chk"> <span style="font-size: 1.2rem;">üêî</span> Chicken</label>
              </div>
              <div class="animal-qty">
                <label>Quantity:</label>
                <input type="number" id="chicken_qty" class="qty" min="0" placeholder="0" />
              </div>
            </div>
          </div>

          <div style="margin-top: 16px;">
            <label>Others</label>
            <textarea id="animals_others" class="others-box" placeholder="Use this field to describe other animals owned in a brief sentence (e.g., '5 goats and 2 ducks')."></textarea>
          </div>
        </div>
      </div>

      <!-- PICKUP / TRANSPORT / CAMP -->
      <div class="card">
        <div class="section-title"><div class="chip">5</div><h3>Transportation & Evacuation Details</h3></div>
        <div class="form-grid">
          <div>
            <label>Transportation</label>
            <select id="head_transport" class="animated">
              <option value="">Select...</option>
              <option>Has Transportation</option>
              <option>Needs Transportation</option>
            </select>
          </div>
          
          <div>
            <label>Pick-Up Location</label>
            <input type="text" id="pickup" />
          </div>
          
          <div>
            <label>Drop-Off Location</label>
            <input type="text" id="dropoff" />
          </div>
          
          <div>
            <label>Evacuation Camp Name</label>
            <input type="text" id="campName" />
          </div>
          
          <div>
            <label>Camp Capacity</label>
            <input type="number" id="capacity" min="0" />
          </div>
          
          <div>
            <label>Individuals Currently in Camp</label>
            <input type="number" id="insideCamp" min="0" />
          </div>
          
          <div>
            <label>Individuals Outside Camp</label>
            <input type="number" id="outsideCamp" min="0"/>
          </div>

          <div style="grid-column:1/-1">
            <label>Reason for Displacement</label>
            <select id="reasons" class="animated">
              <option value="">Select...</option>
              <option>Taal Volcano (Within 14-15 KM Danger Zone)</option>
              <option>Typhoon</option>
              <option>Flood</option>
              <option>Landslide</option>
              <option>Earthquake</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <!-- GOVERNMENT SUPPORT - FIXED ALIGNMENT -->
      <div class="card">
        <div class="section-title1"><div class="chip">6</div><h3 style="margin-bottom: 0; margin-top: 0">Government Assistance Programs</h3></div>
        <div class="instruction-label">Please check (‚úì) all items that apply.</div>

        <div class="gov-support-grid">
          <div class="checkbox-item">
            <input type="checkbox" id="ass_tupad">
            <label for="ass_tupad">TUPAD</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ass_local4ps">
            <label for="ass_local4ps">Local 4Ps</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ass_intl4ps">
            <label for="ass_intl4ps">National 4Ps</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ass_locsp">
            <label for="ass_locsp">Local Social Pension</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ass_intlsp">
            <label for="ass_intlsp">National Social Pension</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ass_solo">
            <label for="ass_solo">Solo Parent Assistance</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ass_relief">
            <label for="ass_relief">Relief Goods</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="ass_cash">
            <label for="ass_cash">Cash Subsidy</label>
          </div>
        </div>

        <div style="grid-column:1/-1;margin-top:16px">
          <label>AICS (if any)</label>
          <select id="ass_aics" class="animated">
            <option value="">None</option>
            <option>Shelter Assistance</option>
            <option>Burial</option>
            <option>Scholarship</option>
          </select>
        </div>
      </div>

      <!-- MEMBERS PREVIEW + ACTION -->
      <div class="card">
        <div class="section-title"><div class="chip">7</div><h3>Members to be collected</h3></div>
        <div class="small-muted">Member/s: <strong id="previewCount">0</strong></div>
        <ul id="membersPreview" class="member-preview"></ul>

        <div class="actions-row">
          <button id="resetBtn" class="btn btn-reset" type="button">
            <i class="fas fa-redo"></i> Reset Form
          </button>
          <button id="nextToMembers" class="btn" type="button">
            <i class="fas fa-save"></i> Save & Continue to Members
          </button>
        </div>
      </div>
    </form>
  </main>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
</div>

<!-- Hazard Hunter Modal - Made smaller -->
<div id="hazardHunterModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-info">
    <h3 class="modal-header">Pick Coordinates from Hazard Hunter</h3>
    <div style="background: var(--light-green); padding: 14px; border-radius: var(--radius-sm); margin: 12px 0;">
      <h4 style="color: var(--hazard-red); margin-top: 0; display: flex; align-items: center; gap: 8px; font-size: 0.95rem;">
        <i class="fas fa-map-marked-alt"></i> Instructions:
      </h4>
      <ol style="margin: 10px 0 0 18px; line-height: 1.5; font-size: 0.9rem; padding-left: 0;">
        <li>Click the button below to open Hazard Hunter in a new tab</li>
        <li>Navigate to the desired location on the map</li>
        <li>Click on the map to get coordinates</li>
        <li>Copy the coordinates (latitude, longitude)</li>
        <li>Return to this tab and paste them in the coordinate field</li>
      </ol>
      <div style="margin-top: 12px; padding: 10px; background: white; border-radius: var(--radius-sm); border-left: 3px solid var(--accent1); font-size: 0.85rem;">
        <strong>üìã Expected format:</strong> <code>14.123456, 121.123456</code>
      </div>
    </div>
    <div class="modal-actions">
      <button id="cancelHazardHunter" class="btn secondary">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button id="confirmHazardHunter" class="btn hazard-hunter">
        <i class="fas fa-external-link-alt"></i> Open Hazard Hunter
      </button>
    </div>
  </div>
</div>

<!-- Overlay + Member Panel -->
<div id="panelOverlay" class="panel-overlay" aria-hidden="true"></div>

<!-- MEMBER SEQUENTIAL PANEL - UPDATED DESIGN FROM RECORDS.HTML -->
<div id="memberPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Member entry panel">
  <div class="panel-header">
    <button id="panelClose" class="btn secondary" title="Close panel">‚Üê</button>
    <h3 id="panelTitle">Member 1 of N</h3>
  </div>

  <div class="panel-body">
    <!-- Validation Summary for Member Form -->
    <div id="validationSummaryMember" class="validation-summary">
      <h4><i class="fas fa-exclamation-triangle"></i> Required Fields ‚Äì The following information must be provided before submission:</h4>
      <ul id="memberValidationErrors"></ul>
    </div>
    
    <form id="memberForm" onsubmit="return false;">
      
      <!-- Card 1: Basic Information -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Basic Information</h5>
        </div>
        <div class="form-grid">
          <div style="grid-column: 1 / -1;">
            <label>Household Member Full Name<span class="required">*</span></label>
            <input type="text" id="memberName" class="member-name" required />
          </div>

          <div style="grid-column: 1 / -1;">
            <div class="checkbox-item1" style="margin-top: 0px;">
              <input type="checkbox" id="memberRegisteredCheckbox">
              <label for="memberRegisteredCheckbox">FishR/RBIS Registered</label>
            </div>
            
            <div id="memberRegistrationField" class="conditional-field">
              <label>FishR Registered/RBIS Registered</label>
              <select id="memberRegistration" class="animated">
                <option value="">Select...</option>
                <option value="FishR Registered">FishR Registered</option>
                <option value="RBIS Registered">RBIS Registered</option>
                <option value="FishR & RBIS Registered">FishR & RBIS Registered</option>
              </select>
            </div>
          </div>

          <div>
            <label>Contact no. <span class="required">*</span></label>
            <input type="text" id="memberContact" placeholder="09XXXXXXXXX" required
                   pattern="^(09|\+639)\d{9}$" />
            <div class="error-message" id="memberContactError"></div>
          </div>

          <div>
            <label>Sex <span class="required">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="member_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="member_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate <span class="required">*</span></label>
            <input type="date" id="memberBirthdate" class="member-birthdate" required/>
          </div>

          <div>
            <label>Age</label>
            <input type="text" id="memberAge" class="member-age" readonly/>
          </div>

          <div>
            <label>Age Category</label>
            <input type="text" id="memberStage" class="member-stage" readonly/>
          </div>
        </div>
      </div>

      <!-- Card 2: Educational & Economic Status -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Educational & Economic Status</h5>
        </div>
        <div class="form-grid">
          <div>
            <label>Educational Attainment</label>
            <select id="memberEducationalAttainment" class="member-educational animated">
              <option value="">Select...</option>
              <option value="No Formal Education">No Formal Education</option>
              <option value="Elementary Level">Elementary Level</option>
              <option value="Elementary Graduate">Elementary Graduate</option>
              <option value="High School Level">High School Level</option>
              <option value="High School Graduate">High School Graduate</option>
              <option value="Senior High School Level">Senior High School Level</option>
              <option value="Senior High School Graduate">Senior High School Graduate</option>
              <option value="College Level">College Level</option>
              <option value="College Graduate">College Graduate</option>
            </select>
          </div>

          <div id="memberCollegeCourseField" class="conditional-field">
            <label>College Graduate Course</label>
            <input type="text" id="memberCollegeCourse" placeholder="Enter course name" />
          </div>

          <div>
            <label>Employment</label>
            <select id="memberEmployment" class="member-employment animated">
              <option value="">Select...</option>
              <option value="Employed">Employed</option>
              <option value="Unemployed">Unemployed</option>
            </select>
          </div>

          <div id="memberJobTitleField" class="conditional-field">
            <label>Job Title</label>
            <select id="memberJobTitle" class="member-jobtitle animated">
              <option value="">Select...</option>
              <optgroup label="Office & Administrative Jobs">
                <option>Administrative Assistant / Admin Staff</option>
                <option>Office Clerk</option>
                <option>Secretary / Executive Assistant</option>
              </optgroup>
              <optgroup label="Business & Management">
                <option>Project Manager</option>
                <option>Operations Manager</option>
                <option>HR Staff / HR Officer</option>
                <option>Account Manager</option>
              </optgroup>
              <optgroup label="Accounting & Finance">
                <option>Accounting Staff</option>
                <option>Bookkeeper</option>
                <option>Payroll Officer</option>
                <option>Auditor</option>
              </optgroup>
              <optgroup label="IT & Tech">
                <option>IT Support / IT Technician</option>
                <option>Web Developer</option>
                <option>Software Developer / Programmer</option>
                <option>Data Analyst</option>
                <option>System Administrator</option>
              </optgroup>
              <optgroup label="Healthcare">
                <option>Nurse (Staff Nurse / Company Nurse)</option>
                <option>Medical Technologist</option>
                <option>Caregiver</option>
                <option>Pharmacist</option>
              </optgroup>
              <optgroup label="Education">
                <option>Teacher / Instructor</option>
                <option>Tutor</option>
                <option>School Administrator</option>
              </optgroup>
              <optgroup label="Sales & Customer Service">
                <option>Customer Service Representative (CSR)</option>
                <option>Sales Associate</option>
                <option>Cashier</option>
                <option>Store Supervisor</option>
              </optgroup>
              <optgroup label="Skilled Work & Labor">
                <option>Electrician</option>
                <option>Plumber</option>
                <option>Welder</option>
                <option>Construction Worker / Skilled Laborer</option>
              </optgroup>
              <optgroup label="Delivery & Logistics">
                <option>Driver (Company Driver / Delivery Driver)</option>
                <option>Logistics Staff</option>
                <option>Rider / Motorcycle Delivery</option>
              </optgroup>
              <optgroup label="Food & Hospitality">
                <option>Cook / Chef</option>
                <option>Waiter / Service Crew</option>
                <option>Barista</option>
                <option>Housekeeping Staff</option>
              </optgroup>
              <optgroup label="Security & Public Service">
                <option>Security Guard</option>
                <option>Barangay Staff / Barangay Council Employee</option>
                <option>Police Officer</option>
                <option>Fire Officer</option>
              </optgroup>
              <optgroup label="Media, Design & Creative">
                <option>Graphic Designer</option>
                <option>Video Editor</option>
                <option>Content Writer</option>
                <option>Social Media Manager</option>
              </optgroup>
              <option>Others</option>
            </select>
          </div>

          <div>
            <label>Overseas Filipino Worker (OFW)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="member_ofw_status" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="member_ofw_status" value="No" checked> No</label>
            </div>
          </div>

          <div id="memberCountryField" class="conditional-field">
            <label>Country</label>
            <select id="memberCountry" class="member-country animated">
              <option value="">Select...</option>
              <option>Saudi Arabia</option>
              <option>United Arab Emirates (UAE)</option>
              <option>Qatar</option>
              <option>Kuwait</option>
              <option>Bahrain</option>
              <option>Oman</option>
              <option>Hong Kong</option>
              <option>Singapore</option>
              <option>Japan</option>
              <option>Taiwan</option>
              <option>Malaysia</option>
              <option>Australia</option>
              <option>New Zealand</option>
              <option>Italy</option>
              <option>United Kingdom (UK)</option>
              <option>Germany</option>
              <option>Cyprus</option>
              <option>Canada</option>
              <option>United States (USA)</option>
              <option>Libya</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Card 3: Health and Status -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Health and Status</h5>
        </div>
        <div class="form-grid">
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="member_pwd" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="member_pwd" value="No" checked> No</label>
            </div>
          </div>

          <div>
            <label>Status</label>
            <select id="memberStatus" class="member-status animated">
              <option value="">Select...</option>
              <option>With Sickness</option>
              <option>Pregnant</option>
              <option>Solo Parent</option>
              <option>Lactating</option>
              <option>Severe Illness</option>
              <option>HIV Positive</option>
              <option>LGBTQ Plus</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Card 4: Transportation & Evacuation Details -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Transportation & Evacuation Details</h5>
        </div>
        <div class="form-grid">
          <div>
            <label>Transportation</label>
            <select id="memberTransport" class="member-transport animated">
              <option value="">Select...</option>
              <option>Has Transportation</option>
              <option>Needs Transportation</option>
            </select>
          </div>
          
          <div>
            <label>Pick-Up Location</label>
            <input id="memberPickup" class="member-pickup"/>
          </div>
          
          <div>
            <label>Drop-Off Location</label>
            <input id="memberDropoff" class="member-dropoff"/>
          </div>
          
          <div>
            <label>Evacuation Camp Name</label>
            <input id="memberCamp" class="member-camp"/>
          </div>
          
          <div>
            <label>Camp Capacity</label>
            <input type="number" id="memberCampCap" class="member-cap" min="0"/>
          </div>
          
          <div>
            <label>Individuals Currently in Camp</label>
            <input type="number" id="memberInside" class="member-inside" min="0"/>
          </div>
          
          <div>
            <label>Individuals Outside Camp</label>
            <input type="number" id="memberOutside" class="member-outside" min="0"/>
          </div>

          <div style="grid-column:1/-1;">
            <label>Reason for Displacement</label>
            <select id="memberReason" class="member-reason animated">
              <option value="">Select...</option>
              <option>Taal Volcano (Within 14-15 KM Danger Zone)</option>
              <option>Typhoon</option>
              <option>Flood</option>
              <option>Landslide</option>
              <option>Earthquake</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Card 5: Government Assistance Programs -->
      <div class="edit-card">
        <div class="form-section">
          <h5>Government Assistance Programs</h5>
        </div>
        <div class="gov-support-grid">
          <div class="checkbox-item">
            <input type="checkbox" id="member_tupad" class="member_tupad">
            <label for="member_tupad">TUPAD</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_local4ps" class="member_local4ps">
            <label for="member_local4ps">Local 4Ps</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_intl4ps" class="member_intl4ps">
            <label for="member_intl4ps">National 4Ps</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_locsp" class="member_locsp">
            <label for="member_locsp">Local Social Pension</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_intlsp" class="member_intlsp">
            <label for="member_intlsp">National Social Pension</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_solo" class="member_solo">
            <label for="member_solo">Solo Parent Assistance</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_relief" class="member_relief">
            <label for="member_relief">Relief Goods</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="member_cash" class="member_cash">
            <label for="member_cash">Cash Subsidy</label>
          </div>
        </div>

        <div style="margin-top:16px">
          <label>AICS (if any)</label>
          <select id="memberAics" class="member_aics animated">
            <option value="">None</option>
            <option>Shelter Assistance</option>
            <option>Burial</option>
            <option>Scholarship</option>
          </select>
        </div>
      </div>

      <!-- Card 6: Action Buttons -->
      <div class="edit-card">
        <div class="panel-actions" style="margin-top:5px;">
          <button id="memberBack" class="btn btn-reset" type="button">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button id="memberNext" class="btn" type="button">
            Save & Next <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- NEW MODALS - ALL MADE SMALLER -->
<!-- Reset Confirmation Modal - Smaller -->
<div id="resetConfirmationModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-warning">
    <div class="modal-icon">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <h3 class="modal-header">Reset Form</h3>
    <p>Are you sure you want to reset the form? All entered data will be permanently lost.</p>
    <div class="modal-actions">
      <button id="cancelReset" class="btn secondary">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button id="confirmReset" class="btn btn-reset">
        <i class="fas fa-redo"></i> Reset Form
      </button>
    </div>
  </div>
</div>

<!-- Save Confirmation Modal - Smaller -->
<div id="saveConfirmationModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-info">
    <div class="modal-icon">
      <i class="fas fa-save"></i>
    </div>
    <h3 class="modal-header">Save Data</h3>
    <p>Are you ready to save the household data? This action cannot be undone.</p>
    <div class="modal-actions">
      <button id="cancelSave" class="btn secondary">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button id="confirmSave" class="btn">
        <i class="fas fa-check"></i> Save Data
      </button>
    </div>
  </div>
</div>

<!-- Success Modal - Smaller -->
<div id="successModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-success">
    <div class="modal-icon">
      <i class="fas fa-check-circle"></i>
    </div>
    <h3 class="modal-header">Success!</h3>
    <p id="successMessage">Operation completed successfully.</p>
    <div class="modal-actions">
      <button id="closeSuccess" class="btn">
        <i class="fas fa-check"></i> OK
      </button>
    </div>
  </div>
</div>

<!-- Error Modal - Smaller -->
<div id="errorModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-error">
    <div class="modal-icon">
      <i class="fas fa-exclamation-circle"></i>
    </div>
    <h3 class="modal-header">Error</h3>
    <p id="errorMessage">An error occurred.</p>
    <div class="modal-actions">
      <button id="closeError" class="btn secondary">
        <i class="fas fa-times"></i> Close
      </button>
    </div>
  </div>
</div>

<!-- Info Modal - Smaller -->
<div id="infoModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-info">
    <div class="modal-icon">
      <i class="fas fa-info-circle"></i>
    </div>
    <h3 class="modal-header">Information</h3>
    <p id="infoMessage">Information message.</p>
    <div class="modal-actions">
      <button id="closeInfo" class="btn">
        <i class="fas fa-check"></i> OK
      </button>
    </div>
  </div>
</div>

<script>
/* final merged client-side script (age, panel, submit). Keep API_URL updated if needed */
const API_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";

document.addEventListener('DOMContentLoaded', function() {
  // SESSION IS HANDLED BY session-manager.js - NO NEED TO CHECK HERE
  
  // Check screen width and adjust sidebar
  if (window.innerWidth <= 768) {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.remove('mobile-open');
  }
  
  // FORM INITIALIZATION CONTINUES BELOW (your existing code after this block)
});

/* ============ MODAL MANAGEMENT FUNCTIONS ============ */
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}

function showSuccess(message) {
    const messageEl = document.getElementById('successMessage');
    if (messageEl) {
        messageEl.textContent = message;
    }
    showModal('successModal');
}

function showError(message) {
    const messageEl = document.getElementById('errorMessage');
    if (messageEl) {
        messageEl.textContent = message;
    }
    showModal('errorModal');
}

function showInfo(message) {
    const messageEl = document.getElementById('infoMessage');
    if (messageEl) {
        messageEl.textContent = message;
    }
    showModal('infoModal');
}

/* ============ UPDATE VALIDATION SUMMARY FUNCTIONS ============ */
function updateHeadValidationSummary() {
    const errors = [];
    let hasErrors = false;

    // Check required fields
    const requiredFields = [
        { id: 'barangay', name: 'Barangay' },
        { id: 'sitio', name: 'Sitio / Purok' },
        { id: 'householdHead', name: 'Household Head Full Name' },
        { id: 'contactNo', name: 'Contact no.' },
        { id: 'householdBirthdate', name: 'Birthdate' },
        { id: 'memberCount', name: 'No. of Household Member/s' }
    ];

    requiredFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element && !element.value.trim()) {
            errors.push(`${field.name} is required`);
            hasErrors = true;
        }
    });

    // Check sex selection
    const sexRadios = document.querySelectorAll('input[name="head_sex"]:checked');
    if (sexRadios.length === 0) {
        errors.push('Sex is required');
        hasErrors = true;
    }

    // Check contact number format if it exists
    const contactInput = document.getElementById("contactNo");
    if (contactInput && contactInput.value.trim() && !validatePhilippineMobileNumber(contactInput.value.trim())) {
        errors.push('Please enter a valid Philippine mobile number (09XXXXXXXXX or +639XXXXXXXXX)');
        hasErrors = true;
    }

    // Update the validation summary display
    const validationSummary = document.getElementById('validationSummaryHead');
    const errorsList = document.getElementById('headValidationErrors');
    
    if (errorsList) {
        errorsList.innerHTML = '';
        if (hasErrors) {
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorsList.appendChild(li);
            });
        }
    }
    
    if (validationSummary) {
        if (hasErrors) {
            validationSummary.classList.add('show');
        } else {
            validationSummary.classList.remove('show');
        }
    }
    
    return !hasErrors;
}


function updateMemberValidationSummary() {
    const errors = [];
    let hasErrors = false;

    // Check required fields
    const requiredFields = [
        { id: 'memberName', name: 'Household Member Full Name' },
        { id: 'memberContact', name: 'Contact no.' },
        { id: 'memberBirthdate', name: 'Birthdate' }
    ];

    requiredFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element && !element.value.trim()) {
            errors.push(`${field.name} is required`);
            hasErrors = true;
        }
    });

    // Check sex selection
    const sexRadios = document.querySelectorAll('input[name="member_sex"]:checked');
    if (sexRadios.length === 0) {
        errors.push('Sex is required');
        hasErrors = true;
    }

    // Check contact number format if it exists
    const contactInput = document.getElementById("memberContact");
    if (contactInput && contactInput.value.trim() && !validatePhilippineMobileNumber(contactInput.value.trim())) {
        errors.push('Please enter a valid Philippine mobile number (09XXXXXXXXX or +639XXXXXXXXX)');
        hasErrors = true;
    }

    // Update the validation summary display
    const validationSummary = document.getElementById('validationSummaryMember');
    const errorsList = document.getElementById('memberValidationErrors');
    
    if (errorsList) {
        errorsList.innerHTML = '';
        if (hasErrors) {
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorsList.appendChild(li);
            });
        }
    }
    
    if (validationSummary) {
        if (hasErrors) {
            validationSummary.classList.add('show');
        } else {
            validationSummary.classList.remove('show');
        }
    }
    
    return !hasErrors;
}


/* ============ FIELD-LEVEL VALIDATION FUNCTIONS ============ */
function validateHeadForm() {
    // First, do a full validation to make sure all errors are captured
    const requiredFields = [
        { id: 'barangay', name: 'Barangay' },
        { id: 'sitio', name: 'Sitio / Purok' },
        { id: 'householdHead', name: 'Household Head Full Name' },
        { id: 'contactNo', name: 'Contact no.' },
        { id: 'householdBirthdate', name: 'Birthdate' },
        { id: 'memberCount', name: 'No. of Household Member/s' }
    ];

    const sexRadios = document.querySelectorAll('input[name="head_sex"]:checked');
    const contactInput = document.getElementById("contactNo");
    const contactError = document.getElementById("contactError");
    
    let errors = [];
    let hasErrors = false;

    // Clear previous validation states
    clearValidationErrors('headForm');

    // Validate required fields
    requiredFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element) {
            const value = element.value.trim();
            if (!value) {
                element.classList.add('validation-error');
                const label = element.closest('div')?.querySelector('label');
                if (label) label.classList.add('validation-error-label');
                errors.push(`${field.name} is required`);
                hasErrors = true;
            }
        }
    });

    // Validate sex selection
    if (sexRadios.length === 0) {
        // Get the Sex label - find it by looking for the label before the radio-line
        const sexLabel = document.querySelector('label[for="head_sex"]') || 
                         document.querySelector('.form-grid > div:has(.radio-line) label');
        
        if (sexLabel) {
            sexLabel.classList.add('validation-error-label');
        }
        errors.push('Sex is required');
        hasErrors = true;
    }

    // Validate contact number
    if (contactInput && contactInput.value.trim()) {
        if (!validateContactInput(contactInput, contactError)) {
            errors.push('Please enter a valid Philippine mobile number (09XXXXXXXXX or +639XXXXXXXXX)');
            hasErrors = true;
        }
    }

    // Show/hide validation summary
    const validationSummary = document.getElementById('validationSummaryHead');
    const errorsList = document.getElementById('headValidationErrors');
    
    if (hasErrors) {
        if (errorsList) {
            errorsList.innerHTML = '';
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorsList.appendChild(li);
            });
        }
        if (validationSummary) {
            validationSummary.classList.add('show');
            // Scroll to validation summary
            validationSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        return false;
    } else {
        if (validationSummary) {
            validationSummary.classList.remove('show');
        }
        return true;
    }
}
function validateMemberForm() {
    // First, do a full validation to make sure all errors are captured
    const requiredFields = [
        { id: 'memberName', name: 'Household Member Full Name' },
        { id: 'memberContact', name: 'Contact no.' },
        { id: 'memberBirthdate', name: 'Birthdate' }
    ];

    const sexRadios = document.querySelectorAll('input[name="member_sex"]:checked');
    const contactInput = document.getElementById("memberContact");
    const contactError = document.getElementById("memberContactError");
    
    let errors = [];
    let hasErrors = false;

    // Clear previous validation states
    clearValidationErrors('memberForm');

    // Validate required fields
    requiredFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element) {
            const value = element.value.trim();
            if (!value) {
                element.classList.add('validation-error');
                const label = element.closest('div')?.querySelector('label');
                if (label) label.classList.add('validation-error-label');
                errors.push(`${field.name} is required`);
                hasErrors = true;
            }
        }
    });

    // Validate sex selection
    if (sexRadios.length === 0) {
        // Get the Sex label in member panel - it's in the first edit-card
        const memberSexLabel = document.querySelector('#memberPanel label:has(+ .radio-line)') ||
                               document.querySelector('#memberForm .form-grid > div:has(.radio-line) label');
        
        if (memberSexLabel) {
            memberSexLabel.classList.add('validation-error-label');
        }
        errors.push('Sex is required');
        hasErrors = true;
    }

    // Validate contact number
    if (contactInput && contactInput.value.trim()) {
        if (!validateContactInput(contactInput, contactError)) {
            errors.push('Please enter a valid Philippine mobile number (09XXXXXXXXX or +639XXXXXXXXX)');
            hasErrors = true;
        }
    }

    // Show/hide validation summary
    const validationSummary = document.getElementById('validationSummaryMember');
    const errorsList = document.getElementById('memberValidationErrors');
    
    if (hasErrors) {
        if (errorsList) {
            errorsList.innerHTML = '';
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorsList.appendChild(li);
            });
        }
        if (validationSummary) {
            validationSummary.classList.add('show');
            // Scroll to validation summary
            validationSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        return false;
    } else {
        if (validationSummary) {
            validationSummary.classList.remove('show');
        }
        return true;
    }
}
/* ============ HELPER FUNCTIONS TO REMOVE SPECIFIC ERRORS ============ */
function removeHeadErrorByFieldId(fieldId) {
    const fieldNameMap = {
        'barangay': 'Barangay',
        'sitio': 'Sitio / Purok',
        'householdHead': 'Household Head Full Name',
        'contactNo': 'Contact number',
        'householdBirthdate': 'Birthdate',
        'memberCount': 'No. of Household Member(s)'
    };
    
    if (fieldNameMap[fieldId]) {
        removeHeadErrorByText(fieldNameMap[fieldId]);
    }
}

function removeMemberErrorByFieldId(fieldId) {
    const fieldNameMap = {
        'memberName': 'Household Member Full Name is required',
        'memberContact': 'Contact no. is required',
        'memberBirthdate': 'Birthdate is required'
    };
    
    if (fieldNameMap[fieldId]) {
        removeMemberErrorByText(fieldNameMap[fieldId]);
    }
}

function removeHeadErrorByText(errorText) {
    const errorsList = document.getElementById('headValidationErrors');
    if (!errorsList) return;
    
    const errors = Array.from(errorsList.querySelectorAll('li'));
    let found = false;
    
    errors.forEach(li => {
        if (li.textContent.includes(errorText)) {
            li.remove();
            found = true;
        }
    });
    
    // If we removed an error, check if there are any errors left
    if (found) {
        const remainingErrors = errorsList.querySelectorAll('li');
        const validationSummary = document.getElementById('validationSummaryHead');
        
        if (remainingErrors.length === 0 && validationSummary) {
            validationSummary.classList.remove('show');
        }
    }
}

function removeMemberErrorByText(errorText) {
    const errorsList = document.getElementById('memberValidationErrors');
    if (!errorsList) return;
    
    const errors = Array.from(errorsList.querySelectorAll('li'));
    let found = false;
    
    errors.forEach(li => {
        if (li.textContent.includes(errorText)) {
            li.remove();
            found = true;
        }
    });
    
    // If we removed an error, check if there are any errors left
    if (found) {
        const remainingErrors = errorsList.querySelectorAll('li');
        const validationSummary = document.getElementById('validationSummaryMember');
        
        if (remainingErrors.length === 0 && validationSummary) {
            validationSummary.classList.remove('show');
        }
    }
}

function clearValidationErrors(formId) {
    let elements;
    if (formId === 'headForm') {
        elements = document.querySelectorAll('#headForm input, #headForm select, #headForm textarea');
        // Clear sex container error
        const sexContainer = document.querySelector('.radio-line');
        if (sexContainer) {
            sexContainer.classList.remove('validation-error');
        }
        // Clear sex label error
        const sexLabel = document.querySelector('#headForm .form-grid > div:has(.radio-line) label');
        if (sexLabel) {
            sexLabel.classList.remove('validation-error-label');
        }
        document.querySelectorAll('#headForm label').forEach(label => {
            label.classList.remove('validation-error-label');
        });
        
        // Hide validation summary
        const validationSummary = document.getElementById('validationSummaryHead');
        if (validationSummary) {
            validationSummary.classList.remove('show');
        }
    } else if (formId === 'memberForm') {
        elements = document.querySelectorAll('#memberForm input, #memberForm select, #memberForm textarea');
        // Clear sex container error
        const sexContainer = document.querySelectorAll('.radio-line')[1];
        if (sexContainer) {
            sexContainer.classList.remove('validation-error');
        }
        // Clear sex label error
        const memberSexLabel = document.querySelector('#memberForm .form-grid > div:has(.radio-line) label');
        if (memberSexLabel) {
            memberSexLabel.classList.remove('validation-error-label');
        }
        document.querySelectorAll('#memberForm label').forEach(label => {
            label.classList.remove('validation-error-label');
        });
        
        // Hide validation summary
        const validationSummary = document.getElementById('validationSummaryMember');
        if (validationSummary) {
            validationSummary.classList.remove('show');
        }
    }
    
    elements.forEach(element => {
        element.classList.remove('validation-error');
    });
}

/* ============ REAL-TIME VALIDATION CLEARING ============ */
function setupRealTimeValidation() {
    // Head form fields
    const headRequiredFields = ['barangay', 'sitio', 'householdHead', 'contactNo', 'householdBirthdate', 'memberCount'];
    
    headRequiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('validation-error');
                    const label = this.closest('div')?.querySelector('label');
                    if (label) label.classList.remove('validation-error-label');
                    
                    // Remove this specific field's error from the summary
                    removeHeadErrorByFieldId(fieldId);
                }
            });
            
            // For select elements, use change event
            if (field.tagName === 'SELECT') {
                field.addEventListener('change', function() {
                    if (this.value.trim()) {
                        this.classList.remove('validation-error');
                        const label = this.closest('div')?.querySelector('label');
                        if (label) label.classList.remove('validation-error-label');
                        
                        // Remove this specific field's error from the summary
                        removeHeadErrorByFieldId(fieldId);
                    }
                });
            }
        }
    });
    
    // Head sex radio buttons
    const headSexRadios = document.querySelectorAll('input[name="head_sex"]');
    headSexRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const sexContainer = document.querySelector('.radio-line');
            if (sexContainer) {
                sexContainer.classList.remove('validation-error');
            }
            // Also clear the sex label error
            const sexLabel = document.querySelector('#headForm .form-grid > div:has(.radio-line) label');
            if (sexLabel) {
                sexLabel.classList.remove('validation-error-label');
            }
            
            // Remove sex error from the summary
            removeHeadErrorByText('Sex is required');
        });
    });
    
    // Head contact number validation
    const contactInput = document.getElementById('contactNo');
    if (contactInput) {
        contactInput.addEventListener('input', function() {
            if (this.value.trim() && validatePhilippineMobileNumber(this.value.trim())) {
                this.classList.remove('validation-error');
                this.classList.remove('input-error');
                const contactError = document.getElementById('contactError');
                if (contactError) contactError.style.display = 'none';
                
                // Remove contact number format error from the summary
                removeHeadErrorByText('Please enter a valid Philippine mobile number');
            }
        });
    }
    
    // Member form fields (set up when panel opens)
    setupMemberRealTimeValidation();
}

function setupMemberRealTimeValidation() {
    // Member form fields
    const memberRequiredFields = ['memberName', 'memberContact', 'memberBirthdate'];
    
    memberRequiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('validation-error');
                    const label = this.closest('div')?.querySelector('label');
                    if (label) label.classList.remove('validation-error-label');
                    
                    // Remove this specific field's error from the summary
                    removeMemberErrorByFieldId(fieldId);
                }
            });
            
            // For date field
            if (field.type === 'date') {
                field.addEventListener('change', function() {
                    if (this.value.trim()) {
                        this.classList.remove('validation-error');
                        const label = this.closest('div')?.querySelector('label');
                        if (label) label.classList.remove('validation-error-label');
                        
                        // Remove this specific field's error from the summary
                        removeMemberErrorByFieldId(fieldId);
                    }
                });
            }
        }
    });
    
    // Member sex radio buttons
    const memberSexRadios = document.querySelectorAll('input[name="member_sex"]');
    memberSexRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const sexContainer = document.querySelectorAll('.radio-line')[1];
            if (sexContainer) {
                sexContainer.classList.remove('validation-error');
            }
            // Also clear the sex label error
            const memberSexLabel = document.querySelector('#memberForm .form-grid > div:has(.radio-line) label');
            if (memberSexLabel) {
                memberSexLabel.classList.remove('validation-error-label');
            }
            
            // Remove sex error from the summary
            removeMemberErrorByText('Sex is required');
        });
    });
    
    // Member contact number validation
    const memberContactInput = document.getElementById('memberContact');
    if (memberContactInput) {
        memberContactInput.addEventListener('input', function() {
            if (this.value.trim() && validatePhilippineMobileNumber(this.value.trim())) {
                this.classList.remove('validation-error');
                this.classList.remove('input-error');
                const contactError = document.getElementById('memberContactError');
                if (contactError) contactError.style.display = 'none';
                
                // Remove contact number format error from the summary
                removeMemberErrorByText('Please enter a valid Philippine mobile number');
            }
        });
    }
}

/* ============ HAZARD HUNTER INTEGRATION ============ */
const HAZARD_HUNTER_URL = "https://hazardhunter.georisk.gov.ph/map#";

/* ============ PHILIPPINE MOBILE NUMBER VALIDATION ============ */
function validatePhilippineMobileNumber(number) {
    // Remove spaces and special characters
    const cleaned = number.replace(/\s+/g, '').replace(/[^\d+]/g, '');
    
    // Pattern for Philippine mobile numbers:
    // 09XXXXXXXXX (11 digits starting with 09)
    // +639XXXXXXXXX (13 digits starting with +639)
    const pattern = /^(09|\+639)\d{9}$/;
    
    if (!pattern.test(cleaned)) {
        return false;
    }
    
    // Additional check: ensure it's exactly 11 digits for 09 format or 13 for +639 format
    if (cleaned.startsWith('09') && cleaned.length !== 11) {
        return false;
    }
    if (cleaned.startsWith('+639') && cleaned.length !== 13) {
        return false;
    }
    
    return true;
}

function formatPhilippineMobileNumber(number) {
    const cleaned = number.replace(/\s+/g, '').replace(/[^\d+]/g, '');
    
    if (cleaned.startsWith('+639')) {
        // Format: +639 XX XXX XXXX
        return cleaned.replace(/(\+639)(\d{2})(\d{3})(\d{4})/, '$1 $2 $3 $4');
    } else if (cleaned.startsWith('09')) {
        // Format: 09XX XXX XXXX
        return cleaned.replace(/(09\d{2})(\d{3})(\d{4})/, '$1 $2 $3');
    }
    
    return number;
}

/* ============ INPUT VALIDATION FUNCTIONS ============ */
function validateContactInput(input, errorElement) {
    const value = input.value.trim();
    const isValid = validatePhilippineMobileNumber(value);
    
    if (value && !isValid) {
        input.classList.add('input-error');
        input.classList.add('validation-error');
        if (errorElement) errorElement.style.display = 'block';
        return false;
    } else {
        input.classList.remove('input-error');
        input.classList.remove('validation-error');
        if (errorElement) errorElement.style.display = 'none';
        
        // Format the number if valid
        if (isValid) {
            input.value = formatPhilippineMobileNumber(value);
        }
        return true;
    }
}

/* ---------------- helpers ---------------- */
function toSheetDateFormat(inputVal){
  if(!inputVal) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputVal)){
    const [y,m,d] = inputVal.split('-');
    return `${d}/${m}/${y}`;
  }
  const dt = new Date(inputVal);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dd}/${mm}/${dt.getFullYear()}`;
  }
  return String(inputVal);
}

function toInputDate(val){
  if(!val) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(val)){
    const [d,m,y] = val.split('/');
    return `${y}-${m}-${d}`;
  }
  const dt = new Date(val);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dt.getFullYear()}-${mm}-${dd}`;
  }
  return "";
}

/* compute age display + stage */
function computeAgeDetailed(inputDateValue){
  if(!inputDateValue) return null;
  let d;
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputDateValue)){
    const parts = inputDateValue.split('-');
    d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
  } else {
    d = new Date(inputDateValue);
  }
  if(isNaN(d)) return null;

  const now = new Date();
  const birth = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  let years = today.getFullYear() - birth.getFullYear();
  let months = today.getMonth() - birth.getMonth();
  let days = today.getDate() - birth.getDate();

  if(days < 0){
    months -= 1;
    const prev = new Date(today.getFullYear(), today.getMonth(), 0);
    days += prev.getDate();
  }
  if(months < 0){
    years -= 1;
    months += 12;
  }

  let display = "";
  if(years >= 1){
    display = String(years);
  } else {
    if(months >= 1) display = `${months} month(s)`;
    else display = `${days} day(s)`;
  }

  let stage = "";
  if(years === 0){
    if(months <= 10) stage = "Infant";
    else stage = "Children";
  } else if(years <= 17) stage = "School Children";
  else if(years >= 60) stage = "Elderly";
  else stage = "Adult";

  return { years, months, days, display, stage };
}

/* ============ COORDINATE HANDLING FUNCTIONS ============ */

/* Parse coordinates from Hazard Hunter format */
function parseHazardHunterCoordinates(coordinateString) {
    if (!coordinateString) return null;
    
    // Remove any extra spaces and special characters
    let cleaned = coordinateString.trim();
    
    // Common formats from Hazard Hunter:
    // 1. "14.123456, 121.123456" (lat, lng)
    // 2. "14¬∞07'24.4\"N 121¬∞07'24.4\"E" (DMS format)
    // 3. "14.123456¬∞ N, 121.123456¬∞ E" (Decimal degrees with directions)
    
    // Try to parse decimal format first (most common)
    const decimalMatch = cleaned.match(/([-+]?\d+\.\d+)\s*,\s*([-+]?\d+\.\d+)/);
    if (decimalMatch) {
        const lat = parseFloat(decimalMatch[1]);
        const lng = parseFloat(decimalMatch[2]);
        if (!isNaN(lat) && !isNaN(lng)) {
            return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }
    }
    
    // Try to parse DMS format (if Hazard Hunter provides it)
    const dmsMatch = cleaned.match(/(\d+)¬∞\s*(\d+)'\s*([\d.]+)"\s*([NS])\s*(\d+)¬∞\s*(\d+)'\s*([\d.]+)"\s*([EW])/i);
    if (dmsMatch) {
        const [_, latDeg, latMin, latSec, latDir, lngDeg, lngMin, lngSec, lngDir] = dmsMatch;
        
        let lat = parseInt(latDeg) + (parseInt(latMin) / 60) + (parseFloat(latSec) / 3600);
        let lng = parseInt(lngDeg) + (parseInt(lngMin) / 60) + (parseFloat(lngSec) / 3600);
        
        if (latDir.toUpperCase() === 'S') lat = -lat;
        if (lngDir.toUpperCase() === 'W') lng = -lng;
        
        return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }
    
    return null;
}

/* Get location from Hazard Hunter (manual selection) */
function openHazardHunterPicker() {
    // Store current form data temporarily
    const formData = {
        barangay: document.getElementById("barangay").value,
        sitio: document.getElementById("sitio").value,
        householdHead: document.getElementById("householdHead").value,
        contactNo: document.getElementById("contactNo").value,
    };
    
    // Store in sessionStorage so we can retrieve it when we come back
    sessionStorage.setItem('tempFormData', JSON.stringify(formData));
    sessionStorage.setItem('awaitingCoordinates', 'true');
    
    // Show modal with instructions
    showModal('hazardHunterModal');
}

/* Get location using browser geolocation */
function getCurrentLocation() {
    if (!navigator.geolocation) {
        showError("Geolocation is not supported by your browser.");
        return;
    }

    // Show loading
    const loadingOverlay = document.getElementById("loadingOverlay");
    loadingOverlay.style.display = "flex";

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude.toFixed(6);
            const lng = pos.coords.longitude.toFixed(6);
            document.getElementById("coordinate").value = `${lat}, ${lng}`;
            loadingOverlay.style.display = "none";
            
            // Ask user if they want to verify on Hazard Hunter
            showInfo("Location captured successfully!\n\nWould you like to verify this location on Hazard Hunter to check for hazards?");
        },
        (err) => {
            loadingOverlay.style.display = "none";
            showError("Unable to retrieve GPS location. Please allow location access or use the Hazard Hunter option.");
            console.error("GPS Error:", err);
        },
        {
            enableHighAccuracy: true,
            timeout: 8000,
            maximumAge: 0
        }
    );
}

/* Open Hazard Hunter with pre-filled coordinates for verification */
function openHazardHunterVerification(lat, lng) {
    // Hazard Hunter URL format for specific coordinates
    const verificationUrl = `${HAZARD_HUNTER_URL}?lat=${lat}&lng=${lng}`;
    
    // Store that we're in verification mode
    sessionStorage.setItem('verifyingCoordinates', 'true');
    sessionStorage.setItem('originalCoordinates', `${lat}, ${lng}`);
    
    // Open in new tab
    window.open(verificationUrl, '_blank');
    
    showInfo("Hazard Hunter opened with your location.\n\nYou can check for hazards and update coordinates if needed.\n\nReturn to this tab and update the coordinates field if necessary.");
}

/* Setup coordinate paste handler */
function setupCoordinatePasteHandler() {
    const coordInput = document.getElementById("coordinate");
    
    if (!coordInput) return;
    
    coordInput.addEventListener('paste', (e) => {
        // Allow the paste to happen first
        setTimeout(() => {
            const pastedText = coordInput.value;
            const parsed = parseHazardHunterCoordinates(pastedText);
            
            if (parsed) {
                coordInput.value = parsed;
                // Show success message
                showSuccess("Coordinates parsed successfully!");
            } else {
                // Show format hint
                showInfo("Please ensure format is: latitude, longitude (e.g., 14.123456, 121.123456)");
            }
        }, 100);
    });
}

/* ============ MODAL HANDLING ============ */
function setupModalHandlers() {
    // Hazard Hunter Modal
    const hazardModal = document.getElementById('hazardHunterModal');
    const cancelHazardBtn = document.getElementById('cancelHazardHunter');
    const confirmHazardBtn = document.getElementById('confirmHazardHunter');
    
    if (hazardModal) {
        // Cancel button
        if (cancelHazardBtn) {
            cancelHazardBtn.addEventListener('click', () => {
                hideModal('hazardHunterModal');
            });
        }
        
        // Confirm button
        if (confirmHazardBtn) {
            confirmHazardBtn.addEventListener('click', () => {
                hideModal('hazardHunterModal');
                
                // Open Hazard Hunter in new tab
                window.open(HAZARD_HUNTER_URL, '_blank');
                
                // Show reminder message
                showInfo("Hazard Hunter opened in new tab. Copy coordinates and return to paste them.");
                
                // Set flag that we're expecting coordinates
                sessionStorage.setItem('awaitingCoordinates', 'true');
            });
        }
        
        // Close modal when clicking outside
        hazardModal.addEventListener('click', (e) => {
            if (e.target === hazardModal) {
                hideModal('hazardHunterModal');
            }
        });
    }
    
    // Reset Confirmation Modal
    const resetModal = document.getElementById('resetConfirmationModal');
    const cancelResetBtn = document.getElementById('cancelReset');
    const confirmResetBtn = document.getElementById('confirmReset');
    
    if (resetModal) {
        // Cancel button
        if (cancelResetBtn) {
            cancelResetBtn.addEventListener('click', () => {
                hideModal('resetConfirmationModal');
            });
        }
        
        // Confirm button
        if (confirmResetBtn) {
            confirmResetBtn.addEventListener('click', () => {
                hideModal('resetConfirmationModal');
                resetForm();
            });
        }
        
        // Close modal when clicking outside
        resetModal.addEventListener('click', (e) => {
            if (e.target === resetModal) {
                hideModal('resetConfirmationModal');
            }
        });
    }
    
    // Save Confirmation Modal
    const saveModal = document.getElementById('saveConfirmationModal');
    const cancelSaveBtn = document.getElementById('cancelSave');
    const confirmSaveBtn = document.getElementById('confirmSave');
    
    if (saveModal) {
        // Cancel button
        if (cancelSaveBtn) {
            cancelSaveBtn.addEventListener('click', () => {
                hideModal('saveConfirmationModal');
            });
        }
        
        // Confirm button
        if (confirmSaveBtn) {
            confirmSaveBtn.addEventListener('click', () => {
                hideModal('saveConfirmationModal');
                proceedToMemberPanel();
            });
        }
        
        // Close modal when clicking outside
        saveModal.addEventListener('click', (e) => {
            if (e.target === saveModal) {
                hideModal('saveConfirmationModal');
            }
        });
    }
    
    // Success Modal
    const successModal = document.getElementById('successModal');
    const closeSuccessBtn = document.getElementById('closeSuccess');
    
    if (successModal) {
        // Close button
        if (closeSuccessBtn) {
            closeSuccessBtn.addEventListener('click', () => {
                hideModal('successModal');
            });
        }
        
        // Close modal when clicking outside
        successModal.addEventListener('click', (e) => {
            if (e.target === successModal) {
                hideModal('successModal');
            }
        });
    }
    
    // Error Modal
    const errorModal = document.getElementById('errorModal');
    const closeErrorBtn = document.getElementById('closeError');
    
    if (errorModal) {
        // Close button
        if (closeErrorBtn) {
            closeErrorBtn.addEventListener('click', () => {
                hideModal('errorModal');
            });
        }
        
        // Close modal when clicking outside
        errorModal.addEventListener('click', (e) => {
            if (e.target === errorModal) {
                hideModal('errorModal');
            }
        });
    }
    
    // Info Modal
    const infoModal = document.getElementById('infoModal');
    const closeInfoBtn = document.getElementById('closeInfo');
    
    if (infoModal) {
        // Close button
        if (closeInfoBtn) {
            closeInfoBtn.addEventListener('click', () => {
                hideModal('infoModal');
            });
        }
        
        // Close modal when clicking outside
        infoModal.addEventListener('click', (e) => {
            if (e.target === infoModal) {
                hideModal('infoModal');
            }
        });
    }
}

/* ============ RESET FORM FUNCTION ============ */
function resetForm() {
    document.getElementById("headForm").reset();
    collectedMembers = [];
    updateMemberPreview();
    document.getElementById("householdAge").value = "";
    document.getElementById("householdStage").value = "";
    
    // Clear conditional fields
    document.getElementById('collegeCourseField').classList.remove('show');
    document.getElementById('jobTitleField').classList.remove('show');
    document.getElementById('countryField').classList.remove('show');
    document.getElementById('headRegistrationField').classList.remove('show');
    
    // Clear any error states
    clearValidationErrors('headForm');
    
    const contactInput = document.getElementById("contactNo");
    const contactError = document.getElementById("contactError");
    if (contactInput) contactInput.classList.remove('input-error');
    if (contactError) contactError.style.display = 'none';
    
    const memberContactInput = document.getElementById("memberContact");
    const memberContactError = document.getElementById("memberContactError");
    if (memberContactInput) memberContactInput.classList.remove('input-error');
    if (memberContactError) memberContactError.style.display = 'none';
    
    showSuccess("Form has been reset successfully.");
}

/* ============ PROCEED TO MEMBER PANEL ============ */
function proceedToMemberPanel() {
    const barangay = document.getElementById("barangay").value.trim();
    const sitio = document.getElementById("sitio").value.trim();
    const headName = document.getElementById("householdHead").value.trim();
    const headContact = document.getElementById("contactNo").value.trim();
    
    // Validate required fields
    if(!barangay || !sitio || !headName || !headContact){ 
        showError("Please fill Barangay, Sitio/Purok, Name of Household Head and Contact no."); 
        return; 
    }
    
    // Validate contact number
    const contactInput = document.getElementById("contactNo");
    const contactError = document.getElementById("contactError");
    if (!validateContactInput(contactInput, contactError)) {
        showError("Please enter a valid Philippine mobile number (09XXXXXXXXX or +639XXXXXXXXX)");
        contactInput.focus();
        return;
    }

    membersToCollect = parseInt(document.getElementById("memberCount").value || 0);
    collectedMembers = []; 
    currentMemberIndex = 0;
    updateMemberPreview();

    if(membersToCollect === 0){
        // no members -> submit head only
        submitHeadAndMembers();
        return;
    }

    // open member panel first
    fillMemberPanel(0);
    currentMemberIndex = 0;
    openPanel();
}

/* ---------------- UI + state ---------------- */
function ensureLoginOrRedirect(){
  if(!localStorage.getItem("loggedIn")){ /* keep as-is or redirect to login */ return true; }
  return true;
}

let membersToCollect = 0;
let currentMemberIndex = 0;
let collectedMembers = [];

function updateMemberPreview(){
  const n = parseInt(document.getElementById("memberCount").value || 0);
  document.getElementById("previewCount").innerText = n;
  const list = document.getElementById("membersPreview");
  list.innerHTML = "";
  for(let i=0;i<n;i++){
    const mem = collectedMembers[i];
    const li = document.createElement('li');
    li.innerText = mem ? `#${i+1} ‚Äî ${mem["Name of Household Member/s"] || "(empty)"} (${mem["Contact no."]||""})` : `#${i+1} ‚Äî (empty)`;
    list.appendChild(li);
  }
}

/* fill member panel */
function fillMemberPanel(idx){
  const mem = collectedMembers[idx] || {};
  
  // Basic Information
  document.getElementById("memberName").value = mem["Name of Household Member/s"] || "";
  
  // Set checkbox based on whether registration field has value
  const hasRegistration = mem["FishR Registered/RBIS Registered"] && mem["FishR Registered/RBIS Registered"] !== "";
  document.getElementById("memberRegisteredCheckbox").checked = hasRegistration;
  
  // Show/hide registration field based on checkbox
  const memberRegistrationField = document.getElementById("memberRegistrationField");
  if (hasRegistration) {
    memberRegistrationField.classList.add('show');
    document.getElementById("memberRegistration").value = mem["FishR Registered/RBIS Registered"] || "";
  } else {
    memberRegistrationField.classList.remove('show');
    document.getElementById("memberRegistration").value = "";
  }
  
  document.getElementById("memberContact").value = mem["Contact no."] || "";
  Array.from(document.getElementsByName("member_sex")).forEach(r => r.checked = (r.value === (mem["Sex"] || "")));
  document.getElementById("memberBirthdate").value = mem["Birthdate"] ? toInputDate(mem["Birthdate"]) : "";
  document.getElementById("memberAge").value = mem["Age"] || "";
  document.getElementById("memberStage").value = mem["Stage"] || "";
  
  // Educational & Economic Status
  document.getElementById("memberEducationalAttainment").value = mem["Educational Attainment"] || "";
  document.getElementById("memberCollegeCourse").value = mem["College Graduate Course"] || "";
  document.getElementById("memberEmployment").value = mem["Employment"] || "";
  document.getElementById("memberJobTitle").value = mem["Job Title"] || "";
  Array.from(document.getElementsByName("member_ofw_status")).forEach(r => r.checked = (r.value === (mem["Overseas Filipino Worker(OFW)"] || "")));
  document.getElementById("memberCountry").value = mem["Country"] || "";
  
  // Health and Status
  Array.from(document.getElementsByName("member_pwd")).forEach(r => r.checked = (r.value === (mem["PWD"] || "")));
  document.getElementById("memberStatus").value = mem["Status"] || "";
  
  // Transportation & Evacuation Details
  document.getElementById("memberTransport").value = mem["Transportation"] || "";
  document.getElementById("memberPickup").value = mem["Designated Pick-Up Point"] || mem["Pick-Up Location"] || "";
  document.getElementById("memberDropoff").value = mem["Drop-Off Point"] || mem["Drop-Off Location"] || "";
  document.getElementById("memberCamp").value = mem["Name of Camp"] || mem["Evacuation Camp Name"] || "";
  document.getElementById("memberCampCap").value = mem["Capacity"] || "";
  document.getElementById("memberInside").value = mem["No. of Individuals Inside Camp"] || mem["Individuals Currently in Camp"] || "";
  document.getElementById("memberOutside").value = mem["No. of Individuals Outside Camp"] || mem["Individuals Outside Camp"] || "";
  document.getElementById("memberReason").value = mem["Reasons for Displacement"] || "";
  
  // Government Assistance Programs
  document.getElementById("member_tupad").checked = (mem["TUPAD"] === "Yes");
  document.getElementById("member_local4ps").checked = (mem["Local 4Ps"] === "Yes");
  document.getElementById("member_intl4ps").checked = (mem["National 4Ps"] === "Yes");
  document.getElementById("member_locsp").checked = (mem["Local Social Pension"] === "Yes");
  document.getElementById("member_intlsp").checked = (mem["National Social Pension"] === "Yes");
  document.getElementById("member_solo").checked = (mem["Solo Parent Assistance"] === "Yes");
  document.getElementById("member_relief").checked = (mem["Relief Goods"] === "Yes");
  document.getElementById("member_cash").checked = (mem["Cash Subsidy"] === "Yes");
  document.getElementById("memberAics").value = mem["AICS"] || "";
  
  // Handle conditional fields
  setupMemberConditionalFields();
  
  // Update panel title
  const total = Math.max(1, membersToCollect);
  document.getElementById("panelTitle").textContent = `Member ${idx + 1} of ${total}`;
}

/* collect member data */
function collectMemberDataFromPanel(){
  const name = document.getElementById("memberName").value.trim();
  const birth_input = document.getElementById("memberBirthdate").value || "";
  const birth_for_sheet = toSheetDateFormat(birth_input);
  const ageObj = computeAgeDetailed(birth_input);
  const ageVal = ageObj ? ageObj.display : "";
  const stageVal = ageObj ? ageObj.stage : "";

  // Get registration value only if checkbox is checked
  let registrationValue = "";
  if (document.getElementById("memberRegisteredCheckbox").checked) {
    registrationValue = document.getElementById("memberRegistration").value || "";
  }

  return {
    "Name of Household Member/s": name,
    "FishR Registered/RBIS Registered": registrationValue,
    "Contact no.": document.getElementById("memberContact").value || "",
    "Sex": document.querySelector("input[name='member_sex']:checked")?.value || "",
    "Birthdate": birth_for_sheet,
    "Age": ageVal,
    "Stage": stageVal,
    "PWD": document.querySelector("input[name='member_pwd']:checked")?.value || "No",
    "Status": document.getElementById("memberStatus").value || "",
    "Educational Attainment": document.getElementById("memberEducationalAttainment").value || "",
    "College Graduate Course": document.getElementById("memberCollegeCourse").value || "",
    "Employment": document.getElementById("memberEmployment").value || "",
    "Job Title": document.getElementById("memberJobTitle").value || "",
    "Overseas Filipino Worker(OFW)": document.querySelector("input[name='member_ofw_status']:checked")?.value || "No",
    "Country": document.getElementById("memberCountry").value || "",
    "Transportation": document.getElementById("memberTransport").value || "",
    "Designated Pick-Up Point": document.getElementById("memberPickup").value || "",
    "Pick-Up Location": document.getElementById("memberPickup").value || "", // Compatibility field
    "Drop-Off Point": document.getElementById("memberDropoff").value || "",
    "Drop-Off Location": document.getElementById("memberDropoff").value || "", // Compatibility field
    "Name of Camp": document.getElementById("memberCamp").value || "",
    "Evacuation Camp Name": document.getElementById("memberCamp").value || "", // Compatibility field
    "Capacity": document.getElementById("memberCampCap").value || "",
    "No. of Individuals Inside Camp": document.getElementById("memberInside").value || "",
    "Individuals Currently in Camp": document.getElementById("memberInside").value || "", // Compatibility field
    "No. of Individuals Outside Camp": document.getElementById("memberOutside").value || "",
    "Individuals Outside Camp": document.getElementById("memberOutside").value || "", // Compatibility field
    "Reasons for Displacement": document.getElementById("memberReason").value || "",
    "TUPAD": document.getElementById("member_tupad").checked ? "Yes" : "No",
    "Local 4Ps": document.getElementById("member_local4ps").checked ? "Yes" : "No",
    "National 4Ps": document.getElementById("member_intl4ps").checked ? "Yes" : "No",
    "Local Social Pension": document.getElementById("member_locsp").checked ? "Yes" : "No",
    "National Social Pension": document.getElementById("member_intlsp").checked ? "Yes" : "No",
    "Solo Parent Assistance": document.getElementById("member_solo").checked ? "Yes" : "No",
    "Relief Goods": document.getElementById("member_relief").checked ? "Yes" : "No",
    "Cash Subsidy": document.getElementById("member_cash").checked ? "Yes" : "No",
    "AICS": document.getElementById("memberAics").value || ""
  };
}

/* ============ CONDITIONAL FIELD HANDLERS ============ */
function setupConditionalFields() {
    // Head Registered Checkbox -> Registration Field
    const headRegisteredCheckbox = document.getElementById('headRegisteredCheckbox');
    const headRegistrationField = document.getElementById('headRegistrationField');
    const headRegistrationSelect = document.getElementById('headRegistration');
    
    if (headRegisteredCheckbox) {
        headRegisteredCheckbox.addEventListener('change', function() {
            if (this.checked) {
                headRegistrationField.classList.add('show');
                headRegistrationSelect.required = true;
            } else {
                headRegistrationField.classList.remove('show');
                headRegistrationSelect.required = false;
                headRegistrationSelect.value = '';
            }
        });
        
        // Initialize based on current value
        if (headRegisteredCheckbox.checked) {
            headRegistrationField.classList.add('show');
            headRegistrationSelect.required = true;
        }
    }
    
    // Member Registered Checkbox -> Registration Field
    const memberRegisteredCheckbox = document.getElementById('memberRegisteredCheckbox');
    const memberRegistrationField = document.getElementById('memberRegistrationField');
    const memberRegistrationSelect = document.getElementById('memberRegistration');
    
    if (memberRegisteredCheckbox) {
        memberRegisteredCheckbox.addEventListener('change', function() {
            if (this.checked) {
                memberRegistrationField.classList.add('show');
                memberRegistrationSelect.required = true;
            } else {
                memberRegistrationField.classList.remove('show');
                memberRegistrationSelect.required = false;
                memberRegistrationSelect.value = '';
            }
        });
        
        // Initialize based on current value
        if (memberRegisteredCheckbox.checked) {
            memberRegistrationField.classList.add('show');
            memberRegistrationSelect.required = true;
        }
    }
    
    // Educational Attainment -> College Course
    const educationSelect = document.getElementById('educationalAttainment');
    const collegeCourseField = document.getElementById('collegeCourseField');
    const collegeCourseInput = document.getElementById('collegeCourse');
    
    if (educationSelect) {
        educationSelect.addEventListener('change', function() {
            if (this.value === 'College Graduate') {
                collegeCourseField.classList.add('show');
                collegeCourseInput.required = true;
            } else {
                collegeCourseField.classList.remove('show');
                collegeCourseInput.required = false;
                collegeCourseInput.value = '';
            }
        });
        
        // Initialize based on current value
        if (educationSelect.value === 'College Graduate') {
            collegeCourseField.classList.add('show');
            collegeCourseInput.required = true;
        }
    }
    
    // Employment -> Job Title
    const employmentSelect = document.getElementById('employment');
    const jobTitleField = document.getElementById('jobTitleField');
    const jobTitleSelect = document.getElementById('jobTitle');
    
    if (employmentSelect) {
        employmentSelect.addEventListener('change', function() {
            if (this.value === 'Employed') {
                jobTitleField.classList.add('show');
                jobTitleSelect.required = true;
            } else {
                jobTitleField.classList.remove('show');
                jobTitleSelect.required = false;
                jobTitleSelect.value = '';
            }
        });
        
        // Initialize based on current value
        if (employmentSelect.value === 'Employed') {
            jobTitleField.classList.add('show');
            jobTitleSelect.required = true;
        }
    }
    
    // OFW Status -> Country
    const ofwRadios = document.querySelectorAll('input[name="ofw_status"]');
    const countryField = document.getElementById('countryField');
    const countrySelect = document.getElementById('country');
    
    if (ofwRadios.length > 0) {
        ofwRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'Yes') {
                    countryField.classList.add('show');
                    countrySelect.required = true;
                } else {
                    countryField.classList.remove('show');
                    countrySelect.required = false;
                    countrySelect.value = '';
                }
            });
        });
        
        // Initialize based on current value
        const checkedOfw = document.querySelector('input[name="ofw_status"]:checked');
        if (checkedOfw && checkedOfw.value === 'Yes') {
            countryField.classList.add('show');
            countrySelect.required = true;
        }
    }
}

function setupMemberConditionalFields() {
    // Member Educational Attainment -> College Course
    const memberEducationSelect = document.getElementById('memberEducationalAttainment');
    const memberCollegeCourseField = document.getElementById('memberCollegeCourseField');
    const memberCollegeCourseInput = document.getElementById('memberCollegeCourse');
    
    if (memberEducationSelect) {
        memberEducationSelect.addEventListener('change', function() {
            if (this.value === 'College Graduate') {
                memberCollegeCourseField.classList.add('show');
                memberCollegeCourseInput.required = true;
            } else {
                memberCollegeCourseField.classList.remove('show');
                memberCollegeCourseInput.required = false;
                memberCollegeCourseInput.value = '';
            }
        });
        
        // Initialize based on current value
        if (memberEducationSelect.value === 'College Graduate') {
            memberCollegeCourseField.classList.add('show');
            memberCollegeCourseInput.required = true;
        }
    }
    
    // Member Employment -> Job Title
    const memberEmploymentSelect = document.getElementById('memberEmployment');
    const memberJobTitleField = document.getElementById('memberJobTitleField');
    const memberJobTitleSelect = document.getElementById('memberJobTitle');
    
    if (memberEmploymentSelect) {
        memberEmploymentSelect.addEventListener('change', function() {
            if (this.value === 'Employed') {
                memberJobTitleField.classList.add('show');
                memberJobTitleSelect.required = true;
            } else {
                memberJobTitleField.classList.remove('show');
                memberJobTitleSelect.required = false;
                memberJobTitleSelect.value = '';
            }
        });
        
        // Initialize based on current value
        if (memberEmploymentSelect.value === 'Employed') {
            memberJobTitleField.classList.add('show');
            memberJobTitleSelect.required = true;
        }
    }
    
    // Member OFW Status -> Country
    const memberOfwRadios = document.querySelectorAll('input[name="member_ofw_status"]');
    const memberCountryField = document.getElementById('memberCountryField');
    const memberCountrySelect = document.getElementById('memberCountry');
    
    if (memberOfwRadios.length > 0) {
        memberOfwRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'Yes') {
                    memberCountryField.classList.add('show');
                    memberCountrySelect.required = true;
                } else {
                    memberCountryField.classList.remove('show');
                    memberCountrySelect.required = false;
                    memberCountrySelect.value = '';
                }
            });
        });
        
        // Initialize based on current value
        const checkedMemberOfw = document.querySelector('input[name="member_ofw_status"]:checked');
        if (checkedMemberOfw && checkedMemberOfw.value === 'Yes') {
            memberCountryField.classList.add('show');
            memberCountrySelect.required = true;
        }
    }
}

/* live age update */
document.addEventListener('input', (ev) => {
  if(ev.target && ev.target.id === "memberBirthdate"){
    const v = ev.target.value;
    const info = computeAgeDetailed(v);
    document.getElementById("memberAge").value = info ? info.display : "";
    document.getElementById("memberStage").value = info ? info.stage : "";
  }
  if(ev.target && ev.target.id === "householdBirthdate"){
    const v = ev.target.value;
    const info = computeAgeDetailed(v);
    document.getElementById("householdAge").value = info ? info.display : "";
    document.getElementById("householdStage").value = info ? info.stage : "";
  }
});

/* ---------------- DOM loaded bindings ---------------- */
document.addEventListener('DOMContentLoaded', function() {
  // SESSION IS HANDLED BY session-manager.js
  
  // Original DOMContentLoaded code continues here...
  ensureLoginOrRedirect(); // Basic local check
  document.getElementById("userName").innerText = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";

  // Check if user is admin - session-manager.js handles this, but keep as backup
  const isAdmin = localStorage.getItem("userRole") === "Admin";
  const adminItems = document.querySelectorAll(".admin-only");
  adminItems.forEach(item => {
    item.style.display = isAdmin ? "block" : "none";
  });

  // Setup modal handlers
  setupModalHandlers();

  // Setup conditional fields
  setupConditionalFields();

  // Setup coordinate paste handler
  setupCoordinatePasteHandler();

  // Setup real-time validation clearing
  setupRealTimeValidation();

  // Contact number validation
  const contactInput = document.getElementById("contactNo");
  const contactError = document.getElementById("contactError");
  
  if (contactInput) {
    contactInput.addEventListener('blur', () => {
      validateContactInput(contactInput, contactError);
    });
    
    contactInput.addEventListener('input', () => {
      // Clear error while typing
      contactInput.classList.remove('input-error');
      contactInput.classList.remove('validation-error');
      if (contactError) contactError.style.display = 'none';
    });
  }

  // Member contact number validation
  const memberContactInput = document.getElementById("memberContact");
  const memberContactError = document.getElementById("memberContactError");
  
  if (memberContactInput) {
    memberContactInput.addEventListener('blur', () => {
      validateContactInput(memberContactInput, memberContactError);
    });
    
    memberContactInput.addEventListener('input', () => {
      memberContactInput.classList.remove('input-error');
      memberContactInput.classList.remove('validation-error');
      if (memberContactError) memberContactError.style.display = 'none';
    });
  }

  // Coordinate buttons
  document.getElementById("getLocationBtn").addEventListener("click", getCurrentLocation);
  document.getElementById("hazardHunterBtn").addEventListener("click", openHazardHunterPicker);

  // reset button - now shows confirmation modal
  document.getElementById("resetBtn").addEventListener('click', () => {
    showModal('resetConfirmationModal');
  });

  // next (head -> members) - now shows save confirmation modal
  document.getElementById("nextToMembers").addEventListener('click', () => {
    // First validate the form
    if (!validateHeadForm()) {
        // Validation failed, scroll to top of validation summary
        const validationSummary = document.getElementById('validationSummaryHead');
        if (validationSummary && validationSummary.classList.contains('show')) {
            validationSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        return;
    }
    
    // If validation passes, show save confirmation modal
    showModal('saveConfirmationModal');
  });

  // panel close/back
  document.getElementById("panelClose").addEventListener('click', () => { closePanel(); });
  document.getElementById("memberBack").addEventListener('click', () => {
    if(currentMemberIndex > 0){
      collectedMembers[currentMemberIndex] = collectMemberDataFromPanel();
      currentMemberIndex--;
      fillMemberPanel(currentMemberIndex);
      updateMemberPreview();
    } else {
      closePanel();
    }
  });

  // memberNext (save & next)
  document.getElementById("memberNext").addEventListener('click', () => {
    // First validate the member form
    if (!validateMemberForm()) {
        // Validation failed, scroll to top of validation summary
        const validationSummary = document.getElementById('validationSummaryMember');
        if (validationSummary && validationSummary.classList.contains('show')) {
            validationSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        return;
    }

    collectedMembers[currentMemberIndex] = collectMemberDataFromPanel();
    updateMemberPreview();

    currentMemberIndex++;
    if(currentMemberIndex >= membersToCollect){
      // done
      closePanel();
      submitHeadAndMembers();
      return;
    }
    fillMemberPanel(currentMemberIndex);
  });

  document.getElementById("householdBirthdate").addEventListener('change', () => {
    const info = computeAgeDetailed(document.getElementById("householdBirthdate").value);
    document.getElementById("householdAge").value = info ? info.display : "";
    document.getElementById("householdStage").value = info ? info.stage : "";
  });

  // Animal quantity input handling
  document.querySelectorAll('.animal-card input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const qtyInput = this.closest('.animal-card').querySelector('.qty');
      if (this.checked) {
        qtyInput.disabled = false;
        qtyInput.value = qtyInput.value || '1';
      } else {
        qtyInput.disabled = true;
        qtyInput.value = '';
      }
    });
  });

  // Initialize animal card states
  document.querySelectorAll('.animal-card').forEach(card => {
    const checkbox = card.querySelector('input[type="checkbox"]');
    const qtyInput = card.querySelector('.qty');
    if (!checkbox.checked) {
      qtyInput.disabled = true;
    }
  });

  // Add logout event listener
  document.getElementById('logoutBtn').addEventListener('click', handleLogout);

  // Check if returning from Hazard Hunter
  checkReturnFromHazardHunter();

  // Initialize validation summaries as hidden
  const headValidationSummary = document.getElementById('validationSummaryHead');
  const memberValidationSummary = document.getElementById('validationSummaryMember');
  
  if (headValidationSummary) {
    headValidationSummary.classList.remove('show');
  }
  if (memberValidationSummary) {
    memberValidationSummary.classList.remove('show');
  }

  updateMemberPreview();
});

/* Check if user is returning from Hazard Hunter */
function checkReturnFromHazardHunter() {
    window.addEventListener('pageshow', (event) => {
        if (sessionStorage.getItem('awaitingCoordinates') === 'true') {
            // User returned from Hazard Hunter
            setTimeout(() => {
                const coordInput = document.getElementById("coordinate");
                if (coordInput && !coordInput.value.trim()) {
                    showInfo("Paste your Hazard Hunter coordinates (Ctrl+V) in the coordinate field.");
                }
            }, 1000);
            sessionStorage.removeItem('awaitingCoordinates');
        }
        
        // Restore form data if we have it
        const tempData = sessionStorage.getItem('tempFormData');
        if (tempData) {
            try {
                const data = JSON.parse(tempData);
                if (data.barangay) document.getElementById("barangay").value = data.barangay;
                if (data.sitio) document.getElementById("sitio").value = data.sitio;
                if (data.householdHead) document.getElementById("householdHead").value = data.householdHead;
                if (data.contactNo) document.getElementById("contactNo").value = data.contactNo;
                sessionStorage.removeItem('tempFormData');
            } catch (e) {
                console.error("Error restoring form data:", e);
            }
        }
    });
}

/* ============ PREVENT BACK BUTTON ISSUES ============ */

/* pageshow event listener */
window.addEventListener('pageshow', function(event) {
  // If page is loaded from cache (back/forward button)
  if (event.persisted) {
    console.log('Page loaded from cache, checking session...');
    
    // Check session again
    sessionCheck();
  }
});

/* panel helpers */
function openPanel(){ 
  document.getElementById("memberPanel").classList.add("open"); 
  document.getElementById("panelOverlay").classList.add("show"); 
}
function closePanel(){ 
  document.getElementById("memberPanel").classList.remove("open"); 
  document.getElementById("panelOverlay").classList.remove("show"); 
}

/* ---------------- Submit head + members ---------------- */
async function submitHeadAndMembers(){
  // Get current user - try to get full name from localStorage
  // First, try to get the full name that was saved during login
  const currentUserFullName = localStorage.getItem("userFullName") || 
                             localStorage.getItem("staffFullName") || 
                             localStorage.getItem("staffName") || 
                             localStorage.getItem("username") || 
                             "Unknown";
  
  // gather head
  const headBirthInput = document.getElementById("householdBirthdate").value || "";
  const headBirthForSheet = toSheetDateFormat(headBirthInput);
  const headAgeInfo = computeAgeDetailed(headBirthInput);
  const headAgeVal = headAgeInfo ? headAgeInfo.display : "";

  // Get head registration value only if checkbox is checked
  let headRegistrationValue = "";
  if (document.getElementById("headRegisteredCheckbox").checked) {
    headRegistrationValue = document.getElementById("headRegistration").value || "";
  }

const head = {
  "Coordinate": document.getElementById("coordinate").value || "",
  "Coordinates": document.getElementById("coordinate").value || "", // Added for compatibility
  "Barangay": document.getElementById("barangay").value || "",
  "Sitio / Purok": document.getElementById("sitio").value || "",
  "Name of Household Head": document.getElementById("householdHead").value || "",
  "FishR Registered/RBIS Registered": headRegistrationValue,
  "Contact no.": document.getElementById("contactNo").value || "",
  "Sex": document.querySelector('input[name="head_sex"]:checked')?.value || "",
  "Birthdate": headBirthForSheet,
  "Age": headAgeVal,
  "No. of Household Member/s": document.getElementById("memberCount").value || "0",
  "Name of Household Member/s": "", // head row has this empty
  "PWD": document.querySelector('input[name="head_pwd"]:checked')?.value || "No",
  "Stage": headAgeInfo ? headAgeInfo.stage : "",
  "Status": document.getElementById("head_status").value || "",
  "Educational Attainment": document.getElementById("educationalAttainment").value || "",
  "College Graduate Course": document.getElementById("collegeCourse").value || "",
  "Employment": document.getElementById("employment").value || "",
  "Job Title": document.getElementById("jobTitle").value || "",
  "Overseas Filipino Worker(OFW)": document.querySelector('input[name="ofw_status"]:checked')?.value || "No",
  "Country": document.getElementById("country").value || "",
  "Transportation": document.getElementById("head_transport").value || "",
  "Designated Pick-Up Point": document.getElementById("pickup").value || "",
  "Pick-Up Location": document.getElementById("pickup").value || "", // Added for compatibility
  "Drop-Off Point": document.getElementById("dropoff").value || "",
  "Drop-Off Location": document.getElementById("dropoff").value || "", // Added for compatibility
  "Name of Camp": document.getElementById("campName").value || "",
  "Evacuation Camp Name": document.getElementById("campName").value || "", // Added for compatibility
  "Capacity": document.getElementById("capacity").value || "",
  "No. of Individuals Inside Camp": document.getElementById("insideCamp").value || "",
  "Individuals Currently in Camp": document.getElementById("insideCamp").value || "", // Added for compatibility
  "No. of Individuals Outside Camp": document.getElementById("outsideCamp").value || "",
  "Individuals Outside Camp": document.getElementById("outsideCamp").value || "", // Added for compatibility
  "Reasons for Displacement": document.getElementById("reasons").value || "",
  "TUPAD": document.getElementById("ass_tupad").checked ? "Yes" : "No",
  "Local 4Ps": document.getElementById("ass_local4ps").checked ? "Yes" : "No",
  "National 4Ps": document.getElementById("ass_intl4ps").checked ? "Yes" : "No",
  "Local Social Pension": document.getElementById("ass_locsp").checked ? "Yes" : "No",
  "National Social Pension": document.getElementById("ass_intlsp").checked ? "Yes" : "No",
  "Solo Parent Assistance": document.getElementById("ass_solo").checked ? "Yes" : "No",
  "Relief Goods": document.getElementById("ass_relief").checked ? "Yes" : "No",
  "Cash Subsidy": document.getElementById("ass_cash").checked ? "Yes" : "No",
  "AICS": document.getElementById("ass_aics").value || "",
  /* Domestic animals ‚Äî store as separate fields matching your header */
  "Dog": document.getElementById("dog_chk").checked ? "Yes" : "No",
  "Dog Qty.": document.getElementById("dog_qty").value || "",
  "Cat": document.getElementById("cat_chk").checked ? "Yes" : "No",
  "Cat Qty.": document.getElementById("cat_qty").value || "",
  "Pig": document.getElementById("pig_chk").checked ? "Yes" : "No",
  "Pig Qty.": document.getElementById("pig_qty").value || "",
  "Cow": document.getElementById("cow_chk").checked ? "Yes" : "No",
  "Cow Qty.": document.getElementById("cow_qty").value || "",
  "Carabao": document.getElementById("carabao_chk").checked ? "Yes" : "No",
  "Carabao Qty.": document.getElementById("carabao_qty").value || "",
  "Chicken": document.getElementById("chicken_chk").checked ? "Yes" : "No",
  "Chicken Qty.": document.getElementById("chicken_qty").value || "",
  "Others": document.getElementById("animals_others").value || "",
  "Submitted By": currentUserFullName, // Use the full name instead of username
  "Submitted On": new Date().toLocaleString()
};

  // ensure members length matches selected
  const expected = parseInt(document.getElementById("memberCount").value || 0);
  const members = collectedMembers.slice(0);
  for(let i=0;i<expected;i++){
    if(!members[i]){
      members[i] = {
        "Name of Household Member/s": "",
        "FishR Registered/RBIS Registered": "",
        "Contact no.": "",
        "Sex": "",
        "Birthdate": "",
        "Age": "",
        "Stage": "",
        "PWD": "No",
        "Status": "",
        "Educational Attainment": "",
        "College Graduate Course": "",
        "Employment": "",
        "Job Title": "",
        "Overseas Filipino Worker(OFW)": "No",
        "Country": "",
        "Transportation": "",
        "Designated Pick-Up Point": "",
        "Pick-Up Location": "", // Added for compatibility
        "Drop-Off Point": "",
        "Drop-Off Location": "", // Added for compatibility
        "Name of Camp": "",
        "Evacuation Camp Name": "", // Added for compatibility
        "Capacity": "",
        "No. of Individuals Inside Camp": "",
        "Individuals Currently in Camp": "", // Added for compatibility
        "No. of Individuals Outside Camp": "",
        "Individuals Outside Camp": "", // Added for compatibility
        "Reasons for Displacement": "",
        "TUPAD": "No",
        "Local 4Ps": "No",
        "National 4Ps": "No",
        "Local Social Pension": "No",
        "National Social Pension": "No",
        "Solo Parent Assistance": "No",
        "Relief Goods": "No",
        "Cash Subsidy": "No",
        "AICS": ""
      };
    }
    // ensure birthdate format DD/MM/YYYY
    if(members[i]["Birthdate"]){
      members[i]["Birthdate"] = (members[i]["Birthdate"].indexOf('/') === -1) ? toSheetDateFormat(members[i]["Birthdate"]) : members[i]["Birthdate"];
    }
  }

  // Build request
// Get current user
const currentUser = localStorage.getItem("username") || 
                   localStorage.getItem("staffName") || 
                   "System";

// Build request
  const form = new FormData();
  form.append("action", "createRecord");
  form.append("actor", currentUserFullName);  // Use full name for actor
  form.append("head", JSON.stringify(head));
  form.append("members", JSON.stringify(members));
  form.append("submittedBy", currentUserFullName);  // Use full name for submittedBy

  // UI disable
  const submitBtn = document.getElementById("nextToMembers");
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

  try{
    console.log("Submitting HEAD:", head);
    console.log("Submitting MEMBERS:", members);
    const res = await fetch(API_URL, { method: "POST", body: form });
    const text = await res.text();
    console.log("RAW RESPONSE:", text);

    let data;
    try { data = JSON.parse(text); } catch (e) {
      // server returned non-JSON (error). Show raw.
      throw new Error("Invalid response from server: " + text);
    }

    if(data.success){
      showSuccess("Record saved successfully! (Data ID: " + (data.dataID || "n/a") + ")");
      // Redirect to records page after a delay
      setTimeout(() => {
        window.location.href = "records.html";
      }, 2000);
    } else {
      showError("Save failed: " + (data.message || "Unknown error"));
      console.error("SAVE ERROR:", data);
    }
  }catch(err){
    console.error("SUBMIT ERROR:", err);
    showError("Network / Server error: " + (err.message || err));
  }finally{
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-save"></i> Save & Continue to Members';
  }
}

/* ============ SIDEBAR COLLAPSE ============ */
function toggleSidebar() {
    const pageContainer = document.querySelector('.page-container');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const icon = sidebarToggle.querySelector('i');
    
    pageContainer.classList.toggle('collapsed');
    
    if (pageContainer.classList.contains('collapsed')) {
        icon.className = 'fas fa-chevron-right';
        sidebarToggle.title = "Expand sidebar";
    } else {
        icon.className = 'fas fa-bars';
        sidebarToggle.title = "Collapse sidebar";
    }
}

/* ============ MOBILE SIDEBAR TOGGLE ============ */
function toggleMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    const icon = mobileToggle.querySelector('i');
    
    sidebar.classList.toggle('mobile-open');
    
    if (sidebar.classList.contains('mobile-open')) {
        icon.className = 'fas fa-times';
        mobileToggle.title = "Close menu";
    } else {
        icon.className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
}

/* ============ CLOSE MOBILE SIDEBAR ON CLICK OUTSIDE ============ */
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    
    if (window.innerWidth <= 768) {
        if (!sidebar.contains(event.target) && !mobileToggle.contains(event.target) && sidebar.classList.contains('mobile-open')) {
            sidebar.classList.remove('mobile-open');
            mobileToggle.querySelector('i').className = 'fas fa-bars';
            mobileToggle.title = "Open menu";
        }
    }
});

/* ============ UI BINDINGS ============ */
// Desktop sidebar toggle
document.getElementById('sidebarToggle').onclick = toggleSidebar;

// Mobile sidebar toggle
document.getElementById('mobileMenuToggle').onclick = toggleMobileSidebar;

/* ============ WINDOW RESIZE HANDLER ============ */
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        // On desktop, ensure sidebar is not in mobile-open state
        const sidebar = document.getElementById('sidebar');
        const mobileToggle = document.getElementById('mobileMenuToggle');
        
        sidebar.classList.remove('mobile-open');
        mobileToggle.querySelector('i').className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
});

/* ============ INPUT WIDTH FIX ============ */
// Fix input widths when sidebar collapses/expands
const sidebarToggle = document.getElementById('sidebarToggle');
if (sidebarToggle) {
    sidebarToggle.addEventListener('click', function() {
        // Force reflow to fix input widths
        setTimeout(() => {
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.style.width = '100%';
            });
        }, 300); // Match the transition duration
    });
}

/* ============ VISIBILITY CHANGE HANDLER ============ */
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    // Tab became active - session is already monitored by session-manager.js
    // No need to check session manually
    console.log("Tab became active");
  }
});

/* ============ ADDITIONAL FUNCTIONS FOR MEMBER PANEL ============ */
function sessionCheck() {
  // This function should be implemented in session-manager.js
  return true;
}

function handleLogout() {
  // This function should be implemented in session-manager.js
  localStorage.clear();
  sessionStorage.clear();
  window.location.href = 'index.html';
}
</script>
<script src="common-utils.js"></script>
<script src="session-manager.js"></script>
<script src="common-session.js"></script>
<script src="activity-tracking-final.js"></script>
</body>
</html>
