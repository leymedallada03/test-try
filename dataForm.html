<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan ‚Äî Data Entry of household</title>
<link rel="stylesheet" href="styles.css"/>
<style>
.content-area{padding:18px; background:linear-gradient(180deg,#f6f8f7,#f4f6f5)}
.card{ padding:14px;border-radius:10px;background:#fff;margin-bottom:12px;box-shadow:0 6px 18px rgba(6,30,20,0.04) }
.form-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; align-items:start }
.small-muted{ font-size:13px; color:var(--muted) }
.member-preview{ margin-top:8px; font-size:14px }
.member-preview li{ margin-bottom:6px }
.member-panel { position: fixed; right: 0; top: 0; height: 100vh; width: 420px; max-width: 96%; background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,250,0.98)); box-shadow: -18px 0 40px rgba(6,30,20,0.12); transform: translateX(110%); transition: transform 280ms cubic-bezier(.2,.9,.3,1); z-index: 6000; padding: 18px; overflow-y: auto; }
.member-panel.open { transform: translateX(0%); }
.panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.32); opacity: 0; transition: opacity 200ms; pointer-events: none; z-index: 5900; }
.panel-overlay.show { opacity: 1; pointer-events: auto; }
.btn { border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;background: linear-gradient(90deg,#0f7a4a,#34b78f); color:#fff; }
.btn.secondary { background: transparent; color: var(--green-1); border:1px solid rgba(6,30,20,0.06); }
.radio-line{display:flex;gap:8px}
.icon-btn{border:0;background:transparent;cursor:pointer}
.actions-row{display:flex;gap:8px;justify-content:flex-end}
.assistance-grid {
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap:10px 18px;
  margin-top:10px;
}

.assistance-grid label {
  display:flex;
  align-items:center;
  gap:6px;
  font-size:15px;
  font-weight:600;
  color:#0b4630;
}
@media (max-width:900px){ .page-container{grid-template-columns:1fr} .sidebar{display:none} }
.hidden{display:none}

</style>
</head>
<body>
<div class="page-container">

  <header class="topbar">
    <button id="menuToggle" class="menu-btn" aria-label="Toggle menu" aria-expanded="true">‚ò∞</button>

    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div>
        <div class="title">PUROK KALIGTASAN</div>
        <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
      </div>
    </div>

    <div class="user-info">
      <span id="userName"></span>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <ul>
      <li><a href="dashboard.html">üìä Dashboard</a></li>
      <li><a href="dataForm.html" class="active">üìù Data Entry</a></li>
      <li><a href="records.html">üìÅ Records</a></li>
      <li><a href="charts.html">üìà Charts</a></li>
      <li class="admin-only"><a href="users.html">üë• User Management</a></li>
    </ul>
  </aside>

  <main class="content-area" tabindex="-1">
    <h2>üìù Household Evacuation Information (Head first)</h2>

    <form id="headForm" novalidate onsubmit="return false;">
      <div class="form-section card">
        <h3>Basic Information (Household Head)</h3>
        <div class="form-grid">
          <div>
            <label>Barangay <span class="small">*</span></label>
            <select id="barangay" required>
              <option value="">Select Barangay...</option>
              <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
              <option>Dalipit East</option><option>Dalipit West</option><option>Dominador East</option>
              <option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
              <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option>
              <option>Ping-As</option><option>Poblacion East</option><option>Poblacion West</option>
              <option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
            </select>
          </div>

          <div>
            <label>Sitio / Purok <span class="small">*</span></label>
            <select id="sitio" required>
              <option value="">Select...</option>
              <option>Purok I</option><option>Purok II</option><option>Purok III</option>
              <option>Purok IV</option><option>Purok V</option><option>Purok VI</option>
              <option>Purok VII</option>
            </select>
          </div>

          <div>
            <label>Name of Household Head <span class="small">*</span></label>
              <input type="text" id="householdHead" required />
          </div>

          <div>
            <label>Contact no.</label>
              <input type="text" id="contactNo" placeholder="09XXXXXXXXX" />
          </div>

          <div>
            <label>Sex <span class="small">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="head_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate</label>
            <input type="date" id="householdBirthdate" />
          </div>

          <div>
            <label>Age</label>
            <!-- changed to text so we can show "11 months" -->
            <input type="text" id="householdAge" readonly />
          </div>

          <div>
            <label>Stage</label>
            <input type="text" id="householdStage" readonly />
          </div>

          <div>
            <label>No. of Household Member/s <span class="small">*</span></label>
            <input type="number" id="memberCount" min="0" value="0" />
            <div class="small-muted">Set to 0 if no other members.</div>
          </div>
        </div>

        <hr style="margin:12px 0">

        <h4>Health and Status</h4>
        <div class="form-grid">
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_pwd" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="head_pwd" value="No" checked> No</label>
            </div>
          </div>

          <div>
            <label>Status</label>
            <select id="head_status">
              <option value="">Select...</option>
              <option>With Sickness</option><option>Pregnant</option><option>Solo Parent</option><option>Lactating</option><option>Severe Illness</option><option>HIV Positive</option><option>LGBTQ Plus</option>
            </select>
          </div>

          <div>
            <label>Transportation</label>
            <select id="head_transport">
              <option value="">Select...</option>
              <option>Individual with Transportation</option>
              <option>Individual needing Transportation</option>
            </select>
          </div>
        </div>

        <hr style="margin:12px 0">

        <h4>Pickup  / Transport / Camp Details</h4>
        <div class="form-grid">
          <div>
            <label>Designated Pick-Up Point</label>
            <input type="text" id="pickup" />
          </div>
          <div>
            <label>Drop-Off Point</label>
            <input type="text" id="dropoff" />
          </div>
          <div>
            <label>Name of Camp</label>
            <input type="text" id="campName" />
          </div>
          <div>
            <label>Capacity</label>
            <input type="number" id="capacity" min="0" />
          </div>
          <div>
            <label>No. of Individuals Inside Camp</label>
            <input type="number" id="insideCamp" min="0" value="0" />
          </div>
          <div>
            <label>No. of Individuals Outside Camp</label>
            <input type="number" id="outsideCamp" min="0" value="0" />
          </div>
        </div>

        <div class="form-grid">
          <div style="grid-column:1/-1">
            <label>Reasons for Displacement</label>
            <select id="reasons">
              <option value="">Select...</option>
              <option> Taal Volcano Eruption - With-in 14-15 KM Danger Zone</option>
              <option>Typhoon</option>
              <option>Flood/Landslide</option>
              <option>Earthquake</option>
              <option>Others</option>
            </select>
          </div>
        </div>

        <hr style="margin:12px 0">
        <h4>Government Support</h4>
        <div class="form-grid">
          <label><input type="checkbox" id="ass_tupad"> TUPAD</label>
          <label><input type="checkbox" id="ass_local4ps"> Local 4Ps</label>
          <label><input type="checkbox" id="ass_intl4ps"> National 4Ps</label>
          <label><input type="checkbox" id="ass_locsp"> Local Social Pension</label>
          <label><input type="checkbox" id="ass_intlsp"> National Social Pension</label>
          <label><input type="checkbox" id="ass_solo"> Solo Parent Assistance</label>
          <label><input type="checkbox" id="ass_relief"> Relief Goods</label>
          <label><input type="checkbox" id="ass_cash"> Cash Subsidy</label>
        </div>

        <div style="margin-top:8px">
          <label>AICS (if any)</label>
          <select id="ass_aics">
            <option value="">None</option>
            <option>Shelter Assistance</option>
            <option>Burial</option>
            <option>Scholarship</option>
          </select>
        </div>

        <div style="height:10px"></div>

        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="resetBtn" class="btn secondary" type="button">Reset</button>
          <button id="nextToMembers" class="btn" type="button">Save ‚Üí Next Members</button>
        </div>
      </div>

      <!-- preview of members to be added -->
      <div class="card">
        <h4>Members to be collected</h4>
        <div class="small-muted">Number of members chosen: <strong id="previewCount">0</strong></div>
        <ul id="membersPreview" class="member-preview"></ul>
      </div>
    </form>
  </main>
</div>

<!-- overlay + member panel -->
<div id="panelOverlay" class="panel-overlay" aria-hidden="true"></div>

<div id="memberPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Member entry panel">
  <div class="panel-header" style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
    <button id="panelClose" class="btn secondary" title="Close panel">‚Üê</button>
    <h3 id="panelTitle">Member 1 of N</h3>
  </div>

  <div class="panel-body">
    <form id="memberForm" onsubmit="return false;">
      <div class="form-grid">
        <div>
          <label>Member Name <span class="small">*</span></label>
          <input type="text" id="memberName" class="member-name" required />
        </div>        
<div>
  <label>Contact no.</label>
  <input type="text" id="memberContact" class="member-contact" placeholder="09XXXXXXXXX"/>
</div>
        <div>
          <label>Sex</label>
          <div class="radio-line">
            <label class="radio-item"><input type="radio" name="member_sex" value="Male" class="member-sex"> Male</label>
            <label class="radio-item"><input type="radio" name="member_sex" value="Female" class="member-sex"> Female</label>
          </div>
        </div>

        <div>
          <label>Birthdate</label>
          <input type="date" id="memberBirthdate" class="member-birthdate" />
        </div>

        <div>
          <label>Age</label>
          <!-- changed to text so we can show "11 months" -->
          <input type="text" id="memberAge" class="member-age" readonly />
        </div>

        <div>
          <label>PWD</label>
          <div class="radio-line">
            <label class="radio-item"><input type="radio" name="member_pwd" value="Yes" class="member-pwd"> Yes</label>
            <label class="radio-item"><input type="radio" name="member_pwd" value="No" checked class="member-pwd"> No</label>
          </div>
        </div>

        <div>
          <label>Stage</label>
          <input type="text" id="memberStage" class="member-stage" readonly />
        </div>

        <div>
          <label>Status</label>
          <select id="memberStatus" class="member-status">
             <option>With Sickness</option><option>Pregnant</option><option>Solo Parent</option><option>Lactating</option><option>Severe Illness</option><option>HIV Positive</option><option>LGBTQ Plus</option>
          </select>
        </div>

        <div>
          <label>Transportation</label>
          <select id="memberTransport" class="member-transport">
            <option value="">Select...</option>
            <option>Individual with Transportation</option>
            <option>Individual needing Transportation</option>
          </select>
        </div>

        <div>
          <label>Designated Pick-Up Point</label>
          <input type="text" id="memberPickup" class="member-pickup"/>
        </div>

        <div>
          <label>Drop-Off Point</label>
          <input type="text" id="memberDropoff" class="member-dropoff"/>
        </div>

        <div>
          <label>Name of Camp</label>
          <input type="text" id="memberCamp" class="member-camp"/>
        </div>

        <div>
          <label>Capacity</label>
          <input type="number" id="memberCampCap" class="member-cap" min="0"/>
        </div>

        <div>
          <label>No. of Individuals Inside Camp</label>
          <input type="number" id="memberInside" class="member-inside" min="0"/>
        </div>

        <div>
          <label>No. of Individuals Outside Camp</label>
          <input type="number" id="memberOutside" class="member-outside" min="0"/>
        </div>

        <div>
          <label>Reason</label>
          <select id="memberReason" class="member-reason">
              <option> Taal Volcano Eruption - With-in 14-15 KM Danger Zone</option>
              <option>Typhoon</option>
              <option>Flood/Landslide</option>
              <option>Earthquake</option>
              <option>Others</option>
          </select>
        </div>

        <div style="grid-column:1/-1; margin-top:8px">
          <h4 style="margin:6px 0 8px 0">Government Support</h4>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px 12px">
            <label><input type="checkbox" id="member_tupad" class="member_tupad"> TUPAD</label>
            <label><input type="checkbox" id="member_local4ps" class="member_local4ps"> Local 4Ps</label>
            <label><input type="checkbox" id="member_intl4ps" class="member_intl4ps"> National 4Ps</label>
            <label><input type="checkbox" id="member_locsp" class="member_locsp"> Local Social Pension</label>
            <label><input type="checkbox" id="member_intlsp" class="member_intlsp"> National Social Pension</label>
            <label><input type="checkbox" id="member_solo" class="member_solo"> Solo Parent Assistance</label>
            <label><input type="checkbox" id="member_cash" class="member_cash"> Cash Subsidy</label>
            <label><input type="checkbox" id="member_relief" class="member_relief"> Relief Goods</label>
          </div>

          <div style="margin-top:8px">
            <label>AICS (if any)</label>
            <select id="memberAics" class="member_aics">
              <option value="">None</option>
              <option>Shelter Assistance</option>
              <option>Burial</option>
              <option>Scholarship</option>
            </select>
          </div>
        </div>

      </div>

      <div class="panel-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="memberBack" class="btn secondary" type="button">Back</button>
        <button id="memberNext" class="btn" type="button">Save & Next</button>
      </div>
    </form>
  </div>
</div>

<script>
/* final merged client-side script (fixed for date format + infant age) */

const API_URL = "https://script.google.com/macros/s/AKfycbyB66g9Ashw5n5ZwaX2XZH8KE2OvAm-8uPAAOVsrF9W59u5Uyr-D0N-fZSC7wIyD4rXDw/exec";

/* ----------------- Date helpers ----------------- */
/* Convert yyyy-mm-dd (from input[type=date].value) into DD/MM/YYYY (text) */
function toSheetDateFormat(inputVal){
  if(!inputVal) return "";
  // inputVal expected 'yyyy-mm-dd'
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputVal)){
    const [y,m,d] = inputVal.split('-');
    return `${d}/${m}/${y}`;
  }
  // try parse fallback
  const dt = new Date(inputVal);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dd}/${mm}/${dt.getFullYear()}`;
  }
  return String(inputVal);
}

/* Convert DD/MM/YYYY back to yyyy-mm-dd for input[type=date] if needed */
function toInputDate(val){
  if(!val) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(val)){
    const [d,m,y] = val.split('/');
    return `${y}-${m}-${d}`;
  }
  // fallback parse
  const dt = new Date(val);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dt.getFullYear()}-${mm}-${dd}`;
  }
  return "";
}

/* ---------------- Age compute (detailed) ----------------
   returns { years, months, days, display, stage }
   display is:
     - "X days" if <1 month
     - "X months" if <1 year
     - "Y" (years) if >=1 year
   stage rules:
     - if years === 0:
         if months <= 10 -> "Infant"
         else -> "Children"
     - years <=17 -> "School Children"
     - years >=60 -> "Elderly"
     - else -> "Adult"
*/
function computeAgeDetailed(inputDateValue){
  if(!inputDateValue) return null;
  // accept yyyy-mm-dd or Date-like strings
  let d;
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputDateValue)){
    const parts = inputDateValue.split('-');
    d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
  } else {
    d = new Date(inputDateValue);
  }
  if(isNaN(d)) return null;

  const now = new Date();
  // normalize to midnight to avoid timezone offset surprises
  const birth = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  let years = today.getFullYear() - birth.getFullYear();
  let months = today.getMonth() - birth.getMonth();
  let days = today.getDate() - birth.getDate();

  if(days < 0){
    months -= 1;
    // get days in previous month
    const prev = new Date(today.getFullYear(), today.getMonth(), 0);
    days += prev.getDate();
  }
  if(months < 0){
    years -= 1;
    months += 12;
  }

  // determine display
  let display = "";
  if(years >= 1){
    display = String(years); // keep years as simple number string per your requirement
  } else {
    if(months >= 1){
      display = `${months} months`;
    } else {
      display = `${days} days`;
    }
  }

  // derive stage
  let stage = "";
  if(years === 0){
    if(months <= 10) stage = "Infant";
    else stage = "Children";
  } else if(years <= 17){
    stage = "School Children";
  } else if(years >= 60){
    stage = "Elderly";
  } else {
    stage = "Adult";
  }

  return { years: years, months: months, days: days, display: display, stage: stage };
}

/* ---------------- UI + state ---------------- */
function ensureLoginOrRedirect(){
  if(!localStorage.getItem("loggedIn")){ window.location.href = "main.html"; return false; }
  return true;
}

let membersToCollect = 0;
let currentMemberIndex = 0;
let collectedMembers = [];

/* update preview */
function updateMemberPreview(){
  const n = parseInt(document.getElementById("memberCount").value || 0);
  document.getElementById("previewCount").innerText = n;
  const list = document.getElementById("membersPreview");
  list.innerHTML = "";
  for(let i=0;i<n;i++){
    const mem = collectedMembers[i];
    const li = document.createElement('li');
    li.innerText = mem ? `#${i+1} ‚Äî ${mem["Name of Household Member/s"] || "(empty)"}` : `#${i+1} ‚Äî (empty)`;
    list.appendChild(li);
  }
}

/* fill member panel with existing or blank */
function fillMemberPanel(idx){
  const mem = collectedMembers[idx] || {};
  document.getElementById("memberName").value = mem["Name of Household Member/s"] || "";
  document.getElementById("memberContact").value = mem["Contact no."] || "";
  Array.from(document.getElementsByName("member_sex")).forEach(r => r.checked = (r.value === (mem["Sex"] || "")));
  document.getElementById("memberBirthdate").value = mem["Birthdate"] ? toInputDate(mem["Birthdate"]) : "";
  document.getElementById("memberAge").value = mem["Age"] || "";
  document.getElementById("memberStage").value = mem["Stage"] || "";
  document.getElementById("memberStatus").value = mem["Status"] || "";
  document.getElementById("memberTransport").value = mem["Transportation"] || "";
  document.getElementById("memberPickup").value = mem["Designated Pick-Up Point"] || "";
  document.getElementById("memberDropoff").value = mem["Drop-Off Point"] || "";
  document.getElementById("memberCamp").value = mem["Name of Camp"] || "";
  document.getElementById("memberCampCap").value = mem["Capacity"] || "";
  document.getElementById("memberInside").value = mem["No. of Individuals Inside Camp"] || "";
  document.getElementById("memberOutside").value = mem["No. of Individuals Outside Camp"] || "";
  document.getElementById("memberReason").value = mem["Reasons for Displacement"] || "";
  document.getElementById("member_tupad").checked = (mem["TUPAD"] === "Yes");
  document.getElementById("member_local4ps").checked = (mem["Local 4Ps"] === "Yes");
  document.getElementById("member_intl4ps").checked = (mem["National 4Ps"] === "Yes");
  document.getElementById("member_locsp").checked = (mem["Local Social Pension"] === "Yes");
  document.getElementById("member_intlsp").checked = (mem["National Social Pension"] === "Yes");
  document.getElementById("member_solo").checked = (mem["Solo Parent Assistance"] === "Yes");
  document.getElementById("member_relief").checked = (mem["Relief Goods"] === "Yes");
  document.getElementById("member_cash").checked = (mem["Cash Subsidy"] === "Yes");
  document.getElementById("memberAics").value = mem["AICS"] || "";
}

/* collect member panel inputs into object that matches Master sheet keys */
function collectMemberDataFromPanel(){
  const name = document.getElementById("memberName").value.trim();
  const sex = document.querySelector("input[name='member_sex']:checked")?.value || "";
  const birth_input = document.getElementById("memberBirthdate").value || "";
  const birth_for_sheet = toSheetDateFormat(birth_input);
  const ageObj = computeAgeDetailed(birth_input);
  const ageVal = ageObj ? ageObj.display : "";
  const stageVal = ageObj ? ageObj.stage : "";

 return {
  "Name of Household Member/s": name,
  "Sex": sex,
  "Birthdate": birth_for_sheet,
  "Age": ageVal,
  "Stage": stageVal,
  "Persons with Disability (PWD)": (document.querySelector("input[name='member_pwd']:checked")?.value || "No"),
  "Status": document.getElementById("memberStatus").value || "",
  "Transportation": document.getElementById("memberTransport").value || "",
  "Designated Pick-Up Point": document.getElementById("memberPickup").value || "",
  "Drop-Off Point": document.getElementById("memberDropoff").value || "",
  "Name of Camp": document.getElementById("memberCamp").value || "",
  "Capacity": document.getElementById("memberCampCap").value || "",
  "No. of Individuals Inside Camp": document.getElementById("memberInside").value || "",
  "No. of Individuals Outside Camp": document.getElementById("memberOutside").value || "",
  "Reasons for Displacement": document.getElementById("memberReason").value || "",
  "TUPAD": document.getElementById("member_tupad").checked ? "Yes" : "No",
  "Local 4Ps": document.getElementById("member_local4ps").checked ? "Yes" : "No",
  "National 4Ps": document.getElementById("member_intl4ps").checked ? "Yes" : "No",
  "Local Social Pension": document.getElementById("member_locsp").checked ? "Yes" : "No",
  "National Social Pension": document.getElementById("member_intlsp").checked ? "Yes" : "No",
  "Solo Parent Assistance": document.getElementById("member_solo").checked ? "Yes" : "No",
  "Relief Goods": document.getElementById("member_relief").checked ? "Yes" : "No",
  "Cash Subsidy": document.getElementById("member_cash").checked ? "Yes" : "No",
  "AICS": document.getElementById("memberAics").value || "",
  "Contact no.": document.getElementById("memberContact").value || ""
};
}

/* update member age/stage live when date changes */
document.addEventListener('input', (ev) => {
  if(ev.target && ev.target.id === "memberBirthdate"){
    const v = ev.target.value;
    const info = computeAgeDetailed(v);
    document.getElementById("memberAge").value = info ? info.display : "";
    document.getElementById("memberStage").value = info ? info.stage : "";
  }
  if(ev.target && ev.target.id === "householdBirthdate"){
    const v = ev.target.value;
    const info = computeAgeDetailed(v);
    document.getElementById("householdAge").value = info ? info.display : "";
    document.getElementById("householdStage").value = info ? info.stage : "";
  }
});

/* ---------------- DOM loaded bindings ---------------- */
document.addEventListener('DOMContentLoaded', () => {
  if(!ensureLoginOrRedirect()) return;
  document.getElementById("userName").innerText = localStorage.getItem("staffName") || "";

  // reset
  document.getElementById("resetBtn").addEventListener('click', () => {
    document.getElementById("headForm").reset();
    collectedMembers = [];
    updateMemberPreview();
    document.getElementById("householdAge").value = "";
    document.getElementById("householdStage").value = "";
  });

  // next (head -> members)
  document.getElementById("nextToMembers").addEventListener('click', () => {
    const barangay = document.getElementById("barangay").value.trim();
    const sitio = document.getElementById("sitio").value.trim();
    const headName = document.getElementById("householdHead").value.trim();
    if(!barangay || !sitio || !headName){ alert("Please fill Barangay, Sitio/Purok and Name of Household Head."); return; }

    membersToCollect = parseInt(document.getElementById("memberCount").value || 0);
    collectedMembers = []; currentMemberIndex = 0;
    updateMemberPreview();

    if(membersToCollect === 0){
      // no members -> submit head only
      submitHeadAndMembers();
      return;
    }

    // open member panel first
    fillMemberPanel(0);
    currentMemberIndex = 0;
    document.getElementById('panelTitle').innerText = `Member 1 of ${membersToCollect}`;
    openPanel();
  });

  // panel close/back
  document.getElementById("panelClose").addEventListener('click', () => { closePanel(); });
  document.getElementById("memberBack").addEventListener('click', () => {
    if(currentMemberIndex > 0){
      collectedMembers[currentMemberIndex] = collectMemberDataFromPanel();
      currentMemberIndex--;
      fillMemberPanel(currentMemberIndex);
      document.getElementById('panelTitle').innerText = `Member ${currentMemberIndex+1} of ${membersToCollect}`;
      updateMemberPreview();
    } else {
      closePanel();
    }
  });

  // memberNext (save & next)
  document.getElementById("memberNext").addEventListener('click', () => {
    const name = document.getElementById("memberName").value.trim();
    if(!name){ alert("Please enter member's name."); return; }

    collectedMembers[currentMemberIndex] = collectMemberDataFromPanel();
    updateMemberPreview();

    currentMemberIndex++;
    if(currentMemberIndex >= membersToCollect){
      // done
      closePanel();
      submitHeadAndMembers();
      return;
    }
    fillMemberPanel(currentMemberIndex);
    document.getElementById('panelTitle').innerText = `Member ${currentMemberIndex+1} of ${membersToCollect}`;
  });

  // live update household birthdate change (also handled by input listener)
  document.getElementById("householdBirthdate").addEventListener('change', () => {
    const info = computeAgeDetailed(document.getElementById("householdBirthdate").value);
    document.getElementById("householdAge").value = info ? info.display : "";
    document.getElementById("householdStage").value = info ? info.stage : "";
  });

  // preview initial
  updateMemberPreview();
});

/* ---------------- open / close panel helpers ---------------- */
function openPanel(){ document.getElementById("memberPanel").classList.add("open"); document.getElementById("panelOverlay").classList.add("show"); }
function closePanel(){ document.getElementById("memberPanel").classList.remove("open"); document.getElementById("panelOverlay").classList.remove("show"); }

/* ---------------- Submit head + members ---------------- */
async function submitHeadAndMembers(){
  // head birthdate -> DD/MM/YYYY
  const headBirthInput = document.getElementById("householdBirthdate").value || "";
  const headBirthForSheet = toSheetDateFormat(headBirthInput);
  const headAgeInfo = computeAgeDetailed(headBirthInput);
  const headAgeVal = headAgeInfo ? headAgeInfo.display : "";

const head = {
  "Barangay": document.getElementById("barangay").value || "",
  "Sitio / Purok": document.getElementById("sitio").value || "",
  "Name of Household Head": document.getElementById("householdHead").value || "",
  "Contact no.": document.getElementById("contactNo").value || "",
  "Sex": document.querySelector("input[name='head_sex']:checked")?.value || "",
  "Birthdate": headBirthForSheet,
  "Age": headAgeVal,
  "Stage": headAgeInfo ? headAgeInfo.stage : "",
  "No. of Household Member/s": document.getElementById("memberCount").value || "0",
  "Persons with Disability (PWD)": document.querySelector("input[name='head_pwd']:checked")?.value || "No",
  "Reasons for Displacement": document.getElementById("reasons").value || "",
  "Transportation": document.getElementById("head_transport").value || "",
  "Designated Pick-Up Point": document.getElementById("pickup").value || "",
  "Drop-Off Point": document.getElementById("dropoff").value || "",
  "Status": document.getElementById("head_status").value || "",
  "Name of Camp": document.getElementById("campName").value || "",
  "Capacity": document.getElementById("capacity").value || "",
  "No. of Individuals Inside Camp": document.getElementById("insideCamp").value || "",
  "No. of Individuals Outside Camp": document.getElementById("outsideCamp").value || "",
  "TUPAD": document.getElementById("ass_tupad").checked ? "Yes" : "No",
  "Local 4Ps": document.getElementById("ass_local4ps").checked ? "Yes" : "No",
  "National 4Ps": document.getElementById("ass_intl4ps").checked ? "Yes" : "No",
  "Local Social Pension": document.getElementById("ass_locsp").checked ? "Yes" : "No",
  "National Social Pension": document.getElementById("ass_intlsp").checked ? "Yes" : "No",
  "Solo Parent Assistance": document.getElementById("ass_solo").checked ? "Yes" : "No",
  "Relief Goods": document.getElementById("ass_relief").checked ? "Yes" : "No",
  "Cash Subsidy": document.getElementById("ass_cash").checked ? "Yes" : "No",
  "AICS": document.getElementById("ass_aics").value || "",
  "Submitted By": localStorage.getItem("staffName") || localStorage.getItem("username") || "Unknown",
  "Submitted On": new Date().toLocaleString()
};


  // ensure members array length matches count
  const expected = parseInt(document.getElementById("memberCount").value || 0);
  const members = collectedMembers.slice(0);
  for(let i=0;i<expected;i++){
    if(!members[i]){
      members[i] = {
        "Name of Household Member/s": "",
        "Sex": "",
        "Birthdate": "",
        "Age": "",
        "Stage": "",
        "Persons with Disability (PWD)": "No",
        "Status": "",
        "Transportation": "",
        "Designated Pick-Up Point": "",
        "Drop-Off Point": "",
        "Name of Camp": "",
        "Capacity": "",
        "No. of Individuals Inside Camp": "",
        "No. of Individuals Outside Camp": "",
        "Reasons for Displacement": "",
        "TUPAD": "No",
        "Local 4Ps": "No",
        "National 4Ps": "No",
        "Local Social Pension": "No",
        "National Social Pension": "No",
        "Solo Parent Assistance": "No",
        "Relief Goods": "No",
        "Cash Subsidy": "No",
        "AICS": ""
      };
    }
    // ensure any birthdate in members are DD/MM/YYYY
    if(members[i]["Birthdate"]){
      // if user saved a raw yyyy-mm-dd in some path, convert
      members[i]["Birthdate"] = (members[i]["Birthdate"].indexOf('/') === -1) ? toSheetDateFormat(members[i]["Birthdate"]) : members[i]["Birthdate"];
    }
  }

  // build FormData
  const form = new FormData();
  form.append("action","createRecord");
  form.append("head", JSON.stringify(head));
  form.append("members", JSON.stringify(members));
  form.append("submittedBy", localStorage.getItem("staffName") || localStorage.getItem("username") || "Unknown");

  // UI disable
  const submitBtn = document.getElementById("nextToMembers");
  submitBtn.disabled = true;
  submitBtn.innerText = "Saving...";

  try{
    console.log("Submitting HEAD:", head);
    console.log("Submitting MEMBERS:", members);
    const res = await fetch(API_URL, { method: "POST", body: form });
    const text = await res.text();
    console.log("RAW RESPONSE:", text);
    let data;
    try { data = JSON.parse(text); } catch(e){ throw new Error("Invalid response from server"); }

    if(data.success){
      alert("Record saved successfully! (Data ID: " + (data.dataID || "n/a") + ")");
      window.location.href = "records.html";
    } else {
      alert("Save failed: " + (data.message || "Unknown error"));
      console.error("SAVE ERROR:", data);
    }
  }catch(err){
    console.error("SUBMIT ERROR:", err);
    alert("Network / Server error. Check console.");
  }finally{
    submitBtn.disabled = false;
    submitBtn.innerText = "Save ‚Üí Next Members";
  }
}

</script>
</body>
</html>







