<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan ‚Äî Data Entry of household (Part 1)</title>
<link rel="stylesheet" href="styles.css"/>
<style>
/* Minimal embedded styles to preserve layout while you keep your styles.css */
.content-area{padding:18px; background:linear-gradient(180deg,#f6f8f7,#f4f6f5)}
.card{ padding:14px;border-radius:10px;background:#fff;margin-bottom:12px;box-shadow:0 6px 18px rgba(6,30,20,0.04) }
.form-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; align-items:start }
.small-muted{ font-size:13px; color:var(--muted) }
.member-preview{ margin-top:8px; font-size:14px }
.member-preview li{ margin-bottom:6px }
.member-panel { position: fixed; right: 0; top: 0; height: 100vh; width: 480px; max-width: 96%; background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,250,0.98)); box-shadow: -18px 0 40px rgba(6,30,20,0.12); transform: translateX(110%); transition: transform 280ms cubic-bezier(.2,.9,.3,1); z-index: 6000; padding: 18px; overflow-y: auto; }
.member-panel.open { transform: translateX(0%); }
.panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.32); opacity: 0; transition: opacity 200ms; pointer-events: none; z-index: 5900; }
.panel-overlay.show { opacity: 1; pointer-events: auto; }
.btn { border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;background: linear-gradient(90deg,#0f7a4a,#34b78f); color:#fff; }
.btn.secondary { background: transparent; color: var(--green-1); border:1px solid rgba(6,30,20,0.06); }
.radio-line{display:flex;gap:8px}
.hidden{display:none}
@media (max-width:900px){ .page-container{grid-template-columns:1fr} .sidebar{display:none} }
.animal-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
.animal-row input[type="number"]{ width:90px; padding:6px; border-radius:6px; border:1px solid #ddd; }
.animal-row label{ display:flex; gap:8px; align-items:center; }
</style>
</head>
<body>
<div class="page-container">

  <header class="topbar">
    <button id="menuToggle" class="menu-btn" aria-label="Toggle menu" aria-expanded="true">‚ò∞</button>

    <div class="brand" style="display:flex;align-items:center;gap:12px">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo" style="height:44px"/>
      <div>
        <div class="title">PUROK KALIGTASAN</div>
        <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
      </div>
    </div>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <div class="user-info"><span id="userName"></span></div>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar" style="width:220px;padding:12px">
    <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px">
      <li><a href="dashboard.html">üìä Dashboard</a></li>
      <li><a href="dataForm.html" class="active">üìù Data Entry</a></li>
      <li><a href="records.html">üìÅ Records</a></li>
      <li><a href="charts.html">üìà Charts</a></li>
      <li class="admin-only"><a href="users.html">üë• User Management</a></li>
    </ul>
  </aside>

  <main class="content-area" tabindex="-1" style="margin-left:236px">
    <h2>üìù Household Evacuation Information (Head first)</h2>

    <form id="headForm" novalidate onsubmit="return false;">
      <div class="form-section card">
        <h3>Basic Information (Household Head)</h3>

        <div class="form-grid">
          <div>
            <label>Barangay <span class="small">*</span></label>
            <select id="barangay" required>
              <option value="">Select Barangay...</option>
              <!-- keep your existing options or populate dynamically -->
              <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
              <option>Dalipit East</option><option>Dalipit West</option><option>Dominador East</option>
              <option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
              <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option>
              <option>Ping-As</option><option>Poblacion East</option><option>Poblacion West</option>
              <option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
            </select>
          </div>

          <div>
            <label>Coordinate (optional)</label>
            <input type="text" id="coordinate" placeholder="lat, lng (optional) ‚Äî e.g. 14.12345, 120.98765" />
            <div class="small-muted">Optional ‚Äî keep blank if not available.</div>
          </div>

          <div>
            <label>Sitio / Purok <span class="small">*</span></label>
            <select id="sitio" required>
              <option value="">Select...</option>
              <option>Purok I</option><option>Purok II</option><option>Purok III</option>
              <option>Purok IV</option><option>Purok V</option><option>Purok VI</option>
              <option>Purok VII</option>
            </select>
          </div>

          <div>
            <label>Name of Household Head <span class="small">*</span></label>
            <input type="text" id="householdHead" required />
          </div>

          <div>
            <label>Contact no.</label>
            <input type="text" id="contactNo" placeholder="09XXXXXXXXX" />
            <div class="small-muted">Format optional; store as text.</div>
          </div>

          <div>
            <label>Sex <span class="small">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="head_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate</label>
            <input type="date" id="householdBirthdate" />
          </div>

          <div>
            <label>Age</label>
            <input type="text" id="householdAge" readonly />
          </div>

          <div>
            <label>Stage</label>
            <input type="text" id="householdStage" readonly />
          </div>

          <div>
            <label>No. of Household Member/s <span class="small">*</span></label>
            <input type="number" id="memberCount" min="0" value="0" />
            <div class="small-muted">Set to 0 if no other members.</div>
          </div>
        </div>

        <hr style="margin:12px 0">

        <h4>Health and Status</h4>
        <div class="form-grid">
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label><input type="radio" name="head_pwd" value="Yes"> Yes</label>
              <label><input type="radio" name="head_pwd" value="No" checked> No</label>
            </div>
          </div>

          <div>
            <label>Status</label>
            <select id="head_status">
              <option value="">Select...</option>
              <option>With Sickness</option><option>Pregnant</option><option>Solo Parent</option><option>Lactating</option><option>Severe Illness</option><option>HIV Positive</option><option>LGBTQ Plus</option>
            </select>
          </div>

          <div>
            <label>Transportation</label>
            <select id="head_transport">
              <option value="">Select...</option>
              <option>Individual with Transportation</option>
              <option>Individual needing Transportation</option>
            </select>
          </div>
        </div>

        <hr style="margin:12px 0">

        <h4>Pickup / Transport / Camp Details</h4>
        <div class="form-grid">
          <div>
            <label>Designated Pick-Up Point</label>
            <input type="text" id="pickup" />
          </div>
          <div>
            <label>Drop-Off Point</label>
            <input type="text" id="dropoff" />
          </div>
          <div>
            <label>Name of Camp</label>
            <input type="text" id="campName" />
          </div>
          <div>
            <label>Capacity</label>
            <input type="number" id="capacity" min="0" />
          </div>
          <div>
            <label>No. of Individuals Inside Camp</label>
            <input type="number" id="insideCamp" min="0" value="0" />
          </div>
          <div>
            <label>No. of Individuals Outside Camp</label>
            <input type="number" id="outsideCamp" min="0" value="0" />
          </div>
        </div>

        <div class="form-grid">
          <div style="grid-column:1/-1">
            <label>Reasons for Displacement</label>
            <select id="reasons">
              <option value="">Select...</option>
              <option>With-in 14-15 KM Danger Zone</option>
              <option>Others</option>
            </select>
          </div>
        </div>

        <hr style="margin:12px 0">

        <h4>Domestic (Animals) ‚Äî Head</h4>
        <div id="headAnimals" class="card" style="padding:10px; margin-bottom:10px">
          <!-- For each animal we provide a checkbox (owner) and qty input -->
          <div class="animal-row">
            <label><input type="checkbox" id="head_animal_dog"> Dog</label>
            <input type="number" id="head_qty_dog" min="0" placeholder="Qty" />
          </div>

          <div class="animal-row">
            <label><input type="checkbox" id="head_animal_cat"> Cat</label>
            <input type="number" id="head_qty_cat" min="0" placeholder="Qty" />
          </div>

          <div class="animal-row">
            <label><input type="checkbox" id="head_animal_pig"> Pig</label>
            <input type="number" id="head_qty_pig" min="0" placeholder="Qty" />
          </div>

          <div class="animal-row">
            <label><input type="checkbox" id="head_animal_cow"> Cow</label>
            <input type="number" id="head_qty_cow" min="0" placeholder="Qty" />
          </div>

          <div class="animal-row">
            <label><input type="checkbox" id="head_animal_carabao"> Carabao</label>
            <input type="number" id="head_qty_carabao" min="0" placeholder="Qty" />
          </div>

          <div class="animal-row">
            <label><input type="checkbox" id="head_animal_chicken"> Chicken</label>
            <input type="number" id="head_qty_chicken" min="0" placeholder="Qty" />
          </div>

          <div class="animal-row">
            <label><input type="checkbox" id="head_animal_others"> Others</label>
            <input type="text" id="head_others_text" placeholder="Describe other animals" style="flex:1" />
            <input type="number" id="head_qty_others" min="0" placeholder="Qty" style="width:90px" />
          </div>
        </div>

        <hr style="margin:12px 0">
        <h4>Government Support</h4>
        <div class="form-grid">
          <label><input type="checkbox" id="ass_tupad"> TUPAD</label>
          <label><input type="checkbox" id="ass_local4ps"> Local 4Ps</label>
          <label><input type="checkbox" id="ass_intl4ps"> National 4Ps</label>
          <label><input type="checkbox" id="ass_locsp"> Local Social Pension</label>
          <label><input type="checkbox" id="ass_intlsp"> National Social Pension</label>
          <label><input type="checkbox" id="ass_solo"> Solo Parent Assistance</label>
          <label><input type="checkbox" id="ass_relief"> Relief Goods</label>
          <label><input type="checkbox" id="ass_cash"> Cash Subsidy</label>
        </div>

        <div style="margin-top:8px">
          <label>AICS (if any)</label>
          <select id="ass_aics">
            <option value="">None</option>
            <option>Shelter Assistance</option>
            <option>Burial</option>
            <option>Scholarship</option>
          </select>
        </div>

        <div style="height:10px"></div>

        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="resetBtn" class="btn secondary" type="button">Reset</button>
          <button id="nextToMembers" class="btn" type="button">Save ‚Üí Next Members</button>
        </div>
      </div>

      <!-- preview + member list -->
      <div class="card" style="margin-left:0">
        <h4>Members to be collected</h4>
        <div class="small-muted">Number of members chosen: <strong id="previewCount">0</strong></div>
        <ul id="membersPreview" class="member-preview"></ul>
      </div>
    </form>
  </main>
</div>

<!-- overlay + member panel (member panel includes Contact no. + animal block identical to head) -->
<div id="panelOverlay" class="panel-overlay" aria-hidden="true"></div>

<div id="memberPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Member entry panel">
  <div class="panel-header" style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
    <button id="panelClose" class="btn secondary" title="Close panel">‚Üê</button>
    <h3 id="panelTitle">Member 1 of N</h3>
  </div>

  <div class="panel-body">
    <form id="memberForm" onsubmit="return false;">
      <div class="form-grid">
        <div>
          <label>Member Name <span class="small">*</span></label>
          <input type="text" id="memberName" class="member-name" required />
        </div>

        <div>
          <label>Contact no.</label>
          <input type="text" id="memberContact" class="member-contact" placeholder="09XXXXXXXXX" />
        </div>

        <div>
          <label>Sex</label>
          <div class="radio-line">
            <label class="radio-item"><input type="radio" name="member_sex" value="Male" class="member-sex"> Male</label>
            <label class="radio-item"><input type="radio" name="member_sex" value="Female" class="member-sex"> Female</label>
          </div>
        </div>

        <div>
          <label>Birthdate</label>
          <input type="date" id="memberBirthdate" class="member-birthdate" />
        </div>

        <div>
          <label>Age</label>
          <input type="text" id="memberAge" class="member-age" readonly />
        </div>

        <div>
          <label>PWD</label>
          <div class="radio-line">
            <label class="radio-item"><input type="radio" name="member_pwd" value="Yes" class="member-pwd"> Yes</label>
            <label class="radio-item"><input type="radio" name="member_pwd" value="No" checked class="member-pwd"> No</label>
          </div>
        </div>

        <div>
          <label>Stage</label>
          <input type="text" id="memberStage" class="member-stage" readonly />
        </div>

        <div>
          <label>Status</label>
          <select id="memberStatus" class="member-status">
            <option value="">Select...</option><option>With Sickness</option><option>Pregnant</option>
          </select>
        </div>

        <div>
          <label>Transportation</label>
          <select id="memberTransport" class="member-transport">
            <option value="">Select...</option>
            <option>Individual with Transportation</option>
            <option>Individual needing Transportation</option>
          </select>
        </div>

        <div>
          <label>Designated Pick-Up Point</label>
          <input type="text" id="memberPickup" class="member-pickup"/>
        </div>

        <div>
          <label>Drop-Off Point</label>
          <input type="text" id="memberDropoff" class="member-dropoff"/>
        </div>

        <div>
          <label>Name of Camp</label>
          <input type="text" id="memberCamp" class="member-camp"/>
        </div>

        <div>
          <label>Capacity</label>
          <input type="number" id="memberCampCap" class="member-cap" min="0"/>
        </div>

        <div>
          <label>No. of Individuals Inside Camp</label>
          <input type="number" id="memberInside" class="member-inside" min="0"/>
        </div>

        <div>
          <label>No. of Individuals Outside Camp</label>
          <input type="number" id="memberOutside" class="member-outside" min="0"/>
        </div>

        <div>
          <label>Reason</label>
          <select id="memberReason" class="member-reason">
            <option value="">Select...</option><option>With-in 14-15 KM Danger Zone</option><option>Others</option>
          </select>
        </div>

        <!-- Member Domestic (animals) block ‚Äî same animals + qty fields as head -->
        <div style="grid-column:1/-1; margin-top:8px">
          <h4 style="margin:6px 0 8px 0">Domestic (Animals) ‚Äî Member</h4>

          <div id="memberAnimals">
            <div class="animal-row">
              <label><input type="checkbox" id="member_animal_dog"> Dog</label>
              <input type="number" id="member_qty_dog" min="0" placeholder="Qty" />
            </div>

            <div class="animal-row">
              <label><input type="checkbox" id="member_animal_cat"> Cat</label>
              <input type="number" id="member_qty_cat" min="0" placeholder="Qty" />
            </div>

            <div class="animal-row">
              <label><input type="checkbox" id="member_animal_pig"> Pig</label>
              <input type="number" id="member_qty_pig" min="0" placeholder="Qty" />
            </div>

            <div class="animal-row">
              <label><input type="checkbox" id="member_animal_cow"> Cow</label>
              <input type="number" id="member_qty_cow" min="0" placeholder="Qty" />
            </div>

            <div class="animal-row">
              <label><input type="checkbox" id="member_animal_carabao"> Carabao</label>
              <input type="number" id="member_qty_carabao" min="0" placeholder="Qty" />
            </div>

            <div class="animal-row">
              <label><input type="checkbox" id="member_animal_chicken"> Chicken</label>
              <input type="number" id="member_qty_chicken" min="0" placeholder="Qty" />
            </div>

            <div class="animal-row">
              <label><input type="checkbox" id="member_animal_others"> Others</label>
              <input type="text" id="member_others_text" placeholder="Describe other animals" style="flex:1" />
              <input type="number" id="member_qty_others" min="0" placeholder="Qty" style="width:90px" />
            </div>
          </div>
        </div>

      </div>

      <div class="panel-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="memberBack" class="btn secondary" type="button">Back</button>
        <button id="memberNext" class="btn" type="button">Save & Next</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ---------------- Age compute (detailed) ----------------
   returns { years, months, days, display, stage }
*/
function computeAgeDetailed(inputDateValue){
  if(!inputDateValue) return null;
  let d;
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputDateValue)){
    const parts = inputDateValue.split('-');
    d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
  } else {
    d = new Date(inputDateValue);
  }
  if(isNaN(d)) return null;

  const now = new Date();
  const birth = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const today = new Date(now.getFullYear(), now.getMonth(), todayDay() );

  function todayDay(){ const n = new Date(); return n.getDate(); } // small helper

  let years = today.getFullYear() - birth.getFullYear();
  let months = today.getMonth() - birth.getMonth();
  let days = today.getDate() - birth.getDate();

  if(days < 0){
    months -= 1;
    const prev = new Date(today.getFullYear(), today.getMonth(), 0);
    days += prev.getDate();
  }
  if(months < 0){
    years -= 1;
    months += 12;
  }

  let display = "";
  if(years >= 1){
    display = String(years);
  } else {
    if(months >= 1) display = `${months} months`;
    else display = `${days} days`;
  }

  let stage = "";
  if(years === 0) {
    if(months <= 10) stage = "Infant"; else stage = "Children";
  } else if(years <= 17) stage = "School Children";
  else if(years >= 60) stage = "Elderly";
  else stage = "Adult";

  return { years, months, days, display, stage };
}

/* ---------------- UI + state ---------------- */
function ensureLoginOrRedirect(){
  // keep your previous behaviour; remove if not required
  if(!localStorage.getItem("loggedIn")){ /*window.location.href = "main.html";*/ return false; }
  return true;
}

let membersToCollect = 0;
let currentMemberIndex = 0;
let collectedMembers = [];

/* ---------------- Preview update ---------------- */
function updateMemberPreview(){
  const n = parseInt(document.getElementById("memberCount").value || 0);
  document.getElementById("previewCount").innerText = n;
  const list = document.getElementById("membersPreview");
  list.innerHTML = "";
  for(let i=0;i<n;i++){
    const mem = collectedMembers[i];
    const li = document.createElement('li');

    if(mem){
      const name = mem["Name of Household Member/s"] || "(no name)";
      const contact = mem["Contact no."] || mem["Contact"] || "";
      // animal summary
      const animals = [];
      if(mem["Dog"] && mem["Dog Qty"]) animals.push(`Dog x${mem["Dog Qty"]}`);
      else if(mem["Dog"]) animals.push("Dog");
      if(mem["Cat"] && mem["Cat Qty"]) animals.push(`Cat x${mem["Cat Qty"]}`);
      if(mem["Pig"] && mem["Pig Qty"]) animals.push(`Pig x${mem["Pig Qty"]}`);
      if(mem["Cow"] && mem["Cow Qty"]) animals.push(`Cow x${mem["Cow Qty"]}`);
      if(mem["Carabao"] && mem["Carabao Qty"]) animals.push(`Carabao x${mem["Carabao Qty"]}`);
      if(mem["Chicken"] && mem["Chicken Qty"]) animals.push(`Chicken x${mem["Chicken Qty"]}`);
      if(mem["Others"] && mem["Others Qty"]) animals.push(`${mem["Others"]} x${mem["Others Qty"]}`);

      const animalText = animals.length ? ` ‚Äî ${animals.join(", ")}` : "";

      li.innerText = `#${i+1} ‚Äî ${name}${contact ? " ("+contact+")" : ""}${animalText}`;
    } else {
      li.innerText = `#${i+1} ‚Äî (empty)`;
    }
    li.style.cursor = "pointer";
    li.title = "Click to edit this member";
    li.addEventListener('click', () => {
      // open panel on this index for editing
      currentMemberIndex = i;
      fillMemberPanel(i);
      document.getElementById('panelTitle').innerText = `Member ${i+1} of ${n}`;
      openPanel();
    });
    list.appendChild(li);
  }
}

/* ---------------- Fill member panel ---------------- */
function fillMemberPanel(idx){
  const mem = collectedMembers[idx] || {};
  document.getElementById("memberName").value = mem["Name of Household Member/s"] || "";
  document.getElementById("memberContact").value = mem["Contact no."] || mem["Contact"] || "";
  Array.from(document.getElementsByName("member_sex")).forEach(r => r.checked = (r.value === (mem["Sex"] || "")));
  document.getElementById("memberBirthdate").value = mem["Birthdate"] ? toInputDate(mem["Birthdate"]) : "";
  document.getElementById("memberAge").value = mem["Age"] || "";
  document.getElementById("memberStage").value = mem["Stage"] || "";
  document.getElementById("memberStatus").value = mem["Status"] || "";
  document.getElementById("memberTransport").value = mem["Transportation"] || "";
  document.getElementById("memberPickup").value = mem["Designated Pick-Up Point"] || "";
  document.getElementById("memberDropoff").value = mem["Drop-Off Point"] || "";
  document.getElementById("memberCamp").value = mem["Name of Camp"] || "";
  document.getElementById("memberCampCap").value = mem["Capacity"] || "";
  document.getElementById("memberInside").value = mem["No. of Individuals Inside Camp"] || "";
  document.getElementById("memberOutside").value = mem["No. of Individuals Outside Camp"] || "";
  document.getElementById("memberReason").value = mem["Reasons for Displacement"] || "";

  // animals
  document.getElementById("member_animal_dog").checked = !!mem["Dog"];
  document.getElementById("member_qty_dog").value = mem["Dog Qty"] || "";

  document.getElementById("member_animal_cat").checked = !!mem["Cat"];
  document.getElementById("member_qty_cat").value = mem["Cat Qty"] || "";

  document.getElementById("member_animal_pig").checked = !!mem["Pig"];
  document.getElementById("member_qty_pig").value = mem["Pig Qty"] || "";

  document.getElementById("member_animal_cow").checked = !!mem["Cow"];
  document.getElementById("member_qty_cow").value = mem["Cow Qty"] || "";

  document.getElementById("member_animal_carabao").checked = !!mem["Carabao"];
  document.getElementById("member_qty_carabao").value = mem["Carabao Qty"] || "";

  document.getElementById("member_animal_chicken").checked = !!mem["Chicken"];
  document.getElementById("member_qty_chicken").value = mem["Chicken Qty"] || "";

  document.getElementById("member_animal_others").checked = !!mem["Others"];
  document.getElementById("member_others_text").value = mem["Others"] || "";
  document.getElementById("member_qty_others").value = mem["Others Qty"] || "";
}

/* ---------------- toInputDate helper ---------------- */
/* Convert DD/MM/YYYY back to yyyy-mm-dd for input[type=date] if needed */
function toInputDate(val){
  if(!val) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(val)){
    const [d,m,y] = val.split('/');
    return `${y}-${m}-${d}`;
  }
  // fallback: try Date parse
  const dt = new Date(val);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dt.getFullYear()}-${mm}-${dd}`;
  }
  return "";
}

/* ---------------- Collect member panel inputs ---------------- */
function collectMemberDataFromPanel(){
  const name = document.getElementById("memberName").value.trim();
  const contact = document.getElementById("memberContact").value.trim();
  const sex = document.querySelector("input[name='member_sex']:checked")?.value || "";
  const birth_input = document.getElementById("memberBirthdate").value || "";
  const birth_for_sheet = toSheetDateFormat(birth_input);
  const ageObj = computeAgeDetailed(birth_input);
  const ageVal = ageObj ? ageObj.display : "";
  const stageVal = ageObj ? ageObj.stage : "";

  // animals -> use clear keys (see note at top)
  const dogOwner = document.getElementById("member_animal_dog").checked;
  const dogQty = document.getElementById("member_qty_dog").value || "";

  const catOwner = document.getElementById("member_animal_cat").checked;
  const catQty = document.getElementById("member_qty_cat").value || "";

  const pigOwner = document.getElementById("member_animal_pig").checked;
  const pigQty = document.getElementById("member_qty_pig").value || "";

  const cowOwner = document.getElementById("member_animal_cow").checked;
  const cowQty = document.getElementById("member_qty_cow").value || "";

  const carabaoOwner = document.getElementById("member_animal_carabao").checked;
  const carabaoQty = document.getElementById("member_qty_carabao").value || "";

  const chickenOwner = document.getElementById("member_animal_chicken").checked;
  const chickenQty = document.getElementById("member_qty_chicken").value || "";

  const othersOwner = document.getElementById("member_animal_others").checked;
  const othersText = document.getElementById("member_others_text").value.trim();
  const othersQty = document.getElementById("member_qty_others").value || "";

  return {
    "Name of Household Member/s": name,
    "Contact no.": contact,
    "Sex": sex,
    "Birthdate": birth_for_sheet,
    "Age": ageVal,
    "Stage": stageVal,
    "Persons with Disability (PWD)": (document.querySelector("input[name='member_pwd']:checked")?.value || "No"),
    "Status": document.getElementById("memberStatus").value || "",
    "Transportation": document.getElementById("memberTransport").value || "",
    "Designated Pick-Up Point": document.getElementById("memberPickup").value || "",
    "Drop-Off Point": document.getElementById("memberDropoff").value || "",
    "Name of Camp": document.getElementById("memberCamp").value || "",
    "Capacity": document.getElementById("memberCampCap").value || "",
    "No. of Individuals Inside Camp": document.getElementById("memberInside").value || "",
    "No. of Individuals Outside Camp": document.getElementById("memberOutside").value || "",
    "Reasons for Displacement": document.getElementById("memberReason").value || "",
    "TUPAD": document.getElementById("member_tupad") ? (document.getElementById("member_tupad").checked ? "Yes" : "No") : "No",
    "Local 4Ps": document.getElementById("member_local4ps") ? (document.getElementById("member_local4ps").checked ? "Yes" : "No") : "No",
    "National 4Ps": document.getElementById("member_intl4ps") ? (document.getElementById("member_intl4ps").checked ? "Yes" : "No") : "No",
    "Local Social Pension": document.getElementById("member_locsp") ? (document.getElementById("member_locsp").checked ? "Yes" : "No") : "No",
    "National Social Pension": document.getElementById("member_intlsp") ? (document.getElementById("member_intlsp").checked ? "Yes" : "No") : "No",
    "Solo Parent Assistance": document.getElementById("member_solo") ? (document.getElementById("member_solo").checked ? "Yes" : "No") : "No",
    "Relief Goods": document.getElementById("member_relief") ? (document.getElementById("member_relief").checked ? "Yes" : "No") : "No",
    "Cash Subsidy": document.getElementById("member_cash") ? (document.getElementById("member_cash").checked ? "Yes" : "No") : "No",
    "AICS": document.getElementById("memberAics").value || "",

    /* animal keys */
    "Dog": dogOwner ? "Yes" : "",
    "Dog Qty": dogQty || "",
    "Cat": catOwner ? "Yes" : "",
    "Cat Qty": catQty || "",
    "Pig": pigOwner ? "Yes" : "",
    "Pig Qty": pigQty || "",
    "Cow": cowOwner ? "Yes" : "",
    "Cow Qty": cowQty || "",
    "Carabao": carabaoOwner ? "Yes" : "",
    "Carabao Qty": carabaoQty || "",
    "Chicken": chickenOwner ? "Yes" : "",
    "Chicken Qty": chickenQty || "",
    "Others": othersOwner ? (othersText || "Others") : "",
    "Others Qty": othersQty || ""
  };
}

/* ---------------- toSheetDateFormat helper ---------------- */
function toSheetDateFormat(inputVal){
  if(!inputVal) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputVal)){
    const [y,m,d] = inputVal.split('-');
    return `${d}/${m}/${y}`;
  }
  const dt = new Date(inputVal);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dd}/${mm}/${dt.getFullYear()}`;
  }
  return String(inputVal);
}

/* ---------------- open / close panel helpers ---------------- */
function openPanel(){ document.getElementById("memberPanel").classList.add("open"); document.getElementById("panelOverlay").classList.add("show"); }
function closePanel(){ document.getElementById("memberPanel").classList.remove("open"); document.getElementById("panelOverlay").classList.remove("show"); }

/* ---------------- DOM loaded bindings ---------------- */
document.addEventListener('DOMContentLoaded', () => {
  // optional login redirect - adjust to your needs
  // ensureLoginOrRedirect();

  // show staff name if present
  if(document.getElementById("userName")) document.getElementById("userName").innerText = localStorage.getItem("staffName") || "";

  // Reset button
  document.getElementById("resetBtn").addEventListener('click', () => {
    document.getElementById("headForm").reset();
    collectedMembers = [];
    updateMemberPreview();
    document.getElementById("householdAge").value = "";
    document.getElementById("householdStage").value = "";

    // clear head animal qtys
    ['dog','cat','pig','cow','carabao','chicken','others'].forEach(k => {
      const cb = document.getElementById(`head_animal_${k}`);
      const qty = document.getElementById(`head_qty_${k}`);
      if(cb) cb.checked = false;
      if(qty) qty.value = "";
    });
    document.getElementById("head_others_text") && (document.getElementById("head_others_text").value = "");
  });

  // Next (head -> members)
  document.getElementById("nextToMembers").addEventListener('click', () => {
    const barangay = document.getElementById("barangay").value.trim();
    const sitio = document.getElementById("sitio").value.trim();
    const headName = document.getElementById("householdHead").value.trim();
    if(!barangay || !sitio || !headName){ alert("Please fill Barangay, Sitio/Purok and Name of Household Head."); return; }

    membersToCollect = parseInt(document.getElementById("memberCount").value || 0);
    collectedMembers = []; currentMemberIndex = 0;
    updateMemberPreview();

    if(membersToCollect === 0){
      // no members -> caller will submit. (Part 3 will implement submitHeadAndMembers)
      alert("No members to collect. Proceed to save (Part 3 handles submission).");
      return;
    }

    // open first member panel
    fillMemberPanel(0);
    currentMemberIndex = 0;
    document.getElementById('panelTitle').innerText = `Member 1 of ${membersToCollect}`;
    openPanel();
  });

  // panel close/back
  document.getElementById("panelClose").addEventListener('click', () => { closePanel(); });
  document.getElementById("memberBack").addEventListener('click', () => {
    if(currentMemberIndex > 0){
      // save current
      collectedMembers[currentMemberIndex] = collectMemberDataFromPanel();
      currentMemberIndex--;
      fillMemberPanel(currentMemberIndex);
      document.getElementById('panelTitle').innerText = `Member ${currentMemberIndex+1} of ${membersToCollect}`;
      updateMemberPreview();
    } else {
      closePanel();
    }
  });

  // memberNext (save & next)
  document.getElementById("memberNext").addEventListener('click', () => {
    const name = document.getElementById("memberName").value.trim();
    if(!name){ alert("Please enter member's name."); return; }

    collectedMembers[currentMemberIndex] = collectMemberDataFromPanel();
    updateMemberPreview();

    currentMemberIndex++;
    if(currentMemberIndex >= membersToCollect){
      // done collecting members - close and let Part 3 handle submission
      closePanel();
      alert("All members collected. Now you can save ‚Äî Part 3 will submit head + members to the server.");
      return;
    }
    fillMemberPanel(currentMemberIndex);
    document.getElementById('panelTitle').innerText = `Member ${currentMemberIndex+1} of ${membersToCollect}`;
  });

  // Live age compute for member + head
  document.addEventListener('input', (ev) => {
    if(ev.target && ev.target.id === "memberBirthdate"){
      const v = ev.target.value;
      const info = computeAgeDetailed(v);
      document.getElementById("memberAge").value = info ? info.display : "";
      document.getElementById("memberStage").value = info ? info.stage : "";
    }
    if(ev.target && ev.target.id === "householdBirthdate"){
      const v = ev.target.value;
      const info = computeAgeDetailed(v);
      document.getElementById("householdAge").value = info ? info.display : "";
      document.getElementById("householdStage").value = info ? info.stage : "";
    }
  });

  // initial preview
  updateMemberPreview();
});
</script>
<script>

const API_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec"; 

/* ------------------ Toast UI ------------------ */
function showToast(msg, type="info"){
  let box = document.createElement("div");
  box.className = "toast "+type;
  box.innerText = msg;
  document.body.appendChild(box);
  setTimeout(()=> box.classList.add("show"), 50);
  setTimeout(()=> {
    box.classList.remove("show");
    setTimeout(()=> box.remove(), 400);
  }, 2600);
}

/* Toast CSS */
const toastStyle = document.createElement("style");
toastStyle.innerHTML = `
.toast {
  position: fixed;
  bottom: 25px;
  right: 25px;
  background: #333;
  color: #fff;
  padding: 14px 20px;
  border-radius: 8px;
  opacity: 0;
  transition: all .4s;
  z-index: 99999;
}
.toast.show {
  opacity: 1;
  transform: translateY(-10px);
}
.toast.success { background:#2e7d32; }
.toast.error { background:#c62828; }
`;
document.head.appendChild(toastStyle);

/* ----------------- HEAD data collector ----------------- */
function collectHeadData(){
  const birth_input = document.getElementById("householdBirthdate").value;
  const birth_sheet = toSheetDateFormat(birth_input);
  const ageObj = computeAgeDetailed(birth_input);

  const dog = document.getElementById("head_animal_dog").checked;
  const cat = document.getElementById("head_animal_cat").checked;
  const pig = document.getElementById("head_animal_pig").checked;
  const cow = document.getElementById("head_animal_cow").checked;
  const carabao = document.getElementById("head_animal_carabao").checked;
  const chicken = document.getElementById("head_animal_chicken").checked;
  const others = document.getElementById("head_animal_others").checked;

  return {
    "Coordinate": document.getElementById("coordinate").value.trim(),
    "Barangay": document.getElementById("barangay").value.trim(),
    "Sitio / Purok": document.getElementById("sitio").value.trim(),
    "Name of Household Head": document.getElementById("householdHead").value.trim(),
    "Contact no.": document.getElementById("householdContact").value.trim(),
    "Sex": document.querySelector("input[name='household_sex']:checked")?.value || "",
    "Birthdate": birth_sheet,
    "Age": ageObj ? ageObj.display : "",
    "Stage": ageObj ? ageObj.stage : "",
    "No. of Household Member/s": document.getElementById("memberCount").value || "",

    /* government support */
    "Persons with Disability (PWD)": document.querySelector("input[name='household_pwd']:checked")?.value || "No",
    "Status": document.getElementById("householdStatus").value || "",
    "Transportation": document.getElementById("householdTransport").value || "",
    "Designated Pick-Up Point": document.getElementById("householdPickup").value || "",
    "Drop-Off Point": document.getElementById("householdDropoff").value || "",
    "Name of Camp": document.getElementById("householdCamp").value || "",
    "Capacity": document.getElementById("householdCampCap").value || "",
    "No. of Individuals Inside Camp": document.getElementById("householdInside").value || "",
    "No. of Individuals Outside Camp": document.getElementById("householdOutside").value || "",
    "Reasons for Displacement": document.getElementById("householdReason").value || "",

    "TUPAD": document.getElementById("head_tupad")?.checked ? "Yes":"No",
    "Local 4Ps": document.getElementById("head_local4ps")?.checked ? "Yes":"No",
    "National 4Ps": document.getElementById("head_intl4ps")?.checked ? "Yes":"No",
    "Local Social Pension": document.getElementById("head_locsp")?.checked ? "Yes":"No",
    "National Social Pension": document.getElementById("head_intlsp")?.checked ? "Yes":"No",
    "Solo Parent Assistance": document.getElementById("head_solo")?.checked ? "Yes":"No",
    "Cash Subsidy": document.getElementById("head_cash")?.checked ? "Yes":"No",
    "Relief Goods": document.getElementById("head_relief")?.checked ? "Yes":"No",
    "AICS": document.getElementById("householdAics").value || "",

    /* -------- Domestic animals (HEAD) -------- */
    "Dog": dog ? "Yes" : "",
    "Dog Qty": dog ? document.getElementById("head_qty_dog").value : "",
    "Cat": cat ? "Yes" : "",
    "Cat Qty": cat ? document.getElementById("head_qty_cat").value : "",
    "Pig": pig ? "Yes" : "",
    "Pig Qty": pig ? document.getElementById("head_qty_pig").value : "",
    "Cow": cow ? "Yes" : "",
    "Cow Qty": cow ? document.getElementById("head_qty_cow").value : "",
    "Carabao": carabao ? "Yes" : "",
    "Carabao Qty": carabao ? document.getElementById("head_qty_carabao").value : "",
    "Chicken": chicken ? "Yes" : "",
    "Chicken Qty": chicken ? document.getElementById("head_qty_chicken").value : "",
    "Others": others ? (document.getElementById("head_others_text").value || "Others") : "",
    "Others Qty": others ? document.getElementById("head_qty_others").value : "",
  };
}

/* -------------- Final Submit (SEND TO GOOGLE SHEETS) ---------------- */
async function submitHeadAndMembers() {
  try {
    // validate
    const barangay = document.getElementById("barangay").value.trim();
    const sitio = document.getElementById("sitio").value.trim();
    const headName = document.getElementById("householdHead").value.trim();

    if(!barangay || !sitio || !headName){
      showToast("Please complete Barangay, Sitio and Head Name","error");
      return;
    }

    /* HEAD */
    const headObj = collectHeadData();

    /* MEMBERS collected from Part 2 */
    const members = [...collectedMembers];

    /* SubmittedBy = staff full name */
    const submittedBy = localStorage.getItem("staffName") || "Unknown";

    /* Build final payload */
    const payload = {
      action: "createRecord",
      payload: JSON.stringify({
        head: headObj,
        members: members,
        submittedBy: submittedBy
      })
    };

    showToast("Saving, please wait...");

    /* SEND POST */
    const res = await fetch(API_URL, {
      method: "POST",
      body: new URLSearchParams(payload)
    });
    const text = await res.text();

    console.log("RAW RESPONSE:", text);

    let json;
    try { json = JSON.parse(text); }
    catch(err){
      showToast("Save failed: invalid server response","error");
      console.error(err);
      return;
    }

    if(!json.success){
      showToast(json.message || "Save error","error");
      return;
    }

    showToast("Saved successfully!","success");

    // RESET form entirely
    document.getElementById("headForm").reset();
    collectedMembers = [];
    updateMemberPreview();

  } catch (err) {
    console.error(err);
    showToast("Unexpected error saving","error");
  }
}
</script>

</body>
</html>
