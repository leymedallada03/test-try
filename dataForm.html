<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan ‚Äî Data Entry of household</title>

<!-- Minimal reset + variables -->
<style>
  :root{
    --bg:#f6f8f7;
    --card:#ffffff;
    --muted:#6b776f;
    --accent1:#0f7a4a;
    --accent2:#34b78f;
    --shadow: 0 8px 28px rgba(6,30,20,0.06);
    --radius:12px;
    --gap:12px;
    --input-h:40px;
    --fs-sm:13px;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#f4f6f5);color:#0b2b1f}
  a{color:inherit}
  /* page container ‚Äî preserved */
  .page-container{display:grid;grid-template-columns:260px 1fr;gap:18px;min-height:100vh;padding:18px}
  .sidebar{background:#fff;border-radius:10px;padding:12px;box-shadow:var(--shadow)}
  .topbar{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 18px;background:#fff;border-radius:10px;box-shadow:var(--shadow);margin-bottom:8px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;object-fit:contain}
  .title{font-weight:800;color:var(--accent1)}
  .subtitle{font-size:13px;color:var(--muted)}
  .user-info{display:flex;gap:8px;align-items:center}
  .logout-btn{border:0;background:transparent;color:var(--accent1);cursor:pointer}

  /* content area */
  .content-area{padding:18px;background:transparent}
  h2{margin:8px 0 12px 0}
  .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);margin-bottom:12px}
  .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--gap);align-items:start}
  label{display:block;font-weight:600;margin-bottom:6px;color:#0b4630;font-size:14px}
  input[type="text"], input[type="number"], select, textarea, input[type="date"]{
    height:var(--input-h);padding:8px 10px;border-radius:10px;border:1px solid rgba(11,36,20,0.08);outline:none;font-size:14px;background:#fff;
    transition:box-shadow 160ms, transform 160ms;
  }
  input[type="date"]{padding-left:10px}
  input[type="text"]:focus, select:focus, textarea:focus, input[type="number"]:focus, input[type="date"]:focus{
    box-shadow:0 6px 18px rgba(6,30,20,0.06);transform:translateY(-1px)
  }
  .small-muted{font-size:var(--fs-sm);color:var(--muted)}
  .actions-row{display:flex;gap:8px;justify-content:flex-end}
  .btn{border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;background: linear-gradient(90deg,var(--accent1),var(--accent2)); color:#fff}
  .btn.secondary{background:transparent;color:var(--accent1);border:1px solid rgba(6,30,20,0.06)}
  .radio-line{display:flex;gap:12px;align-items:center}
  .radio-item{display:flex;gap:8px;align-items:center}
  .checkbox-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px 12px;align-items:center}
  .checkbox-grid label{display:flex;gap:8px;align-items:center;font-weight:600;color:#0b4630}
  /* members preview */
  .member-preview{margin-top:8px;font-size:14px}
  .member-preview li{margin-bottom:6px}
  /* overlay + panel */
  .panel-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.32);opacity:0;pointer-events:none;transition:opacity 200ms;z-index:5900}
  .panel-overlay.show{opacity:1;pointer-events:auto}
  .member-panel{position:fixed;right:0;top:0;height:100vh;width:460px;max-width:96%;background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(250,255,250,0.98));box-shadow:-18px 0 40px rgba(6,30,20,0.12);transform:translateX(110%);transition:transform 280ms cubic-bezier(.2,.9,.3,1);z-index:6000;padding:18px;overflow:auto;border-radius:0 12px 12px 0}
  .member-panel.open{transform:translateX(0)}
  .panel-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .panel-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

  /* Domestic animals grid (2-col) */
  .domestic-grid{display:grid;grid-template-columns:1fr 120px;gap:8px 12px;align-items:center}
  .domestic-grid .animal-label{font-weight:700;color:#0b4630}
  .animal-row{display:contents} /* each label + qty will follow grid cells */

  /* large textarea for Others */
  textarea.large{min-height:84px;resize:vertical;padding:10px;border-radius:10px}

  /* modern select dropdown animation */
  select{
    -webkit-appearance:none;-moz-appearance:none;appearance:none;
    background-image:linear-gradient(45deg,transparent 50%, #0b4630 50%), linear-gradient(135deg,#0b4630 50%, transparent 50%);
    background-position:calc(100% - 18px) calc(1em + 2px), calc(100% - 13px) calc(1em + 2px);
    background-size:6px 6px,6px 6px;
    background-repeat:no-repeat;
    padding-right:36px;
  }

  /* small responsive */
  @media (max-width:900px){
    .page-container{grid-template-columns:1fr;padding:12px}
    .form-grid{grid-template-columns:1fr}
    .domestic-grid{grid-template-columns:1fr 100px}
    .member-panel{width:100%;left:0;right:auto;border-radius:0}
  }

  /* align checkboxes and radios better */
  input[type="checkbox"], input[type="radio"]{width:18px;height:18px;margin:0}
  .field-inline{display:flex;align-items:center;gap:8px}
  .section-title{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .section-title h3{margin:0}
  .muted-small{font-size:12px;color:var(--muted)}
  .card-sep{height:10px}
  /* subtle anim on input focus for date to look modern */
  input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(40%) sepia(60%) saturate(400%) hue-rotate(100deg)}
</style>
</head>
<body>
<div class="page-container">

  <header class="topbar">
    <div style="display:flex;gap:12px;align-items:center">
      <button id="menuToggle" class="menu-btn" aria-label="Toggle menu">‚ò∞</button>
      <div class="brand">
        <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
        <div>
          <div class="title">PUROK KALIGTASAN</div>
          <div class="subtitle">Disaster Risk Reduction & Management Office - Alitagtag</div>
        </div>
      </div>
    </div>

    <div class="user-info">
      <span id="userName"></span>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <ul style="list-style:none;padding:6px;margin:0">
      <li style="margin:8px 0"><a href="dashboard.html">üìä Dashboard</a></li>
      <li style="margin:8px 0"><a href="dataForm.html" class="active">üìù Data Entry</a></li>
      <li style="margin:8px 0"><a href="records.html">üìÅ Records</a></li>
      <li style="margin:8px 0"><a href="charts.html">üìà Charts</a></li>
      <li style="margin:8px 0" class="admin-only"><a href="users.html">üë• User Management</a></li>
    </ul>
  </aside>

  <main class="content-area" tabindex="-1">
    <h2>üìù Household Evacuation Information (Head first)</h2>

    <form id="headForm" novalidate onsubmit="return false;">
      <!-- BASIC INFORMATION -->
      <div class="card">
        <div class="section-title"><h3>Basic Information (Household Head)</h3><div class="muted-small">Required: Contact no. & Birthdate</div></div>
        <div class="form-grid" style="margin-top:10px">
          <div>
            <label>Coordinate (optional)</label>
            <input type="text" id="coordinate" placeholder="lat, lon (optional)" />
            <div class="small-muted">Optional ‚Äî fill when available</div>
          </div>

          <div>
            <label>Barangay <span style="color:#b33">*</span></label>
            <select id="barangay" required>
              <option value="">Select Barangay...</option>
              <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
              <option>Dalipit East</option><option>Dalipit West</option><option>Dominador East</option>
              <option>Dominador West</option><option>Munlawin Sur</option><option>Munlawin Norte</option>
              <option>Muzon Primero</option><option>Muzon Segundo</option><option>Pinagkurusan</option>
              <option>Ping-As</option><option>Poblacion East</option><option>Poblacion West</option>
              <option>San Jose</option><option>San Juan</option><option>Santa Cruz</option><option>Tadlac</option>
            </select>
          </div>

          <div>
            <label>Sitio / Purok <span style="color:#b33">*</span></label>
            <select id="sitio" required>
              <option value="">Select...</option>
              <option>Purok I</option><option>Purok II</option><option>Purok III</option>
              <option>Purok IV</option><option>Purok V</option><option>Purok VI</option>
              <option>Purok VII</option>
            </select>
          </div>

          <div>
            <label>Name of Household Head <span style="color:#b33">*</span></label>
            <input type="text" id="householdHead" required />
          </div>

          <div>
            <label>Contact no. <span style="color:#b33">*</span></label>
            <input type="text" id="contactNo" placeholder="09XXXXXXXXX" pattern="^09[0-9]{9}$" required />
            <div class="small-muted">Format: 09XXXXXXXXX</div>
          </div>

          <div>
            <label>Sex <span style="color:#b33">*</span></label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_sex" value="Male" required> Male</label>
              <label class="radio-item"><input type="radio" name="head_sex" value="Female"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate <span style="color:#b33">*</span></label>
            <input type="date" id="householdBirthdate" required />
          </div>

          <div>
            <label>Age</label>
            <input type="text" id="householdAge" readonly />
          </div>

          <div>
            <label>Stage</label>
            <input type="text" id="householdStage" readonly />
          </div>

          <div>
            <label>No. of Household Member/s <span style="color:#b33">*</span></label>
            <input type="number" id="memberCount" min="0" value="0" />
            <div class="small-muted">Set to 0 if no other members.</div>
          </div>
        </div>
      </div>

      <!-- HEALTH & STATUS -->
      <div class="card">
        <h3>Health and Status</h3>
        <div class="form-grid" style="margin-top:10px">
          <div>
            <label>Persons with Disability (PWD)</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="head_pwd" value="Yes"> Yes</label>
              <label class="radio-item"><input type="radio" name="head_pwd" value="No" checked> No</label>
            </div>
          </div>

          <div>
            <label>Status</label>
            <select id="head_status">
              <option value="">Select...</option>
              <option>With Sickness</option><option>Pregnant</option><option>Solo Parent</option><option>Lactating</option><option>Severe Illness</option><option>HIV Positive</option><option>LGBTQ Plus</option>
            </select>
          </div>

          <div>
            <label>Transportation</label>
            <select id="head_transport">
              <option value="">Select...</option>
              <option>Individual with Transportation</option>
              <option>Individual needing Transportation</option>
            </select>
          </div>

          <div style="grid-column:1/-1">
            <label>Reasons for Displacement</label>
            <select id="reasons">
              <option value="">Select...</option>
              <option>With-in 14-15 KM Danger Zone During Taal Eruption</option>
              <option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <!-- DOMESTIC (ANIMALS) ‚Äî HEAD ONLY -->
      <div class="card">
        <h3>Domestic (Animals) ‚Äî Household Head</h3>
        <div class="small-muted" style="margin-bottom:8px">List animals and the quantities. "Others" is a free-text box (2 sentences).</div>

        <div class="domestic-grid card" style="padding:12px">
          <!-- Each animal label then qty -->
          <div class="animal-label">Dog</div><div><input type="number" id="dogQty" min="0" placeholder="Qty" /></div>
          <div class="animal-label">Cat</div><div><input type="number" id="catQty" min="0" /></div>
          <div class="animal-label">Pig</div><div><input type="number" id="pigQty" min="0" /></div>
          <div class="animal-label">Cow</div><div><input type="number" id="cowQty" min="0" /></div>
          <div class="animal-label">Carabao</div><div><input type="number" id="carabaoQty" min="0" /></div>
          <div class="animal-label">Chicken</div><div><input type="number" id="chickenQty" min="0" /></div>
          <div style="grid-column:1/-1;margin-top:8px">
            <label>Others</label>
            <textarea id="animalsOthers" class="large" maxlength="250" placeholder="Type other domestic animals or notes (max ~2 sentences)"></textarea>
          </div>
        </div>
      </div>

      <!-- PICKUP / TRANSPORT / CAMP DETAILS -->
      <div class="card">
        <h3>Pickup / Transport / Camp Details</h3>
        <div class="form-grid" style="margin-top:10px">
          <div>
            <label>Designated Pick-Up Point</label>
            <input type="text" id="pickup" />
          </div>
          <div>
            <label>Drop-Off Point</label>
            <input type="text" id="dropoff" />
          </div>
          <div>
            <label>Name of Camp</label>
            <input type="text" id="campName" />
          </div>
          <div>
            <label>Capacity</label>
            <input type="number" id="capacity" min="0" />
          </div>
          <div>
            <label>No. of Individuals Inside Camp</label>
            <input type="number" id="insideCamp" min="0" value="0" />
          </div>
          <div>
            <label>No. of Individuals Outside Camp</label>
            <input type="number" id="outsideCamp" min="0" value="0" />
          </div>
        </div>
      </div>

      <!-- GOVERNMENT SUPPORT (HEAD) - 2 col aligned -->
      <div class="card">
        <h3>Government Support (Household Head)</h3>
        <div class="checkbox-grid" style="margin-top:8px">
          <label><input type="checkbox" id="ass_tupad"> TUPAD</label>
          <label><input type="checkbox" id="ass_local4ps"> Local 4Ps</label>
          <label><input type="checkbox" id="ass_intl4ps"> National 4Ps</label>
          <label><input type="checkbox" id="ass_locsp"> Local Social Pension</label>
          <label><input type="checkbox" id="ass_intlsp"> National Social Pension</label>
          <label><input type="checkbox" id="ass_solo"> Solo Parent Assistance</label>
          <label><input type="checkbox" id="ass_relief"> Relief Goods</label>
          <label><input type="checkbox" id="ass_cash"> Cash Subsidy</label>
        </div>

        <div style="margin-top:10px">
          <label>AICS (if any)</label>
          <select id="ass_aics">
            <option value="">None</option>
            <option>Shelter Assistance</option>
            <option>Burial</option>
            <option>Scholarship</option>
          </select>
        </div>
      </div>

      <!-- members preview + submit -->
      <div class="card">
        <h4>Members to be collected</h4>
        <div class="small-muted">Number of members chosen: <strong id="previewCount">0</strong></div>
        <ul id="membersPreview" class="member-preview"></ul>

        <div style="height:10px"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="resetBtn" class="btn secondary" type="button">Reset</button>
          <button id="nextToMembers" class="btn" type="button">Save ‚Üí Next Members</button>
        </div>
      </div>
    </form>
  </main>
</div>

<!-- overlay + member panel -->
<div id="panelOverlay" class="panel-overlay" aria-hidden="true"></div>

<div id="memberPanel" class="member-panel" aria-hidden="true" role="dialog" aria-label="Member entry panel">
  <div class="panel-header">
    <button id="panelClose" class="btn secondary" title="Close panel">‚Üê</button>
    <h3 id="panelTitle">Member 1 of N</h3>
  </div>

  <div class="panel-body">
    <form id="memberForm" onsubmit="return false;">
      <div class="card" style="margin-bottom:8px">
        <h4>Member ‚Äî Basic Info</h4>
        <div class="form-grid" style="margin-top:8px">
          <div>
            <label>Member Name <span style="color:#b33">*</span></label>
            <input type="text" id="memberName" class="member-name" required />
          </div>

          <div>
            <label>Contact no.</label>
            <input type="text" id="memberContact" class="member-contact" placeholder="09XXXXXXXXX" />
          </div>

          <div>
            <label>Sex</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="member_sex" value="Male" class="member-sex"> Male</label>
              <label class="radio-item"><input type="radio" name="member_sex" value="Female" class="member-sex"> Female</label>
            </div>
          </div>

          <div>
            <label>Birthdate</label>
            <input type="date" id="memberBirthdate" class="member-birthdate" />
          </div>

          <div>
            <label>Age</label>
            <input type="text" id="memberAge" class="member-age" readonly />
          </div>

          <div>
            <label>Stage</label>
            <input type="text" id="memberStage" class="member-stage" readonly />
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom:8px">
        <h4>Health & Status</h4>
        <div class="form-grid" style="margin-top:8px">
          <div>
            <label>PWD</label>
            <div class="radio-line">
              <label class="radio-item"><input type="radio" name="member_pwd" value="Yes" class="member-pwd"> Yes</label>
              <label class="radio-item"><input type="radio" name="member_pwd" value="No" checked class="member-pwd"> No</label>
            </div>
          </div>

          <div>
            <label>Status</label>
            <select id="memberStatus" class="member-status">
              <option value="">Select...</option><option>With Sickness</option><option>Pregnant</option>
            </select>
          </div>

          <div>
            <label>Transportation</label>
            <select id="memberTransport" class="member-transport">
              <option value="">Select...</option>
              <option>Individual with Transportation</option>
              <option>Individual needing Transportation</option>
            </select>
          </div>

          <div>
            <label>Reason</label>
            <select id="memberReason" class="member-reason">
              <option value="">Select...</option><option>With-in 14-15 KM Danger Zone</option><option>Others</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom:8px">
        <h4>Pickup / Transport / Camp</h4>
        <div class="form-grid" style="margin-top:8px">
          <div><label>Designated Pick-Up Point</label><input type="text" id="memberPickup" class="member-pickup"/></div>
          <div><label>Drop-Off Point</label><input type="text" id="memberDropoff" class="member-dropoff"/></div>
          <div><label>Name of Camp</label><input type="text" id="memberCamp" class="member-camp"/></div>
          <div><label>Capacity</label><input type="number" id="memberCampCap" class="member-cap" min="0"/></div>
          <div><label>No. inside camp</label><input type="number" id="memberInside" class="member-inside" min="0"/></div>
          <div><label>No. outside camp</label><input type="number" id="memberOutside" class="member-outside" min="0"/></div>
        </div>
      </div>

      <div class="card" style="margin-bottom:8px">
        <h4>Government Support (Member)</h4>
        <div class="checkbox-grid" style="margin-top:8px">
          <label><input type="checkbox" id="member_tupad" class="member_tupad"> TUPAD</label>
          <label><input type="checkbox" id="member_local4ps" class="member_local4ps"> Local 4Ps</label>
          <label><input type="checkbox" id="member_intl4ps" class="member_intl4ps"> National 4Ps</label>
          <label><input type="checkbox" id="member_locsp" class="member_locsp"> Local Social Pension</label>
          <label><input type="checkbox" id="member_intlsp" class="member_intlsp"> National Social Pension</label>
          <label><input type="checkbox" id="member_solo" class="member_solo"> Solo Parent Assistance</label>
          <label><input type="checkbox" id="member_cash" class="member_cash"> Cash Subsidy</label>
          <label><input type="checkbox" id="member_relief" class="member_relief"> Relief Goods</label>
        </div>

        <div style="margin-top:8px">
          <label>AICS (if any)</label>
          <select id="memberAics" class="member_aics">
            <option value="">None</option>
            <option>Shelter Assistance</option>
            <option>Burial</option>
            <option>Scholarship</option>
          </select>
        </div>
      </div>

      <div class="panel-actions">
        <button id="memberBack" class="btn secondary" type="button">Back</button>
        <button id="memberNext" class="btn" type="button">Save & Next</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ---------------- Configuration ---------------- */
const API_URL = "https://script.google.com/macros/s/AKfycbxWs1kxkyleYw6qcQlIx1xsecQS8x2O-nyXxbcdcm5DVst6IcmDKR-NmzSgBxyH7ErvpA/exec";

/* ---------------- date helpers (same as your previous) ---------------- */
function toSheetDateFormat(inputVal){
  if(!inputVal) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputVal)){
    const [y,m,d] = inputVal.split('-');
    return `${d}/${m}/${y}`;
  }
  const dt = new Date(inputVal);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dd}/${mm}/${dt.getFullYear()}`;
  }
  return String(inputVal);
}
function toInputDate(val){
  if(!val) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(val)){
    const [d,m,y] = val.split('/');
    return `${y}-${m}-${d}`;
  }
  const dt = new Date(val);
  if(!isNaN(dt)){
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${dt.getFullYear()}-${mm}-${dd}`;
  }
  return "";
}

/* ---------------- Age compute (unchanged) ---------------- */
function computeAgeDetailed(inputDateValue){
  if(!inputDateValue) return null;
  let d;
  if(/^\d{4}-\d{2}-\d{2}$/.test(inputDateValue)){
    const parts = inputDateValue.split('-');
    d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
  } else {
    d = new Date(inputDateValue);
  }
  if(isNaN(d)) return null;

  const now = new Date();
  const birth = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  let years = today.getFullYear() - birth.getFullYear();
  let months = today.getMonth() - birth.getMonth();
  let days = today.getDate() - birth.getDate();

  if(days < 0){
    months -= 1;
    const prev = new Date(today.getFullYear(), today.getMonth(), 0);
    days += prev.getDate();
  }
  if(months < 0){
    years -= 1;
    months += 12;
  }

  let display = "";
  if(years >= 1){
    display = String(years);
  } else {
    if(months >= 1){
      display = `${months} months`;
    } else {
      display = `${days} days`;
    }
  }

  let stage = "";
  if(years === 0){
    if(months <= 10) stage = "Infant";
    else stage = "Children";
  } else if(years <= 17){
    stage = "School Children";
  } else if(years >= 60){
    stage = "Elderly";
  } else {
    stage = "Adult";
  }

  return { years, months, days, display, stage };
}

/* ---------------- UI + state ---------------- */
function ensureLoginOrRedirect(){
  if(!localStorage.getItem("loggedIn")){ /* keep behavior but don't redirect in test */ return true; }
  return true;
}

let membersToCollect = 0;
let currentMemberIndex = 0;
let collectedMembers = [];

/* update preview */
function updateMemberPreview(){
  const n = parseInt(document.getElementById("memberCount").value || 0);
  document.getElementById("previewCount").innerText = n;
  const list = document.getElementById("membersPreview");
  list.innerHTML = "";
  for(let i=0;i<n;i++){
    const mem = collectedMembers[i];
    const li = document.createElement('li');
    li.innerText = mem ? `#${i+1} ‚Äî ${mem["Name of Household Member/s"] || "(empty)"}` : `#${i+1} ‚Äî (empty)`;
    list.appendChild(li);
  }
}

/* fill member panel with existing or blank */
function fillMemberPanel(idx){
  const mem = collectedMembers[idx] || {};
  document.getElementById("memberName").value = mem["Name of Household Member/s"] || "";
  document.getElementById("memberContact").value = mem["Contact no."] || "";
  Array.from(document.getElementsByName("member_sex")).forEach(r => r.checked = (r.value === (mem["Sex"] || "")));
  document.getElementById("memberBirthdate").value = mem["Birthdate"] ? toInputDate(mem["Birthdate"]) : "";
  document.getElementById("memberAge").value = mem["Age"] || "";
  document.getElementById("memberStage").value = mem["Stage"] || "";
  document.getElementById("memberStatus").value = mem["Status"] || "";
  document.getElementById("memberTransport").value = mem["Transportation"] || "";
  document.getElementById("memberPickup").value = mem["Designated Pick-Up Point"] || "";
  document.getElementById("memberDropoff").value = mem["Drop-Off Point"] || "";
  document.getElementById("memberCamp").value = mem["Name of Camp"] || "";
  document.getElementById("memberCampCap").value = mem["Capacity"] || "";
  document.getElementById("memberInside").value = mem["No. of Individuals Inside Camp"] || "";
  document.getElementById("memberOutside").value = mem["No. of Individuals Outside Camp"] || "";
  document.getElementById("memberReason").value = mem["Reasons for Displacement"] || "";
  document.getElementById("member_tupad").checked = (mem["TUPAD"] === "Yes");
  document.getElementById("member_local4ps").checked = (mem["Local 4Ps"] === "Yes");
  document.getElementById("member_intl4ps").checked = (mem["National 4Ps"] === "Yes");
  document.getElementById("member_locsp").checked = (mem["Local Social Pension"] === "Yes");
  document.getElementById("member_intlsp").checked = (mem["National Social Pension"] === "Yes");
  document.getElementById("member_solo").checked = (mem["Solo Parent Assistance"] === "Yes");
  document.getElementById("member_relief").checked = (mem["Relief Goods"] === "Yes");
  document.getElementById("member_cash").checked = (mem["Cash Subsidy"] === "Yes");
  document.getElementById("memberAics").value = mem["AICS"] || "";
}

/* collect member panel inputs into object that matches Master sheet keys */
function collectMemberDataFromPanel(){
  const name = document.getElementById("memberName").value.trim();
  const sex = document.querySelector("input[name='member_sex']:checked")?.value || "";
  const birth_input = document.getElementById("memberBirthdate").value || "";
  const birth_for_sheet = toSheetDateFormat(birth_input);
  const ageObj = computeAgeDetailed(birth_input);
  const ageVal = ageObj ? ageObj.display : "";
  const stageVal = ageObj ? ageObj.stage : "";

  return {
    "Name of Household Member/s": name,
    "Contact no.": document.getElementById("memberContact").value || "",
    "Sex": sex,
    "Birthdate": birth_for_sheet,
    "Age": ageVal,
    "Stage": stageVal,
    "Persons with Disability (PWD)": (document.querySelector("input[name='member_pwd']:checked")?.value || "No"),
    "Status": document.getElementById("memberStatus").value || "",
    "Transportation": document.getElementById("memberTransport").value || "",
    "Designated Pick-Up Point": document.getElementById("memberPickup").value || "",
    "Drop-Off Point": document.getElementById("memberDropoff").value || "",
    "Name of Camp": document.getElementById("memberCamp").value || "",
    "Capacity": document.getElementById("memberCampCap").value || "",
    "No. of Individuals Inside Camp": document.getElementById("memberInside").value || "",
    "No. of Individuals Outside Camp": document.getElementById("memberOutside").value || "",
    "Reasons for Displacement": document.getElementById("memberReason").value || "",
    "TUPAD": document.getElementById("member_tupad").checked ? "Yes" : "No",
    "Local 4Ps": document.getElementById("member_local4ps").checked ? "Yes" : "No",
    "National 4Ps": document.getElementById("member_intl4ps").checked ? "Yes" : "No",
    "Local Social Pension": document.getElementById("member_locsp").checked ? "Yes" : "No",
    "National Social Pension": document.getElementById("member_intlsp").checked ? "Yes" : "No",
    "Solo Parent Assistance": document.getElementById("member_solo").checked ? "Yes" : "No",
    "Relief Goods": document.getElementById("member_relief").checked ? "Yes" : "No",
    "Cash Subsidy": document.getElementById("member_cash").checked ? "Yes" : "No",
    "AICS": document.getElementById("memberAics").value || ""
  };
}

/* update member age/stage live when date changes */
document.addEventListener('input', (ev) => {
  if(ev.target && ev.target.id === "memberBirthdate"){
    const v = ev.target.value;
    const info = computeAgeDetailed(v);
    document.getElementById("memberAge").value = info ? info.display : "";
    document.getElementById("memberStage").value = info ? info.stage : "";
  }
  if(ev.target && ev.target.id === "householdBirthdate"){
    const v = ev.target.value;
    const info = computeAgeDetailed(v);
    document.getElementById("householdAge").value = info ? info.display : "";
    document.getElementById("householdStage").value = info ? info.stage : "";
  }
});

/* ---------------- DOM loaded bindings ---------------- */
document.addEventListener('DOMContentLoaded', () => {
  ensureLoginOrRedirect();
  document.getElementById("userName").innerText = localStorage.getItem("staffName") || "";

  // reset
  document.getElementById("resetBtn").addEventListener('click', () => {
    document.getElementById("headForm").reset();
    collectedMembers = [];
    updateMemberPreview();
    document.getElementById("householdAge").value = "";
    document.getElementById("householdStage").value = "";
  });

  // next (head -> members)
  document.getElementById("nextToMembers").addEventListener('click', () => {
    const barangay = document.getElementById("barangay").value.trim();
    const sitio = document.getElementById("sitio").value.trim();
    const headName = document.getElementById("householdHead").value.trim();
    const contact = document.getElementById("contactNo").value.trim();
    const bdate = document.getElementById("householdBirthdate").value || "";
    if(!barangay || !sitio || !headName){ alert("Please fill Barangay, Sitio/Purok and Name of Household Head."); return; }
    if(!contact){ alert("Please fill Contact no. for household head."); return; }
    if(!bdate){ alert("Please fill Birthdate for household head."); return; }

    membersToCollect = parseInt(document.getElementById("memberCount").value || 0);
    collectedMembers = []; currentMemberIndex = 0;
    updateMemberPreview();

    if(membersToCollect === 0){
      // no members -> submit head only
      submitHeadAndMembers();
      return;
    }

    // open member panel first
    fillMemberPanel(0);
    currentMemberIndex = 0;
    document.getElementById('panelTitle').innerText = `Member 1 of ${membersToCollect}`;
    openPanel();
  });

  // panel close/back
  document.getElementById("panelClose").addEventListener('click', () => { closePanel(); });
  document.getElementById("memberBack").addEventListener('click', () => {
    if(currentMemberIndex > 0){
      collectedMembers[currentMemberIndex] = collectMemberDataFromPanel();
      currentMemberIndex--;
      fillMemberPanel(currentMemberIndex);
      document.getElementById('panelTitle').innerText = `Member ${currentMemberIndex+1} of ${membersToCollect}`;
      updateMemberPreview();
    } else {
      closePanel();
    }
  });

  // memberNext (save & next)
  document.getElementById("memberNext").addEventListener('click', () => {
    const name = document.getElementById("memberName").value.trim();
    if(!name){ alert("Please enter member's name."); return; }

    collectedMembers[currentMemberIndex] = collectMemberDataFromPanel();
    updateMemberPreview();

    currentMemberIndex++;
    if(currentMemberIndex >= membersToCollect){
      // done
      closePanel();
      submitHeadAndMembers();
      return;
    }
    fillMemberPanel(currentMemberIndex);
    document.getElementById('panelTitle').innerText = `Member ${currentMemberIndex+1} of ${membersToCollect}`;
  });

  // live update household birthdate change (also handled by input listener)
  document.getElementById("householdBirthdate").addEventListener('change', () => {
    const info = computeAgeDetailed(document.getElementById("householdBirthdate").value);
    document.getElementById("householdAge").value = info ? info.display : "";
    document.getElementById("householdStage").value = info ? info.stage : "";
  });

  updateMemberPreview();
});

/* ---------------- open / close panel helpers ---------------- */
function openPanel(){ document.getElementById("memberPanel").classList.add("open"); document.getElementById("panelOverlay").classList.add("show"); }
function closePanel(){ document.getElementById("memberPanel").classList.remove("open"); document.getElementById("panelOverlay").classList.remove("show"); }

/* ---------------- Submit head + members ---------------- */
async function submitHeadAndMembers(){
  // head birthdate -> DD/MM/YYYY
  const headBirthInput = document.getElementById("householdBirthdate").value || "";
  const headBirthForSheet = toSheetDateFormat(headBirthInput);
  const headAgeInfo = computeAgeDetailed(headBirthInput);
  const headAgeVal = headAgeInfo ? headAgeInfo.display : "";

  const head = {
    "Coordinate": document.getElementById("coordinate").value || "",
    "Barangay": document.getElementById("barangay").value || "",
    "Sitio / Purok": document.getElementById("sitio").value || "",
    "Name of Household Head": document.getElementById("householdHead").value || "",
    "Contact no.": document.getElementById("contactNo").value || "",
    "Sex": document.querySelector("input[name='head_sex']:checked")?.value || "",
    "Birthdate": headBirthForSheet,
    "Age": headAgeVal,
    "Stage": headAgeInfo ? headAgeInfo.stage : "",
    "No. of Household Member/s": document.getElementById("memberCount").value || "0",
    "Name of Household Member/s": "",

    "Persons with Disability (PWD)": document.querySelector("input[name='head_pwd']:checked")?.value || "No",
    "Status": document.getElementById("head_status").value || "",
    "Transportation": document.getElementById("head_transport").value || "",
    "Designated Pick-Up Point": document.getElementById("pickup").value || "",
    "Drop-Off Point": document.getElementById("dropoff").value || "",
    "Name of Camp": document.getElementById("campName").value || "",
    "Capacity": document.getElementById("capacity").value || "",
    "No. of Individuals Inside Camp": document.getElementById("insideCamp").value || "",
    "No. of Individuals Outside Camp": document.getElementById("outsideCamp").value || "",
    "Reasons for Displacement": document.getElementById("reasons").value || "",

    "TUPAD": document.getElementById("ass_tupad").checked ? "Yes" : "No",
    "Local 4Ps": document.getElementById("ass_local4ps").checked ? "Yes" : "No",
    "National 4Ps": document.getElementById("ass_intl4ps").checked ? "Yes" : "No",
    "Local Social Pension": document.getElementById("ass_locsp").checked ? "Yes" : "No",
    "National Social Pension": document.getElementById("ass_intlsp").checked ? "Yes" : "No",
    "Solo Parent Assistance": document.getElementById("ass_solo").checked ? "Yes" : "No",
    "Relief Goods": document.getElementById("ass_relief").checked ? "Yes" : "No",
    "Cash Subsidy": document.getElementById("ass_cash").checked ? "Yes" : "No",
    "AICS": document.getElementById("ass_aics").value || "",

    /* Domestic animals ‚Äî HEAD only (keys used below must match your sheet or Code.gs) */
    "Dog": (document.getElementById("dogQty").value ? "Yes" : ""),
    "Dog Qty": document.getElementById("dogQty").value || "",
    "Cat": (document.getElementById("catQty").value ? "Yes" : ""),
    "Cat Qty": document.getElementById("catQty").value || "",
    "Pig": (document.getElementById("pigQty").value ? "Yes" : ""),
    "Pig Qty": document.getElementById("pigQty").value || "",
    "Cow": (document.getElementById("cowQty").value ? "Yes" : ""),
    "Cow Qty": document.getElementById("cowQty").value || "",
    "Carabao": (document.getElementById("carabaoQty").value ? "Yes" : ""),
    "Carabao Qty": document.getElementById("carabaoQty").value || "",
    "Chicken": (document.getElementById("chickenQty").value ? "Yes" : ""),
    "Chicken Qty": document.getElementById("chickenQty").value || "",
    "Others": document.getElementById("animalsOthers").value || "",

    "Submitted By": localStorage.getItem("staffName") || localStorage.getItem("username") || "Unknown",
    "Submitted On": new Date().toLocaleString()
  };

  // ensure members array length matches count
  const expected = parseInt(document.getElementById("memberCount").value || 0);
  const members = collectedMembers.slice(0);
  for(let i=0;i<expected;i++){
    if(!members[i]){
      members[i] = {
        "Name of Household Member/s": "",
        "Contact no.": "",
        "Sex": "",
        "Birthdate": "",
        "Age": "",
        "Stage": "",
        "Persons with Disability (PWD)": "No",
        "Status": "",
        "Transportation": "",
        "Designated Pick-Up Point": "",
        "Drop-Off Point": "",
        "Name of Camp": "",
        "Capacity": "",
        "No. of Individuals Inside Camp": "",
        "No. of Individuals Outside Camp": "",
        "Reasons for Displacement": "",
        "TUPAD": "No",
        "Local 4Ps": "No",
        "National 4Ps": "No",
        "Local Social Pension": "No",
        "National Social Pension": "No",
        "Solo Parent Assistance": "No",
        "Relief Goods": "No",
        "Cash Subsidy": "No",
        "AICS": ""
      };
    }
    // ensure any birthdate in members are DD/MM/YYYY
    if(members[i]["Birthdate"]){
      members[i]["Birthdate"] = (members[i]["Birthdate"].indexOf('/') === -1) ? toSheetDateFormat(members[i]["Birthdate"]) : members[i]["Birthdate"];
    }
  }

  // build FormData
  const form = new FormData();
  form.append("action","createRecord");
  form.append("head", JSON.stringify(head));
  form.append("members", JSON.stringify(members));
  form.append("submittedBy", localStorage.getItem("staffName") || localStorage.getItem("username") || "Unknown");

  // UI disable
  const submitBtn = document.getElementById("nextToMembers");
  submitBtn.disabled = true;
  submitBtn.innerText = "Saving...";

  try{
    console.log("Submitting HEAD:", head);
    console.log("Submitting MEMBERS:", members);
    const res = await fetch(API_URL, { method: "POST", body: form });
    const text = await res.text();
    console.log("RAW RESPONSE:", text);
    let data;
    try { data = JSON.parse(text); } catch(e){ throw new Error("Invalid response from server: " + e.message); }

    if(data.success){
      alert("Record saved successfully! (Data ID: " + (data.dataID || "n/a") + ")");
      window.location.href = "records.html";
    } else {
      alert("Save failed: " + (data.message || "Unknown error"));
      console.error("SAVE ERROR:", data);
    }
  }catch(err){
    console.error("SUBMIT ERROR:", err);
    alert("Network / Server error. Check console.");
  }finally{
    submitBtn.disabled = false;
    submitBtn.innerText = "Save ‚Üí Next Members";
  }
}
</script>
</body>
</html>
