<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>User Management ‚Äî Purok Kaligtasan</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="css/uniform-styles.css">
<style>
   :root{
    --bg:#f6f8f7;
    --card-bg:#fff;
    --muted:#6b6f6b;
    --accent1:#0f7a4a;
    --accent2:#34b78f;
    --accent3: #ff7a00;
    --accent4: #ffa500;
    --light-green: #e9f7f2;
    --border: #e1e8e5;
    --shadow: 0 6px 18px rgba(6,30,20,0.06);
    --shadow-dark: 0 6px 20px rgba(5,40,25,0.12);
    --radius:12px;
    --radius-sm:8px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
   }
   
   /* Enhanced tooltips for protected admin buttons */
.actions-cell button[disabled] {
  position: relative;
}

.actions-cell button[disabled]:hover::after {
  content: attr(title);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  white-space: nowrap;
  z-index: 1000;
  margin-bottom: 5px;
}

.actions-cell button[disabled]:hover::before {
  content: "";
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-top-color: #333;
  z-index: 1000;
  margin-bottom: -5px;
}

/* Protected admin row styling */
.users-table tbody tr:hover {
  background: rgba(52,183,143,0.05);
}

/* Special styling for protected admin row */
.users-table tbody tr:has(.actions-cell button[disabled]) {
  background: rgba(255, 245, 204, 0.1); /* Light yellow background */
}

.users-table tbody tr:has(.actions-cell button[disabled]):hover {
  background: rgba(255, 245, 204, 0.2);
}
   /* Tooltip for protected admin button */
.actions-cell button[disabled] {
  position: relative;
}

.actions-cell button[disabled]:hover::after {
  content: "Protected admin account cannot be deleted";
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  white-space: nowrap;
  z-index: 1000;
  margin-bottom: 5px;
}

.actions-cell button[disabled]:hover::before {
  content: "";
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-top-color: #333;
  z-index: 1000;
  margin-bottom: -5px;
}
   /* Background decorative elements */
   .bg-pattern {
     position: absolute;
     width: 100%;
     height: 100%;
     overflow: hidden;
     z-index: -1;
   }
   
   .bg-circle {
     position: absolute;
     border-radius: 50%;
     background: rgba(15, 122, 74, 0.05);
   }
   
   .circle-1 {
     width: 300px;
     height: 300px;
     top: -150px;
     right: -150px;
   }
   
   .circle-2 {
     width: 200px;
     height: 200px;
     bottom: -100px;
     left: -100px;
     background: rgba(255, 122, 0, 0.05);
   }
   
   .circle-3 {
     width: 150px;
     height: 150px;
     top: 50%;
     left: 10%;
     background: rgba(52, 183, 143, 0.05);
   }
   .admin-only {
    display: none !important;
}

/* Class to show admin elements - applied by JavaScript */
.admin-only.admin-visible {
    display: block !important;
}

/* For list items */
li.admin-only {
    display: none !important;
}

li.admin-only.admin-visible {
    display: list-item !important;
}
   /* Description Styling */
   #disc {
    margin-bottom: 10px;
    background: var(--light-green);
    padding: 12px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--accent1);
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.5;
   }
   
   body {
    background-color: var(--bg);
    margin: 0;
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-text-size-adjust: 100%;
    padding-bottom: 70px; /* Space for fixed bottom nav */
   }

   .page-container{
    max-width:1200px;
    margin:20px auto;
    padding:12px;
    display:grid;
    grid-template-columns:260px 1fr;
    gap:18px;
    align-items:start;
    transition: grid-template-columns 0.3s ease;
   }

   .page-container.collapsed {
    grid-template-columns: 60px 1fr;
   }

   /* Topbar - Enhanced */
   .topbar{
    grid-column:1/-1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
    border-radius:var(--radius);
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    box-shadow:var(--shadow-dark);
   }

   .brand{
    display:flex;
    gap:12px;
    align-items:center;
   }

   .brand .logo{
    width:60px;
    height:60px;
    border-radius:var(--radius-sm);
    object-fit:contain;
   }

   .brand-text h1 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
   }

   .brand-text p {
    font-size:12px;
    opacity:0.95;
    margin: 4px 0 0 0;
   }

   .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
   }

   #userName {
    font-weight: 600;
    border-radius: 20px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
   }

   #logoutBtn {
    background: rgba(255,255,255,0.25);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
   }

   #logoutBtn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
   }

   /* Sidebar - Collapsible */
   .sidebar{
    background:linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.20));
    border-radius:var(--radius);
    padding:12px;
    height:calc(100vh - 120px);
    position:sticky;
    top:72px;
    overflow:auto;
    transition: width 0.3s ease;
    z-index: 100;
   }

   .sidebar-container {
    display: flex;
    flex-direction: column;
    height: 100%;
   }

   .sidebar-toggle {
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.3s ease;
   }

   .sidebar-toggle:hover {
    transform: scale(1.1);
   }

   .sidebar ul{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
    flex: 1;
   }

   .sidebar li a{
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    text-decoration: none;
    color: var(--muted);
    border-radius: var(--radius-sm);
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
   }

   .sidebar li a:hover{
    background: var(--light-green);
    color: var(--accent1);
   }

   .sidebar li a.active{
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .sidebar li a .menu-icon {
    font-size: 1.2rem;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
   }

   .sidebar li a .menu-text {
    transition: opacity 0.3s ease;
   }

   .page-container.collapsed .sidebar li a .menu-text {
    opacity: 0;
    width: 0;
    overflow: hidden;
   }

   /* REMOVED: Mobile Logout Button in Sidebar */
   .mobile-logout-container {
    display: none !important; /* Remove logout button from sidebar */
   }

   /* Content Area */
   .content-area{
    background:linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
    border-radius:var(--radius);
    padding:18px;
    box-shadow:0 8px 22px rgba(10,20,16,0.06);
    min-height:72vh;
    height: calc(100vh - 120px);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
   }

   /* Content Header */
   .content-header {
    margin-top: 0;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
   }

   .content-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: var(--accent1);
    display: flex;
    align-items: center;
    gap: 8px;
   }

   /* Mobile Bottom Navigation - Fixed Position - REMOVED LOGOUT */
   .mobile-bottom-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid var(--border);
    z-index: 1000;
    padding: 8px 0;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
    height: 70px;
    box-sizing: border-box;
    overflow: hidden;
   }

   .mobile-nav-items {
    display: flex;
    justify-content: space-around;
    align-items: center;
    height: 100%;
   }

.mobile-nav-item {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    text-decoration: none !important;
    color: var(--muted) !important;
    padding: 8px 12px !important;
    border-radius: var(--radius-sm) !important;
    transition: all 0.3s ease !important;
    min-width: 60px !important;
    flex: 1 !important;
    height: 100% !important;
    justify-content: center !important;
}

/* Admin items - initially hidden */
.mobile-nav-item.admin-only {
    display: none !important;
}

/* Show admin items when user is admin */
.mobile-nav-item.admin-only.admin-visible {
    display: flex !important;
}

/* Active state for all tabs */
.mobile-nav-item.active {
    color: var(--accent1) !important;
    background: var(--light-green) !important;
}

/* REMOVED: Logout button styling */

/* Icon and text for all tabs */
.mobile-nav-icon {
    font-size: 1.2rem !important;
    margin-bottom: 4px !important;
    display: block !important;
    text-align: center !important;
    width: 100% !important;
}

.mobile-nav-text {
    font-size: 0.7rem !important;
    font-weight: 500 !important;
    display: block !important;
    text-align: center !important;
    width: 100% !important;
}

   /* REMOVED: Mobile Logout Item CSS */

   /* Mobile Styles */
   @media (max-width: 768px) {
    body {
        padding-bottom: 70px; /* Space for fixed bottom nav */
    }
    
    .page-container {
        grid-template-columns: 1fr !important;
        padding: 8px;
        gap: 12px;
        margin-bottom: 0; /* Remove margin since we have body padding */
    }
    
    .page-container.collapsed {
        grid-template-columns: 1fr !important;
    }
    
    .sidebar {
        display: none !important; /* Hide sidebar on mobile */
    }
    
    .mobile-bottom-nav {
        display: flex !important; /* Show bottom nav on mobile */
        flex-direction: column;
    }
    
    /* Remove mobile menu toggle button */
    .mobile-menu-toggle {
        display: none !important;
    }
    
    /* Show mobile logout button in sidebar when sidebar is forced to show */
    .mobile-logout-container {
        display: none !important; /* REMOVED: Hide logout in sidebar */
    }
    
    .content-area {
        height: auto;
        min-height: calc(100vh - 140px);
        padding: 12px;
        margin-bottom: 0;
    }
    
    /* Optimize for mobile */
    .user-info {
        gap: 8px;
    }
    
    #userName {
        font-size: 0.9rem;
        padding: 6px 12px;
    }
    
    #logoutBtn {
        padding: 6px 12px;
        font-size: 0.85rem;
    }
    
    /* Adjust content area for bottom nav */
    .content-area {
        margin-bottom: 70px;
    }
   }

   /* Tablet Styles */
   @media (min-width: 769px) and (max-width: 1024px) {
    .page-container {
        max-width: 95%;
        grid-template-columns: 220px 1fr;
        gap: 15px;
        padding: 10px;
    }
    
    .content-area {
        padding: 15px;
    }
    
    .mobile-bottom-nav {
        display: none;
    }
   }

   /* Desktop Styles */
   @media (min-width: 1025px) {
    .mobile-bottom-nav {
        display: none;
    }
    
    .mobile-menu-toggle {
        display: none;
    }
   }

   /* Print styles - Fixed for no stretching */
   @media print {
    body * {
        visibility: hidden;
        background: white !important;
        color: black !important;
    }
    
    .content-area,
    .content-area * {
        visibility: visible;
        background: white !important;
        color: black !important;
        box-shadow: none !important;
    }
    
    .content-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100% !important;
        height: auto !important;
        padding: 20px !important;
        overflow: visible !important;
        page-break-before: always;
    }
    
    .page-container {
        display: block !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
    }
    
    .topbar,
    .sidebar,
    .toolbar,
    .mobile-bottom-nav,
    .mobile-menu-toggle {
        display: none !important;
    }
   }

   /* Additional existing styles for users.html */
   /* Stats - Made Smaller */
   .stats-container {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
   }

   .stat-item {
    text-align: center;
    min-width: 70px;
    padding: 6px 8px;
    background: white;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
   }

   .stat-item span {
    font-size: 0.75rem;
    color: var(--muted);
    display: block;
    margin-bottom: 2px;
   }

   .stat-item .value {
    font-size: 1rem;
    font-weight: 700;
    color: var(--accent1);
    display: block;
   }

   /* Toolbar - New Layout */
   .toolbar {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
   }

   /* Toolbar Row with Search and Toggle */
   .toolbar-row-1 {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    width: 100%;
   }

   /* Full width search bar */
   .search-container {
    position: relative;
    flex: 1;
    width: 100%;
   }

   .search-container i {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 0.9rem;
    z-index: 1;
   }

   .search-box{
    padding: 10px 12px 10px 32px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    background: white;
    width: 100%;
    box-sizing: border-box;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
   }

   .search-box:focus {
    outline: none;
    border-color: var(--accent1);
    box-shadow: 0 0 0 3px rgba(15,122,74,0.1);
   }

   /* Simple toggle buttons on the right */
   .toggle-buttons {
    display: flex;
    gap: 4px;
    background: var(--light-green);
    border-radius: var(--radius-sm);
    padding: 2px;
    min-width: 180px;
    justify-content: center;
   }

   .toggle-btn {
    padding: 6px 12px;
    border: none;
    background: transparent;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--muted);
    min-width: 60px;
    text-align: center;
    white-space: nowrap;
   }

   .toggle-btn:hover {
    background: rgba(255,255,255,0.7);
    color: var(--accent1);
   }

   .toggle-btn.active {
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: white;
    box-shadow: 0 2px 4px rgba(15,122,74,0.2);
   }

   .toolbar-row-2 {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    align-items: center;
   }

   /* Cards Row */
   .cards-row {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
   }

   .card {
    background: white;
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    flex: 1;
    min-width: 200px;
   }

   .card h3 {
    margin-top: 0;
    margin-bottom: 12px;
    color: var(--accent1);
    font-size: 1rem;
   }

   .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent1);
    margin-top: 8px;
   }

   /* Fix table glitching - Improved */
   .users-table-wrap {
       flex: 1;
       background: white;
       border-radius: var(--radius);
       box-shadow: var(--shadow);
       overflow: hidden;
       position: relative;
       margin-bottom: 16px;
       border: 1px solid var(--border);
       min-height: 400px;
       display: flex;
       flex-direction: column;
       overflow-x: auto;
   }

   .users-table {
       width: 100%;
       border-collapse: separate;
       border-spacing: 0;
       font-size: 14px;
       table-layout: fixed;
       min-width: 800px;
   }

   /* Fixed column widths for users table */
   .users-table th:nth-child(1) { width: 20%; min-width: 120px; }
   .users-table th:nth-child(2) { width: 25%; min-width: 150px; }
   .users-table th:nth-child(3) { width: 15%; min-width: 100px; }
   .users-table th:nth-child(4) { width: 25%; min-width: 150px; }
   .users-table th:nth-child(5) { width: 15%; min-width: 120px; }

   /* Fixed column widths for activity table */
   #activityTable th:nth-child(1) { width: 15%; min-width: 100px; }
   #activityTable th:nth-child(2) { width: 12%; min-width: 80px; }
   #activityTable th:nth-child(3) { width: 20%; min-width: 140px; }
   #activityTable th:nth-child(4) { width: 20%; min-width: 140px; }
   #activityTable th:nth-child(5) { width: 15%; min-width: 100px; }
   #activityTable th:nth-child(6) { width: 18%; min-width: 120px; }

   /* Fixed column widths for logs table */
   #logsTable th:nth-child(1) { width: 20%; min-width: 150px; }
   #logsTable th:nth-child(2) { width: 15%; min-width: 100px; }
   #logsTable th:nth-child(3) { width: 15%; min-width: 100px; }
   #logsTable th:nth-child(4) { width: 15%; min-width: 100px; }
   #logsTable th:nth-child(5) { width: 35%; min-width: 200px; }

   .users-table th {
       background: var(--light-green);
       padding: 14px 10px;
       text-align: center;
       font-weight: 600;
       position: sticky;
       top: 0;
       z-index: 100;
       font-size: 14px;
       color: var(--accent1);
       border-bottom: 2px solid rgba(15,122,74,0.15);
       white-space: nowrap;
       vertical-align: middle;
       height: 44px;
       box-sizing: border-box;
   }

   .users-table td {
       padding: 12px 10px;
       font-size: 14px;
       border-bottom: 1px solid rgba(15,122,74,0.08);
       vertical-align: middle;
       color: var(--muted);
       text-align: center;
       height: 44px;
       box-sizing: border-box;
       line-height: 1.4;
       word-wrap: break-word;
       overflow: hidden;
       text-overflow: ellipsis;
       white-space: nowrap;
   }

   #logsTable td:nth-child(5) {
       white-space: normal;
       word-wrap: break-word;
       overflow-wrap: break-word;
       text-align: left;
       max-width: 300px;
       min-width: 200px;
       text-overflow: unset;
   }

   /* Center role badges */
   .users-table td:nth-child(3) {
    display: flex;
    justify-content: center;
    align-items: center;
   }

   .users-table tbody tr:hover {
    background: rgba(52,183,143,0.05);
   }

   /* Actions column */
   .actions-cell {
    display: flex;
    gap: 6px;
    align-items: center;
    justify-content: center;
   }

   .icon-btn {
    background: none;
    border: 0;
    font-size: 0.85rem;
    cursor: pointer;
    padding: 6px;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    transition: all 0.2s ease;
   }

   .icon-btn:hover {
    background: var(--light-green);
    color: var(--accent1);
    transform: translateY(-1px);
   }

   /* Button styles */
   .btn {
    border: 0;
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 600;
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    white-space: nowrap;
    height: 36px;
    box-sizing: border-box;
    position: relative;
   }

   .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
   }

   .btn-secondary {
    background: transparent;
    color: var(--accent1);
    border: 1px solid var(--accent1);
   }

   /* Save button loading state */
   .btn-saving {
    opacity: 0.8;
    pointer-events: none;
   }

   .btn-saving i {
    animation: spin 1s linear infinite;
   }

   @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
   }

   /* Modal styles - ALL MODALS SMALLER */
   .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 12px;
   }

   .modal-box {
    background: #fff;
    padding: 16px; /* Reduced from 20px */
    border-radius: var(--radius);
    max-width: 420px; /* Smaller width */
    width: 100%;
    box-shadow: var(--shadow-dark);
    animation: modalSlideIn 0.3s ease;
    max-height: 85vh;
    overflow-y: auto;
   }

   /* Smaller modal content */
   .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px; /* Reduced */
    padding-bottom: 10px; /* Reduced */
    border-bottom: 1px solid var(--border);
   }

   .modal-header h3 {
    margin: 0;
    color: var(--accent1);
    font-size: 1.1rem; /* Smaller font */
    display: flex;
    align-items: center;
    gap: 6px; /* Reduced */
   }

   .modal-body {
    margin-bottom: 12px; /* Reduced */
    padding: 0 2px; /* Reduced */
   }

   /* Delete confirmation modal */
   .modal-delete .modal-header {
    background: #ffeaea;
    margin: -16px -16px 16px -16px; /* Reduced margins */
    padding: 12px 16px; /* Reduced padding */
    border-radius: var(--radius) var(--radius) 0 0;
    border-bottom: 1px solid #ffcccc;
   }

   .modal-delete .modal-header h3 {
    color: #ff4444;
   }

   .modal-delete .modal-body {
    padding: 8px 0; /* Reduced */
   }

   .modal-delete .warning-icon {
    font-size: 2.2rem; /* Smaller icon */
    color: #ff7a00;
    text-align: center;
    margin-bottom: 10px; /* Reduced */
   }

   .modal-delete .warning-text {
    text-align: center;
    font-size: 0.9rem; /* Smaller font */
    color: var(--muted);
    margin-bottom: 8px; /* Reduced */
    line-height: 1.4;
   }

   .modal-delete .user-details {
    background: var(--light-green);
    padding: 10px; /* Reduced */
    border-radius: var(--radius-sm);
    margin: 10px 0; /* Reduced */
    text-align: center;
    font-size: 0.85rem; /* Smaller */
   }

   .modal-delete .user-details strong {
    color: var(--accent1);
    font-size: 0.95rem; /* Smaller */
   }

   .modal-delete .info-note {
    text-align: center;
    font-size: 0.8rem; /* Smaller */
    color: #666;
    margin-top: 8px; /* Reduced */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px; /* Reduced */
   }

   /* Reset password modal */
   .modal-reset .modal-header {
    background: #fff8e1;
    margin: -16px -16px 16px -16px; /* Reduced */
    padding: 12px 16px; /* Reduced */
    border-radius: var(--radius) var(--radius) 0 0;
    border-bottom: 1px solid #ffecb3;
   }

   .modal-reset .modal-header h3 {
    color: #ff9800;
   }

   .modal-reset .modal-body {
    padding: 8px 0; /* Reduced */
   }

   .modal-reset .reset-icon {
    font-size: 2.2rem; /* Smaller icon */
    color: #ff9800;
    text-align: center;
    margin-bottom: 10px; /* Reduced */
   }

   .modal-reset .reset-text {
    text-align: center;
    font-size: 0.9rem; /* Smaller font */
    color: var(--muted);
    margin-bottom: 8px; /* Reduced */
    line-height: 1.4;
   }

   .modal-reset .user-details {
    background: var(--light-green);
    padding: 10px; /* Reduced */
    border-radius: var(--radius-sm);
    margin: 10px 0; /* Reduced */
    text-align: center;
    font-size: 0.85rem; /* Smaller */
   }

   .modal-reset .user-details strong {
    color: var(--accent1);
    font-size: 0.95rem; /* Smaller */
   }

   .modal-reset .password-info {
    background: #e9f7f2;
    padding: 8px; /* Reduced */
    border-radius: var(--radius-sm);
    margin-top: 12px; /* Reduced */
    text-align: center;
    font-size: 0.8rem; /* Smaller */
    color: var(--accent1);
    border-left: 3px solid var(--accent1);
   }

   @keyframes modalSlideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
   }

   /* Form styles - Even Smaller */
   .form-group {
    margin-bottom: 10px; /* Reduced */
   }

   .form-group label {
    display: block;
    margin-bottom: 4px;
    font-size: 0.82rem; /* Smaller */
    color: var(--muted);
    font-weight: 500;
   }

   .form-control {
    width: 100%;
    padding: 7px 10px; /* Smaller padding */
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.85rem; /* Smaller */
    box-sizing: border-box;
    height: 36px; /* Fixed height for consistency */
   }

   .form-control:focus {
    outline: none;
    border-color: var(--accent1);
    box-shadow: 0 0 0 3px rgba(15,122,74,0.1);
   }

   .form-hint {
    font-size: 0.72rem; /* Smaller */
    color: var(--muted);
    margin-top: 3px; /* Reduced */
   }

   .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 16px; /* Reduced */
    padding-top: 12px; /* Reduced */
    border-top: 1px solid var(--border);
   }

   /* Adjust select elements to match height */
   .form-control select {
    height: 36px;
    padding: 0 10px;
   }

   /* Password toggle in modal - adjusted for smaller size */
   .modal-body .input-with-icon {
    position: relative;
   }

   .modal-body .input-with-icon .password-toggle {
    position: absolute;
    right: 8px; /* Reduced */
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 0.9rem; /* Smaller */
    padding: 3px; /* Reduced */
   }

   .modal-body .input-with-icon input {
    padding-right: 32px !important; /* Reduced */
   }

   /* Make button heights consistent with inputs */
   .btn {
    border: 0;
    padding: 7px 12px; /* Adjusted */
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 600;
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    font-size: 0.82rem; /* Smaller */
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    white-space: nowrap;
    height: 36px; /* Fixed height */
    box-sizing: border-box;
    position: relative;
   }

   /* Adjust icon sizes in modals */
   .modal-header .icon-btn {
    font-size: 0.9rem; /* Smaller */
    padding: 4px; /* Reduced */
   }

   /* Adjust logs modal size too */
   #logsModal .modal-box {
    max-width: 1100px; /* Reduced from 1200px */
    max-height: 75vh;
   }

   #logsModal .modal-header {
    margin-bottom: 10px;
    padding-bottom: 8px;
   }

   #logsModal .modal-header h3 {
    font-size: 1.1rem;
   }

   /* Tabs styling for logs modal */
   .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    border-bottom: 2px solid var(--border);
    padding-bottom: 4px;
   }

   .tab-btn {
    padding: 8px 16px;
    background: var(--light-green);
    border: none;
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    cursor: pointer;
    font-weight: 500;
    color: var(--muted);
    transition: all 0.2s ease;
    position: relative;
    bottom: -2px;
   }

   .tab-btn:hover {
    background: rgba(15,122,74,0.1);
   }

   .tab-btn.active {
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: white;
    box-shadow: 0 2px 4px rgba(15,122,74,0.2);
    border-bottom: 2px solid var(--accent1);
   }

   .tab-content {
    display: none;
   }

   .tab-content.active {
    display: block;
   }

   /* Sub-tabs for audit logs */
   .tab-btn-small {
       padding: 6px 12px;
       background: var(--light-green);
       border: none;
       border-radius: var(--radius-sm);
       cursor: pointer;
       font-weight: 500;
       color: var(--muted);
       transition: all 0.2s ease;
       font-size: 0.85rem;
       margin-right: 4px;
   }

   .tab-btn-small:hover {
       background: rgba(15,122,74,0.1);
   }

   .tab-btn-small.active {
       background: linear-gradient(90deg, var(--accent1), var(--accent2));
       color: white;
       box-shadow: 0 2px 4px rgba(15,122,74,0.2);
   }

   /* Status badges */
   .status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-block;
    min-width: 70px;
    text-align: center;
   }

   .status-online {
    background: #e9f7f2;
    color: #0f7a4a;
    border: 1px solid #0f7a4a;
   }

   .status-offline {
    background: #f0f0f0;
    color: #666;
    border: 1px solid #ddd;
   }

   .status-idle {
    background: #fff8e1;
    color: #ff9800;
    border: 1px solid #ff9800;
   }

   /* Mobile fixes for tables */
   @media (max-width: 768px) {
       .users-table-wrap {
           overflow-x: auto;
           min-width: 100%;
       }
       
       .users-table {
           table-layout: auto;
           min-width: 700px;
       }
       
       .users-table th,
       .users-table td {
           font-size: 12px;
           padding: 10px 8px;
       }
       
       .users-table th:nth-child(1),
       .users-table th:nth-child(2),
       .users-table th:nth-child(3),
       .users-table th:nth-child(4),
       .users-table th:nth-child(5),
       #activityTable th:nth-child(1),
       #activityTable th:nth-child(2),
       #activityTable th:nth-child(3),
       #activityTable th:nth-child(4),
       #activityTable th:nth-child(5),
       #activityTable th:nth-child(6),
       #logsTable th:nth-child(1),
       #logsTable th:nth-child(2),
       #logsTable th:nth-child(3),
       #logsTable th:nth-child(4),
       #logsTable th:nth-child(5) {
           width: auto !important;
           min-width: auto !important;
       }
       
       .users-table td {
           white-space: nowrap;
       }
       
       #logsTable td:nth-child(5) {
           white-space: normal;
           min-width: 150px;
           max-width: 200px;
       }

       /* Mobile modal adjustments - make even smaller on mobile */
       .modal-overlay {
           padding: 8px;
       }
       
       .modal-box {
           max-width: 92%;
           padding: 12px;
           margin: 8px;
       }
       
       .modal-header {
           margin-bottom: 10px;
           padding-bottom: 8px;
       }
       
       .modal-header h3 {
           font-size: 1rem;
       }
       
       .modal-delete .modal-header,
       .modal-reset .modal-header {
           margin: -12px -12px 12px -12px;
           padding: 10px 12px;
       }
       
       .modal-delete .warning-icon,
       .modal-reset .reset-icon {
           font-size: 1.8rem;
       }
       
       .modal-delete .warning-text,
       .modal-reset .reset-text {
           font-size: 0.85rem;
       }
       
       .form-group {
           margin-bottom: 8px;
       }
       
       .form-control {
           padding: 6px 8px;
           height: 34px;
           font-size: 0.82rem;
       }
       
       .btn {
           padding: 6px 10px;
           height: 34px;
           font-size: 0.8rem;
       }
       
       /* Logs modal on mobile */
       #logsModal .modal-box {
           max-width: 98%;
           max-height: 85vh;
       }
       
       #logsModal .modal-header h3 {
           font-size: 1rem;
       }
       
       .form-actions {
           flex-direction: column;
           gap: 8px;
       }
       
       .form-actions .btn {
           width: 100%;
           justify-content: center;
       }
       
       .toolbar-row-1 {
        flex-direction: column;
        gap: 8px;
       }
       
       .toggle-buttons {
           width: 100%;
           justify-content: center;
       }
       
       .toolbar-row-2 {
           justify-content: space-between;
           flex-wrap: wrap;
       }
       
       .cards-row {
           flex-direction: column;
       }
       
       .card {
           min-width: 100%;
       }
       
       .actions-cell {
           justify-content: flex-start;
       }
   }
</style>
</head>
<body>
    <!-- Background pattern -->
    <div class="bg-pattern">
        <div class="bg-circle circle-1"></div>
        <div class="bg-circle circle-2"></div>
        <div class="bg-circle circle-3"></div>
    </div>
<div class="page-container">

  <header class="topbar">
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div class="brand-text">
        <h1>PUROK KALIGTASAN</h1>
        <p>DRRMO Alitagtag ‚Äì Household Records System</p>
      </div>
    </div>

<div class="user-info">
    <!-- ADD THIS LINE: -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <span id="userName"></span>
    <button id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
    </button>
</div>
  </header>

  <!-- Error Message (for consistency with charts.html) -->
  <div class="error-message" id="errorMessage" style="display: none;">
    <i class="fas fa-exclamation-triangle"></i> 
    <span id="errorText">Failed to fetch data. Please check your connection.</span>
    <button onclick="document.getElementById('errorMessage').style.display = 'none'" style="float:right; background:none; border:none; color:#c00; cursor:pointer;">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-container">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul>
        <li><a href="dashboard.html" title="Dashboard"><span class="menu-icon">üìä</span> <span class="menu-text">Dashboard</span></a></li>
        <li><a href="dataForm.html" title="Data Entry"><span class="menu-icon">üìù</span> <span class="menu-text">Data Entry</span></a></li>
        <li><a href="records.html" title="Records"><span class="menu-icon">üìÅ</span> <span class="menu-text">Records & Management</span></a></li>
        <li><a href="charts.html" title="Charts"><span class="menu-icon">üìà</span> <span class="menu-text">Charts & Analytics</span></a></li>
        <li class="admin-only"><a href="users.html" class="active" title="User Management"><span class="menu-icon">üë•</span> <span class="menu-text">User Management</span></a></li>
      </ul>
      
      <!-- REMOVED: Mobile Logout Button in Sidebar -->
    </div>
  </aside>

  <main class="content-area">
    <div class="content-header">
      <h2><span style="color: var(--accent1);">üë•</span> User Management</h2>
    </div>
     <div id="disc">The User Management section allows administrators to create, update, and control access for all system users. It ensures that only authorized personnel can view, edit, or manage household records. Through this section, admins can assign roles, reset passwords, activate or deactivate accounts, and monitor user activity to maintain data security and system integrity.</div>

    <!-- Toolbar -->
    <div class="toolbar">
      <!-- Row with Search and Toggle Buttons -->
      <div class="toolbar-row-1">
        <!-- Full Width Search Bar -->
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input id="filterUser" class="search-box" placeholder="Search by username or full name..." />
        </div>
        
        <!-- Toggle Buttons Only (right side) -->
        <div class="toggle-buttons" id="roleToggle">
          <button class="toggle-btn active" data-role="all">All</button>
          <button class="toggle-btn" data-role="Admin">Admin</button>
          <button class="toggle-btn" data-role="Staff">Staff</button>
        </div>
      </div>
      
      <div class="toolbar-row-2">
        <button id="viewLogsBtn" class="btn btn-secondary">
          <i class="fas fa-history"></i> View Logs
        </button>
        <button id="openAddUser" class="btn">
          <i class="fas fa-user-plus"></i> Add User
        </button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="cards-row">
      <div class="card">
        <h3>Total Users</h3>
        <div id="statTotal" class="stat-value">0</div>
      </div>
      <div class="card">
        <h3>Admins</h3>
        <div id="statAdmins" class="stat-value">0</div>
      </div>
      <div class="card">
        <h3>Staff</h3>
        <div id="statStaff" class="stat-value">0</div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="users-table-wrap">
      <table class="users-table" id="usersTable">
        <thead>
          <tr>
            <th>Username</th>
            <th>Full Name</th>
            <th>Role</th>
            <th>Barangay</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersBody">
          <tr><td colspan="5" style="text-align: center; padding: 20px;">Loading users...</td></tr>
        </tbody>
      </table>
    </div>

  </main>
</div>

<!-- Mobile Bottom Navigation - Fixed - REMOVED LOGOUT BUTTON -->
<nav class="mobile-bottom-nav" id="mobileBottomNav">
  <div class="mobile-nav-items">
    <a href="dashboard.html" class="mobile-nav-item" title="Dashboard">
      <span class="mobile-nav-icon">üìä</span>
      <span class="mobile-nav-text">Dashboard</span>
    </a>
    <a href="dataForm.html" class="mobile-nav-item" title="Data Entry">
      <span class="mobile-nav-icon">üìù</span>
      <span class="mobile-nav-text">Data Entry</span>
    </a>
    <a href="records.html" class="mobile-nav-item" title="Records">
      <span class="mobile-nav-icon">üìÅ</span>
      <span class="mobile-nav-text">Records</span>
    </a>
    <a href="charts.html" class="mobile-nav-item" title="Charts">
      <span class="mobile-nav-icon">üìà</span>
      <span class="mobile-nav-text">Charts</span>
    </a>
    <a href="users.html" class="mobile-nav-item active admin-only" title="Users" id="mobileUsersNav">
      <span class="mobile-nav-icon">üë•</span>
      <span class="mobile-nav-text">Users</span>
    </a>
    <!-- REMOVED: Logout button in mobile nav -->
  </div>
</nav>

<!-- Add/Edit User Modal -->
<div id="userModal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="modalTitle"><i class="fas fa-user"></i> Add New User</h3>
      <button id="closeModal" class="icon-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="userForm">
        <div class="form-group">
          <label for="user_username">Username *</label>
          <input id="user_username" class="form-control" required />
        </div>
        <div class="form-group">
          <label for="user_fullname">Full Name</label>
          <input id="user_fullname" class="form-control" />
        </div>
        <div class="form-group">
          <label for="user_role">Role</label>
          <select id="user_role" class="form-control">
            <option value="Staff">Staff</option>
            <option value="Admin">Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label for="user_barangay">Assigned Barangay</label>
          <select id="user_barangay" class="form-control">
            <option value="">ALL</option>
            <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
            <option>Dalipit East</option><option>Dalipit West</option>
            <option>Dominador East</option><option>Dominador West</option>
            <option>Munlawin Sur</option><option>Munlawin Norte</option>
            <option>Muzon Primero</option><option>Muzon Segundo</option>
            <option>Pinagkurusan</option><option>Ping-As</option>
            <option>Poblacion East</option><option>Poblacion West</option>
            <option>San Jose</option><option>San Juan</option>
            <option>Santa Cruz</option><option>Tadlac</option>
          </select>
        </div>
        <div class="form-group">
          <label for="user_password">Password</label>
          <div class="input-with-icon">
            <input id="user_password" type="password" class="form-control" placeholder="Enter new password" />
            <button type="button" class="password-toggle" id="toggleModalPassword">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <div class="form-hint">Leave blank when editing to keep current password</div>
        </div>
      </form>
    </div>
    <div class="form-actions">
      <button id="cancelModal" class="btn btn-secondary">Cancel</button>
      <button id="saveUserBtn" class="btn">
        <i class="fas fa-save"></i> Save
      </button>
    </div>
  </div>
</div>

<!-- Reset Password Modal -->
<div id="resetModal" class="modal-overlay">
  <div class="modal-box modal-reset">
    <div class="modal-header">
      <h3><i class="fas fa-key"></i> Reset Password</h3>
      <button id="closeResetModal" class="icon-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="reset-icon">
        <i class="fas fa-unlock-alt"></i>
      </div>
      <div class="reset-text">
        Are you sure you want to reset the password for this user?
      </div>
      <div class="user-details">
        User: <strong id="resetUserName"></strong>
      </div>
      <div class="password-info">
        <i class="fas fa-info-circle"></i> The password will be reset to: <strong>password123</strong>
      </div>
      <div style="text-align: center; font-size: 0.85rem; color: #666; margin-top: 15px;">
        <i class="fas fa-exclamation-triangle"></i> User will need to change their password on next login.
      </div>
    </div>
    <div class="form-actions">
      <button id="cancelReset" class="btn btn-secondary">Cancel</button>
      <button id="confirmReset" class="btn" style="background: linear-gradient(90deg, #ff9800, #ffb74d);">
        <i class="fas fa-redo"></i> Reset Password
      </button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal-overlay">
  <div class="modal-box modal-delete">
    <div class="modal-header">
      <h3><i class="fas fa-exclamation-triangle"></i> Confirm Delete</h3>
      <button id="closeDeleteModal" class="icon-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="warning-icon">
        <i class="fas fa-exclamation-circle"></i>
      </div>
      <div class="warning-text">
        Are you sure you want to delete this user? This action cannot be undone.
      </div>
      <div class="user-details">
        Deleting user: <strong id="deleteUserName"></strong>
      </div>
      <div class="info-note">
        <i class="fas fa-info-circle"></i> All associated data will be permanently removed.
      </div>
    </div>
    <div class="form-actions">
      <button id="cancelDelete" class="btn btn-secondary">Cancel</button>
      <button id="confirmDelete" class="btn" style="background: linear-gradient(90deg, var(--accent3), var(--accent4));">
        <i class="fas fa-trash"></i> Delete User
      </button>
    </div>
  </div>
</div>

<!-- Enhanced Logs Modal with User Activity -->
<div id="logsModal" class="modal-overlay">
  <div class="modal-box" style="max-width: 1100px; max-height: 75vh; overflow-y: auto;">
    <div class="modal-header">
      <h3><i class="fas fa-user-clock"></i> User Activity & Audit Logs</h3>
      <button id="closeLogsModal" class="icon-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="tabs">
      <button class="tab-btn active" data-tab="activity">User Activity</button>
      <button class="tab-btn" data-tab="audit">Audit Logs</button>
    </div>
    
    <!-- User Activity Tab - FIXED TABLE -->
    <div class="tab-content active" id="activityTab">
      <div class="stats-container" style="justify-content: flex-start; margin-bottom: 16px;">
        <div class="stat-item">
          <span>Online Now</span>
          <div id="statOnline" class="value" style="color: #0f7a4a;">0</div>
        </div>
        <div class="stat-item">
          <span>Active Today</span>
          <div id="statToday" class="value">0</div>
        </div>
        <div class="stat-item">
          <span>Total Users</span>
          <div id="statTotalUsers" class="value">0</div>
        </div>
      </div>
      
      <div class="search-container" style="margin-bottom: 16px;">
        <i class="fas fa-search"></i>
        <input id="searchActivity" class="search-box" placeholder="Search users..." />
      </div>
      
      <div class="users-table-wrap" style="min-height: 300px;">
        <table class="users-table" id="activityTable">
          <thead>
            <tr>
              <th>Username</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Last Activity</th>
              <th>Active Time</th>
              <th>Session Duration</th>
            </tr>
          </thead>
          <tbody id="activityBody">
            <tr><td colspan="6" style="text-align: center; padding: 20px;">Loading activity data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Audit Logs Tab - WITH CATEGORIES -->
    <div class="tab-content" id="auditTab">
      <div class="tabs" style="margin-bottom: 16px; border-bottom: 1px solid var(--border);">
        <button class="tab-btn-small active" data-category="all">All Logs</button>
        <button class="tab-btn-small" data-category="today">Today</button>
        <button class="tab-btn-small" data-category="yesterday">Yesterday</button>
        <button class="tab-btn-small" data-category="older">Older</button>
      </div>
      
      <div class="search-container" style="margin-bottom: 16px;">
        <i class="fas fa-search"></i>
        <input id="searchAudit" class="search-box" placeholder="Search audit logs..." />
      </div>
      
<div class="users-table-wrap" style="min-height: 300px;">
  <table class="users-table" id="logsTable">
    <thead>
      <tr>
        <th style="width: 20%;">Timestamp</th>
        <th style="width: 15%;">Action</th>
        <th style="width: 15%;">Actor</th>
        <th style="width: 15%;">Target</th>
        <th style="width: 35%; text-align: left;">Details</th>
      </tr>
    </thead>
    <tbody id="logsBody">
      <tr><td colspan="5" style="text-align: center; padding: 20px;">Loading logs...</td></tr>
    </tbody>
  </table>
      </div>
    </div>
    
    <div class="form-actions">
      <button id="refreshLogs" class="btn btn-secondary">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
      <button id="closeLogsBtn" class="btn">Close</button>
    </div>
  </div>
</div>

<script>
/* ============ CONFIG ============ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";

/* ============ STATE ============ */
let ALL_USERS = [];
let EDIT_TARGET = null;
let CURRENT_ROLE_FILTER = 'all';
let AUDIT_LOGS_DATA = null;
let DELETE_TARGET_USER = null;
let RESET_TARGET_USER = null;

/* ============ SESSION CHECK ============ */
async function sessionCheck(){
  try {
    const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
    
    if (userName && userName !== "User") {
      document.getElementById('userName').innerText = userName;
      
      const userRole = localStorage.getItem("userRole");
      const isAdmin = userRole === "admin" || userRole === "Admin";
      const adminItems = document.querySelectorAll(".admin-only");
      adminItems.forEach(item => {
          item.classList.toggle("admin-visible", isAdmin);
      });
      
      // Handle mobile nav for admin
      const mobileUsersNav = document.getElementById('mobileUsersNav');
      if (mobileUsersNav) {
          mobileUsersNav.classList.toggle("admin-visible", isAdmin);
      }
      
      sessionStorage.setItem('authenticated', 'true');
      return true;
    } else {
      if(sessionStorage.getItem('authenticated')) {
        document.getElementById('userName').innerText = "User";
        return true;
      } else {
        window.location.href = 'index.html?session=expired';
        return false;
      }
    }
  } catch(e){ 
    console.warn('session check failed', e);
    return false;
  }
}

function isProtectedAdmin(user) {
  // Check if it's the specific admin with username 'admin'
  // You can also verify the password hash if available
  return user && user.Username.toLowerCase() === 'admin';
}

// Also add a constant for the protected username
const PROTECTED_ADMIN_USERNAME = 'admin';

/* ============ LOGOUT ============ */
function handleLogout() {
  const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
  
  localStorage.clear();
  sessionStorage.clear();
  
  const logoutUrl = 'index.html?logout=true&t=' + Date.now();
  
  fetch(SCRIPT_URL+'?action=logout&t=' + Date.now())
    .catch(() => {})
    .finally(() => {
      window.location.replace(logoutUrl);
    });
}

/* ============ TOAST NOTIFICATION ============ */
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  toast.style.background = type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : 'var(--accent1)';
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

/* ============ LOAD USERS ============ */
async function loadUsers() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=users`);
    const text = await res.text();
    
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      showToast("Invalid response from server", "error");
      return;
    }
    
    if (!data.success) {
      showToast("Failed to load users: " + (data.message || "Unknown error"), "error");
      return;
    }
    
    ALL_USERS = data.users || [];
    renderUsers();
    updateStats();
  } catch(err) {
    showToast("Error loading users: " + err.message, "error");
  }
}

/* ============ RENDER USERS ============ */
function renderUsers(filter = "", roleFilter = CURRENT_ROLE_FILTER) {
  const tbody = document.getElementById("usersBody");
  tbody.innerHTML = "";
  
  let filtered = ALL_USERS;
  if (roleFilter !== 'all') {
    filtered = ALL_USERS.filter(user => 
      user.Role.toLowerCase() === roleFilter.toLowerCase()
    );
  }
  
  if (filter) {
    filtered = filtered.filter(user => {
      const searchStr = `${user.Username} ${user.FullName} ${user.Role} ${user.AssignedBarangay}`.toLowerCase();
      return searchStr.includes(filter.toLowerCase());
    });
  }
  
  if (filtered.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; padding: 40px 20px; color: var(--muted); font-style: italic;">
          No users found
        </td>
      </tr>
    `;
    return;
  }
  
  filtered.forEach(user => {
    const tr = document.createElement("tr");
    const isProtected = isProtectedAdmin(user);
    
    // Create action buttons - ALL disabled for protected admin
    let actionButtonsHtml = '';
    if (isProtected) {
      actionButtonsHtml = `
        <button class="icon-btn" disabled title="Protected admin cannot be edited" style="opacity: 0.5; cursor: not-allowed;">
          <i class="fas fa-edit" style="color: #ccc;"></i>
        </button>
        <button class="icon-btn" disabled title="Protected admin password cannot be reset" style="opacity: 0.5; cursor: not-allowed;">
          <i class="fas fa-key" style="color: #ccc;"></i>
        </button>
        <button class="icon-btn" disabled title="Protected admin cannot be deleted" style="opacity: 0.5; cursor: not-allowed;">
          <i class="fas fa-trash" style="color: #ccc;"></i>
        </button>
      `;
    } else {
      actionButtonsHtml = `
        <button class="icon-btn" onclick="editUser('${escapeHtml(user.Username)}')" title="Edit">
          <i class="fas fa-edit"></i>
        </button>
        <button class="icon-btn" onclick="showResetModal('${escapeHtml(user.Username)}')" title="Reset Password">
          <i class="fas fa-key"></i>
        </button>
        <button class="icon-btn" onclick="showDeleteModal('${escapeHtml(user.Username)}')" title="Delete" style="color: #ff4444;">
          <i class="fas fa-trash"></i>
        </button>
      `;
    }
    
    // Add a badge for protected admin
    let protectedBadge = '';
    if (isProtected) {
      protectedBadge = '<span style="color: #0f7a4a; font-weight: bold; font-size: 0.8rem; background: #e9f7f2; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">üîí Protected</span>';
    }
    
    tr.innerHTML = `
      <td>
        ${escapeHtml(user.Username)}
        ${protectedBadge}
      </td>
      <td>${escapeHtml(user.FullName)}</td>
      <td>
        <span style="padding: 4px 10px; border-radius: 12px; background: ${user.Role === 'Admin' ? '#e9f7f2' : '#f0f0f0'}; color: ${user.Role === 'Admin' ? '#0f7a4a' : '#666'}; display: inline-block;">
          ${user.Role}
        </span>
      </td>
      <td>${escapeHtml(user.AssignedBarangay || '')}</td>
      <td class="actions-cell">
        ${actionButtonsHtml}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ============ UPDATE STATS ============ */
function updateStats() {
  const total = ALL_USERS.length;
  const admins = ALL_USERS.filter(u => u.Role === 'Admin' || u.Role === 'admin').length;
  const staff = ALL_USERS.filter(u => u.Role === 'Staff' || u.Role === 'staff').length;
  
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statAdmins').textContent = admins;
  document.getElementById('statStaff').textContent = staff;
}

/* ============ ROLE TOGGLE ============ */
function setupRoleToggle() {
  const toggleButtons = document.querySelectorAll('#roleToggle .toggle-btn');
  
  const savedFilter = localStorage.getItem('roleFilter');
  if (savedFilter) {
    CURRENT_ROLE_FILTER = savedFilter;
  }
  
  toggleButtons.forEach(btn => {
    if (btn.getAttribute('data-role') === CURRENT_ROLE_FILTER) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  
  toggleButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      toggleButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      const role = this.getAttribute('data-role');
      CURRENT_ROLE_FILTER = role;
      localStorage.setItem('roleFilter', role);
      
      const searchFilter = document.getElementById('filterUser').value;
      renderUsers(searchFilter, role);
    });
  });
}

/* ============ USER OPERATIONS ============ */
function openUserModal(mode = 'add', username = null) {
  EDIT_TARGET = username;
  
  const modal = document.getElementById('userModal');
  const title = document.getElementById('modalTitle');
  const form = document.getElementById('userForm');
  const saveBtn = document.getElementById('saveUserBtn');
  
  // Reset button state
  saveBtn.disabled = false;
  saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
  saveBtn.classList.remove('btn-saving');
  
  form.reset();
  
  if (mode === 'edit' && username) {
    title.innerHTML = '<i class="fas fa-user-edit"></i> Edit User';
    const user = ALL_USERS.find(u => u.Username === username);
    if (user) {
      document.getElementById('user_username').value = user.Username;
      document.getElementById('user_fullname').value = user.FullName;
      document.getElementById('user_role').value = user.Role;
      document.getElementById('user_barangay').value = user.AssignedBarangay || '';
      document.getElementById('user_username').disabled = true;
      document.getElementById('user_password').required = false;
      document.getElementById('user_password').placeholder = "Leave blank to keep current password";
    }
  } else {
    title.innerHTML = '<i class="fas fa-user-plus"></i> Add New User';
    document.getElementById('user_username').disabled = false;
    document.getElementById('user_password').required = true;
    document.getElementById('user_password').placeholder = "Enter new password";
  }
  
  const toggleIcon = document.querySelector('#toggleModalPassword i');
  if (toggleIcon) {
    toggleIcon.className = 'fas fa-eye';
  }
  const passwordInput = document.getElementById('user_password');
  if (passwordInput) {
    passwordInput.type = 'password';
  }
  
  modal.style.display = 'flex';
  setupPasswordToggle();
}

function editUser(username) {
  const user = ALL_USERS.find(u => u.Username === username);
  
  // Prevent editing username of protected admin
  if (user && isProtectedAdmin(user)) {
    showToast('The main admin account (username: admin) is protected. Username cannot be changed.', 'error');
    return;
  }
  
  openUserModal('edit', username);
}

async function saveUser() {
  const username = document.getElementById('user_username').value.trim();
  const fullname = document.getElementById('user_fullname').value.trim();
  const role = document.getElementById('user_role').value;
  const barangay = document.getElementById('user_barangay').value;
  const password = document.getElementById('user_password').value.trim();
  
  const currentUser = localStorage.getItem("username") || 
                     localStorage.getItem("staffName") || 
                     "System";
  
  if (!username) {
    showToast('Username is required', 'error');
    return;
  }
  
  if (!EDIT_TARGET && !password) {
    showToast('Password is required for new users', 'error');
    return;
  }
  
  // Change button state
  const saveBtn = document.getElementById('saveUserBtn');
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = EDIT_TARGET ? 
    '<i class="fas fa-spinner fa-spin"></i> Updating User...' : 
    '<i class="fas fa-spinner fa-spin"></i> Creating User...';
  saveBtn.disabled = true;
  saveBtn.classList.add('btn-saving');
  
  try {
    const formData = new FormData();
    formData.append('action', EDIT_TARGET ? 'updateUser' : 'createUser');
    formData.append('actor', currentUser);
    
    formData.append('Username', username);
    formData.append('FullName', fullname);
    formData.append('Role', role);
    formData.append('AssignedBarangay', barangay);
    
    if (password) {
      formData.append('Password', password);
    }
    
    if (EDIT_TARGET) {
      formData.append('target', EDIT_TARGET);
    }
    
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });
    
    const text = await res.text();
    
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      showToast("Invalid response from server", "error");
      return;
    }
    
    if (data.success) {
      showToast(data.message || 'User saved successfully', 'success');
      closeUserModal();
      loadUsers();
    } else {
      showToast(data.message || 'Failed to save user', 'error');
    }
  } catch(err) {
    showToast('Error saving user: ' + err.message, 'error');
  } finally {
    // Restore button state
    saveBtn.disabled = false;
    saveBtn.innerHTML = originalText;
    saveBtn.classList.remove('btn-saving');
  }
}

/* ============ RESET PASSWORD WITH MODAL ============ */
function showResetModal(username) {
  const user = ALL_USERS.find(u => u.Username === username);
  
  // PROTECTION: Check if trying to reset password for protected admin
  if (user && isProtectedAdmin(user)) {
    showToast('The main admin account (username: admin) password cannot be reset from here. Please use the main admin panel.', 'error');
    return;
  }
  
  RESET_TARGET_USER = username;
  
  if (user) {
    document.getElementById('resetUserName').textContent = `${user.Username} (${user.FullName})`;
  } else {
    document.getElementById('resetUserName').textContent = username;
  }
  
  document.getElementById('resetModal').style.display = 'flex';
}

async function resetPassword() {
  if (!RESET_TARGET_USER) return;
  
  // Check if trying to reset protected admin password
  const user = ALL_USERS.find(u => u.Username === RESET_TARGET_USER);
  if (user && isProtectedAdmin(user)) {
    showToast('Protected admin password cannot be reset', 'error');
    closeResetModal();
    return;
  }
  
  const username = RESET_TARGET_USER;
  const currentUser = localStorage.getItem("username") || 
                     localStorage.getItem("staffName") || 
                     "System";
  
  // Change button state
  const resetBtn = document.getElementById('confirmReset');
  const originalText = resetBtn.innerHTML;
  resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
  resetBtn.disabled = true;
  
  try {
    const formData = new FormData();
    formData.append('action', 'resetPassword');
    formData.append('target', username);
    formData.append('actor', currentUser);
    
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });
    
    const text = await res.text();
    
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      showToast("Invalid response from server", "error");
      return;
    }
    
    if (data.success) {
      showToast(data.message || 'Password reset successfully', 'success');
      closeResetModal();
    } else {
      showToast(data.message || 'Failed to reset password', 'error');
    }
  } catch(err) {
    showToast('Error resetting password: ' + err.message, 'error');
  } finally {
    // Restore button state
    resetBtn.disabled = false;
    resetBtn.innerHTML = originalText;
  }
}

function closeResetModal() {
  document.getElementById('resetModal').style.display = 'none';
  RESET_TARGET_USER = null;
}

/* ============ DELETE USER WITH MODAL ============ */
function showDeleteModal(username) {
  const user = ALL_USERS.find(u => u.Username === username);
  
  // PROTECTION: Check if trying to delete the specific protected admin
  if (user && isProtectedAdmin(user)) {
    showToast('The main admin account (username: admin) is protected and cannot be deleted', 'error');
    return;
  }
  
  DELETE_TARGET_USER = username;
  
  if (user) {
    document.getElementById('deleteUserName').textContent = `${user.Username} (${user.FullName})`;
  } else {
    document.getElementById('deleteUserName').textContent = username;
  }
  
  document.getElementById('deleteModal').style.display = 'flex';
}

async function deleteUser() {
  if (!DELETE_TARGET_USER) return;
  
  // Double-check protection
  const user = ALL_USERS.find(u => u.Username === DELETE_TARGET_USER);
  if (user && isProtectedAdmin(user)) {
    showToast('Protected admin account cannot be deleted', 'error');
    closeDeleteModal();
    return;
  }
  
  const username = DELETE_TARGET_USER;
  const currentUser = localStorage.getItem("username") || 
                     localStorage.getItem("staffName") || 
                     "System";
  
  // Change button state
  const deleteBtn = document.getElementById('confirmDelete');
  const originalText = deleteBtn.innerHTML;
  deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
  deleteBtn.disabled = true;
  
  try {
    const formData = new FormData();
    formData.append('action', 'deleteUser');
    formData.append('target', username);
    formData.append('actor', currentUser);
    
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });
    
    const text = await res.text();
    
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      showToast("Invalid response from server", "error");
      return;
    }
    
    if (data.success) {
      showToast(data.message || 'User deleted successfully', 'success');
      closeDeleteModal();
      loadUsers();
    } else {
      showToast(data.message || 'Failed to delete user', 'error');
    }
  } catch(err) {
    showToast('Error deleting user: ' + err.message, 'error');
  } finally {
    // Restore button state
    deleteBtn.disabled = false;
    deleteBtn.innerHTML = originalText;
  }
}

function closeDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
  DELETE_TARGET_USER = null;
}

/* ============ LOAD USER ACTIVITY ============ */
async function loadUserActivity() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=userActivity`);
    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      showToast("Invalid response from server", "error");
      return;
    }
    
    const tbody = document.getElementById('activityBody');
    tbody.innerHTML = '';
    
    if (!data.success || !data.activities || data.activities.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">No activity data available</td></tr>`;
      updateActivityStats([]);
      return;
    }
    
    updateActivityStats(data.activities);
    
    data.activities.forEach(activity => {
      const tr = document.createElement('tr');
      
      let statusClass = 'status-offline';
      let statusText = 'Offline';
      
      if (activity.IsOnline === 'Online') {
        const lastActivity = new Date(activity.LastActivity);
        const now = new Date();
        const minutesSinceActivity = Math.floor((now - lastActivity) / (1000 * 60));
        
        if (minutesSinceActivity < 5) {
          statusClass = 'status-online';
          statusText = 'Online';
        } else if (minutesSinceActivity < 15) {
          statusClass = 'status-idle';
          statusText = 'Idle';
        } else {
          statusClass = 'status-offline';
          statusText = 'Away';
        }
      }
      
      const lastLogin = activity.LastLogin ? 
        new Date(activity.LastLogin).toLocaleString('en-PH') : 'Never';
      
      const lastActivityTime = activity.LastActivity ? 
        new Date(activity.LastActivity).toLocaleString('en-PH') : 'Never';
      
      const timeAgo = activity.TimeAgo || 'N/A';
      const sessionDuration = activity.SessionDuration || 'N/A';
      
      tr.innerHTML = `
        <td><strong>${escapeHtml(activity.Username)}</strong></td>
        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
        <td><small>${lastLogin}</small></td>
        <td><small>${lastActivityTime}</small><br><small style="color: var(--muted);">${timeAgo}</small></td>
        <td>${timeAgo}</td>
        <td>${sessionDuration}</td>
      `;
      tbody.appendChild(tr);
    });
    
  } catch(err) {
    showToast('Error loading activity: ' + err.message, 'error');
  }
}

function updateActivityStats(activities) {
  const now = new Date();
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let onlineCount = 0;
  let todayActiveCount = 0;
  
  activities.forEach(activity => {
    if (activity.IsOnline === 'Online' && activity.LastActivity) {
      const lastActivity = new Date(activity.LastActivity);
      const minutesSinceActivity = Math.floor((now - lastActivity) / (1000 * 60));
      if (minutesSinceActivity < 15) {
        onlineCount++;
      }
    }
    
    if (activity.LastActivity) {
      const lastActivity = new Date(activity.LastActivity);
      if (lastActivity >= today) {
        todayActiveCount++;
      }
    }
  });
  
  document.getElementById('statOnline').textContent = onlineCount;
  document.getElementById('statToday').textContent = todayActiveCount;
  document.getElementById('statTotalUsers').textContent = activities.length;
  
  const onlineStat = document.getElementById('statOnline');
  onlineStat.style.color = onlineCount > 0 ? '#0f7a4a' : '#666';
}

/* ============ LOAD AUDIT LOGS ============ */
async function loadAuditLogs() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=logs`);
    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      showToast("Invalid response from server", "error");
      return;
    }
    
    if (!data.success) {
      showToast("Failed to load logs: " + (data.message || "Unknown error"), "error");
      return;
    }
    
    AUDIT_LOGS_DATA = data;
    displayAuditLogs('all');
    
  } catch(err) {
    showToast('Error loading logs: ' + err.message, 'error');
  }
}

/* ============ DISPLAY AUDIT LOGS ============ */
function displayAuditLogs(category = 'all') {
  const tbody = document.getElementById('logsBody');
  tbody.innerHTML = '';
  
  if (!AUDIT_LOGS_DATA) {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">No logs data available</td></tr>`;
    return;
  }
  
  const logs = category === 'all' ? AUDIT_LOGS_DATA.logs || [] :
              category === 'today' ? AUDIT_LOGS_DATA.today || [] :
              category === 'yesterday' ? AUDIT_LOGS_DATA.yesterday || [] :
              AUDIT_LOGS_DATA.older || [];
  
  if (logs.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; padding: 20px; color: var(--muted); font-style: italic;">
          No ${category === 'all' ? '' : category} logs found
        </td>
      </tr>
    `;
    return;
  }
  
  logs.forEach((log) => {
    const tr = document.createElement('tr');
    
    const timestamp = log.FormattedTimestamp || 
                     formatTimestamp(log["Timestamp"] || log.Timestamp || '');
    const action = log["Action"] || log.Action || '';
    const actor = log["Actor"] || log.Actor || '';
    const target = log["TargetSheet"] || log.TargetSheet || log["Target"] || log.Target || '';
    const details = log["Details"] || log.Details || '';
    
    let actionBadgeStyle = '';
    if (action.includes('Login')) {
      actionBadgeStyle = 'background: #e9f7f2; color: #0f7a4a;';
    } else if (action.includes('Delete')) {
      actionBadgeStyle = 'background: #ffeaea; color: #ff4444;';
    } else if (action.includes('Create')) {
      actionBadgeStyle = 'background: #e9f7f2; color: #0f7a4a;';
    } else if (action.includes('Update')) {
      actionBadgeStyle = 'background: #fff8e1; color: #ff9800;';
    } else if (action.includes('Force')) {
      actionBadgeStyle = 'background: #fff0f5; color: #ff66b2;';
    } else {
      actionBadgeStyle = 'background: #f0f0f0; color: #666;';
    }
    
    tr.innerHTML = `
      <td><small style="white-space: nowrap;">${escapeHtml(timestamp)}</small></td>
      <td><span style="padding: 2px 8px; border-radius: 12px; ${actionBadgeStyle} font-weight: 600; font-size: 0.8rem;">${escapeHtml(action)}</span></td>
      <td>${escapeHtml(actor)}</td>
      <td>${escapeHtml(target)}</td>
      <td style="text-align: left; white-space: normal; word-wrap: break-word;">
        <small>${escapeHtml(details)}</small>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function formatTimestamp(timestamp) {
  if (!timestamp) return '';
  try {
    const date = new Date(timestamp);
    return isNaN(date.getTime()) ? String(timestamp) : date.toLocaleString('en-PH');
  } catch (e) {
    return String(timestamp);
  }
}

/* ============ TAB FUNCTIONALITY ============ */
function setupTabs() {
  // Main tabs
  const mainTabBtns = document.querySelectorAll('.tab-btn');
  const mainTabContents = document.querySelectorAll('.tab-content');
  
  mainTabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      mainTabBtns.forEach(b => b.classList.remove('active'));
      mainTabContents.forEach(c => c.classList.remove('active'));
      
      this.classList.add('active');
      const tabId = this.getAttribute('data-tab');
      document.getElementById(`${tabId}Tab`).classList.add('active');
      
      if (tabId === 'activity') {
        loadUserActivity();
      } else {
        loadAuditLogs();
      }
    });
  });
  
  // Audit log sub-tabs
  const subTabBtns = document.querySelectorAll('#auditTab .tab-btn-small');
  
  subTabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      subTabBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      const category = this.getAttribute('data-category');
      displayAuditLogs(category);
    });
  });
}

/* ============ PASSWORD TOGGLE ============ */
function setupPasswordToggle() {
  const toggleBtn = document.getElementById('toggleModalPassword');
  const passwordInput = document.getElementById('user_password');
  
  if (toggleBtn && passwordInput) {
    toggleBtn.addEventListener('click', function() {
      const icon = this.querySelector('i');
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        passwordInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    });
  }
}

/* ============ MODAL CONTROLS ============ */
function closeUserModal() {
  document.getElementById('userModal').style.display = 'none';
  EDIT_TARGET = null;
}

function closeLogsModal() {
  document.getElementById('logsModal').style.display = 'none';
}

/* ============ SIDEBAR TOGGLE ============ */
function toggleSidebar() {
    const pageContainer = document.querySelector('.page-container');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const icon = sidebarToggle.querySelector('i');
    
    pageContainer.classList.toggle('collapsed');
    
    if (pageContainer.classList.contains('collapsed')) {
        icon.className = 'fas fa-chevron-right';
        sidebarToggle.title = "Expand sidebar";
    } else {
        icon.className = 'fas fa-bars';
        sidebarToggle.title = "Collapse sidebar";
    }
}

/* ============ UTILITY FUNCTIONS ============ */
function escapeHtml(text) {
  if (text === null || text === undefined) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/* ============ SEARCH FUNCTIONALITY ============ */
function setupSearch() {
  // User search
  document.getElementById('filterUser').addEventListener('input', (e) => {
    renderUsers(e.target.value, CURRENT_ROLE_FILTER);
  });
  
  // Activity search
  document.getElementById('searchActivity').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#activityBody tr');
    
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });
  
  // Audit search
  document.getElementById('searchAudit').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#logsBody tr');
    
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });
}

/* ============ INITIALIZATION ============ */
window.addEventListener('DOMContentLoaded', async () => {
  const isAuthenticated = await sessionCheck();
  
  if (isAuthenticated) {
    const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
    document.getElementById("userName").innerText = userName;
    
    const userRole = localStorage.getItem("userRole");
    const isAdmin = userRole === "admin" || userRole === "Admin";
    const adminItems = document.querySelectorAll(".admin-only");
    adminItems.forEach(item => {
        item.classList.toggle("admin-visible", isAdmin);
    });
    
    // Handle mobile nav for admin
    const mobileUsersNav = document.getElementById('mobileUsersNav');
    if (mobileUsersNav) {
        mobileUsersNav.classList.toggle("admin-visible", isAdmin);
    }
    
    if (!isAdmin) {
      showToast("Access denied. Admin privileges required.", "error");
      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 2000);
      return;
    }
    
    loadUsers();
    setupRoleToggle();
    setupTabs();
    setupSearch();
    
    // Event listeners
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    
    // REMOVED: Mobile logout button event listeners
    // document.getElementById('mobileLogoutBtn').addEventListener('click', handleLogout);
    // document.getElementById('mobileNavLogoutBtn').addEventListener('click', function(e) {
    //     e.preventDefault();
    //     handleLogout();
    // });
    
    document.getElementById('openAddUser').addEventListener('click', () => openUserModal('add'));
    document.getElementById('viewLogsBtn').addEventListener('click', function() {
      document.getElementById('logsModal').style.display = 'flex';
      loadUserActivity();
      loadAuditLogs();
    });
    document.getElementById('saveUserBtn').addEventListener('click', saveUser);
    document.getElementById('cancelModal').addEventListener('click', closeUserModal);
    document.getElementById('closeModal').addEventListener('click', closeUserModal);
    document.getElementById('closeLogsBtn').addEventListener('click', closeLogsModal);
    document.getElementById('closeLogsModal').addEventListener('click', closeLogsModal);
    document.getElementById('refreshLogs').addEventListener('click', function() {
      const activeTab = document.querySelector('.tab-btn.active');
      if (activeTab) {
        const tabId = activeTab.getAttribute('data-tab');
        if (tabId === 'activity') {
          loadUserActivity();
        } else {
          loadAuditLogs();
        }
      }
    });
    document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
    
    // Reset modal events
    document.getElementById('cancelReset').addEventListener('click', closeResetModal);
    document.getElementById('closeResetModal').addEventListener('click', closeResetModal);
    document.getElementById('confirmReset').addEventListener('click', resetPassword);
    
    // Delete modal events
    document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);
    document.getElementById('closeDeleteModal').addEventListener('click', closeDeleteModal);
    document.getElementById('confirmDelete').addEventListener('click', deleteUser);
    
    // Close modals on overlay click
    document.getElementById('userModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('userModal')) closeUserModal();
    });
    
    document.getElementById('logsModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('logsModal')) closeLogsModal();
    });
    
    document.getElementById('resetModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('resetModal')) closeResetModal();
    });
    
    document.getElementById('deleteModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('deleteModal')) closeDeleteModal();
    });
    
    // Auto-refresh
    setInterval(loadUsers, 30000);
    
    // Handle window resize
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        // Handle responsive adjustments
      }, 250);
    });
  }
});

/* ============ PREVENT BACK BUTTON ISSUES ============ */
window.addEventListener('pageshow', function(event) {
  if (event.persisted) {
    sessionCheck().then(isAuthenticated => {
      if (isAuthenticated) {
        loadUsers();
      }
    });
  }
});
</script>
<script src="js/common-utils.js"></script>
<script src="js/session-manager.js"></script>
<script src="js/common-session.js"></script>
<script src="js/activity-tracking-final.js"></script>
</body>
</html>



