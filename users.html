<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Purok Kaligtasan ‚Äî User Management</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
   :root{
    --bg:#f6f8f7;
    --card-bg:#fff;
    --muted:#6b6f6b;
    --accent1:#0f7a4a;
    --accent2:#34b78f;
    --accent3: #ff7a00;
    --accent4: #ffa500;
    --light-green: #e9f7f2;
    --border: #e1e8e5;
    --shadow: 0 6px 18px rgba(6,30,20,0.06);
    --shadow-dark: 0 6px 20px rgba(5,40,25,0.12);
    --radius:12px;
    --radius-sm:8px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
   }
   body {
    background-color: var(--bg);
    margin: 0;
    min-height: 100vh;
   }
   /* Description Styling */
   #disc {
    margin-bottom: 10px;
    background: var(--light-green);
    padding: 12px;
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--accent1);
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.5;
   }
   .page-container{
    max-width:1200px;
    margin:20px auto;
    padding:12px;
    display:grid;
    grid-template-columns:260px 1fr;
    gap:18px;
    align-items:start;
    transition: grid-template-columns 0.3s ease;
   }

   .page-container.collapsed {
    grid-template-columns: 60px 1fr;
   }

   /* Topbar - Enhanced */
   .topbar{
    grid-column:1/-1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
    border-radius:var(--radius);
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    color:#fff;
    box-shadow:var(--shadow-dark);
   }

   .brand{
    display:flex;
    gap:12px;
    align-items:center;
   }

   .brand .logo{
    width:48px;
    height:48px;
    border-radius:var(--radius-sm);
    object-fit:contain;
    background: rgba(255,255,255,0.1);
    padding: 4px;
    border: 2px solid rgba(255,255,255,0.2);
   }

   .brand-text h1 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
   }

   .brand-text p {
    font-size:12px;
    opacity:0.95;
    margin: 4px 0 0 0;
   }

   #userName {
    font-weight: 600;
    border-radius: 20px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
   }

   #logoutBtn {
    background: rgba(255,255,255,0.15);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
   }

   #logoutBtn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
   }

   /* Sidebar - Collapsible */
   .sidebar{
    background:linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.20));
    border-radius:var(--radius);
    padding:12px;
    height:calc(100vh - 120px);
    position:sticky;
    top:72px;
    overflow:auto;
    transition: width 0.3s ease;
   }

   .sidebar-container {
    display: flex;
    flex-direction: column;
    height: 100%;
   }

   .sidebar-toggle {
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-bottom: 12px;
    transition: all 0.3s ease;
   }

   .sidebar-toggle:hover {
    transform: scale(1.1);
   }

   .sidebar ul{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
    flex: 1;
   }

   .sidebar li a{
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    text-decoration: none;
    color: var(--muted);
    border-radius: var(--radius-sm);
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
   }

   .sidebar li a:hover{
    background: var(--light-green);
    color: var(--accent1);
   }

   .sidebar li a.active{
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .sidebar li a .menu-icon {
    font-size: 1.2rem;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
   }

   .sidebar li a .menu-text {
    transition: opacity 0.3s ease;
   }

   .page-container.collapsed .sidebar li a .menu-text {
    opacity: 0;
    width: 0;
    overflow: hidden;
   }

   /* Content Area - Fixed Size */
   .content-area{
    background:linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
    border-radius:var(--radius);
    padding:18px;
    box-shadow:0 8px 22px rgba(10,20,16,0.06);
    min-height:72vh;
    height: calc(100vh - 120px);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
   }

   /* Content Header - Fixed */
   .content-header {
    margin-top: 0;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
   }

   .content-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: var(--accent1);
    display: flex;
    align-items: center;
    gap: 8px;
   }

   /* Stats - Made Smaller */
   .stats-container {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
   }

   .stat-item {
    text-align: center;
    min-width: 70px;
    padding: 6px 8px;
    background: white;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
   }

   .stat-item span {
    font-size: 0.75rem;
    color: var(--muted);
    display: block;
    margin-bottom: 2px;
   }

   .stat-item .value {
    font-size: 1rem;
    font-weight: 700;
    color: var(--accent1);
    display: block;
   }

   /* Toolbar - New Layout */
   .toolbar {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
   }

   /* Toolbar Row with Search and Toggle */
   .toolbar-row-1 {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    width: 100%;
   }

   /* Full width search bar */
   .search-container {
    position: relative;
    flex: 1;
    width: 100%;
   }

   .search-container i {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 0.9rem;
    z-index: 1;
   }

   .search-box{
    padding: 10px 12px 10px 32px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    background: white;
    width: 100%;
    box-sizing: border-box;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
   }

   .search-box:focus {
    outline: none;
    border-color: var(--accent1);
    box-shadow: 0 0 0 3px rgba(15,122,74,0.1);
   }

   /* Simple toggle buttons on the right */
   .toggle-buttons {
    display: flex;
    gap: 4px;
    background: var(--light-green);
    border-radius: var(--radius-sm);
    padding: 2px;
    min-width: 180px;
    justify-content: center;
   }

   .toggle-btn {
    padding: 6px 12px;
    border: none;
    background: transparent;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--muted);
    min-width: 60px;
    text-align: center;
    white-space: nowrap;
   }

   .toggle-btn:hover {
    background: rgba(255,255,255,0.7);
    color: var(--accent1);
   }

   .toggle-btn.active {
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: white;
    box-shadow: 0 2px 4px rgba(15,122,74,0.2);
   }

   .toolbar-row-2 {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    align-items: center;
   }

   /* Cards Row */
   .cards-row {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
   }

   .card {
    background: white;
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    flex: 1;
    min-width: 200px;
   }

   .card h3 {
    margin-top: 0;
    margin-bottom: 12px;
    color: var(--accent1);
    font-size: 1rem;
   }

   .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent1);
    margin-top: 8px;
   }

   /* Fix table glitching */
   .users-table-wrap {
       flex: 1;
       background: white;
       border-radius: var(--radius);
       box-shadow: var(--shadow);
       overflow: hidden;
       position: relative;
       margin-bottom: 16px;
       border: 1px solid var(--border);
       min-height: 400px;
       display: flex;
       flex-direction: column;
   }

   .users-table {
       width: 100%;
       border-collapse: collapse;
       font-size: 14px;
       table-layout: fixed;
   }

   /* Fixed column widths for activity table */
   #activityTable th:nth-child(1) { width: 15%; }
   #activityTable th:nth-child(2) { width: 12%; }
   #activityTable th:nth-child(3) { width: 20%; }
   #activityTable th:nth-child(4) { width: 20%; }
   #activityTable th:nth-child(5) { width: 15%; }
   #activityTable th:nth-child(6) { width: 18%; }

   /* Fixed column widths for logs table */
#logsTable th:nth-child(1) { width: 20%; min-width: 150px; }
#logsTable th:nth-child(2) { width: 15%; min-width: 100px; }
#logsTable th:nth-child(3) { width: 15%; min-width: 100px; }
#logsTable th:nth-child(4) { width: 15%; min-width: 100px; }
#logsTable th:nth-child(5) { width: 35%; min-width: 200px; text-align: left !important; }

#logsTable td:nth-child(5) {
    white-space: normal !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    text-align: left !important;
    max-width: 300px;
    min-width: 200px;
}

   .users-table th {
       background: var(--light-green);
       padding: 12px 10px;
       text-align: center;
       font-weight: 600;
       position: sticky;
       top: 0;
       z-index: 100;
       font-size: 14px;
       color: var(--accent1);
       border-bottom: 2px solid rgba(15,122,74,0.15);
       white-space: nowrap;
       vertical-align: middle;
       height: 40px;
       box-sizing: border-box;
   }

   /* Fixed column widths for users table */
   .users-table th:nth-child(1) { width: 20%; } /* Username */
   .users-table th:nth-child(2) { width: 25%; } /* Full Name */
   .users-table th:nth-child(3) { width: 15%; } /* Role */
   .users-table th:nth-child(4) { width: 25%; } /* Barangay */
   .users-table th:nth-child(5) { width: 15%; } /* Actions */

   .users-table td {
       padding: 10px;
       font-size: 14px;
       border-bottom: 1px solid rgba(15,122,74,0.08);
       vertical-align: middle;
       color: var(--muted);
       text-align: center;
       height: 36px;
       box-sizing: border-box;
       line-height: 1.3;
       word-wrap: break-word;
       overflow: hidden;
       text-overflow: ellipsis;
       white-space: nowrap;
   }

   #logsTable td:nth-child(5) {
       white-space: normal !important;
       word-wrap: break-word !important;
       text-overflow: unset !important;
       text-align: left;
       max-width: 300px;
       min-width: 200px;
   }

   /* Center role badges */
   .users-table td:nth-child(3) {
    display: flex;
    justify-content: center;
    align-items: center;
   }

   .users-table tbody tr:hover {
    background: rgba(52,183,143,0.05);
   }

   /* Actions column */
   .actions-cell {
    display: flex;
    gap: 6px;
    align-items: center;
    justify-content: center;
   }

   .icon-btn {
    background: none;
    border: 0;
    font-size: 0.85rem;
    cursor: pointer;
    padding: 6px;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    transition: all 0.2s ease;
   }

   .icon-btn:hover {
    background: var(--light-green);
    color: var(--accent1);
    transform: translateY(-1px);
   }

   /* Button styles */
   .btn {
    border: 0;
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 600;
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: #fff;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    white-space: nowrap;
    height: 36px;
    box-sizing: border-box;
   }

   .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(15,122,74,0.2);
   }

   .btn-secondary {
    background: transparent;
    color: var(--accent1);
    border: 1px solid var(--accent1);
   }

   /* Modal styles */
   .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 16px;
   }

   .modal-box {
    background: #fff;
    padding: 20px;
    border-radius: var(--radius);
    max-width: 500px;
    width: 100%;
    box-shadow: var(--shadow-dark);
   }

   .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
   }

   .modal-header h3 {
    margin: 0;
    color: var(--accent1);
   }

   .modal-body {
    margin-bottom: 16px;
   }

   /* Form styles */
   .form-group {
    margin-bottom: 12px;
   }

   .form-group label {
    display: block;
    margin-bottom: 4px;
    font-size: 0.85rem;
    color: var(--muted);
    font-weight: 500;
   }

   .form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    box-sizing: border-box;
   }

   .form-control:focus {
    outline: none;
    border-color: var(--accent1);
    box-shadow: 0 0 0 3px rgba(15,122,74,0.1);
   }

   .form-hint {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 4px;
   }

   .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
   }

   /* Password toggle in modal */
   .modal-body .input-with-icon {
    position: relative;
   }

   .modal-body .input-with-icon .password-toggle {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 1rem;
    padding: 4px;
   }

   .modal-body .input-with-icon input {
    padding-right: 40px !important;
   }

   /* Toast notifications */
   .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--accent1);
    color: white;
    padding: 12px 20px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    box-shadow: var(--shadow-dark);
    z-index: 10000;
    animation: slideIn 0.3s ease;
   }

   @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
   }

   /* Tabs styling for logs modal */
   .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    border-bottom: 2px solid var(--border);
    padding-bottom: 4px;
   }

   .tab-btn {
    padding: 8px 16px;
    background: var(--light-green);
    border: none;
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    cursor: pointer;
    font-weight: 500;
    color: var(--muted);
    transition: all 0.2s ease;
    position: relative;
    bottom: -2px;
   }

   .tab-btn:hover {
    background: rgba(15,122,74,0.1);
   }

   .tab-btn.active {
    background: linear-gradient(90deg, var(--accent1), var(--accent2));
    color: white;
    box-shadow: 0 2px 4px rgba(15,122,74,0.2);
    border-bottom: 2px solid var(--accent1);
   }

   .tab-content {
    display: none;
   }

   .tab-content.active {
    display: block;
   }

   /* Sub-tabs for audit logs */
   .tab-btn-small {
       padding: 6px 12px;
       background: var(--light-green);
       border: none;
       border-radius: var(--radius-sm);
       cursor: pointer;
       font-weight: 500;
       color: var(--muted);
       transition: all 0.2s ease;
       font-size: 0.85rem;
       margin-right: 4px;
   }

   .tab-btn-small:hover {
       background: rgba(15,122,74,0.1);
   }

   .tab-btn-small.active {
       background: linear-gradient(90deg, var(--accent1), var(--accent2));
       color: white;
       box-shadow: 0 2px 4px rgba(15,122,74,0.2);
   }

   /* Status badges */
   .status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-block;
    min-width: 70px;
    text-align: center;
   }

   .status-online {
    background: #e9f7f2;
    color: #0f7a4a;
    border: 1px solid #0f7a4a;
   }

   .status-offline {
    background: #f0f0f0;
    color: #666;
    border: 1px solid #ddd;
   }

   .status-idle {
    background: #fff8e1;
    color: #ff9800;
    border: 1px solid #ff9800;
   }

   /* Mobile fixes for tables */
   @media (max-width: 768px) {
       .users-table-wrap {
           overflow-x: auto;
       }
       
       .users-table {
           table-layout: auto;
           min-width: 600px;
       }
       
       .users-table th,
       .users-table td {
           font-size: 12px;
           padding: 8px 6px;
           text-align: left;
           white-space: nowrap;
       }
       
       #activityTable th:nth-child(1),
       #activityTable th:nth-child(2),
       #activityTable th:nth-child(3),
       #activityTable th:nth-child(4),
       #activityTable th:nth-child(5),
       #activityTable th:nth-child(6),
       #logsTable th:nth-child(1),
       #logsTable th:nth-child(2),
       #logsTable th:nth-child(3),
       #logsTable th:nth-child(4),
       #logsTable th:nth-child(5) {
           width: auto;
       }
       
       .users-table td {
           white-space: normal;
           word-wrap: break-word;
       }
   }

   /* Mobile menu toggle button */
   .mobile-menu-toggle {
    display: none;
   }

   /* Mobile Styles */
   @media (max-width: 768px) {
    .page-container {
        grid-template-columns: 1fr !important;
        padding: 8px;
        gap: 12px;
    }
    
    .page-container.collapsed {
        grid-template-columns: 1fr !important;
    }
    
    .sidebar {
        position: fixed;
        top: 72px;
        left: 0;
        right: 0;
        height: auto;
        max-height: 0;
        overflow: hidden;
        z-index: 1000;
        margin: 0;
        padding: 0;
        border-radius: 0 0 var(--radius) var(--radius);
        background: white;
        box-shadow: var(--shadow);
        transition: max-height 0.3s ease;
    }
    
    .sidebar.mobile-open {
        max-height: 300px;
        padding: 12px;
        overflow-y: auto;
    }
    
    .sidebar-container {
        flex-direction: column;
    }
    
    .sidebar-toggle {
        display: none;
    }
    
    .mobile-menu-toggle {
        display: flex !important;
        background: linear-gradient(135deg, var(--accent1), var(--accent2));
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        width: 40px;
        height: 40px;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
    }
    
    .content-area {
        height: auto;
        min-height: calc(100vh - 140px);
    }
    
    .toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .toolbar-row-1 {
        flex-direction: column;
        gap: 8px;
    }
    
    .toggle-buttons {
        width: 100%;
        justify-content: center;
    }
    
    .toolbar-row-2 {
        justify-content: space-between;
        flex-wrap: wrap;
    }
    
    .cards-row {
        flex-direction: column;
    }
    
    .card {
        min-width: 100%;
    }
    
    .user-info {
        gap: 8px;
    }
    
    #userName {
        font-size: 0.9rem;
        padding: 6px 12px;
    }
    
    #logoutBtn {
        padding: 6px 12px;
        font-size: 0.85rem;
    }
    
    .modal-box {
        max-width: 95%;
        padding: 16px;
    }
    
    .actions-cell {
        justify-content: flex-start;
    }
    
    /* Tabs on mobile */
    .tabs {
        flex-direction: column;
        gap: 4px;
        border-bottom: none;
    }
    
    .tab-btn {
        border-radius: var(--radius-sm);
        width: 100%;
        text-align: center;
        bottom: 0;
    }
   }

   /* Tablet Styles */
   @media (min-width: 769px) and (max-width: 1024px) {
    .page-container {
        max-width: 95%;
        grid-template-columns: 220px 1fr;
        gap: 15px;
        padding: 10px;
    }
    
    .content-area {
        padding: 15px;
    }
    
    .users-table th,
    .users-table td {
        font-size: 13px;
        padding: 10px 8px;
    }
   }
</style>
</head>
<body>
<div class="page-container">

  <header class="topbar">
    <div class="brand">
      <img src="assets/MDRRMO Logo.png" class="logo" alt="Logo"/>
      <div class="brand-text">
        <h1>PUROK KALIGTASAN</h1>
        <p>MDRRMO Alitagtag User Management</p>
      </div>
    </div>

    <div class="user-info">
      <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
      </button>
      <span id="userName"></span>
      <button id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-container">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul>
        <li><a href="dashboard.html" title="Dashboard"><span class="menu-icon">üìä</span> <span class="menu-text">Dashboard</span></a></li>
        <li><a href="dataForm.html" title="Data Entry"><span class="menu-icon">üìù</span> <span class="menu-text">Data Entry</span></a></li>
        <li><a href="records.html" title="Records"><span class="menu-icon">üìÅ</span> <span class="menu-text">Records</span></a></li>
        <li><a href="charts.html" title="Charts"><span class="menu-icon">üìà</span> <span class="menu-text">Charts</span></a></li>
        <li class="admin-only"><a href="users.html" class="active" title="User Management"><span class="menu-icon">üë•</span> <span class="menu-text">User Management</span></a></li>
      </ul>
    </div>
  </aside>

  <main class="content-area">
    <div class="content-header">
      <h2><span style="color: var(--accent1);">üë•</span> User Management</h2>
    </div>
     <div id="disc">The User Management section allows administrators to create, update, and control access for all system users. It ensures that only authorized personnel can view, edit, or manage household records. Through this section, admins can assign roles, reset passwords, activate or deactivate accounts, and monitor user activity to maintain data security and system integrity.</div>

    <!-- Toolbar -->
    <div class="toolbar">
      <!-- Row with Search and Toggle Buttons -->
      <div class="toolbar-row-1">
        <!-- Full Width Search Bar -->
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input id="filterUser" class="search-box" placeholder="Search by username or full name..." />
        </div>
        
        <!-- Toggle Buttons Only (right side) -->
        <div class="toggle-buttons" id="roleToggle">
          <button class="toggle-btn active" data-role="all">All</button>
          <button class="toggle-btn" data-role="Admin">Admin</button>
          <button class="toggle-btn" data-role="Staff">Staff</button>
        </div>
      </div>
      
      <div class="toolbar-row-2">
        <button id="viewLogsBtn" class="btn btn-secondary">
          <i class="fas fa-history"></i> View Logs
        </button>
        <button id="openAddUser" class="btn">
          <i class="fas fa-user-plus"></i> Add User
        </button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="cards-row">
      <div class="card">
        <h3>Total Users</h3>
        <div id="statTotal" class="stat-value">0</div>
      </div>
      <div class="card">
        <h3>Admins</h3>
        <div id="statAdmins" class="stat-value">0</div>
      </div>
      <div class="card">
        <h3>Staff</h3>
        <div id="statStaff" class="stat-value">0</div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="users-table-wrap">
      <table class="users-table" id="usersTable">
        <thead>
          <tr>
            <th>Username</th>
            <th>Full Name</th>
            <th>Role</th>
            <th>Barangay</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersBody">
          <tr><td colspan="5" style="text-align: center; padding: 20px;">Loading users...</td></tr>
        </tbody>
      </table>
    </div>

  </main>
</div>

<!-- Add/Edit User Modal -->
<div id="userModal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="modalTitle">Add New User</h3>
      <button id="closeModal" class="icon-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="userForm">
        <div class="form-group">
          <label for="user_username">Username *</label>
          <input id="user_username" class="form-control" required />
        </div>
        <div class="form-group">
          <label for="user_fullname">Full Name</label>
          <input id="user_fullname" class="form-control" />
        </div>
        <div class="form-group">
          <label for="user_role">Role</label>
          <select id="user_role" class="form-control">
            <option value="Staff">Staff</option>
            <option value="Admin">Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label for="user_barangay">Assigned Barangay</label>
          <select id="user_barangay" class="form-control">
            <option value="">ALL</option>
            <option>Balagbag</option><option>Concepcion</option><option>Concordia</option>
            <option>Dalipit East</option><option>Dalipit West</option>
            <option>Dominador East</option><option>Dominador West</option>
            <option>Munlawin Sur</option><option>Munlawin Norte</option>
            <option>Muzon Primero</option><option>Muzon Segundo</option>
            <option>Pinagkurusan</option><option>Ping-As</option>
            <option>Poblacion East</option><option>Poblacion West</option>
            <option>San Jose</option><option>San Juan</option>
            <option>Santa Cruz</option><option>Tadlac</option>
          </select>
        </div>
        <div class="form-group">
          <label for="user_password">Password</label>
          <div class="input-with-icon">
            <input id="user_password" type="password" class="form-control" placeholder="Enter new password" />
            <button type="button" class="password-toggle" id="toggleModalPassword">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <div class="form-hint">Leave blank when editing to keep current password</div>
        </div>
      </form>
    </div>
    <div class="form-actions">
      <button id="cancelModal" class="btn btn-secondary">Cancel</button>
      <button id="saveUserBtn" class="btn">Save</button>
    </div>
  </div>
</div>

<!-- Enhanced Logs Modal with User Activity -->
<div id="logsModal" class="modal-overlay">
  <div class="modal-box" style="max-width: 1200px; max-height: 80vh; overflow-y: auto;">
    <div class="modal-header">
      <h3><i class="fas fa-user-clock"></i> User Activity & Audit Logs</h3>
      <button id="closeLogsModal" class="icon-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="tabs">
      <button class="tab-btn active" data-tab="activity">User Activity</button>
      <button class="tab-btn" data-tab="audit">Audit Logs</button>
    </div>
    
    <!-- User Activity Tab - FIXED TABLE -->
    <div class="tab-content active" id="activityTab">
      <div class="stats-container" style="justify-content: flex-start; margin-bottom: 16px;">
        <div class="stat-item">
          <span>Online Now</span>
          <div id="statOnline" class="value" style="color: #0f7a4a;">0</div>
        </div>
        <div class="stat-item">
          <span>Active Today</span>
          <div id="statToday" class="value">0</div>
        </div>
        <div class="stat-item">
          <span>Total Users</span>
          <div id="statTotalUsers" class="value">0</div>
        </div>
      </div>
      
      <div class="search-container" style="margin-bottom: 16px;">
        <i class="fas fa-search"></i>
        <input id="searchActivity" class="search-box" placeholder="Search users..." />
      </div>
      
      <div class="users-table-wrap" style="min-height: 300px;">
        <table class="users-table" id="activityTable">
          <thead>
            <tr>
              <th>Username</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Last Activity</th>
              <th>Active Time</th>
              <th>Session Duration</th>
            </tr>
          </thead>
          <tbody id="activityBody">
            <tr><td colspan="6" style="text-align: center; padding: 20px;">Loading activity data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Audit Logs Tab - WITH CATEGORIES -->
    <div class="tab-content" id="auditTab">
      <div class="tabs" style="margin-bottom: 16px; border-bottom: 1px solid var(--border);">
        <button class="tab-btn-small active" data-category="all">All Logs</button>
        <button class="tab-btn-small" data-category="today">Today</button>
        <button class="tab-btn-small" data-category="yesterday">Yesterday</button>
        <button class="tab-btn-small" data-category="older">Older</button>
      </div>
      
      <div class="search-container" style="margin-bottom: 16px;">
        <i class="fas fa-search"></i>
        <input id="searchAudit" class="search-box" placeholder="Search audit logs..." />
      </div>
      
<div class="users-table-wrap" style="min-height: 300px;">
  <table class="users-table" id="logsTable">
    <thead>
      <tr>
        <th style="width: 20%;">Timestamp</th>
        <th style="width: 15%;">Action</th>
        <th style="width: 15%;">Actor</th>
        <th style="width: 15%;">Target</th>
        <th style="width: 35%; text-align: left;">Details</th>
      </tr>
    </thead>
    <tbody id="logsBody">
      <tr><td colspan="5" style="text-align: center; padding: 20px;">Loading logs...</td></tr>
    </tbody>
  </table>
      </div>
    </div>
    
    <div class="form-actions">
      <button id="refreshLogs" class="btn btn-secondary">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
      <button id="closeLogsBtn" class="btn">Close</button>
    </div>
  </div>
</div>

<script>
/* ============ CONFIG ============ */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx855bvwL5GABW5Xfmuytas3FbBikE1R44I7vNuhXNhfTly-MGMonkqPfeSngIt-7OMNA/exec";

/* ============ STATE ============ */
let ALL_USERS = [];
let EDIT_TARGET = null;
let CURRENT_ROLE_FILTER = 'all';
let AUDIT_LOGS_DATA = null;

/* ============ SESSION CHECK ============ */
async function sessionCheck(){
  try {
    const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
    
    if (userName && userName !== "User") {
      document.getElementById('userName').innerText = userName;
      
      const userRole = localStorage.getItem("userRole");
      const isAdmin = userRole === "admin" || userRole === "Admin";
      const adminItems = document.querySelectorAll(".admin-only");
      adminItems.forEach(item => {
          item.style.display = isAdmin ? "block" : "none";
      });
      
      sessionStorage.setItem('authenticated', 'true');
      return true;
    } else {
      if(sessionStorage.getItem('authenticated')) {
        document.getElementById('userName').innerText = "User";
        return true;
      } else {
        window.location.href = 'index.html?session=expired';
        return false;
      }
    }
  } catch(e){ 
    console.warn('session check failed', e);
    return false;
  }
}

/* ============ LOGOUT ============ */
function handleLogout() {
  const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
  
  localStorage.clear();
  sessionStorage.clear();
  
  const logoutUrl = 'index.html?logout=true&t=' + Date.now();
  
  fetch(SCRIPT_URL+'?action=logout&t=' + Date.now())
    .catch(() => {})
    .finally(() => {
      window.location.replace(logoutUrl);
    });
}

/* ============ TOAST NOTIFICATION ============ */
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  toast.style.background = type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : 'var(--accent1)';
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

/* ============ LOAD USERS ============ */
async function loadUsers() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=users`);
    const text = await res.text();
    
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      showToast("Invalid response from server", "error");
      return;
    }
    
    if (!data.success) {
      showToast("Failed to load users: " + (data.message || "Unknown error"), "error");
      return;
    }
    
    ALL_USERS = data.users || [];
    renderUsers();
    updateStats();
  } catch(err) {
    showToast("Error loading users: " + err.message, "error");
  }
}

/* ============ RENDER USERS ============ */
function renderUsers(filter = "", roleFilter = CURRENT_ROLE_FILTER) {
  const tbody = document.getElementById("usersBody");
  tbody.innerHTML = "";
  
  let filtered = ALL_USERS;
  if (roleFilter !== 'all') {
    filtered = ALL_USERS.filter(user => 
      user.Role.toLowerCase() === roleFilter.toLowerCase()
    );
  }
  
  if (filter) {
    filtered = filtered.filter(user => {
      const searchStr = `${user.Username} ${user.FullName} ${user.Role} ${user.AssignedBarangay}`.toLowerCase();
      return searchStr.includes(filter.toLowerCase());
    });
  }
  
  if (filtered.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; padding: 40px 20px; color: var(--muted); font-style: italic;">
          No users found
        </td>
      </tr>
    `;
    return;
  }
  
  filtered.forEach(user => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(user.Username)}</td>
      <td>${escapeHtml(user.FullName)}</td>
      <td>
        <span style="padding: 4px 10px; border-radius: 12px; background: ${user.Role === 'Admin' ? '#e9f7f2' : '#f0f0f0'}; color: ${user.Role === 'Admin' ? '#0f7a4a' : '#666'}; display: inline-block;">
          ${user.Role}
        </span>
      </td>
      <td>${escapeHtml(user.AssignedBarangay || '')}</td>
      <td class="actions-cell">
        <button class="icon-btn" onclick="editUser('${escapeHtml(user.Username)}')" title="Edit">
          <i class="fas fa-edit"></i>
        </button>
        <button class="icon-btn" onclick="resetPassword('${escapeHtml(user.Username)}')" title="Reset Password">
          <i class="fas fa-key"></i>
        </button>
        <button class="icon-btn" onclick="deleteUser('${escapeHtml(user.Username)}')" title="Delete" style="color: #ff4444;">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ============ UPDATE STATS ============ */
function updateStats() {
  const total = ALL_USERS.length;
  const admins = ALL_USERS.filter(u => u.Role === 'Admin' || u.Role === 'admin').length;
  const staff = ALL_USERS.filter(u => u.Role === 'Staff' || u.Role === 'staff').length;
  
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statAdmins').textContent = admins;
  document.getElementById('statStaff').textContent = staff;
}

/* ============ ROLE TOGGLE ============ */
function setupRoleToggle() {
  const toggleButtons = document.querySelectorAll('#roleToggle .toggle-btn');
  
  const savedFilter = localStorage.getItem('roleFilter');
  if (savedFilter) {
    CURRENT_ROLE_FILTER = savedFilter;
  }
  
  toggleButtons.forEach(btn => {
    if (btn.getAttribute('data-role') === CURRENT_ROLE_FILTER) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  
  toggleButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      toggleButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      const role = this.getAttribute('data-role');
      CURRENT_ROLE_FILTER = role;
      localStorage.setItem('roleFilter', role);
      
      const searchFilter = document.getElementById('filterUser').value;
      renderUsers(searchFilter, role);
    });
  });
}

/* ============ USER OPERATIONS ============ */
function openUserModal(mode = 'add', username = null) {
  EDIT_TARGET = username;
  
  const modal = document.getElementById('userModal');
  const title = document.getElementById('modalTitle');
  const form = document.getElementById('userForm');
  
  form.reset();
  
  if (mode === 'edit' && username) {
    title.textContent = 'Edit User';
    const user = ALL_USERS.find(u => u.Username === username);
    if (user) {
      document.getElementById('user_username').value = user.Username;
      document.getElementById('user_fullname').value = user.FullName;
      document.getElementById('user_role').value = user.Role;
      document.getElementById('user_barangay').value = user.AssignedBarangay || '';
      document.getElementById('user_username').disabled = true;
      document.getElementById('user_password').required = false;
      document.getElementById('user_password').placeholder = "Leave blank to keep current password";
    }
  } else {
    title.textContent = 'Add New User';
    document.getElementById('user_username').disabled = false;
    document.getElementById('user_password').required = true;
    document.getElementById('user_password').placeholder = "Enter new password";
  }
  
  const toggleIcon = document.querySelector('#toggleModalPassword i');
  if (toggleIcon) {
    toggleIcon.className = 'fas fa-eye';
  }
  const passwordInput = document.getElementById('user_password');
  if (passwordInput) {
    passwordInput.type = 'password';
  }
  
  modal.style.display = 'flex';
  setupPasswordToggle();
}

function editUser(username) {
  openUserModal('edit', username);
}

async function saveUser() {
  const username = document.getElementById('user_username').value.trim();
  const fullname = document.getElementById('user_fullname').value.trim();
  const role = document.getElementById('user_role').value;
  const barangay = document.getElementById('user_barangay').value;
  const password = document.getElementById('user_password').value.trim();
  
  const currentUser = localStorage.getItem("username") || 
                     localStorage.getItem("staffName") || 
                     "System";
  
  if (!username) {
    showToast('Username is required', 'error');
    return;
  }
  
  if (!EDIT_TARGET && !password) {
    showToast('Password is required for new users', 'error');
    return;
  }
  
  try {
    const formData = new FormData();
    formData.append('action', EDIT_TARGET ? 'updateUser' : 'createUser');
    formData.append('actor', currentUser);
    
    formData.append('Username', username);
    formData.append('FullName', fullname);
    formData.append('Role', role);
    formData.append('AssignedBarangay', barangay);
    
    if (password) {
      formData.append('Password', password);
    }
    
    if (EDIT_TARGET) {
      formData.append('target', EDIT_TARGET);
    }
    
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });
    
    const text = await res.text();
    
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      showToast("Invalid response from server", "error");
      return;
    }
    
    if (data.success) {
      showToast(data.message || 'User saved successfully', 'success');
      closeUserModal();
      loadUsers();
    } else {
      showToast(data.message || 'Failed to save user', 'error');
    }
  } catch(err) {
    showToast('Error saving user: ' + err.message, 'error');
  }
}

async function resetPassword(username) {
  if (!confirm(`Reset password for user "${username}" to default?`)) return;
  
  const currentUser = localStorage.getItem("username") || 
                     localStorage.getItem("staffName") || 
                     "System";
  
  try {
    const formData = new FormData();
    formData.append('action', 'resetPassword');
    formData.append('target', username);
    formData.append('actor', currentUser);
    
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });
    
    const text = await res.text();
    
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      showToast("Invalid response from server", "error");
      return;
    }
    
    if (data.success) {
      showToast(data.message || 'Password reset successfully', 'success');
    } else {
      showToast(data.message || 'Failed to reset password', 'error');
    }
  } catch(err) {
    showToast('Error resetting password: ' + err.message, 'error');
  }
}

async function deleteUser(username) {
  if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) return;
  
  const currentUser = localStorage.getItem("username") || 
                     localStorage.getItem("staffName") || 
                     "System";
  
  try {
    const formData = new FormData();
    formData.append('action', 'deleteUser');
    formData.append('target', username);
    formData.append('actor', currentUser);
    
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });
    
    const text = await res.text();
    
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      showToast("Invalid response from server", "error");
      return;
    }
    
    if (data.success) {
      showToast(data.message || 'User deleted successfully', 'success');
      loadUsers();
    } else {
      showToast(data.message || 'Failed to delete user', 'error');
    }
  } catch(err) {
    showToast('Error deleting user: ' + err.message, 'error');
  }
}

/* ============ LOAD USER ACTIVITY ============ */
async function loadUserActivity() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=userActivity`);
    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      showToast("Invalid response from server", "error");
      return;
    }
    
    const tbody = document.getElementById('activityBody');
    tbody.innerHTML = '';
    
    if (!data.success || !data.activities || data.activities.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">No activity data available</td></tr>`;
      updateActivityStats([]);
      return;
    }
    
    updateActivityStats(data.activities);
    
    data.activities.forEach(activity => {
      const tr = document.createElement('tr');
      
      let statusClass = 'status-offline';
      let statusText = 'Offline';
      
      if (activity.IsOnline === 'Online') {
        const lastActivity = new Date(activity.LastActivity);
        const now = new Date();
        const minutesSinceActivity = Math.floor((now - lastActivity) / (1000 * 60));
        
        if (minutesSinceActivity < 5) {
          statusClass = 'status-online';
          statusText = 'Online';
        } else if (minutesSinceActivity < 15) {
          statusClass = 'status-idle';
          statusText = 'Idle';
        } else {
          statusClass = 'status-offline';
          statusText = 'Away';
        }
      }
      
      const lastLogin = activity.LastLogin ? 
        new Date(activity.LastLogin).toLocaleString('en-PH') : 'Never';
      
      const lastActivityTime = activity.LastActivity ? 
        new Date(activity.LastActivity).toLocaleString('en-PH') : 'Never';
      
      const timeAgo = activity.TimeAgo || 'N/A';
      const sessionDuration = activity.SessionDuration || 'N/A';
      
      tr.innerHTML = `
        <td><strong>${escapeHtml(activity.Username)}</strong></td>
        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
        <td><small>${lastLogin}</small></td>
        <td><small>${lastActivityTime}</small><br><small style="color: var(--muted);">${timeAgo}</small></td>
        <td>${timeAgo}</td>
        <td>${sessionDuration}</td>
      `;
      tbody.appendChild(tr);
    });
    
  } catch(err) {
    showToast('Error loading activity: ' + err.message, 'error');
  }
}

function updateActivityStats(activities) {
  const now = new Date();
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let onlineCount = 0;
  let todayActiveCount = 0;
  
  activities.forEach(activity => {
    if (activity.IsOnline === 'Online' && activity.LastActivity) {
      const lastActivity = new Date(activity.LastActivity);
      const minutesSinceActivity = Math.floor((now - lastActivity) / (1000 * 60));
      if (minutesSinceActivity < 15) {
        onlineCount++;
      }
    }
    
    if (activity.LastActivity) {
      const lastActivity = new Date(activity.LastActivity);
      if (lastActivity >= today) {
        todayActiveCount++;
      }
    }
  });
  
  document.getElementById('statOnline').textContent = onlineCount;
  document.getElementById('statToday').textContent = todayActiveCount;
  document.getElementById('statTotalUsers').textContent = activities.length;
  
  const onlineStat = document.getElementById('statOnline');
  onlineStat.style.color = onlineCount > 0 ? '#0f7a4a' : '#666';
}

/* ============ LOAD AUDIT LOGS ============ */
/* ============ LOAD AUDIT LOGS ============ */
async function loadAuditLogs() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=logs`);
    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
      console.log("Audit logs raw data structure:", data);
      console.log("First log entry:", data.logs ? data.logs[0] : "No logs");
    } catch (e) {
      console.error("Invalid JSON response:", text);
      showToast("Invalid response from server", "error");
      return;
    }
    
    if (!data.success) {
      console.error("Failed to load logs:", data.message);
      showToast("Failed to load logs: " + (data.message || "Unknown error"), "error");
      return;
    }
    
    AUDIT_LOGS_DATA = data;
    displayAuditLogs('all');
    
  } catch(err) {
    console.error("Error loading logs:", err);
    showToast('Error loading logs: ' + err.message, 'error');
  }
}

function displayAuditLogs(category = 'all') {
  console.log("Displaying logs for category:", category);
  
  const tbody = document.getElementById('logsBody');
  tbody.innerHTML = '';
  
  if (!AUDIT_LOGS_DATA) {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">No logs data available</td></tr>`;
    return;
  }
  
  const logs = category === 'all' ? AUDIT_LOGS_DATA.logs || [] :
              category === 'today' ? AUDIT_LOGS_DATA.today || [] :
              category === 'yesterday' ? AUDIT_LOGS_DATA.yesterday || [] :
              AUDIT_LOGS_DATA.older || [];
  
  console.log("Total logs to display:", logs.length);
  
  if (logs.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; padding: 20px; color: var(--muted); font-style: italic;">
          No ${category === 'all' ? '' : category} logs found
        </td>
      </tr>
    `;
    return;
  }
  
  logs.forEach((log, index) => {
    console.log(`Log ${index + 1}:`, JSON.stringify(log, null, 2));
    
    const tr = document.createElement('tr');
    
    // Format timestamp - check multiple possibilities
    let timestamp = '';
    if (log.FormattedTimestamp) {
      timestamp = log.FormattedTimestamp;
    } else if (log.Timestamp) {
      if (log.Timestamp instanceof Date || (typeof log.Timestamp === 'string' && !isNaN(Date.parse(log.Timestamp)))) {
        const date = new Date(log.Timestamp);
        timestamp = date.toLocaleString('en-PH');
      } else {
        timestamp = String(log.Timestamp);
      }
    }
    
    // Get target - check multiple possibilities
    let target = '';
    if (log.TargetSheet) {
      target = log.TargetSheet;
    } else if (log.Target) {
      // Check if Target contains concatenated data like "StaffBalagbag"
      const targetStr = String(log.Target);
      // If it looks like concatenated (contains a role followed by sheet name)
      if (targetStr.includes('Staff') || targetStr.includes('Admin')) {
        // Extract the sheet name (after the role)
        target = targetStr.replace(/^(Staff|Admin)/, '').trim();
      } else {
        target = targetStr;
      }
    }
    
    // Get actor - check multiple possibilities
    let actor = '';
    if (log.Actor) {
      const actorStr = String(log.Actor);
      // If it looks like concatenated (e.g., "Orley P Medallada JrSiaif")
      // Remove any role suffix that might be concatenated
      actor = actorStr.replace(/(Staff|Admin)$/i, '').trim();
    }
    
    // Get role - check multiple possibilities
    let role = '';
    if (log.Role) {
      role = log.Role;
    } else if (log.Actor && String(log.Actor).match(/(Staff|Admin)$/i)) {
      // Extract role from concatenated Actor field
      const match = String(log.Actor).match(/(Staff|Admin)$/i);
      if (match) role = match[0];
    }
    
    // Get details - check multiple possibilities
    let details = '';
    if (log.Details && String(log.Details).trim() !== '') {
      details = log.Details;
    } else if (log.details && String(log.details).trim() !== '') {
      details = log.details;
    } else if (log.description && String(log.description).trim() !== '') {
      details = log.description;
    } else {
      // Create meaningful details based on action and available data
      const action = log.Action || '';
      details = `${actor || 'Unknown'} performed ${action}${target ? ' on ' + target : ''}`;
    }
    
    // Format action for better display
    let action = log.Action || '';
    if (action) {
      action = action.replace(/([A-Z])/g, ' $1').trim();
      action = action.charAt(0).toUpperCase() + action.slice(1);
    }
    
    // Format the action badge color
    let actionBadgeStyle = '';
    if (action.includes('Login')) {
      actionBadgeStyle = 'background: #e9f7f2; color: #0f7a4a;';
    } else if (action.includes('Delete')) {
      actionBadgeStyle = 'background: #ffeaea; color: #ff4444;';
    } else if (action.includes('Create')) {
      actionBadgeStyle = 'background: #e9f7f2; color: #0f7a4a;';
    } else if (action.includes('Update')) {
      actionBadgeStyle = 'background: #fff8e1; color: #ff9800;';
    } else {
      actionBadgeStyle = 'background: #e9f7f2; color: #0f7a4a;';
    }
    
    tr.innerHTML = `
      <td><small style="white-space: nowrap;">${escapeHtml(timestamp)}</small></td>
      <td><span style="padding: 2px 8px; border-radius: 12px; ${actionBadgeStyle} font-weight: 600; font-size: 0.8rem;">${escapeHtml(action)}</span></td>
      <td>
        <strong>${escapeHtml(actor)}</strong>
        ${role ? `<br><small style="color: var(--muted); font-size: 0.75rem;">${escapeHtml(role)}</small>` : ''}
      </td>
      <td>${escapeHtml(target)}</td>
      <td style="text-align: left; white-space: normal; word-wrap: break-word;">
        <small>${escapeHtml(details)}</small>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function displayAuditLogs(category = 'all') {
  console.log("Displaying logs for category:", category, "Data:", AUDIT_LOGS_DATA);
  
  const tbody = document.getElementById('logsBody');
  tbody.innerHTML = '';
  
  if (!AUDIT_LOGS_DATA) {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">No logs data available</td></tr>`;
    return;
  }
  
  const logs = category === 'all' ? AUDIT_LOGS_DATA.logs || [] :
              category === 'today' ? AUDIT_LOGS_DATA.today || [] :
              category === 'yesterday' ? AUDIT_LOGS_DATA.yesterday || [] :
              AUDIT_LOGS_DATA.older || [];
  
  console.log("Logs to display:", logs.length, "items");
  
  if (logs.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; padding: 20px; color: var(--muted); font-style: italic;">
          No ${category === 'all' ? '' : category} logs found
        </td>
      </tr>
    `;
    return;
  }
  
  logs.forEach((log, index) => {
    console.log(`Log ${index}:`, log);
    
    const tr = document.createElement('tr');
    
    // Format timestamp
    let timestamp = '';
    if (log.FormattedTimestamp) {
      timestamp = log.FormattedTimestamp;
    } else if (log.Timestamp) {
      const date = new Date(log.Timestamp);
      timestamp = isNaN(date.getTime()) ? String(log.Timestamp) : date.toLocaleString('en-PH');
    }
    
    // Get target - prefer TargetSheet, then Target
    const target = log.TargetSheet || log.Target || '';
    
    // Get details - check various possible field names
    let details = '';
    if (log.Details) {
      details = log.Details;
    } else if (log.details) {
      details = log.details;
    } else if (log.description) {
      details = log.description;
    } else {
      const action = log.Action || '';
      const actor = log.Actor || '';
      const targetName = target || '';
      details = `${actor} performed ${action} on ${targetName}`;
    }
    
    // Format action for better display
    let action = log.Action || '';
    if (action) {
      action = action.replace(/([A-Z])/g, ' $1').trim();
      action = action.charAt(0).toUpperCase() + action.slice(1);
    }
    
    tr.innerHTML = `
      <td><small>${escapeHtml(timestamp)}</small></td>
      <td><span style="padding: 2px 6px; border-radius: 4px; background: #e9f7f2; color: #0f7a4a; font-weight: 500;">${escapeHtml(action)}</span></td>
      <td><strong>${escapeHtml(log.Actor || '')}</strong><br><small style="color: var(--muted);">${escapeHtml(log.Role || 'Staff')}</small></td>
      <td>${escapeHtml(target)}</td>
      <td style="text-align: left; white-space: normal; word-wrap: break-word; max-width: 300px;">
        <small>${escapeHtml(details)}</small>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ============ TAB FUNCTIONALITY ============ */
function setupTabs() {
  // Main tabs
  const mainTabBtns = document.querySelectorAll('.tab-btn');
  const mainTabContents = document.querySelectorAll('.tab-content');
  
  mainTabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      mainTabBtns.forEach(b => b.classList.remove('active'));
      mainTabContents.forEach(c => c.classList.remove('active'));
      
      this.classList.add('active');
      const tabId = this.getAttribute('data-tab');
      document.getElementById(`${tabId}Tab`).classList.add('active');
      
      if (tabId === 'activity') {
        loadUserActivity();
      } else {
        loadAuditLogs();
      }
    });
  });
  
  // Audit log sub-tabs
  const subTabBtns = document.querySelectorAll('#auditTab .tab-btn-small');
  
  subTabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      subTabBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      const category = this.getAttribute('data-category');
      displayAuditLogs(category);
    });
  });
}

/* ============ PASSWORD TOGGLE ============ */
function setupPasswordToggle() {
  const toggleBtn = document.getElementById('toggleModalPassword');
  const passwordInput = document.getElementById('user_password');
  
  if (toggleBtn && passwordInput) {
    toggleBtn.addEventListener('click', function() {
      const icon = this.querySelector('i');
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        passwordInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    });
  }
}

/* ============ MODAL CONTROLS ============ */
function closeUserModal() {
  document.getElementById('userModal').style.display = 'none';
  EDIT_TARGET = null;
}

function closeLogsModal() {
  document.getElementById('logsModal').style.display = 'none';
}

/* ============ SIDEBAR TOGGLE ============ */
function toggleSidebar() {
    const pageContainer = document.querySelector('.page-container');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const icon = sidebarToggle.querySelector('i');
    
    pageContainer.classList.toggle('collapsed');
    
    if (pageContainer.classList.contains('collapsed')) {
        icon.className = 'fas fa-chevron-right';
        sidebarToggle.title = "Expand sidebar";
    } else {
        icon.className = 'fas fa-bars';
        sidebarToggle.title = "Collapse sidebar";
    }
}

function toggleMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    const icon = mobileToggle.querySelector('i');
    
    sidebar.classList.toggle('mobile-open');
    
    if (sidebar.classList.contains('mobile-open')) {
        icon.className = 'fas fa-times';
        mobileToggle.title = "Close menu";
    } else {
        icon.className = 'fas fa-bars';
        mobileToggle.title = "Open menu";
    }
}

/* ============ UTILITY FUNCTIONS ============ */
function escapeHtml(text) {
  if (text === null || text === undefined) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/* ============ SEARCH FUNCTIONALITY ============ */
function setupSearch() {
  // User search
  document.getElementById('filterUser').addEventListener('input', (e) => {
    renderUsers(e.target.value, CURRENT_ROLE_FILTER);
  });
  
  // Activity search
  document.getElementById('searchActivity').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#activityBody tr');
    
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });
  
  // Audit search
  document.getElementById('searchAudit').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#logsBody tr');
    
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });
}

/* ============ INITIALIZATION ============ */
window.addEventListener('DOMContentLoaded', async () => {
  const isAuthenticated = await sessionCheck();
  
  if (isAuthenticated) {
    const userName = localStorage.getItem("staffName") || localStorage.getItem("username") || "User";
    document.getElementById("userName").innerText = userName;
    
    const userRole = localStorage.getItem("userRole");
    const isAdmin = userRole === "admin" || userRole === "Admin";
    const adminItems = document.querySelectorAll(".admin-only");
    adminItems.forEach(item => {
        item.style.display = isAdmin ? "block" : "none";
    });
    
    if (!isAdmin) {
      showToast("Access denied. Admin privileges required.", "error");
      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 2000);
      return;
    }
    
    loadUsers();
    setupRoleToggle();
    setupTabs();
    setupSearch();
    
    // Event listeners
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    document.getElementById('openAddUser').addEventListener('click', () => openUserModal('add'));
    document.getElementById('viewLogsBtn').addEventListener('click', function() {
      document.getElementById('logsModal').style.display = 'flex';
      loadUserActivity();
      loadAuditLogs();
    });
    document.getElementById('saveUserBtn').addEventListener('click', saveUser);
    document.getElementById('cancelModal').addEventListener('click', closeUserModal);
    document.getElementById('closeModal').addEventListener('click', closeUserModal);
    document.getElementById('closeLogsBtn').addEventListener('click', closeLogsModal);
    document.getElementById('closeLogsModal').addEventListener('click', closeLogsModal);
    document.getElementById('refreshLogs').addEventListener('click', function() {
      const activeTab = document.querySelector('.tab-btn.active');
      if (activeTab) {
        const tabId = activeTab.getAttribute('data-tab');
        if (tabId === 'activity') {
          loadUserActivity();
        } else {
          loadAuditLogs();
        }
      }
    });
    document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
    document.getElementById('mobileMenuToggle').addEventListener('click', toggleMobileSidebar);
    
    // Close modals on overlay click
    document.getElementById('userModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('userModal')) closeUserModal();
    });
    
    document.getElementById('logsModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('logsModal')) closeLogsModal();
    });
    
    // Close mobile sidebar on click outside
    document.addEventListener('click', function(event) {
      const sidebar = document.getElementById('sidebar');
      const mobileToggle = document.getElementById('mobileMenuToggle');
      
      if (window.innerWidth <= 768) {
        if (!sidebar.contains(event.target) && !mobileToggle.contains(event.target) && sidebar.classList.contains('mobile-open')) {
          sidebar.classList.remove('mobile-open');
          mobileToggle.querySelector('i').className = 'fas fa-bars';
          mobileToggle.title = "Open menu";
        }
      }
    });
    
    // Auto-refresh
    setInterval(loadUsers, 30000);
  }
});

/* ============ PREVENT BACK BUTTON ISSUES ============ */
window.addEventListener('pageshow', function(event) {
  if (event.persisted) {
    sessionCheck().then(isAuthenticated => {
      if (isAuthenticated) {
        loadUsers();
      }
    });
  }
});

/* ============ WINDOW RESIZE HANDLER ============ */
window.addEventListener('resize', function() {
  if (window.innerWidth > 768) {
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileMenuToggle');
    
    sidebar.classList.remove('mobile-open');
    mobileToggle.querySelector('i').className = 'fas fa-bars';
    mobileToggle.title = "Open menu";
  }
});
</script>
</body>
</html>
